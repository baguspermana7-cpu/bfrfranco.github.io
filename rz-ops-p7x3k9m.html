<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console | ResistanceZero</title>
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:image:alt" content="ResistanceZero Admin Console">
    <meta name="twitter:image:alt" content="ResistanceZero Admin Console">
    <link rel="icon" type="image/png" href="assets/Favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#0b1120;color:#e2e8f0;min-height:100vh;display:flex}
        ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#0f172a}::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#475569}

        /* ═══ SIDEBAR ═══ */
        .sidebar{width:260px;background:#111827;border-right:1px solid #1f2937;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200;transition:transform 0.3s}
        .sidebar-brand{padding:1.25rem 1.5rem;border-bottom:1px solid #1f2937;display:flex;align-items:center;gap:12px}
        .sidebar-logo{width:36px;height:36px;background:linear-gradient(135deg,#8b5cf6,#6d28d9);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:12px}
        .sidebar-brand-text h2{font-size:0.95rem;font-weight:700;color:#f1f5f9}
        .sidebar-brand-text span{font-size:0.65rem;color:#6b7280;letter-spacing:0.5px}
        .sidebar-nav{flex:1;padding:1rem 0;overflow-y:auto}
        .nav-group-label{padding:0.5rem 1.5rem;font-size:0.6rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#4b5563}
        .nav-item{display:flex;align-items:center;gap:10px;padding:0.6rem 1.5rem;color:#9ca3af;font-size:0.82rem;font-weight:500;cursor:pointer;transition:all 0.15s;border-left:3px solid transparent;text-decoration:none}
        .nav-item:hover{background:rgba(139,92,246,0.06);color:#e2e8f0}
        .nav-item.active{background:rgba(139,92,246,0.1);color:#a78bfa;border-left-color:#8b5cf6;font-weight:600}
        .nav-item i{width:18px;text-align:center;font-size:0.85rem}
        .nav-item .badge{margin-left:auto;padding:1px 7px;border-radius:50px;font-size:0.6rem;font-weight:700}
        .nav-item .badge.purple{background:rgba(139,92,246,0.2);color:#a78bfa}
        .nav-item .badge.green{background:rgba(16,185,129,0.2);color:#34d399}
        .nav-item .badge.amber{background:rgba(245,158,11,0.2);color:#fbbf24}
        .sidebar-footer{padding:1rem 1.5rem;border-top:1px solid #1f2937}
        .sidebar-user{display:flex;align-items:center;gap:10px}
        .sidebar-avatar{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#7c3aed,#a855f7);display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.7rem;font-weight:700}
        .sidebar-user-info{flex:1}
        .sidebar-user-name{font-size:0.78rem;font-weight:600;color:#f1f5f9}
        .sidebar-user-role{font-size:0.65rem;color:#6b7280}
        .sidebar-logout{background:none;border:none;color:#6b7280;cursor:pointer;padding:4px;font-size:0.9rem;transition:color 0.2s}
        .sidebar-logout:hover{color:#ef4444}

        /* ═══ MAIN ═══ */
        .main-wrap{flex:1;margin-left:260px;min-height:100vh}
        .topbar{background:#111827;border-bottom:1px solid #1f2937;padding:0.75rem 2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
        .topbar-title{font-size:1.1rem;font-weight:700;color:#f1f5f9}
        .topbar-right{display:flex;align-items:center;gap:1rem}
        .topbar-time{font-size:0.75rem;color:#6b7280;font-family:'JetBrains Mono',monospace}
        .topbar-link{color:#9ca3af;text-decoration:none;font-size:0.82rem;padding:6px 12px;border-radius:6px;transition:all 0.2s}
        .topbar-link:hover{color:#e2e8f0;background:rgba(255,255,255,0.05)}
        .main-content{padding:2rem;max-width:1400px;margin:0 auto}

        /* ═══ SECTIONS ═══ */
        .section{display:none}
        .section.active{display:block}
        .section-header{margin-bottom:1.75rem}
        .section-header h1{font-size:1.5rem;font-weight:800;color:#f1f5f9;margin-bottom:0.25rem}
        .section-header p{font-size:0.82rem;color:#64748b}

        /* ═══ CARDS ═══ */
        .card{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:1.5rem;margin-bottom:1.5rem}
        .card-title{font-size:0.9rem;font-weight:700;color:#f1f5f9;margin-bottom:1rem;display:flex;align-items:center;gap:8px}
        .card-title i{font-size:0.85rem}

        /* ═══ KPI GRID ═══ */
        .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.75rem}
        .kpi{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:1.25rem;transition:transform 0.2s}
        .kpi:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3)}
        .kpi-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:0.95rem;margin-bottom:0.75rem}
        .kpi-label{font-size:0.68rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600}
        .kpi-val{font-size:1.8rem;font-weight:800;color:#f1f5f9;margin:0.15rem 0}
        .kpi-sub{font-size:0.7rem;font-weight:600;display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:50px}
        .kpi-sub.up{background:rgba(16,185,129,0.15);color:#34d399}
        .kpi-sub.down{background:rgba(239,68,68,0.15);color:#f87171}
        .kpi-sub.neutral{background:rgba(100,116,139,0.15);color:#94a3b8}

        /* ═══ CHARTS ═══ */
        .charts-row{display:grid;grid-template-columns:2fr 1fr;gap:1rem;margin-bottom:1.5rem}

        /* ═══ TABLE ═══ */
        .tbl-controls{display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem}
        .tbl-search{position:relative}
        .tbl-search i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#64748b;font-size:0.78rem}
        .tbl-search input{padding:8px 12px 8px 32px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:0.8rem;font-family:inherit;outline:none;width:240px;transition:border-color 0.2s}
        .tbl-search input:focus{border-color:#8b5cf6}
        .tbl-select{padding:8px 12px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:0.8rem;font-family:inherit;outline:none;cursor:pointer}
        .tbl-select:focus{border-color:#8b5cf6}
        .btn{padding:7px 16px;border-radius:8px;border:none;font-size:0.8rem;font-weight:600;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:6px;transition:all 0.2s}
        .btn:hover{transform:translateY(-1px)}
        .btn-purple{background:linear-gradient(135deg,#7c3aed,#8b5cf6);color:#fff;box-shadow:0 3px 10px rgba(139,92,246,0.25)}
        .btn-green{background:linear-gradient(135deg,#059669,#10b981);color:#fff;box-shadow:0 3px 10px rgba(16,185,129,0.25)}
        .btn-amber{background:linear-gradient(135deg,#d97706,#f59e0b);color:#fff;box-shadow:0 3px 10px rgba(245,158,11,0.25)}
        .btn-red{background:linear-gradient(135deg,#dc2626,#ef4444);color:#fff;box-shadow:0 3px 10px rgba(239,68,68,0.25)}
        .btn-ghost{background:transparent;border:1px solid #334155;color:#94a3b8}
        .btn-ghost:hover{border-color:#8b5cf6;color:#a78bfa}
        .btn-sm{padding:4px 10px;font-size:0.72rem;border-radius:6px}

        .data-tbl{width:100%;border-collapse:collapse;font-size:0.8rem}
        .data-tbl th{text-align:left;padding:10px 12px;border-bottom:2px solid #334155;color:#94a3b8;font-weight:600;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.5px;cursor:pointer;white-space:nowrap;user-select:none}
        .data-tbl th:hover{color:#e2e8f0}
        .data-tbl th .si{margin-left:4px;font-size:0.55rem}
        .data-tbl td{padding:10px 12px;border-bottom:1px solid rgba(51,65,85,0.5);color:#cbd5e1;vertical-align:middle}
        .data-tbl tr:hover td{background:rgba(139,92,246,0.04)}
        .tbl-overflow{overflow-x:auto}

        .tier-badge{display:inline-flex;padding:3px 10px;border-radius:50px;font-size:0.62rem;font-weight:700;letter-spacing:0.5px}
        .tier-badge.pro{background:rgba(139,92,246,0.2);color:#a78bfa}
        .tier-badge.free{background:rgba(100,116,139,0.2);color:#94a3b8}
        .status-dot{display:inline-flex;align-items:center;gap:6px}
        .status-dot::before{content:'';width:7px;height:7px;border-radius:50%}
        .status-dot.active::before{background:#34d399}
        .status-dot.inactive::before{background:#64748b}
        .status-dot.suspended::before{background:#f87171}

        .pagination{display:flex;justify-content:space-between;align-items:center;margin-top:1rem;padding-top:1rem;border-top:1px solid #334155}
        .pagination-info{font-size:0.75rem;color:#64748b}
        .pagination-btns{display:flex;gap:4px}
        .pg-btn{padding:5px 11px;border-radius:6px;background:transparent;border:1px solid #334155;color:#94a3b8;font-size:0.75rem;cursor:pointer;font-family:inherit;transition:all 0.2s}
        .pg-btn:hover{border-color:#8b5cf6;color:#a78bfa}
        .pg-btn.active{background:#8b5cf6;border-color:#8b5cf6;color:#fff}

        /* ═══ TOGGLE SWITCH ═══ */
        .toggle{position:relative;width:42px;height:22px;flex-shrink:0}
        .toggle input{opacity:0;width:0;height:0}
        .toggle .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#334155;transition:0.3s;border-radius:22px}
        .toggle .slider::before{content:'';position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#94a3b8;transition:0.3s;border-radius:50%}
        .toggle input:checked+.slider{background:#7c3aed}
        .toggle input:checked+.slider::before{transform:translateX(20px);background:#fff}

        /* ═══ FEATURE MATRIX ═══ */
        .feat-grid{display:grid;gap:0}
        .feat-row{display:grid;grid-template-columns:2fr repeat(2,1fr);align-items:center;padding:12px 16px;border-bottom:1px solid rgba(51,65,85,0.4)}
        .feat-row.header{background:rgba(15,23,42,0.5);border-radius:8px 8px 0 0;border-bottom:2px solid #334155}
        .feat-row.header span{font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#64748b;text-align:center}
        .feat-row.header span:first-child{text-align:left}
        .feat-name{font-size:0.82rem;color:#e2e8f0;font-weight:500;display:flex;align-items:center;gap:8px}
        .feat-name i{width:16px;color:#64748b;font-size:0.78rem}
        .feat-name .fdesc{font-size:0.68rem;color:#64748b;font-weight:400}
        .feat-cell{display:flex;justify-content:center}

        /* ═══ CREDENTIALS ═══ */
        .cred-row{display:grid;grid-template-columns:40px 1.2fr 1.5fr 1fr 0.8fr 100px;align-items:center;padding:10px 14px;border-bottom:1px solid rgba(51,65,85,0.4);font-size:0.8rem}
        .cred-row.header{background:rgba(15,23,42,0.5);border-radius:8px 8px 0 0;border-bottom:2px solid #334155;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#64748b}
        .cred-avatar{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700;color:#fff}
        .cred-pass{font-family:'JetBrains Mono',monospace;font-size:0.75rem;display:flex;align-items:center;gap:6px}
        .cred-pass .masked{color:#475569;letter-spacing:2px}
        .cred-pass .revealed{color:#fbbf24}
        .cred-reveal{background:none;border:none;color:#64748b;cursor:pointer;font-size:0.7rem;padding:2px;transition:color 0.2s}
        .cred-reveal:hover{color:#a78bfa}

        /* ═══ BENCHMARK ═══ */
        .bench-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
        .bench-card{background:linear-gradient(135deg,#1a1f35,#1e293b);border:1px solid #334155;border-radius:10px;padding:0.85rem;position:relative;overflow:hidden}
        .bench-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
        .bench-card.green::before{background:linear-gradient(90deg,#059669,#34d399)}
        .bench-card.purple::before{background:linear-gradient(90deg,#7c3aed,#a78bfa)}
        .bench-card.amber::before{background:linear-gradient(90deg,#d97706,#fbbf24)}
        .bench-card.blue::before{background:linear-gradient(90deg,#2563eb,#60a5fa)}
        .bench-card.red::before{background:linear-gradient(90deg,#dc2626,#f87171)}
        .bench-card.cyan::before{background:linear-gradient(90deg,#0891b2,#22d3ee)}
        .bench-label{font-size:0.6rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:0.3rem}
        .bench-val{font-size:1.2rem;font-weight:800;color:#f1f5f9}
        .bench-sub{font-size:0.65rem;color:#94a3b8;margin-top:0.15rem}
        .bench-table{width:100%;border-collapse:collapse;font-size:0.78rem;margin-top:0.5rem}
        .bench-table th{text-align:left;padding:8px 10px;color:#64748b;font-weight:600;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid #334155;cursor:pointer;user-select:none;white-space:nowrap}
        .bench-table th:hover{color:#a78bfa}
        .bench-table th .sort-icon{margin-left:3px;font-size:0.55rem;opacity:0.5}
        .bench-table th.sorted .sort-icon{opacity:1;color:#a78bfa}
        .bench-table td{padding:8px 10px;color:#cbd5e1;border-bottom:1px solid rgba(51,65,85,0.4)}
        .bench-table tr:hover td{background:rgba(139,92,246,0.04)}
        .bench-bar{height:6px;border-radius:3px;background:#1e293b;position:relative;margin-top:4px}
        .bench-bar-fill{height:100%;border-radius:3px;transition:width 0.6s ease}
        /* Bench sub-tabs */
        .bench-tabs{display:flex;gap:2px;margin-bottom:1rem;background:#0f172a;border-radius:10px;padding:3px;border:1px solid #1f2937}
        .bench-tab{padding:0.5rem 1rem;font-size:0.75rem;font-weight:600;color:#64748b;background:transparent;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s;white-space:nowrap}
        .bench-tab:hover{color:#e2e8f0;background:rgba(139,92,246,0.08)}
        .bench-tab.active{background:rgba(139,92,246,0.15);color:#a78bfa}
        .bench-panel{display:none}
        .bench-panel.active{display:block}
        /* Filter bar */
        .bench-filters{display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;align-items:center}
        .bench-filter-group{display:flex;align-items:center;gap:4px}
        .bench-filter-label{font-size:0.65rem;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.3px}
        .bench-select{background:#0f172a;border:1px solid #334155;border-radius:6px;color:#e2e8f0;padding:5px 8px;font-size:0.72rem;font-family:'Inter',sans-serif;outline:none;cursor:pointer;min-width:100px}
        .bench-select:focus{border-color:#8b5cf6}
        .bench-input{background:#0f172a;border:1px solid #334155;border-radius:6px;color:#e2e8f0;padding:5px 8px;font-size:0.72rem;font-family:'Inter',sans-serif;outline:none;width:140px}
        .bench-input:focus{border-color:#8b5cf6}
        .bench-input::placeholder{color:#475569}
        .bench-btn{padding:5px 12px;border-radius:6px;font-size:0.7rem;font-weight:600;border:none;cursor:pointer;transition:all 0.15s}
        .bench-btn-primary{background:rgba(139,92,246,0.2);color:#a78bfa;border:1px solid rgba(139,92,246,0.3)}
        .bench-btn-primary:hover{background:rgba(139,92,246,0.3)}
        .bench-btn-ghost{background:transparent;color:#64748b;border:1px solid #334155}
        .bench-btn-ghost:hover{color:#e2e8f0;border-color:#475569}
        .bench-btn-ghost.active{background:rgba(139,92,246,0.12);color:#a78bfa;border-color:rgba(139,92,246,0.3)}
        /* Pagination */
        .bench-pagination{display:flex;align-items:center;justify-content:space-between;margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid rgba(51,65,85,0.3)}
        .bench-page-info{font-size:0.7rem;color:#64748b}
        .bench-page-btns{display:flex;gap:4px}
        .bench-page-btn{padding:4px 10px;font-size:0.68rem;border-radius:4px;border:1px solid #334155;background:transparent;color:#94a3b8;cursor:pointer}
        .bench-page-btn:hover{border-color:#8b5cf6;color:#a78bfa}
        .bench-page-btn.active{background:rgba(139,92,246,0.2);border-color:#8b5cf6;color:#a78bfa}
        .bench-page-btn:disabled{opacity:0.3;cursor:not-allowed}
        /* Type badges */
        .bench-type{display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.62rem;font-weight:600;letter-spacing:0.3px}
        .bench-type.hyperscale{background:rgba(96,165,250,0.15);color:#60a5fa}
        .bench-type.colocation{background:rgba(167,139,250,0.15);color:#a78bfa}
        .bench-type.wholesale{background:rgba(251,191,36,0.15);color:#fbbf24}
        .bench-type.edge{background:rgba(52,211,153,0.15);color:#34d399}
        .bench-type.government{background:rgba(248,113,113,0.15);color:#f87171}
        .bench-type.enterprise{background:rgba(34,211,238,0.15);color:#22d3ee}
        /* Region badges */
        .bench-region{display:inline-block;padding:1px 6px;border-radius:3px;font-size:0.6rem;font-weight:600}
        .bench-region.americas{background:rgba(96,165,250,0.12);color:#60a5fa}
        .bench-region.emea{background:rgba(251,191,36,0.12);color:#fbbf24}
        .bench-region.apac{background:rgba(52,211,153,0.12);color:#34d399}
        .bench-region.latam{background:rgba(167,139,250,0.12);color:#a78bfa}
        .bench-region.mea{background:rgba(248,113,113,0.12);color:#f87171}
        /* Capacity bar inline */
        .cap-bar{display:inline-flex;align-items:center;gap:6px;width:100%}
        .cap-bar-track{flex:1;height:5px;background:#1e293b;border-radius:3px;overflow:hidden;min-width:40px}
        .cap-bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#8b5cf6,#a78bfa);transition:width 0.5s}
        .cap-bar-val{font-size:0.72rem;color:#e2e8f0;font-weight:600;white-space:nowrap;min-width:50px}
        /* Growth indicator */
        .growth-up{color:#34d399;font-weight:600}
        .growth-down{color:#f87171;font-weight:600}
        .growth-neutral{color:#64748b}

        /* ═══ TIMELINE ═══ */
        .tl-item{display:flex;gap:12px;padding:10px 0;border-left:2px solid #334155;margin-left:11px;padding-left:20px;position:relative}
        .tl-item::before{content:'';position:absolute;left:-6px;top:14px;width:10px;height:10px;border-radius:50%;border:2px solid #111827}
        .tl-item.login::before{background:#34d399}.tl-item.logout::before{background:#f87171}.tl-item.calculation::before{background:#60a5fa}.tl-item.pdf::before{background:#a78bfa}.tl-item.tier_change::before{background:#fbbf24}.tl-item.feature_toggle::before{background:#22d3ee}
        .tl-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.68rem;flex-shrink:0}
        .tl-icon.login{background:rgba(52,211,153,0.15);color:#34d399}
        .tl-icon.logout{background:rgba(248,113,113,0.15);color:#f87171}
        .tl-icon.calculation{background:rgba(96,165,250,0.15);color:#60a5fa}
        .tl-icon.pdf{background:rgba(167,139,250,0.15);color:#a78bfa}
        .tl-icon.tier_change{background:rgba(251,191,36,0.15);color:#fbbf24}
        .tl-icon.feature_toggle{background:rgba(34,211,238,0.15);color:#22d3ee}
        .tl-text{font-size:0.8rem;color:#cbd5e1}.tl-text strong{color:#f1f5f9;font-weight:600}
        .tl-time{font-size:0.68rem;color:#64748b;margin-top:2px}

        /* ═══ MODAL ═══ */
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:9999;align-items:center;justify-content:center}
        .modal-overlay.show{display:flex}
        .modal-box{background:#1e293b;border:1px solid #334155;border-radius:16px;width:92%;max-width:680px;max-height:88vh;overflow-y:auto;padding:2rem;position:relative;animation:mIn 0.25s ease}
        @keyframes mIn{from{opacity:0;transform:scale(0.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
        .modal-close{position:absolute;top:14px;right:14px;background:none;border:none;color:#64748b;font-size:1.3rem;cursor:pointer;padding:4px}
        .modal-close:hover{color:#e2e8f0}
        .m-section{margin-bottom:1.5rem}
        .m-section h4{font-size:0.78rem;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.75rem;display:flex;align-items:center;gap:6px}
        .m-row{display:flex;justify-content:space-between;padding:6px 0;font-size:0.8rem}
        .m-row-label{color:#64748b}.m-row-value{color:#e2e8f0;font-weight:500}

        /* ═══ ACCESS DENIED ═══ */
        .access-denied{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;text-align:center;width:100%}
        .access-denied i{font-size:3rem;color:#ef4444;margin-bottom:1rem}
        .access-denied h2{font-size:1.5rem;color:#f1f5f9;margin-bottom:0.5rem}
        .access-denied p{color:#64748b;margin-bottom:1.5rem}
        .access-denied a{padding:10px 24px;background:linear-gradient(135deg,#8b5cf6,#a855f7);color:#fff;text-decoration:none;border-radius:8px;font-weight:600;font-size:0.9rem}

        /* ═══ MOBILE HAMBURGER ═══ */
        .hamburger{display:none;background:none;border:none;color:#e2e8f0;font-size:1.2rem;cursor:pointer;padding:4px}
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:199}

        /* ═══ RESPONSIVE ═══ */
        @media(max-width:1200px){.kpi-grid{grid-template-columns:repeat(2,1fr)}.bench-grid{grid-template-columns:repeat(2,1fr)}.charts-row{grid-template-columns:1fr}}
        @media(max-width:768px){
            .sidebar{transform:translateX(-100%)}
            .sidebar.open{transform:translateX(0)}
            .sidebar-overlay.show{display:block}
            .main-wrap{margin-left:0}
            .hamburger{display:block}
            .kpi-grid{grid-template-columns:1fr}
            .bench-grid{grid-template-columns:1fr}
            .bench-tabs{flex-wrap:wrap}
            .bench-filters{flex-direction:column;align-items:stretch}
            .bench-filter-group{width:100%}
            .bench-select,.bench-input{width:100%}
            .main-content{padding:1rem}
            .cred-row{grid-template-columns:30px 1fr 1fr 0.7fr 80px;font-size:0.72rem}
            .feat-row{grid-template-columns:1.5fr repeat(3,1fr);padding:10px 8px}
        }

        /* ═══ LOGIN PAGE ═══ */
        /* ═══ SKIP LINK ═══ */
        .skip-link{position:absolute;top:-100px;left:0;background:#7c3aed;color:#fff;padding:8px 16px;z-index:9999;font-size:0.85rem;border-radius:0 0 8px 0;transition:top 0.2s}
        .skip-link:focus{top:0}

        /* ═══ LOGIN PAGE ═══ */
        .login-page{position:fixed;top:0;left:0;right:0;bottom:0;z-index:9000;display:flex;align-items:center;justify-content:center;background:#050816;background-image:radial-gradient(ellipse 80% 60% at 50% 120%,rgba(124,58,237,0.15),transparent),radial-gradient(ellipse 60% 50% at 80% 0%,rgba(59,130,246,0.07),transparent),radial-gradient(ellipse 50% 40% at 10% 20%,rgba(139,92,246,0.06),transparent)}
        .login-page .login-bg{position:absolute;inset:0;overflow:hidden;pointer-events:none}
        .login-page .login-bg::before{content:'';position:absolute;top:-15%;right:-5%;width:700px;height:700px;background:radial-gradient(circle,rgba(124,58,237,0.10) 0%,rgba(124,58,237,0.03) 40%,transparent 65%);animation:loginOrb1 12s ease-in-out infinite alternate}
        .login-page .login-bg::after{content:'';position:absolute;bottom:-10%;left:-5%;width:600px;height:600px;background:radial-gradient(circle,rgba(59,130,246,0.08) 0%,rgba(59,130,246,0.02) 40%,transparent 65%);animation:loginOrb2 15s ease-in-out infinite alternate}
        .login-bg-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(148,163,184,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(148,163,184,0.03) 1px,transparent 1px);background-size:60px 60px;mask-image:radial-gradient(ellipse 70% 60% at 50% 50%,black 20%,transparent 70%);-webkit-mask-image:radial-gradient(ellipse 70% 60% at 50% 50%,black 20%,transparent 70%)}
        .login-bg-accent{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:800px;height:800px;background:conic-gradient(from 180deg at 50% 50%,transparent 0deg,rgba(124,58,237,0.04) 60deg,transparent 120deg,rgba(59,130,246,0.03) 200deg,transparent 260deg,rgba(139,92,246,0.04) 320deg,transparent 360deg);animation:loginSpin 40s linear infinite}
        @keyframes loginOrb1{0%{opacity:0.5;transform:translate(0,0) scale(1)}50%{opacity:0.8;transform:translate(-30px,20px) scale(1.1)}100%{opacity:0.6;transform:translate(20px,-10px) scale(1.05)}}
        @keyframes loginOrb2{0%{opacity:0.4;transform:translate(0,0) scale(1)}50%{opacity:0.7;transform:translate(25px,-15px) scale(1.08)}100%{opacity:0.5;transform:translate(-15px,20px) scale(1.03)}}
        @keyframes loginSpin{from{transform:translate(-50%,-50%) rotate(0deg)}to{transform:translate(-50%,-50%) rotate(360deg)}}
        .login-container{width:100%;max-width:420px;margin:0 20px;position:relative;z-index:1}
        .login-card{padding:2.5rem 2.25rem 2rem;background:rgba(15,23,42,0.75);border:1px solid rgba(51,65,85,0.4);border-radius:20px;backdrop-filter:blur(20px);box-shadow:0 24px 64px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.03) inset}
        .login-brand{text-align:center;margin-bottom:1.75rem}
        .login-brand-logo{width:60px;height:60px;margin:0 auto 1rem;border-radius:16px;box-shadow:0 8px 24px rgba(124,58,237,0.25);overflow:hidden}
        .login-brand-logo img{width:100%;height:100%;object-fit:cover;display:block}
        .login-brand h1{font-size:1.4rem;font-weight:800;color:#f1f5f9;margin:0 0 0.15rem;letter-spacing:-0.02em}
        .login-brand p{font-size:0.8rem;color:#64748b;margin:0;font-weight:400}
        .login-divider{height:1px;background:linear-gradient(90deg,transparent,rgba(139,92,246,0.25),transparent);margin:0 0 1.75rem}
        .login-field{margin-bottom:1.125rem}
        .login-field label{display:flex;align-items:center;justify-content:space-between;font-size:0.75rem;font-weight:600;color:#94a3b8;margin-bottom:0.4rem;letter-spacing:0.02em}
        .login-field label a{color:#a78bfa;text-decoration:none;font-size:0.72rem;font-weight:500}
        .login-field label a:hover{color:#c4b5fd;text-decoration:underline}
        .login-field-wrap{position:relative}
        .login-field-wrap .login-field-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#475569;font-size:0.82rem;pointer-events:none;transition:color 0.2s}
        .login-field-wrap input{width:100%;padding:12px 14px 12px 42px;border-radius:10px;border:1px solid rgba(51,65,85,0.6);background:rgba(15,23,42,0.6);color:#f1f5f9;font-size:0.9rem;font-family:inherit;outline:none;transition:border-color 0.2s,box-shadow 0.2s,background 0.2s;box-sizing:border-box}
        .login-field-wrap input:focus{border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,0.15);background:rgba(15,23,42,0.9)}
        .login-field-wrap input:focus ~ .login-field-icon{color:#a78bfa}
        .login-field-wrap input::placeholder{color:#4b5563;font-size:0.84rem}
        .login-toggle-pw{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:#475569;font-size:0.88rem;cursor:pointer;padding:4px 2px;transition:color 0.2s;line-height:1}
        .login-toggle-pw:hover{color:#a78bfa}
        .login-options{display:flex;align-items:center;justify-content:space-between;margin:0.25rem 0 1.25rem}
        .login-remember{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.78rem;color:#94a3b8;user-select:none}
        .login-remember input[type="checkbox"]{appearance:none;-webkit-appearance:none;width:16px;height:16px;border:1.5px solid #475569;border-radius:4px;background:transparent;cursor:pointer;position:relative;transition:all 0.15s;flex-shrink:0}
        .login-remember input[type="checkbox"]:checked{background:#7c3aed;border-color:#7c3aed}
        .login-remember input[type="checkbox"]:checked::after{content:'\2713';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:0.65rem;font-weight:700}
        .login-remember input[type="checkbox"]:focus{box-shadow:0 0 0 2px rgba(124,58,237,0.2)}
        .login-forgot{font-size:0.78rem;color:#a78bfa;text-decoration:none;transition:color 0.15s}
        .login-forgot:hover{color:#c4b5fd;text-decoration:underline}
        .login-error{padding:10px 14px;border-radius:10px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);color:#f87171;font-size:0.8rem;margin-bottom:1rem;display:none;line-height:1.4;animation:loginShake 0.35s ease}
        .login-error i{margin-right:6px}
        @keyframes loginShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
        .login-submit{width:100%;padding:13px;border:none;border-radius:10px;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;font-size:0.92rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s;letter-spacing:0.01em;position:relative;overflow:hidden}
        .login-submit::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.08),transparent);opacity:0;transition:opacity 0.2s}
        .login-submit:hover::before{opacity:1}
        .login-submit:hover{box-shadow:0 8px 24px rgba(124,58,237,0.35);transform:translateY(-1px)}
        .login-submit:active{transform:translateY(0) scale(0.99);box-shadow:0 2px 8px rgba(124,58,237,0.2)}
        .login-submit:disabled{opacity:0.55;cursor:not-allowed;transform:none!important;box-shadow:none!important}
        .login-submit:disabled::before{display:none}
        .login-card-footer{display:flex;align-items:center;justify-content:space-between;margin-top:1.5rem;padding-top:1.25rem;border-top:1px solid rgba(51,65,85,0.3)}
        .login-card-footer a{color:#64748b;text-decoration:none;font-size:0.78rem;transition:color 0.2s;display:inline-flex;align-items:center;gap:6px}
        .login-card-footer a:hover{color:#a78bfa}
        .login-secure{display:flex;align-items:center;gap:5px;font-size:0.68rem;color:#475569}
        .login-secure i{font-size:0.58rem;color:#22c55e}
        .login-ext-footer{text-align:center;margin-top:1.5rem;font-size:0.7rem;color:#334155}
        .login-ext-footer a{color:#475569;text-decoration:none;transition:color 0.15s}
        .login-ext-footer a:hover{color:#64748b}

        /* ═══ THEME TOGGLE ═══ */
        .theme-toggle-btn{background:none;border:1px solid #334155;color:#94a3b8;cursor:pointer;padding:6px 10px;border-radius:8px;font-size:0.85rem;transition:all 0.2s}
        .theme-toggle-btn:hover{border-color:#8b5cf6;color:#a78bfa}

        /* ═══ DC INTEL ENHANCEMENTS ═══ */
        .dc-chart-wrap{position:relative}
        .dc-chart-wrap:hover .dc-chart-actions{opacity:1}
        .dc-chart-actions{position:absolute;top:4px;right:4px;display:flex;gap:2px;opacity:0;transition:opacity 0.2s}
        .dc-chart-btn{background:rgba(15,23,42,0.7);border:1px solid #334155;color:#94a3b8;cursor:pointer;padding:3px 6px;border-radius:4px;font-size:0.6rem;transition:all 0.15s}
        .dc-chart-btn:hover{background:rgba(139,92,246,0.2);color:#a78bfa;border-color:#8b5cf6}
        .dc-kpi-tooltip{position:relative;cursor:help}
        .dc-kpi-tooltip:hover .dc-tooltip-text{opacity:1;visibility:visible;transform:translateY(0)}
        .dc-tooltip-text{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%) translateY(4px);background:#0f172a;border:1px solid #334155;border-radius:8px;padding:8px 12px;font-size:0.68rem;color:#94a3b8;white-space:nowrap;opacity:0;visibility:hidden;transition:all 0.2s;z-index:50;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .dc-skeleton{background:linear-gradient(90deg,#1e293b 25%,#334155 50%,#1e293b 75%);background-size:200% 100%;animation:dcSkeleton 1.5s infinite;border-radius:8px}
        @keyframes dcSkeleton{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .dc-new-badge{display:inline-block;background:rgba(52,211,153,0.2);color:#34d399;font-size:0.5rem;padding:1px 5px;border-radius:3px;font-weight:800;letter-spacing:0.5px;vertical-align:middle;margin-left:4px;animation:dcPulse 2s infinite}
        @keyframes dcPulse{0%,100%{opacity:1}50%{opacity:0.6}}

        /* ═══ E4: Print Styles ═══ */
        @media print{
            .sidebar,.topbar,.login-page,.hamburger,.sidebar-overlay,.btn,.bench-btn,.dc-chart-actions,.bench-filters,.bench-tabs,.modal-overlay{display:none!important}
            .main-wrap{margin-left:0!important}
            .section{display:none!important}
            #sec-benchmarks{display:block!important}
            .bench-panel{display:block!important;page-break-inside:avoid}
            body{background:#fff!important;color:#000!important}
            .card{border:1px solid #ccc!important;background:#fff!important;break-inside:avoid}
            .bench-card{border:1px solid #ccc!important;background:#f9f9f9!important}
            .bench-val,.kpi-val,.card-title{color:#000!important}
            .bench-label,.bench-sub,.kpi-label{color:#666!important}
            canvas{max-height:300px!important}
        }

        /* ═══ F3: Responsive Grid for Overview ═══ */
        @media(max-width:1200px){#bp-overview>div[style*="grid-template-columns: 1fr 1fr"]{grid-template-columns:1fr!important}}
        @media(min-width:1400px){#bp-overview>div:first-child{grid-template-columns:1fr 1fr 1fr!important}}

        /* ═══ SELECT OPTIONS FIX ═══ */
        select option{background:#1e293b;color:#e2e8f0}

        /* ═══ SUBSCRIBERS TABLE ═══ */
        .tbl{width:100%;border-collapse:collapse;font-size:0.8rem}
        .tbl th{text-align:left;padding:10px 12px;border-bottom:2px solid #334155;color:#94a3b8;font-weight:600;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.5px}
        .tbl td{padding:10px 12px;border-bottom:1px solid rgba(51,65,85,0.5);color:#cbd5e1}
        .tbl tr:hover td{background:rgba(139,92,246,0.04)}

        /* ═══ HEALTH STAT ═══ */
        .health-stat{text-align:center;padding:1rem;background:#0f172a;border-radius:10px;border:1px solid #334155}
        .health-stat-label{font-size:0.68rem;color:#64748b;text-transform:uppercase;margin-bottom:0.5rem}
        .health-stat-value{font-size:1.5rem;font-weight:800}
        .health-stat-sub{font-size:0.68rem;color:#64748b}

        /* ═══ LIGHT MODE ═══ */
        body.light-mode{background:#f8fafc;color:#1e293b}
        body.light-mode .sidebar{background:#fff;border-color:#e2e8f0}
        body.light-mode .sidebar-brand{border-color:#e2e8f0}
        body.light-mode .sidebar-brand-text h2{color:#1e293b}
        body.light-mode .sidebar-brand-text span{color:#64748b}
        body.light-mode .nav-group-label{color:#94a3b8}
        body.light-mode .nav-item{color:#64748b}
        body.light-mode .nav-item:hover{background:rgba(139,92,246,0.06);color:#1e293b}
        body.light-mode .nav-item.active{background:rgba(139,92,246,0.08);color:#7c3aed}
        body.light-mode .sidebar-footer{border-color:#e2e8f0}
        body.light-mode .sidebar-user-name{color:#1e293b}
        body.light-mode .topbar{background:#fff;border-color:#e2e8f0}
        body.light-mode .topbar-title{color:#1e293b}
        body.light-mode .topbar-time{color:#64748b}
        body.light-mode .topbar-link{color:#64748b}
        body.light-mode .topbar-link:hover{color:#1e293b;background:rgba(0,0,0,0.04)}
        body.light-mode .card{background:#fff;border-color:#e2e8f0}
        body.light-mode .card-title{color:#1e293b}
        body.light-mode .kpi{background:#fff;border-color:#e2e8f0}
        body.light-mode .kpi:hover{box-shadow:0 8px 24px rgba(0,0,0,0.08)}
        body.light-mode .kpi-val{color:#1e293b}
        body.light-mode .kpi-label{color:#64748b}
        body.light-mode .data-tbl th{color:#64748b;border-color:#e2e8f0}
        body.light-mode .data-tbl td{color:#334155;border-color:#f1f5f9}
        body.light-mode .data-tbl tr:hover td{background:rgba(139,92,246,0.04)}
        body.light-mode .tbl-search input{background:#f8fafc;border-color:#e2e8f0;color:#1e293b}
        body.light-mode .tbl-select{background:#f8fafc;border-color:#e2e8f0;color:#1e293b}
        body.light-mode .btn-ghost{border-color:#e2e8f0;color:#64748b}
        body.light-mode .btn-ghost:hover{border-color:#8b5cf6;color:#7c3aed}
        body.light-mode .section-header h1{color:#1e293b}
        body.light-mode .section-header p{color:#64748b}
        body.light-mode .feat-row{border-color:#f1f5f9}
        body.light-mode .feat-row.header{background:#f8fafc;border-color:#e2e8f0}
        body.light-mode .feat-row.header span{color:#64748b}
        body.light-mode .feat-name{color:#1e293b}
        body.light-mode .cred-row{border-color:#f1f5f9}
        body.light-mode .cred-row.header{background:#f8fafc;border-color:#e2e8f0;color:#64748b}
        body.light-mode .cred-pass .masked{color:#94a3b8}
        body.light-mode .bench-card{background:linear-gradient(135deg,#f8fafc,#fff);border-color:#e2e8f0}
        body.light-mode .bench-val{color:#1e293b}
        body.light-mode .bench-label{color:#64748b}
        body.light-mode .bench-sub{color:#64748b}
        body.light-mode .bench-tabs{background:#f1f5f9;border-color:#e2e8f0}
        body.light-mode .bench-tab{color:#64748b}
        body.light-mode .bench-tab.active{background:rgba(139,92,246,0.12);color:#7c3aed}
        body.light-mode .bench-select{background:#fff;border-color:#e2e8f0;color:#1e293b}
        body.light-mode .bench-input{background:#fff;border-color:#e2e8f0;color:#1e293b}
        body.light-mode .bench-table th{color:#475569;border-bottom-color:#e2e8f0}
        body.light-mode .bench-table td{color:#334155;border-bottom-color:#f1f5f9}
        body.light-mode .cap-bar-track{background:#e2e8f0}
        body.light-mode .bench-page-btn{border-color:#e2e8f0;color:#475569}
        body.light-mode .bench-table th{color:#64748b;border-color:#e2e8f0}
        body.light-mode .bench-table td{color:#334155;border-color:#f1f5f9}
        body.light-mode .dc-chart-btn{background:rgba(255,255,255,0.8);border-color:#e2e8f0;color:#64748b}
        body.light-mode .dc-chart-btn:hover{background:rgba(139,92,246,0.1);color:#7c3aed}
        body.light-mode .dc-tooltip-text{background:#fff;border-color:#e2e8f0;color:#334155;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
        body.light-mode .dc-new-badge{background:rgba(16,185,129,0.12);color:#059669}
        body.light-mode .tl-item{border-color:#e2e8f0}
        body.light-mode .tl-item::before{border-color:#fff}
        body.light-mode .tl-text{color:#334155}
        body.light-mode .tl-text strong{color:#1e293b}
        body.light-mode .modal-box{background:#fff;border-color:#e2e8f0}
        body.light-mode .modal-close{color:#94a3b8}
        body.light-mode .m-section h4{color:#64748b}
        body.light-mode .m-row-label{color:#94a3b8}
        body.light-mode .m-row-value{color:#1e293b}
        body.light-mode .pg-btn{border-color:#e2e8f0;color:#64748b}
        body.light-mode .pg-btn:hover{border-color:#8b5cf6;color:#7c3aed}
        body.light-mode .pagination{border-color:#e2e8f0}
        body.light-mode .pagination-info{color:#94a3b8}
        body.light-mode .theme-toggle-btn{border-color:#e2e8f0;color:#64748b}
        body.light-mode .toggle .slider{background:#cbd5e1}
        body.light-mode .toggle .slider::before{background:#fff}
        body.light-mode #createForm input,body.light-mode #createForm select{background:#f8fafc;border-color:#e2e8f0;color:#1e293b}
        body.light-mode select option{background:#fff;color:#1e293b}
        body.light-mode .tbl th{color:#64748b;border-color:#e2e8f0}
        body.light-mode .tbl td{color:#334155;border-color:#f1f5f9}
        body.light-mode .health-stat{background:#f8fafc;border-color:#e2e8f0}

        /* ═══ MAYAR PAYMENTS ═══ */
        .mayar-tabs{display:flex;gap:4px;margin-bottom:1.5rem;background:#0f172a;padding:4px;border-radius:10px;border:1px solid #1f2937;overflow-x:auto}
        .mayar-tab{padding:8px 16px;border-radius:8px;border:none;background:transparent;color:#94a3b8;font-size:0.78rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s;white-space:nowrap}
        .mayar-tab:hover{color:#e2e8f0;background:rgba(139,92,246,0.08)}
        .mayar-tab.active{background:linear-gradient(135deg,#7c3aed,#8b5cf6);color:#fff;box-shadow:0 2px 8px rgba(139,92,246,0.3)}
        .mayar-panel{display:none}
        .mayar-panel.active{display:block}
        .mayar-label{display:block;font-size:0.7rem;font-weight:600;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
        .mayar-input{width:100%;padding:9px 14px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:0.82rem;font-family:inherit;outline:none;transition:border-color 0.2s;box-sizing:border-box}
        .mayar-input:focus{border-color:#8b5cf6}
        .mayar-loading{text-align:center;padding:2rem;color:#64748b;font-size:0.82rem}
        .mayar-skeleton{background:linear-gradient(90deg,#1e293b 25%,#334155 50%,#1e293b 75%);background-size:200% 100%;animation:mayarShimmer 1.5s infinite;border-radius:6px;height:1rem;margin:4px 0}
        @keyframes mayarShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .mayar-status{padding:2px 10px;border-radius:50px;font-size:0.68rem;font-weight:700;display:inline-block}
        .mayar-status.paid{background:rgba(16,185,129,0.15);color:#34d399}
        .mayar-status.unpaid{background:rgba(245,158,11,0.15);color:#fbbf24}
        .mayar-status.expired{background:rgba(239,68,68,0.15);color:#f87171}
        .mayar-status.pending{background:rgba(96,165,250,0.15);color:#60a5fa}
        .mayar-toast{position:fixed;bottom:2rem;right:2rem;padding:12px 20px;border-radius:10px;font-size:0.82rem;font-weight:600;z-index:9999;transform:translateY(100px);opacity:0;transition:all 0.3s;font-family:inherit;max-width:400px}
        .mayar-toast.show{transform:translateY(0);opacity:1}
        .mayar-toast.error{background:#7f1d1d;color:#fca5a5;border:1px solid #991b1b}
        .mayar-toast.success{background:#064e3b;color:#6ee7b7;border:1px solid #065f46}
        .mayar-toast.info{background:#1e3a5f;color:#93c5fd;border:1px solid #1e40af}
        .mayar-period-btn{padding:5px 12px;border-radius:6px;border:1px solid #334155;background:transparent;color:#94a3b8;font-size:0.72rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s}
        .mayar-period-btn:hover{border-color:#8b5cf6;color:#a78bfa}
        .mayar-period-btn.active{background:rgba(139,92,246,0.2);border-color:#8b5cf6;color:#a78bfa}
        .mayar-cust-card{background:#0f172a;border:1px solid #334155;border-radius:12px;padding:1.25rem;margin-bottom:1rem}
        .mayar-cust-card h4{font-size:0.9rem;font-weight:700;color:#f1f5f9;margin-bottom:0.75rem}
        .mayar-cust-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(51,65,85,0.4);font-size:0.8rem}
        .mayar-cust-row:last-child{border-bottom:none}
        .mayar-cust-row span:first-child{color:#64748b}
        .mayar-cust-row span:last-child{color:#e2e8f0;font-weight:500}
        .mayar-rate{font-size:0.7rem;color:#64748b;display:flex;align-items:center;gap:6px}
        .mayar-rate-bar{width:80px;height:4px;background:#1f2937;border-radius:2px;overflow:hidden}
        .mayar-rate-fill{height:100%;background:linear-gradient(90deg,#34d399,#fbbf24,#ef4444);border-radius:2px;transition:width 0.3s}

        body.light-mode .mayar-tabs{background:#f8fafc;border-color:#e2e8f0}
        body.light-mode .mayar-tab{color:#64748b}
        body.light-mode .mayar-tab:hover{color:#1e293b;background:rgba(139,92,246,0.06)}
        body.light-mode .mayar-input{background:#f8fafc;border-color:#e2e8f0;color:#1e293b}
        body.light-mode .mayar-cust-card{background:#f8fafc;border-color:#e2e8f0}
        body.light-mode .mayar-cust-card h4{color:#1e293b}
        body.light-mode .mayar-cust-row span:last-child{color:#1e293b}
        body.light-mode .mayar-period-btn{border-color:#e2e8f0;color:#64748b}
        body.light-mode .mayar-status.paid{background:rgba(16,185,129,0.1)}
        body.light-mode .mayar-status.unpaid{background:rgba(245,158,11,0.1)}
        body.light-mode .mayar-rate-bar{background:#e2e8f0}

        /* ═══ USER ACTIVITY ═══ */
        .ua-filter-bar{display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem;padding:8px 12px;background:#0f172a;border:1px solid #1f2937;border-radius:10px}
        .ua-filter-bar label{font-size:0.68rem;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.5px}
        .ua-filter-bar input[type="date"]{padding:5px 8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#e2e8f0;font-size:0.72rem;font-family:inherit;outline:none}
        .ua-filter-bar input[type="date"]:focus{border-color:#8b5cf6}
        .ua-period-btn{padding:4px 10px;border-radius:6px;border:1px solid #334155;background:transparent;color:#94a3b8;font-size:0.68rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s}
        .ua-period-btn:hover{border-color:#8b5cf6;color:#a78bfa}
        .ua-period-btn.active{background:linear-gradient(135deg,#7c3aed,#8b5cf6);border-color:#8b5cf6;color:#fff;box-shadow:0 2px 8px rgba(139,92,246,0.3)}
        .ua-cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;margin-bottom:1rem}
        .ua-cat-card{background:#1e293b;border:1px solid #334155;border-radius:10px;padding:0.65rem 0.75rem;position:relative;overflow:hidden;transition:transform 0.2s,box-shadow 0.2s;cursor:default}
        .ua-cat-card:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.25)}
        .ua-cat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
        .ua-cat-card.purple::before{background:linear-gradient(90deg,#7c3aed,#a78bfa)}
        .ua-cat-card.green::before{background:linear-gradient(90deg,#059669,#34d399)}
        .ua-cat-card.blue::before{background:linear-gradient(90deg,#2563eb,#60a5fa)}
        .ua-cat-card.amber::before{background:linear-gradient(90deg,#d97706,#fbbf24)}
        .ua-cat-card.red::before{background:linear-gradient(90deg,#dc2626,#f87171)}
        .ua-cat-card.cyan::before{background:linear-gradient(90deg,#0891b2,#22d3ee)}
        .ua-cat-card.pink::before{background:linear-gradient(90deg,#db2777,#f472b6)}
        .ua-cat-card.indigo::before{background:linear-gradient(90deg,#4f46e5,#818cf8)}
        .ua-cat-icon{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:0.72rem;margin-bottom:0.35rem}
        .ua-cat-count{font-size:1.15rem;font-weight:800;color:#f1f5f9;line-height:1.2}
        .ua-cat-label{font-size:0.6rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-top:1px}
        .ua-cat-sub{font-size:0.58rem;color:#475569;margin-top:2px}
        .ua-event-log{max-height:400px;overflow-y:auto}
        .ua-event-row{display:grid;grid-template-columns:28px 1fr 110px 100px 90px 80px;align-items:center;padding:5px 10px;border-bottom:1px solid rgba(51,65,85,0.4);font-size:0.72rem;transition:background 0.15s}
        .ua-event-loc{color:#94a3b8;font-size:0.65rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .ua-event-loc i{margin-right:3px;font-size:0.55rem}
        .ua-event-row:hover{background:rgba(139,92,246,0.04)}
        .ua-event-row.header{background:#0f172a;border-radius:8px 8px 0 0;border-bottom:2px solid #334155;font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#64748b;position:sticky;top:0;z-index:1}
        .ua-event-icon{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.58rem}
        .ua-event-icon.pro{background:rgba(139,92,246,0.15);color:#a78bfa}
        .ua-event-icon.login{background:rgba(52,211,153,0.15);color:#34d399}
        .ua-event-icon.pdf{background:rgba(96,165,250,0.15);color:#60a5fa}
        .ua-event-icon.cv{background:rgba(245,158,11,0.15);color:#fbbf24}
        .ua-event-icon.ws{background:rgba(236,72,153,0.15);color:#f472b6}
        .ua-event-icon.page{background:rgba(100,116,139,0.15);color:#94a3b8}
        .ua-event-icon.calc{background:rgba(34,211,238,0.15);color:#22d3ee}
        .ua-event-icon.signup{background:rgba(52,211,153,0.15);color:#34d399}
        .ua-event-detail{color:#cbd5e1;font-weight:500}
        .ua-event-detail small{display:block;color:#64748b;font-weight:400;font-size:0.68rem;margin-top:1px}
        .ua-event-page{color:#94a3b8;font-size:0.72rem}
        .ua-event-time{color:#64748b;font-size:0.72rem;font-family:'JetBrains Mono',monospace}
        .ua-event-type{font-size:0.62rem;font-weight:700;padding:2px 8px;border-radius:50px;display:inline-block}
        .ua-event-type.pro{background:rgba(139,92,246,0.2);color:#a78bfa}
        .ua-event-type.login{background:rgba(52,211,153,0.2);color:#34d399}
        .ua-event-type.pdf{background:rgba(96,165,250,0.2);color:#60a5fa}
        .ua-event-type.cv{background:rgba(245,158,11,0.2);color:#fbbf24}
        .ua-event-type.ws{background:rgba(236,72,153,0.2);color:#f472b6}
        .ua-event-type.page{background:rgba(100,116,139,0.2);color:#94a3b8}
        .ua-event-type.calc{background:rgba(34,211,238,0.2);color:#22d3ee}
        .ua-event-type.signup{background:rgba(52,211,153,0.2);color:#34d399}

        @media(max-width:1200px){.ua-cat-grid{grid-template-columns:repeat(4,1fr)} #sec-activity .charts-row{grid-template-columns:1fr}}
        @media(max-width:768px){.ua-cat-grid{grid-template-columns:repeat(2,1fr)}.ua-event-row{grid-template-columns:24px 1fr 80px 60px}.ua-event-row .ua-event-page,.ua-event-row .ua-event-loc{display:none}}

        body.light-mode .ua-filter-bar{background:#f8fafc;border-color:#e2e8f0}
        body.light-mode .ua-filter-bar input[type="date"]{background:#fff;border-color:#e2e8f0;color:#1e293b}
        body.light-mode .ua-period-btn{border-color:#e2e8f0;color:#64748b}
        body.light-mode .ua-cat-card{background:#fff;border-color:#e2e8f0}
        body.light-mode .ua-cat-card:hover{box-shadow:0 6px 20px rgba(0,0,0,0.08)}
        body.light-mode .ua-cat-count{color:#1e293b}
        body.light-mode .ua-event-row{border-color:#f1f5f9}
        body.light-mode .ua-event-row.header{background:#f8fafc;border-color:#e2e8f0;color:#64748b}
        body.light-mode .ua-event-row:hover{background:rgba(139,92,246,0.04)}
        body.light-mode .ua-event-detail{color:#334155}
        body.light-mode .ua-event-page{color:#64748b}
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <!-- Login Page -->
    <div class="login-page" id="loginPage" style="display:none;">
        <div class="login-bg"><div class="login-bg-grid"></div><div class="login-bg-accent"></div></div>
        <div class="login-container">
            <div class="login-card">
                <div class="login-brand">
                    <div class="login-brand-logo"><img src="assets/Favicon.png" alt="ResistanceZero"></div>
                    <h1>ResistanceZero</h1>
                    <p>Operations Console</p>
                </div>
                <div class="login-divider"></div>
                <form onsubmit="return handleAdminLogin(event)" novalidate>
                    <div id="adminLoginError" class="login-error"></div>
                    <div class="login-field">
                        <label for="adminLoginEmail">Email Address</label>
                        <div class="login-field-wrap">
                            <input type="email" id="adminLoginEmail" placeholder="name@resistancezero.com" required autocomplete="username" spellcheck="false">
                            <i class="fas fa-envelope login-field-icon"></i>
                        </div>
                    </div>
                    <div class="login-field">
                        <label for="adminLoginPassword">
                            <span>Password</span>
                            <a href="#" class="login-forgot" onclick="alert('Contact admin to reset your password.');return false;">Forgot password?</a>
                        </label>
                        <div class="login-field-wrap">
                            <input type="password" id="adminLoginPassword" placeholder="Enter your password" required autocomplete="current-password">
                            <i class="fas fa-lock login-field-icon"></i>
                            <button type="button" class="login-toggle-pw" onclick="toggleLoginPassword()" aria-label="Toggle password visibility" tabindex="-1">
                                <i class="fas fa-eye" id="loginPwIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="login-options">
                        <label class="login-remember">
                            <input type="checkbox" id="loginRemember" checked>
                            <span>Remember me</span>
                        </label>
                        <div class="login-secure"><i class="fas fa-lock"></i> 256-bit encrypted</div>
                    </div>
                    <button type="submit" class="login-submit" id="loginSubmitBtn">
                        <span id="loginBtnText">Sign In</span>
                    </button>
                    <div class="login-card-footer">
                        <a href="index.html"><i class="fas fa-arrow-left"></i> Back to Website</a>
                        <div class="login-secure"><i class="fas fa-shield-alt"></i> Authorized only</div>
                    </div>
                    <p style="text-align:center;font-size:0.68rem;color:#475569;margin-top:12px;line-height:1.5;">By signing in, you agree to our <a href="terms.html" target="_blank" style="color:#8b5cf6;text-decoration:underline;">Terms of Service</a> and <a href="privacy.html" target="_blank" style="color:#8b5cf6;text-decoration:underline;">Privacy Policy</a>.</p>
                </form>
            </div>
            <div class="login-ext-footer">&copy; 2026 ResistanceZero. All rights reserved.</div>
        </div>
    </div>

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <div class="sidebar-logo">RZ</div>
            <div class="sidebar-brand-text">
                <h2>ResistanceZero</h2>
                <span>ADMIN CONSOLE v2.0</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-group-label">Analytics</div>
            <a class="nav-item active" data-section="dashboard" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-item" data-section="revenue" onclick="showSection('revenue')">
                <i class="fas fa-chart-bar"></i> Revenue
                <span class="badge green">$</span>
            </a>
            <a class="nav-item" data-section="mayar" onclick="showSection('mayar')">
                <i class="fas fa-credit-card"></i> Mayar Payments
                <span class="badge green">Live</span>
            </a>
            <a class="nav-item" data-section="activity" onclick="showSection('activity')">
                <i class="fas fa-chart-area"></i> User Activity
                <span class="badge purple" id="navActivityCount">0</span>
            </a>

            <div class="nav-group-label" style="margin-top:0.75rem">Management</div>
            <a class="nav-item" data-section="users" onclick="showSection('users')">
                <i class="fas fa-users"></i> Users
                <span class="badge purple" id="navUserCount">50</span>
            </a>
            <a class="nav-item" data-section="credentials" onclick="showSection('credentials')">
                <i class="fas fa-key"></i> Credentials
                <span class="badge amber">15</span>
            </a>
            <a class="nav-item" data-section="features" onclick="showSection('features')">
                <i class="fas fa-toggle-on"></i> Feature Flags
            </a>

            <a class="nav-item" data-section="subscribers" onclick="showSection('subscribers')">
                <i class="fas fa-envelope-open-text"></i> Subscribers
                <span class="badge green" id="navSubCount">0</span>
            </a>

            <div class="nav-group-label" style="margin-top:0.75rem">Intelligence</div>
            <a class="nav-item" data-section="benchmarks" onclick="showSection('benchmarks')">
                <i class="fas fa-landmark"></i> DC Intelligence
            </a>

            <div class="nav-group-label" style="margin-top:0.75rem">System</div>
            <a class="nav-item" data-section="audit" onclick="showSection('audit')">
                <i class="fas fa-clipboard-list"></i> Audit Log
            </a>
            <a class="nav-item" data-section="settings" onclick="showSection('settings')">
                <i class="fas fa-cog"></i> Settings
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-avatar" id="sidebarAvatar">B</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarName">Admin</div>
                    <div class="sidebar-user-role">Super Admin</div>
                </div>
                <button class="sidebar-logout" onclick="adminLogout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </aside>

    <!-- Main Wrapper -->
    <main id="main-content" class="main-wrap" style="display:none;">
        <header class="topbar">
            <div style="display:flex;align-items:center;gap:12px;">
                <button class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <span class="topbar-title" id="topbarTitle">Dashboard</span>
            </div>
            <div class="topbar-right">
                <span class="topbar-time" id="topbarTime"></span>
                <button class="theme-toggle-btn" onclick="toggleAdminTheme()" title="Toggle theme" id="adminThemeBtn">
                    <i class="fas fa-moon"></i>
                </button>
                <a href="capex-calculator.html" class="topbar-link"><i class="fas fa-calculator"></i> CAPEX</a>
                <a href="opex-calculator.html" class="topbar-link"><i class="fas fa-chart-line"></i> OPEX</a>
                <a href="index.html" class="topbar-link"><i class="fas fa-globe"></i> Site</a>
            </div>
        </header>

        <div class="main-content">

<!-- ══════════════════════════════════════ DASHBOARD ══════════════════════════════════════ -->
<div class="section active" id="sec-dashboard">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><h1>Dashboard Overview</h1><p>Real-time platform metrics and analytics</p></div>
        <div style="display:flex;gap:0.5rem;flex-shrink:0">
            <button class="btn btn-green btn-sm" onclick="exportDashboardCSV()"><i class="fas fa-download"></i> CSV</button>
            <button class="btn btn-purple btn-sm" onclick="openReport('dashboard')"><i class="fas fa-file-alt"></i> Report</button>
        </div>
    </div>
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- Quick Stats Row -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem">
        <div class="health-stat">
            <div class="health-stat-label">Total Calculations</div>
            <div class="health-stat-value" style="color:#60a5fa" id="totalCalcs">0</div>
            <div class="health-stat-sub">All users</div>
        </div>
        <div class="health-stat">
            <div class="health-stat-label">PDF Exports</div>
            <div class="health-stat-value" style="color:#a78bfa" id="totalPDFs">234</div>
            <div class="health-stat-sub">Last 30 days</div>
        </div>
        <div class="health-stat">
            <div class="health-stat-label">Active Sessions</div>
            <div class="health-stat-value" style="color:#34d399" id="activeSessions">0</div>
            <div class="health-stat-sub">Today</div>
        </div>
        <div class="health-stat">
            <div class="health-stat-label">System Uptime</div>
            <div class="health-stat-value" style="color:#34d399">99.97%</div>
            <div class="health-stat-sub">Last 30 days</div>
        </div>
    </div>

    <div class="charts-row">
        <div class="card"><div class="card-title"><i class="fas fa-chart-line" style="color:#60a5fa"></i> User Growth (6 Months)</div><canvas id="chartGrowth" height="110"></canvas></div>
        <div class="card"><div class="card-title"><i class="fas fa-chart-pie" style="color:#a78bfa"></i> Tier Distribution</div><canvas id="chartTier" height="220"></canvas></div>
    </div>
    <div class="charts-row">
        <div class="card"><div class="card-title"><i class="fas fa-globe-americas" style="color:#22d3ee"></i> Calculator Usage by Hour (Last 7d)</div><canvas id="chartUsageHour" height="90"></canvas></div>
        <div class="card"><div class="card-title"><i class="fas fa-funnel-dollar" style="color:#fbbf24"></i> Conversion Funnel</div><canvas id="chartFunnel" height="220"></canvas></div>
    </div>

    <!-- Geo Distribution Chart -->
    <div class="card" style="margin-bottom:1.5rem">
        <div class="card-title"><i class="fas fa-map-marker-alt" style="color:#f87171"></i> User Geographic Distribution</div>
        <canvas id="chartGeo" height="120"></canvas>
    </div>

    <!-- Recent Activity Feed -->
    <div class="card">
        <div class="card-title"><i class="fas fa-stream" style="color:#a78bfa"></i> Recent Activity</div>
        <div id="dashActivity" style="max-height:300px;overflow-y:auto;"></div>
    </div>
</div>

<!-- ══════════════════════════════════════ REVENUE ══════════════════════════════════════ -->
<div class="section" id="sec-revenue">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><h1>Revenue Analytics</h1><p>Subscription revenue, LTV, churn, and financial metrics</p></div>
        <div style="display:flex;gap:0.5rem;flex-shrink:0">
            <button class="btn btn-green btn-sm" onclick="exportRevenueCSV()"><i class="fas fa-download"></i> CSV</button>
            <button class="btn btn-purple btn-sm" onclick="openReport('revenue')"><i class="fas fa-file-alt"></i> Report</button>
        </div>
    </div>
    <div class="kpi-grid" id="revenueKpis"></div>
    <div class="charts-row">
        <div class="card"><div class="card-title"><i class="fas fa-chart-area" style="color:#34d399"></i> Monthly Recurring Revenue (MRR)</div><canvas id="chartMRR" height="110"></canvas></div>
        <div class="card"><div class="card-title"><i class="fas fa-percentage" style="color:#f87171"></i> Churn Rate</div><canvas id="chartChurn" height="220"></canvas></div>
    </div>
    <div class="card">
        <div class="card-title"><i class="fas fa-money-bill-wave" style="color:#fbbf24"></i> Revenue by Account</div>
        <div class="tbl-overflow" id="revenueTableWrap"></div>
    </div>
</div>

<!-- ══════════════════════════════════════ USERS ══════════════════════════════════════ -->
<div class="section" id="sec-users">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><h1>User Management</h1><p>Manage accounts, tiers, status, and access</p></div>
        <button class="btn btn-purple btn-sm" onclick="openReport('users')"><i class="fas fa-file-alt"></i> Report</button>
    </div>
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;">
            <div class="card-title" style="margin:0"><i class="fas fa-user-cog" style="color:#a78bfa"></i> All Users</div>
            <div class="tbl-controls" style="margin:0">
                <div class="tbl-search"><i class="fas fa-search"></i><input id="userSearch" placeholder="Search email or name..." oninput="filterUsers()"></div>
                <select class="tbl-select" id="tierFilter" onchange="filterUsers()"><option value="all">All Tiers</option><option value="pro">Pro</option><option value="free">Free</option></select>
                <select class="tbl-select" id="statusFilter" onchange="filterUsers()"><option value="all">All Status</option><option value="active">Active</option><option value="inactive">Inactive</option><option value="suspended">Suspended</option></select>
                <button class="btn btn-green" onclick="exportCSV()"><i class="fas fa-download"></i> Export CSV</button>
                <button class="btn btn-purple" onclick="openCreateModal()" style="background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(168,85,247,0.1));border:1px solid rgba(139,92,246,0.4);color:#a78bfa;"><i class="fas fa-user-plus"></i> Create Account</button>
            </div>
        </div>
        <div class="tbl-overflow">
            <table class="data-tbl" id="userTable">
                <thead><tr>
                    <th onclick="sortTable('name')">Name <i class="fas fa-sort si"></i></th>
                    <th onclick="sortTable('email')">Email <i class="fas fa-sort si"></i></th>
                    <th onclick="sortTable('tier')">Tier <i class="fas fa-sort si"></i></th>
                    <th onclick="sortTable('status')">Status <i class="fas fa-sort si"></i></th>
                    <th onclick="sortTable('registered')">Registered <i class="fas fa-sort si"></i></th>
                    <th onclick="sortTable('lastLogin')">Last Login <i class="fas fa-sort si"></i></th>
                    <th onclick="sortTable('usage')">Calcs <i class="fas fa-sort si"></i></th>
                    <th onclick="sortTable('lastPayment')">Payment <i class="fas fa-sort si"></i></th>
                    <th>Actions</th>
                </tr></thead>
                <tbody id="userTbody"></tbody>
            </table>
        </div>
        <div class="pagination"><div class="pagination-info" id="pgInfo"></div><div class="pagination-btns" id="pgBtns"></div></div>
    </div>
</div>

<!-- ══════════════════════════════════════ CREDENTIALS ══════════════════════════════════════ -->
<div class="section" id="sec-credentials">
    <div class="section-header">
        <h1>Account Credentials</h1>
        <p>View and manage all registered account credentials</p>
    </div>
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div class="card-title" style="margin:0"><i class="fas fa-key" style="color:#fbbf24"></i> Credential Vault</div>
            <div style="display:flex;gap:0.5rem;">
                <button class="btn btn-ghost btn-sm" onclick="toggleAllPasswords()"><i class="fas fa-eye"></i> Toggle All</button>
                <button class="btn btn-green btn-sm" onclick="exportCredCSV()"><i class="fas fa-download"></i> Export</button>
            </div>
        </div>
        <div class="tbl-overflow" id="credentialsList"></div>
    </div>
</div>

<!-- ══════════════════════════════════════ FEATURES ══════════════════════════════════════ -->
<div class="section" id="sec-features">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><h1>Feature Flags</h1><p>Toggle calculator features per subscription tier in real-time</p></div>
        <div style="display:flex;gap:0.5rem;flex-shrink:0">
            <button class="btn btn-green btn-sm" onclick="exportFeaturesCSV()"><i class="fas fa-download"></i> CSV</button>
            <button class="btn btn-purple btn-sm" onclick="openReport('features')"><i class="fas fa-file-alt"></i> Report</button>
        </div>
    </div>
    <div class="card">
        <div class="card-title"><i class="fas fa-sliders-h" style="color:#22d3ee"></i> Tier-Level Feature Matrix</div>
        <p style="font-size:0.78rem;color:#64748b;margin-bottom:1.25rem;">Toggle features ON/OFF per tier. Changes apply immediately to all users of that tier on their next page load.</p>
        <div class="feat-grid" id="featureMatrix"></div>
    </div>
    <div class="card" style="margin-top:1.5rem">
        <div class="card-title"><i class="fas fa-user-shield" style="color:#f59e0b"></i> Per-User Feature Overrides</div>
        <p style="font-size:0.78rem;color:#64748b;margin-bottom:1.25rem;">Grant or revoke individual features for specific users, overriding their tier defaults.</p>
        <div id="userOverrides"></div>
    </div>
    <div class="card" style="margin-top:1.5rem">
        <div class="card-title"><i class="fas fa-flask" style="color:#a78bfa"></i> Experimental Features</div>
        <div id="experimentalFeatures"></div>
    </div>
</div>

<!-- ══════════════════════════════════════ BENCHMARKS ══════════════════════════════════════ -->
<div class="section" id="sec-benchmarks">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
            <h1>Data Center Industry Intelligence</h1>
            <p>Comprehensive global DC capacity data — 50+ operators, 28 countries, 35 facilities · Synergy, CBRE, JLL, C&W 2025-2026</p>
            <div style="font-size:0.62rem;color:#475569;margin-top:4px"><i class="fas fa-clock" style="margin-right:3px"></i>Last updated: Feb 2026 · Sources: Synergy Q3 2025, CBRE H1 2025, JLL 2026 Outlook</div>
        </div>
        <div style="display:flex;gap:0.5rem;flex-shrink:0;align-items:center;flex-wrap:wrap">
            <div style="position:relative"><i class="fas fa-search" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);color:#475569;font-size:0.7rem"></i><input type="text" id="dcGlobalSearch" placeholder="Search all..." style="padding:5px 8px 5px 26px;background:#0f172a;border:1px solid #334155;border-radius:6px;color:#e2e8f0;font-size:0.72rem;font-family:inherit;outline:none;width:160px" oninput="dcGlobalSearchFilter(this.value)"></div>
            <button class="btn btn-ghost btn-sm" onclick="openDcCompareMode()" title="Compare operators"><i class="fas fa-columns"></i> Compare</button>
            <button class="btn btn-green btn-sm" onclick="exportBenchmarksCSV()"><i class="fas fa-download"></i> CSV</button>
            <button class="btn btn-amber btn-sm" onclick="exportBenchJSON()" title="Export as JSON"><i class="fas fa-code"></i> JSON</button>
            <button class="btn btn-purple btn-sm" onclick="openReport('benchmarks')"><i class="fas fa-file-alt"></i> Report</button>
        </div>
    </div>

    <!-- KPI Summary Row -->
    <div class="bench-grid" id="benchKpis" style="gap:0.6rem;margin-bottom:1rem"></div>

    <!-- Sub-tabs -->
    <div class="bench-tabs">
        <button class="bench-tab active" onclick="showBenchTab('overview')"><i class="fas fa-chart-pie" style="margin-right:4px"></i>Overview</button>
        <button class="bench-tab" onclick="showBenchTab('operators')"><i class="fas fa-building" style="margin-right:4px"></i>Operators (50+)</button>
        <button class="bench-tab" onclick="showBenchTab('countries')"><i class="fas fa-globe-americas" style="margin-right:4px"></i>Countries (28)</button>
        <button class="bench-tab" onclick="showBenchTab('facilities')"><i class="fas fa-server" style="margin-right:4px"></i>Facilities (35)</button>
        <button class="bench-tab" onclick="showBenchTab('market')"><i class="fas fa-chart-line" style="margin-right:4px"></i>Market Intel</button>
        <button class="bench-tab" onclick="showBenchTab('projections')"><i class="fas fa-brain" style="margin-right:4px"></i>Projection Analytics</button>
    </div>

    <!-- ═══ OVERVIEW TAB ═══ -->
    <div class="bench-panel active" id="bp-overview">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0"><div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('topOps')" title="Download PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('topOps')" title="Fullscreen"><i class="fas fa-expand"></i></button></div><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-building" style="color:#60a5fa"></i> Top 15 Operators by Capacity (MW)</div><canvas id="chartTopOperators" height="100"></canvas></div>
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0"><div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('regionCap')" title="Download PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('regionCap')" title="Fullscreen"><i class="fas fa-expand"></i></button></div><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-globe" style="color:#34d399"></i> Capacity by Region</div><canvas id="chartRegionCap" height="100"></canvas></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0"><div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('topCountries')" title="Download PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('topCountries')" title="Fullscreen"><i class="fas fa-expand"></i></button></div><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-flag" style="color:#fbbf24"></i> Top 15 Countries by Capacity (MW)</div><canvas id="chartTopCountries" height="100"></canvas></div>
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0"><div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('capex')" title="Download PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('capex')" title="Fullscreen"><i class="fas fa-expand"></i></button></div><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-dollar-sign" style="color:#a78bfa"></i> Hyperscaler CapEx 2025 ($B)</div><canvas id="chartCapex" height="100"></canvas></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0"><div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('growth')" title="Download PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('growth')" title="Fullscreen"><i class="fas fa-expand"></i></button></div><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-chart-area" style="color:#22d3ee"></i> Growth Rate by Country (% YoY)</div><canvas id="chartGrowthRate" height="100"></canvas></div>
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0"><div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('typeDistrib')" title="Download PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('typeDistrib')" title="Fullscreen"><i class="fas fa-expand"></i></button></div><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-layer-group" style="color:#f87171"></i> Operator Type Distribution</div><canvas id="chartTypeDistrib" height="100"></canvas></div>
        </div>
        <!-- A1: Scatter Capacity vs CapEx | A6: Radar Regional Comparison -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-braille" style="color:#a78bfa"></i> Capacity vs CapEx by Operator</div><canvas id="chartScatterCapVsCapex" height="140"></canvas></div>
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-spider" style="color:#60a5fa"></i> Regional Comparison (Radar)</div><canvas id="chartRadarRegion" height="140"></canvas></div>
        </div>
        <!-- A3: Scatter Country Capacity vs Growth | A7: Stacked Bar Capacity by Type per Region -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-bullseye" style="color:#34d399"></i> Country Capacity vs Growth Rate</div><canvas id="chartScatterCountryGrowth" height="140"></canvas></div>
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-chart-bar" style="color:#fbbf24"></i> Capacity by Type per Region</div><canvas id="chartStackedRegionType" height="140"></canvas></div>
        </div>
        <!-- A4: City-Level Capacity Scatter | C5: Market Share Treemap | C8: Top Cities -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-map-pin" style="color:#f87171"></i> City-Level Capacity Distribution</div><canvas id="chartScatterCityCapacity" height="140"></canvas></div>
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-city" style="color:#22d3ee"></i> Top 10 Cities by Total Capacity</div><canvas id="chartTopCities" height="140"></canvas></div>
        </div>
    </div>

    <!-- ═══ OPERATORS TAB ═══ -->
    <div class="bench-panel" id="bp-operators">
        <div class="bench-filters">
            <div class="bench-filter-group">
                <span class="bench-filter-label">Type:</span>
                <select class="bench-select" id="benchOpType" onchange="filterBenchOps()">
                    <option value="all">All Types</option>
                    <option value="Hyperscale">Hyperscale</option>
                    <option value="Colocation">Colocation</option>
                    <option value="Wholesale">Wholesale</option>
                    <option value="Edge">Edge</option>
                </select>
            </div>
            <div class="bench-filter-group">
                <span class="bench-filter-label">Region:</span>
                <select class="bench-select" id="benchOpRegion" onchange="filterBenchOps()">
                    <option value="all">All Regions</option>
                    <option value="Americas">Americas</option>
                    <option value="EMEA">EMEA</option>
                    <option value="APAC">APAC</option>
                </select>
            </div>
            <div class="bench-filter-group">
                <span class="bench-filter-label">Search:</span>
                <input type="text" class="bench-input" id="benchOpSearch" placeholder="Search operator..." oninput="filterBenchOps()">
            </div>
            <div class="bench-filter-group" style="margin-left:auto;display:flex;gap:4px;align-items:center">
                <span style="font-size:0.65rem;color:#64748b" id="benchOpCount">50 operators</span>
                <button class="bench-btn bench-btn-ghost" onclick="exportTabCSV('operators')" title="Export operators CSV"><i class="fas fa-download" style="font-size:0.6rem"></i></button>
            </div>
        </div>
        <!-- A5: Bubble Operator Market Position | C9: Diversification Score -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-circle" style="color:#a78bfa"></i> Operator Market Position (Bubble)</div><canvas id="chartBubbleOperator" height="160"></canvas></div>
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-project-diagram" style="color:#34d399"></i> Geographic Diversification Score</div><canvas id="chartDiversification" height="160"></canvas></div>
        </div>
        <div class="card" style="padding:1rem;margin-bottom:0.75rem">
            <div class="tbl-overflow" id="benchOpTable"></div>
            <div class="bench-pagination" id="benchOpPagination"></div>
        </div>
    </div>

    <!-- ═══ COUNTRIES TAB ═══ -->
    <div class="bench-panel" id="bp-countries">
        <div class="bench-filters">
            <div class="bench-filter-group">
                <span class="bench-filter-label">Region:</span>
                <select class="bench-select" id="benchCountryRegion" onchange="filterBenchCountries()">
                    <option value="all">All Regions</option>
                    <option value="Americas">Americas</option>
                    <option value="EMEA">EMEA</option>
                    <option value="APAC">APAC</option>
                </select>
            </div>
            <div class="bench-filter-group">
                <span class="bench-filter-label">Growth:</span>
                <select class="bench-select" id="benchCountryGrowth" onchange="filterBenchCountries()">
                    <option value="all">All</option>
                    <option value="high">High Growth (>15%)</option>
                    <option value="medium">Medium (8-15%)</option>
                    <option value="low">Low (<8%)</option>
                </select>
            </div>
            <div class="bench-filter-group">
                <span class="bench-filter-label">Search:</span>
                <input type="text" class="bench-input" id="benchCountrySearch" placeholder="Search country..." oninput="filterBenchCountries()">
            </div>
            <div class="bench-filter-group" style="margin-left:auto;display:flex;gap:4px;align-items:center">
                <span style="font-size:0.65rem;color:#64748b" id="benchCountryCount">28 countries</span>
                <button class="bench-btn bench-btn-ghost" onclick="exportTabCSV('countries')" title="Export countries CSV"><i class="fas fa-download" style="font-size:0.6rem"></i></button>
            </div>
        </div>
        <div class="card" style="padding:1rem;margin-bottom:0.75rem">
            <div class="tbl-overflow" id="benchCountryTable"></div>
        </div>
    </div>

    <!-- ═══ FACILITIES TAB ═══ -->
    <div class="bench-panel" id="bp-facilities">
        <div class="bench-filters">
            <div class="bench-filter-group">
                <span class="bench-filter-label">Size:</span>
                <select class="bench-select" id="benchFacSize" onchange="filterBenchFacilities()">
                    <option value="all">All Sizes</option>
                    <option value="mega">Mega (500+ MW)</option>
                    <option value="large">Large (200-500 MW)</option>
                    <option value="medium">Medium (100-200 MW)</option>
                    <option value="standard">Standard (<100 MW)</option>
                </select>
            </div>
            <div class="bench-filter-group">
                <span class="bench-filter-label">Country:</span>
                <select class="bench-select" id="benchFacCountry" onchange="filterBenchFacilities()">
                    <option value="all">All Countries</option>
                </select>
            </div>
            <div class="bench-filter-group">
                <span class="bench-filter-label">Year:</span>
                <select class="bench-select" id="benchFacYear" onchange="filterBenchFacilities()">
                    <option value="all">All Years</option>
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="pre2024">Pre-2024</option>
                </select>
            </div>
            <div class="bench-filter-group" style="margin-left:auto;display:flex;gap:4px;align-items:center">
                <span style="font-size:0.65rem;color:#64748b" id="benchFacCount">35 facilities</span>
                <button class="bench-btn bench-btn-ghost" onclick="exportTabCSV('facilities')" title="Export facilities CSV"><i class="fas fa-download" style="font-size:0.6rem"></i></button>
            </div>
        </div>
        <!-- A2: Scatter Facility MW vs Year | C6: Size Distribution Histogram | C7: Commissioning Timeline -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-braille" style="color:#a78bfa"></i> Facility MW vs Year Built</div><canvas id="chartScatterFacYear" height="160"></canvas></div>
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-chart-bar" style="color:#60a5fa"></i> Size Distribution</div><canvas id="chartFacHistogram" height="160"></canvas></div>
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-calendar-alt" style="color:#34d399"></i> Commissioning Timeline</div><canvas id="chartCommissionTimeline" height="160"></canvas></div>
        </div>
        <div class="card" style="padding:1rem;margin-bottom:0.75rem">
            <div class="tbl-overflow" id="benchFacTable"></div>
        </div>
    </div>

    <!-- ═══ MARKET INTEL TAB ═══ -->
    <div class="bench-panel" id="bp-market">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem;margin-bottom:0.75rem" id="benchMarketKpis"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card" style="padding:1rem;margin-bottom:0">
                <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-cloud" style="color:#60a5fa"></i> Hyperscale Metrics</div>
                <div id="benchHyperscaleInfo"></div>
            </div>
            <div class="card" style="padding:1rem;margin-bottom:0">
                <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-coins" style="color:#fbbf24"></i> Investment Outlook</div>
                <div id="benchInvestmentInfo"></div>
            </div>
        </div>
        <div class="card" style="padding:1rem;margin-bottom:0.75rem">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-map-marked-alt" style="color:#34d399"></i> Regional Breakdown</div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem" id="benchRegionalInfo"></div>
        </div>
        <!-- A8: Projected Capacity Timeline | C10: Investment Gap Analysis -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-chart-area" style="color:#a78bfa"></i> Projected Capacity Timeline (GW)</div><canvas id="chartCapacityTimeline" height="160"></canvas></div>
            <div class="card" style="padding:1rem;margin-bottom:0"><div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-balance-scale" style="color:#fbbf24"></i> Investment Gap Analysis ($B)</div><canvas id="chartInvestmentGap" height="160"></canvas></div>
        </div>
        <div class="card" style="padding:1rem;margin-bottom:0.75rem">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-exclamation-triangle" style="color:#f87171"></i> Key Market Constraints</div>
            <div id="benchConstraints"></div>
        </div>
        <div class="card" style="padding:1rem;margin-bottom:0">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-book" style="color:#64748b"></i> Sources & Methodology</div>
            <p style="font-size:0.72rem;color:#94a3b8;line-height:1.5" id="benchSources"></p>
        </div>
    </div>

    <!-- ═══ PROJECTION ANALYTICS TAB ═══ -->
    <div class="bench-panel" id="bp-projections">
        <div style="margin-bottom:1rem">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                <i class="fas fa-brain" style="color:#a78bfa;font-size:0.9rem"></i>
                <span style="font-size:0.85rem;font-weight:700;color:#f1f5f9">AI/Cloud Demand vs DC Supply — Projection Model</span>
            </div>
            <p style="font-size:0.72rem;color:#64748b;line-height:1.5">Interpolated projections using compound growth modeling on existing capacity data, AI/cloud provider CapEx trajectories, and regional supply pipeline analysis. Model factors: historical CAGR, announced buildout, power grid constraints, and AI compute demand curves (training + inference).</p>
        </div>

        <!-- KPI Summary for Projections -->
        <div class="bench-grid" id="projKpis" style="grid-template-columns:repeat(6,1fr);gap:0.6rem;margin-bottom:1rem"></div>

        <!-- Row 1: Regional Supply vs Demand Projection + Gap Waterfall -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0">
                <div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('projRegionSupplyDemand')" title="PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('projRegionSupplyDemand')" title="Fullscreen"><i class="fas fa-expand"></i></button></div>
                <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-chart-area" style="color:#60a5fa"></i> Regional DC Supply vs AI/Cloud Demand (GW) — 2024→2030</div>
                <canvas id="chartProjRegionSupplyDemand" height="180"></canvas>
            </div>
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0">
                <div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('projGapWaterfall')" title="PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('projGapWaterfall')" title="Fullscreen"><i class="fas fa-expand"></i></button></div>
                <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-exclamation-triangle" style="color:#f87171"></i> Supply-Demand Gap by Region (GW Deficit 2030)</div>
                <canvas id="chartProjGapWaterfall" height="180"></canvas>
            </div>
        </div>

        <!-- Row 2: AI Provider CapEx vs Colo/Hyperscale Buildout + Provider Type Matrix -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0">
                <div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('projProviderVsInfra')" title="PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('projProviderVsInfra')" title="Fullscreen"><i class="fas fa-expand"></i></button></div>
                <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-balance-scale-right" style="color:#fbbf24"></i> AI/Cloud Provider CapEx vs DC Infrastructure Buildout ($B)</div>
                <canvas id="chartProjProviderVsInfra" height="180"></canvas>
            </div>
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0">
                <div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('projProviderTypeScatter')" title="PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('projProviderTypeScatter')" title="Fullscreen"><i class="fas fa-expand"></i></button></div>
                <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-braille" style="color:#a78bfa"></i> Provider Demand (GW) vs Colo/Hyperscale/Edge Allocation</div>
                <canvas id="chartProjProviderTypeScatter" height="180"></canvas>
            </div>
        </div>

        <!-- Row 3: Demand Growth by Provider Timeline + Infrastructure Type Gap Radar -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0">
                <div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('projProviderTimeline')" title="PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('projProviderTimeline')" title="Fullscreen"><i class="fas fa-expand"></i></button></div>
                <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-chart-line" style="color:#34d399"></i> AI/Cloud Provider Capacity Demand Trajectory (GW)</div>
                <canvas id="chartProjProviderTimeline" height="180"></canvas>
            </div>
            <div class="card dc-chart-wrap" style="padding:1rem;margin-bottom:0">
                <div class="dc-chart-actions"><button class="dc-chart-btn" onclick="exportChartPNG('projInfraTypeGap')" title="PNG"><i class="fas fa-image"></i></button><button class="dc-chart-btn" onclick="openChartFullscreen('projInfraTypeGap')" title="Fullscreen"><i class="fas fa-expand"></i></button></div>
                <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-spider" style="color:#22d3ee"></i> Infrastructure Type Balance — Supply vs Demand (Radar)</div>
                <canvas id="chartProjInfraTypeGap" height="180"></canvas>
            </div>
        </div>

        <!-- Row 4: Provider Comparison Table -->
        <div class="card" style="padding:1rem;margin-bottom:0.75rem">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-th" style="color:#a78bfa"></i> AI/Cloud Provider vs Infrastructure Type — Demand Allocation Matrix</div>
            <div class="tbl-overflow" id="projProviderTable"></div>
        </div>

        <!-- Row 5: Regional Projection Detail Table -->
        <div class="card" style="padding:1rem;margin-bottom:0.75rem">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-globe" style="color:#34d399"></i> Regional Supply-Demand Projection Detail (2025→2030)</div>
            <div class="tbl-overflow" id="projRegionTable"></div>
        </div>

        <!-- Row 6: Gap Analysis Insights -->
        <div class="card" style="padding:1rem;margin-bottom:0.75rem">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-lightbulb" style="color:#fbbf24"></i> Key Supply-Demand Imbalance Insights</div>
            <div id="projInsights"></div>
        </div>

        <!-- Methodology -->
        <div class="card" style="padding:1rem;margin-bottom:0">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-cogs" style="color:#64748b"></i> Projection Methodology</div>
            <div id="projMethodology"></div>
        </div>
    </div>
</div>

<!-- ═══ DC INTEL MODALS ═══ -->
<div class="modal-overlay" id="dcOperatorModal">
    <div class="modal-box" style="max-width:780px">
        <button class="modal-close" onclick="document.getElementById('dcOperatorModal').classList.remove('show')">&times;</button>
        <div id="dcOperatorModalContent"></div>
    </div>
</div>
<div class="modal-overlay" id="dcCountryPanel">
    <div class="modal-box" style="max-width:780px">
        <button class="modal-close" onclick="document.getElementById('dcCountryPanel').classList.remove('show')">&times;</button>
        <div id="dcCountryPanelContent"></div>
    </div>
</div>
<div class="modal-overlay" id="dcCompareModal">
    <div class="modal-box" style="max-width:900px">
        <button class="modal-close" onclick="document.getElementById('dcCompareModal').classList.remove('show')">&times;</button>
        <div id="dcCompareContent"></div>
    </div>
</div>
<div class="modal-overlay" id="dcChartFullscreen">
    <div class="modal-box" style="max-width:95vw;max-height:95vh;padding:1rem">
        <button class="modal-close" onclick="document.getElementById('dcChartFullscreen').classList.remove('show')">&times;</button>
        <canvas id="chartFullscreenCanvas" style="width:100%;height:80vh"></canvas>
    </div>
</div>

<!-- ══════════════════════════════════════ AUDIT ══════════════════════════════════════ -->
<div class="section" id="sec-audit">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><h1>Audit Log</h1><p>Complete system event timeline with filters</p></div>
        <button class="btn btn-purple btn-sm" onclick="openReport('audit')"><i class="fas fa-file-alt"></i> Report</button>
    </div>
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;">
            <div class="card-title" style="margin:0"><i class="fas fa-stream" style="color:#60a5fa"></i> Event Timeline</div>
            <div class="tbl-controls" style="margin:0">
                <select class="tbl-select" id="auditTypeFilter" onchange="filterAudit()"><option value="all">All Types</option><option value="login">Login</option><option value="logout">Logout</option><option value="calculation">Calculation</option><option value="pdf">PDF Export</option><option value="tier_change">Tier Change</option><option value="feature_toggle">Feature Toggle</option></select>
                <button class="btn btn-green btn-sm" onclick="exportAuditCSV()"><i class="fas fa-download"></i> Export</button>
            </div>
        </div>
        <div id="auditTimeline" style="max-height:600px;overflow-y:auto;"></div>
    </div>
</div>

<!-- ══════════════════════════════════════ SUBSCRIBERS ══════════════════════════════════════ -->
<div class="section" id="sec-subscribers">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><h1>Newsletter Subscribers</h1><p>Manage email subscribers from article newsletter forms</p></div>
        <button class="btn btn-purple btn-sm" onclick="openReport('subscribers')"><i class="fas fa-file-alt"></i> Report</button>
    </div>
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;">
            <div class="card-title" style="margin:0"><i class="fas fa-envelope-open-text" style="color:#34d399"></i> Subscriber List</div>
            <div class="tbl-controls" style="margin:0;display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
                <input type="text" id="subSearch" placeholder="Search email..." oninput="renderSubscribers()" style="padding:0.4rem 0.75rem;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#e2e8f0;font-size:0.8rem;width:180px;">
                <select class="tbl-select" id="subSourceFilter" onchange="renderSubscribers()"><option value="all">All Sources</option></select>
                <select class="tbl-select" id="subStatusFilter" onchange="renderSubscribers()"><option value="all">All Status</option><option value="active">Active</option><option value="unsubscribed">Unsubscribed</option></select>
                <button class="btn btn-green btn-sm" onclick="exportSubscribersCSV()"><i class="fas fa-download"></i> Export CSV</button>
            </div>
        </div>
        <div style="overflow-x:auto;">
            <table class="tbl" id="subscribersTable">
                <thead><tr><th>Email</th><th>Date Subscribed</th><th>Source</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="subTableBody"></tbody>
            </table>
        </div>
        <div id="subEmpty" style="display:none;text-align:center;padding:3rem;color:#64748b;">
            <i class="fas fa-inbox" style="font-size:2rem;margin-bottom:1rem;display:block;opacity:0.5"></i>
            No subscribers yet. Newsletter signups from articles will appear here.
        </div>
    </div>
</div>

<!-- ══════════════════════════════════════ MAYAR PAYMENTS ══════════════════════════════════════ -->
<div class="section" id="sec-mayar">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><h1>Mayar Payments</h1><p>Live payment operations dashboard — Mayar API integration</p></div>
        <button class="btn btn-purple btn-sm" onclick="openReport('mayar')"><i class="fas fa-file-alt"></i> Report</button>
    </div>

    <!-- Sub-tabs -->
    <div class="mayar-tabs">
        <button class="mayar-tab active" onclick="showMayarTab('overview')">Overview</button>
        <button class="mayar-tab" onclick="showMayarTab('transactions')">Transactions</button>
        <button class="mayar-tab" onclick="showMayarTab('customers')">Customers</button>
        <button class="mayar-tab" onclick="showMayarTab('membership')">Memberships</button>
        <button class="mayar-tab" onclick="showMayarTab('actions')">Quick Actions</button>
    </div>

    <!-- ═══ OVERVIEW TAB ═══ -->
    <div class="mayar-panel active" id="mayar-overview">
        <div class="kpi-grid" id="mayarKpiGrid">
            <div class="kpi">
                <div class="kpi-icon" style="background:rgba(52,211,153,0.15);color:#34d399"><i class="fas fa-wallet"></i></div>
                <div class="kpi-label">Balance</div>
                <div class="kpi-val" id="mayarBalance">—</div>
                <div class="kpi-sub neutral">Live from Mayar</div>
            </div>
            <div class="kpi">
                <div class="kpi-icon" style="background:rgba(96,165,250,0.15);color:#60a5fa"><i class="fas fa-check-circle"></i></div>
                <div class="kpi-label">Paid Transactions</div>
                <div class="kpi-val" id="mayarPaidCount">—</div>
                <div class="kpi-sub up"><i class="fas fa-arrow-up"></i> Paid</div>
            </div>
            <div class="kpi">
                <div class="kpi-icon" style="background:rgba(245,158,11,0.15);color:#fbbf24"><i class="fas fa-clock"></i></div>
                <div class="kpi-label">Unpaid</div>
                <div class="kpi-val" id="mayarUnpaidCount">—</div>
                <div class="kpi-sub down">Pending</div>
            </div>
            <div class="kpi">
                <div class="kpi-icon" style="background:rgba(168,85,247,0.15);color:#a78bfa"><i class="fas fa-coins"></i></div>
                <div class="kpi-label">Gross Revenue</div>
                <div class="kpi-val" id="mayarGrossRevenue">—</div>
                <div class="kpi-sub up"><i class="fas fa-arrow-up"></i> Total</div>
            </div>
        </div>

        <div class="charts-row">
            <div class="card">
                <div class="card-title" style="justify-content:space-between">
                    <span><i class="fas fa-chart-line" style="color:#60a5fa"></i> Revenue Trend</span>
                    <div style="display:flex;gap:4px">
                        <button class="mayar-period-btn active" onclick="loadRevenuePeriod('day')">Day</button>
                        <button class="mayar-period-btn" onclick="loadRevenuePeriod('week')">Week</button>
                        <button class="mayar-period-btn" onclick="loadRevenuePeriod('month')">Month</button>
                        <button class="mayar-period-btn" onclick="loadRevenuePeriod('year')">Year</button>
                    </div>
                </div>
                <canvas id="mayarRevenueChart" height="110"></canvas>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-info-circle" style="color:#a78bfa"></i> Status</div>
                <div style="margin-bottom:0.75rem">
                    <div class="mayar-rate">
                        <span>API Rate:</span>
                        <span id="mayarRateText">0 / 20 per min</span>
                        <div class="mayar-rate-bar"><div class="mayar-rate-fill" id="mayarRateFill" style="width:0%"></div></div>
                    </div>
                </div>
                <div style="font-size:0.72rem;color:#64748b;margin-bottom:0.5rem">Last refreshed: <span id="mayarLastRefresh">Never</span></div>
                <button class="btn btn-purple btn-sm" onclick="refreshMayarAll()"><i class="fas fa-sync-alt"></i> Refresh All</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title"><i class="fas fa-list" style="color:#34d399"></i> Recent Transactions</div>
            <div style="overflow-x:auto">
                <table class="tbl" id="mayarRecentTbl">
                    <thead><tr><th>Date</th><th>Customer</th><th>Description</th><th>Amount</th><th>Status</th></tr></thead>
                    <tbody id="mayarRecentBody"><tr><td colspan="5" class="mayar-loading">Loading transactions...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ═══ TRANSACTIONS TAB ═══ -->
    <div class="mayar-panel" id="mayar-transactions">
        <div class="tbl-controls">
            <select class="tbl-select" id="mayarTxStatus" onchange="filterMayarTx()">
                <option value="all">All Status</option>
                <option value="paid">Paid</option>
                <option value="unpaid">Unpaid</option>
            </select>
            <select class="tbl-select" id="mayarTxPeriod" onchange="filterMayarTx()">
                <option value="">No Period Filter</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
            </select>
            <input type="date" class="mayar-input" id="mayarTxDateFrom" style="width:auto" placeholder="From">
            <input type="date" class="mayar-input" id="mayarTxDateTo" style="width:auto" placeholder="To">
            <input type="text" class="mayar-input" id="mayarTxProductId" style="width:180px" placeholder="Product ID (optional)">
            <button class="btn btn-purple btn-sm" onclick="filterMayarTx()"><i class="fas fa-filter"></i> Filter</button>
            <button class="btn btn-green btn-sm" onclick="exportMayarTxCSV()"><i class="fas fa-download"></i> Export CSV</button>
        </div>

        <div class="card" style="margin-bottom:1rem">
            <div class="card-title"><i class="fas fa-chart-bar" style="color:#fbbf24"></i> Transaction Volume</div>
            <canvas id="mayarTxChart" height="80"></canvas>
        </div>

        <div class="card">
            <div style="overflow-x:auto">
                <table class="tbl">
                    <thead><tr><th>Date</th><th>Customer</th><th>Email</th><th>Description</th><th>Amount</th><th>Status</th></tr></thead>
                    <tbody id="mayarTxBody"><tr><td colspan="6" class="mayar-loading">Select filters and click Filter</td></tr></tbody>
                </table>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem">
                <span style="font-size:0.75rem;color:#64748b" id="mayarTxInfo">Showing 0 transactions</span>
                <div style="display:flex;gap:4px">
                    <button class="btn btn-ghost btn-sm" id="mayarTxPrev" onclick="mayarTxPage(-1)" disabled>&laquo; Prev</button>
                    <button class="btn btn-ghost btn-sm" id="mayarTxNext" onclick="mayarTxPage(1)">Next &raquo;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══ CUSTOMERS TAB ═══ -->
    <div class="mayar-panel" id="mayar-customers">
        <div class="tbl-controls" style="margin-bottom:1.5rem">
            <div class="tbl-search">
                <i class="fas fa-search"></i>
                <input type="text" id="mayarCustSearch" placeholder="Search by name or email..." style="width:320px" onkeydown="if(event.key==='Enter')searchMayarCustomer()">
            </div>
            <button class="btn btn-purple btn-sm" onclick="searchMayarCustomer()"><i class="fas fa-search"></i> Search</button>
        </div>

        <div id="mayarCustResult" style="display:none">
            <div class="mayar-cust-card" id="mayarCustCard">
                <h4><i class="fas fa-user" style="color:#60a5fa;margin-right:6px"></i> Customer Detail</h4>
                <div id="mayarCustDetail"></div>
            </div>
            <div style="display:flex;gap:0.5rem;margin-bottom:1.5rem">
                <button class="btn btn-green btn-sm" onclick="sendMayarPortalLinkForCust()"><i class="fas fa-paper-plane"></i> Send Portal Link</button>
                <select class="tbl-select" id="mayarCustTxPeriod">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                </select>
                <button class="btn btn-purple btn-sm" onclick="loadMayarCustTx()"><i class="fas fa-history"></i> Load Transactions</button>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-receipt" style="color:#34d399"></i> Customer Transactions</div>
                <div style="overflow-x:auto">
                    <table class="tbl">
                        <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Status</th></tr></thead>
                        <tbody id="mayarCustTxBody"><tr><td colspan="4" style="color:#64748b;text-align:center;padding:1.5rem">Search a customer to see transactions</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="mayarCustEmpty" class="card" style="text-align:center;padding:3rem;color:#64748b">
            <i class="fas fa-user-search" style="font-size:2rem;margin-bottom:0.75rem;display:block;color:#334155"></i>
            Search for a customer by name or email above
        </div>
    </div>

    <!-- ═══ MEMBERSHIPS TAB ═══ -->
    <div class="mayar-panel" id="mayar-membership">
        <div class="tbl-controls" style="margin-bottom:1.5rem">
            <input type="text" class="mayar-input" id="mayarMemProductId" placeholder="Product ID *" style="width:260px">
            <input type="text" class="mayar-input" id="mayarMemTierId" placeholder="Tier ID (optional)" style="width:220px">
            <button class="btn btn-purple btn-sm" onclick="loadMayarMembers()"><i class="fas fa-users"></i> Load Members</button>
        </div>
        <div class="card">
            <div class="card-title"><i class="fas fa-id-badge" style="color:#a78bfa"></i> Membership Members</div>
            <div style="overflow-x:auto">
                <table class="tbl">
                    <thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Tier</th><th>Joined</th><th>Actions</th></tr></thead>
                    <tbody id="mayarMemBody"><tr><td colspan="6" style="color:#64748b;text-align:center;padding:1.5rem">Enter a Product ID and click Load Members</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ═══ QUICK ACTIONS TAB ═══ -->
    <div class="mayar-panel" id="mayar-actions">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
            <!-- Create Invoice -->
            <div class="card">
                <div class="card-title"><i class="fas fa-file-invoice-dollar" style="color:#34d399"></i> Create Invoice</div>
                <div style="display:grid;gap:10px">
                    <div><label class="mayar-label">Customer Name *</label><input class="mayar-input" id="mayarInvName" placeholder="John Doe"></div>
                    <div><label class="mayar-label">Email *</label><input class="mayar-input" id="mayarInvEmail" placeholder="john@example.com" type="email"></div>
                    <div><label class="mayar-label">Mobile</label><input class="mayar-input" id="mayarInvMobile" placeholder="+628123456789"></div>
                    <div><label class="mayar-label">Description *</label><input class="mayar-input" id="mayarInvDesc" placeholder="Pro subscription"></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                        <div><label class="mayar-label">Quantity</label><input class="mayar-input" id="mayarInvQty" type="number" value="1" min="1"></div>
                        <div><label class="mayar-label">Rate (IDR) *</label><input class="mayar-input" id="mayarInvRate" type="number" placeholder="99000"></div>
                    </div>
                    <div><label class="mayar-label">Redirect URL</label><input class="mayar-input" id="mayarInvRedirect" placeholder="https://resistancezero.com/dashboard.html"></div>
                    <div><label class="mayar-label">Expiry (days)</label><input class="mayar-input" id="mayarInvExpiry" type="number" value="7" min="1" max="90"></div>
                    <button class="btn btn-green" onclick="submitMayarInvoice()" style="width:100%;justify-content:center"><i class="fas fa-paper-plane"></i> Create Invoice</button>
                </div>
            </div>

            <!-- Right column -->
            <div>
                <!-- Send Portal Link -->
                <div class="card">
                    <div class="card-title"><i class="fas fa-link" style="color:#60a5fa"></i> Send Portal Link</div>
                    <div style="display:grid;gap:10px">
                        <div><label class="mayar-label">Customer Email *</label><input class="mayar-input" id="mayarPortalEmail" placeholder="customer@example.com" type="email"></div>
                        <button class="btn btn-purple" onclick="sendMayarPortalLink()" style="width:100%;justify-content:center"><i class="fas fa-paper-plane"></i> Send Portal Link</button>
                    </div>
                </div>

                <!-- API Health -->
                <div class="card">
                    <div class="card-title"><i class="fas fa-heartbeat" style="color:#34d399"></i> API Health</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
                        <div class="health-stat">
                            <div class="health-stat-label">Status</div>
                            <div class="health-stat-value" id="mayarHealthStatus" style="color:#64748b">—</div>
                            <div class="health-stat-sub">Mayar API</div>
                        </div>
                        <div class="health-stat">
                            <div class="health-stat-label">Rate Limit</div>
                            <div class="health-stat-value" id="mayarHealthRate" style="color:#64748b">0/20</div>
                            <div class="health-stat-sub">Per minute</div>
                        </div>
                    </div>
                    <button class="btn btn-green btn-sm" onclick="checkMayarHealth()" style="width:100%;justify-content:center"><i class="fas fa-stethoscope"></i> Check Health</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ══════════════════════════════════════ USER ACTIVITY ══════════════════════════════════════ -->
<div class="section" id="sec-activity">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><h1>User Activity</h1><p>Real-time tracking — Pro clicks, demo logins, PDF exports, CV downloads, calculator usage <span id="uaDataSource" style="font-size:0.68rem;color:#475569;margin-left:6px"></span></p></div>
        <button class="btn btn-purple btn-sm" onclick="openReport('activity')"><i class="fas fa-file-alt"></i> Report</button>
    </div>

    <!-- Filter Bar -->
    <div class="ua-filter-bar">
        <label>Period:</label>
        <button class="ua-period-btn active" onclick="setUAPeriod('today',this)">Today</button>
        <button class="ua-period-btn" onclick="setUAPeriod('week',this)">This Week</button>
        <button class="ua-period-btn" onclick="setUAPeriod('month',this)">This Month</button>
        <button class="ua-period-btn" onclick="setUAPeriod('year',this)">This Year</button>
        <button class="ua-period-btn" onclick="setUAPeriod('all',this)">All Time</button>
        <span style="color:#334155;margin:0 4px">|</span>
        <label>Custom:</label>
        <input type="date" id="uaDateFrom" onchange="applyUACustomDate()">
        <span style="color:#64748b;font-size:0.75rem">to</span>
        <input type="date" id="uaDateTo" onchange="applyUACustomDate()">
        <span style="color:#334155;margin:0 4px">|</span>
        <label>Category:</label>
        <select class="tbl-select" id="uaCatFilter" onchange="renderActivity()" style="min-width:140px">
            <option value="all">All Categories</option>
            <option value="pro_click">Pro Mode Click</option>
            <option value="demo_login">Demo Login</option>
            <option value="pdf_export">PDF Export</option>
            <option value="cv_download">CV Download</option>
            <option value="ws_download">Work Sample DL</option>
            <option value="page_view">Page View</option>
            <option value="calc_use">Calculator Use</option>
            <option value="signup">Sign Up</option>
        </select>
        <button class="btn btn-purple btn-sm" onclick="renderActivity()" style="margin-left:auto"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>

    <!-- KPI Row -->
    <div class="kpi-grid" id="uaKpiGrid" style="gap:0.6rem;margin-bottom:1rem"></div>

    <!-- Category Breakdown -->
    <div class="ua-cat-grid" id="uaCatGrid" style="gap:0.5rem;margin-bottom:1rem"></div>

    <!-- Charts Row: Timeline + Category + Hourly -->
    <div style="display:grid;grid-template-columns:1.5fr 0.8fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
        <div class="card" style="padding:1rem;margin-bottom:0">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-chart-line" style="color:#8b5cf6"></i> Timeline</div>
            <canvas id="uaTimelineChart" height="70"></canvas>
        </div>
        <div class="card" style="padding:1rem;margin-bottom:0">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-chart-pie" style="color:#f472b6"></i> Categories</div>
            <canvas id="uaCatChart" height="130"></canvas>
        </div>
        <div class="card" style="padding:1rem;margin-bottom:0">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-th" style="color:#22d3ee"></i> By Hour</div>
            <canvas id="uaHourChart" height="70"></canvas>
        </div>
    </div>

    <!-- Top Pages + Visitors -->
    <div style="display:grid;grid-template-columns:1.2fr 1fr;gap:0.75rem;margin-bottom:0.75rem">
        <div class="card" style="padding:1rem;margin-bottom:0">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-file-alt" style="color:#60a5fa"></i> Top Pages</div>
            <canvas id="uaTopPagesChart" height="80"></canvas>
        </div>
        <div class="card" style="padding:1rem;margin-bottom:0">
            <div class="card-title" style="font-size:0.78rem;margin-bottom:0.5rem"><i class="fas fa-users" style="color:#34d399"></i> Visitors</div>
            <div id="uaVisitorStats"></div>
        </div>
    </div>

    <!-- Event Log -->
    <div class="card" style="padding:1rem;margin-bottom:0">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.6rem">
            <div class="card-title" style="margin:0;font-size:0.78rem"><i class="fas fa-stream" style="color:#a78bfa"></i> Event Log</div>
            <div style="display:flex;gap:0.5rem;align-items:center">
                <div class="tbl-search"><i class="fas fa-search"></i><input id="uaEventSearch" placeholder="Search..." oninput="filterUAEvents()" style="width:160px"></div>
                <button class="btn btn-ghost btn-sm" onclick="exportUAEventsCSV()"><i class="fas fa-download"></i> CSV</button>
            </div>
        </div>
        <div class="ua-event-log" id="uaEventLog" style="max-height:320px">
            <div class="ua-event-row header">
                <span></span>
                <span>Event / Visitor</span>
                <span>Location</span>
                <span>Page</span>
                <span>Type</span>
                <span>Time</span>
            </div>
        </div>
        <div class="pagination" style="margin-top:0.6rem;padding-top:0.6rem;display:flex;justify-content:space-between;align-items:center">
            <div id="uaPageInfo"><span style="color:#64748b;font-size:0.72rem">Page 1 of 1</span></div>
            <div id="uaPageBtns" style="display:flex;gap:3px;align-items:center"></div>
        </div>
    </div>
</div>

<!-- ══════════════════════════════════════ SETTINGS ══════════════════════════════════════ -->
<div class="section" id="sec-settings">
    <div class="section-header">
        <h1>System Settings</h1>
        <p>Platform configuration and environment info</p>
    </div>

    <!-- System Health Panel -->
    <div class="card" style="margin-bottom:1.5rem">
        <div class="card-title"><i class="fas fa-heartbeat" style="color:#34d399"></i> System Health</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;">
            <div class="health-stat">
                <div class="health-stat-label">Uptime</div>
                <div class="health-stat-value" style="color:#34d399">99.97%</div>
                <div class="health-stat-sub">Last 30 days</div>
            </div>
            <div class="health-stat">
                <div class="health-stat-label">Response Time</div>
                <div class="health-stat-value" style="color:#60a5fa">42ms</div>
                <div class="health-stat-sub">Avg (P95: 120ms)</div>
            </div>
            <div class="health-stat">
                <div class="health-stat-label">Error Rate</div>
                <div class="health-stat-value" style="color:#34d399">0.02%</div>
                <div class="health-stat-sub">Last 24h</div>
            </div>
            <div class="health-stat">
                <div class="health-stat-label">Storage</div>
                <div class="health-stat-value" style="color:#fbbf24" id="storageUsed">0KB</div>
                <div class="health-stat-sub">localStorage used</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i class="fas fa-server" style="color:#60a5fa"></i> Platform Config</div>
        <div id="settingsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;"></div>
    </div>
    <div class="card" style="margin-top:1.5rem">
        <div class="card-title"><i class="fas fa-database" style="color:#a78bfa"></i> Data Management</div>
        <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:0.5rem;">
            <button class="btn btn-purple" onclick="alert('Mock: Database backup initiated')"><i class="fas fa-hdd"></i> Backup Data</button>
            <button class="btn btn-amber" onclick="if(confirm('Reset all mock data?')){location.reload()}"><i class="fas fa-redo"></i> Reset Mock Data</button>
            <button class="btn btn-red" onclick="alert('Mock: Cache cleared')"><i class="fas fa-broom"></i> Clear Cache</button>
            <button class="btn btn-ghost" onclick="alert('Mock: Health check passed')"><i class="fas fa-heartbeat"></i> Health Check</button>
        </div>
    </div>
</div>

        </div><!-- /main-content -->
    </main><!-- /main-wrap -->

    <!-- User Detail Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-box"><button class="modal-close" onclick="closeModal()">&times;</button><div id="modalBody"></div></div>
    </div>

    <!-- Create Account Modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal-box" style="max-width:480px">
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            <div id="createForm">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:1.5rem">
                    <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#8b5cf6,#a855f7);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1rem"><i class="fas fa-user-plus"></i></div>
                    <div>
                        <div style="font-size:1.1rem;font-weight:700;color:#f1f5f9">Create Account</div>
                        <div style="font-size:0.78rem;color:#64748b">Manually create a new user account</div>
                    </div>
                </div>
                <div id="createError" style="display:none;padding:8px 12px;border-radius:8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;font-size:0.8rem;margin-bottom:12px;"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                    <div>
                        <label style="display:block;font-size:0.72rem;font-weight:600;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Full Name *</label>
                        <input type="text" id="createName" placeholder="John Doe" style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:#f1f5f9;font-size:0.85rem;font-family:inherit;box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block;font-size:0.72rem;font-weight:600;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Role</label>
                        <select id="createRole" style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:#f1f5f9;font-size:0.85rem;font-family:inherit;box-sizing:border-box;">
                            <option value="User">User</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:block;font-size:0.72rem;font-weight:600;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Email Address *</label>
                    <input type="email" id="createEmail" placeholder="user@example.com" style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:#f1f5f9;font-size:0.85rem;font-family:inherit;box-sizing:border-box;">
                </div>
                <div style="margin-bottom:12px">
                    <label style="display:block;font-size:0.72rem;font-weight:600;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Password *</label>
                    <div style="position:relative">
                        <input type="password" id="createPassword" placeholder="Min 6 characters" style="width:100%;padding:10px 14px;padding-right:40px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:#f1f5f9;font-size:0.85rem;font-family:inherit;box-sizing:border-box;">
                        <button onclick="toggleCreatePw()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:#64748b;cursor:pointer;font-size:0.85rem;padding:4px"><i class="fas fa-eye" id="createPwIcon"></i></button>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                    <div>
                        <label style="display:block;font-size:0.72rem;font-weight:600;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Access Tier *</label>
                        <select id="createTier" style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:#f1f5f9;font-size:0.85rem;font-family:inherit;box-sizing:border-box;">
                            <option value="free" selected>Free</option>
                            <option value="pro">Pro</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:0.72rem;font-weight:600;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Company</label>
                        <input type="text" id="createCompany" placeholder="Optional" style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:#f1f5f9;font-size:0.85rem;font-family:inherit;box-sizing:border-box;">
                    </div>
                </div>
                <div style="margin-bottom:20px">
                    <label style="display:block;font-size:0.72rem;font-weight:600;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Country</label>
                    <select id="createCountry" style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:#f1f5f9;font-size:0.85rem;font-family:inherit;box-sizing:border-box;">
                        <option value="Indonesia">Indonesia</option>
                        <option value="Singapore">Singapore</option>
                        <option value="Malaysia">Malaysia</option>
                        <option value="Thailand">Thailand</option>
                        <option value="Philippines">Philippines</option>
                        <option value="Vietnam">Vietnam</option>
                        <option value="India">India</option>
                        <option value="Japan">Japan</option>
                        <option value="Korea">Korea</option>
                        <option value="UAE">UAE</option>
                        <option value="US">US</option>
                        <option value="UK">UK</option>
                        <option value="Germany">Germany</option>
                        <option value="Australia">Australia</option>
                        <option value="Canada">Canada</option>
                        <option value="Brazil">Brazil</option>
                    </select>
                </div>
                <div style="display:flex;gap:0.75rem">
                    <button onclick="submitCreateAccount()" style="flex:1;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;font-size:0.9rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.3s;">
                        <i class="fas fa-plus"></i> Create Account
                    </button>
                    <button onclick="closeCreateModal()" style="padding:12px 20px;border:1px solid rgba(255,255,255,0.15);border-radius:10px;background:transparent;color:#94a3b8;font-size:0.9rem;cursor:pointer;font-family:inherit;transition:all 0.2s;">
                        Cancel
                    </button>
                </div>
            </div>
            <div id="createSuccess" style="display:none;text-align:center;padding:20px 0;">
                <i class="fas fa-check-circle" style="font-size:2.5rem;color:#10b981;margin-bottom:10px;display:block;"></i>
                <p style="color:#f1f5f9;font-weight:600;margin:4px 0;" id="createSuccessMsg">Account Created!</p>
                <small style="color:#64748b;font-size:0.8rem;">The account is now active and can log in immediately.</small>
            </div>
        </div>
    </div>

<script>
// ═══════════════════════════════════════════════════════════════
// ACCESS CONTROL
// ═══════════════════════════════════════════════════════════════
const ADMIN_EMAILS = ['bagus@resistancezero.com','admin@resistancezero.com'];
let adminEmail = '';

function checkAccess(){
    const s = localStorage.getItem('rz_premium_session');
    if(!s){showLogin();return false}
    try{
        const d=JSON.parse(s);
        var expMs=typeof d.expires==='string'?new Date(d.expires).getTime():d.expires;
        if(expMs<Date.now()||!ADMIN_EMAILS.includes(d.email)){showLogin();return false}
        adminEmail=d.email;
        document.getElementById('sidebarAvatar').textContent=d.email.charAt(0).toUpperCase();
        document.getElementById('sidebarName').textContent=d.email.split('@')[0];
        return true;
    }catch(e){showLogin();return false}
}
function showLogin(){
    document.getElementById('loginPage').style.display='flex';
    document.getElementById('main-content').style.display='none';
    document.getElementById('sidebar').style.display='none';
    document.getElementById('sidebarOverlay').style.display='none';
    setTimeout(function(){var e=document.getElementById('adminLoginEmail');if(e)e.focus()},100);
}
function toggleLoginPassword(){
    var inp=document.getElementById('adminLoginPassword');
    var ico=document.getElementById('loginPwIcon');
    if(inp.type==='password'){inp.type='text';ico.className='fas fa-eye-slash'}
    else{inp.type='password';ico.className='fas fa-eye'}
}
function handleAdminLogin(e){
    e.preventDefault();
    var email=document.getElementById('adminLoginEmail').value.trim().toLowerCase();
    var pass=document.getElementById('adminLoginPassword').value;
    var errEl=document.getElementById('adminLoginError');
    var btn=document.getElementById('loginSubmitBtn');
    var btnTxt=document.getElementById('loginBtnText');

    // Validate empty fields
    if(!email||!pass){
        errEl.innerHTML='<i class="fas fa-exclamation-circle"></i> Please enter both email and password.';
        errEl.style.display='block';
        if(!email) document.getElementById('adminLoginEmail').focus();
        else document.getElementById('adminLoginPassword').focus();
        return false;
    }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        errEl.innerHTML='<i class="fas fa-exclamation-circle"></i> Please enter a valid email address.';
        errEl.style.display='block';
        document.getElementById('adminLoginEmail').focus();
        return false;
    }

    // Brief loading state
    btn.disabled=true;
    btnTxt.innerHTML='<i class="fas fa-spinner fa-spin"></i> Authenticating...';
    errEl.style.display='none';

    // Check admin accounts
    var valid=false;
    if(ADMIN_EMAILS.includes(email)&&pass==='RZ@Premium2026!') valid=true;

    setTimeout(function(){
    if(!valid){
        errEl.innerHTML='<i class="fas fa-exclamation-circle"></i> Invalid email or password.';
        errEl.style.display='block';
        btn.disabled=false;
        btnTxt.textContent='Sign In';
        document.getElementById('adminLoginPassword').focus();
        return;
    }

    // Store session (30 days if remember, 24h if not)
    var remember=document.getElementById('loginRemember').checked;
    var expiry=remember ? 30*86400000 : 86400000;
    localStorage.setItem('rz_premium_session',JSON.stringify({
        email:email,tier:'pro',
        expires:new Date(Date.now()+expiry).toISOString()
    }));
    window.dispatchEvent(new CustomEvent('rz-auth-change',{detail:{email:email,tier:'pro',action:'login'}}));

    // Show dashboard
    errEl.style.display='none';
    document.getElementById('loginPage').style.display='none';
    document.getElementById('sidebar').style.display='flex';
    document.getElementById('main-content').style.display='block';
    adminEmail=email;
    document.getElementById('sidebarAvatar').textContent=email.charAt(0).toUpperCase();
    document.getElementById('sidebarName').textContent=email.split('@')[0];

    // Init dashboard
    allUsers=generateUsers();
    loadManualAccounts();
    filteredUsers=[...allUsers];
    activities=generateActivities();
    applySort();renderKPIs();renderDashboardCharts();renderRevenue();
    renderTable();renderCredentials();renderFeatures();renderBenchmarks();
    renderAudit();renderSubscribers();renderSettings();renderMayar();renderActivity();
    },600);
    return false;
}
function adminLogout(){if(!confirm('Logout?'))return;localStorage.removeItem('rz_premium_session');location.href='capex-calculator.html'}

// ═══════════════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════════════
function showSection(id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById('sec-'+id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n=>{n.classList.toggle('active',n.dataset.section===id)});
    const titles={dashboard:'Dashboard',revenue:'Revenue Analytics',mayar:'Mayar Payments',activity:'User Activity',users:'User Management',credentials:'Account Credentials',features:'Feature Flags',subscribers:'Newsletter Subscribers',benchmarks:'DC Industry Intelligence',audit:'Audit Log',settings:'System Settings'};
    if(id==='mayar'&&typeof renderMayar==='function')renderMayar();
    if(id==='activity'&&typeof renderActivity==='function')renderActivity();
    document.getElementById('topbarTitle').textContent=titles[id]||id;
    if(window.innerWidth<768){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('show')}
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}

// ═══════════════════════════════════════════════════════════════
// THEME TOGGLE
// ═══════════════════════════════════════════════════════════════
function toggleAdminTheme(){
    document.body.classList.toggle('light-mode');
    var isLight=document.body.classList.contains('light-mode');
    localStorage.setItem('rz_admin_theme',isLight?'light':'dark');
    document.getElementById('adminThemeBtn').innerHTML='<i class="fas fa-'+(isLight?'sun':'moon')+'"></i>';
    // F2: Re-render DC charts with theme-appropriate colors
    if(typeof renderBenchOverview==='function'){
        try{renderBenchOverview()}catch(e){}
    }
}

// Clock
setInterval(()=>{document.getElementById('topbarTime').textContent=new Date().toLocaleString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})+' UTC+7'},1000);

// ═══════════════════════════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════════════════════════
const CREDENTIALS = [
    {name:'Bagus Dwi Permana',email:'bagus@resistancezero.com',password:'RZ@Premium2026!',tier:'pro',role:'Owner',color:'#8b5cf6'},
    {name:'Admin RZ',email:'admin@resistancezero.com',password:'RZ@Premium2026!',tier:'pro',role:'Admin',color:'#7c3aed'},
    {name:'Demo Pro User',email:'demo@resistancezero.com',password:'demo2026',tier:'pro',role:'User',color:'#6d28d9'}
];

// Feature flags state (persisted in localStorage)
const DEFAULT_FEATURES = {
    advanced_mode:    {label:'Advanced Mode',icon:'fa-cogs',desc:'Extended input parameters',free:false,pro:true},
    unblur_values:    {label:'Unblur $/kW & Energy',icon:'fa-eye',desc:'Show real dollar values',free:false,pro:true},
    unblur_breakdown: {label:'Unblur Cost Breakdown',icon:'fa-chart-bar',desc:'Full breakdown visibility',free:false,pro:true},
    save_scenario:    {label:'Save Scenario',icon:'fa-save',desc:'Save & compare scenarios',free:false,pro:true},
    pdf_export:       {label:'PDF Export',icon:'fa-file-pdf',desc:'Export detailed PDF reports',free:false,pro:true},
    premium_output:   {label:'Premium Output Section',icon:'fa-crown',desc:'Extended analytics output',free:false,pro:true},
    comparison_view:  {label:'Scenario Comparison',icon:'fa-columns',desc:'Side-by-side comparison',free:false,pro:true},
    api_access:       {label:'API Access',icon:'fa-plug',desc:'REST API for automation',free:false,pro:true},
    watermark_hide:   {label:'Remove Watermark',icon:'fa-eraser',desc:'Hide free-tier watermark',free:false,pro:true},
    tooltips:         {label:'Tooltips & Guidance',icon:'fa-info-circle',desc:'Interactive help tooltips',free:true,pro:true},
    dark_mode:        {label:'Dark Mode (Future)',icon:'fa-moon',desc:'Dark theme for calculators',free:false,pro:false},
    multi_scenario:   {label:'Multi-Scenario (Future)',icon:'fa-layer-group',desc:'Compare 3+ scenarios',free:false,pro:false}
};

let featureFlags = JSON.parse(localStorage.getItem('rz_admin_features')||'null') || JSON.parse(JSON.stringify(DEFAULT_FEATURES));

const FIRST_NAMES=['James','Emma','Liam','Olivia','Noah','Ava','William','Sophia','Mason','Isabella','Lucas','Mia','Ethan','Charlotte','Alexander','Amelia','Daniel','Harper','Michael','Evelyn','David','Abigail','Joseph','Emily','Samuel','Elizabeth','Henry','Sofia','Sebastian','Victoria','Andrew','Grace','Joshua','Chloe','Nathan','Zoey','Ryan','Lily','Benjamin','Hannah','Kevin','Aria','Brandon','Riley','Tyler','Nora','Dylan','Ella','Matthew','Scarlett'];
const LAST_NAMES=['Chen','Smith','Patel','Williams','Garcia','Johnson','Kim','Brown','Lee','Davis','Miller','Wilson','Tanaka','Rodriguez','Martinez','Anderson','Thomas','Taylor','Moore','Jackson'];
const DOMAINS=['gmail.com','outlook.com','yahoo.com','protonmail.com','company.io','engineering.co','datacenter.net','techops.com','infra.dev','icloud.com'];
const STATUSES=['active','active','active','active','inactive','inactive','suspended'];

function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min}
function randDate(s,e){return new Date(s.getTime()+Math.random()*(e.getTime()-s.getTime()))}
function fmtDate(d){return d.toISOString().split('T')[0]}
function fmtDT(d){return d.toISOString().replace('T',' ').substring(0,16)}

let allUsers=[], filteredUsers=[], activities=[];
let currentPage=1, PAGE_SIZE=10, sortField='lastLogin', sortDir='desc';
let allPasswordsVisible=false;

function generateUsers(){
    const u=[];
    // Real accounts
    u.push({id:'usr_001',name:'Bagus Dwi Permana',email:'bagus@resistancezero.com',password:'RZ@Premium2026!',tier:'pro',status:'active',registered:'2025-06-15',lastLogin:'2026-02-15 09:30',usage:247,lastPayment:'2026-02-01',amountPaid:49,role:'Owner',company:'ResistanceZero',country:'Indonesia'});
    u.push({id:'usr_002',name:'Admin RZ',email:'admin@resistancezero.com',password:'RZ@Premium2026!',tier:'pro',status:'active',registered:'2025-06-15',lastLogin:'2026-02-14 18:45',usage:182,lastPayment:'2026-02-01',amountPaid:49,role:'Admin',company:'ResistanceZero',country:'Indonesia'});
    u.push({id:'usr_003',name:'Demo Pro User',email:'demo@resistancezero.com',password:'demo2026',tier:'pro',status:'active',registered:'2025-08-20',lastLogin:'2026-02-13 14:20',usage:95,lastPayment:'2026-02-01',amountPaid:49,role:'User',company:'—',country:'Singapore'});
    // Random users
    for(let i=0;i<35;i++){
        const fn=FIRST_NAMES[i],ln=LAST_NAMES[i%LAST_NAMES.length];
        const dm=DOMAINS[rand(0,DOMAINS.length-1)];
        const em=fn.toLowerCase()+'.'+ln.toLowerCase()+'@'+dm;
        const tr=Math.random();
        const tier=tr<0.15?'pro':'free';
        const st=STATUSES[rand(0,STATUSES.length-1)];
        const rd=randDate(new Date('2025-07-01'),new Date('2026-02-10'));
        const ld=randDate(rd,new Date('2026-02-15'));
        const hp=tier==='pro';
        const pd=hp?randDate(new Date('2026-01-01'),new Date('2026-02-15')):null;
        const countries=['US','UK','Germany','Singapore','Japan','India','UAE','Australia','Canada','Brazil','Indonesia','Malaysia'];
        u.push({id:`usr_${String(i+16).padStart(3,'0')}`,name:fn+' '+ln,email:em,password:tier==='free'?'—':'assigned',tier,status:st,registered:fmtDate(rd),lastLogin:fmtDT(ld),usage:rand(1,150),lastPayment:pd?fmtDate(pd):null,amountPaid:hp?49:0,role:'User',company:['Acme Corp','TechData','CloudFirst','DataVault','NetSys','FreeLance'][rand(0,5)],country:countries[rand(0,countries.length-1)]});
    }
    return u;
}

function generateActivities(){
    const types=['login','logout','calculation','pdf','tier_change','feature_toggle'];
    const acts=[];
    const now=new Date('2026-02-15T12:00:00');
    for(let i=0;i<40;i++){
        const usr=allUsers[rand(0,allUsers.length-1)];
        const type=types[rand(0,types.length-1)];
        const time=new Date(now.getTime()-i*(rand(600000,3600000)));
        const details={login:'Logged in via web',logout:'Logged out',calculation:'Ran CAPEX calculation ('+rand(1,100)+'MW)',pdf:'Exported PDF report',tier_change:'Tier changed to '+['Pro','Free'][rand(0,1)],feature_toggle:'Toggled feature flag'};
        acts.push({email:usr.email,name:usr.name,type,time:fmtDT(time),detail:details[type]||''});
    }
    return acts;
}

// ═══════════════════════════════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════════════════════════════
function renderKPIs(){
    const total=allUsers.length,active=allUsers.filter(u=>u.status==='active').length;
    const pro=allUsers.filter(u=>u.tier==='pro').length;
    const revenue=pro*49;
    const kpis=[
        {icon:'fa-users',bg:'rgba(96,165,250,0.15)',color:'#60a5fa',label:'Total Users',val:total,sub:`+${((total/42-1)*100).toFixed(0)}% from last month`,cls:'up'},
        {icon:'fa-user-check',bg:'rgba(52,211,153,0.15)',color:'#34d399',label:'Active Users',val:active,sub:`${((active/total)*100).toFixed(1)}% active rate`,cls:'up'},
        {icon:'fa-crown',bg:'rgba(167,139,250,0.15)',color:'#a78bfa',label:'Pro Users',val:pro,sub:`${(pro/total*100).toFixed(1)}% conversion`,cls:'up'},
        {icon:'fa-dollar-sign',bg:'rgba(251,191,36,0.15)',color:'#fbbf24',label:'Monthly Revenue',val:'$'+revenue.toLocaleString(),sub:'2.1% churn rate',cls:'down'}
    ];
    document.getElementById('kpiGrid').innerHTML=kpis.map(k=>`
        <div class="kpi"><div class="kpi-icon" style="background:${k.bg};color:${k.color}"><i class="fas ${k.icon}"></i></div>
        <div class="kpi-label">${k.label}</div><div class="kpi-val">${k.val}</div>
        <span class="kpi-sub ${k.cls}"><i class="fas fa-arrow-${k.cls==='up'?'up':'down'}"></i> ${k.sub}</span></div>`).join('');
    document.getElementById('navUserCount').textContent=total;
}

function renderDashboardCharts(){
    const actCount=allUsers.filter(u=>u.status==='active').length;
    // Quick stats
    const totalCalcs=allUsers.reduce((sum,u)=>sum+u.usage,0);
    document.getElementById('totalCalcs').textContent=totalCalcs.toLocaleString();
    document.getElementById('activeSessions').textContent=rand(3,12);
    // Growth
    new Chart(document.getElementById('chartGrowth'),{type:'line',data:{labels:['Sep 25','Oct 25','Nov 25','Dec 25','Jan 26','Feb 26'],datasets:[
        {label:'Total',data:[12,18,24,31,42,allUsers.length],borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.08)',fill:true,tension:0.4,pointRadius:4,borderWidth:2},
        {label:'Active',data:[8,14,19,25,35,actCount],borderColor:'#34d399',backgroundColor:'rgba(52,211,153,0.05)',fill:true,tension:0.4,pointRadius:4,borderWidth:2}
    ]},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:10}}}},scales:{x:{ticks:{color:'#475569',font:{size:9}},grid:{color:'rgba(51,65,85,0.2)'}},y:{ticks:{color:'#475569',font:{size:9}},grid:{color:'rgba(51,65,85,0.2)'},beginAtZero:true}}}});
    // Tier dist
    const pc=allUsers.filter(u=>u.tier==='pro').length,fc=allUsers.filter(u=>u.tier==='free').length;
    new Chart(document.getElementById('chartTier'),{type:'doughnut',data:{labels:['Pro','Free'],datasets:[{data:[pc,fc],backgroundColor:['#8b5cf6','#475569'],borderColor:'#1e293b',borderWidth:3}]},options:{responsive:true,cutout:'65%',plugins:{legend:{position:'bottom',labels:{color:'#94a3b8',font:{size:10},padding:14,usePointStyle:true}}}}});
    // Usage by hour
    const hours=Array.from({length:24},(_,i)=>i);
    const hourData=hours.map(()=>rand(2,45));
    new Chart(document.getElementById('chartUsageHour'),{type:'bar',data:{labels:hours.map(h=>h+':00'),datasets:[{label:'Calculations',data:hourData,backgroundColor:'rgba(96,165,250,0.4)',borderColor:'#60a5fa',borderWidth:1,borderRadius:3}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#475569',font:{size:8}},grid:{display:false}},y:{ticks:{color:'#475569',font:{size:9}},grid:{color:'rgba(51,65,85,0.2)'},beginAtZero:true}}}});
    // Funnel
    new Chart(document.getElementById('chartFunnel'),{type:'bar',data:{labels:['Visitors','Signed Up','Active','Pro'],datasets:[{data:[1200,allUsers.length,actCount,pc],backgroundColor:['#475569','#60a5fa','#34d399','#8b5cf6'],borderRadius:6}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#475569',font:{size:9}},grid:{color:'rgba(51,65,85,0.2)'}},y:{ticks:{color:'#e2e8f0',font:{size:10}},grid:{display:false}}}}});
    // Geo Distribution
    var countries={};
    allUsers.forEach(function(u){countries[u.country]=(countries[u.country]||0)+1});
    var sortedCountries=Object.entries(countries).sort(function(a,b){return b[1]-a[1]});
    new Chart(document.getElementById('chartGeo'),{type:'bar',data:{
        labels:sortedCountries.map(function(c){return c[0]}),
        datasets:[{label:'Users',data:sortedCountries.map(function(c){return c[1]}),
        backgroundColor:'rgba(139,92,246,0.4)',borderColor:'#8b5cf6',borderWidth:1,borderRadius:4}]
    },options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},
        scales:{x:{ticks:{color:'#475569',font:{size:9}},grid:{color:'rgba(51,65,85,0.2)'}},
        y:{ticks:{color:'#e2e8f0',font:{size:9}},grid:{display:false}}}}});
    // Dashboard recent activity
    var dashAct=document.getElementById('dashActivity');
    if(dashAct){
        var icons={login:'fa-sign-in-alt',logout:'fa-sign-out-alt',calculation:'fa-calculator',pdf:'fa-file-pdf',tier_change:'fa-exchange-alt',feature_toggle:'fa-toggle-on'};
        dashAct.innerHTML=activities.slice(0,8).map(function(a){return '<div class="tl-item '+a.type+'"><div class="tl-icon '+a.type+'"><i class="fas '+(icons[a.type]||'fa-circle')+'"></i></div>'+
            '<div><div class="tl-text"><strong>'+a.name+'</strong> — '+a.detail+'</div><div class="tl-time">'+a.time+'</div></div></div>'
        }).join('');
    }
}

// ═══════════════════════════════════════════════════════════════
// REVENUE
// ═══════════════════════════════════════════════════════════════
function renderRevenue(){
    const pro=allUsers.filter(u=>u.tier==='pro').length;
    const mrr=pro*49, arr=mrr*12, ltv=49*14.2;
    const kpis=[
        {icon:'fa-receipt',bg:'rgba(52,211,153,0.15)',color:'#34d399',label:'MRR',val:'$'+mrr.toLocaleString(),sub:'Monthly Recurring Revenue',cls:'up'},
        {icon:'fa-calendar-alt',bg:'rgba(96,165,250,0.15)',color:'#60a5fa',label:'ARR',val:'$'+(arr).toLocaleString(),sub:'Annual Recurring Revenue',cls:'up'},
        {icon:'fa-gem',bg:'rgba(167,139,250,0.15)',color:'#a78bfa',label:'Avg LTV',val:'$'+ltv.toFixed(0),sub:'Avg 14.2 month retention',cls:'neutral'},
        {icon:'fa-user-minus',bg:'rgba(248,113,113,0.15)',color:'#f87171',label:'Churn Rate',val:'2.1%',sub:'Last 30 days',cls:'down'}
    ];
    document.getElementById('revenueKpis').innerHTML=kpis.map(k=>`
        <div class="kpi"><div class="kpi-icon" style="background:${k.bg};color:${k.color}"><i class="fas ${k.icon}"></i></div>
        <div class="kpi-label">${k.label}</div><div class="kpi-val">${k.val}</div>
        <span class="kpi-sub ${k.cls}"><i class="fas fa-arrow-${k.cls==='up'?'up':k.cls==='down'?'down':'right'}"></i> ${k.sub}</span></div>`).join('');
    // MRR chart
    new Chart(document.getElementById('chartMRR'),{type:'line',data:{labels:['Sep 25','Oct 25','Nov 25','Dec 25','Jan 26','Feb 26'],datasets:[{label:'MRR ($)',data:[98,147,196,245,343,mrr],borderColor:'#34d399',backgroundColor:'rgba(52,211,153,0.1)',fill:true,tension:0.4,pointRadius:4,borderWidth:2}]},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:10}}}},scales:{x:{ticks:{color:'#475569',font:{size:9}},grid:{color:'rgba(51,65,85,0.2)'}},y:{ticks:{color:'#475569',font:{size:9},callback:v=>'$'+v},grid:{color:'rgba(51,65,85,0.2)'},beginAtZero:true}}}});
    // Churn chart
    new Chart(document.getElementById('chartChurn'),{type:'doughnut',data:{labels:['Retained','Churned'],datasets:[{data:[97.9,2.1],backgroundColor:['#34d399','#f87171'],borderColor:'#1e293b',borderWidth:3}]},options:{responsive:true,cutout:'70%',plugins:{legend:{position:'bottom',labels:{color:'#94a3b8',font:{size:10},padding:14,usePointStyle:true}}}}});
    // Revenue table
    const payingUsers=allUsers.filter(u=>u.tier==='pro').sort((a,b)=>b.amountPaid-a.amountPaid);
    document.getElementById('revenueTableWrap').innerHTML=`<table class="data-tbl"><thead><tr><th>Account</th><th>Tier</th><th>Last Payment</th><th>Amount</th><th>Est. LTV</th></tr></thead><tbody>${payingUsers.map(u=>`<tr><td style="font-weight:500">${u.name}<br><span style="font-size:0.7rem;color:#64748b">${u.email}</span></td><td><span class="tier-badge pro">PRO</span></td><td>${u.lastPayment||'—'}</td><td style="color:#34d399;font-weight:600">$${u.amountPaid.toFixed(2)}</td><td style="color:#fbbf24">$${(u.amountPaid*rand(6,18)).toFixed(0)}</td></tr>`).join('')}</tbody></table>`;
}

// ═══════════════════════════════════════════════════════════════
// USERS
// ═══════════════════════════════════════════════════════════════
function filterUsers(){
    const q=document.getElementById('userSearch').value.toLowerCase();
    const tf=document.getElementById('tierFilter').value;
    const sf=document.getElementById('statusFilter').value;
    filteredUsers=allUsers.filter(u=>{
        if(q&&!u.email.toLowerCase().includes(q)&&!u.name.toLowerCase().includes(q))return false;
        if(tf!=='all'&&u.tier!==tf)return false;
        if(sf!=='all'&&u.status!==sf)return false;
        return true;
    });
    currentPage=1;applySort();renderTable();
}
function sortTable(f){if(sortField===f)sortDir=sortDir==='asc'?'desc':'asc';else{sortField=f;sortDir='asc'}applySort();renderTable()}
function applySort(){filteredUsers.sort((a,b)=>{let va=a[sortField]||'',vb=b[sortField]||'';if(sortField==='usage'){va=+va;vb=+vb}if(va<vb)return sortDir==='asc'?-1:1;if(va>vb)return sortDir==='asc'?1:-1;return 0})}
function goPage(p){currentPage=p;renderTable()}

function renderTable(){
    const s=(currentPage-1)*PAGE_SIZE,e=s+PAGE_SIZE,pg=filteredUsers.slice(s,e);
    document.getElementById('userTbody').innerHTML=pg.map(u=>`<tr>
        <td style="font-weight:500">${u.name}</td>
        <td><span style="font-size:0.75rem">${u.email}</span></td>
        <td><span class="tier-badge ${u.tier}">${u.tier.toUpperCase()}</span></td>
        <td><span class="status-dot ${u.status}">${u.status.charAt(0).toUpperCase()+u.status.slice(1)}</span></td>
        <td>${u.registered}</td><td>${u.lastLogin}</td><td>${u.usage}</td>
        <td>${u.lastPayment||'<span style="color:#475569">—</span>'}</td>
        <td style="white-space:nowrap"><button class="btn btn-ghost btn-sm" onclick="openUserModal('${u.id}')"><i class="fas fa-eye"></i></button> <button class="btn btn-ghost btn-sm" onclick="changeTier('${u.id}')"><i class="fas fa-exchange-alt"></i></button></td>
    </tr>`).join('');
    const tot=filteredUsers.length,tp=Math.ceil(tot/PAGE_SIZE);
    document.getElementById('pgInfo').textContent=`Showing ${s+1}-${Math.min(e,tot)} of ${tot}`;
    let btns='';for(let p=1;p<=tp;p++)btns+=`<button class="pg-btn ${p===currentPage?'active':''}" onclick="goPage(${p})">${p}</button>`;
    document.getElementById('pgBtns').innerHTML=btns;
}

function changeTier(id){
    const u=allUsers.find(x=>x.id===id);if(!u)return;
    const tiers=['free','pro'];
    const curr=tiers.indexOf(u.tier);
    const next=tiers[(curr+1)%2];
    if(!confirm(`Change ${u.email} tier from ${u.tier.toUpperCase()} to ${next.toUpperCase()}?`))return;
    u.tier=next;
    if(next==='pro'){u.amountPaid=49;u.lastPayment=fmtDate(new Date())}
    /* Persist tier change for manual accounts */
    if(u.isManual){
        var manuals=getManualAccounts();
        var ma=manuals.find(a=>a.email===u.email);
        if(ma){ma.tier=next;saveManualAccounts(manuals)}
    }
    activities.unshift({email:adminEmail,name:'Admin',type:'tier_change',time:fmtDT(new Date()),detail:'Changed '+u.email+' tier to '+next.toUpperCase()});
    filterUsers();
    renderKPIs();
    renderCredentials();
    renderAudit();
}

function exportCSV(){
    const h=['Name','Email','Tier','Status','Registered','Last Login','Usage','Last Payment','Amount','Company','Country'];
    const r=filteredUsers.map(u=>[u.name,u.email,u.tier,u.status,u.registered,u.lastLogin,u.usage,u.lastPayment||'',u.amountPaid,u.company||'',u.country||''].join(','));
    downloadCSV([h.join(','),...r].join('\n'),'rz_users_'+fmtDate(new Date())+'.csv');
}
function downloadCSV(csv,fn){const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=fn;a.click();URL.revokeObjectURL(u)}

// ═══ SECTION CSV EXPORTS ═══
function exportDashboardCSV(){
    var pro=allUsers.filter(u=>u.tier==='pro').length;
    var free=allUsers.filter(u=>u.tier==='free').length;
    var active=allUsers.filter(u=>u.status==='active').length;
    var totalCalcs=allUsers.reduce((s,u)=>s+u.usage,0);
    var csv='Metric,Value\nTotal Users,'+allUsers.length+'\nPro Users,'+pro+'\nFree Users,'+free+'\nActive Users,'+active+'\nTotal Calculations,'+totalCalcs+'\nPDF Exports,234\nSystem Uptime,99.97%\n';
    csv+='\nUser,Email,Tier,Status,Country,Calculations\n';
    allUsers.forEach(u=>{csv+='"'+u.name+'","'+u.email+'",'+u.tier+','+u.status+',"'+(u.country||'')+'",'+u.usage+'\n'});
    downloadCSV(csv,'rz_dashboard_'+fmtDate(new Date())+'.csv');
}

function exportRevenueCSV(){
    var pro=allUsers.filter(u=>u.tier==='pro').length;
    var mrr=pro*49;
    var csv='Metric,Value\nMRR,$'+mrr+'\nARR,$'+(mrr*12)+'\nAvg LTV,$697\nChurn Rate,2.1%\nPro Users,'+pro+'\n';
    csv+='\nAccount,Email,Tier,Last Payment,Amount Paid,Est LTV\n';
    allUsers.filter(u=>u.tier==='pro').sort((a,b)=>b.amountPaid-a.amountPaid).forEach(u=>{
        csv+='"'+u.name+'","'+u.email+'",'+u.tier+','+(u.lastPayment||'')+','+u.amountPaid.toFixed(2)+','+(u.amountPaid*10).toFixed(0)+'\n';
    });
    downloadCSV(csv,'rz_revenue_'+fmtDate(new Date())+'.csv');
}

function exportFeaturesCSV(){
    var csv='Feature,Label,Description,Free Tier,Pro Tier\n';
    Object.keys(featureFlags).forEach(k=>{
        var f=featureFlags[k];
        csv+='"'+k+'","'+f.label+'","'+f.desc+'",'+f.free+','+f.pro+'\n';
    });
    downloadCSV(csv,'rz_features_'+fmtDate(new Date())+'.csv');
}

// exportBenchmarksCSV moved to benchmarks section below

// ═══ UNIVERSAL REPORT GENERATOR ═══
function openReport(section){
    var now=new Date();
    var dateStr=now.toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'})+' '+now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});

    var reportCSS='*{margin:0;padding:0;box-sizing:border-box}body{font-family:Inter,-apple-system,sans-serif;background:#fff;color:#1e293b;padding:2rem;max-width:1000px;margin:0 auto;font-size:13px}'+
        'h1{font-size:1.6rem;font-weight:800;color:#0f172a;margin-bottom:0.25rem}h2{font-size:1.1rem;font-weight:700;color:#1e293b;margin:1.5rem 0 0.75rem;padding-bottom:0.3rem;border-bottom:2px solid #e2e8f0}'+
        '.subtitle{font-size:0.85rem;color:#64748b;margin-bottom:1.5rem}.meta{font-size:0.75rem;color:#94a3b8;margin-bottom:2rem}'+
        '.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;margin-bottom:1.5rem}.kpi-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;text-align:center}'+
        '.kpi-box .label{font-size:0.65rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600}.kpi-box .value{font-size:1.5rem;font-weight:800;color:#0f172a;margin:0.25rem 0}'+
        '.kpi-box .sub{font-size:0.68rem;color:#94a3b8}'+
        'table{width:100%;border-collapse:collapse;margin-bottom:1.5rem;font-size:0.8rem}th{background:#f1f5f9;padding:8px 10px;text-align:left;font-weight:700;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.5px;color:#475569;border-bottom:2px solid #e2e8f0}'+
        'td{padding:7px 10px;border-bottom:1px solid #f1f5f9;color:#334155}tr:hover{background:#f8fafc}'+
        '.badge{padding:2px 8px;border-radius:50px;font-size:0.65rem;font-weight:700}.badge.pro{background:#ede9fe;color:#7c3aed}.badge.free{background:#f1f5f9;color:#64748b}'+
        '.badge.active{background:#d1fae5;color:#059669}.badge.inactive{background:#fef3c7;color:#d97706}.badge.paid{background:#d1fae5;color:#059669}.badge.unpaid{background:#fee2e2;color:#dc2626}'+
        '.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem}.stat-card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:1rem}'+
        '.stat-card h3{font-size:0.8rem;font-weight:700;margin-bottom:0.5rem;color:#475569}'+
        '.bar{display:flex;align-items:center;gap:8px;margin:3px 0;font-size:0.75rem}.bar-fill{height:6px;border-radius:3px;background:#8b5cf6}.bar-label{min-width:100px;color:#64748b}.bar-val{font-weight:600;min-width:35px;text-align:right}'+
        '.footer{margin-top:2rem;padding-top:1rem;border-top:1px solid #e2e8f0;font-size:0.7rem;color:#94a3b8;text-align:center}'+
        '@media print{body{padding:1rem}h1{font-size:1.2rem}.kpi-row{grid-template-columns:repeat(4,1fr)}}'+
        '.print-btn{position:fixed;top:1rem;right:1rem;padding:8px 16px;background:#7c3aed;color:#fff;border:none;border-radius:8px;font-size:0.82rem;font-weight:600;cursor:pointer;z-index:100;font-family:inherit}'+
        '.print-btn:hover{background:#6d28d9}@media print{.print-btn{display:none}}';

    var body='';
    var title='';
    var subtitle='';

    if(section==='dashboard'){
        title='Dashboard Overview Report';
        subtitle='Platform metrics and user analytics';
        var pro=allUsers.filter(u=>u.tier==='pro').length;
        var free=allUsers.filter(u=>u.tier==='free').length;
        var active=allUsers.filter(u=>u.status==='active').length;
        var totalCalcs=allUsers.reduce((s,u)=>s+u.usage,0);
        var countries={};allUsers.forEach(u=>{countries[u.country]=(countries[u.country]||0)+1});
        body+='<div class="kpi-row">';
        body+='<div class="kpi-box"><div class="label">Total Users</div><div class="value">'+allUsers.length+'</div><div class="sub">All accounts</div></div>';
        body+='<div class="kpi-box"><div class="label">Pro Users</div><div class="value">'+pro+'</div><div class="sub">'+Math.round(pro/allUsers.length*100)+'% of total</div></div>';
        body+='<div class="kpi-box"><div class="label">Active</div><div class="value">'+active+'</div><div class="sub">'+Math.round(active/allUsers.length*100)+'% active rate</div></div>';
        body+='<div class="kpi-box"><div class="label">Calculations</div><div class="value">'+totalCalcs.toLocaleString()+'</div><div class="sub">All time</div></div>';
        body+='</div>';
        body+='<h2>Tier Distribution</h2><div class="stats-grid"><div class="stat-card"><h3>By Tier</h3>';
        body+='<div class="bar"><span class="bar-label">Pro</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(pro/allUsers.length*100)+'%"></div></div><span class="bar-val">'+pro+'</span></div>';
        body+='<div class="bar"><span class="bar-label">Free</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(free/allUsers.length*100)+'%;background:#64748b"></div></div><span class="bar-val">'+free+'</span></div>';
        body+='</div><div class="stat-card"><h3>By Status</h3>';
        ['active','inactive','suspended'].forEach(function(s){var c=allUsers.filter(u=>u.status===s).length;
            body+='<div class="bar"><span class="bar-label">'+s.charAt(0).toUpperCase()+s.slice(1)+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(c/allUsers.length*100)+'%;background:'+(s==='active'?'#34d399':s==='inactive'?'#fbbf24':'#f87171')+'"></div></div><span class="bar-val">'+c+'</span></div>';
        });
        body+='</div></div>';
        body+='<h2>Geographic Distribution</h2><div class="stat-card" style="margin-bottom:1.5rem"><h3>Top Countries</h3>';
        Object.entries(countries).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(function(c){
            body+='<div class="bar"><span class="bar-label">'+c[0]+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(c[1]/allUsers.length*100)+'%"></div></div><span class="bar-val">'+c[1]+'</span></div>';
        });
        body+='</div>';
        body+='<h2>User List</h2><table><thead><tr><th>Name</th><th>Email</th><th>Tier</th><th>Status</th><th>Country</th><th>Calcs</th></tr></thead><tbody>';
        allUsers.slice(0,50).forEach(u=>{body+='<tr><td>'+u.name+'</td><td>'+u.email+'</td><td><span class="badge '+u.tier+'">'+u.tier.toUpperCase()+'</span></td><td><span class="badge '+u.status+'">'+u.status+'</span></td><td>'+(u.country||'—')+'</td><td>'+u.usage+'</td></tr>'});
        body+='</tbody></table>';
    }
    else if(section==='revenue'){
        title='Revenue Analytics Report';
        subtitle='Subscription revenue, LTV, and financial metrics';
        var pro=allUsers.filter(u=>u.tier==='pro').length;
        var mrr=pro*49,arr=mrr*12;
        body+='<div class="kpi-row">';
        body+='<div class="kpi-box"><div class="label">MRR</div><div class="value">$'+mrr.toLocaleString()+'</div><div class="sub">Monthly Recurring</div></div>';
        body+='<div class="kpi-box"><div class="label">ARR</div><div class="value">$'+arr.toLocaleString()+'</div><div class="sub">Annual Recurring</div></div>';
        body+='<div class="kpi-box"><div class="label">Avg LTV</div><div class="value">$697</div><div class="sub">14.2 mo retention</div></div>';
        body+='<div class="kpi-box"><div class="label">Churn</div><div class="value">2.1%</div><div class="sub">Last 30 days</div></div>';
        body+='</div>';
        body+='<h2>Revenue by Account</h2><table><thead><tr><th>Name</th><th>Email</th><th>Last Payment</th><th>Amount</th><th>Est. LTV</th></tr></thead><tbody>';
        allUsers.filter(u=>u.tier==='pro').sort((a,b)=>b.amountPaid-a.amountPaid).forEach(u=>{
            body+='<tr><td>'+u.name+'</td><td>'+u.email+'</td><td>'+(u.lastPayment||'—')+'</td><td style="font-weight:600;color:#059669">$'+u.amountPaid.toFixed(2)+'</td><td>$'+(u.amountPaid*10).toFixed(0)+'</td></tr>';
        });
        body+='</tbody></table>';
        body+='<h2>Revenue Growth</h2><div class="stat-card"><h3>MRR Trend (6 Months)</h3>';
        ['Sep $98','Oct $147','Nov $196','Dec $245','Jan $343','Feb $'+mrr].forEach(function(m){
            var val=parseInt(m.split('$')[1]);
            body+='<div class="bar"><span class="bar-label">'+m.split(' ')[0]+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(val/(mrr||1)*100)+'%;background:#34d399"></div></div><span class="bar-val">$'+val+'</span></div>';
        });
        body+='</div>';
    }
    else if(section==='users'){
        title='User Management Report';
        subtitle='Complete user account listing and analytics';
        var pro=allUsers.filter(u=>u.tier==='pro').length;
        var active=allUsers.filter(u=>u.status==='active').length;
        body+='<div class="kpi-row">';
        body+='<div class="kpi-box"><div class="label">Total</div><div class="value">'+allUsers.length+'</div><div class="sub">All accounts</div></div>';
        body+='<div class="kpi-box"><div class="label">Pro</div><div class="value">'+pro+'</div><div class="sub">'+Math.round(pro/allUsers.length*100)+'%</div></div>';
        body+='<div class="kpi-box"><div class="label">Active</div><div class="value">'+active+'</div><div class="sub">'+Math.round(active/allUsers.length*100)+'%</div></div>';
        body+='<div class="kpi-box"><div class="label">Avg Calcs</div><div class="value">'+Math.round(allUsers.reduce((s,u)=>s+u.usage,0)/allUsers.length)+'</div><div class="sub">Per user</div></div>';
        body+='</div>';
        body+='<h2>All Users ('+filteredUsers.length+')</h2><table><thead><tr><th>Name</th><th>Email</th><th>Tier</th><th>Status</th><th>Registered</th><th>Last Login</th><th>Calcs</th><th>Payment</th></tr></thead><tbody>';
        filteredUsers.forEach(u=>{body+='<tr><td>'+u.name+'</td><td style="font-size:0.72rem">'+u.email+'</td><td><span class="badge '+u.tier+'">'+u.tier.toUpperCase()+'</span></td><td><span class="badge '+u.status+'">'+u.status+'</span></td><td>'+u.registered+'</td><td>'+u.lastLogin+'</td><td>'+u.usage+'</td><td>'+(u.lastPayment||'—')+'</td></tr>'});
        body+='</tbody></table>';
    }
    else if(section==='features'){
        title='Feature Flags Report';
        subtitle='Current tier-level feature matrix configuration';
        var keys=Object.keys(featureFlags);
        var proEnabled=keys.filter(k=>featureFlags[k].pro).length;
        var freeEnabled=keys.filter(k=>featureFlags[k].free).length;
        body+='<div class="kpi-row" style="grid-template-columns:repeat(3,1fr)">';
        body+='<div class="kpi-box"><div class="label">Total Features</div><div class="value">'+keys.length+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Pro Enabled</div><div class="value">'+proEnabled+'</div><div class="sub">of '+keys.length+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Free Enabled</div><div class="value">'+freeEnabled+'</div><div class="sub">of '+keys.length+'</div></div>';
        body+='</div>';
        body+='<h2>Feature Matrix</h2><table><thead><tr><th>Feature</th><th>Description</th><th>Free</th><th>Pro</th></tr></thead><tbody>';
        keys.forEach(k=>{var f=featureFlags[k];
            body+='<tr><td style="font-weight:600">'+f.label+'</td><td style="color:#64748b">'+f.desc+'</td><td style="text-align:center;color:'+(f.free?'#059669':'#dc2626')+';font-weight:700">'+(f.free?'ON':'OFF')+'</td><td style="text-align:center;color:'+(f.pro?'#059669':'#dc2626')+';font-weight:700">'+(f.pro?'ON':'OFF')+'</td></tr>';
        });
        body+='</tbody></table>';
    }
    else if(section==='benchmarks'){
        title='DC Industry Intelligence Report';
        subtitle='Global operator capacity, country analysis, and market intelligence — '+DC_OPERATORS.length+' operators, '+DC_COUNTRIES.length+' countries';
        var totalMW=DC_OPERATORS.reduce((s,o)=>s+o.mw,0);
        body+='<div class="kpi-row">';
        body+='<div class="kpi-box"><div class="label">Total Installed</div><div class="value">'+DC_SUMMARY.totalInstalledGW+' GW</div><div class="sub">Synergy Q1 2025</div></div>';
        body+='<div class="kpi-box"><div class="label">Operators Tracked</div><div class="value">'+DC_OPERATORS.length+'</div><div class="sub">'+(totalMW/1000).toFixed(1)+' GW combined</div></div>';
        body+='<div class="kpi-box"><div class="label">Hyperscale DCs</div><div class="value">'+DC_SUMMARY.hyperscaleDCs.toLocaleString()+'</div><div class="sub">'+Math.round(DC_SUMMARY.hyperscaleShare*100)+'% of global</div></div>';
        body+='<div class="kpi-box"><div class="label">2030 Projection</div><div class="value">'+DC_SUMMARY.projected2030GW+' GW</div><div class="sub">$'+DC_SUMMARY.investmentRequired2030T+'T needed</div></div>';
        body+='</div>';
        body+='<h2>Top Operators by Capacity</h2><table><thead><tr><th>#</th><th>Operator</th><th>HQ</th><th>Type</th><th>Capacity (MW)</th><th>Facilities</th><th>Countries</th><th>CapEx 2025</th></tr></thead><tbody>';
        DC_OPERATORS.forEach(o=>{body+='<tr><td>'+o.rank+'</td><td style="font-weight:600">'+o.company+'</td><td>'+o.hq+'</td><td>'+o.type+'</td><td>'+o.mw.toLocaleString()+'</td><td>'+o.facilities+'</td><td>'+o.countries+'</td><td>'+(o.capex>=1?'$'+o.capex+'B':'$'+Math.round(o.capex*1000)+'M')+'</td></tr>'});
        body+='</tbody></table>';
        body+='<h2>Capacity by Country</h2><table><thead><tr><th>#</th><th>Country</th><th>Region</th><th>Capacity (MW)</th><th>Facilities</th><th>Growth YoY</th></tr></thead><tbody>';
        DC_COUNTRIES.forEach(c=>{body+='<tr><td>'+c.rank+'</td><td>'+c.country+'</td><td>'+c.region+'</td><td>'+c.mw.toLocaleString()+'</td><td>'+c.facilities.toLocaleString()+'</td><td>'+c.growth+'%</td></tr>'});
        body+='</tbody></table>';
    }
    else if(section==='audit'){
        title='Audit Log Report';
        subtitle='System event timeline and activity history';
        var byType={};activities.forEach(a=>{byType[a.type]=(byType[a.type]||0)+1});
        body+='<div class="kpi-row" style="grid-template-columns:repeat(3,1fr)">';
        body+='<div class="kpi-box"><div class="label">Total Events</div><div class="value">'+activities.length+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Event Types</div><div class="value">'+Object.keys(byType).length+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Unique Users</div><div class="value">'+(new Set(activities.map(a=>a.email))).size+'</div></div>';
        body+='</div>';
        body+='<h2>Events by Type</h2><div class="stat-card" style="margin-bottom:1.5rem"><h3>Distribution</h3>';
        Object.entries(byType).sort((a,b)=>b[1]-a[1]).forEach(function(t){
            body+='<div class="bar"><span class="bar-label">'+t[0]+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(t[1]/activities.length*100)+'%"></div></div><span class="bar-val">'+t[1]+'</span></div>';
        });
        body+='</div>';
        body+='<h2>Event Log</h2><table><thead><tr><th>Time</th><th>User</th><th>Type</th><th>Detail</th></tr></thead><tbody>';
        activities.slice(0,100).forEach(a=>{body+='<tr><td style="white-space:nowrap;font-size:0.72rem">'+a.time+'</td><td>'+a.email+'</td><td><span class="badge">'+a.type+'</span></td><td>'+a.detail+'</td></tr>'});
        body+='</tbody></table>';
    }
    else if(section==='subscribers'){
        title='Newsletter Subscribers Report';
        subtitle='Email subscriber listing and source analytics';
        var subs=typeof getSubscribers==='function'?getSubscribers():[];
        var bySource={};subs.forEach(s=>{bySource[s.source]=(bySource[s.source]||0)+1});
        var activeSubs=subs.filter(s=>s.status==='active').length;
        body+='<div class="kpi-row" style="grid-template-columns:repeat(3,1fr)">';
        body+='<div class="kpi-box"><div class="label">Total</div><div class="value">'+subs.length+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Active</div><div class="value">'+activeSubs+'</div><div class="sub">'+Math.round(activeSubs/(subs.length||1)*100)+'%</div></div>';
        body+='<div class="kpi-box"><div class="label">Sources</div><div class="value">'+Object.keys(bySource).length+'</div></div>';
        body+='</div>';
        if(Object.keys(bySource).length){
            body+='<h2>By Source</h2><div class="stat-card" style="margin-bottom:1.5rem"><h3>Source Breakdown</h3>';
            Object.entries(bySource).sort((a,b)=>b[1]-a[1]).forEach(function(s){
                body+='<div class="bar"><span class="bar-label">'+s[0]+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(s[1]/(subs.length||1)*100)+'%"></div></div><span class="bar-val">'+s[1]+'</span></div>';
            });
            body+='</div>';
        }
        body+='<h2>Subscriber List</h2><table><thead><tr><th>Email</th><th>Date</th><th>Source</th><th>Status</th></tr></thead><tbody>';
        subs.forEach(s=>{body+='<tr><td>'+s.email+'</td><td>'+(s.date||'—')+'</td><td>'+(s.source||'—')+'</td><td><span class="badge '+(s.status||'active')+'">'+(s.status||'active')+'</span></td></tr>'});
        body+='</tbody></table>';
    }
    else if(section==='activity'){
        title='User Activity Report';
        subtitle='Event tracking analytics — '+uaPeriod+' period';
        var events=uaFilteredEvents||[];
        var byType={};var byPage={};var byCountry={};var byDevice={};var byBrowser={};
        events.forEach(function(e){
            byType[e.type]=(byType[e.type]||0)+1;
            byPage[e.page]=(byPage[e.page]||0)+1;
            if(e.country)byCountry[e.country]=(byCountry[e.country]||0)+1;
            if(e.device)byDevice[e.device]=(byDevice[e.device]||0)+1;
            if(e.browser)byBrowser[e.browser]=(byBrowser[e.browser]||0)+1;
        });
        var ips=new Set(events.map(e=>e.ip).filter(Boolean));
        body+='<div class="kpi-row">';
        body+='<div class="kpi-box"><div class="label">Total Events</div><div class="value">'+events.length+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Unique IPs</div><div class="value">'+ips.size+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Countries</div><div class="value">'+Object.keys(byCountry).length+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Event Types</div><div class="value">'+Object.keys(byType).length+'</div></div>';
        body+='</div>';
        body+='<h2>Events by Type</h2><div class="stat-card" style="margin-bottom:1.5rem"><h3>Category Breakdown</h3>';
        Object.entries(byType).sort((a,b)=>b[1]-a[1]).forEach(function(t){
            body+='<div class="bar"><span class="bar-label">'+t[0].replace(/_/g,' ')+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(t[1]/events.length*100)+'%"></div></div><span class="bar-val">'+t[1]+' ('+Math.round(t[1]/events.length*100)+'%)</span></div>';
        });
        body+='</div>';
        body+='<div class="stats-grid"><div class="stat-card"><h3>Top Pages</h3>';
        Object.entries(byPage).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(function(p){
            body+='<div class="bar"><span class="bar-label">'+p[0].replace('.html','')+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(p[1]/(events.length||1)*100)+'%;background:#60a5fa"></div></div><span class="bar-val">'+p[1]+'</span></div>';
        });
        body+='</div><div class="stat-card"><h3>Top Countries</h3>';
        Object.entries(byCountry).sort((a,b)=>b[1]-a[1]).slice(0,8).forEach(function(c){
            body+='<div class="bar"><span class="bar-label">'+c[0]+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(c[1]/(events.length||1)*100)+'%;background:#fbbf24"></div></div><span class="bar-val">'+c[1]+'</span></div>';
        });
        body+='</div></div>';
        body+='<div class="stats-grid"><div class="stat-card"><h3>Device</h3>';
        Object.entries(byDevice).sort((a,b)=>b[1]-a[1]).forEach(function(d){
            body+='<div class="bar"><span class="bar-label">'+d[0]+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(d[1]/(events.length||1)*100)+'%;background:#f472b6"></div></div><span class="bar-val">'+Math.round(d[1]/(events.length||1)*100)+'%</span></div>';
        });
        body+='</div><div class="stat-card"><h3>Browser</h3>';
        Object.entries(byBrowser).sort((a,b)=>b[1]-a[1]).forEach(function(b){
            body+='<div class="bar"><span class="bar-label">'+b[0]+'</span><div style="flex:1;background:#f1f5f9;border-radius:3px;height:6px"><div class="bar-fill" style="width:'+Math.round(b[1]/(events.length||1)*100)+'%;background:#22d3ee"></div></div><span class="bar-val">'+b[1]+'</span></div>';
        });
        body+='</div></div>';
        body+='<h2>Recent Events (Last 100)</h2><table><thead><tr><th>Time</th><th>Type</th><th>Page</th><th>IP</th><th>Country</th><th>City</th><th>Device</th><th>Browser</th></tr></thead><tbody>';
        events.slice(0,100).forEach(function(e){var dt=new Date(e.ts);
            body+='<tr><td style="white-space:nowrap;font-size:0.72rem">'+dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})+' '+String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0')+'</td><td><span class="badge">'+e.type+'</span></td><td>'+e.page.replace('.html','')+'</td><td style="font-family:monospace;font-size:0.68rem">'+(e.ip||'—')+'</td><td>'+(e.country||'—')+'</td><td>'+(e.city||'—')+'</td><td>'+(e.device||'—')+'</td><td>'+(e.browser||'—')+'</td></tr>';
        });
        body+='</tbody></table>';
    }
    else if(section==='mayar'){
        title='Mayar Payments Report';
        subtitle='Payment gateway transactions and balance';
        var bal=document.getElementById('mayarBalance').textContent;
        var paid=document.getElementById('mayarPaidCount').textContent;
        var unpaid=document.getElementById('mayarUnpaidCount').textContent;
        var gross=document.getElementById('mayarGrossRevenue').textContent;
        body+='<div class="kpi-row">';
        body+='<div class="kpi-box"><div class="label">Balance</div><div class="value">'+bal+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Paid Tx</div><div class="value">'+paid+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Unpaid</div><div class="value">'+unpaid+'</div></div>';
        body+='<div class="kpi-box"><div class="label">Gross Revenue</div><div class="value">'+gross+'</div></div>';
        body+='</div>';
        var tbl=document.getElementById('mayarRecentBody');
        if(tbl&&tbl.rows.length>0){
            body+='<h2>Recent Transactions</h2><table><thead><tr><th>Date</th><th>Customer</th><th>Description</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
            for(var i=0;i<tbl.rows.length;i++){var r=tbl.rows[i];if(r.cells.length>=5){
                body+='<tr><td>'+r.cells[0].textContent+'</td><td>'+r.cells[1].textContent+'</td><td>'+r.cells[2].textContent+'</td><td>'+r.cells[3].textContent+'</td><td>'+r.cells[4].textContent+'</td></tr>';
            }}
            body+='</tbody></table>';
        }
    }

    var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+title+' — ResistanceZero</title>'+
        '<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>'+
        '<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">'+
        '<style>'+reportCSS+'</style></head><body>'+
        '<button class="print-btn" onclick="window.print()">Print / Save PDF</button>'+
        '<h1>'+title+'</h1><div class="subtitle">'+subtitle+'</div>'+
        '<div class="meta">Generated: '+dateStr+' | ResistanceZero Admin Console</div>'+
        body+
        '<div class="footer">ResistanceZero Admin Console — Report generated '+dateStr+'</div>'+
        '</body></html>';

    var win=window.open('','_blank');
    win.document.write(html);
    win.document.close();
}

function openUserModal(id){
    const u=allUsers.find(x=>x.id===id);if(!u)return;
    const ua=activities.filter(a=>a.email===u.email).slice(0,10);
    const icons={login:'fa-sign-in-alt',logout:'fa-sign-out-alt',calculation:'fa-calculator',pdf:'fa-file-pdf',tier_change:'fa-exchange-alt',feature_toggle:'fa-toggle-on'};
    document.getElementById('modalBody').innerHTML=`
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:1.5rem">
            <div style="width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,#7c3aed,#a855f7);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem;font-weight:700">${u.name.charAt(0)}</div>
            <div><div style="font-size:1.1rem;font-weight:700;color:#f1f5f9">${u.name}</div><div style="font-size:0.82rem;color:#64748b">${u.email}</div><div style="margin-top:4px"><span class="tier-badge ${u.tier}">${u.tier.toUpperCase()}</span> <span class="status-dot ${u.status}" style="margin-left:8px">${u.status}</span></div></div>
        </div>
        <div class="m-section"><h4><i class="fas fa-info-circle"></i> Profile</h4>
            <div class="m-row"><span class="m-row-label">User ID</span><span class="m-row-value" style="font-family:'JetBrains Mono',monospace;font-size:0.75rem">${u.id}</span></div>
            <div class="m-row"><span class="m-row-label">Full Name</span><span class="m-row-value">${u.name}</span></div>
            <div class="m-row"><span class="m-row-label">Role</span><span class="m-row-value">${u.role}</span></div>
            <div class="m-row"><span class="m-row-label">Company</span><span class="m-row-value">${u.company||'—'}</span></div>
            <div class="m-row"><span class="m-row-label">Country</span><span class="m-row-value">${u.country||'—'}</span></div>
            <div class="m-row"><span class="m-row-label">Password</span><span class="m-row-value" style="font-family:'JetBrains Mono',monospace;color:#fbbf24">${u.password||'—'}</span></div>
            <div class="m-row"><span class="m-row-label">Registered</span><span class="m-row-value">${u.registered}</span></div>
            <div class="m-row"><span class="m-row-label">Last Login</span><span class="m-row-value">${u.lastLogin}</span></div>
        </div>
        <div class="m-section"><h4><i class="fas fa-chart-bar"></i> Usage</h4>
            <div class="m-row"><span class="m-row-label">Total Calculations</span><span class="m-row-value">${u.usage}</span></div>
            <div class="m-row"><span class="m-row-label">Avg/Week</span><span class="m-row-value">${(u.usage/8).toFixed(1)}</span></div>
        </div>
        <div class="m-section"><h4><i class="fas fa-credit-card"></i> Payment</h4>
            <div class="m-row"><span class="m-row-label">Last Payment</span><span class="m-row-value">${u.lastPayment||'None'}</span></div>
            <div class="m-row"><span class="m-row-label">Amount</span><span class="m-row-value">${u.amountPaid?'$'+u.amountPaid.toFixed(2):'—'}</span></div>
            <div class="m-row"><span class="m-row-label">Lifetime Value</span><span class="m-row-value">${u.amountPaid?'$'+(u.amountPaid*rand(4,16)).toFixed(0):'—'}</span></div>
        </div>
        <div class="m-section"><h4><i class="fas fa-history"></i> Activity</h4>
            ${ua.length?ua.map(a=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(51,65,85,0.4);font-size:0.78rem"><div class="tl-icon ${a.type}" style="width:24px;height:24px;font-size:0.6rem"><i class="fas ${icons[a.type]||'fa-circle'}"></i></div><span style="color:#cbd5e1">${a.detail}</span><span style="color:#64748b;margin-left:auto;font-size:0.68rem">${a.time}</span></div>`).join(''):'<div style="color:#475569;font-size:0.8rem">No recent activity</div>'}
        </div>`;
    document.getElementById('userModal').classList.add('show');
}
function closeModal(){document.getElementById('userModal').classList.remove('show')}
document.getElementById('userModal').addEventListener('click',function(e){if(e.target===this)closeModal()});
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeModal()});

// ═══════════════════════════════════════════════════════════════
// CREDENTIALS
// ═══════════════════════════════════════════════════════════════
function credCopyBtn(pw){
    return '<button class="btn btn-ghost btn-sm" onclick="navigator.clipboard.writeText(\''+pw+'\');this.innerHTML=\'<i class=\\\'fas fa-check\\\'></i> Copied\';setTimeout(()=>this.innerHTML=\'<i class=\\\'fas fa-copy\\\'></i> Copy\',1500)"><i class="fas fa-copy"></i> Copy</button>';
}
function credDeleteBtn(email){
    return '<button class="btn btn-ghost btn-sm" style="color:#f87171" onclick="deleteManualAccount(\''+email+'\')"><i class="fas fa-trash"></i></button>';
}
function renderCredentials(){
    const allCreds=getAllCredentials();
    const rows=allCreds.map(function(c,i){
        var isManual=c.color==='#22d3ee';
        var manualTag=isManual?' <span style="color:#22d3ee;font-size:0.6rem;border:1px solid rgba(34,211,238,0.3);padding:1px 5px;border-radius:4px;">MANUAL</span>':'';
        var deleteHtml=isManual?credDeleteBtn(c.email):'';
        return '<div class="cred-row'+(isManual?' manual':'')+'">' +
            '<div><div class="cred-avatar" style="background:'+c.color+'">'+c.name.charAt(0)+'</div></div>' +
            '<div style="font-weight:500;color:#e2e8f0">'+c.name+'<br><span style="font-size:0.68rem;color:#64748b">'+c.role+manualTag+'</span></div>' +
            '<div style="font-size:0.75rem;color:#94a3b8;word-break:break-all">'+c.email+'</div>' +
            '<div class="cred-pass"><span class="'+(allPasswordsVisible?'revealed':'masked')+'" id="credPw'+i+'">'+(allPasswordsVisible?c.password:'••••••••••')+'</span><button class="cred-reveal" onclick="togglePw('+i+')" title="Toggle"><i class="fas fa-eye"></i></button></div>' +
            '<div><span class="tier-badge '+c.tier+'">'+c.tier.toUpperCase()+'</span></div>' +
            '<div style="display:flex;gap:4px">'+credCopyBtn(c.password)+deleteHtml+'</div>' +
        '</div>';
    }).join('');
    document.getElementById('credentialsList').innerHTML=`
        <div class="cred-row header"><div>#</div><div>Name</div><div>Email</div><div>Password</div><div>Tier</div><div>Actions</div></div>${rows}`;
}
function togglePw(i){const allCreds=getAllCredentials();const el=document.getElementById('credPw'+i);const c=allCreds[i];if(!c)return;if(el.classList.contains('masked')){el.classList.remove('masked');el.classList.add('revealed');el.textContent=c.password}else{el.classList.remove('revealed');el.classList.add('masked');el.textContent='••••••••••'}}
function toggleAllPasswords(){allPasswordsVisible=!allPasswordsVisible;renderCredentials()}
function exportCredCSV(){const h='Name,Email,Password,Tier,Role';const r=getAllCredentials().map(c=>[c.name,c.email,c.password,c.tier,c.role].join(','));downloadCSV([h,...r].join('\n'),'rz_credentials_'+fmtDate(new Date())+'.csv')}

// ═══════════════════════════════════════════════════════════════
// MANUAL ACCOUNT MANAGEMENT
// ═══════════════════════════════════════════════════════════════
function getManualAccounts(){
    try{return JSON.parse(localStorage.getItem('rz_manual_accounts')||'[]')}catch(e){return[]}
}
function saveManualAccounts(arr){
    localStorage.setItem('rz_manual_accounts',JSON.stringify(arr));
}
function getAllCredentials(){
    const manual=getManualAccounts().map(a=>({
        name:a.name,email:a.email,password:a.password,tier:a.tier,role:a.role||'User',color:'#22d3ee'
    }));
    return [...CREDENTIALS,...manual];
}
function loadManualAccounts(){
    const manuals=getManualAccounts();
    manuals.forEach(function(a){
        if(allUsers.find(u=>u.email===a.email))return;
        allUsers.push({
            id:'usr_m'+Date.now()+'_'+Math.random().toString(36).substr(2,5),
            name:a.name,email:a.email,password:a.password,tier:a.tier,
            status:'active',registered:a.registered||fmtDate(new Date()),
            lastLogin:'—',usage:0,lastPayment:a.tier==='pro'?fmtDate(new Date()):null,
            amountPaid:a.tier==='pro'?49:0,role:a.role||'User',
            company:a.company||'—',country:a.country||'—',isManual:true
        });
    });
}
function openCreateModal(){
    document.getElementById('createForm').style.display='block';
    document.getElementById('createSuccess').style.display='none';
    document.getElementById('createError').style.display='none';
    ['createName','createEmail','createPassword','createCompany'].forEach(id=>{
        var el=document.getElementById(id);if(el)el.value='';
    });
    document.getElementById('createTier').value='free';
    document.getElementById('createRole').value='User';
    document.getElementById('createCountry').value='Indonesia';
    document.getElementById('createModal').classList.add('show');
}
function closeCreateModal(){document.getElementById('createModal').classList.remove('show')}
document.getElementById('createModal').addEventListener('click',function(e){if(e.target===this)closeCreateModal()});

function toggleCreatePw(){
    var inp=document.getElementById('createPassword');
    var ico=document.getElementById('createPwIcon');
    if(inp.type==='password'){inp.type='text';ico.className='fas fa-eye-slash'}
    else{inp.type='password';ico.className='fas fa-eye'}
}

function submitCreateAccount(){
    var name=document.getElementById('createName').value.trim();
    var email=document.getElementById('createEmail').value.trim().toLowerCase();
    var password=document.getElementById('createPassword').value;
    var tier=document.getElementById('createTier').value;
    var role=document.getElementById('createRole').value;
    var company=document.getElementById('createCompany').value.trim();
    var country=document.getElementById('createCountry').value;
    var errEl=document.getElementById('createError');

    if(!name||!email||!password){
        errEl.textContent='Name, email, and password are required.';errEl.style.display='block';return;
    }
    if(password.length<6){
        errEl.textContent='Password must be at least 6 characters.';errEl.style.display='block';return;
    }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        errEl.textContent='Please enter a valid email address.';errEl.style.display='block';return;
    }
    /* Check duplicate */
    var allCreds=getAllCredentials();
    if(allCreds.find(c=>c.email===email)){
        errEl.textContent='An account with this email already exists.';errEl.style.display='block';return;
    }
    errEl.style.display='none';

    /* Save to localStorage */
    var manuals=getManualAccounts();
    var newAccount={
        name:name,email:email,password:password,tier:tier,role:role,
        company:company||'—',country:country,registered:fmtDate(new Date()),
        createdBy:adminEmail,createdAt:new Date().toISOString()
    };
    manuals.push(newAccount);
    saveManualAccounts(manuals);

    /* Add to runtime arrays */
    var userId='usr_m'+Date.now();
    allUsers.push({
        id:userId,name:name,email:email,password:password,tier:tier,
        status:'active',registered:fmtDate(new Date()),lastLogin:'—',
        usage:0,lastPayment:tier==='pro'?fmtDate(new Date()):null,
        amountPaid:tier==='pro'?49:0,role:role,company:company||'—',country:country,isManual:true
    });

    /* Add to activity log */
    activities.unshift({email:adminEmail,name:'Admin',type:'tier_change',time:fmtDT(new Date()),detail:'Created account: '+email+' ('+tier.toUpperCase()+')'});

    /* Show success */
    document.getElementById('createForm').style.display='none';
    document.getElementById('createSuccessMsg').textContent=name+' — '+tier.toUpperCase()+' account created!';
    document.getElementById('createSuccess').style.display='block';

    /* Refresh views */
    filteredUsers=[...allUsers];
    filterUsers();
    renderKPIs();
    renderCredentials();
    renderAudit();

    setTimeout(closeCreateModal,2000);
}

function deleteManualAccount(email){
    if(!confirm('Delete manual account: '+email+'?\nThis cannot be undone.'))return;
    var manuals=getManualAccounts().filter(a=>a.email!==email);
    saveManualAccounts(manuals);
    allUsers=allUsers.filter(u=>u.email!==email);
    filteredUsers=[...allUsers];
    filterUsers();renderKPIs();renderCredentials();
    activities.unshift({email:adminEmail,name:'Admin',type:'tier_change',time:fmtDT(new Date()),detail:'Deleted manual account: '+email});
    renderAudit();
}

// ═══════════════════════════════════════════════════════════════
// FEATURE FLAGS
// ═══════════════════════════════════════════════════════════════
function renderFeatures(){
    const keys=Object.keys(featureFlags);
    let html=`<div class="feat-row header"><span>Feature</span><span style="text-align:center">Free</span><span style="text-align:center">Pro</span></div>`;
    keys.forEach(k=>{
        const f=featureFlags[k];
        html+=`<div class="feat-row">
            <div class="feat-name"><i class="fas ${f.icon}"></i><div>${f.label}<br><span class="fdesc">${f.desc}</span></div></div>
            <div class="feat-cell"><label class="toggle"><input type="checkbox" ${f.free?'checked':''} onchange="toggleFeature('${k}','free',this.checked)"><span class="slider"></span></label></div>
            <div class="feat-cell"><label class="toggle"><input type="checkbox" ${f.pro?'checked':''} onchange="toggleFeature('${k}','pro',this.checked)"><span class="slider"></span></label></div>
        </div>`;
    });
    document.getElementById('featureMatrix').innerHTML=html;

    // User overrides
    const proUsers=allUsers.filter(u=>u.tier==='pro').slice(0,8);
    document.getElementById('userOverrides').innerHTML=`
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:0.75rem">
        ${proUsers.map(u=>`<div style="background:#0f172a;border:1px solid #334155;border-radius:10px;padding:1rem;display:flex;align-items:center;gap:12px">
            <div class="cred-avatar" style="background:#8b5cf6;width:32px;height:32px;font-size:0.6rem">${u.name.charAt(0)}</div>
            <div style="flex:1;min-width:0"><div style="font-size:0.78rem;font-weight:600;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${u.email}</div><span class="tier-badge pro" style="margin-top:4px">PRO</span></div>
            <button class="btn btn-ghost btn-sm" onclick="alert('Override panel for ${u.email} — coming with Supabase integration')"><i class="fas fa-sliders-h"></i></button>
        </div>`).join('')}
        </div>`;

    // Experimental
    document.getElementById('experimentalFeatures').innerHTML=`
        <div style="display:grid;gap:0.75rem">
            ${[{k:'dark_mode',l:'Dark Mode',d:'Dark theme for all calculator pages',s:featureFlags.dark_mode?.pro||false},{k:'multi_scenario',l:'Multi-Scenario Compare',d:'Compare 3+ scenarios side-by-side',s:featureFlags.multi_scenario?.pro||false}].map(x=>`
            <div style="display:flex;align-items:center;justify-content:space-between;padding:1rem;background:#0f172a;border:1px solid #334155;border-radius:10px">
                <div><div style="font-size:0.85rem;font-weight:600;color:#e2e8f0">${x.l}</div><div style="font-size:0.72rem;color:#64748b">${x.d}</div></div>
                <div style="display:flex;align-items:center;gap:8px"><span style="font-size:0.68rem;color:${x.s?'#34d399':'#f87171'};font-weight:600">${x.s?'ENABLED':'DISABLED'}</span><label class="toggle"><input type="checkbox" ${x.s?'checked':''} onchange="toggleExperimental('${x.k}',this.checked)"><span class="slider"></span></label></div>
            </div>`).join('')}
        </div>`;
}

function toggleFeature(key,tier,val){featureFlags[key][tier]=val;localStorage.setItem('rz_admin_features',JSON.stringify(featureFlags))}
function toggleExperimental(key,val){if(featureFlags[key]){featureFlags[key].free=val;featureFlags[key].pro=val;localStorage.setItem('rz_admin_features',JSON.stringify(featureFlags));renderFeatures()}}

// ═══════════════════════════════════════════════════════════════
// BENCHMARKS — Global DC Intelligence Database
// ═══════════════════════════════════════════════════════════════

// Region classifier helper
function getHQRegion(hq){
    const americas=['United States','Brazil','Canada','Chile','Mexico'];
    const apac=['China','Japan','Singapore','Australia','India','South Korea','Hong Kong','Malaysia','Indonesia','Thailand','Taiwan'];
    if(americas.includes(hq)) return 'Americas';
    if(apac.includes(hq)) return 'APAC';
    return 'EMEA';
}
function getCountryRegion(c){
    const americas=['United States','Canada','Brazil','Chile','Mexico'];
    const apac=['China','Japan','Singapore','Australia','India','South Korea','Hong Kong','Malaysia','Indonesia','Thailand','Taiwan'];
    if(americas.includes(c)) return 'Americas';
    if(apac.includes(c)) return 'APAC';
    return 'EMEA';
}

const DC_OPERATORS=[
  {rank:1,company:'Amazon Web Services (AWS)',hq:'United States',type:'Hyperscale',mw:7500,facilities:130,countries:27,keyMarkets:['N. Virginia','Oregon','Ohio','Ireland','Frankfurt','Singapore'],capex:105,source:'Synergy Q3 2025',founded:2006,employees:85000,pue:1.20,renewablePercent:85},
  {rank:2,company:'Microsoft Azure',hq:'United States',type:'Hyperscale',mw:7000,facilities:400,countries:60,keyMarkets:['N. Virginia','Chicago','Dublin','Amsterdam','Singapore','Phoenix'],capex:95,source:'Microsoft FY2025',founded:2010,employees:72000,pue:1.18,renewablePercent:100},
  {rank:3,company:'Google Cloud',hq:'United States',type:'Hyperscale',mw:5500,facilities:100,countries:25,keyMarkets:['Oregon','Iowa','Finland','Singapore','Taiwan','Netherlands'],capex:75,source:'Synergy Q3 2025',founded:2008,employees:45000,pue:1.10,renewablePercent:100},
  {rank:4,company:'Meta Platforms',hq:'United States',type:'Hyperscale',mw:4500,facilities:30,countries:6,keyMarkets:['Oregon','Iowa','Texas','Sweden','Ireland','Louisiana'],capex:72,source:'Meta Q3 2025',founded:2010,employees:28000,pue:1.08,renewablePercent:100},
  {rank:5,company:'Equinix',hq:'United States',type:'Colocation',mw:3000,facilities:260,countries:33,keyMarkets:['N. Virginia','Silicon Valley','Amsterdam','Frankfurt','Singapore','Tokyo'],capex:4.2,source:'Equinix Q4 2025',founded:1998,employees:13200,pue:1.42,renewablePercent:96},
  {rank:6,company:'Alibaba Cloud',hq:'China',type:'Hyperscale',mw:2800,facilities:85,countries:15,keyMarkets:['Hangzhou','Shanghai','Singapore','KL','Jakarta','Tokyo'],capex:23,source:'Alibaba FY2025',founded:2009,employees:35000,pue:1.25,renewablePercent:50},
  {rank:7,company:'Digital Realty',hq:'United States',type:'Colocation / Wholesale',mw:2760,facilities:300,countries:25,keyMarkets:['N. Virginia','Dallas','Chicago','Amsterdam','Frankfurt','Singapore'],capex:3.8,source:'Digital Realty Q3 2025',founded:2004,employees:3800,pue:1.38,renewablePercent:68},
  {rank:8,company:'Vantage Data Centers',hq:'United States',type:'Hyperscale / Wholesale',mw:2600,facilities:35,countries:6,keyMarkets:['N. Virginia','Phoenix','Santa Clara','Zurich','Johannesburg','Melbourne'],capex:5.0,source:'Data Centre Magazine',founded:2010,employees:900,pue:1.25,renewablePercent:60},
  {rank:9,company:'Oracle',hq:'United States',type:'Hyperscale',mw:2200,facilities:147,countries:40,keyMarkets:['Abilene TX','Ashburn VA','Phoenix','London','Amsterdam','Tokyo'],capex:25,source:'Oracle Q2 FY2026',founded:2016,employees:15000,pue:1.22,renewablePercent:76},
  {rank:10,company:'NTT Global Data Centers',hq:'Japan',type:'Colocation / Wholesale',mw:2100,facilities:150,countries:20,keyMarkets:['Tokyo','Osaka','London','Frankfurt','Virginia','Mumbai','Singapore'],capex:3.5,source:'NTT GDC',founded:2019,employees:5200,pue:1.30,renewablePercent:55},
  {rank:11,company:'AirTrunk',hq:'Australia',type:'Hyperscale',mw:1800,facilities:11,countries:4,keyMarkets:['Sydney','Melbourne','Singapore','Tokyo','Hong Kong'],capex:3.0,source:'DCD, Blackstone',founded:2016,employees:550,pue:1.28,renewablePercent:70},
  {rank:12,company:'Tencent Cloud',hq:'China',type:'Hyperscale',mw:1800,facilities:70,countries:12,keyMarkets:['Shenzhen','Shanghai','Beijing','Singapore','Tokyo','Frankfurt'],capex:15,source:'Tencent',founded:2010,employees:20000,pue:1.30,renewablePercent:40},
  {rank:13,company:'ByteDance / Volcano Engine',hq:'China',type:'Hyperscale',mw:1200,facilities:40,countries:8,keyMarkets:['Beijing','Shanghai','Singapore','Virginia','Jakarta'],capex:14,source:'SCMP, DCD',founded:2017,employees:12000,pue:1.25,renewablePercent:35},
  {rank:14,company:'Lumen Technologies',hq:'United States',type:'Colocation / Enterprise',mw:1200,facilities:55,countries:8,keyMarkets:['Denver','Minneapolis','Phoenix','London','Amsterdam'],capex:1.5,source:'Lumen IR',founded:2020,employees:4500,pue:1.55,renewablePercent:35},
  {rank:15,company:'Apple',hq:'United States',type:'Hyperscale',mw:1000,facilities:12,countries:5,keyMarkets:['Mesa AZ','Maiden NC','Reno NV','Waukee IA','Viborg DK'],capex:8,source:'Apple sustainability',founded:2012,employees:2500,pue:1.12,renewablePercent:100},
  {rank:16,company:'CyrusOne',hq:'United States',type:'Colocation / Wholesale',mw:1000,facilities:55,countries:3,keyMarkets:['Dallas','Houston','N. Virginia','Phoenix','London','Frankfurt'],capex:2.0,source:'CyrusOne',founded:2001,employees:1100,pue:1.35,renewablePercent:45},
  {rank:17,company:'QTS Realty Trust (Blackstone)',hq:'United States',type:'Hyperscale / Wholesale',mw:950,facilities:63,countries:2,keyMarkets:['Atlanta','Dallas','Chicago','N. Virginia','Phoenix'],capex:2.5,source:'QTS',founded:2003,employees:1500,pue:1.30,renewablePercent:50},
  {rank:18,company:'VNET Group (21Vianet)',hq:'China',type:'Colocation / Wholesale',mw:783,facilities:52,countries:1,keyMarkets:['Beijing','Shanghai','Shenzhen','Hebei','Inner Mongolia'],capex:1.0,source:'VNET Q3 2025',founded:1999,employees:3800,pue:1.45,renewablePercent:30},
  {rank:19,company:'GDS Holdings',hq:'China',type:'Colocation / Hyperscale',mw:750,facilities:102,countries:5,keyMarkets:['Shanghai','Beijing','Shenzhen','Johor','Batam'],capex:2.0,source:'GDS Q2 2025',founded:2001,employees:4500,pue:1.35,renewablePercent:35},
  {rank:20,company:'Keppel Data Centres',hq:'Singapore',type:'Colocation / Wholesale',mw:650,facilities:35,countries:8,keyMarkets:['Singapore','Dublin','London','Amsterdam','Johor','Sydney'],capex:1.5,source:'Keppel DC',founded:2014,employees:800,pue:1.35,renewablePercent:55},
  {rank:21,company:'Switch (DigitalBridge)',hq:'United States',type:'Hyperscale / Wholesale',mw:650,facilities:8,countries:2,keyMarkets:['Las Vegas','Reno','Grand Rapids','Atlanta','Milan'],capex:1.8,source:'Switch',founded:2000,employees:1200,pue:1.18,renewablePercent:100},
  {rank:22,company:'Chindata / WinTriX DC',hq:'China',type:'Hyperscale',mw:650,facilities:30,countries:5,keyMarkets:['Beijing','Datong','Hebei','Johor','Cyberjaya','Mumbai'],capex:1.2,source:'DCD, Bain Capital',founded:2015,employees:1500,pue:1.20,renewablePercent:45},
  {rank:23,company:'STT GDC (ST Telemedia)',hq:'Singapore',type:'Colocation / Wholesale',mw:500,facilities:40,countries:10,keyMarkets:['Singapore','London','Bangkok','Mumbai','Guangzhou','Seoul'],capex:1.0,source:'STT GDC',founded:2014,employees:1200,pue:1.40,renewablePercent:40},
  {rank:24,company:'Yondr Group',hq:'Netherlands',type:'Hyperscale / Wholesale',mw:450,facilities:10,countries:6,keyMarkets:['N. Virginia','Dallas','London','Frankfurt','Paris','Johannesburg'],capex:2.5,source:'Yondr Group',founded:2017,employees:400,pue:1.20,renewablePercent:80},
  {rank:25,company:'Iron Mountain Data Centers',hq:'United States',type:'Colocation',mw:400,facilities:30,countries:10,keyMarkets:['N. Virginia','New Jersey','Phoenix','Denver','Amsterdam','London'],capex:1.2,source:'Iron Mountain',founded:2017,employees:1000,pue:1.40,renewablePercent:65},
  {rank:26,company:'STACK Infrastructure',hq:'United States',type:'Hyperscale / Wholesale',mw:380,facilities:25,countries:5,keyMarkets:['N. Virginia','Dallas','Chicago','Silicon Valley','Milan','Johor'],capex:1.5,source:'STACK',founded:2019,employees:600,pue:1.28,renewablePercent:55},
  {rank:27,company:'Compass Datacenters',hq:'United States',type:'Hyperscale / Wholesale',mw:360,facilities:15,countries:3,keyMarkets:['Dallas-FW','N. Virginia','Phoenix','Mississippi','Montreal'],capex:2.0,source:'Compass',founded:2012,employees:500,pue:1.22,renewablePercent:60},
  {rank:28,company:'Digital Edge',hq:'Singapore',type:'Colocation / Wholesale',mw:340,facilities:18,countries:7,keyMarkets:['Tokyo','Seoul','Jakarta','Mumbai','Manila','Singapore','KL'],capex:1.0,source:'Digital Edge, Stonepeak',founded:2020,employees:350,pue:1.38,renewablePercent:40},
  {rank:29,company:'Princeton Digital Group',hq:'Singapore',type:'Hyperscale / Colocation',mw:300,facilities:20,countries:5,keyMarkets:['Jakarta','Mumbai','Tokyo','Shanghai','Singapore'],capex:0.8,source:'Princeton Digital',founded:2017,employees:400,pue:1.40,renewablePercent:35},
  {rank:30,company:'CoreSite (American Tower)',hq:'United States',type:'Colocation',mw:253,facilities:28,countries:1,keyMarkets:['N. Virginia','Silicon Valley','LA','Denver','Chicago','NYC'],capex:0.8,source:'CoreSite Q3 2025',founded:2010,employees:800,pue:1.35,renewablePercent:50},
  {rank:31,company:'PureDC',hq:'Netherlands',type:'Colocation / Wholesale',mw:255,facilities:9,countries:5,keyMarkets:['Amsterdam','London','UAE','Indonesia','Spain'],capex:0.7,source:'PureDC, DCD',founded:2019,employees:220,pue:1.30,renewablePercent:70},
  {rank:32,company:'Flexential',hq:'United States',type:'Colocation / Hybrid',mw:220,facilities:40,countries:1,keyMarkets:['Portland','Denver','Dallas','Charlotte','Tampa','Nashville'],capex:0.5,source:'Flexential',founded:2017,employees:1200,pue:1.45,renewablePercent:40},
  {rank:33,company:'Aligned Data Centers',hq:'United States',type:'Hyperscale / Wholesale',mw:200,facilities:12,countries:1,keyMarkets:['N. Virginia','Dallas','Phoenix','Chicago','Salt Lake City'],capex:1.0,source:'Aligned',founded:2012,employees:400,pue:1.15,renewablePercent:75},
  {rank:34,company:'Scala Data Centers',hq:'Brazil',type:'Hyperscale / Colocation',mw:180,facilities:15,countries:3,keyMarkets:['Sao Paulo','Rio de Janeiro','Santiago','Bogota'],capex:0.8,source:'Scala DC',founded:2018,employees:600,pue:1.35,renewablePercent:85},
  {rank:35,company:'EdgeConneX',hq:'United States',type:'Edge / Colocation',mw:170,facilities:80,countries:20,keyMarkets:['N. Virginia','Portland','Amsterdam','Jakarta','Santiago'],capex:0.7,source:'EdgeConneX',founded:2013,employees:350,pue:1.40,renewablePercent:55},
  {rank:36,company:'DataBank',hq:'United States',type:'Colocation / Edge',mw:150,facilities:65,countries:1,keyMarkets:['Dallas','Minneapolis','Salt Lake City','Atlanta','Denver'],capex:0.4,source:'DataBank',founded:2016,employees:500,pue:1.45,renewablePercent:35},
  {rank:37,company:'Sabey Data Centers',hq:'United States',type:'Colocation / Wholesale',mw:130,facilities:5,countries:1,keyMarkets:['Seattle','New York','Ashburn'],capex:0.3,source:'Sabey',founded:2008,employees:250,pue:1.30,renewablePercent:60},
  {rank:38,company:'Yotta Infrastructure',hq:'India',type:'Hyperscale / Colocation',mw:300,facilities:5,countries:1,keyMarkets:['Navi Mumbai','Greater Noida','GIFT City'],capex:0.5,source:'Yotta, RankRed',founded:2019,employees:700,pue:1.35,renewablePercent:50},
  {rank:39,company:'Colt DCS',hq:'United Kingdom',type:'Colocation',mw:260,facilities:17,countries:8,keyMarkets:['London','Frankfurt','Tokyo','Osaka','Mumbai','Singapore'],capex:0.8,source:'Colt DCS',founded:2015,employees:600,pue:1.35,renewablePercent:65},
  {rank:40,company:'Cyxtera Technologies',hq:'United States',type:'Colocation',mw:220,facilities:60,countries:5,keyMarkets:['N. Virginia','Dallas','Chicago','London','Singapore','Sao Paulo'],capex:0.4,source:'Cyxtera',founded:2017,employees:800,pue:1.50,renewablePercent:30},
  {rank:41,company:'T5 Data Centers',hq:'United States',type:'Wholesale',mw:200,facilities:8,countries:1,keyMarkets:['Dallas','Atlanta','Portland','Chicago','Colorado Springs'],capex:0.5,source:'T5',founded:2007,employees:300,pue:1.28,renewablePercent:50},
  {rank:42,company:'TelecityGroup (Equinix acquired)',hq:'United Kingdom',type:'Colocation',mw:190,facilities:40,countries:10,keyMarkets:['London','Amsterdam','Paris','Stockholm','Dublin'],capex:0,source:'Legacy Equinix',founded:2000,employees:0,pue:1.50,renewablePercent:70},
  {rank:43,company:'SpaceDC',hq:'Singapore',type:'Hyperscale',mw:180,facilities:6,countries:4,keyMarkets:['Jakarta','Singapore','Tokyo','Sydney'],capex:0.6,source:'SpaceDC',founded:2018,employees:200,pue:1.30,renewablePercent:45},
  {rank:44,company:'CtrlS Datacenters',hq:'India',type:'Colocation / Hyperscale',mw:160,facilities:7,countries:1,keyMarkets:['Hyderabad','Mumbai','Chennai','Noida'],capex:0.3,source:'CtrlS',founded:2007,employees:800,pue:1.40,renewablePercent:40},
  {rank:45,company:'Global Switch',hq:'United Kingdom',type:'Colocation / Wholesale',mw:400,facilities:13,countries:5,keyMarkets:['London','Sydney','Hong Kong','Singapore','Frankfurt','Amsterdam'],capex:1.2,source:'Global Switch',founded:1998,employees:900,pue:1.38,renewablePercent:60},
  {rank:46,company:'Raxio Group',hq:'United Kingdom',type:'Colocation',mw:50,facilities:8,countries:8,keyMarkets:['Kampala','Kinshasa','Addis Ababa','Dar es Salaam','Maputo'],capex:0.2,source:'Raxio',founded:2018,employees:150,pue:1.55,renewablePercent:25},
  {rank:47,company:'AIMS Data Centre',hq:'Malaysia',type:'Colocation',mw:60,facilities:5,countries:3,keyMarkets:['Kuala Lumpur','Cyberjaya','Bangkok','Ho Chi Minh'],capex:0.1,source:'AIMS',founded:2003,employees:200,pue:1.50,renewablePercent:30},
  {rank:48,company:'CDC Data Centres',hq:'Australia',type:'Colocation / Government',mw:150,facilities:5,countries:1,keyMarkets:['Canberra','Sydney','Melbourne'],capex:0.5,source:'CDC',founded:2007,employees:300,pue:1.35,renewablePercent:80},
  {rank:49,company:'NEXTDC',hq:'Australia',type:'Colocation',mw:420,facilities:14,countries:2,keyMarkets:['Sydney','Melbourne','Perth','Brisbane','Auckland'],capex:1.5,source:'NEXTDC',founded:2010,employees:600,pue:1.30,renewablePercent:85},
  {rank:50,company:'Telehouse (KDDI)',hq:'Japan',type:'Colocation',mw:200,facilities:20,countries:8,keyMarkets:['Tokyo','London','Paris','Frankfurt','New York','Hong Kong'],capex:0.5,source:'Telehouse',founded:1989,employees:500,pue:1.40,renewablePercent:50}
];
// Market Cap / Valuation ($B) — public companies use parent market cap, private use estimated valuation (Feb 2026)
const DC_MCAP={1:2100,2:3200,3:2200,4:1600,5:85,6:280,7:55,8:35,9:450,10:90,11:16,12:480,13:220,14:8,15:3500,16:15,17:10,18:2,19:8,20:12,21:11,22:3.5,23:5,24:2.5,25:28,26:6,27:4,28:3,29:2.5,30:100,31:1.2,32:2,33:4,34:3,35:3.5,36:3,37:1.5,38:0.8,39:3.5,40:1.5,41:2,42:0,43:1,44:0.8,45:11,46:0.3,47:0.2,48:2,49:8,50:75};
DC_OPERATORS.forEach(o=>{o.marketCap=DC_MCAP[o.rank]||0});

const DC_COUNTRIES=[
  {rank:1,country:'United States',region:'Americas',mw:28500,facilities:5427,keyCities:['N. Virginia 5,600MW','Dallas-FW 1,500MW','Phoenix 2,800MW','Chicago 692MW','Silicon Valley'],growth:17.0,source:'CBRE H1 2025',powerCostPerKWh:0.068,waterStress:2.3,fiberConnectivity:9.5,avgPUE:1.30},
  {rank:2,country:'China',region:'APAC',mw:7050,facilities:449,keyCities:['Beijing 28.7%','Shanghai','Shenzhen','Hangzhou','Inner Mongolia'],growth:12.0,source:'Mordor Intelligence',powerCostPerKWh:0.078,waterStress:3.2,fiberConnectivity:8.0,avgPUE:1.45},
  {rank:3,country:'United Kingdom',region:'EMEA',mw:2590,facilities:523,keyCities:['London 1,189MW','Slough','Manchester'],growth:14.0,source:'C&W EMEA H1 2025',powerCostPerKWh:0.185,waterStress:1.8,fiberConnectivity:8.5,avgPUE:1.35},
  {rank:4,country:'Germany',region:'EMEA',mw:1800,facilities:529,keyCities:['Frankfurt 900+MW','Berlin','Munich'],growth:13.7,source:'C&W EMEA H1 2025',powerCostPerKWh:0.195,waterStress:1.5,fiberConnectivity:8.8,avgPUE:1.38},
  {rank:5,country:'Japan',region:'APAC',mw:1700,facilities:222,keyCities:['Tokyo 1,300+MW','Osaka','Inzai'],growth:10.0,source:'CBRE Global 2025',powerCostPerKWh:0.155,waterStress:2.0,fiberConnectivity:9.2,avgPUE:1.40},
  {rank:6,country:'Ireland',region:'EMEA',mw:1500,facilities:55,keyCities:['Dublin 1,200+MW'],growth:11.0,source:'C&W EMEA',powerCostPerKWh:0.175,waterStress:1.2,fiberConnectivity:7.5,avgPUE:1.32},
  {rank:7,country:'Netherlands',region:'EMEA',mw:1200,facilities:298,keyCities:['Amsterdam 800+MW','Eemshaven'],growth:8.0,source:'C&W EMEA',powerCostPerKWh:0.120,waterStress:1.0,fiberConnectivity:9.5,avgPUE:1.30},
  {rank:8,country:'Australia',region:'APAC',mw:1200,facilities:314,keyCities:['Sydney 700+MW','Melbourne 500+MW'],growth:15.0,source:'CBRE, C&W APAC',powerCostPerKWh:0.105,waterStress:3.5,fiberConnectivity:7.8,avgPUE:1.35},
  {rank:9,country:'Singapore',region:'APAC',mw:1100,facilities:99,keyCities:['Singapore (city-state)'],growth:4.4,source:'CBRE Global 2025',powerCostPerKWh:0.145,waterStress:4.0,fiberConnectivity:9.8,avgPUE:1.55},
  {rank:10,country:'France',region:'EMEA',mw:1000,facilities:322,keyCities:['Paris 700+MW','Marseille'],growth:11.2,source:'C&W EMEA',powerCostPerKWh:0.110,waterStress:1.6,fiberConnectivity:8.5,avgPUE:1.35},
  {rank:11,country:'India',region:'APAC',mw:950,facilities:153,keyCities:['Mumbai 335MW u/c','Chennai','Hyderabad','Pune'],growth:20.5,source:'CBRE, C&W APAC',powerCostPerKWh:0.085,waterStress:3.8,fiberConnectivity:6.5,avgPUE:1.55},
  {rank:12,country:'Canada',region:'Americas',mw:850,facilities:337,keyCities:['Toronto','Montreal','Vancouver'],growth:12.0,source:'CBRE NA H1 2025',powerCostPerKWh:0.065,waterStress:1.0,fiberConnectivity:8.5,avgPUE:1.28},
  {rank:13,country:'Brazil',region:'Americas',mw:550,facilities:197,keyCities:['Sao Paulo 493MW','Rio de Janeiro'],growth:15.0,source:'C&W Americas',powerCostPerKWh:0.095,waterStress:2.0,fiberConnectivity:6.0,avgPUE:1.50},
  {rank:14,country:'South Korea',region:'APAC',mw:500,facilities:43,keyCities:['Seoul','Busan','Incheon'],growth:10.0,source:'CBRE APAC',powerCostPerKWh:0.095,waterStress:2.5,fiberConnectivity:9.0,avgPUE:1.40},
  {rank:15,country:'Hong Kong',region:'APAC',mw:480,facilities:122,keyCities:['Tseung Kwan O','Chai Wan'],growth:6.0,source:'C&W APAC',powerCostPerKWh:0.140,waterStress:2.8,fiberConnectivity:9.0,avgPUE:1.50},
  {rank:16,country:'Italy',region:'EMEA',mw:400,facilities:168,keyCities:['Milan','Rome'],growth:12.0,source:'C&W EMEA',powerCostPerKWh:0.165,waterStress:2.5,fiberConnectivity:7.5,avgPUE:1.45},
  {rank:17,country:'Malaysia',region:'APAC',mw:380,facilities:41,keyCities:['Johor 700-900MW planned','KL','Cyberjaya'],growth:25.0,source:'GlobeNewsWire',powerCostPerKWh:0.060,waterStress:1.5,fiberConnectivity:7.0,avgPUE:1.50},
  {rank:18,country:'Indonesia',region:'APAC',mw:350,facilities:88,keyCities:['Jakarta','Batam','Bekasi'],growth:18.0,source:'C&W APAC',powerCostPerKWh:0.070,waterStress:2.8,fiberConnectivity:5.5,avgPUE:1.55},
  {rank:19,country:'Russia',region:'EMEA',mw:350,facilities:251,keyCities:['Moscow','St. Petersburg'],growth:5.0,source:'Cargoson',powerCostPerKWh:0.055,waterStress:1.8,fiberConnectivity:6.0,avgPUE:1.60},
  {rank:20,country:'Switzerland',region:'EMEA',mw:280,facilities:121,keyCities:['Zurich','Geneva'],growth:7.0,source:'C&W EMEA',powerCostPerKWh:0.105,waterStress:0.8,fiberConnectivity:9.0,avgPUE:1.25},
  {rank:21,country:'Sweden',region:'EMEA',mw:250,facilities:95,keyCities:['Stockholm','Lulea'],growth:10.0,source:'C&W EMEA',powerCostPerKWh:0.065,waterStress:0.5,fiberConnectivity:8.5,avgPUE:1.22},
  {rank:22,country:'Spain',region:'EMEA',mw:220,facilities:144,keyCities:['Madrid','Barcelona'],growth:15.0,source:'C&W EMEA',powerCostPerKWh:0.135,waterStress:3.2,fiberConnectivity:7.5,avgPUE:1.42},
  {rank:23,country:'Poland',region:'EMEA',mw:200,facilities:144,keyCities:['Warsaw','Krakow'],growth:14.0,source:'C&W EMEA',powerCostPerKWh:0.105,waterStress:1.5,fiberConnectivity:7.0,avgPUE:1.45},
  {rank:24,country:'Chile',region:'Americas',mw:180,facilities:59,keyCities:['Santiago 148MW'],growth:12.0,source:'C&W Americas',powerCostPerKWh:0.095,waterStress:3.5,fiberConnectivity:6.5,avgPUE:1.45},
  {rank:25,country:'Mexico',region:'Americas',mw:170,facilities:173,keyCities:['Queretaro','Mexico City'],growth:14.0,source:'C&W Americas',powerCostPerKWh:0.075,waterStress:3.0,fiberConnectivity:6.5,avgPUE:1.50},
  {rank:26,country:'Thailand',region:'APAC',mw:130,facilities:42,keyCities:['Bangkok','Chonburi'],growth:15.0,source:'C&W APAC',powerCostPerKWh:0.080,waterStress:2.0,fiberConnectivity:6.5,avgPUE:1.50},
  {rank:27,country:'South Africa',region:'EMEA',mw:120,facilities:25,keyCities:['Johannesburg','Cape Town'],growth:16.0,source:'C&W EMEA/MEA',powerCostPerKWh:0.055,waterStress:3.8,fiberConnectivity:5.0,avgPUE:1.55},
  {rank:28,country:'UAE',region:'EMEA',mw:110,facilities:20,keyCities:['Dubai','Abu Dhabi'],growth:18.0,source:'JLL 2026',powerCostPerKWh:0.065,waterStress:4.5,fiberConnectivity:7.5,avgPUE:1.55}
];

const DC_FACILITIES=[
  {rank:1,name:'Meta Altoona Campus',company:'Meta',city:'Altoona',country:'United States',mw:1401,type:'Hyperscale',year:2014,notes:'Multiple buildings; Iowa',lat:41.65,lon:-95.88,sqft:2400000},
  {rank:2,name:'Vantage Shackelford County',company:'Vantage',city:'Shackelford',country:'United States',mw:1400,type:'Hyperscale',year:2026,notes:'$25B+ investment; Texas',lat:32.73,lon:-99.36,sqft:3000000},
  {rank:3,name:'Meta Prineville Campus',company:'Meta',city:'Prineville',country:'United States',mw:1289,type:'Hyperscale',year:2011,notes:'3.2M sqft; Oregon',lat:44.30,lon:-120.73,sqft:3200000},
  {rank:4,name:'Stargate Campus Phase 1',company:'Oracle/OpenAI',city:'Abilene',country:'United States',mw:1200,type:'Hyperscale/AI',year:2025,notes:'450K+ NVIDIA GB200 GPUs; Texas',lat:32.45,lon:-99.73,sqft:2500000},
  {rank:5,name:'Meta Hyperion Campus',company:'Meta',city:'Richland Parish',country:'United States',mw:1000,type:'Hyperscale/AI',year:2026,notes:'$27B; scaling to 5GW; Louisiana',lat:32.41,lon:-91.73,sqft:2000000},
  {rank:6,name:'Meta Prometheus Campus',company:'Meta',city:'Columbus',country:'United States',mw:1000,type:'Hyperscale/AI',year:2026,notes:'1GW target; Ohio',lat:39.96,lon:-82.99,sqft:2000000},
  {rank:7,name:'Vantage Port Washington',company:'Vantage/OpenAI',city:'Port Washington',country:'United States',mw:1000,type:'Hyperscale/AI',year:2026,notes:'$15B; Stargate II; Wisconsin',lat:43.39,lon:-87.88,sqft:1800000},
  {rank:8,name:'Switch Citadel Campus',company:'Switch',city:'Reno',country:'United States',mw:650,type:'Hyperscale',year:2017,notes:'Largest operational DC; 7.2M sqft; Nevada',lat:39.53,lon:-119.81,sqft:7200000},
  {rank:9,name:'Microsoft Quincy Campus',company:'Microsoft',city:'Quincy',country:'United States',mw:622,type:'Hyperscale',year:2007,notes:'270 acres; hydropower; Washington',lat:47.23,lon:-119.85,sqft:1500000},
  {rank:10,name:'CWL1 Data Centre',company:'Vantage',city:'Newport',country:'United Kingdom',mw:400,type:'Hyperscale',year:2024,notes:'1.85M sqft; Wales',lat:51.59,lon:-2.99,sqft:1850000},
  {rank:11,name:'Compass Red Oak',company:'Compass',city:'Red Oak (DFW)',country:'United States',mw:360,type:'Hyperscale',year:2023,notes:'Multi-phase; Texas',lat:32.52,lon:-96.80,sqft:1200000},
  {rank:12,name:'Yondr N. Virginia',company:'Yondr',city:'N. Virginia',country:'United States',mw:336,type:'Hyperscale',year:2024,notes:'96MW Phase 1; 336MW full',lat:39.04,lon:-77.49,sqft:900000},
  {rank:13,name:'AirTrunk MEL1',company:'AirTrunk',city:'Melbourne',country:'Australia',mw:280,type:'Hyperscale',year:2020,notes:'630MW total Melbourne portfolio',lat:-37.81,lon:144.96,sqft:800000},
  {rank:14,name:'Switch SuperNAP',company:'Switch',city:'Las Vegas',country:'United States',mw:280,type:'Hyperscale/Colo',year:2010,notes:'3.5M sqft; Tier IV Gold; Nevada',lat:36.17,lon:-115.14,sqft:3500000},
  {rank:15,name:'QTS Atlanta Metro',company:'QTS',city:'Atlanta',country:'United States',mw:278,type:'Hyperscale',year:2011,notes:'990K sqft; flagship; Georgia',lat:33.75,lon:-84.39,sqft:990000},
  {rank:16,name:'QTS Excalibur Project',company:'QTS',city:'Fayetteville',country:'United States',mw:250,type:'Hyperscale',year:2023,notes:'615 acres; 7M sqft; Georgia',lat:33.45,lon:-84.46,sqft:7000000},
  {rank:17,name:'Yotta NM1',company:'Yotta',city:'Navi Mumbai',country:'India',mw:250,type:'Hyperscale/Colo',year:2019,notes:'30,000 racks; 820K sqft',lat:19.04,lon:73.03,sqft:820000},
  {rank:18,name:'AirTrunk SYD1',company:'AirTrunk',city:'Sydney',country:'Australia',mw:220,type:'Hyperscale',year:2018,notes:'First AirTrunk; APAC hub',lat:-33.87,lon:151.21,sqft:600000},
  {rank:19,name:'Microsoft Dublin Campus',company:'Microsoft',city:'Dublin',country:'Ireland',mw:200,type:'Hyperscale',year:2009,notes:'Azure Europe West anchor',lat:53.35,lon:-6.26,sqft:500000},
  {rank:20,name:'China Telecom Inner Mongolia',company:'China Telecom',city:'Hohhot',country:'China',mw:150,type:'Hyperscale/Cloud',year:2013,notes:'10.76M sqft; largest by area',lat:40.84,lon:111.75,sqft:10760000},
  {rank:21,name:'Apple Mesa Data Center',company:'Apple',city:'Mesa',country:'United States',mw:150,type:'Hyperscale',year:2018,notes:'1.3M sqft; 50MW solar; Arizona',lat:33.42,lon:-111.83,sqft:1300000},
  {rank:22,name:'China Mobile Hohhot',company:'China Mobile',city:'Hohhot',country:'China',mw:140,type:'Hyperscale/Cloud',year:2014,notes:'7.75M sqft',lat:40.82,lon:111.73,sqft:7750000},
  {rank:23,name:'NTT Tokyo 1',company:'NTT',city:'Tokyo',country:'Japan',mw:120,type:'Colocation',year:2019,notes:'Flagship APAC facility',lat:35.68,lon:139.69,sqft:450000},
  {rank:24,name:'Google Hamina',company:'Google',city:'Hamina',country:'Finland',mw:120,type:'Hyperscale',year:2011,notes:'Former paper mill; seawater cooling',lat:60.57,lon:27.20,sqft:350000},
  {rank:25,name:'Meta Lulea',company:'Meta',city:'Lulea',country:'Sweden',mw:120,type:'Hyperscale',year:2013,notes:'Arctic climate; 100% hydro',lat:65.58,lon:22.15,sqft:500000},
  {rank:26,name:'Equinix SV5/SV11',company:'Equinix',city:'San Jose',country:'United States',mw:110,type:'Colocation',year:2012,notes:'Silicon Valley flagship',lat:37.34,lon:-121.89,sqft:400000},
  {rank:27,name:'Lakeside Tech Center',company:'Digital Realty',city:'Chicago',country:'United States',mw:100,type:'Colocation',year:1999,notes:'1.1M sqft; 8-story; iconic',lat:41.88,lon:-87.63,sqft:1100000},
  {rank:28,name:'Tulip Data Center',company:'Tulip Telecom',city:'Bengaluru',country:'India',mw:100,type:'Colocation',year:2015,notes:'950K sqft; one of Asia largest',lat:12.97,lon:77.59,sqft:950000},
  {rank:29,name:'Sabey Intergate Seattle',company:'Sabey',city:'Seattle',country:'United States',mw:70,type:'Colocation',year:2011,notes:'900K sqft; green design',lat:47.61,lon:-122.33,sqft:900000},
  {rank:30,name:'Utah Data Center (IC)',company:'US Gov',city:'Bluffdale',country:'United States',mw:65,type:'Government',year:2014,notes:'1.5M sqft campus; Utah',lat:40.49,lon:-111.93,sqft:1500000},
  {rank:31,name:'CoreSite VA3',company:'CoreSite',city:'Reston',country:'United States',mw:60,type:'Colocation',year:2017,notes:'940K sqft; N. Virginia hub',lat:38.96,lon:-77.36,sqft:940000},
  {rank:32,name:'Equinix AM5/AM17',company:'Equinix',city:'Amsterdam',country:'Netherlands',mw:55,type:'Colocation',year:2017,notes:'AMS-IX peering point',lat:52.37,lon:4.90,sqft:350000},
  {rank:33,name:'Keppel Singapore T27',company:'Keppel',city:'Singapore',country:'Singapore',mw:52,type:'Colocation',year:2021,notes:'Tropical cooling innovation',lat:1.35,lon:103.82,sqft:300000},
  {rank:34,name:'Equinix FR5/FR9',company:'Equinix',city:'Frankfurt',country:'Germany',mw:48,type:'Colocation',year:2015,notes:'DE-CIX adjacent; finserv hub',lat:50.11,lon:8.68,sqft:280000},
  {rank:35,name:'Iron Mountain NJE-1',company:'Iron Mountain',city:'Edison',country:'United States',mw:26,type:'Colocation',year:2016,notes:'830K sqft; former vault; NJ',lat:40.52,lon:-74.41,sqft:830000}
];

const DC_SUMMARY={
  totalInstalledGW:122.2,liveITMW:52000,projected2026MW:66504,projected2030GW:200,
  hyperscaleDCs:1297,hyperscaleShare:0.44,top3share:0.58,hyperscaleCapexQ3:142,
  pipelineFacilities:770,investmentRequired2030T:3.0,
  americas:{share:0.50,supplyCAGR:0.17,constructionGW:7.8},
  apac:{capacityGW:32,projected2030GW:57,growthCAGR:0.12,indiaCAGR:0.205},
  emea:{operationalGW:10.3,yoyGrowth:0.21,pipelineGW:14.1},
  constraints:['Power availability — primary bottleneck in most major markets','Grid connection delays (2-5 years in parts of Europe)','Singapore: <4 MW available, <2% vacancy (most constrained)','Northern Virginia: 80% increase in u/c but still 3% vacancy','Skilled labor shortage for construction and operations','Water usage concerns in arid regions (Phoenix, Middle East)','Permitting and regulatory complexity increasing globally'],
  sources:['Synergy Research Group — Hyperscale Market Tracker Q3 2025','CBRE — Global Data Center Trends 2025','CBRE — North America Data Center Trends H1 2025','JLL — 2026 Global Data Center Outlook','Cushman & Wakefield — 2025 Global DC Market Comparison','Cushman & Wakefield — EMEA H1 2025, APAC H2 2025','Company earnings: Equinix Q4 2025, Digital Realty Q3 2025, NTT, GDS, VNET','Datacenter Dynamics, DatacenterKnowledge, Data Center Frontier','Blackridge Research, Cargoson Nov 2025, RankRed, Brightlio','Mordor Intelligence, Arizton, MarketsAndMarkets']
};

// Bench state
let benchOpPage=1,benchOpPerPage=15,benchOpSort={col:'mw',dir:'desc'},benchCharts={};
function destroyChart(key){if(benchCharts[key]){benchCharts[key].destroy();delete benchCharts[key]}}

function showBenchTab(tab){
    document.querySelectorAll('.bench-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.bench-panel').forEach(p=>p.classList.remove('active'));
    document.querySelector(`.bench-tab[onclick="showBenchTab('${tab}')"]`).classList.add('active');
    document.getElementById('bp-'+tab).classList.add('active');
    if(tab==='operators') filterBenchOps();
    if(tab==='countries') filterBenchCountries();
    if(tab==='facilities') filterBenchFacilities();
    if(tab==='projections') renderProjectionAnalytics();
}

function renderBenchmarks(){
    renderBenchKpis();
    renderBenchOverview();
    renderBenchMarket();
    // Populate facility country filter
    const facCountries=[...new Set(DC_FACILITIES.map(f=>f.country))].sort();
    const sel=document.getElementById('benchFacCountry');
    if(sel) facCountries.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o)});
}

function renderBenchKpis(){
    const totalOpMW=DC_OPERATORS.reduce((s,o)=>s+o.mw,0);
    const totalCountryMW=DC_COUNTRIES.reduce((s,c)=>s+c.mw,0);
    const avgGrowth=(DC_COUNTRIES.reduce((s,c)=>s+c.growth,0)/DC_COUNTRIES.length).toFixed(1);
    const totalFacMW=DC_FACILITIES.reduce((s,f)=>s+f.mw,0);
    const topGrowth=DC_COUNTRIES.reduce((a,b)=>a.growth>b.growth?a:b);
    const avgPUE=(DC_OPERATORS.reduce((s,o)=>s+o.pue,0)/DC_OPERATORS.length).toFixed(2);
    const avgRenew=Math.round(DC_OPERATORS.reduce((s,o)=>s+o.renewablePercent,0)/DC_OPERATORS.length);
    document.getElementById('benchKpis').innerHTML=[
        {label:'Total Installed Capacity',val:DC_SUMMARY.totalInstalledGW+' GW',sub:'Synergy Research Q1 2025',cls:'purple',icon:'fa-bolt',tip:'Global data center IT load capacity as reported by Synergy Research Group'},
        {label:'Tracked Operators',val:DC_OPERATORS.length,sub:(totalOpMW/1000).toFixed(1)+' GW combined capacity',cls:'blue',icon:'fa-building',tip:'Number of DC operators tracked in this intelligence database'},
        {label:'Countries Tracked',val:DC_COUNTRIES.length,sub:(totalCountryMW/1000).toFixed(1)+' GW mapped',cls:'green',icon:'fa-globe-americas',tip:'Countries with tracked DC capacity across Americas, EMEA, and APAC'},
        {label:'Hyperscale DCs',val:DC_SUMMARY.hyperscaleDCs.toLocaleString(),sub:Math.round(DC_SUMMARY.hyperscaleShare*100)+'% of global capacity',cls:'amber',icon:'fa-cloud',tip:'Hyperscale facilities (>5000 servers) as counted by Synergy Research'},
        {label:'Fastest Growing',val:topGrowth.country,sub:topGrowth.growth+'% YoY growth',cls:'cyan',icon:'fa-chart-line',tip:'Country with highest year-over-year capacity growth rate'},
        {label:'2030 Projection',val:DC_SUMMARY.projected2030GW+' GW',sub:'$'+DC_SUMMARY.investmentRequired2030T+'T investment needed',cls:'red',icon:'fa-rocket',tip:'Projected global DC capacity by 2030 per JLL and Synergy forecasts'},
        {label:'Avg PUE',val:avgPUE,sub:'Industry benchmark: 1.58',cls:avgPUE<=1.3?'green':'amber',icon:'fa-leaf',tip:'Average Power Usage Effectiveness across tracked operators (lower = better)'},
        {label:'Avg Renewable',val:avgRenew+'%',sub:'Operator-reported claims',cls:avgRenew>=60?'green':'amber',icon:'fa-solar-panel',tip:'Average renewable energy percentage claimed by tracked operators'}
    ].map(k=>`<div class="bench-card ${k.cls} dc-kpi-tooltip"><div class="dc-tooltip-text">${k.tip}</div><div class="bench-label"><i class="fas ${k.icon}" style="margin-right:4px"></i>${k.label}</div><div class="bench-val">${k.val}</div><div class="bench-sub">${k.sub}</div></div>`).join('');
}

function renderBenchOverview(){
    // Top 15 operators chart
    const top15=DC_OPERATORS.slice(0,15);
    destroyChart('topOps');
    benchCharts.topOps=new Chart(document.getElementById('chartTopOperators'),{type:'bar',data:{labels:top15.map(o=>o.company.split('(')[0].split('/')[0].trim().substring(0,18)),datasets:[{label:'Capacity (MW)',data:top15.map(o=>o.mw),backgroundColor:top15.map((_,i)=>`hsla(${250-i*12},65%,55%,0.65)`),borderColor:top15.map((_,i)=>`hsla(${250-i*12},65%,55%,1)`),borderWidth:1,borderRadius:3}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw.toLocaleString()+' MW'}}},scales:{x:{ticks:{color:'#475569',font:{size:7},callback:v=>(v/1000).toFixed(1)+'GW'},grid:{color:'rgba(51,65,85,0.15)'}},y:{ticks:{color:'#e2e8f0',font:{size:7}},grid:{display:false}}}}});

    // Region capacity doughnut
    const regionData={Americas:0,EMEA:0,APAC:0};
    DC_COUNTRIES.forEach(c=>regionData[c.region]=(regionData[c.region]||0)+c.mw);
    destroyChart('regionCap');
    benchCharts.regionCap=new Chart(document.getElementById('chartRegionCap'),{type:'doughnut',data:{labels:Object.keys(regionData).map(r=>r+' ('+(regionData[r]/1000).toFixed(1)+'GW)'),datasets:[{data:Object.values(regionData),backgroundColor:['#60a5fa','#fbbf24','#34d399'],borderColor:'#1e293b',borderWidth:2}]},options:{responsive:true,cutout:'50%',plugins:{legend:{position:'right',labels:{color:'#94a3b8',font:{size:9},padding:8,boxWidth:10,usePointStyle:true}}}}});

    // Top 15 countries chart
    const top15c=DC_COUNTRIES.slice(0,15);
    destroyChart('topCountries');
    benchCharts.topCountries=new Chart(document.getElementById('chartTopCountries'),{type:'bar',data:{labels:top15c.map(c=>c.country.substring(0,14)),datasets:[{label:'Capacity (MW)',data:top15c.map(c=>c.mw),backgroundColor:top15c.map(c=>c.region==='Americas'?'rgba(96,165,250,0.55)':c.region==='APAC'?'rgba(52,211,153,0.55)':'rgba(251,191,36,0.55)'),borderColor:top15c.map(c=>c.region==='Americas'?'#60a5fa':c.region==='APAC'?'#34d399':'#fbbf24'),borderWidth:1,borderRadius:3}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw.toLocaleString()+' MW'}}},scales:{x:{ticks:{color:'#475569',font:{size:7},callback:v=>(v/1000).toFixed(1)+'GW'},grid:{color:'rgba(51,65,85,0.15)'}},y:{ticks:{color:'#e2e8f0',font:{size:7}},grid:{display:false}}}}});

    // CapEx chart
    const capOps=DC_OPERATORS.filter(o=>o.capex>=5).sort((a,b)=>b.capex-a.capex);
    destroyChart('capex');
    benchCharts.capex=new Chart(document.getElementById('chartCapex'),{type:'bar',data:{labels:capOps.map(o=>o.company.split('(')[0].split('/')[0].trim().substring(0,14)),datasets:[{label:'CapEx ($B)',data:capOps.map(o=>o.capex),backgroundColor:capOps.map((_,i)=>`hsla(${40+i*18},70%,55%,0.6)`),borderColor:capOps.map((_,i)=>`hsla(${40+i*18},70%,55%,1)`),borderWidth:1,borderRadius:3}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>'$'+c.raw+'B'}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:7},maxRotation:45},grid:{display:false}},y:{ticks:{color:'#475569',font:{size:7},callback:v=>'$'+v+'B'},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // Growth rate chart
    const growthCountries=DC_COUNTRIES.filter(c=>c.growth>=10).sort((a,b)=>b.growth-a.growth).slice(0,12);
    destroyChart('growth');
    benchCharts.growth=new Chart(document.getElementById('chartGrowthRate'),{type:'bar',data:{labels:growthCountries.map(c=>c.country.substring(0,12)),datasets:[{label:'Growth %',data:growthCountries.map(c=>c.growth),backgroundColor:growthCountries.map(c=>c.growth>=18?'rgba(52,211,153,0.6)':c.growth>=14?'rgba(251,191,36,0.6)':'rgba(96,165,250,0.6)'),borderColor:growthCountries.map(c=>c.growth>=18?'#34d399':c.growth>=14?'#fbbf24':'#60a5fa'),borderWidth:1,borderRadius:3}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw+'% YoY'}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:7},maxRotation:45},grid:{display:false}},y:{ticks:{color:'#475569',font:{size:7},callback:v=>v+'%'},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // Type distribution doughnut
    const typeCounts={};
    DC_OPERATORS.forEach(o=>{const t=o.type.includes('Hyperscale')?'Hyperscale':o.type.includes('Colocation')?'Colocation':o.type.includes('Wholesale')?'Wholesale':o.type.includes('Edge')?'Edge':'Other';typeCounts[t]=(typeCounts[t]||0)+1});
    destroyChart('typeDistrib');
    benchCharts.typeDistrib=new Chart(document.getElementById('chartTypeDistrib'),{type:'doughnut',data:{labels:Object.keys(typeCounts),datasets:[{data:Object.values(typeCounts),backgroundColor:['#60a5fa','#a78bfa','#fbbf24','#34d399','#f87171'],borderColor:'#1e293b',borderWidth:2}]},options:{responsive:true,cutout:'50%',plugins:{legend:{position:'right',labels:{color:'#94a3b8',font:{size:9},padding:8,boxWidth:10,usePointStyle:true}}}}});

    // ═══ A1: Scatter — Capacity vs CapEx by Operator ═══
    const scatterData=DC_OPERATORS.filter(o=>o.capex>0).map(o=>{
        const t=o.type.includes('Hyperscale')?'Hyperscale':o.type.includes('Colocation')?'Colocation':o.type.includes('Wholesale')?'Wholesale':'Other';
        const colors={Hyperscale:'rgba(96,165,250,0.7)',Colocation:'rgba(167,139,250,0.7)',Wholesale:'rgba(251,191,36,0.7)',Other:'rgba(248,113,113,0.7)'};
        return {x:o.mw,y:o.capex,r:Math.max(3,Math.sqrt(o.facilities)*1.5),label:o.company.split('(')[0].trim(),color:colors[t],type:t};
    });
    const scatterDatasets={};
    scatterData.forEach(d=>{if(!scatterDatasets[d.type])scatterDatasets[d.type]=[];scatterDatasets[d.type].push(d)});
    destroyChart('scatterCapVsCapex');
    benchCharts.scatterCapVsCapex=new Chart(document.getElementById('chartScatterCapVsCapex'),{type:'bubble',data:{datasets:Object.entries(scatterDatasets).map(([type,pts])=>({label:type,data:pts.map(p=>({x:p.x,y:p.y,r:p.r,label:p.label})),backgroundColor:pts[0].color,borderColor:pts[0].color.replace('0.7','1'),borderWidth:1}))},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:8},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>{const d=c.raw;return d.label+': '+d.x.toLocaleString()+'MW, $'+(d.y>=1?d.y+'B':Math.round(d.y*1000)+'M')}}}},scales:{x:{title:{display:true,text:'Capacity (MW)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7},callback:v=>(v/1000).toFixed(0)+'GW'},grid:{color:'rgba(51,65,85,0.15)'}},y:{title:{display:true,text:'CapEx ($B)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7},callback:v=>'$'+v+'B'},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ A6: Radar — Regional Comparison ═══
    const regionStats={Americas:{mw:0,fac:0,count:0,growth:0,hyper:0,capex:0},EMEA:{mw:0,fac:0,count:0,growth:0,hyper:0,capex:0},APAC:{mw:0,fac:0,count:0,growth:0,hyper:0,capex:0}};
    DC_COUNTRIES.forEach(c=>{const r=regionStats[c.region];if(r){r.mw+=c.mw;r.fac+=c.facilities;r.count++;r.growth+=c.growth}});
    DC_OPERATORS.forEach(o=>{const reg=getHQRegion(o.hq);if(regionStats[reg]){if(o.type.includes('Hyperscale'))regionStats[reg].hyper++;regionStats[reg].capex+=o.capex}});
    const maxVals=[Math.max(...Object.values(regionStats).map(r=>r.mw)),Math.max(...Object.values(regionStats).map(r=>r.growth/r.count)),Math.max(...Object.values(regionStats).map(r=>r.fac)),Math.max(...Object.values(regionStats).map(r=>r.mw/r.fac)),Math.max(...Object.values(regionStats).map(r=>r.hyper)),Math.max(...Object.values(regionStats).map(r=>r.capex))];
    destroyChart('radarRegion');
    benchCharts.radarRegion=new Chart(document.getElementById('chartRadarRegion'),{type:'radar',data:{labels:['Total MW','Growth %','Facilities','Avg Size','Hyperscale','Investment'],datasets:[{label:'Americas',data:[regionStats.Americas.mw/maxVals[0]*100,(regionStats.Americas.growth/regionStats.Americas.count)/maxVals[1]*100,regionStats.Americas.fac/maxVals[2]*100,(regionStats.Americas.mw/regionStats.Americas.fac)/maxVals[3]*100,regionStats.Americas.hyper/maxVals[4]*100,regionStats.Americas.capex/maxVals[5]*100],borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.15)',pointBackgroundColor:'#60a5fa',borderWidth:2},{label:'EMEA',data:[regionStats.EMEA.mw/maxVals[0]*100,(regionStats.EMEA.growth/regionStats.EMEA.count)/maxVals[1]*100,regionStats.EMEA.fac/maxVals[2]*100,(regionStats.EMEA.mw/regionStats.EMEA.fac)/maxVals[3]*100,regionStats.EMEA.hyper/maxVals[4]*100,regionStats.EMEA.capex/maxVals[5]*100],borderColor:'#fbbf24',backgroundColor:'rgba(251,191,36,0.15)',pointBackgroundColor:'#fbbf24',borderWidth:2},{label:'APAC',data:[regionStats.APAC.mw/maxVals[0]*100,(regionStats.APAC.growth/regionStats.APAC.count)/maxVals[1]*100,regionStats.APAC.fac/maxVals[2]*100,(regionStats.APAC.mw/regionStats.APAC.fac)/maxVals[3]*100,regionStats.APAC.hyper/maxVals[4]*100,regionStats.APAC.capex/maxVals[5]*100],borderColor:'#34d399',backgroundColor:'rgba(52,211,153,0.15)',pointBackgroundColor:'#34d399',borderWidth:2}]},options:{responsive:true,scales:{r:{grid:{color:'rgba(51,65,85,0.3)'},angleLines:{color:'rgba(51,65,85,0.3)'},ticks:{display:false},pointLabels:{color:'#94a3b8',font:{size:8}}}},plugins:{legend:{labels:{color:'#94a3b8',font:{size:8},boxWidth:8,usePointStyle:true}}}}});

    // ═══ A3: Scatter — Country Capacity vs Growth Rate ═══
    const countryScatter=DC_COUNTRIES.map(c=>{
        const colors={Americas:'rgba(96,165,250,0.7)',EMEA:'rgba(251,191,36,0.7)',APAC:'rgba(52,211,153,0.7)'};
        return {x:c.mw,y:c.growth,r:Math.max(3,Math.sqrt(c.facilities)*0.5),label:c.country,color:colors[c.region],region:c.region};
    });
    const csDatasets={};
    countryScatter.forEach(d=>{if(!csDatasets[d.region])csDatasets[d.region]=[];csDatasets[d.region].push(d)});
    destroyChart('scatterCountryGrowth');
    benchCharts.scatterCountryGrowth=new Chart(document.getElementById('chartScatterCountryGrowth'),{type:'bubble',data:{datasets:Object.entries(csDatasets).map(([region,pts])=>({label:region,data:pts.map(p=>({x:p.x,y:p.y,r:p.r,label:p.label})),backgroundColor:pts[0].color,borderColor:pts[0].color.replace('0.7','1'),borderWidth:1}))},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:8},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>{const d=c.raw;return d.label+': '+(d.x>=1000?(d.x/1000).toFixed(1)+'GW':d.x+'MW')+', '+d.y+'% growth'}}}},scales:{x:{title:{display:true,text:'Capacity (MW)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7},callback:v=>(v>=1000?(v/1000).toFixed(0)+'GW':v+'MW')},grid:{color:'rgba(51,65,85,0.15)'}},y:{title:{display:true,text:'Growth Rate (%)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7},callback:v=>v+'%'},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ A7: Stacked Bar — Capacity by Type per Region ═══
    const regionTypeData={Americas:{Hyperscale:0,Colocation:0,Wholesale:0,Other:0},EMEA:{Hyperscale:0,Colocation:0,Wholesale:0,Other:0},APAC:{Hyperscale:0,Colocation:0,Wholesale:0,Other:0}};
    DC_OPERATORS.forEach(o=>{const reg=getHQRegion(o.hq);const t=o.type.includes('Hyperscale')?'Hyperscale':o.type.includes('Colocation')?'Colocation':o.type.includes('Wholesale')?'Wholesale':'Other';if(regionTypeData[reg])regionTypeData[reg][t]+=o.mw});
    destroyChart('stackedRegionType');
    benchCharts.stackedRegionType=new Chart(document.getElementById('chartStackedRegionType'),{type:'bar',data:{labels:['Americas','EMEA','APAC'],datasets:[{label:'Hyperscale',data:[regionTypeData.Americas.Hyperscale,regionTypeData.EMEA.Hyperscale,regionTypeData.APAC.Hyperscale],backgroundColor:'rgba(96,165,250,0.7)',borderRadius:2},{label:'Colocation',data:[regionTypeData.Americas.Colocation,regionTypeData.EMEA.Colocation,regionTypeData.APAC.Colocation],backgroundColor:'rgba(167,139,250,0.7)',borderRadius:2},{label:'Wholesale',data:[regionTypeData.Americas.Wholesale,regionTypeData.EMEA.Wholesale,regionTypeData.APAC.Wholesale],backgroundColor:'rgba(251,191,36,0.7)',borderRadius:2},{label:'Other',data:[regionTypeData.Americas.Other,regionTypeData.EMEA.Other,regionTypeData.APAC.Other],backgroundColor:'rgba(248,113,113,0.7)',borderRadius:2}]},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:8},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+(c.raw/1000).toFixed(1)+'GW'}}},scales:{x:{stacked:true,ticks:{color:'#94a3b8',font:{size:8}},grid:{display:false}},y:{stacked:true,ticks:{color:'#475569',font:{size:7},callback:v=>(v/1000).toFixed(0)+'GW'},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ A4: Scatter — City-Level Capacity Distribution ═══
    const cityData=[];
    DC_FACILITIES.forEach(f=>{cityData.push({x:f.lon,y:f.mw,label:f.city+' ('+f.company+')',city:f.city,country:f.country})});
    destroyChart('scatterCityCapacity');
    benchCharts.scatterCityCapacity=new Chart(document.getElementById('chartScatterCityCapacity'),{type:'scatter',data:{datasets:[{label:'Facilities',data:cityData.map(d=>({x:d.x,y:d.y,label:d.label})),backgroundColor:cityData.map(d=>d.y>=500?'rgba(248,113,113,0.7)':d.y>=200?'rgba(251,191,36,0.7)':d.y>=100?'rgba(96,165,250,0.7)':'rgba(52,211,153,0.7)'),borderColor:cityData.map(d=>d.y>=500?'#f87171':d.y>=200?'#fbbf24':d.y>=100?'#60a5fa':'#34d399'),borderWidth:1,pointRadius:cityData.map(d=>Math.max(3,Math.sqrt(d.y)*0.25))}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>{const d=c.raw;return d.label+': '+d.y+'MW'}}}},scales:{x:{title:{display:true,text:'Longitude',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}},y:{title:{display:true,text:'Capacity (MW)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ C8: Top 10 Cities by Capacity ═══
    const cityAgg={};
    DC_FACILITIES.forEach(f=>{cityAgg[f.city]=(cityAgg[f.city]||0)+f.mw});
    const topCities=Object.entries(cityAgg).sort((a,b)=>b[1]-a[1]).slice(0,10);
    destroyChart('topCities');
    benchCharts.topCities=new Chart(document.getElementById('chartTopCities'),{type:'bar',data:{labels:topCities.map(c=>c[0]),datasets:[{label:'Total MW',data:topCities.map(c=>c[1]),backgroundColor:topCities.map((_,i)=>`hsla(${200+i*15},65%,55%,0.6)`),borderColor:topCities.map((_,i)=>`hsla(${200+i*15},65%,55%,1)`),borderWidth:1,borderRadius:3}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw.toLocaleString()+' MW'}}},scales:{x:{ticks:{color:'#475569',font:{size:7},callback:v=>v>=1000?(v/1000).toFixed(1)+'GW':v+'MW'},grid:{color:'rgba(51,65,85,0.15)'}},y:{ticks:{color:'#e2e8f0',font:{size:7}},grid:{display:false}}}}});
}

function renderBenchOpCharts(){
    // ═══ A5: Bubble — Operator Market Position ═══
    const top25=DC_OPERATORS.filter(o=>o.capex>0).slice(0,25);
    destroyChart('bubbleOperator');
    benchCharts.bubbleOperator=new Chart(document.getElementById('chartBubbleOperator'),{type:'bubble',data:{datasets:[{label:'Operators',data:top25.map(o=>({x:o.mw,y:o.countries,r:Math.max(3,Math.sqrt(o.capex)*3),label:o.company.split('(')[0].trim(),capex:o.capex})),backgroundColor:top25.map(o=>o.type.includes('Hyperscale')?'rgba(96,165,250,0.6)':o.type.includes('Colocation')?'rgba(167,139,250,0.6)':'rgba(251,191,36,0.6)'),borderColor:top25.map(o=>o.type.includes('Hyperscale')?'#60a5fa':o.type.includes('Colocation')?'#a78bfa':'#fbbf24'),borderWidth:1}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>{const d=c.raw;return d.label+': '+d.x.toLocaleString()+'MW, '+d.y+' countries, $'+(d.capex>=1?d.capex+'B':Math.round(d.capex*1000)+'M')+' CapEx'}}}},scales:{x:{title:{display:true,text:'Capacity (MW)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7},callback:v=>(v/1000).toFixed(0)+'GW'},grid:{color:'rgba(51,65,85,0.15)'}},y:{title:{display:true,text:'Country Reach',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ C9: Diversification Score ═══
    const maxCountries=Math.max(...DC_OPERATORS.map(o=>o.countries));
    const divOps=DC_OPERATORS.filter(o=>o.countries>=3).sort((a,b)=>(b.countries/maxCountries)-(a.countries/maxCountries)).slice(0,15);
    destroyChart('diversification');
    benchCharts.diversification=new Chart(document.getElementById('chartDiversification'),{type:'bar',data:{labels:divOps.map(o=>o.company.split('(')[0].split('/')[0].trim().substring(0,16)),datasets:[{label:'Score',data:divOps.map(o=>Math.round(o.countries/maxCountries*100)),backgroundColor:divOps.map(o=>o.countries>=20?'rgba(52,211,153,0.6)':o.countries>=10?'rgba(96,165,250,0.6)':'rgba(251,191,36,0.6)'),borderColor:divOps.map(o=>o.countries>=20?'#34d399':o.countries>=10?'#60a5fa':'#fbbf24'),borderWidth:1,borderRadius:3}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw+'% ('+divOps[c.dataIndex].countries+' countries)'}}},scales:{x:{ticks:{color:'#475569',font:{size:7},callback:v=>v+'%'},grid:{color:'rgba(51,65,85,0.15)'},max:100},y:{ticks:{color:'#e2e8f0',font:{size:7}},grid:{display:false}}}}});
}

function filterBenchOps(){
    const type=document.getElementById('benchOpType').value;
    const region=document.getElementById('benchOpRegion').value;
    const search=document.getElementById('benchOpSearch').value.toLowerCase();
    let data=[...DC_OPERATORS];
    renderBenchOpCharts();
    if(type!=='all') data=data.filter(o=>o.type.includes(type));
    if(region!=='all') data=data.filter(o=>getHQRegion(o.hq)===region);
    if(search) data=data.filter(o=>o.company.toLowerCase().includes(search)||o.hq.toLowerCase().includes(search));
    // Sort
    data.sort((a,b)=>{
        let va=a[benchOpSort.col],vb=b[benchOpSort.col];
        if(typeof va==='string') va=va.toLowerCase();
        if(typeof vb==='string') vb=vb.toLowerCase();
        return benchOpSort.dir==='asc'?(va>vb?1:-1):(va<vb?1:-1);
    });
    document.getElementById('benchOpCount').textContent=data.length+' operators';
    // Paginate
    const totalPages=Math.ceil(data.length/benchOpPerPage);
    if(benchOpPage>totalPages) benchOpPage=1;
    const start=(benchOpPage-1)*benchOpPerPage;
    const pageData=data.slice(start,start+benchOpPerPage);
    const maxMW=Math.max(...DC_OPERATORS.map(o=>o.mw));
    const sortIcon=(col)=>`<span class="sort-icon">${benchOpSort.col===col?(benchOpSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9650;'}</span>`;
    const sortCls=(col)=>benchOpSort.col===col?' sorted':'';
    document.getElementById('benchOpTable').innerHTML=`<table class="bench-table"><thead><tr>
        <th class="${sortCls('rank')}" onclick="sortBenchOps('rank')">#${sortIcon('rank')}</th>
        <th class="${sortCls('company')}" onclick="sortBenchOps('company')">Operator${sortIcon('company')}</th>
        <th>Type</th>
        <th class="${sortCls('mw')}" onclick="sortBenchOps('mw')">Capacity${sortIcon('mw')}</th>
        <th class="${sortCls('facilities')}" onclick="sortBenchOps('facilities')">Sites${sortIcon('facilities')}</th>
        <th class="${sortCls('countries')}" onclick="sortBenchOps('countries')">Countries${sortIcon('countries')}</th>
        <th class="${sortCls('capex')}" onclick="sortBenchOps('capex')">CapEx '25${sortIcon('capex')}</th>
        <th class="${sortCls('marketCap')}" onclick="sortBenchOps('marketCap')">Mkt Cap${sortIcon('marketCap')}</th>
        <th class="${sortCls('pue')}" onclick="sortBenchOps('pue')">PUE${sortIcon('pue')}</th>
        <th>MW/Site</th>
        <th>$/MW</th>
        <th>Renew%</th>
        <th>Key Markets</th>
    </tr></thead><tbody>
        ${pageData.map(o=>{
            const pct=Math.round(o.mw/maxMW*100);
            const typeCls=o.type.includes('Hyperscale')?'hyperscale':o.type.includes('Colocation')?'colocation':o.type.includes('Wholesale')?'wholesale':o.type.includes('Edge')?'edge':'enterprise';
            const regionCls=getHQRegion(o.hq).toLowerCase();
            const mwPerSite=o.facilities>0?(o.mw/o.facilities).toFixed(1):'—';
            const dollarPerMW=o.capex>0&&o.mw>0?'$'+(o.capex*1000/o.mw).toFixed(1)+'M':'—';
            const pueCls=o.pue<=1.2?'color:#34d399':o.pue<=1.4?'color:#fbbf24':'color:#f87171';
            const renewCls=o.renewablePercent>=80?'color:#34d399':o.renewablePercent>=50?'color:#fbbf24':'color:#f87171';
            return `<tr onclick="showOperatorModal(${o.rank})" style="cursor:pointer">
                <td style="color:#64748b;font-size:0.7rem">${o.rank}</td>
                <td><div style="font-weight:600;color:#f1f5f9;font-size:0.78rem">${o.company}</div><div style="font-size:0.62rem;color:#64748b"><span class="bench-region ${regionCls}">${getHQRegion(o.hq)}</span> ${o.hq} · Est. ${o.founded}</div></td>
                <td><span class="bench-type ${typeCls}">${o.type.split('/')[0].trim()}</span></td>
                <td><div class="cap-bar"><span class="cap-bar-val">${o.mw>=1000?(o.mw/1000).toFixed(1)+'GW':o.mw+'MW'}</span><div class="cap-bar-track"><div class="cap-bar-fill" style="width:${pct}%"></div></div></div></td>
                <td>${o.facilities}</td>
                <td>${o.countries}</td>
                <td>${o.capex>=1?'$'+o.capex+'B':o.capex>0?'$'+Math.round(o.capex*1000)+'M':'—'}</td>
                <td style="font-size:0.72rem;color:#60a5fa;font-weight:600">${o.marketCap>=1000?'$'+(o.marketCap/1000).toFixed(1)+'T':o.marketCap>=1?'$'+o.marketCap+'B':o.marketCap>0?'$'+Math.round(o.marketCap*1000)+'M':'—'}</td>
                <td style="${pueCls};font-weight:600;font-size:0.72rem">${o.pue}</td>
                <td style="font-size:0.72rem;color:#94a3b8">${mwPerSite}</td>
                <td style="font-size:0.72rem;color:#94a3b8">${dollarPerMW}</td>
                <td style="${renewCls};font-weight:600;font-size:0.72rem">${o.renewablePercent}%</td>
                <td style="font-size:0.68rem;color:#94a3b8;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${o.keyMarkets.join(', ')}">${o.keyMarkets.slice(0,3).join(', ')}</td>
            </tr>`;
        }).join('')}
    </tbody></table>`;
    // Pagination
    let pagHtml=`<div class="bench-page-info">Showing ${start+1}-${Math.min(start+benchOpPerPage,data.length)} of ${data.length}</div><div class="bench-page-btns">`;
    pagHtml+=`<button class="bench-page-btn" onclick="benchOpPage=1;filterBenchOps()" ${benchOpPage===1?'disabled':''}>&laquo;</button>`;
    pagHtml+=`<button class="bench-page-btn" onclick="benchOpPage--;filterBenchOps()" ${benchOpPage===1?'disabled':''}>&lsaquo;</button>`;
    for(let i=1;i<=totalPages;i++){
        if(totalPages<=7||Math.abs(i-benchOpPage)<=2||i===1||i===totalPages){
            pagHtml+=`<button class="bench-page-btn ${i===benchOpPage?'active':''}" onclick="benchOpPage=${i};filterBenchOps()">${i}</button>`;
        }else if(i===benchOpPage-3||i===benchOpPage+3) pagHtml+=`<span style="color:#64748b;font-size:0.7rem;padding:0 4px">…</span>`;
    }
    pagHtml+=`<button class="bench-page-btn" onclick="benchOpPage++;filterBenchOps()" ${benchOpPage>=totalPages?'disabled':''}>&rsaquo;</button>`;
    pagHtml+=`<button class="bench-page-btn" onclick="benchOpPage=${totalPages};filterBenchOps()" ${benchOpPage>=totalPages?'disabled':''}>&raquo;</button></div>`;
    document.getElementById('benchOpPagination').innerHTML=pagHtml;
}

function sortBenchOps(col){
    if(benchOpSort.col===col) benchOpSort.dir=benchOpSort.dir==='asc'?'desc':'asc';
    else{benchOpSort.col=col;benchOpSort.dir=col==='company'?'asc':'desc'}
    benchOpPage=1;filterBenchOps();
}

let benchCountrySort={col:'mw',dir:'desc'};
function sortBenchCountries(col){
    if(benchCountrySort.col===col) benchCountrySort.dir=benchCountrySort.dir==='asc'?'desc':'asc';
    else{benchCountrySort.col=col;benchCountrySort.dir=col==='country'?'asc':'desc'}
    filterBenchCountries();
}
function filterBenchCountries(){
    const region=document.getElementById('benchCountryRegion').value;
    const growth=document.getElementById('benchCountryGrowth').value;
    const search=document.getElementById('benchCountrySearch').value.toLowerCase();
    let data=[...DC_COUNTRIES];
    if(region!=='all') data=data.filter(c=>c.region===region);
    if(growth==='high') data=data.filter(c=>c.growth>15);
    else if(growth==='medium') data=data.filter(c=>c.growth>=8&&c.growth<=15);
    else if(growth==='low') data=data.filter(c=>c.growth<8);
    if(search) data=data.filter(c=>c.country.toLowerCase().includes(search));
    data.sort((a,b)=>{
        let va=a[benchCountrySort.col],vb=b[benchCountrySort.col];
        if(typeof va==='string'){va=va.toLowerCase();vb=vb.toLowerCase()}
        return benchCountrySort.dir==='asc'?(va>vb?1:-1):(va<vb?1:-1);
    });
    const maxMW=Math.max(...DC_COUNTRIES.map(c=>c.mw));
    document.getElementById('benchCountryCount').textContent=data.length+' countries';
    // C3: HHI — Geographic Concentration Index
    const totalCountryMW2=DC_COUNTRIES.reduce((s,c)=>s+c.mw,0);
    const hhi=Math.round(DC_COUNTRIES.reduce((s,c)=>s+Math.pow(c.mw/totalCountryMW2*100,2),0));
    document.getElementById('benchCountryTable').innerHTML=`
    <div style="display:flex;gap:1rem;margin-bottom:0.75rem;flex-wrap:wrap">
        <div style="background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:8px 14px;font-size:0.72rem"><span style="color:#64748b">HHI Index:</span> <span style="color:${hhi>2500?'#f87171':hhi>1500?'#fbbf24':'#34d399'};font-weight:700">${hhi}</span> <span style="color:#475569">(${hhi>2500?'Highly Concentrated':hhi>1500?'Moderate':'Competitive'})</span></div>
        <div style="background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:8px 14px;font-size:0.72rem"><span style="color:#64748b">Avg Power Cost:</span> <span style="color:#e2e8f0;font-weight:700">$${(DC_COUNTRIES.reduce((s,c)=>s+c.powerCostPerKWh,0)/DC_COUNTRIES.length).toFixed(3)}/kWh</span></div>
        <div style="background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:8px 14px;font-size:0.72rem"><span style="color:#64748b">Avg PUE:</span> <span style="color:#e2e8f0;font-weight:700">${(DC_COUNTRIES.reduce((s,c)=>s+c.avgPUE,0)/DC_COUNTRIES.length).toFixed(2)}</span></div>
    </div>
    <table class="bench-table"><thead><tr>
        <th onclick="sortBenchCountries('rank')" style="cursor:pointer">#</th><th onclick="sortBenchCountries('country')" style="cursor:pointer">Country</th><th>Region</th><th onclick="sortBenchCountries('mw')" style="cursor:pointer">Capacity</th><th onclick="sortBenchCountries('facilities')" style="cursor:pointer">Facilities</th><th onclick="sortBenchCountries('growth')" style="cursor:pointer">Growth YoY</th><th>2030 Est.</th><th onclick="sortBenchCountries('powerCostPerKWh')" style="cursor:pointer">$/kWh</th><th onclick="sortBenchCountries('avgPUE')" style="cursor:pointer">PUE</th><th onclick="sortBenchCountries('waterStress')" style="cursor:pointer">Water</th><th onclick="sortBenchCountries('fiberConnectivity')" style="cursor:pointer">Fiber</th><th>Key Cities</th>
    </tr></thead><tbody>
        ${data.map((c,i)=>{
            const pct=Math.round(c.mw/maxMW*100);
            const regionCls=c.region.toLowerCase();
            const growthCls=c.growth>=15?'growth-up':c.growth>=8?'growth-neutral':'growth-down';
            const proj2030=Math.round(c.mw*Math.pow(1+c.growth/100,5));
            const waterCls=c.waterStress>=3.5?'color:#f87171':c.waterStress>=2?'color:#fbbf24':'color:#34d399';
            const fiberCls=c.fiberConnectivity>=8?'color:#34d399':c.fiberConnectivity>=6?'color:#fbbf24':'color:#f87171';
            return `<tr onclick="showCountryPanel('${c.country}')" style="cursor:pointer">
                <td style="color:#64748b;font-size:0.7rem">${i+1}</td>
                <td style="font-weight:600;color:#f1f5f9">${c.country}</td>
                <td><span class="bench-region ${regionCls}">${c.region}</span></td>
                <td><div class="cap-bar"><span class="cap-bar-val">${c.mw>=1000?(c.mw/1000).toFixed(1)+'GW':c.mw+'MW'}</span><div class="cap-bar-track"><div class="cap-bar-fill" style="width:${pct}%"></div></div></div></td>
                <td>${c.facilities.toLocaleString()}</td>
                <td><span class="${growthCls}">${c.growth>=0?'+':''}${c.growth}%</span></td>
                <td style="font-size:0.72rem;color:#a78bfa;font-weight:600">${proj2030>=1000?(proj2030/1000).toFixed(1)+'GW':proj2030+'MW'}</td>
                <td style="font-size:0.72rem;color:#94a3b8">$${c.powerCostPerKWh.toFixed(3)}</td>
                <td style="font-size:0.72rem;color:${c.avgPUE<=1.3?'#34d399':c.avgPUE<=1.45?'#fbbf24':'#f87171'};font-weight:600">${c.avgPUE}</td>
                <td style="font-size:0.72rem;${waterCls};font-weight:600">${c.waterStress.toFixed(1)}</td>
                <td style="font-size:0.72rem;${fiberCls};font-weight:600">${c.fiberConnectivity.toFixed(1)}</td>
                <td style="font-size:0.68rem;color:#94a3b8;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${c.keyCities.join(', ')}">${c.keyCities.slice(0,2).join(', ')}</td>
            </tr>`;
        }).join('')}
    </tbody></table>`;
}

function renderBenchFacCharts(){
    // ═══ A2: Scatter — Facility MW vs Year Built ═══
    const facScatter=DC_FACILITIES.map(f=>{
        const colors={'United States':'rgba(96,165,250,0.7)','China':'rgba(248,113,113,0.7)','Australia':'rgba(52,211,153,0.7)','United Kingdom':'rgba(251,191,36,0.7)'};
        return {x:f.year,y:f.mw,label:f.name,color:colors[f.country]||'rgba(167,139,250,0.7)'};
    });
    destroyChart('scatterFacYear');
    benchCharts.scatterFacYear=new Chart(document.getElementById('chartScatterFacYear'),{type:'scatter',data:{datasets:[{label:'Facilities',data:facScatter.map(d=>({x:d.x,y:d.y,label:d.label})),backgroundColor:facScatter.map(d=>d.color),borderColor:facScatter.map(d=>d.color.replace('0.7','1')),borderWidth:1,pointRadius:facScatter.map(d=>Math.max(3,Math.sqrt(d.y)*0.2))}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>{const d=c.raw;return d.label+': '+d.y+'MW ('+d.x+')'}}}},scales:{x:{title:{display:true,text:'Year Built',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'},min:1998,max:2027},y:{title:{display:true,text:'Capacity (MW)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ C6: Facility Size Distribution Histogram ═══
    const bins=[{label:'<50MW',min:0,max:50},{label:'50-100',min:50,max:100},{label:'100-200',min:100,max:200},{label:'200-500',min:200,max:500},{label:'500-1000',min:500,max:1000},{label:'1000+',min:1000,max:Infinity}];
    const binCounts=bins.map(b=>DC_FACILITIES.filter(f=>f.mw>=b.min&&f.mw<b.max).length);
    destroyChart('facHistogram');
    benchCharts.facHistogram=new Chart(document.getElementById('chartFacHistogram'),{type:'bar',data:{labels:bins.map(b=>b.label),datasets:[{label:'Facilities',data:binCounts,backgroundColor:['rgba(52,211,153,0.6)','rgba(96,165,250,0.6)','rgba(167,139,250,0.6)','rgba(251,191,36,0.6)','rgba(248,113,113,0.6)','rgba(244,63,94,0.6)'],borderColor:['#34d399','#60a5fa','#a78bfa','#fbbf24','#f87171','#f43f5e'],borderWidth:1,borderRadius:3}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw+' facilities'}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:8}},grid:{display:false}},y:{ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ C7: Commissioning Timeline ═══
    const yearCounts={};
    DC_FACILITIES.forEach(f=>{yearCounts[f.year]=(yearCounts[f.year]||0)+1});
    const years=Object.keys(yearCounts).sort();
    destroyChart('commissionTimeline');
    benchCharts.commissionTimeline=new Chart(document.getElementById('chartCommissionTimeline'),{type:'bar',data:{labels:years,datasets:[{label:'Commissioned',data:years.map(y=>yearCounts[y]),backgroundColor:years.map(y=>y>=2025?'rgba(52,211,153,0.6)':y>=2020?'rgba(96,165,250,0.6)':'rgba(167,139,250,0.6)'),borderColor:years.map(y=>y>=2025?'#34d399':y>=2020?'#60a5fa':'#a78bfa'),borderWidth:1,borderRadius:3}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw+' facilities'}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:7}},grid:{display:false}},y:{ticks:{color:'#475569',font:{size:7},stepSize:1},grid:{color:'rgba(51,65,85,0.15)'}}}}});
}

function filterBenchFacilities(){
    renderBenchFacCharts();
    const size=document.getElementById('benchFacSize').value;
    const country=document.getElementById('benchFacCountry').value;
    const year=document.getElementById('benchFacYear').value;
    let data=[...DC_FACILITIES];
    if(size==='mega') data=data.filter(f=>f.mw>=500);
    else if(size==='large') data=data.filter(f=>f.mw>=200&&f.mw<500);
    else if(size==='medium') data=data.filter(f=>f.mw>=100&&f.mw<200);
    else if(size==='standard') data=data.filter(f=>f.mw<100);
    if(country!=='all') data=data.filter(f=>f.country===country);
    if(year==='2026') data=data.filter(f=>f.year===2026);
    else if(year==='2025') data=data.filter(f=>f.year===2025);
    else if(year==='2024') data=data.filter(f=>f.year===2024);
    else if(year==='pre2024') data=data.filter(f=>f.year<2024);
    data.sort((a,b)=>b.mw-a.mw);
    const maxMW=Math.max(...DC_FACILITIES.map(f=>f.mw));
    document.getElementById('benchFacCount').textContent=data.length+' facilities';
    document.getElementById('benchFacTable').innerHTML=`<table class="bench-table"><thead><tr>
        <th>#</th><th>Facility</th><th>Company</th><th>Location</th><th>Capacity</th><th>Area</th><th>W/sqft</th><th>Type</th><th>Year</th><th>Notes</th>
    </tr></thead><tbody>
        ${data.map((f,i)=>{
            const pct=Math.round(f.mw/maxMW*100);
            const wPerSqft=f.sqft>0?(f.mw*1000000/f.sqft).toFixed(0):'—';
            const isNew=f.year>=2025;
            return `<tr>
                <td style="color:#64748b;font-size:0.7rem">${i+1}</td>
                <td style="font-weight:600;color:#f1f5f9;font-size:0.78rem">${f.name}${isNew?' <span style="background:rgba(52,211,153,0.2);color:#34d399;font-size:0.55rem;padding:1px 5px;border-radius:3px;font-weight:700;vertical-align:middle">NEW</span>':''}</td>
                <td style="font-size:0.75rem">${f.company}</td>
                <td style="font-size:0.72rem">${f.city}, ${f.country}</td>
                <td><div class="cap-bar"><span class="cap-bar-val">${f.mw>=1000?(f.mw/1000).toFixed(1)+'GW':f.mw+'MW'}</span><div class="cap-bar-track"><div class="cap-bar-fill" style="width:${pct}%"></div></div></div></td>
                <td style="font-size:0.72rem;color:#94a3b8">${f.sqft>=1000000?(f.sqft/1000000).toFixed(1)+'M':f.sqft>=1000?Math.round(f.sqft/1000)+'K':f.sqft} sqft</td>
                <td style="font-size:0.72rem;color:${parseInt(wPerSqft)>500?'#34d399':parseInt(wPerSqft)>200?'#fbbf24':'#94a3b8'};font-weight:600">${wPerSqft}</td>
                <td><span class="bench-type ${f.type.includes('Hyperscale')?'hyperscale':f.type.includes('Colo')?'colocation':f.type.includes('Gov')?'government':'wholesale'}">${f.type.split('/')[0]}</span></td>
                <td style="font-size:0.72rem">${f.year}</td>
                <td style="font-size:0.65rem;color:#94a3b8;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${f.notes}">${f.notes}</td>
            </tr>`;
        }).join('')}
    </tbody></table>`;
}

function renderBenchMarket(){
    // Market KPIs
    document.getElementById('benchMarketKpis').innerHTML=[
        {label:'Global Installed',val:DC_SUMMARY.totalInstalledGW+' GW',sub:'Synergy Q1 2025',cls:'purple',icon:'fa-globe'},
        {label:'Live IT Load (est.)',val:(DC_SUMMARY.liveITMW/1000).toFixed(0)+' GW',sub:'Mid-2025 estimate',cls:'blue',icon:'fa-microchip'},
        {label:'Projected 2026',val:(DC_SUMMARY.projected2026MW/1000).toFixed(1)+' GW',sub:'JLL 2026 Outlook',cls:'green',icon:'fa-chart-line'},
        {label:'Projected 2030',val:DC_SUMMARY.projected2030GW+' GW',sub:'100GW to add',cls:'amber',icon:'fa-rocket'},
        {label:'Hyperscale DCs',val:DC_SUMMARY.hyperscaleDCs.toLocaleString(),sub:DC_SUMMARY.pipelineFacilities+' in pipeline',cls:'cyan',icon:'fa-cloud'},
        {label:'Investment to 2030',val:'$'+DC_SUMMARY.investmentRequired2030T+'T',sub:'Real estate + IT infra',cls:'red',icon:'fa-dollar-sign'}
    ].map(k=>`<div class="bench-card ${k.cls}"><div class="bench-label"><i class="fas ${k.icon}" style="margin-right:4px"></i>${k.label}</div><div class="bench-val">${k.val}</div><div class="bench-sub">${k.sub}</div></div>`).join('');

    // Hyperscale info
    document.getElementById('benchHyperscaleInfo').innerHTML=`
        <div style="display:grid;gap:8px">
            ${[
                {l:'Total Hyperscale DCs',v:DC_SUMMARY.hyperscaleDCs.toLocaleString()},
                {l:'Share of Global Capacity',v:Math.round(DC_SUMMARY.hyperscaleShare*100)+'%'},
                {l:'Top 3 (AWS+MSFT+GOOG) Share',v:Math.round(DC_SUMMARY.top3share*100)+'%'},
                {l:'Q3 2025 CapEx',v:'$'+DC_SUMMARY.hyperscaleCapexQ3+'B'},
                {l:'Pipeline Facilities',v:DC_SUMMARY.pipelineFacilities},
                {l:'Capacity Doubling Period',v:'~3 years'}
            ].map(r=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(51,65,85,0.3)"><span style="font-size:0.75rem;color:#94a3b8">${r.l}</span><span style="font-size:0.75rem;color:#e2e8f0;font-weight:600">${r.v}</span></div>`).join('')}
        </div>`;

    // Investment info
    document.getElementById('benchInvestmentInfo').innerHTML=`
        <div style="display:grid;gap:8px">
            ${[
                {l:'Total Required by 2030',v:'$3.0 Trillion'},
                {l:'Real Estate Asset Creation',v:'$1.2 Trillion'},
                {l:'Tenant IT Infra Spend',v:'$1-2 Trillion'},
                {l:'Top 4 CapEx 2025',v:'$370B'},
                {l:'Projected All CapEx 2026',v:'$600B+'},
                {l:'Data Source',v:'JLL 2026 Outlook'}
            ].map(r=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(51,65,85,0.3)"><span style="font-size:0.75rem;color:#94a3b8">${r.l}</span><span style="font-size:0.75rem;color:#e2e8f0;font-weight:600">${r.v}</span></div>`).join('')}
        </div>`;

    // Regional breakdown
    document.getElementById('benchRegionalInfo').innerHTML=[
        {title:'Americas',icon:'fa-flag-usa',color:'#60a5fa',items:[
            {l:'Share of Global',v:Math.round(DC_SUMMARY.americas.share*100)+'%'},
            {l:'Supply CAGR',v:Math.round(DC_SUMMARY.americas.supplyCAGR*100)+'%'},
            {l:'Construction Pipeline',v:DC_SUMMARY.americas.constructionGW+'GW'}
        ]},
        {title:'APAC',icon:'fa-globe-asia',color:'#34d399',items:[
            {l:'Current Capacity',v:DC_SUMMARY.apac.capacityGW+'GW'},
            {l:'Projected 2030',v:DC_SUMMARY.apac.projected2030GW+'GW'},
            {l:'India CAGR',v:Math.round(DC_SUMMARY.apac.indiaCAGR*100)+'%'}
        ]},
        {title:'EMEA',icon:'fa-globe-europe',color:'#fbbf24',items:[
            {l:'Operational',v:DC_SUMMARY.emea.operationalGW+'GW'},
            {l:'YoY Growth',v:Math.round(DC_SUMMARY.emea.yoyGrowth*100)+'%'},
            {l:'Pipeline',v:DC_SUMMARY.emea.pipelineGW+'GW'}
        ]}
    ].map(r=>`<div style="background:#0f172a;border:1px solid #1f2937;border-radius:10px;padding:1rem">
        <div style="font-size:0.82rem;font-weight:700;color:${r.color};margin-bottom:0.6rem"><i class="fas ${r.icon}" style="margin-right:4px"></i>${r.title}</div>
        ${r.items.map(i=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(51,65,85,0.2)"><span style="font-size:0.72rem;color:#94a3b8">${i.l}</span><span style="font-size:0.72rem;color:#e2e8f0;font-weight:600">${i.v}</span></div>`).join('')}
    </div>`).join('');

    // ═══ A8: Projected Capacity Timeline ═══
    const timelineYears=['2020','2021','2022','2023','2024','2025','2026','2027','2028','2029','2030'];
    const baseGW=50;
    const growthRate=0.15;
    const actualData=[50,58,67,78,90,DC_SUMMARY.totalInstalledGW,DC_SUMMARY.projected2026MW/1000];
    const projectedData=[null,null,null,null,null,null,DC_SUMMARY.projected2026MW/1000];
    for(let i=7;i<11;i++){const prev=projectedData[i-1]||actualData[i-1];projectedData.push(Math.round(prev*(1+growthRate)))}
    destroyChart('capacityTimeline');
    benchCharts.capacityTimeline=new Chart(document.getElementById('chartCapacityTimeline'),{type:'line',data:{labels:timelineYears,datasets:[{label:'Actual',data:actualData.concat(Array(4).fill(null)),borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.1)',fill:true,tension:0.3,borderWidth:2,pointRadius:3,pointBackgroundColor:'#60a5fa'},{label:'Projected',data:projectedData,borderColor:'#a78bfa',backgroundColor:'rgba(167,139,250,0.1)',fill:true,borderDash:[5,3],tension:0.3,borderWidth:2,pointRadius:3,pointBackgroundColor:'#a78bfa'}]},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:8},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.raw?c.dataset.label+': '+c.raw.toFixed(1)+' GW':''}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}},y:{title:{display:true,text:'Capacity (GW)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7},callback:v=>v+'GW'},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ C10: Investment Gap Analysis ═══
    const investYears=['2024','2025','2026','2027','2028','2029','2030'];
    const actualCapex=[250,370,450,null,null,null,null];
    const requiredCapex=[280,350,480,550,620,700,800];
    destroyChart('investmentGap');
    benchCharts.investmentGap=new Chart(document.getElementById('chartInvestmentGap'),{type:'bar',data:{labels:investYears,datasets:[{label:'Actual CapEx',data:actualCapex,backgroundColor:'rgba(96,165,250,0.6)',borderColor:'#60a5fa',borderWidth:1,borderRadius:3},{label:'Required CapEx',data:requiredCapex,backgroundColor:'rgba(248,113,113,0.3)',borderColor:'#f87171',borderWidth:1,borderRadius:3,borderDash:[3,3]}]},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:8},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.raw?c.dataset.label+': $'+c.raw+'B':''}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:7}},grid:{display:false}},y:{title:{display:true,text:'Investment ($B)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7},callback:v=>'$'+v+'B'},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // Constraints
    document.getElementById('benchConstraints').innerHTML=DC_SUMMARY.constraints.map(c=>
        `<div style="display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid rgba(51,65,85,0.2)"><i class="fas fa-exclamation-circle" style="color:#f87171;font-size:0.65rem;margin-top:3px"></i><span style="font-size:0.75rem;color:#cbd5e1">${c}</span></div>`
    ).join('');

    // Sources with data freshness (E5)
    document.getElementById('benchSources').innerHTML=`
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><i class="fas fa-clock" style="color:#34d399;font-size:0.6rem"></i><span style="font-size:0.7rem;color:#34d399;font-weight:600">Data last verified: Feb 2026</span></div>
        <strong>Sources:</strong> ${DC_SUMMARY.sources.join(' · ')}<br>
        <em style="color:#475569">Compiled 2026-02-17. MW figures represent IT load capacity unless noted. Country totals include colocation, hyperscale, and enterprise DCs.</em><br>
        <em style="color:#475569">PUE and renewable% are operator-reported estimates. Water stress uses WRI Aqueduct scale (0-5). Fiber connectivity scored 1-10 based on submarine cable density and IX presence.</em>`;
}

function exportBenchmarksCSV(){
    const tab=document.querySelector('.bench-tab.active').textContent.trim();
    let csv='';
    if(tab.includes('Operators')){
        csv='Rank,Company,HQ,Type,Capacity_MW,Facilities,Countries,CapEx_2025_B,Source\n';
        DC_OPERATORS.forEach(o=>csv+=`${o.rank},"${o.company}",${o.hq},"${o.type}",${o.mw},${o.facilities},${o.countries},${o.capex},"${o.source}"\n`);
    }else if(tab.includes('Countries')){
        csv='Rank,Country,Region,Capacity_MW,Facilities,Growth_YoY,Source\n';
        DC_COUNTRIES.forEach(c=>csv+=`${c.rank},${c.country},${c.region},${c.mw},${c.facilities},${c.growth},"${c.source}"\n`);
    }else if(tab.includes('Facilities')){
        csv='Rank,Name,Company,City,Country,Capacity_MW,Type,Year,Notes\n';
        DC_FACILITIES.forEach(f=>csv+=`${f.rank},"${f.name}","${f.company}",${f.city},${f.country},${f.mw},"${f.type}",${f.year},"${f.notes}"\n`);
    }else{
        csv='Rank,Company,HQ,Type,Capacity_MW,Facilities,Countries,CapEx_2025_B\n';
        DC_OPERATORS.forEach(o=>csv+=`${o.rank},"${o.company}",${o.hq},"${o.type}",${o.mw},${o.facilities},${o.countries},${o.capex}\n`);
    }
    downloadCSV(csv,'rz_dc_intelligence_'+fmtDate(new Date())+'.csv');
}

// ═══ D2: Operator Detail Modal ═══
function showOperatorModal(rank){
    const o=DC_OPERATORS.find(op=>op.rank===rank);
    if(!o)return;
    const mwPerSite=o.facilities>0?(o.mw/o.facilities).toFixed(1):'—';
    const dollarPerMW=o.capex>0&&o.mw>0?'$'+(o.capex*1000/o.mw).toFixed(1)+'M':'—';
    const divScore=Math.round(o.countries/Math.max(...DC_OPERATORS.map(x=>x.countries))*100);
    const opFacilities=DC_FACILITIES.filter(f=>f.company.toLowerCase().includes(o.company.split('(')[0].split('/')[0].trim().split(' ')[0].toLowerCase()));
    const isBookmarked=JSON.parse(localStorage.getItem('dc_bookmarks')||'[]').includes(o.rank);
    document.getElementById('dcOperatorModalContent').innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem">
            <div>
                <h3 style="font-size:1.1rem;font-weight:800;color:#f1f5f9;margin-bottom:4px">${o.company}</h3>
                <div style="font-size:0.75rem;color:#64748b">${o.hq} · Est. ${o.founded} · <span class="bench-type ${o.type.includes('Hyperscale')?'hyperscale':'colocation'}">${o.type}</span></div>
            </div>
            <button onclick="toggleDcBookmark(${o.rank})" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:${isBookmarked?'#fbbf24':'#475569'}" title="Bookmark"><i class="fas fa-star"></i></button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.6rem;margin-bottom:1.25rem">
            ${[{l:'Capacity',v:o.mw>=1000?(o.mw/1000).toFixed(1)+' GW':o.mw+' MW',c:'purple'},{l:'Mkt Cap',v:o.marketCap>=1000?'$'+(o.marketCap/1000).toFixed(1)+'T':o.marketCap>=1?'$'+o.marketCap+'B':o.marketCap>0?'$'+Math.round(o.marketCap*1000)+'M':'N/A',c:'blue'},{l:'Sites',v:o.facilities,c:'blue'},{l:'Countries',v:o.countries,c:'green'},{l:'CapEx',v:o.capex>=1?'$'+o.capex+'B':'$'+Math.round(o.capex*1000)+'M',c:'amber'},{l:'PUE',v:o.pue,c:o.pue<=1.2?'green':o.pue<=1.4?'amber':'red'},{l:'Renewable',v:o.renewablePercent+'%',c:o.renewablePercent>=80?'green':o.renewablePercent>=50?'amber':'red'},{l:'MW/Site',v:mwPerSite,c:'cyan'},{l:'$/MW',v:dollarPerMW,c:'purple'}].map(k=>`<div class="bench-card ${k.c}" style="padding:8px 10px"><div class="bench-label" style="font-size:0.55rem">${k.l}</div><div class="bench-val" style="font-size:1rem">${k.v}</div></div>`).join('')}
        </div>
        <div class="m-section"><h4><i class="fas fa-map-marker-alt"></i> Key Markets</h4>
            <div style="display:flex;flex-wrap:wrap;gap:4px">${o.keyMarkets.map(m=>'<span style="background:rgba(139,92,246,0.12);color:#a78bfa;padding:3px 10px;border-radius:12px;font-size:0.7rem;font-weight:600">'+m+'</span>').join('')}</div>
        </div>
        <div class="m-section"><h4><i class="fas fa-chart-bar"></i> Diversification Score</h4>
            <div style="background:#0f172a;border-radius:6px;height:12px;overflow:hidden"><div style="height:100%;width:${divScore}%;background:linear-gradient(90deg,#8b5cf6,#a78bfa);border-radius:6px"></div></div>
            <div style="font-size:0.68rem;color:#64748b;margin-top:4px">${divScore}% geographic diversification (${o.countries} of ${Math.max(...DC_OPERATORS.map(x=>x.countries))} max countries)</div>
        </div>
        ${opFacilities.length>0?`<div class="m-section"><h4><i class="fas fa-server"></i> Known Facilities (${opFacilities.length})</h4>
            <table class="bench-table"><thead><tr><th>Facility</th><th>Location</th><th>MW</th><th>Year</th></tr></thead><tbody>
            ${opFacilities.map(f=>`<tr><td style="font-weight:600;font-size:0.75rem">${f.name}</td><td style="font-size:0.72rem">${f.city}, ${f.country}</td><td style="font-weight:600">${f.mw>=1000?(f.mw/1000).toFixed(1)+'GW':f.mw+'MW'}</td><td>${f.year}</td></tr>`).join('')}
            </tbody></table></div>`:''}
        <div style="font-size:0.65rem;color:#475569;margin-top:1rem">Source: ${o.source} · Employees est: ${o.employees>0?o.employees.toLocaleString():'N/A'}</div>`;
    document.getElementById('dcOperatorModal').classList.add('show');
}

// ═══ D3: Country Deep-Dive Panel ═══
function showCountryPanel(countryName){
    const c=DC_COUNTRIES.find(x=>x.country===countryName);
    if(!c)return;
    const countryOps=DC_OPERATORS.filter(o=>o.keyMarkets.some(m=>c.keyCities.some(kc=>m.toLowerCase().includes(kc.split(' ')[0].toLowerCase())))||o.hq===c.country);
    const countryFacs=DC_FACILITIES.filter(f=>f.country===c.country);
    const proj2030=Math.round(c.mw*Math.pow(1+c.growth/100,5));
    document.getElementById('dcCountryPanelContent').innerHTML=`
        <h3 style="font-size:1.1rem;font-weight:800;color:#f1f5f9;margin-bottom:4px">${c.country}</h3>
        <div style="font-size:0.75rem;color:#64748b;margin-bottom:1.25rem"><span class="bench-region ${c.region.toLowerCase()}">${c.region}</span> · Rank #${c.rank}</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.6rem;margin-bottom:1.25rem">
            ${[{l:'Capacity',v:c.mw>=1000?(c.mw/1000).toFixed(1)+' GW':c.mw+' MW',c:'purple'},{l:'Facilities',v:c.facilities.toLocaleString(),c:'blue'},{l:'Growth',v:'+'+c.growth+'%',c:'green'},{l:'2030 Est.',v:proj2030>=1000?(proj2030/1000).toFixed(1)+' GW':proj2030+' MW',c:'amber'},{l:'Power Cost',v:'$'+c.powerCostPerKWh.toFixed(3)+'/kWh',c:'cyan'},{l:'Avg PUE',v:c.avgPUE.toFixed(2),c:c.avgPUE<=1.3?'green':c.avgPUE<=1.45?'amber':'red'},{l:'Water Stress',v:c.waterStress.toFixed(1)+'/5',c:c.waterStress>=3.5?'red':c.waterStress>=2?'amber':'green'},{l:'Fiber Score',v:c.fiberConnectivity.toFixed(1)+'/10',c:c.fiberConnectivity>=8?'green':'amber'}].map(k=>`<div class="bench-card ${k.c}" style="padding:8px 10px"><div class="bench-label" style="font-size:0.55rem">${k.l}</div><div class="bench-val" style="font-size:1rem">${k.v}</div></div>`).join('')}
        </div>
        <div class="m-section"><h4><i class="fas fa-city"></i> Key Cities</h4>
            <div style="display:flex;flex-wrap:wrap;gap:4px">${c.keyCities.map(m=>'<span style="background:rgba(52,211,153,0.12);color:#34d399;padding:3px 10px;border-radius:12px;font-size:0.7rem;font-weight:600">'+m+'</span>').join('')}</div>
        </div>
        ${countryOps.length>0?`<div class="m-section"><h4><i class="fas fa-building"></i> Operators Present (${countryOps.length})</h4>
            <div style="display:flex;flex-wrap:wrap;gap:4px">${countryOps.slice(0,15).map(o=>'<span style="background:rgba(96,165,250,0.12);color:#60a5fa;padding:3px 10px;border-radius:12px;font-size:0.7rem;font-weight:500">'+o.company.split('(')[0].trim()+'</span>').join('')}</div></div>`:''}
        ${countryFacs.length>0?`<div class="m-section"><h4><i class="fas fa-server"></i> Tracked Facilities (${countryFacs.length})</h4>
            <table class="bench-table"><thead><tr><th>Facility</th><th>Company</th><th>City</th><th>MW</th><th>Year</th></tr></thead><tbody>
            ${countryFacs.map(f=>`<tr><td style="font-weight:600;font-size:0.75rem">${f.name}</td><td>${f.company}</td><td>${f.city}</td><td style="font-weight:600">${f.mw}MW</td><td>${f.year}</td></tr>`).join('')}
            </tbody></table></div>`:''}
        <div style="font-size:0.65rem;color:#475569;margin-top:1rem">Source: ${c.source}</div>`;
    document.getElementById('dcCountryPanel').classList.add('show');
}

// ═══ D4: Comparison Mode ═══
let dcCompareList=[];
function openDcCompareMode(){
    dcCompareList=[];
    let html=`<h3 style="font-size:1rem;font-weight:800;color:#f1f5f9;margin-bottom:1rem"><i class="fas fa-columns" style="margin-right:6px"></i> Compare Operators</h3>
        <p style="font-size:0.75rem;color:#64748b;margin-bottom:1rem">Select 2-5 operators to compare side-by-side</p>
        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:1rem" id="dcCompareCheckboxes">
            ${DC_OPERATORS.slice(0,30).map(o=>`<label style="display:inline-flex;align-items:center;gap:4px;background:#0f172a;border:1px solid #1f2937;border-radius:6px;padding:4px 10px;font-size:0.72rem;color:#e2e8f0;cursor:pointer"><input type="checkbox" value="${o.rank}" onchange="dcCompareToggle(${o.rank})" style="accent-color:#8b5cf6">${o.company.split('(')[0].split('/')[0].trim().substring(0,20)}</label>`).join('')}
        </div>
        <button class="btn btn-purple btn-sm" onclick="dcRunComparison()"><i class="fas fa-chart-bar"></i> Compare Selected</button>
        <div id="dcCompareResult" style="margin-top:1rem"></div>`;
    document.getElementById('dcCompareContent').innerHTML=html;
    document.getElementById('dcCompareModal').classList.add('show');
}
function dcCompareToggle(rank){
    const idx=dcCompareList.indexOf(rank);
    if(idx>=0)dcCompareList.splice(idx,1);else if(dcCompareList.length<5)dcCompareList.push(rank);
    else{event.target.checked=false}
}
function dcRunComparison(){
    if(dcCompareList.length<2){document.getElementById('dcCompareResult').innerHTML='<p style="color:#f87171;font-size:0.75rem">Select at least 2 operators</p>';return}
    const ops=dcCompareList.map(r=>DC_OPERATORS.find(o=>o.rank===r)).filter(Boolean);
    const maxMW=Math.max(...ops.map(o=>o.mw));
    const maxCap=Math.max(...ops.map(o=>o.capex));
    const maxFac=Math.max(...ops.map(o=>o.facilities));
    const maxCountries=Math.max(...ops.map(o=>o.countries));
    let html=`<table class="bench-table"><thead><tr><th>Metric</th>${ops.map(o=>'<th style="text-align:center">'+o.company.split('(')[0].trim().substring(0,14)+'</th>').join('')}</tr></thead><tbody>
        <tr><td>Capacity</td>${ops.map(o=>'<td style="text-align:center;font-weight:600">'+(o.mw>=1000?(o.mw/1000).toFixed(1)+'GW':o.mw+'MW')+'</td>').join('')}</tr>
        <tr><td>Facilities</td>${ops.map(o=>'<td style="text-align:center">'+o.facilities+'</td>').join('')}</tr>
        <tr><td>Countries</td>${ops.map(o=>'<td style="text-align:center">'+o.countries+'</td>').join('')}</tr>
        <tr><td>CapEx 2025</td>${ops.map(o=>'<td style="text-align:center">'+(o.capex>=1?'$'+o.capex+'B':'$'+Math.round(o.capex*1000)+'M')+'</td>').join('')}</tr>
        <tr><td>Market Cap</td>${ops.map(o=>'<td style="text-align:center;color:#60a5fa;font-weight:600">'+(o.marketCap>=1000?'$'+(o.marketCap/1000).toFixed(1)+'T':o.marketCap>=1?'$'+o.marketCap+'B':o.marketCap>0?'$'+Math.round(o.marketCap*1000)+'M':'—')+'</td>').join('')}</tr>
        <tr><td>PUE</td>${ops.map(o=>'<td style="text-align:center;color:'+(o.pue<=1.2?'#34d399':o.pue<=1.4?'#fbbf24':'#f87171')+'">'+o.pue+'</td>').join('')}</tr>
        <tr><td>Renewable %</td>${ops.map(o=>'<td style="text-align:center;color:'+(o.renewablePercent>=80?'#34d399':o.renewablePercent>=50?'#fbbf24':'#f87171')+'">'+o.renewablePercent+'%</td>').join('')}</tr>
        <tr><td>MW/Site</td>${ops.map(o=>'<td style="text-align:center">'+(o.facilities>0?(o.mw/o.facilities).toFixed(1):'—')+'</td>').join('')}</tr>
        <tr><td>$/MW</td>${ops.map(o=>'<td style="text-align:center">'+(o.capex>0?'$'+(o.capex*1000/o.mw).toFixed(1)+'M':'—')+'</td>').join('')}</tr>
        <tr><td>Founded</td>${ops.map(o=>'<td style="text-align:center">'+o.founded+'</td>').join('')}</tr>
        <tr><td>Type</td>${ops.map(o=>'<td style="text-align:center"><span class="bench-type '+(o.type.includes('Hyperscale')?'hyperscale':'colocation')+'">'+o.type.split('/')[0].trim()+'</span></td>').join('')}</tr>
    </tbody></table>
    <div style="margin-top:1rem"><canvas id="chartCompareRadar" height="200"></canvas></div>`;
    document.getElementById('dcCompareResult').innerHTML=html;
    // Radar comparison chart
    destroyChart('compareRadar');
    const colors=['#60a5fa','#a78bfa','#34d399','#fbbf24','#f87171'];
    benchCharts.compareRadar=new Chart(document.getElementById('chartCompareRadar'),{type:'radar',data:{labels:['Capacity','Sites','Countries','CapEx','PUE (inv)','Renewable%'],datasets:ops.map((o,i)=>({label:o.company.split('(')[0].trim().substring(0,14),data:[o.mw/maxMW*100,o.facilities/maxFac*100,o.countries/maxCountries*100,o.capex/maxCap*100,(2-o.pue)*100,o.renewablePercent],borderColor:colors[i],backgroundColor:colors[i].replace(')',',0.1)').replace('rgb','rgba'),pointBackgroundColor:colors[i],borderWidth:2}))},options:{responsive:true,scales:{r:{grid:{color:'rgba(51,65,85,0.3)'},angleLines:{color:'rgba(51,65,85,0.3)'},ticks:{display:false},pointLabels:{color:'#94a3b8',font:{size:8}}}},plugins:{legend:{labels:{color:'#94a3b8',font:{size:8},boxWidth:8,usePointStyle:true}}}}});
}

// ═══ D6: Global Search ═══
function dcGlobalSearchFilter(q){
    if(!q||q.length<2){return}
    q=q.toLowerCase();
    const matchedOps=DC_OPERATORS.filter(o=>o.company.toLowerCase().includes(q)||o.hq.toLowerCase().includes(q)||o.type.toLowerCase().includes(q));
    const matchedCountries=DC_COUNTRIES.filter(c=>c.country.toLowerCase().includes(q)||c.region.toLowerCase().includes(q));
    const matchedFacs=DC_FACILITIES.filter(f=>f.name.toLowerCase().includes(q)||f.company.toLowerCase().includes(q)||f.city.toLowerCase().includes(q)||f.country.toLowerCase().includes(q));
    if(matchedOps.length>0&&matchedCountries.length===0&&matchedFacs.length===0){showBenchTab('operators');document.getElementById('benchOpSearch').value=q;filterBenchOps()}
    else if(matchedCountries.length>0&&matchedOps.length===0&&matchedFacs.length===0){showBenchTab('countries');document.getElementById('benchCountrySearch').value=q;filterBenchCountries()}
    else if(matchedFacs.length>0&&matchedOps.length===0&&matchedCountries.length===0){showBenchTab('facilities')}
}

// ═══ D9: Bookmarks ═══
function toggleDcBookmark(rank){
    let bm=JSON.parse(localStorage.getItem('dc_bookmarks')||'[]');
    const idx=bm.indexOf(rank);
    if(idx>=0)bm.splice(idx,1);else bm.push(rank);
    localStorage.setItem('dc_bookmarks',JSON.stringify(bm));
    showOperatorModal(rank);
}

// ═══ E2: Export JSON ═══
function exportBenchJSON(){
    const data={operators:DC_OPERATORS,countries:DC_COUNTRIES,facilities:DC_FACILITIES,summary:DC_SUMMARY,exportedAt:new Date().toISOString()};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='rz_dc_intelligence_'+fmtDate(new Date())+'.json';a.click();URL.revokeObjectURL(a.href);
}

// ═══ E1: Export Chart as PNG ═══
function exportChartPNG(chartKey){
    const chart=benchCharts[chartKey];
    if(!chart)return;
    const a=document.createElement('a');a.href=chart.toBase64Image();a.download='rz_chart_'+chartKey+'_'+fmtDate(new Date())+'.png';a.click();
}

// ═══ F1: Fullscreen Chart Mode ═══
function openChartFullscreen(chartKey){
    const srcChart=benchCharts[chartKey];
    if(!srcChart)return;
    destroyChart('fullscreen');
    document.getElementById('dcChartFullscreen').classList.add('show');
    setTimeout(()=>{
        benchCharts.fullscreen=new Chart(document.getElementById('chartFullscreenCanvas'),{type:srcChart.config.type,data:JSON.parse(JSON.stringify(srcChart.config.data)),options:{...JSON.parse(JSON.stringify(srcChart.config.options)),responsive:true,maintainAspectRatio:false}});
    },100);
}

// ═══ E6: Per-tab CSV Export (enhanced) ═══
function exportTabCSV(tabName){
    let csv='';
    if(tabName==='operators'){
        csv='Rank,Company,HQ,Type,Capacity_MW,Facilities,Countries,CapEx_B,MarketCap_B,PUE,Renewable%,Founded,Employees,MW_Per_Site,Dollar_Per_MW,Source\n';
        DC_OPERATORS.forEach(o=>{const mps=o.facilities>0?(o.mw/o.facilities).toFixed(1):'';const dpm=o.capex>0?(o.capex*1000/o.mw).toFixed(1):'';csv+=`${o.rank},"${o.company}","${o.hq}","${o.type}",${o.mw},${o.facilities},${o.countries},${o.capex},${o.marketCap||0},${o.pue},${o.renewablePercent},${o.founded},${o.employees},${mps},${dpm},"${o.source}"\n`});
    }else if(tabName==='countries'){
        csv='Rank,Country,Region,Capacity_MW,Facilities,Growth_YoY,PowerCost_kWh,AvgPUE,WaterStress,FiberScore,Source\n';
        DC_COUNTRIES.forEach(c=>csv+=`${c.rank},"${c.country}","${c.region}",${c.mw},${c.facilities},${c.growth},${c.powerCostPerKWh},${c.avgPUE},${c.waterStress},${c.fiberConnectivity},"${c.source}"\n`);
    }else if(tabName==='facilities'){
        csv='Rank,Name,Company,City,Country,Capacity_MW,SqFt,Type,Year,Lat,Lon,Notes\n';
        DC_FACILITIES.forEach(f=>csv+=`${f.rank},"${f.name}","${f.company}","${f.city}","${f.country}",${f.mw},${f.sqft},"${f.type}",${f.year},${f.lat},${f.lon},"${f.notes}"\n`);
    }
    if(csv)downloadCSV(csv,'rz_dc_'+tabName+'_'+fmtDate(new Date())+'.csv');
}

// ═══════════════════════════════════════════════════════════════
// PROJECTION ANALYTICS — AI/Cloud Demand vs DC Supply
// ═══════════════════════════════════════════════════════════════

// AI/Cloud Provider demand profiles
const AI_PROVIDERS=[
    {name:'Microsoft (Azure/OpenAI)',short:'MSFT',type:'Hyperscale',currentGW:7.0,capex2025:95,growthRate:0.35,infraMix:{hyperscale:0.55,colo:0.30,edge:0.10,wholesale:0.05},regions:{Americas:0.45,EMEA:0.28,APAC:0.27},aiShare:0.45,color:'#60a5fa'},
    {name:'Google (GCP/DeepMind)',short:'GOOG',type:'Hyperscale',currentGW:5.5,capex2025:75,growthRate:0.32,infraMix:{hyperscale:0.65,colo:0.20,edge:0.10,wholesale:0.05},regions:{Americas:0.40,EMEA:0.30,APAC:0.30},aiShare:0.50,color:'#34d399'},
    {name:'Amazon (AWS/Anthropic)',short:'AWS',type:'Hyperscale',currentGW:7.5,capex2025:105,growthRate:0.30,infraMix:{hyperscale:0.60,colo:0.25,edge:0.10,wholesale:0.05},regions:{Americas:0.48,EMEA:0.25,APAC:0.27},aiShare:0.40,color:'#fbbf24'},
    {name:'Meta (Llama/FAIR)',short:'META',type:'Hyperscale',currentGW:4.5,capex2025:72,growthRate:0.40,infraMix:{hyperscale:0.85,colo:0.05,edge:0.05,wholesale:0.05},regions:{Americas:0.60,EMEA:0.20,APAC:0.20},aiShare:0.55,color:'#a78bfa'},
    {name:'Oracle (OCI/Stargate)',short:'ORCL',type:'Hyperscale',currentGW:2.2,capex2025:25,growthRate:0.45,infraMix:{hyperscale:0.50,colo:0.30,edge:0.15,wholesale:0.05},regions:{Americas:0.50,EMEA:0.25,APAC:0.25},aiShare:0.60,color:'#f87171'},
    {name:'OpenAI (via MSFT/OCI)',short:'OAI',type:'AI-Native',currentGW:1.8,capex2025:18,growthRate:0.65,infraMix:{hyperscale:0.70,colo:0.20,edge:0.05,wholesale:0.05},regions:{Americas:0.55,EMEA:0.20,APAC:0.25},aiShare:1.00,color:'#22d3ee'},
    {name:'Anthropic (via AWS/GCP)',short:'ANTH',type:'AI-Native',currentGW:0.6,capex2025:8,growthRate:0.80,infraMix:{hyperscale:0.50,colo:0.35,edge:0.10,wholesale:0.05},regions:{Americas:0.55,EMEA:0.25,APAC:0.20},aiShare:1.00,color:'#c084fc'},
    {name:'xAI (Grok)',short:'XAI',type:'AI-Native',currentGW:0.8,capex2025:10,growthRate:0.90,infraMix:{hyperscale:0.80,colo:0.10,edge:0.05,wholesale:0.05},regions:{Americas:0.70,EMEA:0.15,APAC:0.15},aiShare:1.00,color:'#fb923c'},
    {name:'Alibaba Cloud',short:'BABA',type:'Hyperscale',currentGW:2.8,capex2025:23,growthRate:0.22,infraMix:{hyperscale:0.60,colo:0.25,edge:0.10,wholesale:0.05},regions:{Americas:0.05,EMEA:0.05,APAC:0.90},aiShare:0.35,color:'#f472b6'},
    {name:'Tencent Cloud',short:'TCNT',type:'Hyperscale',currentGW:1.8,capex2025:15,growthRate:0.20,infraMix:{hyperscale:0.55,colo:0.30,edge:0.10,wholesale:0.05},regions:{Americas:0.05,EMEA:0.05,APAC:0.90},aiShare:0.30,color:'#4ade80'},
    {name:'ByteDance (Volcano)',short:'BYTE',type:'AI-Native',currentGW:1.2,capex2025:14,growthRate:0.50,infraMix:{hyperscale:0.65,colo:0.20,edge:0.10,wholesale:0.05},regions:{Americas:0.10,EMEA:0.05,APAC:0.85},aiShare:0.70,color:'#818cf8'}
];

// Interpolation: compound growth with constraint dampening
function interpolateGrowth(baseGW,rate,years,constraintFactor){
    constraintFactor=constraintFactor||0.92;
    const result=[];
    let v=baseGW;
    for(let i=0;i<years;i++){
        const dampened=rate*Math.pow(constraintFactor,i);
        v=v*(1+dampened);
        result.push(parseFloat(v.toFixed(2)));
    }
    return result;
}

// DC Supply projection per region (from existing data)
function projectRegionalSupply(){
    const regions={
        Americas:{current:DC_SUMMARY.americas.share*DC_SUMMARY.totalInstalledGW,cagr:DC_SUMMARY.americas.supplyCAGR,pipeline:DC_SUMMARY.americas.constructionGW,constraint:0.90},
        EMEA:{current:DC_SUMMARY.emea.operationalGW,cagr:DC_SUMMARY.emea.yoyGrowth,pipeline:DC_SUMMARY.emea.pipelineGW,constraint:0.85},
        APAC:{current:DC_SUMMARY.apac.capacityGW,cagr:DC_SUMMARY.apac.growthCAGR,pipeline:0,constraint:0.88}
    };
    const result={};
    Object.entries(regions).forEach(([r,d])=>{
        const proj=interpolateGrowth(d.current,d.cagr,6,d.constraint);
        proj[0]=d.current*(1+d.cagr);
        if(d.pipeline>0)proj[1]+=d.pipeline*0.3;
        result[r]={current:d.current,projections:proj};
    });
    return result;
}

// AI/Cloud demand projection per region
function projectRegionalDemand(){
    const regions={Americas:0,EMEA:0,APAC:0};
    const result={};
    Object.keys(regions).forEach(r=>{
        let totalCurrent=0;
        AI_PROVIDERS.forEach(p=>{totalCurrent+=p.currentGW*(p.regions[r]||0)});
        const avgGrowth=AI_PROVIDERS.reduce((s,p)=>s+p.growthRate*(p.regions[r]||0)*p.currentGW,0)/Math.max(totalCurrent,0.1);
        const proj=interpolateGrowth(totalCurrent,avgGrowth,6,0.88);
        result[r]={current:totalCurrent,projections:proj,avgGrowth:avgGrowth};
    });
    return result;
}

let projRendered=false;
function renderProjectionAnalytics(){
    if(projRendered)return;
    projRendered=true;

    const supply=projectRegionalSupply();
    const demand=projectRegionalDemand();
    const years=['2025','2026','2027','2028','2029','2030'];

    // Total demand and supply
    const totalDemand2030=Object.values(demand).reduce((s,d)=>s+d.projections[5],0);
    const totalSupply2030=Object.values(supply).reduce((s,d)=>s+d.projections[5],0);
    const totalGap=totalDemand2030-totalSupply2030;
    const aiOnlyDemand2030=AI_PROVIDERS.filter(p=>p.aiShare>=0.9).reduce((s,p)=>{const proj=interpolateGrowth(p.currentGW,p.growthRate,6,0.88);return s+proj[5]},0);
    const hyperscaleSupplyShare=0.44;

    // Infra type demand aggregation
    const infraDemand2030={hyperscale:0,colo:0,edge:0,wholesale:0};
    AI_PROVIDERS.forEach(p=>{
        const proj=interpolateGrowth(p.currentGW,p.growthRate,6,0.88);
        const gw2030=proj[5];
        Object.entries(p.infraMix).forEach(([t,share])=>{infraDemand2030[t]+=gw2030*share});
    });

    // KPIs
    document.getElementById('projKpis').innerHTML=[
        {label:'Total AI/Cloud Demand 2030',val:totalDemand2030.toFixed(0)+' GW',sub:'All providers combined',cls:'purple',icon:'fa-brain'},
        {label:'Total DC Supply 2030',val:totalSupply2030.toFixed(0)+' GW',sub:'Interpolated from pipeline',cls:'blue',icon:'fa-server'},
        {label:'Projected Gap 2030',val:(totalGap>0?'+':'')+totalGap.toFixed(0)+' GW',sub:totalGap>0?'Demand exceeds supply':'Supply sufficient',cls:totalGap>0?'red':'green',icon:'fa-exclamation-triangle'},
        {label:'AI-Native Demand 2030',val:aiOnlyDemand2030.toFixed(1)+' GW',sub:'OpenAI + Anthropic + xAI + ByteDance',cls:'cyan',icon:'fa-robot'},
        {label:'Hyperscale Colo Gap',val:((infraDemand2030.hyperscale-totalSupply2030*hyperscaleSupplyShare)).toFixed(0)+' GW',sub:'Hyperscale demand vs supply share',cls:'amber',icon:'fa-warehouse'},
        {label:'Edge Deficit',val:infraDemand2030.edge.toFixed(1)+' GW needed',sub:'Edge severely under-built',cls:'red',icon:'fa-network-wired'}
    ].map(k=>`<div class="bench-card ${k.cls}"><div class="bench-label"><i class="fas ${k.icon}" style="margin-right:4px"></i>${k.label}</div><div class="bench-val">${k.val}</div><div class="bench-sub">${k.sub}</div></div>`).join('');

    // ═══ Chart 1: Regional Supply vs Demand (stacked area) ═══
    const regionColors={Americas:'#60a5fa',EMEA:'#fbbf24',APAC:'#34d399'};
    destroyChart('projRegionSupplyDemand');
    benchCharts.projRegionSupplyDemand=new Chart(document.getElementById('chartProjRegionSupplyDemand'),{type:'line',data:{labels:years,datasets:[
        ...Object.entries(supply).map(([r,d])=>({label:r+' Supply',data:d.projections.map(v=>parseFloat(v.toFixed(1))),borderColor:regionColors[r],backgroundColor:regionColors[r].replace(')',',0.08)').replace('#',`rgba(${parseInt(regionColors[r].slice(1,3),16)},${parseInt(regionColors[r].slice(3,5),16)},${parseInt(regionColors[r].slice(5,7),16)},0.08)`),fill:false,borderWidth:2,pointRadius:3,pointBackgroundColor:regionColors[r],tension:0.3})),
        ...Object.entries(demand).map(([r,d])=>({label:r+' Demand',data:d.projections.map(v=>parseFloat(v.toFixed(1))),borderColor:regionColors[r],borderDash:[5,3],fill:false,borderWidth:2,pointRadius:3,pointStyle:'triangle',pointBackgroundColor:regionColors[r],tension:0.3}))
    ]},options:{responsive:true,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#94a3b8',font:{size:7},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+c.raw+' GW'}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}},y:{title:{display:true,text:'GW',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ Chart 2: Gap Waterfall by Region ═══
    const gapData=Object.entries(supply).map(([r,s])=>{
        const d=demand[r];
        return {region:r,supply2030:s.projections[5],demand2030:d.projections[5],gap:d.projections[5]-s.projections[5]};
    });
    destroyChart('projGapWaterfall');
    benchCharts.projGapWaterfall=new Chart(document.getElementById('chartProjGapWaterfall'),{type:'bar',data:{labels:gapData.map(g=>g.region),datasets:[
        {label:'DC Supply 2030',data:gapData.map(g=>parseFloat(g.supply2030.toFixed(1))),backgroundColor:'rgba(96,165,250,0.5)',borderColor:'#60a5fa',borderWidth:1,borderRadius:3},
        {label:'AI/Cloud Demand 2030',data:gapData.map(g=>parseFloat(g.demand2030.toFixed(1))),backgroundColor:'rgba(248,113,113,0.5)',borderColor:'#f87171',borderWidth:1,borderRadius:3},
        {label:'Gap (Deficit)',data:gapData.map(g=>parseFloat(g.gap.toFixed(1))),backgroundColor:gapData.map(g=>g.gap>0?'rgba(248,113,113,0.3)':'rgba(52,211,153,0.3)'),borderColor:gapData.map(g=>g.gap>0?'#f87171':'#34d399'),borderWidth:1,borderRadius:3,borderDash:[3,3]}
    ]},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:7},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+c.raw+' GW'}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:8}},grid:{display:false}},y:{title:{display:true,text:'GW',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ Chart 3: Provider CapEx vs DC Infrastructure Buildout ═══
    const providerCapex=AI_PROVIDERS.filter(p=>p.capex2025>=8).sort((a,b)=>b.capex2025-a.capex2025);
    const dcBuilders=DC_OPERATORS.filter(o=>!o.type.includes('Hyperscale')||o.capex<10).filter(o=>o.capex>=1).sort((a,b)=>b.capex-a.capex).slice(0,8);
    destroyChart('projProviderVsInfra');
    benchCharts.projProviderVsInfra=new Chart(document.getElementById('chartProjProviderVsInfra'),{type:'bar',data:{
        labels:[...providerCapex.map(p=>p.short),'|',...dcBuilders.map(o=>o.company.split('(')[0].split('/')[0].trim().substring(0,10))],
        datasets:[{label:'AI/Cloud Provider CapEx ($B)',data:[...providerCapex.map(p=>p.capex2025),...Array(1+dcBuilders.length).fill(null)],backgroundColor:'rgba(167,139,250,0.6)',borderColor:'#a78bfa',borderWidth:1,borderRadius:3},
        {label:'DC Infrastructure CapEx ($B)',data:[...Array(providerCapex.length).fill(null),null,...dcBuilders.map(o=>o.capex)],backgroundColor:'rgba(52,211,153,0.6)',borderColor:'#34d399',borderWidth:1,borderRadius:3}]
    },options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:7},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.raw?c.dataset.label+': $'+c.raw+'B':''}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:7},maxRotation:45},grid:{display:false}},y:{title:{display:true,text:'CapEx ($B)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7},callback:v=>'$'+v+'B'},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ Chart 4: Provider Demand vs Infra Type Scatter ═══
    const provTypeData=AI_PROVIDERS.map(p=>{
        const proj=interpolateGrowth(p.currentGW,p.growthRate,6,0.88);
        const gw2030=proj[5];
        return {name:p.short,gw2030:gw2030,hyperscale:gw2030*p.infraMix.hyperscale,colo:gw2030*p.infraMix.colo,edge:gw2030*p.infraMix.edge,color:p.color,aiShare:p.aiShare};
    });
    destroyChart('projProviderTypeScatter');
    benchCharts.projProviderTypeScatter=new Chart(document.getElementById('chartProjProviderTypeScatter'),{type:'bubble',data:{datasets:[
        {label:'Hyperscale',data:provTypeData.map(d=>({x:d.gw2030,y:d.hyperscale,r:Math.max(4,Math.sqrt(d.hyperscale)*5),label:d.name})),backgroundColor:'rgba(96,165,250,0.5)',borderColor:'#60a5fa',borderWidth:1},
        {label:'Colocation',data:provTypeData.map(d=>({x:d.gw2030,y:d.colo,r:Math.max(3,Math.sqrt(d.colo)*5),label:d.name})),backgroundColor:'rgba(167,139,250,0.5)',borderColor:'#a78bfa',borderWidth:1},
        {label:'Edge',data:provTypeData.map(d=>({x:d.gw2030,y:d.edge,r:Math.max(2,Math.sqrt(d.edge)*5),label:d.name})),backgroundColor:'rgba(52,211,153,0.5)',borderColor:'#34d399',borderWidth:1}
    ]},options:{responsive:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:7},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>{const d=c.raw;return provTypeData[c.dataIndex].name+' — '+c.dataset.label+': '+d.y.toFixed(1)+' GW (of '+d.x.toFixed(1)+' total)'}}}},scales:{x:{title:{display:true,text:'Total Demand 2030 (GW)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}},y:{title:{display:true,text:'Type Allocation (GW)',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ Chart 5: Provider Demand Timeline ═══
    destroyChart('projProviderTimeline');
    benchCharts.projProviderTimeline=new Chart(document.getElementById('chartProjProviderTimeline'),{type:'line',data:{labels:['2024',...years],datasets:AI_PROVIDERS.filter(p=>p.currentGW>=0.6).map(p=>{
        const proj=interpolateGrowth(p.currentGW,p.growthRate,6,0.88);
        return {label:p.short,data:[p.currentGW,...proj.map(v=>parseFloat(v.toFixed(1)))],borderColor:p.color,backgroundColor:'transparent',borderWidth:2,pointRadius:2,pointBackgroundColor:p.color,tension:0.3};
    })},options:{responsive:true,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#94a3b8',font:{size:7},boxWidth:8,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+c.raw+' GW'}}},scales:{x:{ticks:{color:'#94a3b8',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}},y:{title:{display:true,text:'GW Demand',color:'#64748b',font:{size:8}},ticks:{color:'#475569',font:{size:7}},grid:{color:'rgba(51,65,85,0.15)'}}}}});

    // ═══ Chart 6: Infrastructure Type Radar — Supply vs Demand ═══
    const infraSupply2030={hyperscale:totalSupply2030*0.44,colo:totalSupply2030*0.30,edge:totalSupply2030*0.05,wholesale:totalSupply2030*0.21};
    const maxInfra=Math.max(...Object.values(infraDemand2030),...Object.values(infraSupply2030));
    destroyChart('projInfraTypeGap');
    benchCharts.projInfraTypeGap=new Chart(document.getElementById('chartProjInfraTypeGap'),{type:'radar',data:{labels:['Hyperscale','Colocation','Edge','Wholesale'],datasets:[
        {label:'Demand 2030',data:Object.values(infraDemand2030).map(v=>v/maxInfra*100),borderColor:'#f87171',backgroundColor:'rgba(248,113,113,0.15)',pointBackgroundColor:'#f87171',borderWidth:2},
        {label:'Supply 2030',data:Object.values(infraSupply2030).map(v=>v/maxInfra*100),borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.15)',pointBackgroundColor:'#60a5fa',borderWidth:2}
    ]},options:{responsive:true,scales:{r:{grid:{color:'rgba(51,65,85,0.3)'},angleLines:{color:'rgba(51,65,85,0.3)'},ticks:{display:false},pointLabels:{color:'#94a3b8',font:{size:9}}}},plugins:{legend:{labels:{color:'#94a3b8',font:{size:8},boxWidth:8,usePointStyle:true}}}}});

    // ═══ Provider Comparison Table ═══
    document.getElementById('projProviderTable').innerHTML=`<table class="bench-table"><thead><tr>
        <th>Provider</th><th>Type</th><th>Current GW</th><th>CapEx '25</th><th>Growth Rate</th><th>2030 Demand</th><th>AI Share</th>
        <th style="color:#60a5fa">Hyperscale</th><th style="color:#a78bfa">Colo</th><th style="color:#34d399">Edge</th><th style="color:#fbbf24">Wholesale</th>
        <th>Americas</th><th>EMEA</th><th>APAC</th>
    </tr></thead><tbody>
        ${AI_PROVIDERS.sort((a,b)=>{const pa=interpolateGrowth(a.currentGW,a.growthRate,6,0.88);const pb=interpolateGrowth(b.currentGW,b.growthRate,6,0.88);return pb[5]-pa[5]}).map(p=>{
            const proj=interpolateGrowth(p.currentGW,p.growthRate,6,0.88);
            const gw2030=proj[5];
            const typeCls=p.type==='AI-Native'?'edge':p.type==='Hyperscale'?'hyperscale':'colocation';
            const growthCls=p.growthRate>=0.5?'color:#f87171;font-weight:700':p.growthRate>=0.3?'color:#fbbf24;font-weight:600':'color:#34d399';
            return `<tr>
                <td><div style="display:flex;align-items:center;gap:6px"><div style="width:8px;height:8px;border-radius:50%;background:${p.color};flex-shrink:0"></div><span style="font-weight:600;color:#f1f5f9;font-size:0.75rem">${p.name}</span></div></td>
                <td><span class="bench-type ${typeCls}">${p.type}</span></td>
                <td style="font-weight:600">${p.currentGW} GW</td>
                <td>$${p.capex2025}B</td>
                <td style="${growthCls}">${Math.round(p.growthRate*100)}% CAGR</td>
                <td style="font-weight:700;color:#f1f5f9;font-size:0.82rem">${gw2030.toFixed(1)} GW</td>
                <td style="color:${p.aiShare>=0.9?'#f87171':p.aiShare>=0.5?'#fbbf24':'#94a3b8'};font-weight:600">${Math.round(p.aiShare*100)}%</td>
                <td style="font-size:0.72rem;color:#60a5fa">${(gw2030*p.infraMix.hyperscale).toFixed(1)}</td>
                <td style="font-size:0.72rem;color:#a78bfa">${(gw2030*p.infraMix.colo).toFixed(1)}</td>
                <td style="font-size:0.72rem;color:#34d399">${(gw2030*p.infraMix.edge).toFixed(1)}</td>
                <td style="font-size:0.72rem;color:#fbbf24">${(gw2030*p.infraMix.wholesale).toFixed(1)}</td>
                <td style="font-size:0.72rem">${Math.round(p.regions.Americas*100)}%</td>
                <td style="font-size:0.72rem">${Math.round(p.regions.EMEA*100)}%</td>
                <td style="font-size:0.72rem">${Math.round(p.regions.APAC*100)}%</td>
            </tr>`;
        }).join('')}
    </tbody></table>
    <div style="display:flex;gap:1rem;margin-top:0.75rem;flex-wrap:wrap">
        <div style="background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:8px 14px;font-size:0.72rem">
            <span style="color:#64748b">Hyperscale Demand 2030:</span> <span style="color:#60a5fa;font-weight:700">${infraDemand2030.hyperscale.toFixed(0)} GW</span>
            <span style="color:#475569;margin:0 4px">vs Supply:</span> <span style="color:${infraDemand2030.hyperscale>infraSupply2030.hyperscale?'#f87171':'#34d399'};font-weight:700">${infraSupply2030.hyperscale.toFixed(0)} GW</span>
            <span style="color:${infraDemand2030.hyperscale>infraSupply2030.hyperscale?'#f87171':'#34d399'};font-weight:600;margin-left:4px">(${infraDemand2030.hyperscale>infraSupply2030.hyperscale?'DEFICIT':'OK'}: ${Math.abs(infraDemand2030.hyperscale-infraSupply2030.hyperscale).toFixed(0)} GW)</span>
        </div>
        <div style="background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:8px 14px;font-size:0.72rem">
            <span style="color:#64748b">Colo Demand 2030:</span> <span style="color:#a78bfa;font-weight:700">${infraDemand2030.colo.toFixed(0)} GW</span>
            <span style="color:#475569;margin:0 4px">vs Supply:</span> <span style="color:${infraDemand2030.colo>infraSupply2030.colo?'#f87171':'#34d399'};font-weight:700">${infraSupply2030.colo.toFixed(0)} GW</span>
        </div>
        <div style="background:#0f172a;border:1px solid rgba(248,113,113,0.3);border-radius:8px;padding:8px 14px;font-size:0.72rem">
            <span style="color:#64748b">Edge Demand 2030:</span> <span style="color:#34d399;font-weight:700">${infraDemand2030.edge.toFixed(1)} GW</span>
            <span style="color:#475569;margin:0 4px">vs Supply:</span> <span style="color:#f87171;font-weight:700">${infraSupply2030.edge.toFixed(1)} GW</span>
            <span style="color:#f87171;font-weight:600;margin-left:4px">CRITICAL GAP</span>
        </div>
    </div>`;

    // ═══ Regional Projection Table ═══
    document.getElementById('projRegionTable').innerHTML=`<table class="bench-table"><thead><tr>
        <th>Region</th><th>Supply 2025</th><th>Supply 2028</th><th>Supply 2030</th><th>Demand 2025</th><th>Demand 2028</th><th>Demand 2030</th><th>Gap 2028</th><th>Gap 2030</th><th>Gap %</th>
    </tr></thead><tbody>
        ${Object.entries(supply).map(([r,s])=>{
            const d=demand[r];
            const gap2028=d.projections[3]-s.projections[3];
            const gap2030=d.projections[5]-s.projections[5];
            const gapPct=((gap2030/s.projections[5])*100).toFixed(0);
            return `<tr>
                <td><span class="bench-region ${r.toLowerCase()}" style="font-size:0.72rem;padding:3px 10px">${r}</span></td>
                <td style="font-weight:600">${s.projections[0].toFixed(1)} GW</td>
                <td>${s.projections[3].toFixed(1)} GW</td>
                <td style="font-weight:700;color:#60a5fa">${s.projections[5].toFixed(1)} GW</td>
                <td style="font-weight:600">${d.projections[0].toFixed(1)} GW</td>
                <td>${d.projections[3].toFixed(1)} GW</td>
                <td style="font-weight:700;color:#f87171">${d.projections[5].toFixed(1)} GW</td>
                <td style="color:${gap2028>0?'#f87171':'#34d399'};font-weight:600">${gap2028>0?'+':''}${gap2028.toFixed(1)} GW</td>
                <td style="color:${gap2030>0?'#f87171':'#34d399'};font-weight:700;font-size:0.82rem">${gap2030>0?'+':''}${gap2030.toFixed(1)} GW</td>
                <td style="color:${gap2030>0?'#f87171':'#34d399'};font-weight:700">${gap2030>0?'+':''}${gapPct}%</td>
            </tr>`;
        }).join('')}
        <tr style="border-top:2px solid #334155;font-weight:700">
            <td style="color:#f1f5f9">GLOBAL TOTAL</td>
            <td>${Object.values(supply).reduce((s,d)=>s+d.projections[0],0).toFixed(1)} GW</td>
            <td>${Object.values(supply).reduce((s,d)=>s+d.projections[3],0).toFixed(1)} GW</td>
            <td style="color:#60a5fa">${totalSupply2030.toFixed(1)} GW</td>
            <td>${Object.values(demand).reduce((s,d)=>s+d.projections[0],0).toFixed(1)} GW</td>
            <td>${Object.values(demand).reduce((s,d)=>s+d.projections[3],0).toFixed(1)} GW</td>
            <td style="color:#f87171">${totalDemand2030.toFixed(1)} GW</td>
            <td style="color:${Object.values(demand).reduce((s,d)=>s+d.projections[3],0)-Object.values(supply).reduce((s,d)=>s+d.projections[3],0)>0?'#f87171':'#34d399'}">${(Object.values(demand).reduce((s,d)=>s+d.projections[3],0)-Object.values(supply).reduce((s,d)=>s+d.projections[3],0)).toFixed(1)} GW</td>
            <td style="color:${totalGap>0?'#f87171':'#34d399'};font-size:0.85rem">${totalGap>0?'+':''}${totalGap.toFixed(1)} GW</td>
            <td style="color:${totalGap>0?'#f87171':'#34d399'}">${totalGap>0?'+':''}${((totalGap/totalSupply2030)*100).toFixed(0)}%</td>
        </tr>
    </tbody></table>`;

    // ═══ Key Insights ═══
    const fastestProvider=AI_PROVIDERS.reduce((a,b)=>a.growthRate>b.growthRate?a:b);
    const largestDemand=AI_PROVIDERS.reduce((a,b)=>{const pa=interpolateGrowth(a.currentGW,a.growthRate,6,0.88);const pb=interpolateGrowth(b.currentGW,b.growthRate,6,0.88);return pa[5]>pb[5]?a:b});
    const worstRegionGap=Object.entries(supply).reduce((worst,[r,s])=>{const gap=demand[r].projections[5]-s.projections[5];return gap>worst.gap?{region:r,gap}:worst},{region:'',gap:-Infinity});
    document.getElementById('projInsights').innerHTML=[
        {icon:'fa-fire',color:'#f87171',title:'Hyperscale Colo Imbalance',text:`Hyperscale colocation demand is projected at ${infraDemand2030.hyperscale.toFixed(0)} GW by 2030, but only ${infraSupply2030.hyperscale.toFixed(0)} GW of hyperscale-grade supply is projected. AI providers (OpenAI, Anthropic, xAI) are growing at 65-90% CAGR but infrastructure buildout at ~17% CAGR cannot keep pace. The compounding gap widens exponentially after 2027.`},
        {icon:'fa-bolt',color:'#fbbf24',title:'AI-Native Providers — Fastest Growth, Least Infrastructure',text:`AI-native providers (OpenAI, Anthropic, xAI, ByteDance) rely entirely on leased infrastructure but are growing 2-4x faster than hyperscalers who own their DCs. ${fastestProvider.name} at ${Math.round(fastestProvider.growthRate*100)}% CAGR is the fastest grower. This creates severe dependency on Colo/Wholesale capacity that is already constrained.`},
        {icon:'fa-globe-americas',color:'#60a5fa',title:'Regional Mismatch — '+worstRegionGap.region+' Most At-Risk',text:`${worstRegionGap.region} faces the largest absolute gap of ${worstRegionGap.gap.toFixed(1)} GW by 2030. Americas has massive hyperscale buildout (N. Virginia, Texas, Ohio) but AI demand is concentrating faster. EMEA faces grid constraints. APAC growth is bottlenecked by Singapore moratorium and India power infrastructure.`},
        {icon:'fa-network-wired',color:'#34d399',title:'Edge Computing — Critical Under-Investment',text:`Edge infrastructure demand is projected at ${infraDemand2030.edge.toFixed(1)} GW by 2030, primarily driven by AI inference workloads. Current edge capacity is estimated at ${(totalSupply2030*0.05).toFixed(1)} GW. Edge DCs require fundamentally different economics (small, distributed, latency-optimized) that incumbent builders are not addressing at scale.`},
        {icon:'fa-coins',color:'#a78bfa',title:'CapEx Mismatch — Providers vs Builders',text:`Top 4 AI/Cloud providers alone plan $${AI_PROVIDERS.slice(0,4).reduce((s,p)=>s+p.capex2025,0)}B CapEx in 2025, dwarfing the top 8 independent DC operators at $${dcBuilders.reduce((s,o)=>s+o.capex,0).toFixed(1)}B combined. However, provider CapEx includes GPUs, networking, and software — only ~30-40% goes to physical DC infrastructure. This amplifies the supply bottleneck.`},
        {icon:'fa-chart-line',color:'#22d3ee',title:'Compound Divergence After 2027',text:`The demand-supply gap is manageable through 2027 (~${(Object.values(demand).reduce((s,d)=>s+d.projections[2],0)-Object.values(supply).reduce((s,d)=>s+d.projections[2],0)).toFixed(0)} GW deficit) because current construction pipelines deliver through 2027. Beyond 2027, constraint dampening accelerates supply slowdown while AI compute demand continues compounding. By 2030, the gap becomes structural — requiring $${(totalGap*1.5).toFixed(0)}B+ additional investment to close.`}
    ].map(i=>`<div style="display:flex;gap:12px;padding:10px 0;border-bottom:1px solid rgba(51,65,85,0.2)">
        <div style="flex-shrink:0;width:32px;height:32px;border-radius:8px;background:${i.color}15;display:flex;align-items:center;justify-content:center"><i class="fas ${i.icon}" style="color:${i.color};font-size:0.75rem"></i></div>
        <div><div style="font-size:0.78rem;font-weight:700;color:#f1f5f9;margin-bottom:3px">${i.title}</div><div style="font-size:0.72rem;color:#94a3b8;line-height:1.5">${i.text}</div></div>
    </div>`).join('');

    // ═══ Methodology ═══
    document.getElementById('projMethodology').innerHTML=`
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
            <div>
                <h5 style="font-size:0.75rem;font-weight:700;color:#a78bfa;margin-bottom:6px"><i class="fas fa-function" style="margin-right:4px"></i>Supply Projection Model</h5>
                <div style="font-size:0.7rem;color:#94a3b8;line-height:1.6">
                    <div style="margin-bottom:4px"><strong style="color:#e2e8f0">Formula:</strong> <code style="background:#0f172a;padding:2px 6px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:0.65rem">S(t) = S₀ × (1 + CAGR × 0.92^t)</code></div>
                    <div style="margin-bottom:4px">• Base: Regional installed capacity from DC_SUMMARY (Synergy/CBRE 2025)</div>
                    <div style="margin-bottom:4px">• CAGR: Americas 17%, EMEA 21%, APAC 12% from C&W/JLL data</div>
                    <div style="margin-bottom:4px">• Constraint dampening: 0.92 per year (power, permits, labor)</div>
                    <div>• Pipeline boost: Construction GW added to 2026-2027 projections</div>
                </div>
            </div>
            <div>
                <h5 style="font-size:0.75rem;font-weight:700;color:#f87171;margin-bottom:6px"><i class="fas fa-brain" style="margin-right:4px"></i>Demand Projection Model</h5>
                <div style="font-size:0.7rem;color:#94a3b8;line-height:1.6">
                    <div style="margin-bottom:4px"><strong style="color:#e2e8f0">Formula:</strong> <code style="background:#0f172a;padding:2px 6px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:0.65rem">D(t) = Σ P_i × (1 + g_i × 0.88^t) × R_region</code></div>
                    <div style="margin-bottom:4px">• Per-provider growth rates from CapEx trajectory analysis</div>
                    <div style="margin-bottom:4px">• AI-native providers: 65-90% CAGR (OpenAI, Anthropic, xAI)</div>
                    <div style="margin-bottom:4px">• Hyperscalers: 20-45% CAGR (MSFT, GOOG, AWS, META, ORCL)</div>
                    <div>• Dampening: 0.88 (capital constraints, efficiency gains)</div>
                </div>
            </div>
        </div>
        <div style="margin-top:1rem;padding:10px;background:#0f172a;border:1px solid rgba(248,113,113,0.2);border-radius:8px">
            <div style="font-size:0.7rem;color:#f87171;font-weight:600;margin-bottom:4px"><i class="fas fa-exclamation-triangle" style="margin-right:4px"></i>Key Limitation</div>
            <div style="font-size:0.68rem;color:#94a3b8;line-height:1.5">These projections use deterministic compound growth with constraint dampening. Actual outcomes will vary based on: (1) AI model efficiency improvements (reducing compute per inference), (2) Nuclear/SMR power availability post-2028, (3) Regulatory changes (EU AI Act, Singapore lifting moratorium), (4) Potential AI winter / demand correction. Infrastructure allocation (hyperscale/colo/edge mix) is estimated from provider announcements and may shift significantly.</div>
        </div>`;
}

// ═══════════════════════════════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════════════════════════════
function renderAudit(){filterAudit()}
function filterAudit(){
    const tf=document.getElementById('auditTypeFilter').value;
    const filtered=tf==='all'?activities:activities.filter(a=>a.type===tf);
    const icons={login:'fa-sign-in-alt',logout:'fa-sign-out-alt',calculation:'fa-calculator',pdf:'fa-file-pdf',tier_change:'fa-exchange-alt',feature_toggle:'fa-toggle-on'};
    document.getElementById('auditTimeline').innerHTML=filtered.map(a=>`
        <div class="tl-item ${a.type}"><div class="tl-icon ${a.type}"><i class="fas ${icons[a.type]||'fa-circle'}"></i></div>
        <div><div class="tl-text"><strong>${a.name||a.email}</strong> — ${a.detail}</div><div class="tl-time">${a.time} · ${a.email}</div></div></div>`).join('');
}
function exportAuditCSV(){const h='Time,Email,Name,Type,Detail';const r=activities.map(a=>[a.time,a.email,a.name||'',a.type,a.detail].join(','));downloadCSV([h,...r].join('\n'),'rz_audit_'+fmtDate(new Date())+'.csv')}

// ═══════════════════════════════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════════════════════════════
function renderSettings(){
    // Calculate storage size
    var storageSize=0;
    for(var key in localStorage){
        if(localStorage.hasOwnProperty(key)){
            storageSize+=localStorage[key].length+key.length;
        }
    }
    var storageMB=(storageSize/1024).toFixed(2);
    document.getElementById('storageUsed').textContent=storageMB+'KB';

    const settings=[
        {label:'Platform',value:'ResistanceZero Calculator Suite',icon:'fa-globe'},
        {label:'Version',value:'v2.0.0 (Feb 2026)',icon:'fa-code-branch'},
        {label:'Environment',value:'Production',icon:'fa-server'},
        {label:'Auth Backend',value:'localStorage (Pre-Supabase)',icon:'fa-database'},
        {label:'Session Duration',value:'24 hours',icon:'fa-clock'},
        {label:'Admin Emails',value:ADMIN_EMAILS.join(', '),icon:'fa-user-shield'},
        {label:'Total Accounts',value:CREDENTIALS.length+' registered',icon:'fa-users'},
        {label:'Feature Flags',value:Object.keys(featureFlags).length+' flags configured',icon:'fa-toggle-on'},
        {label:'Calculators',value:'CAPEX + OPEX',icon:'fa-calculator'},
        {label:'Deployment',value:'GitHub Pages (Static)',icon:'fa-cloud-upload-alt'},
        {label:'CDN',value:'Cloudflare',icon:'fa-shield-alt'},
        {label:'Analytics',value:'Google Analytics (G-GED7FX8RTV)',icon:'fa-chart-line'}
    ];
    document.getElementById('settingsGrid').innerHTML=settings.map(s=>`
        <div style="display:flex;align-items:center;gap:12px;padding:0.75rem;background:#0f172a;border:1px solid #334155;border-radius:8px">
            <i class="fas ${s.icon}" style="color:#64748b;width:16px;text-align:center"></i>
            <div><div style="font-size:0.68rem;color:#64748b;text-transform:uppercase;letter-spacing:0.3px">${s.label}</div><div style="font-size:0.82rem;color:#e2e8f0;font-weight:500">${s.value}</div></div>
        </div>`).join('');
}

// ═══════════════════════════════════════════════════════════════
// NEWSLETTER SUBSCRIBERS
// ═══════════════════════════════════════════════════════════════
function getSubscribers(){return JSON.parse(localStorage.getItem('rz_newsletter_subscribers')||'[]')}
function renderSubscribers(){
    var subs=getSubscribers();
    var search=(document.getElementById('subSearch').value||'').toLowerCase();
    var srcFilter=document.getElementById('subSourceFilter').value;
    var statusFilter=document.getElementById('subStatusFilter').value;
    // Populate source filter options
    var sources=[...new Set(subs.map(s=>s.source))].sort();
    var srcSel=document.getElementById('subSourceFilter');
    var curVal=srcSel.value;
    srcSel.innerHTML='<option value="all">All Sources</option>'+sources.map(s=>'<option value="'+s+'">'+s+'</option>').join('');
    srcSel.value=curVal;
    // Filter
    var filtered=subs.filter(function(s){
        if(search&&s.email.toLowerCase().indexOf(search)<0)return false;
        if(srcFilter!=='all'&&s.source!==srcFilter)return false;
        if(statusFilter!=='all'&&s.status!==statusFilter)return false;
        return true;
    });
    // Update nav badge
    document.getElementById('navSubCount').textContent=subs.length;
    // Render
    var tbody=document.getElementById('subTableBody');
    if(filtered.length===0){
        tbody.innerHTML='';
        document.getElementById('subEmpty').style.display='block';
        return;
    }
    document.getElementById('subEmpty').style.display='none';
    tbody.innerHTML=filtered.map(function(s,i){
        var d=new Date(s.date);
        var dateStr=d.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
        var statusClass=s.status==='active'?'green':'amber';
        return '<tr><td style="font-weight:500">'+s.email+'</td><td style="font-size:0.78rem;color:#94a3b8">'+dateStr+'</td><td><span class="badge '+statusClass+'" style="font-size:0.7rem">'+s.source+'</span></td><td><span style="color:'+(s.status==='active'?'#34d399':'#fbbf24')+'">'+s.status+'</span></td><td><button class="btn btn-ghost btn-sm" onclick="toggleSubStatus('+i+')" title="Toggle status"><i class="fas fa-exchange-alt"></i></button> <button class="btn btn-red btn-sm" onclick="removeSub('+i+')" title="Remove"><i class="fas fa-trash"></i></button></td></tr>';
    }).join('');
}
function toggleSubStatus(idx){
    var subs=getSubscribers();
    if(subs[idx])subs[idx].status=subs[idx].status==='active'?'unsubscribed':'active';
    localStorage.setItem('rz_newsletter_subscribers',JSON.stringify(subs));
    renderSubscribers();
}
function removeSub(idx){
    if(!confirm('Remove this subscriber?'))return;
    var subs=getSubscribers();
    subs.splice(idx,1);
    localStorage.setItem('rz_newsletter_subscribers',JSON.stringify(subs));
    renderSubscribers();
}
function exportSubscribersCSV(){
    var subs=getSubscribers();
    if(!subs.length){alert('No subscribers to export');return}
    var h='Email,Date Subscribed,Source,Status';
    var rows=subs.map(function(s){return [s.email,s.date,s.source,s.status].join(',')});
    downloadCSV([h].concat(rows).join('\n'),'rz_subscribers_'+fmtDate(new Date())+'.csv');
}

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════
// MAYAR PAYMENTS DASHBOARD
// ═══════════════════════════════════════════════════════════════
var MAYAR_API_BASE='https://api.mayar.id/hl/v1';
var MAYAR_KEY='';
var mayarRateCount=0;
var mayarRateReset=Date.now();
var mayarRevenueChart=null;
var mayarTxChart=null;
var mayarInitDone=false;
var mayarTxCache=[];
var mayarTxPageNum=0;
var mayarTxPageSize=20;
var mayarCurrentCustomer=null;

function getMayarKey(){
    if(MAYAR_KEY)return MAYAR_KEY;
    var k=localStorage.getItem('rz_mayar_key');
    if(k){MAYAR_KEY=k;return k}
    return null;
}

function mayarFetch(endpoint,options){
    var key=getMayarKey();
    if(!key)return Promise.reject(new Error('No API key'));
    // Rate limit guard
    if(Date.now()-mayarRateReset>60000){mayarRateCount=0;mayarRateReset=Date.now()}
    if(mayarRateCount>=18){
        showMayarToast('Rate limit approaching (18/20). Please wait.','error');
        return Promise.reject(new Error('Rate limit'));
    }
    mayarRateCount++;
    updateMayarRate();
    var opts=Object.assign({method:'GET',headers:{'Authorization':'Bearer '+key,'Content-Type':'application/json'}},options||{});
    return fetch(MAYAR_API_BASE+endpoint,opts).then(function(r){
        if(!r.ok)throw new Error('HTTP '+r.status);
        return r.json();
    });
}

function updateMayarRate(){
    var pct=Math.round(mayarRateCount/20*100);
    var txt=document.getElementById('mayarRateText');
    var fill=document.getElementById('mayarRateFill');
    var hRate=document.getElementById('mayarHealthRate');
    if(txt)txt.textContent=mayarRateCount+' / 20 per min';
    if(fill)fill.style.width=pct+'%';
    if(hRate)hRate.textContent=mayarRateCount+'/20';
}

function showMayarTab(tabId){
    document.querySelectorAll('.mayar-tab').forEach(function(t){t.classList.remove('active')});
    document.querySelectorAll('.mayar-panel').forEach(function(p){p.classList.remove('active')});
    var panel=document.getElementById('mayar-'+tabId);
    if(panel)panel.classList.add('active');
    document.querySelectorAll('.mayar-tab').forEach(function(t){
        if(t.textContent.toLowerCase().replace(/\s/g,'').indexOf(tabId)!==-1||(tabId==='overview'&&t.textContent==='Overview')||(tabId==='transactions'&&t.textContent==='Transactions')||(tabId==='customers'&&t.textContent==='Customers')||(tabId==='membership'&&t.textContent==='Memberships')||(tabId==='actions'&&t.textContent==='Quick Actions'))t.classList.add('active');
    });
}

function showMayarToast(msg,type){
    var existing=document.querySelector('.mayar-toast');
    if(existing)existing.remove();
    var t=document.createElement('div');
    t.className='mayar-toast '+(type||'info');
    t.innerHTML='<i class="fas fa-'+(type==='error'?'exclamation-triangle':type==='success'?'check-circle':'info-circle')+'"></i> '+msg;
    document.body.appendChild(t);
    setTimeout(function(){t.classList.add('show')},50);
    setTimeout(function(){t.classList.remove('show');setTimeout(function(){t.remove()},300)},4000);
}

function showMayarLoading(id,show){
    var el=document.getElementById(id);
    if(!el)return;
    if(show)el.innerHTML='<tr><td colspan="6" class="mayar-loading"><div class="mayar-skeleton" style="width:60%;margin:0 auto"></div><div class="mayar-skeleton" style="width:40%;margin:4px auto"></div></td></tr>';
}

function fmtMayarDate(d){
    if(!d)return '—';
    var dt=new Date(d);
    return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})+' '+dt.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
}

function fmtMayarCurrency(amt){
    if(amt==null||isNaN(amt))return '—';
    return 'Rp '+Number(amt).toLocaleString('id-ID');
}

function mayarStatusBadge(s){
    if(!s)return '<span class="mayar-status pending">Unknown</span>';
    var sl=String(s).toLowerCase();
    if(sl==='paid'||sl==='active'||sl==='success')return '<span class="mayar-status paid">'+s+'</span>';
    if(sl==='unpaid'||sl==='pending')return '<span class="mayar-status unpaid">'+s+'</span>';
    if(sl==='expired'||sl==='cancelled'||sl==='failed')return '<span class="mayar-status expired">'+s+'</span>';
    return '<span class="mayar-status pending">'+s+'</span>';
}

// ═══ API WRAPPERS ═══

function loadMayarBalance(){
    return mayarFetch('/balance').then(function(r){
        var d=r.data||r;
        var bal=d.balance!=null?d.balance:(d.amount!=null?d.amount:0);
        document.getElementById('mayarBalance').textContent=fmtMayarCurrency(bal);
        return d;
    }).catch(function(e){
        document.getElementById('mayarBalance').textContent='Error';
        throw e;
    });
}

function loadMayarLatestTx(){
    return mayarFetch('/transactions').then(function(r){
        var txs=(r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
        return txs;
    });
}

function loadMayarUnpaid(){
    return mayarFetch('/unpaid').then(function(r){
        var txs=(r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
        return txs;
    });
}

function loadMayarTxByPeriod(period){
    return mayarFetch('/transactions?period='+encodeURIComponent(period)).then(function(r){
        return (r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
    });
}

function loadMayarTxByRange(from,to){
    return mayarFetch('/transactions?startDate='+encodeURIComponent(from)+'&endDate='+encodeURIComponent(to)).then(function(r){
        return (r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
    });
}

function loadMayarTxByProduct(productId){
    return mayarFetch('/transactions?productId='+encodeURIComponent(productId)).then(function(r){
        return (r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
    });
}

function loadMayarTxByCustomer(customerId){
    return mayarFetch('/transactions?customerId='+encodeURIComponent(customerId)).then(function(r){
        return (r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
    });
}

function loadMayarTxByCustPeriod(customerId,period){
    return mayarFetch('/transactions?customerId='+encodeURIComponent(customerId)+'&period='+encodeURIComponent(period)).then(function(r){
        return (r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
    });
}

function loadMayarTxByCustRange(customerId,from,to){
    return mayarFetch('/transactions?customerId='+encodeURIComponent(customerId)+'&startDate='+encodeURIComponent(from)+'&endDate='+encodeURIComponent(to)).then(function(r){
        return (r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
    });
}

function loadMayarUnpaidByRange(from,to){
    return mayarFetch('/unpaid?startDate='+encodeURIComponent(from)+'&endDate='+encodeURIComponent(to)).then(function(r){
        return (r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
    });
}

function searchMayarCustomer(){
    var q=document.getElementById('mayarCustSearch').value.trim();
    if(!q){showMayarToast('Enter a name or email to search','error');return}
    showMayarToast('Searching customer...','info');
    mayarFetch('/customer?search='+encodeURIComponent(q)).then(function(r){
        var d=r.data||(Array.isArray(r)?r[0]:r);
        if(!d||(!d.name&&!d.email)){
            showMayarToast('No customer found for "'+q+'"','error');
            return;
        }
        // Handle array response
        var cust=Array.isArray(d)?d[0]:d;
        if(!cust){showMayarToast('No customer found','error');return}
        mayarCurrentCustomer=cust;
        renderMayarCustomerDetail(cust);
        document.getElementById('mayarCustResult').style.display='block';
        document.getElementById('mayarCustEmpty').style.display='none';
        showMayarToast('Customer found: '+(cust.name||cust.email),'success');
    }).catch(function(e){
        showMayarToast('Customer search failed: '+e.message,'error');
    });
}

function renderMayarCustomerDetail(c){
    var html='';
    var fields=[['Name',c.name||'—'],['Email',c.email||'—'],['Customer ID',c.id||c.customerId||'—'],['Mobile',c.mobile||c.phone||'—'],['Status',c.status||'Active'],['Created',fmtMayarDate(c.createdAt||c.created_at)]];
    fields.forEach(function(f){
        html+='<div class="mayar-cust-row"><span>'+f[0]+'</span><span>'+f[1]+'</span></div>';
    });
    document.getElementById('mayarCustDetail').innerHTML=html;
}

function sendMayarPortalLinkForCust(){
    if(!mayarCurrentCustomer||!mayarCurrentCustomer.email){showMayarToast('No customer selected','error');return}
    sendMayarPortalLinkByEmail(mayarCurrentCustomer.email);
}

function loadMayarCustTx(){
    if(!mayarCurrentCustomer){showMayarToast('Search a customer first','error');return}
    var custId=mayarCurrentCustomer.id||mayarCurrentCustomer.customerId;
    var period=document.getElementById('mayarCustTxPeriod').value;
    showMayarLoading('mayarCustTxBody',true);
    var p;
    if(period)p=loadMayarTxByCustPeriod(custId,period);
    else p=loadMayarTxByCustomer(custId);
    p.then(function(txs){
        if(!txs.length){
            document.getElementById('mayarCustTxBody').innerHTML='<tr><td colspan="4" style="color:#64748b;text-align:center;padding:1.5rem">No transactions found</td></tr>';
            return;
        }
        var html='';
        txs.forEach(function(tx){
            html+='<tr><td>'+fmtMayarDate(tx.createdAt||tx.created_at||tx.date)+'</td><td>'+(tx.description||tx.name||'—')+'</td><td>'+fmtMayarCurrency(tx.amount||tx.total)+'</td><td>'+mayarStatusBadge(tx.status)+'</td></tr>';
        });
        document.getElementById('mayarCustTxBody').innerHTML=html;
    }).catch(function(e){
        document.getElementById('mayarCustTxBody').innerHTML='<tr><td colspan="4" style="color:#f87171;text-align:center;padding:1.5rem">Failed: '+e.message+'</td></tr>';
    });
}

function loadMayarMembersApi(){
    var pid=document.getElementById('mayarMemProductId').value.trim();
    if(!pid){showMayarToast('Enter a Product ID','error');return}
    var tid=document.getElementById('mayarMemTierId').value.trim();
    showMayarLoading('mayarMemBody',true);
    var url='/membership?productId='+encodeURIComponent(pid);
    if(tid)url+='&tierId='+encodeURIComponent(tid);
    mayarFetch(url).then(function(r){
        var members=(r.data&&Array.isArray(r.data))?r.data:(Array.isArray(r)?r:[]);
        renderMayarMembers(members);
    }).catch(function(e){
        document.getElementById('mayarMemBody').innerHTML='<tr><td colspan="6" style="color:#f87171;text-align:center;padding:1.5rem">Failed: '+e.message+'</td></tr>';
    });
}
function loadMayarMembers(){loadMayarMembersApi()}

function renderMayarMembers(members){
    if(!members.length){
        document.getElementById('mayarMemBody').innerHTML='<tr><td colspan="6" style="color:#64748b;text-align:center;padding:1.5rem">No members found</td></tr>';
        return;
    }
    var html='';
    members.forEach(function(m){
        html+='<tr><td>'+(m.name||'—')+'</td><td>'+(m.email||'—')+'</td><td>'+mayarStatusBadge(m.status||'active')+'</td><td>'+(m.tierName||m.tier||'—')+'</td><td>'+fmtMayarDate(m.createdAt||m.created_at||m.joinedAt)+'</td><td><button class="btn btn-ghost btn-sm" onclick="document.getElementById(\'mayarCustSearch\').value=\''+(m.email||'')+'\';showMayarTab(\'customers\');searchMayarCustomer()"><i class="fas fa-external-link-alt"></i></button></td></tr>';
    });
    document.getElementById('mayarMemBody').innerHTML=html;
}

function submitMayarInvoice(){
    var name=document.getElementById('mayarInvName').value.trim();
    var email=document.getElementById('mayarInvEmail').value.trim();
    var mobile=document.getElementById('mayarInvMobile').value.trim();
    var desc=document.getElementById('mayarInvDesc').value.trim();
    var qty=parseInt(document.getElementById('mayarInvQty').value)||1;
    var rate=parseInt(document.getElementById('mayarInvRate').value)||0;
    var redirect=document.getElementById('mayarInvRedirect').value.trim();
    var expiry=parseInt(document.getElementById('mayarInvExpiry').value)||7;

    if(!name||!email||!desc||!rate){showMayarToast('Fill required fields: Name, Email, Description, Rate','error');return}

    var body={name:name,email:email,description:desc,quantity:qty,rate:rate,expiryDays:expiry};
    if(mobile)body.mobile=mobile;
    if(redirect)body.redirectUrl=redirect;

    showMayarToast('Creating invoice...','info');
    mayarFetch('/invoice/create',{method:'POST',body:JSON.stringify(body)}).then(function(r){
        var d=r.data||r;
        showMayarToast('Invoice created! Link: '+(d.link||d.paymentLink||'Check Mayar dashboard'),'success');
        // Clear form
        ['mayarInvName','mayarInvEmail','mayarInvMobile','mayarInvDesc','mayarInvRate','mayarInvRedirect'].forEach(function(id){document.getElementById(id).value=''});
        document.getElementById('mayarInvQty').value='1';
        document.getElementById('mayarInvExpiry').value='7';
    }).catch(function(e){
        showMayarToast('Invoice creation failed: '+e.message,'error');
    });
}

function sendMayarPortalLink(){
    var email=document.getElementById('mayarPortalEmail').value.trim();
    if(!email){showMayarToast('Enter customer email','error');return}
    sendMayarPortalLinkByEmail(email);
}

function sendMayarPortalLinkByEmail(email){
    showMayarToast('Sending portal link to '+email+'...','info');
    mayarFetch('/customer/login/portal',{method:'POST',body:JSON.stringify({email:email})}).then(function(r){
        showMayarToast('Portal link sent to '+email,'success');
        document.getElementById('mayarPortalEmail').value='';
    }).catch(function(e){
        showMayarToast('Failed to send portal link: '+e.message,'error');
    });
}

function checkMayarHealth(){
    var el=document.getElementById('mayarHealthStatus');
    el.textContent='...';el.style.color='#64748b';
    var t0=Date.now();
    loadMayarBalance().then(function(){
        var ms=Date.now()-t0;
        el.innerHTML='<span style="color:#34d399">OK</span>';
        showMayarToast('API healthy — responded in '+ms+'ms','success');
    }).catch(function(e){
        el.innerHTML='<span style="color:#f87171">DOWN</span>';
        showMayarToast('API health check failed: '+e.message,'error');
    });
}

// ═══ RENDER FUNCTIONS ═══

function renderMayarKpis(txs,unpaidTxs){
    var paidCount=0,grossRevenue=0;
    if(txs&&txs.length){
        txs.forEach(function(tx){
            var st=String(tx.status||'').toLowerCase();
            if(st==='paid'||st==='success'||st==='active'){paidCount++;grossRevenue+=(tx.amount||tx.total||0)}
        });
    }
    document.getElementById('mayarPaidCount').textContent=paidCount;
    document.getElementById('mayarUnpaidCount').textContent=unpaidTxs?unpaidTxs.length:'—';
    document.getElementById('mayarGrossRevenue').textContent=fmtMayarCurrency(grossRevenue);
}

function renderMayarTxRows(txs,bodyId){
    var body=document.getElementById(bodyId);
    if(!body)return;
    if(!txs||!txs.length){
        body.innerHTML='<tr><td colspan="'+(bodyId==='mayarRecentBody'?5:6)+'" style="color:#64748b;text-align:center;padding:1.5rem">No transactions found</td></tr>';
        return;
    }
    var html='';
    txs.forEach(function(tx){
        html+='<tr>';
        html+='<td style="white-space:nowrap">'+fmtMayarDate(tx.createdAt||tx.created_at||tx.date)+'</td>';
        html+='<td>'+(tx.customerName||tx.customer_name||tx.name||'—')+'</td>';
        if(bodyId!=='mayarRecentBody')html+='<td>'+(tx.customerEmail||tx.customer_email||tx.email||'—')+'</td>';
        html+='<td>'+(tx.description||tx.productName||tx.product_name||'—')+'</td>';
        html+='<td>'+fmtMayarCurrency(tx.amount||tx.total)+'</td>';
        html+='<td>'+mayarStatusBadge(tx.status)+'</td>';
        html+='</tr>';
    });
    body.innerHTML=html;
}

function updateMayarRevenueChart(txs,period){
    var canvas=document.getElementById('mayarRevenueChart');
    if(!canvas)return;
    // Group by date
    var grouped={};
    (txs||[]).forEach(function(tx){
        var st=String(tx.status||'').toLowerCase();
        if(st!=='paid'&&st!=='success'&&st!=='active')return;
        var d=tx.createdAt||tx.created_at||tx.date;
        if(!d)return;
        var key;
        var dt=new Date(d);
        if(period==='year')key=dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0');
        else if(period==='month')key=dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
        else key=dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
        grouped[key]=(grouped[key]||0)+(tx.amount||tx.total||0);
    });
    var labels=Object.keys(grouped);
    var data=Object.values(grouped);
    if(mayarRevenueChart){mayarRevenueChart.destroy()}
    var isDark=!document.body.classList.contains('light-mode');
    mayarRevenueChart=new Chart(canvas,{type:'line',data:{labels:labels,datasets:[{label:'Revenue (IDR)',data:data,borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.1)',fill:true,tension:0.4,pointRadius:3,pointBackgroundColor:'#8b5cf6'}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:isDark?'#64748b':'#94a3b8',font:{size:10}},grid:{color:isDark?'rgba(51,65,85,0.3)':'rgba(226,232,240,0.5)'}},y:{ticks:{color:isDark?'#64748b':'#94a3b8',font:{size:10},callback:function(v){return 'Rp '+Number(v/1000).toFixed(0)+'K'}},grid:{color:isDark?'rgba(51,65,85,0.3)':'rgba(226,232,240,0.5)'}}}}});
}

function updateMayarTxChart(txs){
    var canvas=document.getElementById('mayarTxChart');
    if(!canvas)return;
    var grouped={};
    (txs||[]).forEach(function(tx){
        var d=tx.createdAt||tx.created_at||tx.date;
        if(!d)return;
        var key=new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
        if(!grouped[key])grouped[key]={paid:0,unpaid:0};
        var st=String(tx.status||'').toLowerCase();
        if(st==='paid'||st==='success')grouped[key].paid++;
        else grouped[key].unpaid++;
    });
    var labels=Object.keys(grouped);
    if(mayarTxChart){mayarTxChart.destroy()}
    var isDark=!document.body.classList.contains('light-mode');
    mayarTxChart=new Chart(canvas,{type:'bar',data:{labels:labels,datasets:[{label:'Paid',data:labels.map(function(l){return grouped[l].paid}),backgroundColor:'rgba(16,185,129,0.6)',borderRadius:4},{label:'Unpaid',data:labels.map(function(l){return grouped[l].unpaid}),backgroundColor:'rgba(245,158,11,0.6)',borderRadius:4}]},options:{responsive:true,plugins:{legend:{labels:{color:isDark?'#94a3b8':'#64748b',font:{size:10}}}},scales:{x:{ticks:{color:isDark?'#64748b':'#94a3b8',font:{size:9}},grid:{display:false},stacked:true},y:{ticks:{color:isDark?'#64748b':'#94a3b8',font:{size:10},stepSize:1},grid:{color:isDark?'rgba(51,65,85,0.3)':'rgba(226,232,240,0.5)'},stacked:true}}}});
}

// ═══ ORCHESTRATORS ═══

function renderMayar(){
    if(mayarInitDone)return;
    mayarInitDone=true;
    var balP=loadMayarBalance().catch(function(e){return null});
    var txP=loadMayarLatestTx().catch(function(e){return[]});
    var unpaidP=loadMayarUnpaid().catch(function(e){return[]});
    Promise.allSettled?Promise.allSettled([balP,txP,unpaidP]).then(function(results){
        var txs=results[1].value||[];
        var unpaid=results[2].value||[];
        renderMayarKpis(txs,unpaid);
        renderMayarTxRows(txs.slice(0,10),'mayarRecentBody');
        updateMayarRevenueChart(txs,'month');
        document.getElementById('mayarLastRefresh').textContent=new Date().toLocaleTimeString();
        if(results[0].status==='rejected'||results[1].status==='rejected'){
            showMayarToast('Some API calls failed — CORS or API key issue. Data may be incomplete.','error');
        }
    }):Promise.all([balP,txP,unpaidP]).then(function(r){
        renderMayarKpis(r[1]||[],r[2]||[]);
        renderMayarTxRows((r[1]||[]).slice(0,10),'mayarRecentBody');
        updateMayarRevenueChart(r[1]||[],'month');
        document.getElementById('mayarLastRefresh').textContent=new Date().toLocaleTimeString();
    }).catch(function(){
        showMayarToast('Failed to load Mayar data — check API key and CORS','error');
    });
}

function refreshMayarAll(){
    mayarInitDone=false;
    mayarRateCount=0;
    document.getElementById('mayarBalance').textContent='...';
    document.getElementById('mayarPaidCount').textContent='...';
    document.getElementById('mayarUnpaidCount').textContent='...';
    document.getElementById('mayarGrossRevenue').textContent='...';
    showMayarLoading('mayarRecentBody',true);
    renderMayar();
}

function filterMayarTx(){
    var status=document.getElementById('mayarTxStatus').value;
    var period=document.getElementById('mayarTxPeriod').value;
    var dateFrom=document.getElementById('mayarTxDateFrom').value;
    var dateTo=document.getElementById('mayarTxDateTo').value;
    var productId=document.getElementById('mayarTxProductId').value.trim();
    showMayarLoading('mayarTxBody',true);

    var p;
    if(status==='unpaid'){
        if(dateFrom&&dateTo)p=loadMayarUnpaidByRange(dateFrom,dateTo);
        else p=loadMayarUnpaid();
    } else if(productId){
        p=loadMayarTxByProduct(productId);
    } else if(dateFrom&&dateTo){
        p=loadMayarTxByRange(dateFrom,dateTo);
    } else if(period){
        p=loadMayarTxByPeriod(period);
    } else {
        p=loadMayarLatestTx();
    }

    p.then(function(txs){
        // Client-side status filter for paid-only within mixed results
        if(status==='paid'){
            txs=txs.filter(function(tx){var s=String(tx.status||'').toLowerCase();return s==='paid'||s==='success'||s==='active'});
        }
        mayarTxCache=txs;
        mayarTxPageNum=0;
        renderMayarTxPage();
        updateMayarTxChart(txs);
        document.getElementById('mayarTxInfo').textContent='Showing '+txs.length+' transactions';
    }).catch(function(e){
        document.getElementById('mayarTxBody').innerHTML='<tr><td colspan="6" style="color:#f87171;text-align:center;padding:1.5rem">Failed: '+e.message+'</td></tr>';
        document.getElementById('mayarTxInfo').textContent='Error loading transactions';
    });
}

function renderMayarTxPage(){
    var start=mayarTxPageNum*mayarTxPageSize;
    var page=mayarTxCache.slice(start,start+mayarTxPageSize);
    renderMayarTxRows(page,'mayarTxBody');
    document.getElementById('mayarTxPrev').disabled=mayarTxPageNum===0;
    document.getElementById('mayarTxNext').disabled=start+mayarTxPageSize>=mayarTxCache.length;
    document.getElementById('mayarTxInfo').textContent='Showing '+(start+1)+'-'+Math.min(start+mayarTxPageSize,mayarTxCache.length)+' of '+mayarTxCache.length;
}

function mayarTxPage(dir){
    mayarTxPageNum+=dir;
    if(mayarTxPageNum<0)mayarTxPageNum=0;
    renderMayarTxPage();
}

function loadRevenuePeriod(period){
    document.querySelectorAll('.mayar-period-btn').forEach(function(b){b.classList.remove('active')});
    event.target.classList.add('active');
    showMayarToast('Loading '+period+' revenue data...','info');
    loadMayarTxByPeriod(period).then(function(txs){
        updateMayarRevenueChart(txs,period);
        showMayarToast('Revenue chart updated','success');
    }).catch(function(e){
        showMayarToast('Failed to load revenue data: '+e.message,'error');
    });
}

function exportMayarTxCSV(){
    if(!mayarTxCache.length){showMayarToast('No transactions to export','error');return}
    var csv='Date,Customer,Email,Description,Amount,Status\n';
    mayarTxCache.forEach(function(tx){
        csv+='"'+fmtMayarDate(tx.createdAt||tx.created_at||tx.date)+'","'+(tx.customerName||tx.customer_name||tx.name||'')+
            '","'+(tx.customerEmail||tx.customer_email||tx.email||'')+'","'+(tx.description||tx.productName||'')+
            '","'+(tx.amount||tx.total||0)+'","'+(tx.status||'')+'"\n';
    });
    var blob=new Blob([csv],{type:'text/csv'});
    var a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='mayar-transactions-'+new Date().toISOString().slice(0,10)+'.csv';
    a.click();
    showMayarToast('CSV exported','success');
}

// ═══════════════════════════════════════════════════════════════
// USER ACTIVITY DASHBOARD
// ═══════════════════════════════════════════════════════════════
var UA_STORAGE_KEY='rz_user_events';
var uaPeriod='today';
var uaFilteredEvents=[];
var uaPageNum=0;
var UA_PAGE_SIZE=15;
var uaIpPage=0;
var UA_IP_PAGE_SIZE=2;
var uaAllIPs=[];
var uaAllIPEvents=[];
var uaTimelineChartInst=null;
var uaCatChartInst=null;
var uaHourChartInst=null;
var uaTopPagesChartInst=null;
var uaActivityRendered=false;

// ═══ EVENT CATEGORIES ═══
var UA_CATEGORIES={
    pro_click:   {label:'Pro Mode Click',  icon:'fa-crown',       color:'#a78bfa',bg:'rgba(139,92,246,0.15)',cardClass:'purple'},
    demo_login:  {label:'Demo Login',      icon:'fa-sign-in-alt', color:'#34d399',bg:'rgba(52,211,153,0.15)',cardClass:'green'},
    pdf_export:  {label:'PDF Export',      icon:'fa-file-pdf',    color:'#60a5fa',bg:'rgba(96,165,250,0.15)',cardClass:'blue'},
    cv_download: {label:'CV Download',     icon:'fa-id-card',     color:'#fbbf24',bg:'rgba(245,158,11,0.15)',cardClass:'amber'},
    ws_download: {label:'Work Sample DL',  icon:'fa-briefcase',   color:'#f472b6',bg:'rgba(236,72,153,0.15)',cardClass:'pink'},
    page_view:   {label:'Page View',       icon:'fa-eye',         color:'#94a3b8',bg:'rgba(100,116,139,0.15)',cardClass:'indigo'},
    calc_use:    {label:'Calculator Use',  icon:'fa-calculator',  color:'#22d3ee',bg:'rgba(34,211,238,0.15)',cardClass:'cyan'},
    signup:      {label:'Sign Up',         icon:'fa-user-plus',   color:'#34d399',bg:'rgba(52,211,153,0.15)',cardClass:'green'}
};

// ═══ STORAGE ═══
function getUAEvents(){
    try{
        var raw=localStorage.getItem(UA_STORAGE_KEY);
        if(!raw)return[];
        return JSON.parse(raw);
    }catch(e){return[]}
}
function saveUAEvents(events){
    try{localStorage.setItem(UA_STORAGE_KEY,JSON.stringify(events))}catch(e){}
}

// ═══ SEED DEMO DATA ═══
function seedUADemoData(){
    var existing=getUAEvents();
    // Re-seed if old format (no country field) or too few events
    var hasGeo=existing.length>0&&existing[0].country;
    if(existing.length>50&&hasGeo)return;
    if(!hasGeo)existing=[]; // clear old format data
    var events=existing.slice();
    var pages=['index.html','article-1.html','article-2.html','article-3.html','article-4.html','article-5.html','article-6.html','article-7.html','article-8.html','article-9.html','article-10.html','article-11.html','article-12.html','article-13.html','article-14.html','article-15.html','article-16.html','article-17.html','capex-calculator.html','opex-calculator.html','geopolitics-1.html','insights.html','datahall.html','articles.html'];
    var types=Object.keys(UA_CATEGORIES);
    var ips=['103.28.'+rand(100,255)+'.'+rand(1,254),'202.46.'+rand(100,255)+'.'+rand(1,254),'118.97.'+rand(100,255)+'.'+rand(1,254),'180.244.'+rand(100,255)+'.'+rand(1,254),'36.68.'+rand(100,255)+'.'+rand(1,254),'103.10.'+rand(100,255)+'.'+rand(1,254),'110.137.'+rand(100,255)+'.'+rand(1,254),'114.124.'+rand(100,255)+'.'+rand(1,254)];
    var agents=['Mozilla/5.0 Chrome/121','Mozilla/5.0 Safari/17','Mozilla/5.0 Firefox/122','Mozilla/5.0 Edge/121','Mozilla/5.0 Mobile Safari','Mozilla/5.0 Chrome Mobile'];
    var geos=[
        {country:'Indonesia',cc:'ID',city:'Jakarta',region:'Jakarta'},
        {country:'Indonesia',cc:'ID',city:'Surabaya',region:'East Java'},
        {country:'Indonesia',cc:'ID',city:'Bandung',region:'West Java'},
        {country:'Indonesia',cc:'ID',city:'Medan',region:'North Sumatra'},
        {country:'Singapore',cc:'SG',city:'Singapore',region:'Central'},
        {country:'United States',cc:'US',city:'San Francisco',region:'California'},
        {country:'United States',cc:'US',city:'New York',region:'New York'},
        {country:'Malaysia',cc:'MY',city:'Kuala Lumpur',region:'Federal Territory'},
        {country:'Australia',cc:'AU',city:'Sydney',region:'NSW'},
        {country:'Germany',cc:'DE',city:'Frankfurt',region:'Hessen'},
        {country:'India',cc:'IN',city:'Mumbai',region:'Maharashtra'},
        {country:'Japan',cc:'JP',city:'Tokyo',region:'Kanto'}
    ];
    var browsers=['Chrome','Safari','Firefox','Edge','Chrome','Chrome'];
    var devices=['Desktop','Desktop','Desktop','Mobile','Mobile','Tablet'];
    var screens=['1920x1080','1366x768','2560x1440','390x844','412x915','1024x768'];
    var langs=['id','en-US','en-GB','ms','ja','de'];
    var refs=['direct','google.com','linkedin.com','github.com','direct','direct'];
    var now=Date.now();
    // Generate events for last 30 days
    for(var d=0;d<30;d++){
        var dayTs=now-(d*86400000);
        var eventsPerDay=d<1?rand(15,35):d<7?rand(8,20):rand(3,12);
        for(var e=0;e<eventsPerDay;e++){
            var ts=dayTs-rand(0,86399999);
            var type=types[rand(0,types.length-1)];
            // Adjust probabilities: page_view most common
            var r=Math.random();
            if(r<0.35)type='page_view';
            else if(r<0.50)type='pro_click';
            else if(r<0.62)type='calc_use';
            else if(r<0.72)type='demo_login';
            else if(r<0.82)type='pdf_export';
            else if(r<0.88)type='cv_download';
            else if(r<0.94)type='ws_download';
            else type='signup';
            var page=pages[rand(0,pages.length-1)];
            // Make some types more page-specific
            if(type==='calc_use')page=['capex-calculator.html','opex-calculator.html','article-1.html','article-5.html'][rand(0,3)];
            if(type==='pro_click')page=pages[rand(1,17)]; // articles only
            if(type==='pdf_export')page=['capex-calculator.html','opex-calculator.html','article-1.html'][rand(0,2)];
            var geo=geos[rand(0,geos.length-1)];
            var devIdx=rand(0,devices.length-1);
            events.push({
                type:type,
                page:page,
                ts:ts,
                ip:ips[rand(0,ips.length-1)],
                country:geo.country,
                cc:geo.cc,
                city:geo.city,
                region:geo.region,
                tz:'Asia/Jakarta',
                device:devices[devIdx],
                browser:browsers[rand(0,browsers.length-1)],
                screen:screens[devIdx],
                lang:langs[rand(0,langs.length-1)],
                ref:refs[rand(0,refs.length-1)],
                ua:agents[rand(0,agents.length-1)],
                sid:'ses_'+Math.random().toString(36).substring(2,10)
            });
        }
    }
    // Sort by timestamp descending
    events.sort(function(a,b){return b.ts-a.ts});
    saveUAEvents(events);
    return events;
}

// ═══ PERIOD FILTER ═══
function setUAPeriod(period,btn){
    uaPeriod=period;
    document.querySelectorAll('.ua-period-btn').forEach(function(b){b.classList.remove('active')});
    if(btn)btn.classList.add('active');
    // Clear custom date if preset used
    if(period!=='custom'){
        document.getElementById('uaDateFrom').value='';
        document.getElementById('uaDateTo').value='';
    }
    renderActivity();
}

function applyUACustomDate(){
    var from=document.getElementById('uaDateFrom').value;
    var to=document.getElementById('uaDateTo').value;
    if(from&&to){
        uaPeriod='custom';
        document.querySelectorAll('.ua-period-btn').forEach(function(b){b.classList.remove('active')});
        renderActivity();
    }
}

function filterEventsByPeriod(events){
    var now=new Date();
    var startOfDay=new Date(now.getFullYear(),now.getMonth(),now.getDate()).getTime();
    var from,to=Date.now();

    switch(uaPeriod){
        case 'today':from=startOfDay;break;
        case 'week':from=startOfDay-(now.getDay()*86400000);break;
        case 'month':from=new Date(now.getFullYear(),now.getMonth(),1).getTime();break;
        case 'year':from=new Date(now.getFullYear(),0,1).getTime();break;
        case 'all':from=0;break;
        case 'custom':
            var df=document.getElementById('uaDateFrom').value;
            var dt=document.getElementById('uaDateTo').value;
            from=df?new Date(df).getTime():0;
            to=dt?new Date(dt+'T23:59:59').getTime():Date.now();
            break;
        default:from=startOfDay;
    }

    return events.filter(function(e){return e.ts>=from&&e.ts<=to});
}

// ═══ MAIN RENDER ═══
function renderActivity(){
    var allEvents=getUAEvents();
    if(allEvents.length<50)allEvents=seedUADemoData();

    // Filter by period
    var periodEvents=filterEventsByPeriod(allEvents);

    // Filter by category
    var catFilter=document.getElementById('uaCatFilter').value;
    if(catFilter!=='all'){
        uaFilteredEvents=periodEvents.filter(function(e){return e.type===catFilter});
    } else {
        uaFilteredEvents=periodEvents;
    }

    // Update nav badge + data source label
    var todayStart=new Date();todayStart.setHours(0,0,0,0);
    var todayCount=allEvents.filter(function(e){return e.ts>=todayStart.getTime()}).length;
    var navBadge=document.getElementById('navActivityCount');
    if(navBadge)navBadge.textContent=todayCount;
    var srcEl=document.getElementById('uaDataSource');
    if(srcEl)srcEl.textContent='('+allEvents.length+' events in localStorage)';

    renderUAKpis(periodEvents);
    renderUACatGrid(periodEvents);
    renderUATimelineChart(periodEvents);
    renderUACatChart(periodEvents);
    renderUAHourChart(periodEvents);
    renderUATopPages(periodEvents);
    renderUAVisitorStats(periodEvents);
    uaPageNum=0;
    renderUAEventLog();
    uaActivityRendered=true;
}

// ═══ KPI CARDS ═══
function renderUAKpis(events){
    var total=events.length;
    var uniqueIPs={};
    var uniqueSessions={};
    events.forEach(function(e){
        if(e.ip)uniqueIPs[e.ip]=1;
        if(e.sid)uniqueSessions[e.sid]=1;
    });
    var visitors=Object.keys(uniqueIPs).length;
    var sessions=Object.keys(uniqueSessions).length;
    var proClicks=events.filter(function(e){return e.type==='pro_click'}).length;

    var kpis=[
        {icon:'fa-mouse-pointer',bg:'rgba(139,92,246,0.15)',color:'#a78bfa',label:'Total Events',val:total.toLocaleString(),sub:uaPeriod==='today'?'Today':'Period total',cls:'neutral'},
        {icon:'fa-users',bg:'rgba(52,211,153,0.15)',color:'#34d399',label:'Unique Visitors',val:visitors.toLocaleString(),sub:sessions+' sessions',cls:'up'},
        {icon:'fa-crown',bg:'rgba(167,139,250,0.15)',color:'#a78bfa',label:'Pro Clicks',val:proClicks.toLocaleString(),sub:total>0?((proClicks/total*100).toFixed(1)+'% of events'):'No events',cls:'up'},
        {icon:'fa-chart-bar',bg:'rgba(96,165,250,0.15)',color:'#60a5fa',label:'Avg Events/Day',val:calcAvgPerDay(events),sub:'Per active day',cls:'neutral'}
    ];

    document.getElementById('uaKpiGrid').innerHTML=kpis.map(function(k){
        return '<div class="kpi" style="padding:0.85rem"><div class="kpi-icon" style="background:'+k.bg+';color:'+k.color+';width:32px;height:32px;border-radius:8px;font-size:0.8rem;margin-bottom:0.4rem"><i class="fas '+k.icon+'"></i></div>'+
            '<div class="kpi-label">'+k.label+'</div><div class="kpi-val" style="font-size:1.3rem">'+k.val+'</div>'+
            '<span class="kpi-sub '+k.cls+'"><i class="fas fa-arrow-'+(k.cls==='up'?'up':k.cls==='down'?'down':'right')+'"></i> '+k.sub+'</span></div>';
    }).join('');
}

function calcAvgPerDay(events){
    if(!events.length)return '0';
    var days={};
    events.forEach(function(e){
        var d=new Date(e.ts).toISOString().split('T')[0];
        days[d]=1;
    });
    var activeDays=Object.keys(days).length;
    return activeDays>0?Math.round(events.length/activeDays).toString():'0';
}

// ═══ CATEGORY GRID ═══
function renderUACatGrid(events){
    var counts={};
    Object.keys(UA_CATEGORIES).forEach(function(k){counts[k]=0});
    events.forEach(function(e){if(counts[e.type]!==undefined)counts[e.type]++});

    var html='';
    Object.keys(UA_CATEGORIES).forEach(function(key){
        var cat=UA_CATEGORIES[key];
        var count=counts[key]||0;
        var pct=events.length>0?((count/events.length)*100).toFixed(1):'0';
        html+='<div class="ua-cat-card '+cat.cardClass+'">'+
            '<div class="ua-cat-icon" style="background:'+cat.bg+';color:'+cat.color+'"><i class="fas '+cat.icon+'"></i></div>'+
            '<div class="ua-cat-count">'+count.toLocaleString()+'</div>'+
            '<div class="ua-cat-label">'+cat.label+'</div>'+
            '<div class="ua-cat-sub">'+pct+'% of total</div>'+
            '</div>';
    });
    document.getElementById('uaCatGrid').innerHTML=html;
}

// ═══ TIMELINE CHART ═══
function renderUATimelineChart(events){
    var canvas=document.getElementById('uaTimelineChart');
    if(!canvas)return;
    if(uaTimelineChartInst)uaTimelineChartInst.destroy();

    // Group by day (sorted by date)
    var grouped={};
    events.forEach(function(e){
        var d=new Date(e.ts);
        var sortKey=d.toISOString().split('T')[0]; // YYYY-MM-DD for sorting
        var label=d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
        if(!grouped[sortKey])grouped[sortKey]={label:label,total:0,pro:0,pdf:0,demo:0,cv:0,calc:0};
        grouped[sortKey].total++;
        if(e.type==='pro_click')grouped[sortKey].pro++;
        if(e.type==='pdf_export')grouped[sortKey].pdf++;
        if(e.type==='demo_login')grouped[sortKey].demo++;
        if(e.type==='cv_download')grouped[sortKey].cv++;
        if(e.type==='calc_use')grouped[sortKey].calc++;
    });

    var sortedKeys=Object.keys(grouped).sort();
    var labels=sortedKeys.map(function(k){return grouped[k].label});
    var isDark=!document.body.classList.contains('light-mode');
    uaTimelineChartInst=new Chart(canvas,{type:'line',data:{
        labels:labels,
        datasets:[
            {label:'All Events',data:sortedKeys.map(function(k){return grouped[k].total}),borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.08)',fill:true,tension:0.4,pointRadius:2,borderWidth:2,pointBackgroundColor:'#8b5cf6'},
            {label:'Pro Clicks',data:sortedKeys.map(function(k){return grouped[k].pro}),borderColor:'#a78bfa',fill:false,tension:0.4,pointRadius:1,borderWidth:1.5,borderDash:[4,4]},
            {label:'PDF Exports',data:sortedKeys.map(function(k){return grouped[k].pdf}),borderColor:'#60a5fa',fill:false,tension:0.4,pointRadius:1,borderWidth:1.5,borderDash:[4,4]},
            {label:'Demo Login',data:sortedKeys.map(function(k){return grouped[k].demo}),borderColor:'#34d399',fill:false,tension:0.4,pointRadius:1,borderWidth:1.5,borderDash:[4,4]}
        ]
    },options:{responsive:true,plugins:{legend:{labels:{color:isDark?'#94a3b8':'#64748b',font:{size:9},boxWidth:12,padding:8}}},scales:{x:{ticks:{color:isDark?'#475569':'#94a3b8',font:{size:8},maxRotation:45},grid:{color:isDark?'rgba(51,65,85,0.2)':'rgba(226,232,240,0.5)'}},y:{ticks:{color:isDark?'#475569':'#94a3b8',font:{size:8},stepSize:1},grid:{color:isDark?'rgba(51,65,85,0.2)':'rgba(226,232,240,0.5)'},beginAtZero:true}}}});
}

// ═══ CATEGORY DISTRIBUTION CHART ═══
function renderUACatChart(events){
    var canvas=document.getElementById('uaCatChart');
    if(!canvas)return;
    if(uaCatChartInst)uaCatChartInst.destroy();

    var counts={};
    events.forEach(function(e){counts[e.type]=(counts[e.type]||0)+1});

    var keys=Object.keys(UA_CATEGORIES).filter(function(k){return counts[k]>0});
    var isDark=!document.body.classList.contains('light-mode');
    uaCatChartInst=new Chart(canvas,{type:'doughnut',data:{
        labels:keys.map(function(k){return UA_CATEGORIES[k].label}),
        datasets:[{
            data:keys.map(function(k){return counts[k]}),
            backgroundColor:keys.map(function(k){return UA_CATEGORIES[k].color}),
            borderColor:isDark?'#1e293b':'#fff',
            borderWidth:3
        }]
    },options:{responsive:true,cutout:'55%',plugins:{legend:{position:'right',labels:{color:isDark?'#94a3b8':'#64748b',font:{size:8},padding:6,boxWidth:10,usePointStyle:true}}}}});
}

// ═══ HOURLY CHART ═══
function renderUAHourChart(events){
    var canvas=document.getElementById('uaHourChart');
    if(!canvas)return;
    if(uaHourChartInst)uaHourChartInst.destroy();

    var hours=Array.from({length:24},function(){return 0});
    events.forEach(function(e){
        var h=new Date(e.ts).getHours();
        hours[h]++;
    });

    var isDark=!document.body.classList.contains('light-mode');
    uaHourChartInst=new Chart(canvas,{type:'bar',data:{
        labels:Array.from({length:24},function(_,i){return String(i).padStart(2,'0')+':00'}),
        datasets:[{label:'Events',data:hours,backgroundColor:hours.map(function(v,i){
            var max=Math.max.apply(null,hours)||1;
            var intensity=v/max;
            return 'rgba(139,92,246,'+(0.15+intensity*0.65)+')';
        }),borderRadius:3}]
    },options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:isDark?'#475569':'#94a3b8',font:{size:8}},grid:{display:false}},y:{ticks:{color:isDark?'#475569':'#94a3b8',font:{size:9}},grid:{color:isDark?'rgba(51,65,85,0.2)':'rgba(226,232,240,0.5)'},beginAtZero:true}}}});
}

// ═══ TOP PAGES CHART ═══
function renderUATopPages(events){
    var canvas=document.getElementById('uaTopPagesChart');
    if(!canvas)return;
    if(uaTopPagesChartInst)uaTopPagesChartInst.destroy();

    var pages={};
    events.forEach(function(e){pages[e.page]=(pages[e.page]||0)+1});

    var sorted=Object.entries(pages).sort(function(a,b){return b[1]-a[1]}).slice(0,10);
    var isDark=!document.body.classList.contains('light-mode');
    uaTopPagesChartInst=new Chart(canvas,{type:'bar',data:{
        labels:sorted.map(function(p){return p[0].replace('.html','')}),
        datasets:[{label:'Events',data:sorted.map(function(p){return p[1]}),backgroundColor:'rgba(96,165,250,0.5)',borderColor:'#60a5fa',borderWidth:1,borderRadius:4}]
    },options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:isDark?'#475569':'#94a3b8',font:{size:9}},grid:{color:isDark?'rgba(51,65,85,0.2)':'rgba(226,232,240,0.5)'}},y:{ticks:{color:isDark?'#e2e8f0':'#1e293b',font:{size:9}},grid:{display:false}}}}});
}

// ═══ VISITOR STATS ═══
function renderUAVisitorStats(events){
    var el=document.getElementById('uaVisitorStats');
    if(!el)return;

    var byIP={};var bySess={};var byDev={};var byBrowser={};var byCountry={};var byRef={};
    events.forEach(function(e){
        if(e.ip){byIP[e.ip]=(byIP[e.ip]||0)+1}
        if(e.sid){bySess[e.sid]=(bySess[e.sid]||0)+1}
        var dev=e.device||(e.ua&&e.ua.indexOf('Mobile')!==-1?'Mobile':'Desktop');
        byDev[dev]=(byDev[dev]||0)+1;
        if(e.browser){byBrowser[e.browser]=(byBrowser[e.browser]||0)+1}
        if(e.country){byCountry[e.country]=(byCountry[e.country]||0)+1}
        if(e.ref){byRef[e.ref]=(byRef[e.ref]||0)+1}
    });

    var ccFlags={'Indonesia':'\ud83c\uddee\ud83c\udde9','Singapore':'\ud83c\uddf8\ud83c\uddec','United States':'\ud83c\uddfa\ud83c\uddf8','Malaysia':'\ud83c\uddf2\ud83c\uddfe','Australia':'\ud83c\udde6\ud83c\uddfa','Germany':'\ud83c\udde9\ud83c\uddea','India':'\ud83c\uddee\ud83c\uddf3','Japan':'\ud83c\uddef\ud83c\uddf5','United Kingdom':'\ud83c\uddec\ud83c\udde7','Netherlands':'\ud83c\uddf3\ud83c\uddf1','France':'\ud83c\uddeb\ud83c\uddf7','South Korea':'\ud83c\uddf0\ud83c\uddf7'};
    var mobile=(byDev['Mobile']||0);var desktop=(byDev['Desktop']||0);var tablet=(byDev['Tablet']||0);
    var totalDev=mobile+desktop+tablet||1;

    var html='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;margin-bottom:0.6rem">';
    html+='<div class="health-stat" style="padding:0.5rem"><div class="health-stat-label" style="font-size:0.58rem">Unique IPs</div><div class="health-stat-value" style="color:#34d399;font-size:1.1rem">'+Object.keys(byIP).length+'</div></div>';
    html+='<div class="health-stat" style="padding:0.5rem"><div class="health-stat-label" style="font-size:0.58rem">Sessions</div><div class="health-stat-value" style="color:#60a5fa;font-size:1.1rem">'+Object.keys(bySess).length+'</div></div>';
    html+='<div class="health-stat" style="padding:0.5rem"><div class="health-stat-label" style="font-size:0.58rem">Countries</div><div class="health-stat-value" style="color:#fbbf24;font-size:1.1rem">'+Object.keys(byCountry).length+'</div></div>';
    html+='<div class="health-stat" style="padding:0.5rem"><div class="health-stat-label" style="font-size:0.58rem">Browsers</div><div class="health-stat-value" style="color:#a78bfa;font-size:1.1rem">'+Object.keys(byBrowser).length+'</div></div>';
    html+='</div>';

    // Device + Browser breakdown row
    html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-bottom:0.6rem">';
    html+='<div style="font-size:0.6rem;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.2rem">Device</div>';
    html+='<div style="font-size:0.6rem;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.2rem">Browser</div>';
    html+='</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-bottom:0.6rem">';
    html+='<div>';
    [['Desktop','fa-desktop','#a78bfa'],['Mobile','fa-mobile-alt','#f472b6'],['Tablet','fa-tablet-alt','#22d3ee']].forEach(function(d){
        var ct=byDev[d[0]]||0;if(!ct)return;
        html+='<div style="display:flex;align-items:center;gap:5px;padding:2px 0;font-size:0.68rem"><i class="fas '+d[1]+'" style="color:'+d[2]+';width:14px;text-align:center;font-size:0.6rem"></i><span style="color:#cbd5e1">'+d[0]+'</span><span style="margin-left:auto;color:'+d[2]+';font-weight:600">'+Math.round(ct/totalDev*100)+'%</span></div>';
    });
    html+='</div><div>';
    Object.entries(byBrowser).sort(function(a,b){return b[1]-a[1]}).slice(0,4).forEach(function(b){
        html+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:0.68rem"><span style="color:#cbd5e1">'+b[0]+'</span><span style="color:#60a5fa;font-weight:600">'+b[1]+'</span></div>';
    });
    html+='</div></div>';

    // Country breakdown
    var topCountries=Object.entries(byCountry).sort(function(a,b){return b[1]-a[1]}).slice(0,6);
    html+='<div style="font-size:0.6rem;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.3rem">Top Countries</div>';
    topCountries.forEach(function(c){
        var pct=Math.round(c[1]/events.length*100);
        var flag=ccFlags[c[0]]||'';
        html+='<div style="display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid rgba(51,65,85,0.3);font-size:0.68rem">'+
            '<span>'+flag+'</span><span style="color:#cbd5e1;flex:1">'+c[0]+'</span>'+
            '<span style="color:#94a3b8;font-size:0.62rem">'+pct+'%</span>'+
            '<span style="color:#e2e8f0;font-weight:600;min-width:28px;text-align:right">'+c[1]+'</span></div>';
    });

    // Top Visitors by IP — store globally for pagination
    uaAllIPs=Object.entries(byIP).sort(function(a,b){return b[1]-a[1]});
    uaAllIPEvents=events;
    uaIpPage=0;
    html+='<div style="font-size:0.6rem;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin:0.5rem 0 0.3rem">Top Visitors (IP)</div>';
    html+='<div id="uaIpList"></div>';
    html+='<div id="uaIpPagination" style="display:flex;align-items:center;justify-content:space-between;margin-top:0.4rem"></div>';

    // Referrers
    var topRefs=Object.entries(byRef).sort(function(a,b){return b[1]-a[1]}).slice(0,4);
    if(topRefs.length){
        html+='<div style="font-size:0.6rem;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin:0.5rem 0 0.3rem">Referrers</div>';
        topRefs.forEach(function(r){
            html+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:0.68rem"><span style="color:#94a3b8">'+r[0]+'</span><span style="color:#e2e8f0;font-weight:600">'+r[1]+'</span></div>';
        });
    }

    el.innerHTML=html;
    renderUAIpList();
}

function renderUAIpList(){
    var list=document.getElementById('uaIpList');
    var pag=document.getElementById('uaIpPagination');
    if(!list||!pag)return;
    var ccFlags={'Indonesia':'\ud83c\uddee\ud83c\udde9','Singapore':'\ud83c\uddf8\ud83c\uddec','United States':'\ud83c\uddfa\ud83c\uddf8','Malaysia':'\ud83c\uddf2\ud83c\uddfe','Australia':'\ud83c\udde6\ud83c\uddfa','Germany':'\ud83c\udde9\ud83c\uddea','India':'\ud83c\uddee\ud83c\uddf3','Japan':'\ud83c\uddef\ud83c\uddf5','United Kingdom':'\ud83c\uddec\ud83c\udde7','Netherlands':'\ud83c\uddf3\ud83c\uddf1','France':'\ud83c\uddeb\ud83c\uddf7','South Korea':'\ud83c\uddf0\ud83c\uddf7'};
    var total=uaAllIPs.length;
    var totalPages=Math.ceil(total/UA_IP_PAGE_SIZE)||1;
    if(uaIpPage>=totalPages)uaIpPage=totalPages-1;
    if(uaIpPage<0)uaIpPage=0;
    var start=uaIpPage*UA_IP_PAGE_SIZE;
    var slice=uaAllIPs.slice(start,start+UA_IP_PAGE_SIZE);
    var html='';
    slice.forEach(function(ip){
        var ipCountry='';
        for(var i=0;i<uaAllIPEvents.length;i++){if(uaAllIPEvents[i].ip===ip[0]&&uaAllIPEvents[i].country){ipCountry=uaAllIPEvents[i].country;break}}
        var ipFlag=ccFlags[ipCountry]||'';
        html+='<div style="display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid rgba(51,65,85,0.3);font-size:0.68rem">'+
            '<span style="color:#94a3b8;font-family:JetBrains Mono,monospace;font-size:0.62rem;flex:1">'+ip[0]+'</span>'+
            '<span style="font-size:0.6rem">'+ipFlag+'</span>'+
            '<span style="color:#64748b;font-size:0.58rem;margin-right:2px">'+(ipCountry?ipCountry.substring(0,3).toUpperCase():'')+'</span>'+
            '<span style="color:#e2e8f0;font-weight:600;min-width:24px;text-align:right">'+ip[1]+'</span></div>';
    });
    list.innerHTML=html;
    // Pagination
    if(total>UA_IP_PAGE_SIZE){
        pag.innerHTML='<span style="font-size:0.58rem;color:#64748b">Page '+(uaIpPage+1)+' of '+totalPages+' ('+total+' IPs)</span>'+
            '<div style="display:flex;gap:3px">'+
            '<button class="btn btn-ghost btn-sm" style="padding:2px 6px;font-size:0.6rem" onclick="uaIpGoPage(-1)"'+(uaIpPage===0?' disabled':'')+'>&laquo;</button>'+
            '<button class="btn btn-ghost btn-sm" style="padding:2px 6px;font-size:0.6rem" onclick="uaIpGoPage(1)"'+(uaIpPage>=totalPages-1?' disabled':'')+'>&raquo;</button></div>';
    } else {
        pag.innerHTML='<span style="font-size:0.58rem;color:#64748b">'+total+' IPs</span>';
    }
}
function uaIpGoPage(dir){uaIpPage+=dir;renderUAIpList()}

// ═══ EVENT LOG ═══
function renderUAEventLog(){
    var container=document.getElementById('uaEventLog');
    if(!container)return;

    var search=document.getElementById('uaEventSearch').value.toLowerCase();
    var displayEvents=uaFilteredEvents;
    if(search){
        displayEvents=displayEvents.filter(function(e){
            return e.type.indexOf(search)!==-1||e.page.indexOf(search)!==-1||(e.ip||'').indexOf(search)!==-1||(e.country||'').toLowerCase().indexOf(search)!==-1||(e.city||'').toLowerCase().indexOf(search)!==-1||(e.browser||'').toLowerCase().indexOf(search)!==-1;
        });
    }

    var start=uaPageNum*UA_PAGE_SIZE;
    var page=displayEvents.slice(start,start+UA_PAGE_SIZE);

    var headerRow='<div class="ua-event-row header"><span></span><span>Event / Visitor</span><span>Location</span><span>Page</span><span>Type</span><span>Time</span></div>';
    var html=headerRow;

    var ccFlags={'ID':'\ud83c\uddee\ud83c\udde9','SG':'\ud83c\uddf8\ud83c\uddec','US':'\ud83c\uddfa\ud83c\uddf8','MY':'\ud83c\uddf2\ud83c\uddfe','AU':'\ud83c\udde6\ud83c\uddfa','DE':'\ud83c\udde9\ud83c\uddea','IN':'\ud83c\uddee\ud83c\uddf3','JP':'\ud83c\uddef\ud83c\uddf5','GB':'\ud83c\uddec\ud83c\udde7','NL':'\ud83c\uddf3\ud83c\uddf1','FR':'\ud83c\uddeb\ud83c\uddf7','KR':'\ud83c\uddf0\ud83c\uddf7'};
    page.forEach(function(e){
        var cat=UA_CATEGORIES[e.type]||{icon:'fa-circle',color:'#94a3b8',label:e.type};
        var dt=new Date(e.ts);
        var timeStr=String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
        var dateStr=dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
        var flag=ccFlags[e.cc]||'';
        var locStr=e.city?(flag+' '+e.city):(e.country?(flag+' '+e.country):'—');
        var devIcon=e.device==='Mobile'?'fa-mobile-alt':e.device==='Tablet'?'fa-tablet-alt':'fa-desktop';
        html+='<div class="ua-event-row">'+
            '<div class="ua-event-icon '+e.type+'"><i class="fas '+cat.icon+'"></i></div>'+
            '<div class="ua-event-detail">'+cat.label+'<small><span style="font-family:JetBrains Mono,monospace;color:#94a3b8">'+(e.ip||'—')+'</span> &middot; '+(e.browser||'')+' <i class="fas '+devIcon+'" style="font-size:0.55rem;opacity:0.6"></i></small></div>'+
            '<span class="ua-event-loc" title="'+(e.city||'')+', '+(e.country||'')+'">'+locStr+'</span>'+
            '<span class="ua-event-page">'+e.page.replace('.html','')+'</span>'+
            '<span class="ua-event-type '+e.type+'">'+e.type.replace('_',' ')+'</span>'+
            '<span class="ua-event-time">'+dateStr+' '+timeStr+'</span>'+
            '</div>';
    });

    container.innerHTML=html;

    // Pagination
    var totalPages=Math.ceil(displayEvents.length/UA_PAGE_SIZE)||1;
    var curPage=uaPageNum+1;
    // Page number buttons
    var pgNums='';
    var maxBtns=5;
    var startPg=Math.max(0,uaPageNum-2);
    var endPg=Math.min(totalPages,startPg+maxBtns);
    if(endPg-startPg<maxBtns)startPg=Math.max(0,endPg-maxBtns);
    for(var p=startPg;p<endPg;p++){
        pgNums+='<button class="pg-btn'+(p===uaPageNum?' active':'')+'" style="min-width:26px;padding:3px 6px;font-size:0.68rem" onclick="uaGoToPage('+p+')">'+(p+1)+'</button>';
    }
    document.getElementById('uaPageInfo').innerHTML='<span style="color:#64748b;font-size:0.72rem">Page '+curPage+' of '+totalPages+' &middot; '+displayEvents.length+' events</span>';
    document.getElementById('uaPageBtns').innerHTML='<button class="pg-btn" onclick="uaGoPage(-1)"'+(uaPageNum===0?' disabled':'')+'>&laquo;</button>'+pgNums+'<button class="pg-btn" onclick="uaGoPage(1)"'+(start+UA_PAGE_SIZE>=displayEvents.length?' disabled':'')+'>&raquo;</button>';
}

function uaGoPage(dir){
    uaPageNum+=dir;
    if(uaPageNum<0)uaPageNum=0;
    renderUAEventLog();
}
function uaGoToPage(p){uaPageNum=p;renderUAEventLog()}

function filterUAEvents(){
    uaPageNum=0;
    renderUAEventLog();
}

// ═══ CSV EXPORT ═══
function exportUAEventsCSV(){
    if(!uaFilteredEvents.length){alert('No events to export');return}
    var csv='Timestamp,Type,Page,IP,Country,City,Device,Browser,Screen,Language,Referrer,Session,UserAgent\n';
    uaFilteredEvents.forEach(function(e){
        csv+='"'+new Date(e.ts).toISOString()+'","'+e.type+'","'+e.page+'","'+(e.ip||'')+'","'+(e.country||'')+'","'+(e.city||'')+'","'+(e.device||'')+'","'+(e.browser||'')+'","'+(e.screen||'')+'","'+(e.lang||'')+'","'+(e.ref||'')+'","'+(e.sid||'')+'","'+(e.ua||'')+'"\n';
    });
    var blob=new Blob([csv],{type:'text/csv'});
    var a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='rz-user-activity-'+new Date().toISOString().slice(0,10)+'.csv';
    a.click();
}

// Load saved theme
(function(){
    var saved=localStorage.getItem('rz_admin_theme');
    if(saved==='light'){
        document.body.classList.add('light-mode');
        setTimeout(function(){
            var btn=document.getElementById('adminThemeBtn');
            if(btn)btn.innerHTML='<i class="fas fa-sun"></i>';
        },100);
    }
})();

if(checkAccess()){
    document.getElementById('main-content').style.display='block';
    allUsers=generateUsers();
    loadManualAccounts();
    filteredUsers=[...allUsers];
    activities=generateActivities();

    applySort();
    renderKPIs();
    renderDashboardCharts();
    renderRevenue();
    renderTable();
    renderCredentials();
    renderFeatures();
    renderBenchmarks();
    renderAudit();
    renderSubscribers();
    renderSettings();
    renderMayar();
    renderActivity();
}
</script>
</body>
</html>
