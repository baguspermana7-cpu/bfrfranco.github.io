<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GED7FX8RTV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GED7FX8RTV');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- SEO Meta Tags -->
    <title>Data Center CAPEX Calculator | Construction Cost Estimator</title>
    <meta name="description" content="Data Center CAPEX Calculator for construction cost estimation. Calculate comprehensive capital expenditure with detailed breakdown of electrical, cooling, civil, and infrastructure costs.">
    <meta name="keywords" content="Data Center CAPEX, Construction Cost Calculator, Data Center Cost, Tier III Cost, UPS Cost, Generator Cost, Cooling System Cost">
    <meta name="author" content="Bagus Dwi Permana">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#0066cc">
    <link rel="canonical" href="https://resistancezero.com/capex-calculator.html">

    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://resistancezero.com/capex-calculator.html">
    <meta property="og:title" content="Data Center CAPEX Calculator">
    <meta property="og:description" content="Construction cost estimation with detailed breakdown of all infrastructure components.">
    <meta property="og:image" content="https://resistancezero.com/assets/capex-og.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="509">
    <meta property="og:image:alt" content="Data Center CAPEX Calculator - Construction Cost Estimator">
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="Bagus Dwi Permana Portfolio">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@BagusDPermana">
    <meta name="twitter:title" content="Data Center CAPEX Calculator">
    <meta name="twitter:description" content="Construction cost estimation with infrastructure breakdown.">
    <meta name="twitter:image" content="https://resistancezero.com/assets/capex-og.jpg">
    <meta name="twitter:image:alt" content="Data Center CAPEX Calculator Tool">

    <!-- WebApplication Schema -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Data Center CAPEX Calculator",
        "applicationCategory": "FinanceApplication",
        "description": "Calculate comprehensive data center construction costs with detailed breakdown of electrical, cooling, civil, UPS, generator, fire suppression, and infrastructure components.",
        "url": "https://resistancezero.com/capex-calculator.html",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "IT load capacity sizing (100 kW - 100 MW)",
            "Multiple cooling types (Air, In-Row, RDHX, DLC)",
            "Redundancy configurations (N, N+1, 2N, 2N+1)",
            "Seismic zone adjustments",
            "Building type cost factors",
            "Fire suppression system options",
            "UPS and generator configurations",
            "Location factor adjustments"
        ],
        "creator": {
            "@type": "Person",
            "name": "Bagus Dwi Permana",
            "jobTitle": "Engineering Operations Manager",
            "url": "https://resistancezero.com/"
        }
    }
    </script>

    <!-- Structured Data - HowTo -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "HowTo",
        "name": "How to Estimate Data Center Construction CAPEX",
        "description": "Interactive calculator for estimating data center capital expenditure including land, building, MEP systems, IT infrastructure, and project management costs.",
        "totalTime": "PT5M",
        "tool": [
            {"@type": "HowToTool", "name": "Data Center CAPEX Calculator"}
        ],
        "step": [
            {
                "@type": "HowToStep",
                "position": 1,
                "name": "Select Region and Tier Level",
                "text": "Choose your data center location and target tier certification level (Tier I through Tier IV) to set baseline construction cost parameters."
            },
            {
                "@type": "HowToStep",
                "position": 2,
                "name": "Define Facility Specifications",
                "text": "Enter the planned IT capacity in MW, building footprint, and number of data halls to calculate structural and MEP requirements."
            },
            {
                "@type": "HowToStep",
                "position": 3,
                "name": "Configure Power and Cooling Systems",
                "text": "Select UPS topology, generator redundancy, cooling system type, and fuel storage requirements based on your availability targets."
            },
            {
                "@type": "HowToStep",
                "position": 4,
                "name": "Review CAPEX Breakdown",
                "text": "Analyze the detailed cost breakdown across land acquisition, civil works, electrical systems, mechanical systems, IT infrastructure, and soft costs with per-MW benchmarking."
            }
        ]
    }
    </script>

    <link rel="icon" type="image/png" href="assets/Favicon.png">
    <link rel="apple-touch-icon" href="assets/Favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preload" as="image" href="assets/capex-og.jpg">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3a7ca5 100%);
            --secondary-gradient: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%);
            --dark-blue: #1e3a5f;
            --medium-blue: #2d5a87;
            --light-blue: #4a90b8;
            --accent-gold: #f59e0b;
            --accent-amber: #fbbf24;
            --accent-emerald: #10b981;
            --accent-cyan: #06b6d4;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-bg-dark: rgba(30, 58, 95, 0.95);
            --glass-border: rgba(30, 58, 95, 0.1);
            --glass-blur: blur(20px);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Background */
        .page-background {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            background:
                radial-gradient(ellipse at top right, rgba(245, 158, 11, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at bottom left, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                linear-gradient(rgba(30, 58, 95, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 58, 95, 0.02) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 50px 50px, 50px 50px;
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: var(--shadow-md);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--dark-blue);
        }

        .nav-logo {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .nav-title { font-weight: 700; font-size: 1.1rem; color: var(--dark-blue); }
        .nav-subtitle { font-size: 0.75rem; color: var(--text-muted); }

        .nav-links { display: flex; gap: 1.5rem; align-items: center; }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 0;
            transition: color 0.3s;
        }

        .nav-link:hover { color: var(--dark-blue); }

        .nav-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            color: white;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.25);
        }

        .nav-back:hover { transform: translateY(-2px); }

        /* Main Content */
        .main-content {
            position: relative;
            z-index: 10;
            padding-top: 80px;
        }

        /* Hero */
        .hero {
            padding: 3rem 2rem 2rem;
            text-align: center;
            max-width: 900px;
            margin: 0 auto;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 50px;
            font-size: 0.8rem;
            color: var(--accent-gold);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .hero h1 {
            font-size: clamp(2rem, 4vw, 2.8rem);
            font-weight: 800;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
        }

        /* Brief Section */
        .brief-section {
            max-width: 860px;
            margin: -0.5rem auto 2rem;
            padding: 0 2rem;
        }

        .brief-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.04), rgba(30, 58, 95, 0.06));
            border: 1px solid rgba(245, 158, 11, 0.15);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .brief-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #f59e0b, #d97706);
            border-radius: 4px 0 0 4px;
        }

        .brief-hero-img {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 1.25rem;
            border: 1px solid rgba(245, 158, 11, 0.12);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .brief-lead {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .brief-body {
            font-size: 0.92rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 0.75rem;
        }

        .brief-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0,0,0,0.06);
        }

        .brief-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .brief-stat i {
            color: var(--accent-gold);
            font-size: 0.75rem;
        }

        .brief-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .brief-section { padding: 0 1rem; }
            .brief-card { padding: 1.25rem 1.25rem 1.25rem 1.5rem; }
            .brief-stats { gap: 1rem; }
        }

        /* Calculator Container */
        .calculator-section {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .simulator-container {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 2rem;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: var(--shadow-lg);
        }

        @media (max-width: 1024px) {
            .simulator-container {
                grid-template-columns: 1fr;
            }
        }

        .simulator-inputs {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 600px) {
            .input-row {
                grid-template-columns: 1fr;
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-label i {
            color: var(--accent-gold);
        }

        /* Tooltip Styles - Fixed positioning to escape overflow */
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 50%;
            font-size: 10px;
            color: var(--accent-gold);
            cursor: help;
            margin-left: auto;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .tooltip-trigger:hover {
            background: rgba(245, 158, 11, 0.2);
            transform: scale(1.1);
        }

        /* Global tooltip container */
        #tooltip-container {
            position: fixed;
            width: 320px;
            max-width: calc(100vw - 40px);
            padding: 16px;
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
            z-index: 999999;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease;
            color: white;
            font-size: 12px;
            line-height: 1.5;
        }

        #tooltip-container.visible {
            opacity: 1;
            visibility: visible;
        }

        #tooltip-container .tooltip-title {
            font-size: 13px;
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #tooltip-container .tooltip-desc {
            color: rgba(255,255,255,0.9);
            margin-bottom: 10px;
        }

        #tooltip-container .tooltip-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }

        #tooltip-container .tooltip-table th {
            text-align: left;
            color: rgba(255,255,255,0.6);
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #tooltip-container .tooltip-table td {
            padding: 4px 0;
        }

        #tooltip-container .tooltip-table td:last-child {
            text-align: right;
            color: #22d3ee;
        }

        /* Hide inline tooltip content */
        .tooltip-trigger .tooltip-content {
            display: none;
        }

        .tooltip-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-amber);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tooltip-desc {
            font-size: 11px;
            color: rgba(255,255,255,0.9);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .tooltip-table {
            width: 100%;
            font-size: 10px;
            border-collapse: collapse;
        }

        .tooltip-table th {
            text-align: left;
            color: rgba(255,255,255,0.6);
            font-weight: 500;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tooltip-table td {
            padding: 4px 0;
            color: white;
        }

        .tooltip-table td:last-child {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
        }

        .tooltip-impact {
            margin-top: 10px;
            padding: 8px;
            background: rgba(245, 158, 11, 0.15);
            border-radius: 6px;
            font-size: 10px;
            color: var(--accent-amber);
        }

        .input-field {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
        }

        select.input-field {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .radio-option {
            flex: 1;
            min-width: 80px;
        }

        .radio-option input {
            display: none;
        }

        .radio-option label {
            display: block;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            text-align: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .radio-option label small {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .radio-option input:checked + label {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.1));
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .radio-option label:hover {
            border-color: var(--accent-gold);
        }

        /* Cost Results */
        .simulator-results {
            background: linear-gradient(135deg, var(--dark-blue), var(--medium-blue));
            border-radius: 20px;
            padding: 2rem;
            color: white;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        .results-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-total {
            text-align: right;
        }

        .total-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .total-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-amber);
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .cost-breakdown {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .cost-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
        }

        .cost-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .cost-bar-container {
            flex: 1;
            margin: 0 12px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .cost-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .cost-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 80px;
            text-align: right;
        }

        .cost-percent {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            min-width: 35px;
            text-align: right;
        }

        /* Metrics Display */
        .per-kw-display {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .per-kw-label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
        }

        .per-kw-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-amber);
            font-family: 'JetBrains Mono', monospace;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric-box {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .metric-label {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .metric-value.tier { color: #a78bfa; }
        .metric-value.pue { color: #22d3ee; }
        .metric-value.uptime { color: #34d399; }
        .metric-value.energy { color: #fbbf24; }

        /* Footer */
        .footer {
            background: var(--dark-blue);
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
        }

        .footer p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        /* Navbar Auth */
        .nav-auth-wrap {
            position: relative;
            margin-left: 0.5rem;
        }
        .nav-login-btn {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 18px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border: none; border-radius: 8px;
            color: white; font-size: 0.82rem; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(139,92,246,0.3);
            white-space: nowrap;
        }
        .nav-login-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 16px rgba(139,92,246,0.4); filter: brightness(1.08); }

        .nav-user-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 12px 6px 6px;
            background: rgba(139,92,246,0.08);
            border: 1px solid rgba(139,92,246,0.25);
            border-radius: 50px;
            cursor: pointer; transition: all 0.3s;
            font-family: inherit;
            color: var(--text-primary);
        }
        .nav-user-btn:hover { background: rgba(139,92,246,0.14); border-color: rgba(139,92,246,0.4); }

        .nav-user-avatar {
            width: 30px; height: 30px; border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 0.7rem; font-weight: 700;
        }
        .nav-user-email {
            font-size: 0.8rem; font-weight: 500; color: var(--text-secondary);
            max-width: 130px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .nav-user-chevron { font-size: 0.6rem; color: var(--text-muted); transition: transform 0.3s; }
        .nav-user-btn.open .nav-user-chevron { transform: rotate(180deg); }

        .nav-user-dropdown {
            display: none; position: absolute; top: calc(100% + 8px); right: 0;
            background: white; border-radius: 12px; border: 1px solid #e2e8f0;
            box-shadow: 0 12px 40px rgba(0,0,0,0.12); min-width: 220px;
            z-index: 1001; overflow: hidden;
            animation: dropdownSlideIn 0.2s ease;
        }
        .nav-user-dropdown.show { display: block; }
        @keyframes dropdownSlideIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

        .nav-dd-header {
            padding: 14px 16px; border-bottom: 1px solid #f1f5f9;
        }
        .nav-dd-tier-badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 3px 10px; border-radius: 50px;
            font-size: 0.65rem; font-weight: 700; letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .nav-dd-tier-badge.pro { background: linear-gradient(135deg,#8b5cf6,#a855f7); color: white; }
        .nav-dd-email {
            font-size: 0.78rem; color: #64748b; word-break: break-all;
        }
        .nav-dd-logout {
            display: flex; align-items: center; gap: 8px;
            width: 100%; padding: 12px 16px; border: none; background: none;
            font-size: 0.82rem; font-weight: 500; color: #ef4444;
            cursor: pointer; font-family: inherit; transition: background 0.2s;
        }
        .nav-dd-logout:hover { background: #fef2f2; }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .calculator-section { padding: 1rem; }
            .simulator-container { padding: 1.5rem; }
            #compareGrid { grid-template-columns: 1fr !important; }
            #deltaColumn { flex-direction: row !important; width: 100%; justify-content: center !important; }
            .nav-user-email { display: none; }
            .nav-login-btn .nav-login-text { display: none; }
            .nav-login-btn { padding: 8px 12px; }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="page-background"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <div class="nav-logo">CAPEX</div>
                <div>
                    <div class="nav-title">CAPEX Calculator</div>
                    <div class="nav-subtitle">Capital Expenditure Analysis</div>
                </div>
            </a>
            <div class="nav-links">
                <a href="datacenter-solutions.html" class="nav-link">DC Solutions</a>
                <a href="datahallAI.html" class="nav-link" style="color: #8b5cf6;">DC AI/HPC</a>
                <a href="dc-conventional.html" class="nav-link">DC Conventional</a>
                <a href="opex-calculator.html" class="nav-link" style="color: #10b981;">OPEX Calc</a>
                <a href="tia-942-checklist.html" class="nav-link" style="color: #10b981;">TIA-942</a>
                <!-- Auth Button -->
                <div class="nav-auth-wrap" id="navAuthWrap">
                    <button class="nav-login-btn" id="navLoginBtn" onclick="handlePremiumTab()">
                        <i class="fas fa-user-circle"></i>
                        <span class="nav-login-text">Login</span>
                    </button>
                    <button class="nav-user-btn" id="navUserBtn" style="display:none;" onclick="toggleUserDropdown()">
                        <div class="nav-user-avatar" id="navUserAvatar">U</div>
                        <span class="nav-user-email" id="navUserEmail"></span>
                        <i class="fas fa-chevron-down nav-user-chevron"></i>
                    </button>
                    <div class="nav-user-dropdown" id="navUserDropdown">
                        <div class="nav-dd-header">
                            <div class="nav-dd-tier-badge" id="navDdTierBadge">PRO</div>
                            <div class="nav-dd-email" id="navDdEmail"></div>
                        </div>
                        <button class="nav-dd-logout" onclick="logoutPremium()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                <a href="index.html" class="nav-back">
                    <i class="fas fa-arrow-left"></i>
                    Portfolio
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="main-content">
        <!-- Hero -->
        <section class="hero">
            <div class="hero-badge">
                <i class="fas fa-calculator"></i>
                Capital Expenditure Analysis
            </div>
            <h1>Data Center CAPEX Calculator</h1>
            <p>Calculate comprehensive construction costs with detailed breakdown of electrical, cooling, civil, and infrastructure components</p>
        </section>

        <!-- Brief -->
        <section class="brief-section">
            <div class="brief-card">
                <img src="assets/capex-og.jpg" alt="Data Center CAPEX Calculator â€” capital expenditure breakdown for construction, electrical, cooling, and infrastructure" class="brief-hero-img" loading="eager">
                <p class="brief-lead">Building a data center is not a spreadsheet exercise &mdash; it's a bet worth millions where every wrong assumption compounds.</p>
                <p class="brief-body">A 10 MW facility can swing between $80M and $200M+ depending on cooling architecture, redundancy tier, seismic zone, and dozens of other variables most cost models quietly ignore. This calculator won't replace a detailed engineering estimate &mdash; but it will give you a defensible starting point in under 60 seconds. Adjust IT load, pick your cooling strategy, set your redundancy level, and watch how each decision moves the total. Use it to sanity-check vendor quotes, benchmark across regions, or build a rough business case before the first shovel hits the ground.</p>
                <div class="brief-stats">
                    <span class="brief-stat"><i class="fas fa-sliders-h"></i> 12+ configurable variables</span>
                    <span class="brief-stat"><i class="fas fa-globe-americas"></i> Location factor adjustments</span>
                    <span class="brief-stat"><i class="fas fa-layer-group"></i> Tier I &ndash; IV redundancy</span>
                    <span class="brief-stat"><i class="fas fa-snowflake"></i> 4 cooling architectures</span>
                </div>
                <p class="brief-note">General-purpose estimate &mdash; actual costs depend on site-specific engineering, local regulations, and procurement strategy. Need a deeper analysis? Let's talk.</p>
            </div>
        </section>

        <!-- Calculator -->
        <section class="calculator-section">
            <!-- Mode Tabs -->
            <div id="capexModeTabs" style="display:flex;gap:0.5rem;margin-bottom:1.5rem;flex-wrap:wrap;align-items:center;max-width:1400px;margin-left:auto;margin-right:auto;">
                <button type="button" class="capex-mode-btn active" data-mode="simple" onclick="switchCapexMode('simple')" style="padding:0.6rem 1.2rem;border-radius:10px;border:1px solid rgba(245,158,11,0.4);background:rgba(245,158,11,0.15);color:#f59e0b;cursor:pointer;font-weight:600;font-size:0.9rem;font-family:inherit;transition:all 0.3s;">
                    <i class="fas fa-sliders-h" style="margin-right:6px;"></i>Simple
                </button>
                <button type="button" class="capex-mode-btn" data-mode="advanced" onclick="switchCapexMode('advanced')" style="padding:0.6rem 1.2rem;border-radius:10px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:#94a3b8;cursor:pointer;font-weight:500;font-size:0.9rem;font-family:inherit;transition:all 0.3s;">
                    <i class="fas fa-cogs" style="margin-right:6px;"></i>Advanced
                </button>
                <!-- Separator + Premium button (right-aligned) -->
                <div style="margin-left:auto;display:flex;align-items:center;gap:0.5rem;">
                    <span id="premiumBadge" style="display:none;padding:4px 12px;border-radius:50px;background:linear-gradient(135deg,#8b5cf6,#a855f7);color:white;font-size:0.7rem;font-weight:700;letter-spacing:0.5px;">PRO ACTIVE</span>
                    <button type="button" id="premiumTabBtn" onclick="handlePremiumTab()" style="padding:0.6rem 1.4rem;border-radius:10px;border:1px solid rgba(168,85,247,0.6);background:linear-gradient(135deg,#7c3aed,#a855f7);color:white;cursor:pointer;font-weight:700;font-size:0.9rem;font-family:inherit;transition:all 0.3s;box-shadow:0 2px 12px rgba(139,92,246,0.35);position:relative;overflow:hidden;">
                        <i class="fas fa-crown" style="margin-right:6px;"></i>Premium
                    </button>
                </div>
            </div>

            <!-- Login Modal -->
            <div id="loginModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);z-index:99999;align-items:center;justify-content:center;">
                <div style="background:white;border-radius:20px;padding:2.5rem;max-width:420px;width:90%;box-shadow:0 25px 60px rgba(0,0,0,0.3);position:relative;animation:modalSlideIn 0.3s ease;">
                    <button onclick="closeLoginModal()" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:1.2rem;color:#94a3b8;cursor:pointer;padding:4px;">&times;</button>
                    <div style="text-align:center;margin-bottom:1.5rem;">
                        <div style="width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,#8b5cf6,#a855f7);display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;">
                            <i class="fas fa-crown" style="color:white;font-size:1.3rem;"></i>
                        </div>
                        <h3 style="font-size:1.3rem;font-weight:700;color:#1e293b;margin-bottom:0.25rem;">Premium Access</h3>
                        <p style="font-size:0.85rem;color:#64748b;">Login to unlock all premium features</p>
                    </div>
                    <div id="loginError" style="display:none;padding:10px 14px;border-radius:8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#dc2626;font-size:0.8rem;margin-bottom:1rem;text-align:center;">
                        Invalid credentials
                    </div>
                    <div style="display:flex;flex-direction:column;gap:1rem;">
                        <div>
                            <label style="display:block;font-size:0.8rem;font-weight:600;color:#475569;margin-bottom:6px;">Email</label>
                            <input type="email" id="loginEmail" placeholder="your@email.com" style="width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.95rem;font-family:inherit;outline:none;transition:border-color 0.3s;" onfocus="this.style.borderColor='#8b5cf6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display:block;font-size:0.8rem;font-weight:600;color:#475569;margin-bottom:6px;">Password</label>
                            <input type="password" id="loginPassword" placeholder="Enter password" style="width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.95rem;font-family:inherit;outline:none;transition:border-color 0.3s;" onfocus="this.style.borderColor='#8b5cf6'" onblur="this.style.borderColor='#e2e8f0'" onkeydown="if(event.key==='Enter')attemptLogin()">
                        </div>
                        <button onclick="attemptLogin()" style="padding:12px;border-radius:10px;border:none;background:linear-gradient(135deg,#8b5cf6,#a855f7);color:white;font-size:0.95rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 12px rgba(139,92,246,0.3);" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-unlock" style="margin-right:8px;"></i>Unlock Premium
                        </button>
                    </div>
                    <div style="text-align:center;margin-top:1.25rem;padding-top:1rem;border-top:1px solid #f1f5f9;">
                        <p style="font-size:0.75rem;color:#94a3b8;">PRO features: Full breakdown, $/kW benchmark, PDF export, Scenario compare, Premium articles &amp; analysis</p>
                        <a href="https://bagus-dwi-permana.myr.id/membership/resistancezero-pro" target="_blank" style="display:inline-block;margin-top:8px;font-size:0.78rem;color:#8b5cf6;text-decoration:none;font-weight:600;">Don't have an account? Subscribe to PRO &rarr;</a>
                        <div style="margin-top:12px;padding:10px 12px;border-radius:8px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2);font-size:0.78rem;color:#64748b;line-height:1.6;">
                            <span style="color:#8b5cf6;font-weight:600;">Demo Account:</span><br>
                            <code style="background:rgba(139,92,246,0.1);padding:2px 6px;border-radius:4px;font-size:0.75rem;color:#7c3aed;">demo@resistancezero.com</code> / <code style="background:rgba(139,92,246,0.1);padding:2px 6px;border-radius:4px;font-size:0.75rem;color:#7c3aed;">demo2026</code>
                        </div>
                        <p style="font-size:0.68rem;color:#64748b;margin-top:12px;line-height:1.5;">By clicking Login, you agree to our <a href="terms.html" target="_blank" style="color:#8b5cf6;text-decoration:underline;">Terms of Service</a> and <a href="privacy.html" target="_blank" style="color:#8b5cf6;text-decoration:underline;">Privacy Policy</a>.</p>
                    </div>
                </div>
            </div>
            <style>
                @keyframes modalSlideIn { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
                @keyframes premiumGlow { 0%,100% { box-shadow:0 2px 12px rgba(139,92,246,0.35); } 50% { box-shadow:0 2px 20px rgba(139,92,246,0.55); } }
                #premiumTabBtn { animation: premiumGlow 2.5s ease-in-out infinite; }
                #premiumTabBtn:hover { transform:translateY(-2px); box-shadow:0 4px 24px rgba(139,92,246,0.5) !important; filter:brightness(1.1); }
                #premiumTabBtn.premium-active { animation:none !important; background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(168,85,247,0.15)) !important; color:#c4b5fd !important; border-color:rgba(139,92,246,0.5) !important; box-shadow:0 2px 8px rgba(139,92,246,0.2) !important; }
                #premiumTabBtn.premium-active:hover { transform:translateY(-1px); }

                /* Feature Gating Styles */
                .gated-overlay {
                    position: relative;
                    cursor: pointer;
                }
                .gated-overlay::after {
                    content: '';
                    position: absolute;
                    top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(15, 23, 42, 0.6);
                    backdrop-filter: blur(6px);
                    -webkit-backdrop-filter: blur(6px);
                    border-radius: inherit;
                    z-index: 10;
                }
                .gated-overlay::before {
                    content: '\f521';
                    font-family: 'Font Awesome 5 Free';
                    font-weight: 900;
                    position: absolute;
                    top: 50%; left: 50%;
                    transform: translate(-50%, -50%);
                    color: #a78bfa;
                    font-size: 1.2rem;
                    z-index: 11;
                    text-shadow: 0 2px 8px rgba(139,92,246,0.5);
                }
                .gated-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 4px;
                    padding: 2px 8px;
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(168,85,247,0.1));
                    border: 1px solid rgba(139,92,246,0.3);
                    color: #a78bfa;
                    font-size: 0.65rem;
                    font-weight: 700;
                    letter-spacing: 0.5px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                .gated-badge:hover {
                    background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(168,85,247,0.2));
                    transform: translateY(-1px);
                }
                .gated-btn {
                    opacity: 0.5;
                    pointer-events: none;
                    position: relative;
                }
                .gated-btn.clickable {
                    opacity: 0.7;
                    pointer-events: auto;
                    cursor: pointer;
                }
                .free-watermark {
                    text-align: center;
                    padding: 8px 16px;
                    margin-top: 0.75rem;
                    border-radius: 8px;
                    background: rgba(139, 92, 246, 0.08);
                    border: 1px dashed rgba(139, 92, 246, 0.25);
                    font-size: 0.7rem;
                    color: #a78bfa;
                    letter-spacing: 0.3px;
                }
                .cost-value-hidden {
                    filter: blur(5px);
                    user-select: none;
                    pointer-events: none;
                }

                /* Action button hover effects */
                .action-btn-save:hover { transform: translateY(-2px); box-shadow: 0 4px 18px rgba(245,158,11,0.35) !important; border-color: rgba(251,191,36,0.8) !important; }
                .action-btn-pdf:hover { transform: translateY(-2px); box-shadow: 0 4px 18px rgba(239,68,68,0.3) !important; border-color: rgba(239,68,68,0.7) !important; }

                /* Print / PDF Styles */
                @media print {
                    body { background: white !important; color: #1e293b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    .navbar, .hero, .brief-section, #capexModeTabs, #loginModal, .nav-back, footer,
                    #freeWatermark, #btnSaveA, #btnExportPDF, #btnClearCompare, #scenarioBBanner,
                    .tooltip-trigger, .gated-badge { display: none !important; }
                    .main-content { padding-top: 0 !important; }
                    .calculator-section { padding: 0 !important; }
                    .simulator-container { display: block !important; max-width: 100% !important; }
                    .simulator-inputs { margin-bottom: 2rem; }
                    .simulator-results { background: #f8fafc !important; color: #1e293b !important; border: 1px solid #e2e8f0; }
                    .results-header { background: linear-gradient(135deg, #1e3a5f, #2d5a87) !important; }
                    .cost-item { border-color: #e2e8f0 !important; }
                    .cost-value, .cost-percent { color: #334155 !important; filter: none !important; }
                    .cost-name { color: #475569 !important; }
                    #premiumOutput { display: flex !important; }
                    #premiumOutput > div { border-color: #e2e8f0 !important; background: #f8fafc !important; }
                    .gated-overlay::after, .gated-overlay::before { display: none !important; }
                    .cost-value-hidden { filter: none !important; user-select: auto !important; }
                    @page { margin: 1cm; size: A4; }
                }
            </style>

            <div class="simulator-container">
                <!-- Input Side -->
                <div class="simulator-inputs">
                    <!-- Scenario B indicator (shown after Save Scenario A) -->
                    <div id="scenarioBBanner" style="display:none;padding:10px 16px;border-radius:10px;background:linear-gradient(135deg,rgba(52,211,153,0.15),rgba(16,185,129,0.08));border:1.5px solid rgba(16,185,129,0.4);margin-bottom:0.75rem;display:none;align-items:center;gap:10px;">
                        <span style="width:28px;height:28px;border-radius:8px;background:rgba(52,211,153,0.2);color:#34d399;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;flex-shrink:0;">B</span>
                        <div>
                            <div style="font-size:0.85rem;font-weight:600;color:#059669;">Scenario B Input</div>
                            <div style="font-size:0.72rem;color:#6b7280;">Modify the inputs below to configure Scenario B for comparison</div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-bolt"></i> IT Load (kW)
                                <span class="tooltip-trigger">?
                                    <div class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-bolt"></i> IT Load (kW)</div>
                                        <div class="tooltip-desc">Total power consumption of all IT equipment including servers, storage arrays, and network devices.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Category</th><th>Range</th></tr>
                                            <tr><td>Small / Edge</td><td>100-500 kW</td></tr>
                                            <tr><td>Medium</td><td>500-2,000 kW</td></tr>
                                            <tr><td>Large</td><td>2-10 MW</td></tr>
                                            <tr><td>Hyperscale</td><td>10+ MW</td></tr>
                                        </table>
                                    </div>
                                </span>
                            </label>
                            <input type="number" class="input-field" id="itLoad" value="1000" min="100" max="100000">
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-gas-pump"></i> Fuel Autonomy (hours)
                                <span class="tooltip-trigger">?
                                    <div class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-gas-pump"></i> Fuel Autonomy</div>
                                        <div class="tooltip-desc">Duration generators can operate without refueling during utility power outage.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Tier Level</th><th>Typical Hours</th></tr>
                                            <tr><td>Minimum</td><td>8 hours</td></tr>
                                            <tr><td>Standard</td><td>24 hours</td></tr>
                                            <tr><td>Tier III</td><td>48 hours</td></tr>
                                            <tr><td>Mission Critical</td><td>72+ hours</td></tr>
                                        </table>
                                    </div>
                                </span>
                            </label>
                            <input type="number" class="input-field" id="fuelHours" value="48" min="8" max="168">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-building"></i> Building Type
                                <span class="tooltip-trigger">?
                                    <div class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-building"></i> Building Type</div>
                                        <div class="tooltip-desc">The type of structure affects construction costs significantly. Purpose-built facilities are optimized for data centers.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Type</th><th>Cost Factor</th></tr>
                                            <tr><td>Warehouse Conversion</td><td>0.70x (lowest)</td></tr>
                                            <tr><td>Modular / Prefab</td><td>0.85x</td></tr>
                                            <tr><td>Purpose-Built</td><td>1.00x (baseline)</td></tr>
                                            <tr><td>High-Rise Multi-Story</td><td>1.40x (highest)</td></tr>
                                        </table>
                                    </div>
                                </span>
                            </label>
                            <select class="input-field" id="buildingType">
                                <option value="warehouse">Warehouse Conversion (0.70x)</option>
                                <option value="modular">Modular / Prefab (0.85x)</option>
                                <option value="purpose" selected>Purpose-Built (1.00x)</option>
                                <option value="highrise">High-Rise Multi-Story (1.40x)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-mountain"></i> Seismic Zone
                                <span class="tooltip-trigger">?
                                    <div class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-mountain"></i> Seismic Zone</div>
                                        <div class="tooltip-desc">Earthquake risk zones require additional structural reinforcement. Indonesia is typically Zone 2-4.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Zone</th><th>Cost Impact</th></tr>
                                            <tr><td>Zone 0 - No Risk</td><td>+0%</td></tr>
                                            <tr><td>Zone 1 - Low</td><td>+3%</td></tr>
                                            <tr><td>Zone 2 - Moderate</td><td>+6%</td></tr>
                                            <tr><td>Zone 3 - High</td><td>+10%</td></tr>
                                            <tr><td>Zone 4 - Very High</td><td>+15%</td></tr>
                                        </table>
                                    </div>
                                </span>
                            </label>
                            <select class="input-field" id="seismicZone">
                                <option value="zone0">Zone 0 - No Seismic Risk</option>
                                <option value="zone1">Zone 1 - Low Risk</option>
                                <option value="zone2" selected>Zone 2 - Moderate Risk</option>
                                <option value="zone3">Zone 3 - High Risk</option>
                                <option value="zone4">Zone 4 - Very High Risk</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-server"></i> Rack Density
                            <span class="tooltip-trigger">?
                                <div class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-server"></i> Rack Density</div>
                                    <div class="tooltip-desc">Power consumption per rack affects cooling requirements and infrastructure costs. AI/HPC racks require specialized cooling.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Density</th><th>Cooling Needs</th></tr>
                                        <tr><td>Standard (5-7 kW)</td><td>Air cooling adequate</td></tr>
                                        <tr><td>Medium (10-15 kW)</td><td>Enhanced airflow</td></tr>
                                        <tr><td>High (20-30 kW)</td><td>In-row or RDHX required</td></tr>
                                        <tr><td>AI/HPC (50-100 kW)</td><td>Direct liquid cooling</td></tr>
                                    </table>
                                </div>
                            </span>
                        </label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="rackType" id="rackStd" value="standard" checked>
                                <label for="rackStd">Standard<small>5-7 kW</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="rackType" id="rackMid" value="medium">
                                <label for="rackMid">Medium<small>10-15 kW</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="rackType" id="rackHigh" value="high">
                                <label for="rackHigh">High Density<small>20-30 kW</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="rackType" id="rackAI" value="ai">
                                <label for="rackAI">AI/HPC<small>50-100 kW</small></label>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-snowflake"></i> Cooling Type
                            <span class="tooltip-trigger">?
                                <div class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-snowflake"></i> Cooling Type</div>
                                    <div class="tooltip-desc">Cooling technology affects both CAPEX and operational efficiency. Higher density requires more advanced cooling.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Type</th><th>Best For</th></tr>
                                        <tr><td>Air (CRAC/CRAH)</td><td>Standard &lt;10 kW/rack</td></tr>
                                        <tr><td>In-Row Precision</td><td>Medium 10-20 kW/rack</td></tr>
                                        <tr><td>RDHX (Rear Door)</td><td>High 20-40 kW/rack</td></tr>
                                        <tr><td>DLC (Direct Liquid)</td><td>AI/HPC 50+ kW/rack</td></tr>
                                    </table>
                                </div>
                            </span>
                        </label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="coolingType" id="coolAir" value="air" checked>
                                <label for="coolAir">Air<small>CRAC/CRAH</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="coolingType" id="coolInrow" value="inrow">
                                <label for="coolInrow">In-Row<small>Precision</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="coolingType" id="coolRDHX" value="rdhx">
                                <label for="coolRDHX">RDHX<small>Rear Door</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="coolingType" id="coolLiquid" value="liquid">
                                <label for="coolLiquid">DLC<small>Direct Liquid</small></label>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-shield-alt"></i> Redundancy
                            <span class="tooltip-trigger">?
                                <div class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-shield-alt"></i> Redundancy Level</div>
                                    <div class="tooltip-desc">Higher redundancy = higher uptime but significantly more cost. 2N doubles infrastructure.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Level</th><th>Uptime SLA</th></tr>
                                        <tr><td>N (Basic)</td><td>99.671% (~28.8hr/yr)</td></tr>
                                        <tr><td>N+1 (Standard)</td><td>99.982% (~1.6hr/yr)</td></tr>
                                        <tr><td>2N (Full)</td><td>99.995% (~26min/yr)</td></tr>
                                        <tr><td>2N+1 (Premium)</td><td>99.9995% (~2.6min/yr)</td></tr>
                                    </table>
                                </div>
                            </span>
                        </label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="redundancy" id="redN" value="n">
                                <label for="redN">N<small>Basic</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="redundancy" id="redN1" value="n1" checked>
                                <label for="redN1">N+1<small>Standard</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="redundancy" id="red2N" value="2n">
                                <label for="red2N">2N<small>Full</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="redundancy" id="red2N1" value="2n1">
                                <label for="red2N1">2N+1<small>Premium</small></label>
                            </div>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-fire-extinguisher"></i> Fire Suppression
                                <span class="tooltip-trigger">?
                                    <div class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-fire-extinguisher"></i> Fire Suppression</div>
                                        <div class="tooltip-desc">Clean agent fire suppression systems that don't damage IT equipment.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Agent</th><th>Notes</th></tr>
                                            <tr><td>FM200/HFC-227ea</td><td>Common, being phased out</td></tr>
                                            <tr><td>Novec 1230</td><td>Low GWP, safest choice</td></tr>
                                            <tr><td>Inergen (IG-541)</td><td>Inert gas, unlimited</td></tr>
                                            <tr><td>Nitrogen Inerting</td><td>For sealed rooms</td></tr>
                                            <tr><td>Water Mist</td><td>Green alternative</td></tr>
                                        </table>
                                    </div>
                                </span>
                            </label>
                            <select class="input-field" id="fireType">
                                <option value="fm200">FM200 / HFC-227ea</option>
                                <option value="novec" selected>Novec 1230</option>
                                <option value="inergen">Inergen (IG-541)</option>
                                <option value="n2">Nitrogen Inerting</option>
                                <option value="water">Water Mist</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-bell"></i> Fire Alarm System
                                <span class="tooltip-trigger">?
                                    <div class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-bell"></i> Fire Alarm System</div>
                                        <div class="tooltip-desc">Early detection is critical for data centers. VESDA provides earliest warning.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Type</th><th>Detection Time</th></tr>
                                            <tr><td>Conventional</td><td>Late stage smoke</td></tr>
                                            <tr><td>Addressable</td><td>Point location ID</td></tr>
                                            <tr><td>VESDA</td><td>Pre-combustion</td></tr>
                                            <tr><td>Hybrid</td><td>Best of both</td></tr>
                                        </table>
                                    </div>
                                </span>
                            </label>
                            <select class="input-field" id="alarmType">
                                <option value="conventional">Conventional</option>
                                <option value="addressable" selected>Addressable</option>
                                <option value="vesda">VESDA (Aspirating)</option>
                                <option value="hybrid">Hybrid VESDA + Addressable</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-battery-full"></i> UPS Type
                                <span class="tooltip-trigger">?
                                    <div class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-battery-full"></i> UPS Type</div>
                                        <div class="tooltip-desc">Uninterruptible Power Supply provides backup during generator startup (10-15 seconds).</div>
                                        <table class="tooltip-table">
                                            <tr><th>Type</th><th>Best For</th></tr>
                                            <tr><td>Standalone</td><td>Small, fixed capacity</td></tr>
                                            <tr><td>Modular</td><td>Scalable, N+1 within</td></tr>
                                            <tr><td>Distributed/Rack</td><td>Edge, distributed</td></tr>
                                            <tr><td>Rotary UPS</td><td>Ultra-reliable, diesel</td></tr>
                                        </table>
                                    </div>
                                </span>
                            </label>
                            <select class="input-field" id="upsType">
                                <option value="standalone">Standalone</option>
                                <option value="modular" selected>Modular</option>
                                <option value="distributed">Distributed / Rack</option>
                                <option value="rotary">Rotary UPS</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <i class="fas fa-plug"></i> Generator Type
                                <span class="tooltip-trigger">?
                                    <div class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-plug"></i> Generator Type</div>
                                        <div class="tooltip-desc">Backup power generation fuel type affects maintenance and sustainability.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Fuel</th><th>Notes</th></tr>
                                            <tr><td>Diesel</td><td>Standard, reliable</td></tr>
                                            <tr><td>Natural Gas</td><td>Lower emissions</td></tr>
                                            <tr><td>Dual Fuel</td><td>Flexibility</td></tr>
                                            <tr><td>HVO/Biodiesel</td><td>90% lower CO2</td></tr>
                                        </table>
                                    </div>
                                </span>
                            </label>
                            <select class="input-field" id="genType">
                                <option value="diesel" selected>Diesel</option>
                                <option value="gas">Natural Gas</option>
                                <option value="dualfuel">Dual Fuel</option>
                                <option value="hvo">HVO / Biodiesel</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <i class="fas fa-map-marker-alt"></i> Location Factor
                            <span class="tooltip-trigger">?
                                <div class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-map-marker-alt"></i> Location Factor</div>
                                    <div class="tooltip-desc">Regional cost multiplier based on labor rates, materials, and logistics costs.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Region</th><th>Multiplier</th></tr>
                                        <tr><td>India</td><td>0.55x (lowest)</td></tr>
                                        <tr><td>SE Asia (Indonesia)</td><td>0.65x</td></tr>
                                        <tr><td>China</td><td>0.70x</td></tr>
                                        <tr><td>USA (baseline)</td><td>1.00x</td></tr>
                                        <tr><td>Europe</td><td>1.15x (highest)</td></tr>
                                    </table>
                                </div>
                            </span>
                        </label>
                        <select class="input-field" id="locationFactor">
                            <option value="sea">Southeast Asia - Indonesia, Malaysia (0.65x)</option>
                            <option value="india">India (0.55x)</option>
                            <option value="china">China (0.70x)</option>
                            <option value="japan">Japan / Korea (1.10x)</option>
                            <option value="australia">Australia (1.05x)</option>
                            <option value="europe">Europe (1.15x)</option>
                            <option value="usa" selected>USA (1.00x)</option>
                        </select>
                    </div>

                    <!-- â•â•â• ADVANCED MODE SECTIONS (hidden by default) â•â•â• -->
                    <div id="advancedInputs" style="display:none;flex-direction:column;gap:1.5rem;">

                        <!-- A. Year & City/Market -->
                        <div style="border-top:1px solid rgba(245,158,11,0.2);padding-top:1.5rem;margin-top:0.5rem;">
                            <div style="font-size:0.8rem;font-weight:700;color:#f59e0b;text-transform:uppercase;letter-spacing:1px;margin-bottom:1rem;display:flex;align-items:center;gap:8px;">
                                <i class="fas fa-calendar-alt"></i> Year & Market Location
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-calendar"></i> Projection Year
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-calendar"></i> Year Escalation</div>
                                                <div class="tooltip-desc">Cost escalation based on industry trends. 7% CAGR 2020-2025 (T&T), decelerating as supply chains normalize.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Year</th><th>Multiplier</th></tr>
                                                    <tr><td>2025 (baseline)</td><td>1.000x</td></tr>
                                                    <tr><td>2026</td><td>1.060x (+6.0%)</td></tr>
                                                    <tr><td>2027</td><td>1.115x (+5.5%)</td></tr>
                                                    <tr><td>2028</td><td>1.165x (+4.5%)</td></tr>
                                                    <tr><td>2029</td><td>1.210x (+3.8%)</td></tr>
                                                    <tr><td>2030</td><td>1.250x (+3.3%)</td></tr>
                                                </table>
                                                <div class="tooltip-impact">Sources: JLL 2026 Outlook, Turner & Townsend DCCI 2025, Avid Solutions 2026-2030 projections</div>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="projYear">
                                        <option value="2025" selected>2025 (Baseline)</option>
                                        <option value="2026">2026 (+6.0%)</option>
                                        <option value="2027">2027 (+5.2%)</option>
                                        <option value="2028">2028 (+4.5%)</option>
                                        <option value="2029">2029 (+3.9%)</option>
                                        <option value="2030">2030 (+3.3%)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-city"></i> City / Market
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-city"></i> City-Specific $/W Cost</div>
                                                <div class="tooltip-desc">Construction cost per watt based on specific metro area. Replaces generic Location Factor when selected.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>City</th><th>$/W (2025)</th></tr>
                                                    <tr><td>Tokyo</td><td>$15.20</td></tr>
                                                    <tr><td>Singapore</td><td>$14.53</td></tr>
                                                    <tr><td>Silicon Valley</td><td>$13.30</td></tr>
                                                    <tr><td>Dallas, TX</td><td>$14.30</td></tr>
                                                    <tr><td>Mumbai</td><td>$6.64</td></tr>
                                                </table>
                                                <div class="tooltip-impact">Sources: Turner & Townsend DCCI 2025, Cushman & Wakefield Cost Guide 2025</div>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="cityMarket">
                                        <option value="none">-- Use Location Factor above --</option>
                                        <optgroup label="Americas">
                                            <option value="silicon_valley">Silicon Valley â€” $13.30/W</option>
                                            <option value="new_jersey">New Jersey / NYC â€” $12.90/W</option>
                                            <option value="virginia">Virginia / NOVA â€” $13.40/W</option>
                                            <option value="dallas">Dallas, TX â€” $14.30/W</option>
                                            <option value="phoenix">Phoenix, AZ â€” $13.40/W</option>
                                            <option value="chicago">Chicago, IL â€” $13.20/W</option>
                                            <option value="san_antonio">San Antonio, TX â€” $9.30/W</option>
                                        </optgroup>
                                        <optgroup label="Europe">
                                            <option value="london">London â€” $12.00/W</option>
                                            <option value="frankfurt">Frankfurt â€” $11.60/W</option>
                                            <option value="amsterdam">Amsterdam â€” $11.80/W</option>
                                            <option value="stockholm">Stockholm â€” $10.50/W</option>
                                            <option value="lisbon">Lisbon â€” $10.80/W</option>
                                        </optgroup>
                                        <optgroup label="Asia Pacific">
                                            <option value="tokyo">Tokyo â€” $15.20/W</option>
                                            <option value="singapore">Singapore â€” $14.53/W</option>
                                            <option value="hong_kong">Hong Kong â€” $13.80/W</option>
                                            <option value="seoul">Seoul â€” $9.50/W</option>
                                            <option value="sydney">Sydney â€” $12.30/W</option>
                                            <option value="malaysia">Malaysia / Johor â€” $11.37/W</option>
                                            <option value="jakarta">Jakarta â€” $11.21/W</option>
                                            <option value="mumbai">Mumbai â€” $6.64/W</option>
                                            <option value="bangkok">Bangkok â€” $8.50/W</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- B. Front-of-Meter / Utility Interconnection -->
                        <div style="border-top:1px solid rgba(59,130,246,0.2);padding-top:1.5rem;">
                            <div style="font-size:0.8rem;font-weight:700;color:#3b82f6;text-transform:uppercase;letter-spacing:1px;margin-bottom:1rem;display:flex;align-items:center;gap:8px;">
                                <i class="fas fa-plug"></i> Front-of-Meter / Utility
                            </div>
                            <div class="input-group" style="margin-bottom:1rem;">
                                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:0.9rem;font-weight:500;color:var(--text-secondary);">
                                    <input type="checkbox" id="includeFOM" style="width:18px;height:18px;accent-color:#3b82f6;cursor:pointer;">
                                    Include Front-of-Meter Costs
                                    <span class="tooltip-trigger">?
                                        <div class="tooltip-content">
                                            <div class="tooltip-title"><i class="fas fa-plug"></i> Front-of-Meter</div>
                                            <div class="tooltip-desc">Costs for grid interconnection, substation, transformer, switchgear â€” typically borne by data center operator per utility agreement.</div>
                                            <div class="tooltip-impact">Per Mark Lewis (VP Engineering): "Don't forget front-of-meter â€” transformer, substation, switchgear, and utility's 9% return on investment."</div>
                                        </div>
                                    </span>
                                </label>
                            </div>
                            <div id="fomInputs" style="display:none;flex-direction:column;gap:1rem;">
                                <div class="input-row">
                                    <div class="input-group">
                                        <label class="input-label"><i class="fas fa-industry"></i> Substation Type</label>
                                        <select class="input-field" id="substationType">
                                            <option value="shared">Shared Utility ($0.5-1.5M)</option>
                                            <option value="dedicated_33kv" selected>Dedicated 33kV ($3-5M)</option>
                                            <option value="dedicated_132kv">Dedicated 132kV+ ($5-10M+)</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label"><i class="fas fa-bolt"></i> Transformer Lead Time</label>
                                        <select class="input-field" id="transformerLead">
                                            <option value="standard" selected>Standard (18-24 mo)</option>
                                            <option value="extended">Extended (24-36 mo, +15%)</option>
                                            <option value="emergency">Emergency (expedited, +30%)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label class="input-label"><i class="fas fa-percentage"></i> Utility Rate of Return: <span id="utilRateVal" style="color:#3b82f6;font-family:'JetBrains Mono',monospace;">9%</span></label>
                                    <input type="range" id="utilityRate" min="7" max="12" value="9" step="0.5" style="width:100%;accent-color:#3b82f6;">
                                </div>
                            </div>
                        </div>

                        <!-- C. Vendor & Market Factors -->
                        <div style="border-top:1px solid rgba(139,92,246,0.2);padding-top:1.5rem;">
                            <div style="font-size:0.8rem;font-weight:700;color:#8b5cf6;text-transform:uppercase;letter-spacing:1px;margin-bottom:1rem;display:flex;align-items:center;gap:8px;">
                                <i class="fas fa-handshake"></i> Vendor & Market Factors
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-chart-line"></i> Market Conditions
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-chart-line"></i> Market Conditions</div>
                                                <div class="tooltip-desc">Current supply-demand dynamics affect pricing. Seller's market = contractors charge premiums due to high demand.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Condition</th><th>Impact</th></tr>
                                                    <tr><td>Buyer's Market</td><td>-5% (overcapacity)</td></tr>
                                                    <tr><td>Balanced</td><td>0% (baseline)</td></tr>
                                                    <tr><td>Seller's Market</td><td>+10% (high demand)</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="marketCondition">
                                        <option value="buyer">Buyer's Market (-5%)</option>
                                        <option value="balanced" selected>Balanced (0%)</option>
                                        <option value="seller">Seller's Market (+10%)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-truck"></i> Delivery Method
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-truck"></i> Delivery Method</div>
                                                <div class="tooltip-desc">Project delivery approach affects cost structure and timeline.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Method</th><th>Impact</th></tr>
                                                    <tr><td>Design-Bid-Build</td><td>Baseline</td></tr>
                                                    <tr><td>Design-Build</td><td>-3% (integrated)</td></tr>
                                                    <tr><td>Modular-Prefab</td><td>-8% (factory-built)</td></tr>
                                                    <tr><td>EPC Turnkey</td><td>+5% (single source)</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="deliveryMethod">
                                        <option value="dbb" selected>Design-Bid-Build (baseline)</option>
                                        <option value="db">Design-Build (-3%)</option>
                                        <option value="modular">Modular-Prefab (-8%)</option>
                                        <option value="epc">EPC Turnkey (+5%)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group" style="margin-top:1rem;">
                                <label class="input-label">
                                    <i class="fas fa-hard-hat"></i> Contractor Availability
                                    <span class="tooltip-trigger">?
                                        <div class="tooltip-content">
                                            <div class="tooltip-title"><i class="fas fa-hard-hat"></i> Contractor Availability</div>
                                            <div class="tooltip-desc">Labor market tightness. Per Matt Pacione: location-specific labor costs drive significant variance.</div>
                                            <table class="tooltip-table">
                                                <tr><th>Availability</th><th>Premium</th></tr>
                                                <tr><td>High Availability</td><td>+0%</td></tr>
                                                <tr><td>Normal</td><td>+3%</td></tr>
                                                <tr><td>Tight Market</td><td>+8%</td></tr>
                                            </table>
                                        </div>
                                    </span>
                                </label>
                                <select class="input-field" id="contractorAvail">
                                    <option value="high">High Availability (+0%)</option>
                                    <option value="normal" selected>Normal (+3%)</option>
                                    <option value="tight">Tight Market (+8%)</option>
                                </select>
                            </div>
                        </div>

                        <!-- D. Professional Fees & Soft Costs -->
                        <div style="border-top:1px solid rgba(16,185,129,0.2);padding-top:1.5rem;">
                            <div style="font-size:0.8rem;font-weight:700;color:#10b981;text-transform:uppercase;letter-spacing:1px;margin-bottom:1rem;display:flex;align-items:center;gap:8px;">
                                <i class="fas fa-file-invoice-dollar"></i> Professional Fees & Soft Costs
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label class="input-label"><i class="fas fa-drafting-compass"></i> Design & Engineering: <span id="designFeeVal" style="color:#10b981;font-family:'JetBrains Mono',monospace;">8%</span></label>
                                    <input type="range" id="designFee" min="5" max="12" value="8" step="0.5" style="width:100%;accent-color:#10b981;">
                                </div>
                                <div class="input-group">
                                    <label class="input-label"><i class="fas fa-tasks"></i> Project Management: <span id="pmFeeVal" style="color:#10b981;font-family:'JetBrains Mono',monospace;">5%</span></label>
                                    <input type="range" id="pmFee" min="3" max="8" value="5" step="0.5" style="width:100%;accent-color:#10b981;">
                                </div>
                            </div>
                            <div class="input-group" style="margin-top:1rem;">
                                <label class="input-label"><i class="fas fa-exclamation-triangle"></i> Contingency: <span id="contingencyVal" style="color:#10b981;font-family:'JetBrains Mono',monospace;">10%</span></label>
                                <input type="range" id="contingencyAdv" min="5" max="20" value="10" step="1" style="width:100%;accent-color:#10b981;">
                            </div>
                        </div>

                        <!-- E. Electrical Distribution -->
                        <div style="border-top:1px solid rgba(234,179,8,0.2);padding-top:1.5rem;">
                            <div style="font-size:0.8rem;font-weight:700;color:#eab308;text-transform:uppercase;letter-spacing:1px;margin-bottom:1rem;display:flex;align-items:center;gap:8px;">
                                <i class="fas fa-bolt"></i> Electrical Distribution
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-ethernet"></i> Power Distribution
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-ethernet"></i> Power Distribution Method</div>
                                                <div class="tooltip-desc">How power is distributed from switchgear to PDUs. Busway is standard for large facilities; underground conduit adds civil costs but better for campus layouts.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Method</th><th>Cost Impact</th></tr>
                                                    <tr><td>Overhead Cable Tray</td><td>-8% (cheapest, less flexible)</td></tr>
                                                    <tr><td>Busway</td><td>Baseline (industry standard)</td></tr>
                                                    <tr><td>Underground Conduit</td><td>+15% (cable pits, trenching)</td></tr>
                                                    <tr><td>Mixed (Bus + Underground)</td><td>+8% (campus/multi-building)</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="powerDistribution">
                                        <option value="overhead">Overhead Cable Tray (-8%)</option>
                                        <option value="busway" selected>Busway (standard)</option>
                                        <option value="underground">Underground Conduit (+15%)</option>
                                        <option value="mixed">Mixed Bus + Underground (+8%)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-random"></i> Transformer Type
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-random"></i> MV/LV Transformer</div>
                                                <div class="tooltip-desc">Dry-type is common indoors; oil-filled is cheaper but requires containment and fire separation. Cast-resin is premium indoor option.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Type</th><th>Cost Impact</th></tr>
                                                    <tr><td>Oil-Filled (outdoor)</td><td>-10% (cheapest, needs bund)</td></tr>
                                                    <tr><td>Dry-Type</td><td>Baseline (indoor standard)</td></tr>
                                                    <tr><td>Cast Resin</td><td>+12% (premium, low fire risk)</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="transformerType">
                                        <option value="oil">Oil-Filled Outdoor (-10%)</option>
                                        <option value="dry" selected>Dry-Type Indoor (standard)</option>
                                        <option value="cast_resin">Cast Resin (+12%)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-row" style="margin-top:1rem;">
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-plug"></i> PDU Type
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-plug"></i> Power Distribution Unit</div>
                                                <div class="tooltip-desc">Basic PDUs distribute power only. Intelligent PDUs add per-outlet monitoring, switching, and DCIM integration â€” critical for high-density racks.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Type</th><th>Cost per Rack</th></tr>
                                                    <tr><td>Basic Metered</td><td>~$800/rack</td></tr>
                                                    <tr><td>Intelligent (monitored)</td><td>~$1,500/rack</td></tr>
                                                    <tr><td>Intelligent + Switched</td><td>~$2,500/rack</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="pduType">
                                        <option value="basic">Basic Metered ($800/rack)</option>
                                        <option value="intelligent" selected>Intelligent Monitored ($1,500/rack)</option>
                                        <option value="switched">Intelligent + Switched ($2,500/rack)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-network-wired"></i> Structured Cabling
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-network-wired"></i> Structured Cabling System</div>
                                                <div class="tooltip-desc">Backbone and horizontal cabling type. Fiber backbone with copper drops is standard; all-fiber is premium for high-density/AI facilities.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Type</th><th>Cost per Rack</th></tr>
                                                    <tr><td>Cat6A Copper</td><td>~$600/rack</td></tr>
                                                    <tr><td>Hybrid (Fiber + Cat6A)</td><td>~$1,200/rack</td></tr>
                                                    <tr><td>All-Fiber (OM4/OS2)</td><td>~$2,000/rack</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="cablingType">
                                        <option value="copper">Cat6A Copper ($600/rack)</option>
                                        <option value="hybrid" selected>Hybrid Fiber+Copper ($1,200/rack)</option>
                                        <option value="fiber">All-Fiber OM4/OS2 ($2,000/rack)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- F. Site & Civil -->
                        <div style="border-top:1px solid rgba(244,63,94,0.2);padding-top:1.5rem;">
                            <div style="font-size:0.8rem;font-weight:700;color:#f43f5e;text-transform:uppercase;letter-spacing:1px;margin-bottom:1rem;display:flex;align-items:center;gap:8px;">
                                <i class="fas fa-building"></i> Site & Civil
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-layer-group"></i> Floor Construction
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-layer-group"></i> Raised Floor vs Slab</div>
                                                <div class="tooltip-desc">Raised floor allows under-floor air distribution and cable routing but adds $25-50/sqft. Slab with overhead is increasingly popular for high-density deployments.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Type</th><th>Cost Impact</th></tr>
                                                    <tr><td>Slab (overhead services)</td><td>-5% on building</td></tr>
                                                    <tr><td>Raised Floor 600mm</td><td>Baseline</td></tr>
                                                    <tr><td>Raised Floor 900mm</td><td>+6% on building</td></tr>
                                                    <tr><td>Raised Floor 1200mm</td><td>+12% (high airflow)</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="floorType">
                                        <option value="slab">Slab / Overhead (-5%)</option>
                                        <option value="raised_600" selected>Raised Floor 600mm (standard)</option>
                                        <option value="raised_900">Raised Floor 900mm (+6%)</option>
                                        <option value="raised_1200">Raised Floor 1200mm (+12%)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-hard-hat"></i> Site Condition
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-hard-hat"></i> Site Preparation</div>
                                                <div class="tooltip-desc">Greenfield = raw land needing full civil work. Brownfield = existing industrial site needing some demo. Retrofit = converting existing building.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Condition</th><th>Site Cost</th></tr>
                                                    <tr><td>Greenfield (raw land)</td><td>+5-8% for grading/utilities</td></tr>
                                                    <tr><td>Brownfield</td><td>Baseline</td></tr>
                                                    <tr><td>Retrofit / Conversion</td><td>+10-20% for demo/adaptation</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="siteCondition">
                                        <option value="greenfield">Greenfield (+6%)</option>
                                        <option value="brownfield" selected>Brownfield (standard)</option>
                                        <option value="retrofit">Retrofit / Conversion (+15%)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-row" style="margin-top:1rem;">
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-shield-alt"></i> Security Level
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-shield-alt"></i> Physical Security</div>
                                                <div class="tooltip-desc">Security infrastructure including fencing, CCTV, access control, bollards, mantrap, vehicle barriers, and SOC. Enterprise+ adds biometrics, 24/7 SOC, and anti-vehicle barriers.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Level</th><th>$/kW Impact</th></tr>
                                                    <tr><td>Standard</td><td>Baseline (CCTV+access)</td></tr>
                                                    <tr><td>Enterprise</td><td>+2% (biometric+mantrap)</td></tr>
                                                    <tr><td>High Security</td><td>+5% (SOC+barriers+K12)</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="securityLevel">
                                        <option value="standard" selected>Standard (CCTV + Access Control)</option>
                                        <option value="enterprise">Enterprise (+2% biometric/mantrap)</option>
                                        <option value="high">High Security (+5% SOC/barriers)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-satellite-dish"></i> Fiber Entry
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-satellite-dish"></i> Fiber / Connectivity</div>
                                                <div class="tooltip-desc">Number of diverse fiber entry paths. Dual-diverse is standard for Tier III+. Multi-carrier meet-me room adds connectivity value but costs more.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Entry</th><th>Cost</th></tr>
                                                    <tr><td>Single Path</td><td>~$150K</td></tr>
                                                    <tr><td>Dual Diverse</td><td>~$350K</td></tr>
                                                    <tr><td>Multi-Path + MMR</td><td>~$600K</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="fiberEntry">
                                        <option value="single">Single Path ($150K)</option>
                                        <option value="dual" selected>Dual Diverse ($350K)</option>
                                        <option value="multi">Multi-Path + Meet-Me Room ($600K)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- G. Sustainability & Certification -->
                        <div style="border-top:1px solid rgba(34,197,94,0.2);padding-top:1.5rem;">
                            <div style="font-size:0.8rem;font-weight:700;color:#22c55e;text-transform:uppercase;letter-spacing:1px;margin-bottom:1rem;display:flex;align-items:center;gap:8px;">
                                <i class="fas fa-leaf"></i> Sustainability & Certification
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-certificate"></i> Green Certification
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-certificate"></i> LEED / BREEAM</div>
                                                <div class="tooltip-desc">Green building certification adds 2-8% to construction costs for materials, energy modeling, commissioning, and documentation, but reduces long-term OPEX.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Level</th><th>Cost Premium</th></tr>
                                                    <tr><td>None</td><td>0%</td></tr>
                                                    <tr><td>LEED Silver</td><td>+2%</td></tr>
                                                    <tr><td>LEED Gold</td><td>+4%</td></tr>
                                                    <tr><td>LEED Platinum</td><td>+8%</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="greenCert">
                                        <option value="none" selected>None</option>
                                        <option value="silver">LEED Silver (+2%)</option>
                                        <option value="gold">LEED Gold / BREEAM Very Good (+4%)</option>
                                        <option value="platinum">LEED Platinum / BREEAM Outstanding (+8%)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        <i class="fas fa-solar-panel"></i> On-Site Renewable
                                        <span class="tooltip-trigger">?
                                            <div class="tooltip-content">
                                                <div class="tooltip-title"><i class="fas fa-solar-panel"></i> On-Site Generation</div>
                                                <div class="tooltip-desc">On-site solar PV or battery energy storage (BESS). Reduces grid dependency but adds CAPEX. BESS can also serve as UPS reserve.</div>
                                                <table class="tooltip-table">
                                                    <tr><th>Option</th><th>Cost Addition</th></tr>
                                                    <tr><td>None</td><td>$0</td></tr>
                                                    <tr><td>Rooftop Solar</td><td>~$1.2M/MW</td></tr>
                                                    <tr><td>Solar + BESS</td><td>~$2.5M/MW</td></tr>
                                                </table>
                                            </div>
                                        </span>
                                    </label>
                                    <select class="input-field" id="renewableOption">
                                        <option value="none" selected>None</option>
                                        <option value="solar">Rooftop Solar (~$1.2M/MW)</option>
                                        <option value="solar_bess">Solar + Battery Storage (~$2.5M/MW)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- â•â•â• END ADVANCED MODE â•â•â• -->
                </div>

                <!-- Results Side -->
                <div class="simulator-results">
                    <div class="results-header">
                        <span class="results-title"><i class="fas fa-chart-pie"></i> Cost Breakdown <span id="advInfoBadge" style="display:none;font-size:0.65rem;background:rgba(245,158,11,0.2);color:#fbbf24;padding:2px 8px;border-radius:6px;font-weight:500;margin-left:6px;"></span></span>
                        <div class="results-total">
                            <div class="total-label">Total CAPEX <span class="tooltip-trigger" style="font-size: 0.7rem;">?
                                <div class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-dollar-sign"></i> Total CAPEX</div>
                                    <div class="tooltip-desc">Capital Expenditure - Total upfront investment required to build the data center including construction, equipment, and commissioning.</div>
                                </div>
                            </span></div>
                            <div class="total-value" id="totalCost">$12,500,000</div>
                        </div>
                    </div>

                    <!-- Action Toolbar â€” right under total for visibility -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;margin-top:0.75rem;">
                        <button onclick="gatedAction('save')" id="btnSaveA" class="action-btn-save" style="padding:10px 8px;border-radius:10px;border:2px solid rgba(251,191,36,0.5);background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(245,158,11,0.1));color:#fbbf24;cursor:pointer;font-weight:700;font-size:0.78rem;font-family:inherit;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 2px 8px rgba(245,158,11,0.15);">
                            <i class="fas fa-bookmark"></i> <span id="btnSaveLabel">Save A</span>
                        </button>
                        <button onclick="gatedAction('pdf')" id="btnExportPDF" class="action-btn-pdf" style="padding:10px 8px;border-radius:10px;border:2px solid rgba(239,68,68,0.4);background:linear-gradient(135deg,rgba(239,68,68,0.15),rgba(220,38,38,0.08));color:#f87171;cursor:pointer;font-weight:700;font-size:0.78rem;font-family:inherit;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 2px 8px rgba(239,68,68,0.12);">
                            <i class="fas fa-file-pdf"></i> <span id="btnPdfLabel">Export PDF</span>
                        </button>
                        <div style="display:none;" id="btnClearRow">
                            <button onclick="clearComparison()" id="btnClearCompare" style="width:100%;padding:10px 8px;border-radius:10px;border:1px solid rgba(239,68,68,0.35);background:linear-gradient(135deg,rgba(239,68,68,0.12),rgba(239,68,68,0.04));color:#f87171;cursor:pointer;font-weight:600;font-size:0.75rem;font-family:inherit;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:5px;">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                    <!-- Saved indicator -->
                    <div id="savedIndicator" style="display:none;margin-top:0.5rem;padding:6px 10px;border-radius:8px;background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.3);font-size:0.7rem;color:#34d399;text-align:center;">
                        <i class="fas fa-check-circle" style="margin-right:4px;"></i> Scenario A saved â€” change inputs for Scenario B
                    </div>

                    <div class="cost-breakdown" id="costBreakdown">
                        <!-- Cost items populated by JS -->
                    </div>

                    <div class="per-kw-display" id="perKwSection" onclick="if(!isPremiumUser)handlePremiumTab()">
                        <span class="per-kw-label">Cost per kW IT Load <span class="tooltip-trigger" style="font-size: 0.7rem;">?
                            <div class="tooltip-content">
                                <div class="tooltip-title"><i class="fas fa-calculator"></i> Cost per kW</div>
                                <div class="tooltip-desc">Industry benchmark metric: Total CAPEX divided by IT Load capacity. Typical ranges: $8,000-15,000/kW for Tier III, $15,000-25,000/kW for Tier IV.</div>
                            </div>
                        </span>
                        <span id="perKwGateBadge" class="gated-badge" onclick="event.stopPropagation();handlePremiumTab()"><i class="fas fa-crown"></i> PRO</span>
                        </span>
                        <span class="per-kw-value" id="perKwCost">$12,500/kW</span>
                    </div>

                    <div class="metrics-row">
                        <div class="metric-box">
                            <div class="metric-label">Tier Classification <span class="tooltip-trigger" style="font-size: 0.6rem;">?
                                <div class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-layer-group"></i> Uptime Tier</div>
                                    <div class="tooltip-desc">Uptime Institute classification based on redundancy level: Tier I (N) = 99.671%, Tier II = 99.741%, Tier III (N+1) = 99.982%, Tier IV (2N) = 99.995%.</div>
                                </div>
                            </span></div>
                            <div class="metric-value tier" id="tierClass">Tier III</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Estimated PUE <span class="tooltip-trigger" style="font-size: 0.6rem;">?
                                <div class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-leaf"></i> Power Usage Effectiveness</div>
                                    <div class="tooltip-desc">PUE = Total Facility Power Ã· IT Equipment Power. Industry average: 1.55. Efficient DC: 1.2-1.4. Best-in-class: &lt;1.2. Lower is better.</div>
                                </div>
                            </span></div>
                            <div class="metric-value pue" id="pueValue">1.45</div>
                        </div>
                    </div>

                    <div class="metrics-row">
                        <div class="metric-box">
                            <div class="metric-label">Expected Uptime <span class="tooltip-trigger" style="font-size: 0.6rem;">?
                                <div class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-clock"></i> Expected Uptime</div>
                                    <div class="tooltip-desc">Percentage of time the facility is expected to be operational per year. 99.982% = ~1.6 hours downtime/year. 99.995% = ~26 minutes/year.</div>
                                </div>
                            </span></div>
                            <div class="metric-value uptime" id="uptimeValue">99.982%</div>
                        </div>
                        <div class="metric-box" id="energySection" onclick="if(!isPremiumUser)handlePremiumTab()">
                            <div class="metric-label">Annual Energy <span class="tooltip-trigger" style="font-size: 0.6rem;">?
                                <div class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-plug"></i> Annual Energy Cost</div>
                                    <div class="tooltip-desc">Estimated yearly electricity cost based on IT Load Ã— PUE Ã— 8,760 hours Ã— electricity rate. This is an OPEX cost, not included in CAPEX.</div>
                                </div>
                            </span> <span id="energyGateBadge" class="gated-badge" onclick="event.stopPropagation();handlePremiumTab()"><i class="fas fa-crown"></i> PRO</span></div>
                            <div class="metric-value energy" id="energyCost">$1.2M</div>
                        </div>
                    </div>

                    <!-- Free Tier Watermark -->
                    <div id="freeWatermark" class="free-watermark" onclick="handlePremiumTab()">
                        <i class="fas fa-crown" style="margin-right:4px;"></i> Free Estimate &mdash; resistancezero.com &mdash; <strong style="cursor:pointer;text-decoration:underline;">Upgrade to PRO â€” Rp 199K/bulan</strong>
                    </div>

                    <!-- â•â•â• COMPARE MODE: Side-by-side cards â•â•â• -->
                    <div id="comparePanel" style="display:none;margin-top:1rem;">
                        <div style="background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);border-radius:16px;padding:1.25rem;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
                                <h3 style="font-size:0.95rem;font-weight:700;color:var(--dark-blue);display:flex;align-items:center;gap:8px;margin:0;">
                                    <i class="fas fa-columns" style="color:#f59e0b;"></i> Scenario Comparison
                                </h3>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:1rem;align-items:stretch;" id="compareGrid">
                                <div id="scenarioACard" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);border-radius:12px;padding:1.25rem;color:white;"></div>
                                <div id="deltaColumn" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0.75rem 0.25rem;gap:0.5rem;min-width:80px;"></div>
                                <div id="scenarioBCard" style="background:linear-gradient(135deg,#1a4731,#2d6a4f);border-radius:12px;padding:1.25rem;color:white;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- â•â•â• PREMIUM OUTPUT SECTION â•â•â• -->
                    <div id="premiumOutput" style="display:none;margin-top:1.5rem;flex-direction:column;gap:1rem;">

                        <!-- Premium KPI Cards -->
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;" id="premiumKpiGrid">
                            <div style="background:linear-gradient(135deg,#5b21b6,#7c3aed);border-radius:12px;padding:1rem;text-align:center;box-shadow:0 2px 8px rgba(139,92,246,0.25);">
                                <div style="font-size:0.65rem;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">Est. Racks</div>
                                <div style="font-size:1.5rem;font-weight:800;color:#ffffff;margin-top:4px;" id="premRackCount">167</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#1d4ed8,#3b82f6);border-radius:12px;padding:1rem;text-align:center;box-shadow:0 2px 8px rgba(59,130,246,0.25);">
                                <div style="font-size:0.65rem;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">Floor Space</div>
                                <div style="font-size:1.5rem;font-weight:800;color:#ffffff;margin-top:4px;" id="premFloorSpace">418 mÂ²</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#047857,#10b981);border-radius:12px;padding:1rem;text-align:center;box-shadow:0 2px 8px rgba(16,185,129,0.25);">
                                <div style="font-size:0.65rem;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">Build Time</div>
                                <div style="font-size:1.5rem;font-weight:800;color:#ffffff;margin-top:4px;" id="premTimeline">29 mo</div>
                            </div>
                        </div>

                        <!-- $/kW Benchmark Bar -->
                        <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(139,92,246,0.2);border-radius:12px;padding:1rem 1.25rem;">
                            <div style="font-size:0.72rem;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:1rem;display:flex;align-items:center;gap:6px;">
                                <i class="fas fa-chart-bar"></i> $/kW Industry Benchmark
                            </div>
                            <div id="benchmarkBar" style="position:relative;height:28px;background:linear-gradient(90deg,#10b981 0%,#f59e0b 50%,#ef4444 100%);border-radius:8px;overflow:visible;margin-bottom:1.75rem;">
                                <div id="benchmarkMarker" style="position:absolute;top:-4px;width:3px;height:36px;background:white;border-radius:2px;box-shadow:0 0 8px rgba(255,255,255,0.5);transition:left 0.5s ease;"></div>
                                <div id="benchmarkLabel" style="position:absolute;bottom:-24px;transform:translateX(-50%);font-size:0.72rem;font-weight:800;color:#fbbf24;white-space:nowrap;transition:left 0.5s ease;background:rgba(251,191,36,0.12);padding:2px 8px;border-radius:6px;border:1px solid rgba(251,191,36,0.3);"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:0.6rem;color:#64748b;">
                                <span>$5K/kW (Low)</span>
                                <span>$15K/kW (Avg)</span>
                                <span>$30K/kW (Premium)</span>
                            </div>
                        </div>


                        <!-- Construction Timeline -->
                        <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(139,92,246,0.2);border-radius:12px;padding:1rem 1.25rem;">
                            <div style="font-size:0.72rem;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.75rem;display:flex;align-items:center;gap:6px;">
                                <i class="fas fa-project-diagram"></i> Estimated Construction Timeline
                            </div>
                            <div id="timelineChart" style="display:flex;flex-direction:column;gap:4px;"></div>
                        </div>

                        <!-- Sustainability Metrics -->
                        <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(16,185,129,0.2);border-radius:12px;padding:1rem 1.25rem;">
                            <div style="font-size:0.72rem;font-weight:700;color:#6ee7b7;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.75rem;display:flex;align-items:center;gap:6px;">
                                <i class="fas fa-leaf"></i> Sustainability & Efficiency Metrics
                            </div>
                            <div id="sustainMetrics" style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;"></div>
                        </div>

                        <!-- Pro watermark -->
                        <div style="text-align:center;padding:6px;font-size:0.6rem;color:rgba(139,92,246,0.5);letter-spacing:0.3px;">
                            <i class="fas fa-crown" style="margin-right:3px;"></i> PRO Report â€” resistancezero.com â€” Generated <span id="premReportDate"></span>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #94a3b8; padding: 3rem 2rem; margin-top: 3rem;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 2rem; align-items: start;">
                <div>
                    <p style="font-size: 0.75rem; font-weight: 700; letter-spacing: 0.15em; color: #64748b; line-height: 1.6; margin-bottom: 1rem;">BUILT FOR MISSION CRITICAL INFRASTRUCTURE<br>MANAGEMENT // 2026</p>
                    <p style="font-size: 0.65rem; letter-spacing: 0.1em; color: #475569; margin-bottom: 0.75rem;">ALL OPERATIONAL DATASETS PRESERVED.</p>
                    <p style="font-size: 0.75rem; color: #64748b;">&copy; 2026 Bagus Dwi Permana. All rights reserved.</p>
                </div>
                <div>
                    <h4 style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.15em; color: #64748b; margin-bottom: 1rem;">NAVIGATION</h4>
                    <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.5rem;">
                        <li><a href="index.html" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Home Dashboard</a></li>
                        <li><a href="articles.html" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Technical Journal</a></li>
                        <li><a href="index.html#case-studies" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Case Studies</a></li>
                        <li><a href="datacenter-solutions.html" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">DC Solutions</a></li>
                    </ul>
                </div>
                <div>
                    <h4 style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.15em; color: #64748b; margin-bottom: 1rem;">CONNECT</h4>
                    <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.5rem;">
                        <li><a href="https://www.linkedin.com/in/bagus-dwi-permana-ba90b092" target="_blank" rel="noopener" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">LinkedIn Profile</a></li>
                        <li><a href="articles.html" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Technical Journal</a></li>
                        <li><a href="mailto:baguspermana7@gmail.com" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Direct Contact</a></li>
                        <li><a href="https://github.com/baguspermana7-cpu" target="_blank" rel="noopener" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">GitHub</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Cost Simulator Logic
        const costFactors = {
            building: { base: 800, label: 'Building & Civil', icon: 'fa-building', color: '#64748b' },
            seismic: { base: 100, label: 'Seismic Protection', icon: 'fa-mountain', color: '#78716c' },
            electrical: { base: 1200, label: 'Electrical (MV/LV)', icon: 'fa-bolt', color: '#3b82f6' },
            ups: { base: 600, label: 'UPS Systems', icon: 'fa-battery-full', color: '#8b5cf6' },
            generator: { base: 400, label: 'Generator & Fuel', icon: 'fa-gas-pump', color: '#f59e0b' },
            cooling: { base: 700, label: 'Cooling Systems', icon: 'fa-snowflake', color: '#06b6d4' },
            fireSuppression: { base: 150, label: 'Fire Suppression', icon: 'fa-fire-extinguisher', color: '#ef4444' },
            fireAlarm: { base: 80, label: 'Fire Alarm System', icon: 'fa-bell', color: '#f97316' },
            bms: { base: 120, label: 'BMS / DCIM', icon: 'fa-desktop', color: '#10b981' },
            network: { base: 250, label: 'Network Infra', icon: 'fa-network-wired', color: '#a855f7' },
            security: { base: 80, label: 'Security Systems', icon: 'fa-shield-alt', color: '#6366f1' },
            commissioning: { base: 120, label: 'Cx Agent & Startup', icon: 'fa-clipboard-check', color: '#14b8a6' },
            testing: { base: 90, label: 'Testing & Compliance', icon: 'fa-certificate', color: '#0ea5e9' },
            permits: { base: 60, label: 'Permits & Approvals', icon: 'fa-file-contract', color: '#84cc16' }
        };

        const redundancyMultipliers = { n: 1.0, n1: 1.25, '2n': 1.85, '2n1': 2.1 };
        const coolingMultipliers = { air: 1.0, inrow: 1.2, rdhx: 1.35, liquid: 1.6 };
        const rackMultipliers = { standard: 1.0, medium: 1.1, high: 1.3, ai: 1.6 };
        const buildingMultipliers = { warehouse: 0.7, modular: 0.85, purpose: 1.0, highrise: 1.4 };
        const seismicMultipliers = { zone0: 0.2, zone1: 1.0, zone2: 2.5, zone3: 5.0, zone4: 8.0 };
        const fireSuppressionMultipliers = { fm200: 1.0, novec: 1.3, inergen: 1.2, n2: 1.8, water: 0.6 };
        const fireAlarmMultipliers = { conventional: 0.6, addressable: 1.0, vesda: 1.8, hybrid: 2.2 };
        const upsMultipliers = { standalone: 0.9, modular: 1.0, distributed: 1.2, rotary: 1.5 };
        const genMultipliers = { diesel: 1.0, gas: 1.15, dualfuel: 1.3, hvo: 1.2 };
        const locationMultipliers = { sea: 0.65, india: 0.55, china: 0.7, japan: 1.1, australia: 1.05, europe: 1.15, usa: 1.0 };

        // â•â•â• ADVANCED MODE DATA â•â•â•
        // City-specific cost per Watt ($/W, 2025 baseline)
        // Sources: Turner & Townsend DCCI 2025, Cushman & Wakefield Cost Guide 2025
        const cityData = {
            silicon_valley: { perW: 13.30, region: 'usa', label: 'Silicon Valley', source: 'T&T 2025' },
            new_jersey:     { perW: 12.90, region: 'usa', label: 'New Jersey/NYC', source: 'C&W 2025' },
            virginia:       { perW: 13.40, region: 'usa', label: 'Virginia/NOVA', source: 'C&W 2025' },
            dallas:         { perW: 14.30, region: 'usa', label: 'Dallas, TX', source: 'C&W 2025' },
            phoenix:        { perW: 13.40, region: 'usa', label: 'Phoenix, AZ', source: 'C&W 2025' },
            chicago:        { perW: 13.20, region: 'usa', label: 'Chicago, IL', source: 'C&W 2025' },
            san_antonio:    { perW:  9.30, region: 'usa', label: 'San Antonio, TX', source: 'C&W 2025' },
            london:         { perW: 12.00, region: 'europe', label: 'London', source: 'T&T 2025' },
            frankfurt:      { perW: 11.60, region: 'europe', label: 'Frankfurt', source: 'T&T 2025' },
            amsterdam:      { perW: 11.80, region: 'europe', label: 'Amsterdam', source: 'Est. T&T' },
            stockholm:      { perW: 10.50, region: 'europe', label: 'Stockholm', source: 'Est. T&T' },
            lisbon:         { perW: 10.80, region: 'europe', label: 'Lisbon', source: 'Est. T&T' },
            tokyo:          { perW: 15.20, region: 'japan', label: 'Tokyo', source: 'T&T 2025' },
            singapore:      { perW: 14.53, region: 'sea', label: 'Singapore', source: 'T&T 2025' },
            hong_kong:      { perW: 13.80, region: 'china', label: 'Hong Kong', source: 'Est. T&T' },
            seoul:          { perW:  9.50, region: 'japan', label: 'Seoul', source: 'C&W APAC' },
            sydney:         { perW: 12.30, region: 'australia', label: 'Sydney', source: 'Est. T&T' },
            malaysia:       { perW: 11.37, region: 'sea', label: 'Malaysia/Johor', source: 'T&T 2025' },
            jakarta:        { perW: 11.21, region: 'sea', label: 'Jakarta', source: 'T&T 2025' },
            mumbai:         { perW:  6.64, region: 'india', label: 'Mumbai', source: 'T&T 2025' },
            bangkok:        { perW:  8.50, region: 'sea', label: 'Bangkok', source: 'Est. APAC' }
        };

        // Year escalation multipliers (CAPEX)
        // Sources: JLL 2026 Outlook (6%), T&T DCCI survey, Avid Solutions 2026-2030
        const yearEscalation = {
            '2025': { mult: 1.000, note: 'Baseline (current data)' },
            '2026': { mult: 1.060, note: '+6.0% â€” JLL forecast' },
            '2027': { mult: 1.115, note: '+5.2% â€” T&T trend' },
            '2028': { mult: 1.165, note: '+4.5% â€” supply normalization' },
            '2029': { mult: 1.210, note: '+3.9% â€” market stabilization' },
            '2030': { mult: 1.250, note: '+3.3% â€” historical average' }
        };

        // Front-of-meter costs (USD)
        const substationCosts = {
            shared: { base: 1000000, label: 'Shared Utility' },
            dedicated_33kv: { base: 4000000, label: 'Dedicated 33kV' },
            dedicated_132kv: { base: 7500000, label: 'Dedicated 132kV+' }
        };
        const transformerLeadMult = { standard: 1.0, extended: 1.15, emergency: 1.30 };
        const marketConditionMult = { buyer: 0.95, balanced: 1.0, seller: 1.10 };
        const deliveryMethodMult = { dbb: 1.0, db: 0.97, modular: 0.92, epc: 1.05 };
        const contractorAvailMult = { high: 1.0, normal: 1.03, tight: 1.08 };

        // Electrical distribution multipliers (applied to electrical cost category)
        const powerDistMult = { overhead: 0.92, busway: 1.0, underground: 1.15, mixed: 1.08 };
        const transformerTypeMult = { oil: 0.90, dry: 1.0, cast_resin: 1.12 };
        // PDU cost per rack (added as flat cost to electrical)
        const pduCostPerRack = { basic: 800, intelligent: 1500, switched: 2500 };
        // Structured cabling cost per rack (added as flat cost to network)
        const cablingCostPerRack = { copper: 600, hybrid: 1200, fiber: 2000 };
        // Floor construction multipliers (applied to building cost)
        const floorTypeMult = { slab: 0.95, raised_600: 1.0, raised_900: 1.06, raised_1200: 1.12 };
        // Site condition multipliers (applied to building cost)
        const siteConditionMult = { greenfield: 1.06, brownfield: 1.0, retrofit: 1.15 };
        // Security multipliers (applied to security cost)
        const securityLevelMult = { standard: 1.0, enterprise: 1.5, high: 2.2 };
        // Fiber entry fixed costs
        const fiberEntryCost = { single: 150000, dual: 350000, multi: 600000 };
        // Green cert multipliers (applied to total)
        const greenCertMult = { none: 1.0, silver: 1.02, gold: 1.04, platinum: 1.08 };
        // On-site renewable fixed costs (per MW of IT load)
        const renewableCostPerMW = { none: 0, solar: 1200000, solar_bess: 2500000 };

        // Permit & compliance cost multipliers by region
        // Higher = stricter regulations, more permits, longer processes
        const permitRegionMult = {
            sea: { permits: 1.3, testing: 0.8, label: 'PUPR/BKPM permits, AMDAL, SLF, PLN approval' },
            india: { permits: 1.4, testing: 0.7, label: 'MoEF clearance, CEA, state DISCOM, fire NOC' },
            china: { permits: 1.5, testing: 0.9, label: 'NDRC approval, environmental impact, fire bureau' },
            japan: { permits: 1.8, testing: 1.5, label: 'Building Standards Act, fire prevention, seismic cert' },
            australia: { permits: 1.6, testing: 1.3, label: 'DA/CC approval, NCC compliance, fire safety' },
            europe: { permits: 1.7, testing: 1.4, label: 'EIA, energy efficiency directive, CE marking' },
            usa: { permits: 1.0, testing: 1.0, label: 'AHJ permits, NFPA 75/76, UL/ETL listing' }
        };
        // Testing standards by redundancy (more redundancy = more IST/ISST testing)
        const testingRedundancyMult = { n: 0.7, n1: 1.0, '2n': 1.5, '2n1': 1.8 };

        // â•â•â• PREMIUM: EQUIPMENT BRAND DATABASE â•â•â•
        const equipmentBrands = {
            ups: {
                standalone: [
                    { brand: 'Eaton', model: '93PM', range: '30-500 kVA', efficiency: '97.4%', note: 'Hot-swappable modules' },
                    { brand: 'Vertiv', model: 'Liebert EXL S1', range: '100-1200 kVA', efficiency: '97%', note: 'Scalable architecture' },
                    { brand: 'Schneider', model: 'Galaxy VX', range: '500-1500 kVA', efficiency: '97%', note: 'Lithium-ion compatible' }
                ],
                modular: [
                    { brand: 'Vertiv', model: 'Trinergy Cube', range: '200-3600 kVA', efficiency: '98.5%', note: '3-mode operation' },
                    { brand: 'ABB', model: 'MegaFlex DPA', range: '200-4800 kVA', efficiency: '97.6%', note: 'Decentralized parallel' },
                    { brand: 'Huawei', model: 'UPS5000-H', range: '50-800 kVA/module', efficiency: '97.5%', note: 'AI-powered management' }
                ],
                distributed: [
                    { brand: 'Schneider', model: 'Symmetra PX', range: '16-500 kVA', efficiency: '97%', note: 'Rack-mount modular' },
                    { brand: 'Vertiv', model: 'Liebert APM', range: '30-600 kVA', efficiency: '96%', note: 'Mixed-capacity modules' },
                    { brand: 'Eaton', model: '9PXM', range: '4-20 kVA', efficiency: '97%', note: 'Hot-swap batteries' }
                ],
                rotary: [
                    { brand: 'Hitec', model: 'PowerProtection UNIBLOCK', range: '300-3000 kVA', efficiency: '97%', note: 'Diesel rotary, no batteries' },
                    { brand: 'Piller', model: 'UNIBLOCK', range: '400-3300 kVA', efficiency: '96%', note: 'Kinetic energy storage' },
                    { brand: 'Rolls-Royce', model: 'DRUPS', range: '500-3000 kW', efficiency: '95%', note: 'Integrated diesel flywheel' }
                ]
            },
            cooling: {
                air: [
                    { brand: 'Vertiv', model: 'Liebert PFH', range: '24-252 kW', note: 'Perimeter CRAH with EC fans' },
                    { brand: 'Schneider', model: 'InRow RD', range: '21-50 kW', note: 'Close-coupled, variable speed' },
                    { brand: 'Stulz', model: 'CyberAir 3PRO', range: '6-200 kW', note: 'Free cooling capable' }
                ],
                inrow: [
                    { brand: 'Vertiv', model: 'Liebert XDC', range: '35-80 kW', note: 'Rear-intake, variable capacity' },
                    { brand: 'Schneider', model: 'InRow RD', range: '21-50 kW/row', note: 'Hot/cold aisle containment' },
                    { brand: 'Stulz', model: 'CoolRow', range: '10-50 kW', note: 'Direct expansion or chilled water' }
                ],
                rdhx: [
                    { brand: 'CoolIT', model: 'Rack DCHX', range: '30-80 kW/rack', note: 'Passive rear-door, no fans' },
                    { brand: 'Vertiv', model: 'Liebert RDHx', range: '10-40 kW/rack', note: 'Zero rack footprint' },
                    { brand: 'Motivair', model: 'ChilledDoor', range: '50-100 kW/rack', note: 'Active cooling, high density' }
                ],
                liquid: [
                    { brand: 'CoolIT', model: 'DLC Manifold', range: '100+ kW/rack', note: 'CPU/GPU direct-to-chip' },
                    { brand: 'GRC', model: 'ICEtank', range: 'Full immersion', note: 'Single-phase immersion' },
                    { brand: 'LiquidCool', model: 'LCS2', range: '200+ kW/rack', note: 'Two-phase immersion cooling' }
                ]
            },
            generator: {
                diesel: [
                    { brand: 'Caterpillar', model: 'C175-16', range: '2-3.5 MW', note: 'Tier 4F / EPA compliant' },
                    { brand: 'Cummins', model: 'QSK95', range: '2.2-3.5 MW', note: 'Modular power nodes' },
                    { brand: 'MTU', model: 'Series 4000', range: '0.5-3.25 MW', note: 'Compact footprint, low emissions' }
                ],
                gas: [
                    { brand: 'Caterpillar', model: 'CG260-16', range: '2-4.5 MW', note: 'Natural gas, CHP capable' },
                    { brand: 'Jenbacher', model: 'Type 6', range: '2-4.4 MW', note: 'High efficiency gas engine' },
                    { brand: 'WÃ¤rtsilÃ¤', model: '34SG', range: '4-18 MW', note: 'Multi-fuel smart power' }
                ],
                dualfuel: [
                    { brand: 'WÃ¤rtsilÃ¤', model: '34DF', range: '4-18 MW', note: 'Gas primary, diesel backup' },
                    { brand: 'MAN', model: '51/60DF', range: '8-18 MW', note: 'Dual-fuel marine-grade' },
                    { brand: 'Caterpillar', model: 'CG260DF', range: '2-4 MW', note: 'Seamless fuel switching' }
                ],
                hvo: [
                    { brand: 'Cummins', model: 'QSK78 HVO', range: '2-3 MW', note: 'Drop-in HVO/renewable diesel' },
                    { brand: 'Caterpillar', model: 'C175 HVO', range: '2-3.5 MW', note: '90% COâ‚‚ reduction' },
                    { brand: 'MTU', model: '4000 HVO', range: '1-3 MW', note: 'Certified for 100% HVO' }
                ]
            },
            fire: {
                fm200: { agent: 'HFC-227ea', density: '0.57 kg/mÂ³', discharge: '10 sec', note: 'Being phased out (high GWP 3220)' },
                novec: { agent: 'FK-5-1-12', density: '0.51 kg/mÂ³', discharge: '10 sec', note: 'GWP=1, zero ODP, safest choice' },
                inergen: { agent: 'IG-541 (Nâ‚‚/Ar/COâ‚‚)', density: '43.7%', discharge: '60 sec', note: 'Infinite atmospheric life, no residue' },
                n2: { agent: 'Nâ‚‚', density: '12-15% Oâ‚‚', discharge: 'Continuous', note: 'Prevents ignition, sealed rooms only' },
                water: { agent: 'High-pressure mist', density: '50-120 bar', discharge: 'Zoned', note: 'Green, no chemicals, NFPA 750' }
            }
        };

        // Premium: Floor space & timeline estimators
        const rackKw = { standard: 6, medium: 12.5, high: 25, ai: 75 };
        const rackFootprint = 2.5; // mÂ² per rack (including aisle)

        // Base timeline by redundancy (months)
        const timelineBase = {
            n: { design: 4, permit: 3, civil: 8, mep: 6, commission: 2 },
            n1: { design: 5, permit: 3, civil: 10, mep: 8, commission: 3 },
            '2n': { design: 6, permit: 4, civil: 12, mep: 10, commission: 4 },
            '2n1': { design: 7, permit: 4, civil: 14, mep: 12, commission: 5 }
        };

        // Timeline adjustment multipliers
        const buildingTimeMult = { warehouse: 0.7, modular: 0.6, purpose: 1.0, highrise: 1.4 };
        const coolingTimeMult = { air: 1.0, inrow: 1.05, rdhx: 1.15, liquid: 1.3 }; // DLC needs more MEP time
        const permitTimeMult = { sea: 1.2, india: 1.4, china: 1.3, japan: 1.5, australia: 1.3, europe: 1.4, usa: 1.0 };
        // IT load scale: >10MW = +20%, >50MW = +40%
        function loadScaleMult(itLoad) {
            if (itLoad <= 1000) return 0.55;   // micro/edge DC
            if (itLoad <= 2000) return 0.65;   // small DC
            if (itLoad <= 5000) return 0.8;    // medium-small
            if (itLoad <= 10000) return 1.0;   // medium (reference)
            if (itLoad <= 25000) return 1.15;  // large
            if (itLoad <= 50000) return 1.3;   // campus
            return 1.5;                        // hyperscale
        }

        // â•â•â• ESG / SUSTAINABILITY DATA â•â•â•
        // Grid emission factors (tCOâ‚‚/MWh) â€” IEA 2024 estimates
        const gridEmissionFactor = {
            sea: 0.72, india: 0.71, china: 0.56, japan: 0.47,
            australia: 0.65, europe: 0.23, usa: 0.39
        };
        // WUE by cooling type (L/kWh IT load)
        const wueByCooling = {
            air: 0.0, inrow: 1.8, rdhx: 0.3, liquid: 0.1
        };
        // Refrigerant data by cooling type
        const refrigerantData = {
            air:    { type: 'R-410A', gwp: 2088, rec: 'R-32', recGwp: 675, note: 'EU F-Gas phase-down by 2030; US AIM Act restricts GWP >700 for new equipment from 2025' },
            inrow:  { type: 'R-410A', gwp: 2088, rec: 'R-454B', recGwp: 466, note: 'Kigali Amendment mandates 80% HFC phase-down by 2036 (A2 countries)' },
            rdhx:   { type: 'R-134a', gwp: 1430, rec: 'R-1234ze(E)', recGwp: 7, note: 'Ultra-low GWP HFO; EU F-Gas bans GWP >150 for new chillers from 2025' },
            liquid: { type: 'None (closed-loop)', gwp: 0, rec: 'N/A', recGwp: 0, note: 'No refrigerant â€” lowest environmental impact cooling method' }
        };

        // Compute timeline from all inputs
        function computeTimeline(redundancy, buildingType, coolingType, effectiveRegion, itLoad) {
            const base = timelineBase[redundancy] || timelineBase['n1'];
            const bMult = buildingTimeMult[buildingType] || 1.0;
            const cMult = coolingTimeMult[coolingType] || 1.0;
            const pMult = permitTimeMult[effectiveRegion] || 1.0;
            const lMult = loadScaleMult(itLoad);

            // Phase durations (months)
            const design = Math.max(2, Math.ceil(base.design * lMult));
            const permit = Math.max(2, Math.ceil(base.permit * pMult));
            const procurement = Math.max(2, Math.ceil(base.mep * 0.4 * cMult * lMult));
            const civil = Math.max(2, Math.ceil(base.civil * bMult * lMult));
            const mep = Math.max(2, Math.ceil(base.mep * cMult * lMult));
            const commission = Math.max(1, Math.ceil(base.commission * cMult * Math.max(0.7, lMult)));

            // PARALLEL MODEL â€” realistic phase overlaps
            // Permit starts 1 month into design (parallel)
            const permitStart = 1;
            const designEnd = design;
            const permitEnd = permitStart + permit;
            const designPermitEnd = Math.max(designEnd, permitEnd);

            // Procurement starts late in design phase
            const procStart = Math.max(1, design - Math.ceil(procurement * 0.3));
            const procEnd = procStart + procurement;

            // Civil starts after design+permit complete
            const civilStart = designPermitEnd;
            const civilEnd = civilStart + civil;

            // MEP starts after procurement done AND 50% of civil done (whichever is later)
            const mepStart = Math.max(procEnd, civilStart + Math.ceil(civil * 0.5));
            const mepEnd = mepStart + mep;

            // Commissioning after MEP and civil both complete
            const commStart = Math.max(mepEnd, civilEnd);
            const totalMonths = commStart + commission;

            return {
                design, permit, procurement, civil, mep, commission,
                totalMonths,
                phases: [
                    { name: 'Design & Engineering', start: 0, end: designEnd, color: '#8b5cf6' },
                    { name: 'Permitting & Approvals', start: permitStart, end: permitEnd, color: '#f59e0b' },
                    { name: 'Procurement (Long-Lead)', start: procStart, end: procEnd, color: '#ec4899' },
                    { name: 'Civil & Structural', start: civilStart, end: civilEnd, color: '#3b82f6' },
                    { name: 'MEP Installation', start: mepStart, end: mepEnd, color: '#10b981' },
                    { name: 'Testing & Commissioning', start: commStart, end: commStart + commission, color: '#06b6d4' }
                ]
            };
        }

        // Current mode
        let capexMode = 'simple';
        let savedScenario = null;

        function switchCapexMode(mode) {
            // Gate: only free users cannot access Advanced mode (demo + pro can)
            if (mode === 'advanced' && !isPremiumUser) {
                handlePremiumTab();
                return;
            }
            capexMode = mode;
            document.querySelectorAll('.capex-mode-btn').forEach(btn => {
                if (btn.id === 'premiumTabBtn') return; // Skip â€” Premium has its own styling
                const isActive = btn.dataset.mode === mode;
                btn.style.background = isActive ? 'rgba(245,158,11,0.15)' : 'transparent';
                btn.style.borderColor = isActive ? 'rgba(245,158,11,0.4)' : 'rgba(255,255,255,0.15)';
                btn.style.color = isActive ? '#f59e0b' : '#94a3b8';
                btn.style.fontWeight = isActive ? '600' : '500';
                btn.classList.toggle('active', isActive);
            });
            const advPanel = document.getElementById('advancedInputs');
            advPanel.style.display = mode === 'advanced' ? 'flex' : 'none';
            calculateCosts();
            // Re-init tooltips for newly visible elements
            setTimeout(() => initTooltipSystem(), 50);
        }

        // FOM toggle
        document.getElementById('includeFOM').addEventListener('change', function() {
            document.getElementById('fomInputs').style.display = this.checked ? 'flex' : 'none';
            calculateCosts();
        });

        // Slider label updaters
        document.getElementById('utilityRate').addEventListener('input', function() {
            document.getElementById('utilRateVal').textContent = this.value + '%';
            calculateCosts();
        });
        document.getElementById('designFee').addEventListener('input', function() {
            document.getElementById('designFeeVal').textContent = this.value + '%';
            calculateCosts();
        });
        document.getElementById('pmFee').addEventListener('input', function() {
            document.getElementById('pmFeeVal').textContent = this.value + '%';
            calculateCosts();
        });
        document.getElementById('contingencyAdv').addEventListener('input', function() {
            document.getElementById('contingencyVal').textContent = this.value + '%';
            calculateCosts();
        });

        // Advanced mode event listeners
        ['projYear','cityMarket','substationType','transformerLead','marketCondition','deliveryMethod','contractorAvail',
         'powerDistribution','transformerType','pduType','cablingType','floorType','siteCondition','securityLevel','fiberEntry','greenCert','renewableOption'].forEach(id => {
            document.getElementById(id).addEventListener('change', calculateCosts);
        });

        const tierMapping = {
            n: { tier: 'Tier I', uptime: '99.671%' },
            n1: { tier: 'Tier II', uptime: '99.741%' },
            '2n': { tier: 'Tier III', uptime: '99.982%' },
            '2n1': { tier: 'Tier IV', uptime: '99.995%' }
        };

        const pueMapping = {
            air: { standard: 1.8, medium: 1.7, high: 1.6, ai: 1.5 },
            inrow: { standard: 1.6, medium: 1.5, high: 1.45, ai: 1.4 },
            rdhx: { standard: 1.45, medium: 1.4, high: 1.35, ai: 1.3 },
            liquid: { standard: 1.3, medium: 1.25, high: 1.2, ai: 1.15 }
        };

        function getSelectedValue(name) {
            const selected = document.querySelector(`input[name="${name}"]:checked`);
            return selected ? selected.value : null;
        }

        function formatCurrency(amount) {
            if (amount >= 1000000000) {
                return '$' + (amount / 1000000000).toFixed(2) + 'B';
            } else if (amount >= 1000000) {
                return '$' + (amount / 1000000).toFixed(2) + 'M';
            } else if (amount >= 1000) {
                return '$' + (amount / 1000).toFixed(0) + 'K';
            }
            return '$' + amount.toFixed(0);
        }

        function calculateCosts() {
            const itLoad = parseInt(document.getElementById('itLoad').value) || 1000;
            const rackType = getSelectedValue('rackType');
            const coolingType = getSelectedValue('coolingType');
            const redundancy = getSelectedValue('redundancy');
            const fuelHours = parseInt(document.getElementById('fuelHours').value) || 48;
            const buildingType = document.getElementById('buildingType').value;
            const seismicZone = document.getElementById('seismicZone').value;
            const fireType = document.getElementById('fireType').value;
            const alarmType = document.getElementById('alarmType').value;
            const upsType = document.getElementById('upsType').value;
            const genType = document.getElementById('genType').value;
            const location = document.getElementById('locationFactor').value;

            const redMult = redundancyMultipliers[redundancy];
            const coolMult = coolingMultipliers[coolingType];
            const rackMult = rackMultipliers[rackType];
            const buildMult = buildingMultipliers[buildingType];
            const seismicMult = seismicMultipliers[seismicZone];
            const fireSupMult = fireSuppressionMultipliers[fireType];
            const alarmMult = fireAlarmMultipliers[alarmType];
            const upsMult = upsMultipliers[upsType];
            const genMult = genMultipliers[genType];
            let locMult = locationMultipliers[location];
            let effectiveRegion = location; // for permit/compliance lookup
            const fuelMult = 1 + (fuelHours - 24) * 0.008;

            // Advanced mode adjustments
            const isAdv = capexMode === 'advanced';
            let yearMult = 1.0, cityLabel = '', yearLabel = '2025';
            let marketMult = 1.0, deliveryMult = 1.0, contractorMult = 1.0;
            let designPct = 0, pmPct = 0, contingencyPct = 5;
            let fomTotal = 0, fomIncluded = false;
            let powerDistM = 1.0, transformerM = 1.0, pduPerRack = 0, cablingPerRack = 0;
            let floorM = 1.0, siteM = 1.0, securityM = 1.0, fiberCost = 0;
            let greenM = 1.0, renewableCost = 0;

            if (isAdv) {
                // Year escalation
                yearLabel = document.getElementById('projYear').value;
                yearMult = yearEscalation[yearLabel].mult;

                // City-specific override
                const cityVal = document.getElementById('cityMarket').value;
                if (cityVal !== 'none' && cityData[cityVal]) {
                    const city = cityData[cityVal];
                    cityLabel = city.label;
                    effectiveRegion = city.region;
                    // City $/W -> derive location multiplier relative to US baseline ~$13/W
                    locMult = city.perW / 13.0;
                }

                // Market factors
                marketMult = marketConditionMult[document.getElementById('marketCondition').value];
                deliveryMult = deliveryMethodMult[document.getElementById('deliveryMethod').value];
                contractorMult = contractorAvailMult[document.getElementById('contractorAvail').value];

                // Professional fees
                designPct = parseFloat(document.getElementById('designFee').value);
                pmPct = parseFloat(document.getElementById('pmFee').value);
                contingencyPct = parseInt(document.getElementById('contingencyAdv').value);

                // Front-of-meter
                fomIncluded = document.getElementById('includeFOM').checked;
                if (fomIncluded) {
                    const subType = document.getElementById('substationType').value;
                    const transLead = document.getElementById('transformerLead').value;
                    const utilRate = parseFloat(document.getElementById('utilityRate').value) / 100;
                    const subCost = substationCosts[subType].base * transformerLeadMult[transLead];
                    const gridConnection = itLoad * 0.001 * 500000; // ~$500K per MW
                    const switchgear = itLoad * 0.001 * 300000; // ~$300K per MW
                    fomTotal = (subCost + gridConnection + switchgear) * (1 + utilRate);
                    fomTotal *= yearMult;
                }

                // Electrical distribution
                powerDistM = powerDistMult[document.getElementById('powerDistribution').value] || 1.0;
                transformerM = transformerTypeMult[document.getElementById('transformerType').value] || 1.0;
                pduPerRack = pduCostPerRack[document.getElementById('pduType').value] || 1500;
                cablingPerRack = cablingCostPerRack[document.getElementById('cablingType').value] || 1200;

                // Site & civil
                floorM = floorTypeMult[document.getElementById('floorType').value] || 1.0;
                siteM = siteConditionMult[document.getElementById('siteCondition').value] || 1.0;
                securityM = securityLevelMult[document.getElementById('securityLevel').value] || 1.0;
                fiberCost = fiberEntryCost[document.getElementById('fiberEntry').value] || 350000;

                // Sustainability
                greenM = greenCertMult[document.getElementById('greenCert').value] || 1.0;
                renewableCost = renewableCostPerMW[document.getElementById('renewableOption').value] * (itLoad / 1000) || 0;
            }

            const costs = {};
            let total = 0;
            const advGlobalMult = isAdv ? yearMult * marketMult * deliveryMult * contractorMult : 1.0;

            for (const [key, factor] of Object.entries(costFactors)) {
                let multiplier = locMult;

                if (key === 'building') {
                    multiplier *= buildMult * rackMult * floorM * siteM;
                } else if (key === 'seismic') {
                    multiplier *= seismicMult * buildMult;
                } else if (key === 'electrical') {
                    multiplier *= redMult * rackMult * powerDistM * transformerM;
                } else if (key === 'ups') {
                    multiplier *= redMult * rackMult * upsMult;
                } else if (key === 'generator') {
                    multiplier *= redMult * fuelMult * genMult;
                } else if (key === 'cooling') {
                    multiplier *= coolMult * rackMult;
                } else if (key === 'fireSuppression') {
                    multiplier *= fireSupMult;
                } else if (key === 'fireAlarm') {
                    multiplier *= alarmMult;
                } else if (key === 'security') {
                    multiplier *= securityM;
                } else if (key === 'commissioning') {
                    multiplier *= redMult; // more redundancy = more Cx scope
                } else if (key === 'testing') {
                    const regionTest = permitRegionMult[effectiveRegion] || permitRegionMult.usa;
                    const redTest = testingRedundancyMult[redundancy] || 1.0;
                    multiplier *= regionTest.testing * redTest;
                } else if (key === 'permits') {
                    const regionPermit = permitRegionMult[effectiveRegion] || permitRegionMult.usa;
                    multiplier *= regionPermit.permits;
                }

                costs[key] = factor.base * itLoad * multiplier * advGlobalMult;
                total += costs[key];
            }

            // Add per-rack fixed costs (PDU + structured cabling) in advanced mode
            const racks = Math.ceil(itLoad / rackKw[rackType]);
            if (isAdv) {
                const pduTotal = racks * pduPerRack * advGlobalMult * locMult;
                costs['electrical'] += pduTotal;
                total += pduTotal;

                const cablingTotal = racks * cablingPerRack * advGlobalMult * locMult;
                costs['network'] += cablingTotal;
                total += cablingTotal;

                // Add fiber entry cost
                if (fiberCost > 0) {
                    costs['network'] += fiberCost * advGlobalMult;
                    total += fiberCost * advGlobalMult;
                }
            }

            // Soft costs (advanced)
            let softCosts = {};
            if (isAdv) {
                if (designPct > 0) {
                    softCosts.design = total * (designPct / 100);
                }
                if (pmPct > 0) {
                    softCosts.pm = total * (pmPct / 100);
                }
            }
            const softTotal = Object.values(softCosts).reduce((a, b) => a + b, 0);
            total += softTotal;

            // Green certification premium (applied to subtotal)
            if (isAdv && greenM > 1.0) {
                const greenPremium = total * (greenM - 1.0);
                total += greenPremium;
            }

            // Contingency
            const contingency = total * (contingencyPct / 100);
            total += contingency;

            // Add FOM
            if (fomIncluded) total += fomTotal;

            // Add on-site renewable costs
            if (isAdv && renewableCost > 0) {
                total += renewableCost * advGlobalMult;
            }

            // â•â•â• UPDATE UI â•â•â•
            document.getElementById('totalCost').textContent = formatCurrency(total);
            document.getElementById('perKwCost').textContent = formatCurrency(total / itLoad) + '/kW';

            const tierInfo = tierMapping[redundancy];
            document.getElementById('tierClass').textContent = tierInfo.tier;
            document.getElementById('uptimeValue').textContent = tierInfo.uptime;

            const pue = pueMapping[coolingType][rackType];
            document.getElementById('pueValue').textContent = pue.toFixed(2);

            const energyRate = location === 'sea' ? 0.08 : location === 'india' ? 0.07 : location === 'usa' ? 0.10 : 0.12;
            const annualEnergy = itLoad * pue * 8760 * energyRate;
            document.getElementById('energyCost').textContent = formatCurrency(annualEnergy);

            // â•â•â• RENDER BREAKDOWN â•â•â•
            const breakdownEl = document.getElementById('costBreakdown');
            breakdownEl.innerHTML = '';

            // Collect all line items for bar sizing
            const allItems = { ...costs };
            if (softCosts.design) allItems._design = softCosts.design;
            if (softCosts.pm) allItems._pm = softCosts.pm;
            allItems._contingency = contingency;
            if (fomIncluded) allItems._fom = fomTotal;
            const maxCost = Math.max(...Object.values(allItems));

            const sortedCosts = Object.entries(costs).sort((a, b) => b[1] - a[1]);
            for (const [key, cost] of sortedCosts) {
                const factor = costFactors[key];
                const percent = ((cost / total) * 100).toFixed(1);
                const barWidth = (cost / maxCost) * 100;
                breakdownEl.innerHTML += `
                    <div class="cost-item">
                        <div class="cost-name">
                            <div class="cost-icon" style="background: ${factor.color}30; color: ${factor.color};"><i class="fas ${factor.icon}"></i></div>
                            ${factor.label}
                        </div>
                        <div class="cost-bar-container">
                            <div class="cost-bar" style="width: ${barWidth}%; background: ${factor.color};"></div>
                        </div>
                        <span class="cost-value">${formatCurrency(cost)}</span>
                        <span class="cost-percent">${percent}%</span>
                    </div>`;
            }

            // Soft cost rows (advanced)
            if (softCosts.design) {
                breakdownEl.innerHTML += renderExtraRow('fa-drafting-compass', 'Design & Engineering', softCosts.design, '#10b981', maxCost, total);
            }
            if (softCosts.pm) {
                breakdownEl.innerHTML += renderExtraRow('fa-tasks', 'Project Management', softCosts.pm, '#059669', maxCost, total);
            }

            // FOM row
            if (fomIncluded) {
                breakdownEl.innerHTML += renderExtraRow('fa-plug', 'Front-of-Meter / Utility', fomTotal, '#3b82f6', maxCost, total);
            }

            // Contingency row
            breakdownEl.innerHTML += `
                <div class="cost-item" style="opacity: 0.7;">
                    <div class="cost-name">
                        <div class="cost-icon" style="background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8);"><i class="fas fa-plus-circle"></i></div>
                        Contingency (${contingencyPct}%)
                    </div>
                    <div class="cost-bar-container">
                        <div class="cost-bar" style="width: ${(contingency / maxCost) * 100}%; background: rgba(255,255,255,0.5);"></div>
                    </div>
                    <span class="cost-value">${formatCurrency(contingency)}</span>
                    <span class="cost-percent">${contingencyPct}.0%</span>
                </div>`;

            // Green cert and renewable rows
            if (isAdv && greenM > 1.0) {
                const greenPremium = (total - contingency) * (greenM - 1.0); // approx
                breakdownEl.innerHTML += renderExtraRow('fa-certificate', 'Green Certification (' + document.getElementById('greenCert').selectedOptions[0].text.split('(')[0].trim() + ')', greenPremium, '#22c55e', maxCost, total);
            }
            if (isAdv && renewableCost > 0) {
                breakdownEl.innerHTML += renderExtraRow('fa-solar-panel', 'On-Site Renewable', renewableCost * advGlobalMult, '#f97316', maxCost, total);
            }

            // Advanced info badge
            const advBadge = document.getElementById('advInfoBadge');
            if (advBadge) {
                if (isAdv) {
                    let info = yearLabel;
                    if (cityLabel) info += ' Â· ' + cityLabel;
                    if (yearMult > 1) info += ' Â· +' + ((yearMult - 1) * 100).toFixed(1) + '% escalation';
                    advBadge.textContent = info;
                    advBadge.style.display = 'inline-block';
                } else {
                    advBadge.style.display = 'none';
                }
            }

            // Build config metadata for PDF comparison
            const buildingLabels = { warehouse: 'Warehouse Conversion', modular: 'Modular / Prefab', purpose: 'Purpose-Built', highrise: 'High-Rise Multi-Story' };
            const locationLabels = { sea: 'Southeast Asia', india: 'India', china: 'China', japan: 'Japan / Korea', australia: 'Australia', europe: 'Europe', usa: 'USA' };
            const coolingLabels = { air: 'Raised Floor / CRAC', inrow: 'In-Row Cooling', rdhx: 'Rear-Door HX', liquid: 'Direct Liquid' };
            const rackLabels = { standard: 'Standard (5-8 kW)', medium: 'Medium (8-15 kW)', high: 'High (15-30 kW)', ai: 'AI/HPC (30-100 kW)' };
            const redundancyLabels = { n: 'N (No Redundancy)', n1: 'N+1', '2n': '2N', '2n1': '2N+1' };
            const upsLabels = { standalone: 'Standalone', modular: 'Modular', distributed: 'Distributed', rotary: 'Rotary' };
            const genLabels = { diesel: 'Diesel', gas: 'Natural Gas', dualfuel: 'Dual Fuel', hvo: 'HVO Biodiesel' };
            const fireLabels = { fm200: 'FM-200 / HFC', novec: 'Novec 1230', inergen: 'Inergen / IG-541', n2: 'Nitrogen (Nâ‚‚)', water: 'Water Mist' };
            const deliveryLabels = { dbb: 'Design-Bid-Build', db: 'Design-Build', modular: 'Modular-Prefab', epc: 'EPC Turnkey' };
            const marketLabels = { buyer: "Buyer's Market (-5%)", balanced: 'Balanced', seller: "Seller's Market (+10%)" };
            const contractorLabels = { high: 'High Availability', normal: 'Normal (+3%)', tight: 'Tight Market (+8%)' };
            const substationLabels = { shared: 'Shared Utility', dedicated_33kv: 'Dedicated 33kV', dedicated_132kv: 'Dedicated 132kV+' };
            const transformerLeadLabels = { standard: 'Standard (18-24 mo)', extended: 'Extended (+15%)', emergency: 'Emergency (+30%)' };

            const _config = {
                itLoad: itLoad.toLocaleString() + ' kW',
                location: locationLabels[location] || location,
                buildingType: buildingLabels[buildingType] || buildingType,
                redundancy: redundancyLabels[redundancy] || redundancy,
                coolingType: coolingLabels[coolingType] || coolingType,
                rackDensity: rackLabels[rackType] || rackType,
                upsType: upsLabels[upsType] || upsType,
                genType: genLabels[genType] || genType,
                fireSuppression: fireLabels[fireType] || fireType,
                tier: tierInfo.tier,
                pue: pue.toFixed(2),
                mode: isAdv ? 'Advanced' : 'Simple',
                yearLabel: yearLabel,
                cityLabel: cityLabel || 'â€”',
                fuelHours: fuelHours + 'h',
                deliveryMethod: isAdv ? deliveryLabels[document.getElementById('deliveryMethod').value] : 'Design-Bid-Build (default)',
                marketCondition: isAdv ? marketLabels[document.getElementById('marketCondition').value] : 'Balanced (default)',
                contractorAvail: isAdv ? contractorLabels[document.getElementById('contractorAvail').value] : 'Normal (default)',
                designFee: designPct + '%',
                pmFee: pmPct + '%',
                contingency: contingencyPct + '%',
                fomIncluded: fomIncluded ? 'Yes' : 'No',
                substationType: fomIncluded ? substationLabels[document.getElementById('substationType').value] : 'â€”',
                transformerLead: fomIncluded ? transformerLeadLabels[document.getElementById('transformerLead').value] : 'â€”',
                utilityRate: fomIncluded ? document.getElementById('utilityRate').value + '%' : 'â€”',
                effectiveRegion: (permitRegionMult[effectiveRegion] || permitRegionMult.usa).label.split(',')[0],
                powerDistribution: isAdv ? { overhead:'Overhead Cable Tray', busway:'Busway', underground:'Underground Conduit', mixed:'Mixed Bus+Underground' }[document.getElementById('powerDistribution').value] : 'Busway (default)',
                transformerType: isAdv ? { oil:'Oil-Filled Outdoor', dry:'Dry-Type Indoor', cast_resin:'Cast Resin' }[document.getElementById('transformerType').value] : 'Dry-Type (default)',
                pduType: isAdv ? { basic:'Basic Metered', intelligent:'Intelligent Monitored', switched:'Intelligent + Switched' }[document.getElementById('pduType').value] : 'Intelligent (default)',
                cablingType: isAdv ? { copper:'Cat6A Copper', hybrid:'Hybrid Fiber+Copper', fiber:'All-Fiber OM4/OS2' }[document.getElementById('cablingType').value] : 'Hybrid (default)',
                floorType: isAdv ? { slab:'Slab/Overhead', raised_600:'Raised Floor 600mm', raised_900:'Raised Floor 900mm', raised_1200:'Raised Floor 1200mm' }[document.getElementById('floorType').value] : 'Raised Floor 600mm (default)',
                siteCondition: isAdv ? { greenfield:'Greenfield', brownfield:'Brownfield', retrofit:'Retrofit' }[document.getElementById('siteCondition').value] : 'Brownfield (default)',
                securityLevel: isAdv ? { standard:'Standard', enterprise:'Enterprise', high:'High Security' }[document.getElementById('securityLevel').value] : 'Standard (default)',
                fiberEntry: isAdv ? { single:'Single Path', dual:'Dual Diverse', multi:'Multi-Path + MMR' }[document.getElementById('fiberEntry').value] : 'Dual Diverse (default)',
                greenCert: isAdv ? { none:'None', silver:'LEED Silver', gold:'LEED Gold', platinum:'LEED Platinum' }[document.getElementById('greenCert').value] : 'None',
                renewable: isAdv ? { none:'None', solar:'Rooftop Solar', solar_bess:'Solar + BESS' }[document.getElementById('renewableOption').value] : 'None',
            };

            // Pre-compute timeline & ESG for A/B comparison persistence
            const _timeline = computeTimeline(redundancy, buildingType, coolingType, effectiveRegion, itLoad);
            const _raw = { redundancy, buildingType, coolingType, rackType, upsType, genType, fireType, location, effectiveRegion };

            const result = { total, costs, contingency, softCosts, fomTotal, fomIncluded, itLoad, pue, tierInfo, annualEnergy, yearLabel, cityLabel, contingencyPct, designPct, pmPct, _config, _timeline, _raw };
            lastResult = result;
            // Auto-update comparison if saved
            if (savedScenario) renderComparison();
            // Apply feature gating after render
            if (typeof applyFeatureGating === 'function') applyFeatureGating();
            if (typeof renderPremiumOutput === 'function') renderPremiumOutput();
            return result;
        }

        function renderExtraRow(icon, label, cost, color, maxCost, total) {
            return `<div class="cost-item">
                <div class="cost-name">
                    <div class="cost-icon" style="background: ${color}30; color: ${color};"><i class="fas ${icon}"></i></div>
                    ${label}
                </div>
                <div class="cost-bar-container">
                    <div class="cost-bar" style="width: ${(cost / maxCost) * 100}%; background: ${color};"></div>
                </div>
                <span class="cost-value">${formatCurrency(cost)}</span>
                <span class="cost-percent">${((cost / total) * 100).toFixed(1)}%</span>
            </div>`;
        }

        // Event Listeners
        document.getElementById('itLoad').addEventListener('input', calculateCosts);
        document.getElementById('fuelHours').addEventListener('input', calculateCosts);
        document.getElementById('buildingType').addEventListener('change', calculateCosts);
        document.getElementById('seismicZone').addEventListener('change', calculateCosts);
        document.getElementById('fireType').addEventListener('change', calculateCosts);
        document.getElementById('alarmType').addEventListener('change', calculateCosts);
        document.getElementById('upsType').addEventListener('change', calculateCosts);
        document.getElementById('genType').addEventListener('change', calculateCosts);
        document.getElementById('locationFactor').addEventListener('change', function() {
            filterCityByLocation();
            calculateCosts();
        });
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', calculateCosts);
        });

        // Filter city dropdown to only show cities matching the selected location/region
        function filterCityByLocation() {
            const loc = document.getElementById('locationFactor').value;
            const citySelect = document.getElementById('cityMarket');
            if (!citySelect) return;
            const prev = citySelect.value;
            citySelect.querySelectorAll('option').forEach(opt => {
                if (opt.value === 'none') { opt.style.display = ''; return; }
                const cd = cityData[opt.value];
                opt.style.display = (cd && cd.region === loc) ? '' : 'none';
            });
            citySelect.querySelectorAll('optgroup').forEach(og => {
                const visible = Array.from(og.querySelectorAll('option')).some(o => o.style.display !== 'none');
                og.style.display = visible ? '' : 'none';
            });
            // Reset to "none" if current selection is now hidden
            const selOpt = citySelect.querySelector('option[value="' + prev + '"]');
            if (selOpt && selOpt.style.display === 'none') citySelect.value = 'none';
        }

        // Last computed result (avoids recalculation in comparison)
        let lastResult = null;

        // Premium state (must be declared before first calculateCosts call)
        var isPremiumUser = false;
        var userTier = 'free'; // 'free' | 'pro'

        // Initial calculation
        filterCityByLocation();
        calculateCosts();
        initTooltipSystem();

        // â•â•â• COMPARE MODE â•â•â•
        function saveScenarioA() {
            if (!lastResult) calculateCosts();
            savedScenario = JSON.parse(JSON.stringify(lastResult));
            document.getElementById('comparePanel').style.display = 'block';
            document.getElementById('savedIndicator').style.display = 'block';
            document.getElementById('scenarioBBanner').style.display = 'flex';
            document.getElementById('btnClearRow').style.display = 'block';
            const btn = document.getElementById('btnSaveA');
            btn.innerHTML = '<i class="fas fa-check-circle"></i> Scenario A Saved';
            btn.style.background = 'linear-gradient(135deg,rgba(16,185,129,0.2),rgba(16,185,129,0.1))';
            btn.style.borderColor = 'rgba(16,185,129,0.5)';
            btn.style.color = '#34d399';
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.pointerEvents = 'none';
            btn.style.cursor = 'default';
            renderComparison();
            // Scroll to input top so user sees Scenario B banner
            setTimeout(() => document.getElementById('scenarioBBanner').scrollIntoView({ behavior:'smooth', block:'start' }), 100);
        }

        function clearComparison() {
            savedScenario = null;
            document.getElementById('comparePanel').style.display = 'none';
            document.getElementById('savedIndicator').style.display = 'none';
            document.getElementById('scenarioBBanner').style.display = 'none';
            document.getElementById('btnClearRow').style.display = 'none';
            const btn = document.getElementById('btnSaveA');
            btn.innerHTML = '<i class="fas fa-bookmark"></i> Save Scenario A';
            btn.style.background = 'linear-gradient(135deg,rgba(251,191,36,0.25),rgba(245,158,11,0.15))';
            btn.style.borderColor = 'rgba(251,191,36,0.6)';
            btn.style.color = '#fbbf24';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
            btn.style.cursor = 'pointer';
        }

        function renderComparison() {
            if (!savedScenario || !lastResult) return;
            const b = lastResult;
            const a = savedScenario;
            const delta = ((b.total - a.total) / a.total * 100);
            const deltaSign = delta >= 0 ? '+' : '';
            const deltaColor = delta > 0 ? '#ef4444' : '#10b981';

            document.getElementById('scenarioACard').innerHTML = renderScenarioCard('A', a, '#fbbf24');
            document.getElementById('scenarioBCard').innerHTML = renderScenarioCard('B', b, '#34d399');

            document.getElementById('deltaColumn').innerHTML = `
                <div style="text-align:center;padding:0.5rem;">
                    <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Delta</div>
                    <div style="font-size:1.6rem;font-weight:700;color:${deltaColor};font-family:'JetBrains Mono',monospace;">${deltaSign}${delta.toFixed(1)}%</div>
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px;">${deltaSign}${formatCurrency(b.total - a.total)}</div>
                </div>
                <div style="width:2px;height:60px;background:linear-gradient(180deg,${deltaColor},transparent);border-radius:1px;"></div>
                <div style="text-align:center;">
                    <div style="font-size:0.7rem;color:var(--text-muted);">$/kW Delta</div>
                    <div style="font-size:0.95rem;font-weight:600;color:${deltaColor};font-family:'JetBrains Mono',monospace;">${deltaSign}${formatCurrency((b.total/b.itLoad) - (a.total/a.itLoad))}</div>
                </div>`;
        }

        // Fixed order for consistent comparison display
        const costKeyOrder = ['electrical','cooling','building','ups','generator','fireSuppression','fireAlarm','bms','network','security','seismic','commissioning','testing','permits'];

        function renderScenarioCard(label, data, accent) {
            // Use fixed key order, show top items by value but in consistent order
            const allEntries = costKeyOrder.map(k => [k, data.costs[k] || 0]).filter(([,v]) => v > 0);
            const topKeys = Object.entries(data.costs).sort((a,b) => b[1] - a[1]).slice(0, 5).map(e => e[0]);
            const topCosts = costKeyOrder.filter(k => topKeys.includes(k)).map(k => [k, data.costs[k]]);
            const maxC = Math.max(...topCosts.map(e => e[1]));
            let barsHTML = topCosts.map(([key, cost]) => {
                const f = costFactors[key];
                return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <span style="font-size:0.7rem;min-width:90px;color:rgba(255,255,255,0.7);">${f.label}</span>
                    <div style="flex:1;height:5px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;">
                        <div style="width:${(cost/maxC)*100}%;height:100%;background:${f.color};border-radius:3px;"></div>
                    </div>
                    <span style="font-size:0.75rem;font-family:'JetBrains Mono',monospace;min-width:60px;text-align:right;">${formatCurrency(cost)}</span>
                </div>`;
            }).join('');
            let metaInfo = data.tierInfo.tier + ' Â· PUE ' + data.pue;
            if (data.yearLabel !== '2025') metaInfo += ' Â· ' + data.yearLabel;
            if (data.cityLabel) metaInfo += ' Â· ' + data.cityLabel;
            return `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid rgba(255,255,255,0.15);">
                    <span style="font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:6px;">
                        <span style="width:24px;height:24px;border-radius:6px;background:${accent}30;color:${accent};display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;">${label}</span>
                        Scenario ${label}
                    </span>
                    <span style="font-size:0.7rem;color:rgba(255,255,255,0.5);">${metaInfo}</span>
                </div>
                <div style="text-align:center;margin-bottom:1rem;">
                    <div style="font-size:0.7rem;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:0.5px;">Total CAPEX</div>
                    <div style="font-size:1.8rem;font-weight:700;color:${accent};font-family:'JetBrains Mono',monospace;">${formatCurrency(data.total)}</div>
                    <div style="font-size:0.85rem;color:rgba(255,255,255,0.7);font-family:'JetBrains Mono',monospace;">${formatCurrency(data.total/data.itLoad)}/kW Â· ${data.itLoad.toLocaleString()} kW</div>
                </div>
                <div style="margin-top:0.75rem;">${barsHTML}</div>`;
        }

        // â•â•â• TIMELINE GANTT HTML BUILDER (for PDF) â•â•â•
        function buildTimelineGanttHTML(phases, totalMonths, cellS, hdrS) {
            const barH = 18;
            const labelW = 120;
            let barsHTML = '';
            phases.phases.forEach(p => {
                const leftPct = (p.start / totalMonths * 100).toFixed(1);
                const widthPct = ((p.end - p.start) / totalMonths * 100).toFixed(1);
                const dur = p.end - p.start;
                const barNarrow = parseFloat(widthPct) < 12;
                const rightPct = (parseFloat(leftPct) + parseFloat(widthPct)).toFixed(1);
                barsHTML += '<div style="display:flex;align-items:center;margin-bottom:4px;">' +
                    '<div style="width:' + labelW + 'px;font-size:8.5px;color:#374151;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:6px;">' + p.name + '</div>' +
                    '<div style="flex:1;position:relative;height:' + barH + 'px;background:#f1f5f9;border-radius:3px;">' +
                        '<div style="position:absolute;left:' + leftPct + '%;width:' + widthPct + '%;height:100%;background:' + p.color + ';border-radius:3px;opacity:0.85;"></div>' +
                        (barNarrow
                            ? '<span style="position:absolute;left:' + rightPct + '%;top:0;font-size:7.5px;color:#374151;font-weight:600;padding-left:4px;line-height:' + barH + 'px;white-space:nowrap;">' + dur + 'mo</span>'
                            : '<span style="position:absolute;left:' + leftPct + '%;top:0;font-size:7.5px;color:white;font-weight:600;padding-left:4px;line-height:' + barH + 'px;white-space:nowrap;">' + dur + 'mo</span>') +
                    '</div>' +
                '</div>';
            });
            // Month scale
            let scaleHTML = '<div style="display:flex;align-items:center;margin-top:4px;"><div style="width:' + labelW + 'px;"></div><div style="flex:1;display:flex;justify-content:space-between;font-size:7px;color:#9ca3af;">';
            const step = totalMonths <= 18 ? 3 : totalMonths <= 30 ? 6 : 12;
            for (let m = 0; m <= totalMonths; m += step) {
                scaleHTML += '<span>Mo ' + m + '</span>';
            }
            scaleHTML += '</div></div>';
            return '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:10px 12px;margin-bottom:8px;">' + barsHTML + scaleHTML + '</div>';
        }

        // â•â•â• SUSTAINABILITY HTML BUILDER (for PDF) â•â•â•
        function buildSustainabilityHTML(result, coolingType, effReg, racks, floorM2, annualMWh, cellS, hdrS) {
            const emFactor = gridEmissionFactor[effReg] || 0.4;
            const co2Tons = annualMWh * emFactor;
            const wue = wueByCooling[coolingType] || 0;
            const waterM3 = wue * result.itLoad * result.pue * 8760 / 1000;
            const dcie = (1 / result.pue * 100).toFixed(1);
            const cue = (co2Tons * 1000 / (result.itLoad * 8760)).toFixed(3);
            const refrig = refrigerantData[coolingType] || refrigerantData.air;

            return '<table style="width:100%;border-collapse:collapse;font-size:11px;">' +
                '<tr style="background:#1e3a5f;color:white;"><th style="' + hdrS + '" colspan="2">Energy & Carbon</th></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">PUE / DCiE</td><td style="' + cellS + '">' + result.pue.toFixed(2) + ' (' + (result.pue <= 1.2 ? 'Best-in-Class' : result.pue <= 1.3 ? 'Excellent' : result.pue <= 1.5 ? 'Good' : result.pue <= 1.7 ? 'Average' : 'Below Average') + ') / ' + dcie + '%</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Annual Energy</td><td style="' + cellS + '">' + annualMWh.toLocaleString(undefined,{maximumFractionDigits:0}) + ' MWh/yr (' + (annualMWh/1000).toFixed(1) + ' GWh)</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Grid Emission Factor</td><td style="' + cellS + '">' + emFactor.toFixed(2) + ' tCO\u2082/MWh (' + (effReg||'avg').toUpperCase() + ' region â€” IEA 2024)</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Scope 2 CO\u2082 Emissions</td><td style="' + cellS + '">' + co2Tons.toLocaleString(undefined,{maximumFractionDigits:0}) + ' tCO\u2082/yr (' + (co2Tons/result.itLoad).toFixed(1) + ' tCO\u2082/kW IT)</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">CUE (Carbon Use Effectiveness)</td><td style="' + cellS + '">' + cue + ' kgCO\u2082/kWh IT</td></tr>' +
                '<tr style="background:#1e3a5f;color:white;"><th style="' + hdrS + '" colspan="2">Water & Cooling</th></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">WUE (Water Use Effectiveness)</td><td style="' + cellS + '">' + wue.toFixed(1) + ' L/kWh' + (wue === 0 ? ' â€” Air-cooled: no evaporative water used' : wue <= 0.5 ? ' (Excellent)' : wue <= 1.0 ? ' (Good)' : wue <= 2.0 ? ' (Average)' : ' (High)') + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Est. Annual Water Consumption</td><td style="' + cellS + '">' + (waterM3 > 0 ? waterM3.toLocaleString(undefined,{maximumFractionDigits:0}) + ' m\u00B3/yr (' + (waterM3 * 264.172).toLocaleString(undefined,{maximumFractionDigits:0}) + ' gal)' : 'No water consumption (air-cooled DX â€” zero evaporative load)') + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Power Density</td><td style="' + cellS + '">' + rackKw[document.querySelector('input[name="rackType"]:checked').value] + ' kW/rack \u00B7 ' + (result.itLoad * result.pue / (floorM2 * 1.8)).toFixed(1) + ' kW/m\u00B2 gross</td></tr>' +
                '<tr style="background:#1e3a5f;color:white;"><th style="' + hdrS + '" colspan="2">Refrigerant & Compliance</th></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Current Refrigerant</td><td style="' + cellS + '">' + refrig.type + (refrig.gwp > 0 ? ' (GWP ' + refrig.gwp.toLocaleString() + ')' : '') + '</td></tr>' +
                (refrig.gwp > 0 ? '<tr><td style="' + cellS + 'font-weight:600;color:#047857;">Recommended Alternative</td><td style="' + cellS + 'color:#047857;font-weight:600;">' + refrig.rec + ' (GWP ' + refrig.recGwp + ') â€” ' + ((1 - refrig.recGwp / refrig.gwp) * 100).toFixed(0) + '% lower GWP</td></tr>' : '') +
                '<tr><td style="' + cellS + 'font-weight:600;">Regulatory Context</td><td style="' + cellS + 'color:#6b7280;font-size:10px;">' + refrig.note + '</td></tr>' +
            '</table>';
        }

        // â•â•â• PREMIUM PDF SECTION BUILDER â•â•â•
        function buildPremiumPdfSection(result) {
            const rackType = document.querySelector('input[name="rackType"]:checked').value;
            const coolingType = document.querySelector('input[name="coolingType"]:checked').value;
            const upsType = document.getElementById('upsType').value;
            const genType = document.getElementById('genType').value;
            const fireType = document.getElementById('fireType').value;
            const redundancy = document.querySelector('input[name="redundancy"]:checked').value;

            const buildingType = document.getElementById('buildingType').value;
            const locVal = document.getElementById('locationFactor').value;
            const cityVal2 = document.getElementById('cityMarket') ? document.getElementById('cityMarket').value : 'none';
            const effReg = (cityVal2 !== 'none' && cityData[cityVal2]) ? cityData[cityVal2].region : locVal;

            const racks = Math.ceil(result.itLoad / rackKw[rackType]);
            const floorM2 = Math.ceil(racks * rackFootprint);
            const phases = result._timeline || computeTimeline(redundancy, buildingType, coolingType, effReg, result.itLoad);
            const totalMonths = phases.totalMonths;

            // Equipment specs
            const upsOpts = equipmentBrands.ups[upsType] || equipmentBrands.ups.modular;
            const coolOpts = equipmentBrands.cooling[coolingType] || equipmentBrands.cooling.air;
            const genOpts = equipmentBrands.generator[genType] || equipmentBrands.generator.diesel;
            const fireInfo = equipmentBrands.fire[fireType] || equipmentBrands.fire.novec;

            const cellS = 'padding:5px 8px;border-bottom:1px solid #e5e7eb;font-size:11px;';
            const hdrS = 'padding:6px 8px;text-align:left;font-size:11px;';
            const cfg = result._config || {};

            // Equipment table
            let eqRows = '';
            upsOpts.forEach(u => { eqRows += `<tr><td style="${cellS}">UPS</td><td style="${cellS}font-weight:600;">${u.brand} ${u.model}</td><td style="${cellS}">${u.range}</td><td style="${cellS}color:#6b7280;">${u.note}</td></tr>`; });
            coolOpts.forEach(c => { eqRows += `<tr><td style="${cellS}">Cooling</td><td style="${cellS}font-weight:600;">${c.brand} ${c.model}</td><td style="${cellS}">${c.range || 'â€”'}</td><td style="${cellS}color:#6b7280;">${c.note}</td></tr>`; });
            genOpts.forEach(g => { eqRows += `<tr><td style="${cellS}">Generator</td><td style="${cellS}font-weight:600;">${g.brand} ${g.model}</td><td style="${cellS}">${g.range}</td><td style="${cellS}color:#6b7280;">${g.note}</td></tr>`; });
            eqRows += `<tr><td style="${cellS}">Fire Suppression</td><td style="${cellS}font-weight:600;">${fireInfo.agent}</td><td style="${cellS}">${fireInfo.density} / ${fireInfo.discharge}</td><td style="${cellS}color:#6b7280;">${fireInfo.note}</td></tr>`;
            const pdfRegionInfo = permitRegionMult[effReg] || permitRegionMult.usa;
            eqRows += `<tr><td style="${cellS}">Permits & Compliance</td><td style="${cellS}font-weight:600;">${effReg.toUpperCase()} region</td><td style="${cellS}">â€”</td><td style="${cellS}color:#6b7280;">${pdfRegionInfo.label}</td></tr>`;

            // Total capacity metrics
            const totalUpsKva = Math.ceil(result.itLoad * 1.15);
            const totalGenMw = (result.itLoad * result.pue / 1000 * (redundancy === '2n' || redundancy === '2n1' ? 2 : 1.25)).toFixed(1);
            const coolingKw = Math.ceil(result.itLoad * result.pue * 0.35);

            // Sustainability
            const annualMWh = result.itLoad * result.pue * 8760 / 1000;
            const co2Tons = annualMWh * 0.4;
            const waterM3 = coolingType === 'liquid' ? result.itLoad * 0.5 : result.itLoad * 2.5;

            return `
            <div style="page-break-before:auto;margin-top:28px;">
                <h2 style="font-size:15px;color:#1e3a5f;border-bottom:2px solid #8b5cf6;padding-bottom:6px;margin-bottom:14px;">
                    <span style="color:#8b5cf6;">&#9733;</span> Premium: Infrastructure Summary
                </h2>

                <!-- KPI Cards -->
                ${savedScenario ? (function(){
                    const aR = savedScenario;
                    const aRw = aR._raw || {};
                    const aRacks = Math.ceil(aR.itLoad / rackKw[aRw.rackType || 'standard']);
                    const aFloor = Math.ceil(aRacks * rackFootprint);
                    const aTl = aR._timeline || { totalMonths: 0 };
                    const aMWh = aR.itLoad * aR.pue * 8760 / 1000;
                    const cardS = 'flex:1;border-radius:8px;padding:10px;text-align:center;';
                    const lblS = 'font-size:9px;text-transform:uppercase;margin-bottom:2px;';
                    const valS = 'font-size:18px;font-weight:700;';
                    const subS = 'font-size:9px;color:#6b7280;';
                    return '<div style="display:flex;gap:12px;margin-bottom:16px;">' +
                        '<div style="flex:1;">' +
                            '<div style="font-size:10px;font-weight:700;color:#d97706;margin-bottom:6px;">SCENARIO A</div>' +
                            '<div style="display:flex;gap:8px;">' +
                                '<div style="' + cardS + 'background:#fffbeb;border:1px solid #fde68a;"><div style="' + lblS + 'color:#92400e;">Racks</div><div style="' + valS + 'color:#d97706;">' + aRacks + '</div><div style="' + subS + '">' + aR.itLoad.toLocaleString() + ' kW</div></div>' +
                                '<div style="' + cardS + 'background:#fffbeb;border:1px solid #fde68a;"><div style="' + lblS + 'color:#92400e;">White Space</div><div style="' + valS + 'color:#d97706;">' + aFloor.toLocaleString() + ' mÂ²</div><div style="' + subS + '">~' + Math.ceil(aFloor*1.8).toLocaleString() + ' mÂ² gross</div></div>' +
                                '<div style="' + cardS + 'background:#fffbeb;border:1px solid #fde68a;"><div style="' + lblS + 'color:#92400e;">Build Time</div><div style="' + valS + 'color:#d97706;">' + aTl.totalMonths + ' mo</div><div style="' + subS + '">Design to COD</div></div>' +
                                '<div style="' + cardS + 'background:#fffbeb;border:1px solid #fde68a;"><div style="' + lblS + 'color:#92400e;">$/kW</div><div style="' + valS + 'color:#d97706;">$' + Math.round(aR.total/aR.itLoad).toLocaleString() + '</div><div style="' + subS + '">' + (aR.total/1e6).toFixed(1) + 'M total</div></div>' +
                                '<div style="' + cardS + 'background:#fffbeb;border:1px solid #fde68a;"><div style="' + lblS + 'color:#92400e;">Energy</div><div style="' + valS + 'color:#d97706;">' + (aMWh/1000).toFixed(1) + ' GWh</div><div style="' + subS + '">PUE ' + aR.pue.toFixed(2) + '</div></div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div style="display:flex;gap:12px;margin-bottom:16px;">' +
                        '<div style="flex:1;">' +
                            '<div style="font-size:10px;font-weight:700;color:#059669;margin-bottom:6px;">SCENARIO B</div>' +
                            '<div style="display:flex;gap:8px;">' +
                                '<div style="' + cardS + 'background:#ecfdf5;border:1px solid #a7f3d0;"><div style="' + lblS + 'color:#065f46;">Racks</div><div style="' + valS + 'color:#059669;">' + racks + '</div><div style="' + subS + '">' + result.itLoad.toLocaleString() + ' kW</div></div>' +
                                '<div style="' + cardS + 'background:#ecfdf5;border:1px solid #a7f3d0;"><div style="' + lblS + 'color:#065f46;">White Space</div><div style="' + valS + 'color:#059669;">' + floorM2.toLocaleString() + ' mÂ²</div><div style="' + subS + '">~' + Math.ceil(floorM2*1.8).toLocaleString() + ' mÂ² gross</div></div>' +
                                '<div style="' + cardS + 'background:#ecfdf5;border:1px solid #a7f3d0;"><div style="' + lblS + 'color:#065f46;">Build Time</div><div style="' + valS + 'color:#059669;">' + totalMonths + ' mo</div><div style="' + subS + '">Design to COD</div></div>' +
                                '<div style="' + cardS + 'background:#ecfdf5;border:1px solid #a7f3d0;"><div style="' + lblS + 'color:#065f46;">$/kW</div><div style="' + valS + 'color:#059669;">$' + Math.round(result.total/result.itLoad).toLocaleString() + '</div><div style="' + subS + '">' + (result.total/1e6).toFixed(1) + 'M total</div></div>' +
                                '<div style="' + cardS + 'background:#ecfdf5;border:1px solid #a7f3d0;"><div style="' + lblS + 'color:#065f46;">Energy</div><div style="' + valS + 'color:#059669;">' + (annualMWh/1000).toFixed(1) + ' GWh</div><div style="' + subS + '">PUE ' + result.pue.toFixed(2) + '</div></div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                })() : `
                <div style="display:flex;gap:10px;margin-bottom:16px;">
                    <div style="flex:1;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center;">
                        <div style="font-size:9px;color:#6b7280;text-transform:uppercase;">Est. Racks</div>
                        <div style="font-size:20px;font-weight:700;color:#1e3a5f;">${racks}</div>
                        <div style="font-size:9px;color:#6b7280;">${rackKw[rackType]} kW/rack</div>
                    </div>
                    <div style="flex:1;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center;">
                        <div style="font-size:9px;color:#6b7280;text-transform:uppercase;">White Space</div>
                        <div style="font-size:20px;font-weight:700;color:#1e3a5f;">${floorM2.toLocaleString()} mÂ²</div>
                        <div style="font-size:9px;color:#6b7280;">~${Math.ceil(floorM2*1.8).toLocaleString()} mÂ² gross</div>
                    </div>
                    <div style="flex:1;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center;">
                        <div style="font-size:9px;color:#6b7280;text-transform:uppercase;">Build Time</div>
                        <div style="font-size:20px;font-weight:700;color:#1e3a5f;">${totalMonths} mo</div>
                        <div style="font-size:9px;color:#6b7280;">Design to COD</div>
                    </div>
                    <div style="flex:1;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center;">
                        <div style="font-size:9px;color:#6b7280;text-transform:uppercase;">$/kW</div>
                        <div style="font-size:20px;font-weight:700;color:#f59e0b;">$${Math.round(result.total/result.itLoad).toLocaleString()}</div>
                        <div style="font-size:9px;color:#6b7280;">per kW IT Load</div>
                    </div>
                    <div style="flex:1;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center;">
                        <div style="font-size:9px;color:#6b7280;text-transform:uppercase;">Annual Energy</div>
                        <div style="font-size:20px;font-weight:700;color:#1e3a5f;">${(annualMWh/1000).toFixed(1)} GWh</div>
                        <div style="font-size:9px;color:#6b7280;">PUE ${result.pue.toFixed(2)}</div>
                    </div>
                </div>
                `}

                ${savedScenario ? buildPremiumComparisonHTML(savedScenario, result, cellS, hdrS) : `
                <!-- Design & Delivery Concept -->
                <h3 style="font-size:13px;color:#1e3a5f;border-bottom:1px solid #e5e7eb;padding-bottom:4px;margin:16px 0 8px;">Design & Delivery Concept</h3>
                <div style="display:flex;gap:16px;margin-bottom:12px;">
                    <table style="flex:1;border-collapse:collapse;font-size:11px;">
                        <tr style="background:#1e3a5f;color:white;"><th style="${hdrS}" colspan="2">Facility Design</th></tr>
                        <tr><td style="${cellS}color:#6b7280;">Building Type</td><td style="${cellS}font-weight:600;">${cfg.buildingType}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Redundancy</td><td style="${cellS}font-weight:600;">${cfg.redundancy} (${cfg.tier})</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Cooling Strategy</td><td style="${cellS}font-weight:600;">${cfg.coolingType}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Rack Density</td><td style="${cellS}font-weight:600;">${cfg.rackDensity}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">UPS Architecture</td><td style="${cellS}font-weight:600;">${cfg.upsType}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Generator</td><td style="${cellS}font-weight:600;">${cfg.genType} (${cfg.fuelHours} fuel)</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Fire Suppression</td><td style="${cellS}font-weight:600;">${cfg.fireSuppression}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Floor Construction</td><td style="${cellS}font-weight:600;">${cfg.floorType}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Site Condition</td><td style="${cellS}font-weight:600;">${cfg.siteCondition}</td></tr>
                    </table>
                    <table style="flex:1;border-collapse:collapse;font-size:11px;">
                        <tr style="background:#1e3a5f;color:white;"><th style="${hdrS}" colspan="2">Electrical & Connectivity</th></tr>
                        <tr><td style="${cellS}color:#6b7280;">Power Distribution</td><td style="${cellS}font-weight:600;">${cfg.powerDistribution}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Transformer Type</td><td style="${cellS}font-weight:600;">${cfg.transformerType}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">PDU Type</td><td style="${cellS}font-weight:600;">${cfg.pduType}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Structured Cabling</td><td style="${cellS}font-weight:600;">${cfg.cablingType}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Fiber Entry</td><td style="${cellS}font-weight:600;">${cfg.fiberEntry}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Security Level</td><td style="${cellS}font-weight:600;">${cfg.securityLevel}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Green Certification</td><td style="${cellS}font-weight:600;">${cfg.greenCert}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">On-Site Renewable</td><td style="${cellS}font-weight:600;">${cfg.renewable}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Front-of-Meter</td><td style="${cellS}font-weight:600;">${cfg.fomIncluded === 'Yes' ? cfg.substationType + ' â€” ' + cfg.transformerLead : 'Not included'}</td></tr>
                    </table>
                </div>
                <div style="display:flex;gap:16px;margin-bottom:12px;">
                    <table style="flex:1;border-collapse:collapse;font-size:11px;">
                        <tr style="background:#1e3a5f;color:white;"><th style="${hdrS}" colspan="2">Project Delivery</th></tr>
                        <tr><td style="${cellS}color:#6b7280;">Delivery Method</td><td style="${cellS}font-weight:600;">${cfg.deliveryMethod}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Market Condition</td><td style="${cellS}font-weight:600;">${cfg.marketCondition}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Contractor Availability</td><td style="${cellS}font-weight:600;">${cfg.contractorAvail}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Projection Year</td><td style="${cellS}font-weight:600;">${cfg.yearLabel}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Location / Region</td><td style="${cellS}font-weight:600;">${cfg.location}${cfg.cityLabel !== 'â€”' ? ' â€” ' + cfg.cityLabel : ''}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Permits / Compliance</td><td style="${cellS}font-weight:600;">${cfg.effectiveRegion || 'â€”'}</td></tr>
                    </table>
                    <table style="flex:1;border-collapse:collapse;font-size:11px;">
                        <tr style="background:#1e3a5f;color:white;"><th style="${hdrS}" colspan="2">Project Cost Assumptions</th></tr>
                        <tr><td style="${cellS}color:#6b7280;">Design & Engineering</td><td style="${cellS}font-weight:600;">${cfg.designFee} of hard costs</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Project Management</td><td style="${cellS}font-weight:600;">${cfg.pmFee} of hard costs</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Contingency Reserve</td><td style="${cellS}font-weight:600;">${cfg.contingency} of subtotal</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Utility Rate of Return</td><td style="${cellS}font-weight:600;">${cfg.fomIncluded === 'Yes' ? cfg.utilityRate : 'N/A'}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Green Cert Premium</td><td style="${cellS}font-weight:600;">${cfg.greenCert !== 'None' ? cfg.greenCert : 'N/A'}</td></tr>
                        <tr><td style="${cellS}color:#6b7280;">Renewable CAPEX</td><td style="${cellS}font-weight:600;">${cfg.renewable !== 'None' ? cfg.renewable : 'N/A'}</td></tr>
                    </table>
                </div>

                <!-- Capacity Summary -->
                <h3 style="font-size:13px;color:#1e3a5f;border-bottom:1px solid #e5e7eb;padding-bottom:4px;margin:16px 0 8px;">Capacity Summary</h3>
                <table style="width:100%;border-collapse:collapse;font-size:11px;">
                    <tr style="background:#1e3a5f;color:white;"><th style="${hdrS}">System</th><th style="${hdrS}">Total Capacity</th><th style="${hdrS}">Per Rack</th><th style="${hdrS}">Notes</th></tr>
                    <tr><td style="${cellS}font-weight:600;">IT Load</td><td style="${cellS}">${result.itLoad.toLocaleString()} kW (${(result.itLoad/1000).toFixed(1)} MW)</td><td style="${cellS}">${rackKw[rackType]} kW/rack</td><td style="${cellS}color:#6b7280;">${racks} racks total</td></tr>
                    <tr><td style="${cellS}font-weight:600;">UPS</td><td style="${cellS}">${totalUpsKva.toLocaleString()} kVA</td><td style="${cellS}">${(totalUpsKva/racks).toFixed(1)} kVA/rack</td><td style="${cellS}color:#6b7280;">15% safety margin included</td></tr>
                    <tr><td style="${cellS}font-weight:600;">Generator</td><td style="${cellS}">${totalGenMw} MW</td><td style="${cellS}">â€”</td><td style="${cellS}color:#6b7280;">${redundancy === '2n' || redundancy === '2n1' ? '2x redundancy' : 'N+1 redundancy'}</td></tr>
                    <tr><td style="${cellS}font-weight:600;">Cooling</td><td style="${cellS}">${coolingKw.toLocaleString()} kW</td><td style="${cellS}">${(coolingKw/racks).toFixed(1)} kW/rack</td><td style="${cellS}color:#6b7280;">~35% of total facility load</td></tr>
                    <tr><td style="${cellS}font-weight:600;">Floor Space</td><td style="${cellS}">${floorM2.toLocaleString()} mÂ² (white) / ~${Math.ceil(floorM2*1.8).toLocaleString()} mÂ² (gross)</td><td style="${cellS}">${rackFootprint.toFixed(1)} mÂ²/rack</td><td style="${cellS}color:#6b7280;">${Math.ceil(racks * 0.3)} kW/mÂ² density</td></tr>
                </table>

                <!-- Recommended Equipment Specification -->
                <h3 style="font-size:13px;color:#1e3a5f;border-bottom:1px solid #e5e7eb;padding-bottom:4px;margin:16px 0 8px;">Recommended Equipment Specification</h3>
                <table style="width:100%;border-collapse:collapse;">
                    <tr style="background:#1e3a5f;color:white;"><th style="${hdrS}">System</th><th style="${hdrS}">Brand / Model</th><th style="${hdrS}">Capacity</th><th style="${hdrS}">Notes</th></tr>
                    ${eqRows}
                </table>

                <!-- Construction Timeline with Parallel Gantt -->
                <h3 style="font-size:13px;color:#1e3a5f;border-bottom:1px solid #e5e7eb;padding-bottom:4px;margin:16px 0 8px;">Estimated Construction Timeline (Parallel Model)</h3>
                <p style="font-size:9px;color:#6b7280;margin:0 0 8px;">Phases shown with realistic overlaps â€” permitting parallels design, MEP overlaps civil, procurement runs during design/civil.</p>
                ${buildTimelineGanttHTML(phases, totalMonths, cellS, hdrS)}
                <table style="width:100%;border-collapse:collapse;font-size:11px;margin-top:8px;">
                    <tr style="background:#1e3a5f;color:white;"><th style="${hdrS}">Phase</th><th style="${hdrS}">Duration</th><th style="${hdrS}">Start â†’ End</th><th style="${hdrS}">Key Factors</th></tr>
                    <tr><td style="${cellS}font-weight:600;">Design & Engineering</td><td style="${cellS}">${phases.design} mo</td><td style="${cellS}">Mo 0 â†’ ${phases.phases[0].end}</td><td style="${cellS}color:#6b7280;">${result.itLoad > 10000 ? 'Scaled for ' + (result.itLoad/1000).toFixed(0) + ' MW facility' : 'Standard design scope'}</td></tr>
                    <tr><td style="${cellS}font-weight:600;">Permitting & Approvals</td><td style="${cellS}">${phases.permit} mo</td><td style="${cellS}">Mo ${phases.phases[1].start} â†’ ${phases.phases[1].end}</td><td style="${cellS}color:#6b7280;">${pdfRegionInfo.label.split(',')[0]} (overlaps design)</td></tr>
                    <tr><td style="${cellS}font-weight:600;">Procurement (Long-Lead)</td><td style="${cellS}">${phases.procurement} mo</td><td style="${cellS}">Mo ${phases.phases[2].start} â†’ ${phases.phases[2].end}</td><td style="${cellS}color:#6b7280;">Major equipment lead time</td></tr>
                    <tr><td style="${cellS}font-weight:600;">Civil & Structural</td><td style="${cellS}">${phases.civil} mo</td><td style="${cellS}">Mo ${phases.phases[3].start} â†’ ${phases.phases[3].end}</td><td style="${cellS}color:#6b7280;">${cfg.buildingType} construction</td></tr>
                    <tr><td style="${cellS}font-weight:600;">MEP Installation</td><td style="${cellS}">${phases.mep} mo</td><td style="${cellS}">Mo ${phases.phases[4].start} â†’ ${phases.phases[4].end}</td><td style="${cellS}color:#6b7280;">${coolingType === 'liquid' ? 'DLC pipework +30%' : coolingType === 'rdhx' ? 'RDHX plumbing +15%' : 'Standard MEP scope'} (overlaps 50% civil)</td></tr>
                    <tr><td style="${cellS}font-weight:600;">Testing & Commissioning</td><td style="${cellS}">${phases.commission} mo</td><td style="${cellS}">Mo ${phases.phases[5].start} â†’ ${phases.phases[5].end}</td><td style="${cellS}color:#6b7280;">${redundancy === '2n1' ? 'Full IST/ISST for 2N+1' : redundancy === '2n' ? 'IST required for 2N' : 'Standard Cx scope'}</td></tr>
                    <tr style="background:#f0f7ff;"><td style="${cellS}font-weight:700;">Total (Design â†’ COD)</td><td style="${cellS}font-weight:700;">${totalMonths} months</td><td style="${cellS}font-weight:700;">~${(totalMonths/12).toFixed(1)} years</td><td style="${cellS}font-weight:600;color:#1e3a5f;">Parallel model saves ~${Math.round((phases.design + phases.permit + phases.procurement + phases.civil + phases.mep + phases.commission - totalMonths) / totalMonths * 100)}% vs serial</td></tr>
                </table>

                <!-- Sustainability & Efficiency -->
                <h3 style="font-size:13px;color:#1e3a5f;border-bottom:1px solid #e5e7eb;padding-bottom:4px;margin:16px 0 8px;">Sustainability & Efficiency</h3>
                ${buildSustainabilityHTML(result, coolingType, effReg, racks, floorM2, annualMWh, cellS, hdrS)}
                `}
            </div>`;
        }

        // â•â•â• PREMIUM A vs B COMPARISON (Timeline + Sustainability + Capacity) â•â•â•
        function buildPremiumComparisonHTML(a, b, cellS, hdrS) {
            const aTimeline = a._timeline;
            const bTimeline = b._timeline;
            const aRaw = a._raw || {};
            const bRaw = b._raw || {};
            if (!aTimeline || !bTimeline) return '';

            const aRacks = Math.ceil(a.itLoad / rackKw[aRaw.rackType || 'standard']);
            const bRacks = Math.ceil(b.itLoad / rackKw[bRaw.rackType || 'standard']);
            const aFloor = Math.ceil(aRacks * rackFootprint);
            const bFloor = Math.ceil(bRacks * rackFootprint);
            const aUpsKva = Math.ceil(a.itLoad * 1.15);
            const bUpsKva = Math.ceil(b.itLoad * 1.15);
            const aRed = aRaw.redundancy || 'n1';
            const bRed = bRaw.redundancy || 'n1';
            const aGenMw = (a.itLoad * a.pue / 1000 * (aRed === '2n' || aRed === '2n1' ? 2 : 1.25)).toFixed(1);
            const bGenMw = (b.itLoad * b.pue / 1000 * (bRed === '2n' || bRed === '2n1' ? 2 : 1.25)).toFixed(1);
            const aCoolKw = Math.ceil(a.itLoad * a.pue * 0.35);
            const bCoolKw = Math.ceil(b.itLoad * b.pue * 0.35);

            // ESG comparison
            const aEf = gridEmissionFactor[aRaw.effectiveRegion] || 0.4;
            const bEf = gridEmissionFactor[bRaw.effectiveRegion] || 0.4;
            const aMWh = a.itLoad * a.pue * 8760 / 1000;
            const bMWh = b.itLoad * b.pue * 8760 / 1000;
            const aCo2 = aMWh * aEf;
            const bCo2 = bMWh * bEf;
            const aWue = wueByCooling[aRaw.coolingType] || 0;
            const bWue = wueByCooling[bRaw.coolingType] || 0;
            const aWater = aWue * a.itLoad * a.pue * 8760 / 1000;
            const bWater = bWue * b.itLoad * b.pue * 8760 / 1000;
            const aRefrig = refrigerantData[aRaw.coolingType] || refrigerantData.air;
            const bRefrig = refrigerantData[bRaw.coolingType] || refrigerantData.air;

            const dFmt = (aV, bV, unit) => {
                if (!aV && !bV) return '';
                const d = ((bV - aV) / (aV || 1) * 100);
                const clr = d > 0 ? '#ef4444' : d < 0 ? '#10b981' : '#6b7280';
                return '<span style="color:' + clr + ';font-weight:600;">' + (d >= 0 ? '+' : '') + d.toFixed(1) + '% ' + (unit || '') + '</span>';
            };

            let html = '<div style="page-break-before:auto;margin-top:24px;">' +
                '<h2 style="font-size:15px;color:#1e3a5f;border-bottom:2px solid #f59e0b;padding-bottom:6px;margin-bottom:14px;">Scenario A vs B: Infrastructure Comparison</h2>';

            // Timeline comparison
            html += '<h3 style="font-size:13px;color:#1e3a5f;margin:12px 0 8px;">Construction Timeline</h3>' +
                '<div style="display:flex;gap:16px;">' +
                    '<div style="flex:1;"><div style="font-size:10px;font-weight:700;color:#fbbf24;margin-bottom:6px;">SCENARIO A â€” ' + aTimeline.totalMonths + ' months</div>' + buildTimelineGanttHTML(aTimeline, Math.max(aTimeline.totalMonths, bTimeline.totalMonths), cellS, hdrS) + '</div>' +
                    '<div style="flex:1;"><div style="font-size:10px;font-weight:700;color:#34d399;margin-bottom:6px;">SCENARIO B â€” ' + bTimeline.totalMonths + ' months</div>' + buildTimelineGanttHTML(bTimeline, Math.max(aTimeline.totalMonths, bTimeline.totalMonths), cellS, hdrS) + '</div>' +
                '</div>';

            // Design & Delivery Concept comparison
            const aCfg = a._config || {};
            const bCfg = b._config || {};
            const designRows = [
                ['Building Type', 'buildingType'],
                ['Redundancy', 'redundancy'],
                ['Cooling Strategy', 'coolingType'],
                ['Rack Density', 'rackDensity'],
                ['UPS Architecture', 'upsType'],
                ['Generator', 'genType'],
                ['Fire Suppression', 'fireSuppression'],
                ['Floor Construction', 'floorType'],
                ['Site Condition', 'siteCondition'],
                ['Power Distribution', 'powerDistribution'],
                ['Transformer Type', 'transformerType'],
                ['PDU Type', 'pduType'],
                ['Structured Cabling', 'cablingType'],
                ['Fiber Entry', 'fiberEntry'],
                ['Security Level', 'securityLevel'],
                ['Green Certification', 'greenCert'],
                ['On-Site Renewable', 'renewable'],
                ['Delivery Method', 'deliveryMethod'],
                ['Market Condition', 'marketCondition'],
                ['Location / Region', 'location'],
            ];
            html += '<h3 style="font-size:13px;color:#1e3a5f;margin:16px 0 8px;">Design & Delivery Concept</h3>' +
                '<table style="width:100%;border-collapse:collapse;font-size:11px;">' +
                '<tr style="background:#1e3a5f;color:white;"><th style="' + hdrS + '">Parameter</th><th style="' + hdrS + '">Scenario A</th><th style="' + hdrS + '">Scenario B</th><th style="' + hdrS + '">Change</th></tr>';
            designRows.forEach(function(r) {
                var aVal = aCfg[r[1]] || '\u2014';
                var bVal = bCfg[r[1]] || '\u2014';
                var changed = aVal !== bVal;
                html += '<tr' + (changed ? ' style="background:#fffbeb;"' : '') + '><td style="' + cellS + 'font-weight:600;">' + r[0] + '</td><td style="' + cellS + '">' + aVal + '</td><td style="' + cellS + '">' + bVal + '</td><td style="' + cellS + (changed ? 'color:#f59e0b;font-weight:600;"' : '"') + '>' + (changed ? 'Changed' : '\u2014') + '</td></tr>';
            });
            html += '</table>';

            // Equipment Specification comparison
            var aUpsOpts = equipmentBrands.ups[aRaw.upsType] || equipmentBrands.ups.modular;
            var bUpsOpts = equipmentBrands.ups[bRaw.upsType] || equipmentBrands.ups.modular;
            var aCoolOpts = equipmentBrands.cooling[aRaw.coolingType] || equipmentBrands.cooling.air;
            var bCoolOpts = equipmentBrands.cooling[bRaw.coolingType] || equipmentBrands.cooling.air;
            var aGenOpts = equipmentBrands.generator[aRaw.genType] || equipmentBrands.generator.diesel;
            var bGenOpts = equipmentBrands.generator[bRaw.genType] || equipmentBrands.generator.diesel;
            var aFireInfo = equipmentBrands.fire[aRaw.fireType] || equipmentBrands.fire.novec;
            var bFireInfo = equipmentBrands.fire[bRaw.fireType] || equipmentBrands.fire.novec;

            function eqRow(sys, aItems, bItems) {
                var aText = aItems.join(', ') || '\u2014';
                var bText = bItems.join(', ') || '\u2014';
                var changed = aText !== bText;
                return '<tr' + (changed ? ' style="background:#fffbeb;"' : '') + '><td style="' + cellS + 'font-weight:600;">' + sys + '</td><td style="' + cellS + '">' + aText + '</td><td style="' + cellS + '">' + bText + '</td><td style="' + cellS + (changed ? 'color:#f59e0b;font-weight:600;"' : '"') + '>' + (changed ? 'Changed' : '\u2014') + '</td></tr>';
            }

            html += '<h3 style="font-size:13px;color:#1e3a5f;margin:16px 0 8px;">Recommended Equipment Specification</h3>' +
                '<table style="width:100%;border-collapse:collapse;font-size:11px;">' +
                '<tr style="background:#1e3a5f;color:white;"><th style="' + hdrS + '">System</th><th style="' + hdrS + '">Scenario A</th><th style="' + hdrS + '">Scenario B</th><th style="' + hdrS + '">Change</th></tr>' +
                eqRow('UPS', aUpsOpts.map(function(u){return u.brand+' '+u.model;}), bUpsOpts.map(function(u){return u.brand+' '+u.model;})) +
                eqRow('Cooling', aCoolOpts.map(function(c){return c.brand+' '+c.model;}), bCoolOpts.map(function(c){return c.brand+' '+c.model;})) +
                eqRow('Generator', aGenOpts.map(function(g){return g.brand+' '+g.model;}), bGenOpts.map(function(g){return g.brand+' '+g.model;})) +
                eqRow('Fire Suppression', [aFireInfo.agent || '\u2014'], [bFireInfo.agent || '\u2014']) +
                '</table>';

            // Capacity comparison table
            html += '<h3 style="font-size:13px;color:#1e3a5f;margin:16px 0 8px;">Capacity Summary</h3>' +
                '<table style="width:100%;border-collapse:collapse;font-size:11px;">' +
                '<tr style="background:#1e3a5f;color:white;"><th style="' + hdrS + '">Metric</th><th style="' + hdrS + '">Scenario A</th><th style="' + hdrS + '">Scenario B</th><th style="' + hdrS + '">Delta</th></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">IT Load</td><td style="' + cellS + '">' + a.itLoad.toLocaleString() + ' kW</td><td style="' + cellS + '">' + b.itLoad.toLocaleString() + ' kW</td><td style="' + cellS + '">' + dFmt(a.itLoad, b.itLoad) + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Racks</td><td style="' + cellS + '">' + aRacks + '</td><td style="' + cellS + '">' + bRacks + '</td><td style="' + cellS + '">' + dFmt(aRacks, bRacks) + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">White Space</td><td style="' + cellS + '">' + aFloor.toLocaleString() + ' m\u00B2</td><td style="' + cellS + '">' + bFloor.toLocaleString() + ' m\u00B2</td><td style="' + cellS + '">' + dFmt(aFloor, bFloor) + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">UPS Capacity</td><td style="' + cellS + '">' + aUpsKva.toLocaleString() + ' kVA</td><td style="' + cellS + '">' + bUpsKva.toLocaleString() + ' kVA</td><td style="' + cellS + '">' + dFmt(aUpsKva, bUpsKva) + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Generator</td><td style="' + cellS + '">' + aGenMw + ' MW</td><td style="' + cellS + '">' + bGenMw + ' MW</td><td style="' + cellS + '">' + dFmt(parseFloat(aGenMw), parseFloat(bGenMw)) + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Cooling Capacity</td><td style="' + cellS + '">' + aCoolKw.toLocaleString() + ' kW</td><td style="' + cellS + '">' + bCoolKw.toLocaleString() + ' kW</td><td style="' + cellS + '">' + dFmt(aCoolKw, bCoolKw) + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Build Time</td><td style="' + cellS + '">' + aTimeline.totalMonths + ' months</td><td style="' + cellS + '">' + bTimeline.totalMonths + ' months</td><td style="' + cellS + '">' + dFmt(aTimeline.totalMonths, bTimeline.totalMonths) + '</td></tr>' +
                '</table>';

            // Sustainability comparison
            html += '<h3 style="font-size:13px;color:#1e3a5f;margin:16px 0 8px;">Sustainability Comparison</h3>' +
                '<table style="width:100%;border-collapse:collapse;font-size:11px;">' +
                '<tr style="background:#1e3a5f;color:white;"><th style="' + hdrS + '">Metric</th><th style="' + hdrS + '">Scenario A</th><th style="' + hdrS + '">Scenario B</th><th style="' + hdrS + '">Delta</th></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">PUE</td><td style="' + cellS + '">' + a.pue.toFixed(2) + '</td><td style="' + cellS + '">' + b.pue.toFixed(2) + '</td><td style="' + cellS + '">' + dFmt(a.pue, b.pue) + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Annual Energy</td><td style="' + cellS + '">' + (aMWh/1000).toFixed(1) + ' GWh</td><td style="' + cellS + '">' + (bMWh/1000).toFixed(1) + ' GWh</td><td style="' + cellS + '">' + dFmt(aMWh, bMWh) + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Grid Emission Factor</td><td style="' + cellS + '">' + aEf.toFixed(2) + ' tCO\u2082/MWh</td><td style="' + cellS + '">' + bEf.toFixed(2) + ' tCO\u2082/MWh</td><td style="' + cellS + '">' + (aEf !== bEf ? 'Different regions' : 'Same') + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Scope 2 CO\u2082</td><td style="' + cellS + '">' + aCo2.toLocaleString(undefined,{maximumFractionDigits:0}) + ' t/yr</td><td style="' + cellS + '">' + bCo2.toLocaleString(undefined,{maximumFractionDigits:0}) + ' t/yr</td><td style="' + cellS + '">' + dFmt(aCo2, bCo2) + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">WUE</td><td style="' + cellS + '">' + aWue.toFixed(1) + ' L/kWh</td><td style="' + cellS + '">' + bWue.toFixed(1) + ' L/kWh</td><td style="' + cellS + '">' + (aWue !== bWue ? dFmt(aWue || 0.001, bWue || 0.001) : 'Same') + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Water Usage</td><td style="' + cellS + '">' + (aWater > 0 ? aWater.toLocaleString(undefined,{maximumFractionDigits:0}) + ' m\u00B3/yr' : 'None') + '</td><td style="' + cellS + '">' + (bWater > 0 ? bWater.toLocaleString(undefined,{maximumFractionDigits:0}) + ' m\u00B3/yr' : 'None') + '</td><td style="' + cellS + '">' + (aWater && bWater ? dFmt(aWater, bWater) : '\u2014') + '</td></tr>' +
                '<tr><td style="' + cellS + 'font-weight:600;">Refrigerant</td><td style="' + cellS + '">' + aRefrig.type + (aRefrig.gwp ? ' (GWP ' + aRefrig.gwp.toLocaleString() + ')' : '') + '</td><td style="' + cellS + '">' + bRefrig.type + (bRefrig.gwp ? ' (GWP ' + bRefrig.gwp.toLocaleString() + ')' : '') + '</td><td style="' + cellS + '">' + (aRefrig.type !== bRefrig.type ? 'Different type' : 'Same') + '</td></tr>' +
                '</table>';

            html += '</div>';
            return html;
        }

        // â•â•â• CAPEX NARRATIVE CONCLUSION â•â•â•
        function generateCapexNarrative(result, hasCompare, savedA) {
            const total = result.total;
            const perKW = total / result.itLoad;
            const itKW = result.itLoad;
            const mw = itKW / 1000;
            const pue = result.pue;
            const tier = result.tierInfo.tier;
            const costs = result.costs;
            const cfg = result._config || {};
            const timeline = result._timeline;
            const raw = result._raw || {};

            // Sort costs to find top contributors
            const sorted = Object.entries(costs).sort((a, b) => b[1] - a[1]);
            const topCost = sorted[0] || ['unknown', 0];
            const topPct = ((topCost[1] / total) * 100).toFixed(1);
            const top3 = sorted.slice(0, 3);

            // $/kW benchmarking
            let costProfile;
            if (perKW < 8000) costProfile = { label: 'Ultra-Lean', color: '#059669', desc: 'well below industry average. This may indicate a lean facility design (warehouse conversion, air-cooled, lower redundancy) or favorable market conditions. Verify that reliability and quality standards are not compromised.' };
            else if (perKW < 12000) costProfile = { label: 'Cost-Efficient', color: '#0284c7', desc: 'below the industry midpoint for ' + tier + ' facilities. The design achieves good value through efficient component selection and/or favorable location factors.' };
            else if (perKW < 18000) costProfile = { label: 'Market Rate', color: '#d97706', desc: 'within the typical range for ' + tier + ' data center construction. Cost is consistent with current market conditions for ' + (cfg.buildingType || 'standard') + ' facilities with ' + (cfg.coolingType || 'standard') + ' cooling.' };
            else if (perKW < 25000) costProfile = { label: 'Premium Build', color: '#dc2626', desc: 'above average, typical for purpose-built facilities with high redundancy, premium cooling (RDHX/DLC), and comprehensive infrastructure. The premium reflects higher reliability and operational efficiency.' };
            else costProfile = { label: 'Hyperscale/Complex', color: '#7c3aed', desc: 'in the upper range, consistent with large-scale, mission-critical deployments requiring maximum redundancy, liquid cooling, extensive utility infrastructure, and stringent compliance.' };

            // Cost structure analysis
            const mechPct = ((costs.cooling || 0) / total * 100);
            const elecPct = (((costs.ups || 0) + (costs.generator || 0) + (costs.switchgear || 0)) / total * 100);
            const civilPct = (((costs.building || 0) + (costs.raisedFloor || 0)) / total * 100);
            const itInfra = (((costs.racks || 0) + (costs.cabling || 0) + (costs.pdu || 0)) / total * 100);

            let structureNarrative;
            if (elecPct > 35) structureNarrative = 'Electrical infrastructure dominates at ' + elecPct.toFixed(0) + '% of CAPEX, driven by ' + (cfg.upsType || 'UPS') + ' and generator requirements. This is typical for high-redundancy designs where 2N electrical paths are specified.';
            else if (mechPct > 25) structureNarrative = 'Mechanical/cooling systems represent ' + mechPct.toFixed(0) + '% of CAPEX, reflecting the ' + (cfg.coolingType || 'selected') + ' cooling strategy. Advanced cooling solutions (RDHX, DLC) command higher upfront cost but deliver significantly better PUE and lower long-term OPEX.';
            else if (civilPct > 30) structureNarrative = 'Civil/structural costs are the primary driver at ' + civilPct.toFixed(0) + '% of CAPEX. This may indicate purpose-built construction, high-rise design, or challenging site conditions requiring significant foundation and structural work.';
            else structureNarrative = 'Cost distribution is well-balanced across electrical (' + elecPct.toFixed(0) + '%), mechanical (' + mechPct.toFixed(0) + '%), and civil (' + civilPct.toFixed(0) + '%) systems. This suggests a well-optimized design without any single system dominating the budget.';

            // PUE analysis
            let pueNarrative;
            if (pue <= 1.2) pueNarrative = 'Design PUE of ' + pue.toFixed(2) + ' is best-in-class, achievable with ' + (cfg.coolingType || 'advanced') + ' cooling. Annual energy cost of <strong>' + formatCurrency(result.annualEnergy) + '</strong> reflects excellent efficiency. The CAPEX premium for advanced cooling is offset by estimated annual energy savings of $' + Math.round((1.5 - pue) * itKW * 8760 * 0.08 / 1000).toLocaleString() + 'K versus a PUE 1.5 baseline.';
            else if (pue <= 1.4) pueNarrative = 'Design PUE of ' + pue.toFixed(2) + ' is above average. Annual energy consumption will be approximately ' + ((itKW * pue * 8760) / 1000000).toFixed(1) + ' GWh, costing <strong>' + formatCurrency(result.annualEnergy) + '/year</strong>. For every 0.1 PUE improvement, annual energy savings would be approximately $' + Math.round(0.1 * itKW * 8760 * 0.08 / 1000).toLocaleString() + 'K.';
            else pueNarrative = 'Design PUE of ' + pue.toFixed(2) + ' is average to below average. The facility will consume approximately ' + ((itKW * pue * 8760) / 1000000).toFixed(1) + ' GWh annually (' + formatCurrency(result.annualEnergy) + '/year). Consider investing in cooling upgrades â€” a 0.2 PUE improvement would save approximately $' + Math.round(0.2 * itKW * 8760 * 0.08 / 1000).toLocaleString() + 'K/year, potentially paying back within ' + Math.ceil(total * 0.05 / (0.2 * itKW * 8760 * 0.08 / 1000) * 10) / 10 + ' years.';

            // Timeline assessment
            let timelineNarrative = '';
            if (timeline) {
                const months = timeline.totalMonths;
                if (months <= 12) timelineNarrative = 'Estimated build time of <strong>' + months + ' months</strong> is aggressive and achievable with modular/prefab construction and parallel execution. Critical path risks include long-lead equipment procurement and permitting delays.';
                else if (months <= 24) timelineNarrative = 'Estimated build time of <strong>' + months + ' months</strong> is standard for a ' + (cfg.buildingType || 'data center') + ' facility of this scale. The parallel execution model saves approximately ' + Math.round((timeline.design + timeline.permit + timeline.procurement + timeline.civil + timeline.mep + timeline.commission - months) / (timeline.design + timeline.permit + timeline.procurement + timeline.civil + timeline.mep + timeline.commission) * 100) + '% versus serial execution.';
                else timelineNarrative = 'Estimated build time of <strong>' + months + ' months</strong> reflects the complexity of this project (scale, location, or regulatory requirements). Consider phased deployment to achieve partial revenue earlier, or modular construction to accelerate the critical path.';
            }

            // Risk factors
            let risks = [];
            if (perKW > 20000) risks.push({ level: 'HIGH', text: '<strong>Budget Risk:</strong> At $' + Math.round(perKW).toLocaleString() + '/kW, total investment of ' + formatCurrency(total) + ' is significant. Ensure contingency (' + (result.contingencyPct || 10) + '%) is adequate for scope changes and market volatility.' });
            if (pue > 1.6) risks.push({ level: 'HIGH', text: '<strong>Efficiency Risk:</strong> PUE ' + pue.toFixed(2) + ' will result in high ongoing energy costs. Consider cooling system upgrade during design phase â€” the marginal CAPEX increase may deliver substantial OPEX savings.' });
            if (sorted.some(([k, v]) => v / total > 0.25)) risks.push({ level: 'MEDIUM', text: '<strong>Concentration Risk:</strong> ' + (costFactors[topCost[0]]?.label || topCost[0]) + ' represents ' + topPct + '% of total CAPEX. Diversify vendor strategy and negotiate competitive bids for this component.' });
            if (timeline && timeline.totalMonths > 24) risks.push({ level: 'MEDIUM', text: '<strong>Schedule Risk:</strong> ' + timeline.totalMonths + '-month timeline increases exposure to material price escalation, labor market changes, and regulatory shifts. Lock in pricing for long-lead items early.' });
            if (raw.redundancy === '2n' || raw.redundancy === '2n1') risks.push({ level: 'LOW', text: '<strong>Over-Engineering Risk:</strong> Full ' + (raw.redundancy === '2n1' ? '2(N+1)' : '2N') + ' redundancy adds significant cost. Validate that SLA requirements justify this level of redundancy versus a ' + (raw.redundancy === '2n1' ? '2N' : 'N+1') + ' design.' });
            risks.push({ level: 'LOW', text: '<strong>Annual Review:</strong> Re-run this analysis with updated market conditions, commodity prices, and regulatory requirements before final procurement decisions.' });

            const riskHTML = risks.map(r => {
                const c = r.level === 'HIGH' ? '#dc2626' : r.level === 'MEDIUM' ? '#d97706' : '#059669';
                return '<tr><td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:' + c + ';color:white;font-size:9px;font-weight:700;">' + r.level + '</span></td><td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;font-size:11px;">' + r.text + '</td></tr>';
            }).join('');

            // Optimization opportunities
            let optHTML = '';
            const opts = [];
            if (mechPct > 20 && raw.coolingType !== 'liquid') opts.push('Evaluate direct liquid cooling (DLC) for high-density racks â€” potential 20-40% cooling CAPEX reduction with PUE improvement');
            if (raw.buildingType === 'purpose' && itKW < 5000) opts.push('Consider warehouse conversion instead of purpose-built â€” potential 15-25% civil cost savings for smaller facilities');
            if (raw.redundancy === '2n1' && itKW < 3000) opts.push('Evaluate 2N instead of 2(N+1) redundancy for this scale â€” significant CAPEX savings with minimal SLA impact');
            if (elecPct > 30) opts.push('Investigate modular UPS architecture to right-size initial deployment and scale with demand â€” reduces day-1 CAPEX');
            if (result.softCosts.design / total > 0.06) opts.push('Design & engineering at ' + ((result.softCosts.design / total) * 100).toFixed(1) + '% of CAPEX â€” consider value engineering workshop to identify cost reduction opportunities');
            if (timeline && timeline.totalMonths > 18) opts.push('Prefabricated/modular power and cooling skids could reduce MEP installation time by 30-50%');
            opts.push('Phase IT deployment to match customer demand â€” reduces initial rack/cabling/PDU investment by 30-50%');

            if (opts.length > 0) {
                optHTML = '<div style="margin-bottom:14px;"><div style="font-size:12px;font-weight:700;color:#1e3a5f;margin-bottom:8px;">Optimization Opportunities</div><ul style="margin:0;padding-left:18px;font-size:11px;line-height:1.7;color:#374151;">' + opts.map(o => '<li>' + o + '</li>').join('') + '</ul></div>';
            }

            // Comparison narrative
            let compNarrative = '';
            if (hasCompare && savedA) {
                const delta = ((total - savedA.total) / savedA.total * 100);
                const sign = delta >= 0 ? '+' : '';
                const perKwA = savedA.total / savedA.itLoad;
                compNarrative = '<div style="background:#f0fdf4;border:1px solid #a7f3d0;border-radius:10px;padding:14px;margin-bottom:14px;">' +
                    '<div style="font-size:12px;font-weight:700;color:#065f46;margin-bottom:6px;">Scenario Comparison Insight</div>' +
                    '<p style="font-size:11px;line-height:1.6;color:#374151;margin:0 0 6px;">' +
                    'Scenario B (' + formatCurrency(total) + ', $' + Math.round(perKW).toLocaleString() + '/kW) is <strong>' + sign + delta.toFixed(1) + '%</strong> (' + sign + formatCurrency(total - savedA.total) + ') ' + (delta >= 0 ? 'higher' : 'lower') + ' than Scenario A (' + formatCurrency(savedA.total) + ', $' + Math.round(perKwA).toLocaleString() + '/kW).</p>' +
                    '<p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">' +
                    (Math.abs(delta) > 20 ? 'The substantial cost difference reflects fundamentally different design philosophies. Carefully evaluate whether the additional investment translates to proportional improvements in reliability, efficiency, and operational performance.' :
                    Math.abs(delta) > 8 ? 'The moderate cost difference is likely driven by changes in scale, redundancy level, or cooling strategy. Review the component-level comparison to identify the primary cost drivers.' :
                    'The scenarios are closely aligned in total CAPEX, suggesting that the configuration changes have minimal cost impact. Selection should be based on operational preferences, efficiency targets, and long-term OPEX implications rather than CAPEX alone.') +
                    '</p></div>';
            }

            // Assemble narrative
            return '<div style="page-break-before:auto;margin-top:24px;">' +
                '<h2 style="font-size:16px;color:#1e3a5f;border-bottom:3px solid #1e3a5f;padding-bottom:6px;margin-bottom:14px;">Executive Assessment & Recommendations</h2>' +

                // Cost Profile Badge
                '<div style="display:flex;gap:12px;margin-bottom:14px;">' +
                    '<div style="flex:0 0 140px;background:' + costProfile.color + ';color:white;border-radius:10px;padding:16px;text-align:center;">' +
                        '<div style="font-size:10px;opacity:0.8;text-transform:uppercase;letter-spacing:1px;">CAPEX Profile</div>' +
                        '<div style="font-size:16px;font-weight:800;margin:4px 0;">' + costProfile.label + '</div>' +
                        '<div style="font-size:11px;opacity:0.9;">$' + Math.round(perKW).toLocaleString() + '/kW</div>' +
                    '</div>' +
                    '<div style="flex:1;font-size:11.5px;line-height:1.65;color:#374151;">' +
                        '<p style="margin:0 0 6px;"><strong>Investment Assessment:</strong> At <strong style="font-family:monospace;">' + formatCurrency(total) + '</strong> ($' + Math.round(perKW).toLocaleString() + '/kW) for a ' + (mw >= 1 ? mw.toFixed(1) + ' MW' : itKW.toLocaleString() + ' kW') + ' ' + tier + ' facility, this project is ' + costProfile.desc + '</p>' +
                        '<p style="margin:0;font-size:10.5px;color:#6b7280;">Top cost drivers: ' + top3.map(([k, v]) => (costFactors[k]?.label || k) + ' (' + ((v / total) * 100).toFixed(0) + '%)').join(', ') + '</p>' +
                    '</div>' +
                '</div>' +

                // Cost Structure
                '<div style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:14px;margin-bottom:14px;">' +
                    '<div style="font-size:12px;font-weight:700;color:#1e3a5f;margin-bottom:6px;">Cost Structure Analysis</div>' +
                    '<p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">' + structureNarrative + '</p>' +
                '</div>' +

                // PUE & Efficiency
                '<div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:14px;margin-bottom:14px;">' +
                    '<div style="font-size:12px;font-weight:700;color:#92400e;margin-bottom:6px;">Energy Efficiency & PUE Assessment</div>' +
                    '<p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">' + pueNarrative + '</p>' +
                '</div>' +

                // Timeline
                (timelineNarrative ? '<div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:14px;margin-bottom:14px;">' +
                    '<div style="font-size:12px;font-weight:700;color:#1e3a5f;margin-bottom:6px;">Construction Timeline Assessment</div>' +
                    '<p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">' + timelineNarrative + '</p>' +
                '</div>' : '') +

                // Comparison insight
                compNarrative +

                // Optimization opportunities
                optHTML +

                // Risk & Action Items
                '<div style="margin-bottom:14px;">' +
                    '<div style="font-size:12px;font-weight:700;color:#1e3a5f;margin-bottom:8px;">Risk Assessment & Action Items</div>' +
                    '<table style="width:100%;border-collapse:collapse;">' +
                        '<tr style="background:#1e3a5f;color:white;"><th style="padding:5px 8px;text-align:left;font-size:10px;width:80px;">Level</th><th style="padding:5px 8px;text-align:left;font-size:10px;">Item</th></tr>' +
                        riskHTML +
                    '</table>' +
                '</div>' +

                // Summary KPI bar
                '<div style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);border-radius:10px;padding:14px;color:white;display:flex;gap:2px;text-align:center;">' +
                    [
                        { label: 'Total CAPEX', value: formatCurrency(total) },
                        { label: '$/kW', value: '$' + Math.round(perKW).toLocaleString() },
                        { label: 'PUE', value: pue.toFixed(2) },
                        { label: 'Annual Energy', value: formatCurrency(result.annualEnergy) },
                        { label: 'Timeline', value: (timeline ? timeline.totalMonths + ' mo' : 'â€”') },
                        { label: 'Tier', value: tier }
                    ].map(function(k) { return '<div style="flex:1;padding:6px;background:rgba(255,255,255,0.06);border-radius:6px;margin:0 2px;"><div style="font-size:13px;font-weight:700;font-family:monospace;">' + k.value + '</div><div style="font-size:8px;opacity:0.7;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;">' + k.label + '</div></div>'; }).join('') +
                '</div>' +
            '</div>';
        }

        // â•â•â• EXPORT PDF â•â•â•
        function exportPDF() {
            const result = calculateCosts();
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
            const sortedCosts = Object.entries(result.costs).sort((a, b) => b[1] - a[1]);

            let rowsHTML = sortedCosts.map(([key, cost]) => {
                const f = costFactors[key];
                return `<tr><td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;">${f.label}</td>
                    <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;font-family:monospace;">${formatCurrency(cost)}</td>
                    <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;color:#6b7280;">${((cost/result.total)*100).toFixed(1)}%</td></tr>`;
            }).join('');

            // Add soft costs
            if (result.softCosts.design) {
                rowsHTML += `<tr><td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;">Design & Engineering</td>
                    <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;font-family:monospace;">${formatCurrency(result.softCosts.design)}</td>
                    <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;color:#6b7280;">${((result.softCosts.design/result.total)*100).toFixed(1)}%</td></tr>`;
            }
            if (result.softCosts.pm) {
                rowsHTML += `<tr><td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;">Project Management</td>
                    <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;font-family:monospace;">${formatCurrency(result.softCosts.pm)}</td>
                    <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;color:#6b7280;">${((result.softCosts.pm/result.total)*100).toFixed(1)}%</td></tr>`;
            }
            if (result.fomIncluded) {
                rowsHTML += `<tr><td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;">Front-of-Meter / Utility</td>
                    <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;font-family:monospace;">${formatCurrency(result.fomTotal)}</td>
                    <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;color:#6b7280;">${((result.fomTotal/result.total)*100).toFixed(1)}%</td></tr>`;
            }
            rowsHTML += `<tr style="background:#f9fafb;"><td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;">Contingency (${result.contingencyPct}%)</td>
                <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;font-family:monospace;">${formatCurrency(result.contingency)}</td>
                <td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;text-align:right;color:#6b7280;">${result.contingencyPct}.0%</td></tr>`;

            // Compare sections
            let compareSummaryHTML = '';
            let compareBreakdownHTML = '';
            let configMetricsHTML = '';

            if (savedScenario) {
                const a = savedScenario;
                const b = result;
                const totalDelta = ((b.total - a.total) / a.total * 100);
                const totalSign = totalDelta >= 0 ? '+' : '';
                const dClr = (v) => v > 0 ? '#ef4444' : v < 0 ? '#10b981' : '#6b7280';
                const dFmt = (aVal, bVal) => {
                    if (!aVal && !bVal) return 'â€”';
                    if (!aVal) return '<span style="color:#ef4444;">NEW</span>';
                    const d = ((bVal - aVal) / aVal * 100);
                    const s = d >= 0 ? '+' : '';
                    return `<span style="color:${dClr(d)};font-weight:600;">${s}${d.toFixed(1)}%</span>`;
                };
                const cellSt = 'padding:8px 10px;border-bottom:1px solid #e5e7eb;';
                const monoR = cellSt + 'text-align:right;font-family:monospace;';
                const deltaR = cellSt + 'text-align:right;';

                // â”€â”€ Visual summary cards (like the web) â”€â”€
                const cardSt = 'flex:1;background:#1e3a5f;color:white;border-radius:10px;padding:16px 20px;text-align:center;';
                compareSummaryHTML = `
                <div style="margin-bottom:24px;">
                    <h2 style="font-size:15px;color:#1e3a5f;border-bottom:2px solid #f59e0b;padding-bottom:6px;margin-bottom:14px;">Scenario Comparison</h2>
                    <div style="display:flex;gap:12px;align-items:stretch;">
                        <div style="${cardSt}">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.6);margin-bottom:2px;">Scenario A</div>
                            <div style="font-size:22px;font-weight:700;color:#fbbf24;font-family:monospace;">${formatCurrency(a.total)}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.7);margin-top:2px;">${formatCurrency(a.total/a.itLoad)}/kW Â· ${a.itLoad.toLocaleString()} kW</div>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:80px;">
                            <div style="font-size:10px;color:#6b7280;text-transform:uppercase;letter-spacing:1px;">Delta</div>
                            <div style="font-size:20px;font-weight:700;color:${dClr(totalDelta)};font-family:monospace;">${totalSign}${totalDelta.toFixed(1)}%</div>
                            <div style="font-size:11px;color:#6b7280;">${totalSign}${formatCurrency(b.total - a.total)}</div>
                        </div>
                        <div style="${cardSt}">
                            <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.6);margin-bottom:2px;">Scenario B</div>
                            <div style="font-size:22px;font-weight:700;color:#34d399;font-family:monospace;">${formatCurrency(b.total)}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.7);margin-top:2px;">${formatCurrency(b.total/b.itLoad)}/kW Â· ${b.itLoad.toLocaleString()} kW</div>
                        </div>
                    </div>
                </div>`;

                // â”€â”€ Configuration Comparison (A vs B side-by-side) â”€â”€
                const ac = a._config || {};
                const bc = b._config || {};
                const configParams = [
                    { label: 'IT Load', a: ac.itLoad || a.itLoad.toLocaleString()+' kW', b: bc.itLoad || b.itLoad.toLocaleString()+' kW' },
                    { label: 'Location', a: ac.location || 'â€”', b: bc.location || 'â€”' },
                    { label: 'Building Type', a: ac.buildingType || 'â€”', b: bc.buildingType || 'â€”' },
                    { label: 'Redundancy', a: ac.redundancy || 'â€”', b: bc.redundancy || 'â€”' },
                    { label: 'Tier', a: ac.tier || a.tierInfo.tier, b: bc.tier || b.tierInfo.tier },
                    { label: 'Cooling', a: ac.coolingType || 'â€”', b: bc.coolingType || 'â€”' },
                    { label: 'Rack Density', a: ac.rackDensity || 'â€”', b: bc.rackDensity || 'â€”' },
                    { label: 'UPS Type', a: ac.upsType || 'â€”', b: bc.upsType || 'â€”' },
                    { label: 'Generator', a: ac.genType || 'â€”', b: bc.genType || 'â€”' },
                    { label: 'Fire Suppression', a: ac.fireSuppression || 'â€”', b: bc.fireSuppression || 'â€”' },
                    { label: 'PUE', a: ac.pue || a.pue, b: bc.pue || b.pue },
                    { label: 'Fuel Storage', a: ac.fuelHours || 'â€”', b: bc.fuelHours || 'â€”' },
                    { label: 'Delivery Method', a: ac.deliveryMethod || 'â€”', b: bc.deliveryMethod || 'â€”' },
                    { label: 'Power Distribution', a: ac.powerDistribution || 'â€”', b: bc.powerDistribution || 'â€”' },
                    { label: 'Floor Type', a: ac.floorType || 'â€”', b: bc.floorType || 'â€”' },
                    { label: 'Site Condition', a: ac.siteCondition || 'â€”', b: bc.siteCondition || 'â€”' },
                    { label: 'Security', a: ac.securityLevel || 'â€”', b: bc.securityLevel || 'â€”' },
                    { label: 'Mode', a: ac.mode || 'Simple', b: bc.mode || 'Simple' },
                    { label: 'Year', a: ac.yearLabel || a.yearLabel, b: bc.yearLabel || b.yearLabel },
                    { label: 'City/Market', a: ac.cityLabel || a.cityLabel || 'â€”', b: bc.cityLabel || b.cityLabel || 'â€”' },
                ];
                let cfgRows = configParams.map(p => {
                    const diff = p.a !== p.b;
                    const style = diff ? 'color:#ef4444;font-weight:600;' : '';
                    return `<tr><td style="${cellSt}color:#6b7280;">${p.label}</td><td style="${cellSt}${style}">${p.a}</td><td style="${cellSt}${style}">${p.b}</td></tr>`;
                }).join('');

                configMetricsHTML = `
                <div style="display:flex;gap:16px;margin-bottom:20px;">
                    <div style="flex:1.2;min-width:0;">
                        <h2 style="font-size:13px;color:#1e3a5f;border-bottom:2px solid #f59e0b;padding-bottom:5px;margin-bottom:10px;">Configuration Comparison</h2>
                        <table style="width:100%;border-collapse:collapse;font-size:11px;">
                            <tr style="background:#1e3a5f;color:white;"><th style="padding:6px 8px;text-align:left;">Parameter</th><th style="padding:6px 8px;text-align:left;">Scenario A</th><th style="padding:6px 8px;text-align:left;">Scenario B</th></tr>
                            ${cfgRows}
                        </table>
                    </div>
                    <div style="flex:0.8;min-width:0;">
                        <h2 style="font-size:13px;color:#1e3a5f;border-bottom:2px solid #f59e0b;padding-bottom:5px;margin-bottom:10px;">Key Metrics</h2>
                        <table style="width:100%;font-size:11.5px;">
                            <tr><td style="padding:5px 0;color:#6b7280;"></td><td style="padding:5px 0;font-weight:600;color:#6b7280;font-size:10px;">Scenario A</td><td style="padding:5px 0;font-weight:600;color:#6b7280;font-size:10px;">Scenario B</td></tr>
                            <tr><td style="padding:5px 0;color:#6b7280;">Total CAPEX</td><td style="padding:5px 0;font-weight:700;color:#fbbf24;font-family:monospace;">${formatCurrency(a.total)}</td><td style="padding:5px 0;font-weight:700;color:#34d399;font-family:monospace;">${formatCurrency(b.total)}</td></tr>
                            <tr><td style="padding:5px 0;color:#6b7280;">$/kW</td><td style="padding:5px 0;font-weight:600;font-family:monospace;">${formatCurrency(a.total/a.itLoad)}</td><td style="padding:5px 0;font-weight:600;font-family:monospace;">${formatCurrency(b.total/b.itLoad)}</td></tr>
                            <tr><td style="padding:5px 0;color:#6b7280;">Annual Energy</td><td style="padding:5px 0;font-weight:600;font-family:monospace;">${formatCurrency(a.annualEnergy)}/yr</td><td style="padding:5px 0;font-weight:600;font-family:monospace;">${formatCurrency(b.annualEnergy)}/yr</td></tr>
                            <tr><td style="padding:5px 0;color:#6b7280;">Uptime SLA</td><td style="padding:5px 0;font-weight:600;">${a.tierInfo.uptime}</td><td style="padding:5px 0;font-weight:600;">${b.tierInfo.uptime}</td></tr>
                        </table>
                    </div>
                </div>`;

                // â”€â”€ Detailed breakdown table â”€â”€
                let cmpRows = '';
                cmpRows += `<tr style="background:#f0f7ff;"><td style="${cellSt}font-weight:700;" colspan="4">Component Breakdown</td></tr>`;
                costKeyOrder.forEach(key => {
                    const aVal = a.costs[key] || 0;
                    const bVal = b.costs[key] || 0;
                    if (aVal === 0 && bVal === 0) return;
                    const f = costFactors[key];
                    cmpRows += `<tr><td style="${cellSt}">${f.label}</td><td style="${monoR}">${formatCurrency(aVal)}</td><td style="${monoR}">${formatCurrency(bVal)}</td><td style="${deltaR}">${dFmt(aVal, bVal)}</td></tr>`;
                });

                cmpRows += `<tr style="background:#f0f7ff;"><td style="${cellSt}font-weight:700;" colspan="4">Additional Costs</td></tr>`;
                if (a.softCosts.design || b.softCosts.design) {
                    cmpRows += `<tr><td style="${cellSt}">Design & Engineering</td><td style="${monoR}">${formatCurrency(a.softCosts.design||0)}</td><td style="${monoR}">${formatCurrency(b.softCosts.design||0)}</td><td style="${deltaR}">${dFmt(a.softCosts.design, b.softCosts.design)}</td></tr>`;
                }
                if (a.softCosts.pm || b.softCosts.pm) {
                    cmpRows += `<tr><td style="${cellSt}">Project Management</td><td style="${monoR}">${formatCurrency(a.softCosts.pm||0)}</td><td style="${monoR}">${formatCurrency(b.softCosts.pm||0)}</td><td style="${deltaR}">${dFmt(a.softCosts.pm, b.softCosts.pm)}</td></tr>`;
                }
                if (a.fomIncluded || b.fomIncluded) {
                    cmpRows += `<tr><td style="${cellSt}">Front-of-Meter / Utility</td><td style="${monoR}">${a.fomIncluded ? formatCurrency(a.fomTotal) : 'â€”'}</td><td style="${monoR}">${b.fomIncluded ? formatCurrency(b.fomTotal) : 'â€”'}</td><td style="${deltaR}">${(a.fomIncluded && b.fomIncluded) ? dFmt(a.fomTotal, b.fomTotal) : 'â€”'}</td></tr>`;
                }
                cmpRows += `<tr><td style="${cellSt}">Contingency</td><td style="${monoR}">${formatCurrency(a.contingency)} (${a.contingencyPct}%)</td><td style="${monoR}">${formatCurrency(b.contingency)} (${b.contingencyPct}%)</td><td style="${deltaR}">${dFmt(a.contingency, b.contingency)}</td></tr>`;

                cmpRows += `<tr style="background:#1e3a5f;color:white;font-weight:700;"><td style="padding:10px;">TOTAL</td><td style="padding:10px;text-align:right;font-family:monospace;">${formatCurrency(a.total)}</td><td style="padding:10px;text-align:right;font-family:monospace;">${formatCurrency(b.total)}</td><td style="padding:10px;text-align:right;">${totalSign}${totalDelta.toFixed(1)}%<br><span style="font-size:11px;font-weight:400;">${totalSign}${formatCurrency(b.total - a.total)}</span></td></tr>`;

                compareBreakdownHTML = `
                <div style="margin-top:24px;">
                    <h2 style="font-size:15px;color:#1e3a5f;border-bottom:2px solid #f59e0b;padding-bottom:6px;margin-bottom:14px;">Detailed Comparison</h2>
                    <table style="width:100%;border-collapse:collapse;font-size:11.5px;">
                        <tr style="background:#1e3a5f;color:white;"><th style="padding:8px 10px;text-align:left;">Component</th><th style="padding:8px 10px;text-align:right;min-width:90px;">Scenario A</th><th style="padding:8px 10px;text-align:right;min-width:90px;">Scenario B</th><th style="padding:8px 10px;text-align:right;min-width:60px;">Delta</th></tr>
                        ${cmpRows}
                    </table>
                </div>`;
            } else {
                // Single scenario â€” original 3-column layout
                const cfg = result._config || {};
                const cR = 'padding:5px 0;color:#6b7280;font-size:11px;';
                const cV = 'padding:5px 0;font-weight:600;font-size:11px;';
                let singleConfigHTML = `<tr><td style="${cR}">IT Load</td><td style="${cV}">${cfg.itLoad || result.itLoad.toLocaleString()+' kW'}</td></tr>
                    <tr><td style="${cR}">Location</td><td style="${cV}">${cfg.location || 'â€”'}${cfg.cityLabel !== 'â€”' ? ' â€” ' + cfg.cityLabel : ''}</td></tr>
                    <tr><td style="${cR}">Building Type</td><td style="${cV}">${cfg.buildingType || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Redundancy / Tier</td><td style="${cV}">${cfg.redundancy || 'â€”'} (${result.tierInfo.tier})</td></tr>
                    <tr><td style="${cR}">Cooling</td><td style="${cV}">${cfg.coolingType || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Rack Density</td><td style="${cV}">${cfg.rackDensity || 'â€”'}</td></tr>
                    <tr><td style="${cR}">UPS / Generator</td><td style="${cV}">${cfg.upsType || 'â€”'} / ${cfg.genType || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Fire Suppression</td><td style="${cV}">${cfg.fireSuppression || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Floor / Site</td><td style="${cV}">${cfg.floorType || 'â€”'} / ${cfg.siteCondition || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Power Distribution</td><td style="${cV}">${cfg.powerDistribution || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Cabling / PDU</td><td style="${cV}">${cfg.cablingType || 'â€”'} / ${cfg.pduType || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Delivery Method</td><td style="${cV}">${cfg.deliveryMethod || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Market Condition</td><td style="${cV}">${cfg.marketCondition || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Security / Fiber</td><td style="${cV}">${cfg.securityLevel || 'â€”'} / ${cfg.fiberEntry || 'â€”'}</td></tr>
                    <tr><td style="${cR}">Projection Year</td><td style="${cV}">${result.yearLabel}</td></tr>
                    <tr><td style="${cR}">PUE</td><td style="${cV}">${result.pue}</td></tr>`;

                configMetricsHTML = `
                <div style="display:flex;gap:16px;margin-bottom:20px;">
                    <div style="flex:1;min-width:0;">
                        <h2 style="font-size:13px;color:#1e3a5f;border-bottom:2px solid #f59e0b;padding-bottom:5px;margin-bottom:10px;">Configuration</h2>
                        <table style="width:100%;font-size:11.5px;">${singleConfigHTML}</table>
                    </div>
                    <div style="flex:1;min-width:0;">
                        <h2 style="font-size:13px;color:#1e3a5f;border-bottom:2px solid #f59e0b;padding-bottom:5px;margin-bottom:10px;">Key Metrics</h2>
                        <table style="width:100%;font-size:11.5px;">
                            <tr><td style="padding:5px 0;color:#6b7280;">Total CAPEX</td><td style="padding:5px 0;font-weight:700;color:#f59e0b;font-family:monospace;">${formatCurrency(result.total)}</td></tr>
                            <tr><td style="padding:5px 0;color:#6b7280;">Annual Energy</td><td style="padding:5px 0;font-weight:600;font-family:monospace;">${formatCurrency(result.annualEnergy)}/yr</td></tr>
                            <tr><td style="padding:5px 0;color:#6b7280;">Uptime SLA</td><td style="padding:5px 0;font-weight:600;">${result.tierInfo.uptime}</td></tr>
                        </table>
                    </div>
                    <div style="flex:1.2;min-width:0;">
                        <h2 style="font-size:13px;color:#1e3a5f;border-bottom:2px solid #f59e0b;padding-bottom:5px;margin-bottom:10px;">Cost Breakdown</h2>
                        <table style="width:100%;border-collapse:collapse;font-size:11px;">
                            <tr style="background:#1e3a5f;color:white;"><th style="padding:6px 8px;text-align:left;">Component</th><th style="padding:6px 8px;text-align:right;">Cost</th><th style="padding:6px 8px;text-align:right;">%</th></tr>
                            ${rowsHTML}
                            <tr style="background:#1e3a5f;color:white;font-weight:700;"><td style="padding:6px 8px;">TOTAL</td><td style="padding:6px 8px;text-align:right;font-family:monospace;">${formatCurrency(result.total)}</td><td style="padding:6px 8px;text-align:right;">100%</td></tr>
                        </table>
                    </div>
                </div>`;
            }

            const printHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>CAPEX Report â€” ${dateStr}</title>
            <style>@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}@page{margin:15mm;}}</style></head>
            <body style="font-family:Arial,Helvetica,sans-serif;max-width:820px;margin:0 auto;padding:36px;color:#1f2937;">
                <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #1e3a5f;padding-bottom:14px;margin-bottom:20px;">
                    <div>
                        <h1 style="font-size:20px;color:#1e3a5f;margin:0;">Data Center CAPEX Report${savedScenario ? ' â€” Scenario Comparison' : ''}</h1>
                        <p style="font-size:11px;color:#6b7280;margin:4px 0 0;">Generated ${dateStr} Â· resistancezero.com</p>
                    </div>
                    ${savedScenario ? `
                    <div style="display:flex;gap:12px;text-align:right;">
                        <div style="padding:6px 12px;background:#fef3c7;border-radius:8px;"><div style="font-size:9px;color:#92400e;text-transform:uppercase;font-weight:700;">Scenario A</div><div style="font-size:18px;font-weight:700;color:#d97706;font-family:monospace;">${formatCurrency(savedScenario.total)}</div><div style="font-size:10px;color:#6b7280;">${formatCurrency(savedScenario.total/savedScenario.itLoad)}/kW</div></div>
                        <div style="padding:6px 12px;background:#d1fae5;border-radius:8px;"><div style="font-size:9px;color:#065f46;text-transform:uppercase;font-weight:700;">Scenario B</div><div style="font-size:18px;font-weight:700;color:#059669;font-family:monospace;">${formatCurrency(result.total)}</div><div style="font-size:10px;color:#6b7280;">${formatCurrency(result.total/result.itLoad)}/kW</div></div>
                    </div>` : `
                    <div style="text-align:right;">
                        <div style="font-size:26px;font-weight:700;color:#f59e0b;font-family:monospace;">${formatCurrency(result.total)}</div>
                        <div style="font-size:12px;color:#6b7280;">${formatCurrency(result.total/result.itLoad)}/kW Â· ${result.itLoad.toLocaleString()} kW IT Load</div>
                    </div>`}
                </div>
                ${compareSummaryHTML}
                ${configMetricsHTML}
                ${compareBreakdownHTML}
                ${isPremiumUser ? buildPremiumPdfSection(result) : ''}
                ${generateCapexNarrative(result, !!savedScenario, savedScenario)}
                <div style="margin-top:36px;padding-top:14px;border-top:1px solid #e5e7eb;font-size:10px;color:#9ca3af;text-align:center;">
                    <p>This report is a general-purpose estimate. Actual costs depend on site-specific engineering, local regulations, and procurement strategy.</p>
                    <p style="margin-top:4px;">Generated by Data Center CAPEX Calculator Â· resistancezero.com Â· &copy; ${now.getFullYear()} Bagus Dwi Permana${isPremiumUser ? ' Â· PRO Report' : ''}</p>
                </div>
</body></html>`;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHTML);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 500);
        }

        // Global Tooltip System
        function initTooltipSystem() {
            const tooltipEl = document.createElement('div');
            tooltipEl.id = 'tooltip-container';
            document.body.appendChild(tooltipEl);

            document.querySelectorAll('.tooltip-trigger').forEach(trigger => {
                const content = trigger.querySelector('.tooltip-content');
                if (!content) return;

                trigger.addEventListener('mouseenter', () => {
                    tooltipEl.innerHTML = content.innerHTML;

                    const rect = trigger.getBoundingClientRect();
                    const tooltipWidth = 320;
                    const tooltipHeight = tooltipEl.offsetHeight || 200;
                    const padding = 15;

                    let left = rect.right + padding;
                    let top = rect.top + rect.height / 2;

                    if (left + tooltipWidth > window.innerWidth - 20) {
                        left = rect.left - tooltipWidth - padding;
                    }
                    if (left < 20) left = 20;

                    top = top - tooltipHeight / 2;
                    if (top < 20) top = 20;
                    if (top + tooltipHeight > window.innerHeight - 20) {
                        top = window.innerHeight - tooltipHeight - 20;
                    }

                    tooltipEl.style.left = left + 'px';
                    tooltipEl.style.top = top + 'px';
                    tooltipEl.classList.add('visible');
                });

                trigger.addEventListener('mouseleave', () => {
                    tooltipEl.classList.remove('visible');
                });
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PREMIUM OUTPUT RENDERING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderPremiumOutput() {
            if (!isPremiumUser || !lastResult || userTier !== 'pro') {
                document.getElementById('premiumOutput').style.display = 'none';
                return;
            }
            document.getElementById('premiumOutput').style.display = 'flex';

            const r = lastResult;
            const itLoad = r.itLoad;
            const redundancy = document.querySelector('input[name="redundancy"]:checked').value;
            const rackType = document.querySelector('input[name="rackType"]:checked').value;
            const coolingType = document.querySelector('input[name="coolingType"]:checked').value;
            const upsType = document.getElementById('upsType').value;
            const genType = document.getElementById('genType').value;
            const fireType = document.getElementById('fireType').value;

            // 1. KPI Cards
            const racks = Math.ceil(itLoad / rackKw[rackType]);
            const floorM2 = Math.ceil(racks * rackFootprint);
            const buildingType = document.getElementById('buildingType').value;
            const location = document.getElementById('locationFactor').value;
            const cityVal = document.getElementById('cityMarket') ? document.getElementById('cityMarket').value : 'none';
            const effRegion = (cityVal !== 'none' && cityData[cityVal]) ? cityData[cityVal].region : location;
            const phases = r._timeline || computeTimeline(redundancy, buildingType, coolingType, effRegion, itLoad);
            const totalMonths = phases.totalMonths;

            document.getElementById('premRackCount').textContent = racks.toLocaleString();
            document.getElementById('premFloorSpace').textContent = floorM2.toLocaleString() + ' mÂ²';
            document.getElementById('premTimeline').textContent = totalMonths + ' mo';

            // 2. $/kW Benchmark
            const perKw = r.total / itLoad;
            const pct = Math.min(Math.max((perKw - 5000) / 25000, 0), 1) * 100;
            document.getElementById('benchmarkMarker').style.left = pct + '%';
            document.getElementById('benchmarkLabel').style.left = pct + '%';
            document.getElementById('benchmarkLabel').textContent = '$' + Math.round(perKw).toLocaleString() + '/kW';

            // 3. Construction Timeline (Gantt-style bars with parallel model)
            const tlEl = document.getElementById('timelineChart');
            const regionLabel = (permitRegionMult[effRegion] || permitRegionMult.usa).label.split(',')[0];
            const buildLabel = { warehouse: 'Warehouse', modular: 'Modular/Prefab', purpose: 'Purpose-Built', highrise: 'High-Rise' }[buildingType] || '';
            const icons = ['fa-drafting-compass', 'fa-file-alt', 'fa-truck', 'fa-hard-hat', 'fa-wrench', 'fa-clipboard-check'];
            const notes = [
                itLoad > 10000 ? 'Scaled for ' + (itLoad/1000).toFixed(0) + ' MW' : '',
                regionLabel,
                'Long-lead equipment',
                buildLabel,
                coolingType === 'liquid' ? 'DLC pipework +30%' : coolingType === 'rdhx' ? 'RDHX plumbing +15%' : '',
                redundancy === '2n1' ? 'Full IST/ISST' : redundancy === '2n' ? 'IST required' : ''
            ];
            let tlHTML = '';
            phases.phases.forEach((p, i) => {
                const leftPct = (p.start / totalMonths * 100).toFixed(1);
                const widthPct = ((p.end - p.start) / totalMonths * 100).toFixed(1);
                const dur = p.end - p.start;
                tlHTML += `<div style="display:grid;grid-template-columns:140px 1fr 50px;gap:8px;align-items:center;font-size:0.7rem;">
                    <div style="color:#e2e8f0;display:flex;align-items:center;gap:6px;font-weight:500;"><i class="fas ${icons[i]}" style="color:${p.color};width:14px;text-align:center;"></i>${p.name.length > 18 ? p.name.substring(0,16) + '..' : p.name}</div>
                    <div style="position:relative;height:20px;background:rgba(255,255,255,0.06);border-radius:4px;">
                        <div style="position:absolute;left:${leftPct}%;width:${widthPct}%;height:100%;background:linear-gradient(90deg,${p.color},${p.color}cc);border-radius:4px;display:flex;align-items:center;padding-left:6px;overflow:hidden;">
                            ${notes[i] ? `<span style="font-size:0.5rem;color:rgba(255,255,255,0.8);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;">${notes[i]}</span>` : ''}
                        </div>
                    </div>
                    <div style="color:${p.color};font-weight:700;text-align:right;">${dur} mo</div>
                </div>`;
            });
            // Total row
            const serialTotal = phases.design + phases.permit + phases.procurement + phases.civil + phases.mep + phases.commission;
            const savedPct = Math.round((serialTotal - totalMonths) / serialTotal * 100);
            tlHTML += `<div style="display:grid;grid-template-columns:140px 1fr 50px;gap:8px;align-items:center;font-size:0.7rem;margin-top:4px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.1);">
                <div style="color:#fbbf24;font-weight:700;">Total (Designâ†’COD)</div>
                <div style="height:3px;background:linear-gradient(90deg,#8b5cf6,#f59e0b,#ec4899,#3b82f6,#10b981,#06b6d4);border-radius:2px;"></div>
                <div style="color:#fbbf24;font-weight:800;text-align:right;">${totalMonths} mo</div>
            </div>`;
            if (savedPct > 0) {
                tlHTML += `<div style="font-size:0.55rem;color:#94a3b8;text-align:right;margin-top:2px;">Parallel model saves ~${savedPct}% vs serial execution</div>`;
            }
            tlEl.innerHTML = tlHTML;

            // 5. Sustainability Metrics (region-specific)
            const smEl = document.getElementById('sustainMetrics');
            const annualMWh = itLoad * r.pue * 8760 / 1000;
            const emFactor = gridEmissionFactor[effRegion] || 0.4;
            const co2Tons = annualMWh * emFactor;
            const wue = wueByCooling[coolingType] || 0;
            const waterM3 = wue * itLoad * r.pue * 8760 / 1000;
            const dcie = (1 / r.pue * 100).toFixed(1);
            const refrig = refrigerantData[coolingType] || refrigerantData.air;
            smEl.innerHTML = `
                <div style="padding:10px 12px;border-radius:10px;background:linear-gradient(135deg,#047857,#10b981);box-shadow:0 2px 6px rgba(16,185,129,0.2);">
                    <div style="font-size:0.6rem;color:rgba(255,255,255,0.7);font-weight:600;">PUE / DCiE</div>
                    <div style="font-size:1.2rem;font-weight:800;color:#ffffff;">${r.pue.toFixed(2)}</div>
                    <div style="font-size:0.55rem;color:rgba(255,255,255,0.6);">DCiE ${dcie}% Â· ${r.pue <= 1.3 ? 'Excellent' : r.pue <= 1.5 ? 'Good' : r.pue <= 1.7 ? 'Average' : 'Below Average'}</div>
                </div>
                <div style="padding:10px 12px;border-radius:10px;background:linear-gradient(135deg,#1d4ed8,#3b82f6);box-shadow:0 2px 6px rgba(59,130,246,0.2);">
                    <div style="font-size:0.6rem;color:rgba(255,255,255,0.7);font-weight:600;">Annual Energy</div>
                    <div style="font-size:1.2rem;font-weight:800;color:#ffffff;">${(annualMWh / 1000).toFixed(1)} GWh</div>
                    <div style="font-size:0.55rem;color:rgba(255,255,255,0.6);">${annualMWh.toLocaleString(undefined,{maximumFractionDigits:0})} MWh/yr</div>
                </div>
                <div style="padding:10px 12px;border-radius:10px;background:linear-gradient(135deg,#b45309,#f59e0b);box-shadow:0 2px 6px rgba(245,158,11,0.2);">
                    <div style="font-size:0.6rem;color:rgba(255,255,255,0.7);font-weight:600;">Scope 2 COâ‚‚</div>
                    <div style="font-size:1.2rem;font-weight:800;color:#ffffff;">${co2Tons >= 1000 ? (co2Tons / 1000).toFixed(1) + 'K' : Math.round(co2Tons)} t</div>
                    <div style="font-size:0.55rem;color:rgba(255,255,255,0.6);">${emFactor.toFixed(2)} tCOâ‚‚/MWh (${(effRegion||'avg').toUpperCase()})</div>
                </div>
                <div style="padding:10px 12px;border-radius:10px;background:linear-gradient(135deg,#0e7490,#06b6d4);box-shadow:0 2px 6px rgba(6,182,212,0.2);">
                    <div style="font-size:0.6rem;color:rgba(255,255,255,0.7);font-weight:600;">Water / Refrigerant</div>
                    <div style="font-size:1.2rem;font-weight:800;color:#ffffff;">WUE ${wue.toFixed(1)}</div>
                    <div style="font-size:0.55rem;color:rgba(255,255,255,0.6);">${refrig.type}${refrig.gwp > 0 ? ' GWP ' + refrig.gwp : ''}</div>
                </div>`;

            // Report date
            document.getElementById('premReportDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FEATURE GATING SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function applyFeatureGating() {
            const isFree = !isPremiumUser;               // true for free tier
            const isFullPremium = (userTier === 'pro');   // pro tier

            // 1. $/kW section â€” blur for free only (demo + pro see values)
            const perKwSection = document.getElementById('perKwSection');
            const perKwValue = document.getElementById('perKwCost');
            const perKwBadge = document.getElementById('perKwGateBadge');
            if (perKwSection) {
                if (isFree) {
                    perKwSection.classList.add('gated-overlay');
                    perKwValue.classList.add('cost-value-hidden');
                } else {
                    perKwSection.classList.remove('gated-overlay');
                    perKwValue.classList.remove('cost-value-hidden');
                }
            }
            if (perKwBadge) perKwBadge.style.display = isFree ? 'inline-flex' : 'none';

            // 2. Annual Energy â€” blur for free only
            const energySection = document.getElementById('energySection');
            const energyValue = document.getElementById('energyCost');
            const energyBadge = document.getElementById('energyGateBadge');
            if (energySection) {
                if (isFree) {
                    energySection.classList.add('gated-overlay');
                    energyValue.classList.add('cost-value-hidden');
                } else {
                    energySection.classList.remove('gated-overlay');
                    energyValue.classList.remove('cost-value-hidden');
                }
            }
            if (energyBadge) energyBadge.style.display = isFree ? 'inline-flex' : 'none';

            // 3. Cost breakdown â€” hide dollar values for free only
            const costItems = document.querySelectorAll('#costBreakdown .cost-item');
            costItems.forEach((item, index) => {
                const valueEl = item.querySelector('.cost-value');
                const barEl = item.querySelector('.cost-bar');
                if (isFree) {
                    if (valueEl) valueEl.classList.add('cost-value-hidden');
                    if (barEl && index > 2) barEl.style.opacity = '0.15';
                } else {
                    if (valueEl) valueEl.classList.remove('cost-value-hidden');
                    if (barEl) barEl.style.opacity = '1';
                }
            });

            // 4. Action buttons â€” lock for free (pro only)
            const btnSave = document.getElementById('btnSaveA');
            const btnPdf = document.getElementById('btnExportPDF');
            const btnSaveLabel = document.getElementById('btnSaveLabel');
            const btnPdfLabel = document.getElementById('btnPdfLabel');
            const lockActions = !isFullPremium; // free locked
            if (lockActions) {
                if (btnSave) { btnSave.classList.add('gated-btn','clickable'); btnSave.style.opacity = '0.6'; }
                if (btnPdf) { btnPdf.classList.add('gated-btn','clickable'); btnPdf.style.opacity = '0.6'; }
                if (btnSaveLabel) btnSaveLabel.innerHTML = '<i class="fas fa-lock" style="font-size:0.65rem;margin-right:3px;color:#a78bfa;"></i>Save Scenario A';
                if (btnPdfLabel) btnPdfLabel.innerHTML = '<i class="fas fa-lock" style="font-size:0.65rem;margin-right:3px;color:#a78bfa;"></i>Export PDF';
            } else {
                if (btnSave) { btnSave.classList.remove('gated-btn','clickable'); btnSave.style.opacity = '1'; }
                if (btnPdf) { btnPdf.classList.remove('gated-btn','clickable'); btnPdf.style.opacity = '1'; }
                if (btnSaveLabel) btnSaveLabel.textContent = 'Save Scenario A';
                if (btnPdfLabel) btnPdfLabel.textContent = 'Export PDF';
            }

            // 5. Watermark â€” show for free only
            const watermark = document.getElementById('freeWatermark');
            if (watermark) watermark.style.display = isFree ? 'block' : 'none';

            // 6. Advanced tab â€” add lock icon for free only
            const advBtn = document.querySelector('.capex-mode-btn[data-mode="advanced"]');
            if (advBtn) {
                if (isFree) {
                    if (!advBtn.querySelector('.gate-lock-icon')) {
                        advBtn.insertAdjacentHTML('beforeend', '<i class="fas fa-lock gate-lock-icon" style="margin-left:6px;font-size:0.65rem;color:#a78bfa;"></i>');
                    }
                } else {
                    const lockIcon = advBtn.querySelector('.gate-lock-icon');
                    if (lockIcon) lockIcon.remove();
                }
            }

            // 7. Comparison section â€” blur for free (pro only)
            const compareGrid = document.getElementById('compareGrid');
            if (compareGrid) {
                if (!isFullPremium) {
                    compareGrid.style.filter = 'blur(4px)';
                    compareGrid.style.pointerEvents = 'none';
                    compareGrid.style.opacity = '0.5';
                } else {
                    compareGrid.style.filter = 'none';
                    compareGrid.style.pointerEvents = 'auto';
                    compareGrid.style.opacity = '1';
                }
            }
        }

        // Gated action handler â€” intercepts non-pro users
        function gatedAction(action) {
            if (userTier !== 'pro') {
                handlePremiumTab(); // show login modal for free users
                return;
            }
            if (action === 'save') saveScenarioA();
            if (action === 'pdf') exportPDF();
        }

        // PREMIUM ACCESS SYSTEM (Temporary)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Check if already logged in (session persistence)
        (function checkPremiumSession() {
            const session = localStorage.getItem('rz_premium_session');
            if (session) {
                try {
                    const data = JSON.parse(session);
                    // Handle both ISO string and timestamp formats
                    const expiresMs = typeof data.expires === 'string' ? new Date(data.expires).getTime() : data.expires;
                    if (expiresMs > Date.now()) {
                        isPremiumUser = true;
                        userTier = data.tier || 'pro';
                        activatePremiumUI();
                    } else {
                        localStorage.removeItem('rz_premium_session');
                    }
                } catch(e) {
                    localStorage.removeItem('rz_premium_session');
                }
            }
        })();

        function handlePremiumTab() {
            if (isPremiumUser) {
                // Already premium â€” toggle to show advanced mode
                switchCapexMode('advanced');
                return;
            }
            // Show login modal
            const modal = document.getElementById('loginModal');
            modal.style.display = 'flex';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            setTimeout(() => document.getElementById('loginEmail').focus(), 100);
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        // Close modal on backdrop click
        document.getElementById('loginModal').addEventListener('click', function(e) {
            if (e.target === this) closeLoginModal();
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeLoginModal();
        });

        function attemptLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                errorEl.style.display = 'block';
                return;
            }

            // Temporary hardcoded auth (will be replaced with Supabase)
            const validUsers = [
                { email: 'demo@resistancezero.com', password: 'demo2026', tier: 'pro' }
            ];

            const match = validUsers.find(u => u.email === email && u.password === password);

            if (match) {
                // Login success â€” store session (30 days)
                var expDate = new Date(); expDate.setDate(expDate.getDate() + 30);
                localStorage.setItem('rz_premium_session', JSON.stringify({
                    email: match.email,
                    tier: match.tier,
                    expires: expDate.toISOString()
                }));
                isPremiumUser = true;
                userTier = match.tier;
                closeLoginModal();
                activatePremiumUI();
                switchCapexMode('advanced');
            } else {
                errorEl.textContent = 'Invalid email or password';
                errorEl.style.display = 'block';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        }

        function activatePremiumUI() {
            const premBtn = document.getElementById('premiumTabBtn');
            premBtn.classList.add('premium-active');
            premBtn.innerHTML = '<i class="fas fa-crown" style="margin-right:6px;"></i>Premium Active';
            premBtn.onclick = function() { logoutPremium(); };

            // Show tier badge
            const premBadge = document.getElementById('premiumBadge');
            premBadge.textContent = 'PRO ACTIVE';
            premBadge.style.display = 'inline-flex';
            premBadge.style.background = 'linear-gradient(135deg,#8b5cf6,#a855f7)';
            premBadge.style.color = 'white';

            // Enable advanced mode and apply gating
            switchCapexMode('advanced');
            applyFeatureGating();
            renderPremiumOutput();

            // Update navbar auth UI
            updateNavbarAuthUI();
        }

        function logoutPremium() {
            if (!confirm('Logout from your account?')) return;
            isPremiumUser = false;
            userTier = 'free';
            localStorage.removeItem('rz_premium_session');

            const premBtn = document.getElementById('premiumTabBtn');
            premBtn.classList.remove('premium-active');
            premBtn.innerHTML = '<i class="fas fa-crown" style="margin-right:6px;"></i>Premium';
            premBtn.onclick = function() { handlePremiumTab(); };

            // Hide badge
            document.getElementById('premiumBadge').style.display = 'none';

            switchCapexMode('simple');
            applyFeatureGating();
            renderPremiumOutput(); // hides premium output

            // Update navbar auth UI
            updateNavbarAuthUI();

            // Close dropdown if open
            const dd = document.getElementById('navUserDropdown');
            if (dd) dd.classList.remove('show');
        }

        // Toggle user dropdown in navbar
        function toggleUserDropdown() {
            const btn = document.getElementById('navUserBtn');
            const dd = document.getElementById('navUserDropdown');
            btn.classList.toggle('open');
            dd.classList.toggle('show');
        }

        // Close dropdown on outside click
        document.addEventListener('click', function(e) {
            const wrap = document.getElementById('navAuthWrap');
            if (wrap && !wrap.contains(e.target)) {
                const dd = document.getElementById('navUserDropdown');
                const btn = document.getElementById('navUserBtn');
                if (dd) dd.classList.remove('show');
                if (btn) btn.classList.remove('open');
            }
        });

        // Update navbar auth state (login btn vs user avatar)
        function updateNavbarAuthUI() {
            const loginBtn = document.getElementById('navLoginBtn');
            const userBtn = document.getElementById('navUserBtn');
            const ddEmail = document.getElementById('navDdEmail');
            const ddBadge = document.getElementById('navDdTierBadge');
            const avatar = document.getElementById('navUserAvatar');
            const emailSpan = document.getElementById('navUserEmail');

            if (isPremiumUser) {
                const session = JSON.parse(localStorage.getItem('rz_premium_session') || '{}');
                const email = session.email || '';
                const initial = email.charAt(0).toUpperCase();
                loginBtn.style.display = 'none';
                userBtn.style.display = 'flex';
                avatar.textContent = initial;
                emailSpan.textContent = email;
                ddEmail.textContent = email;
                ddBadge.textContent = 'PRO';
                ddBadge.className = 'nav-dd-tier-badge pro';
            } else {
                loginBtn.style.display = 'flex';
                userBtn.style.display = 'none';
            }
        }

        // Apply gating on initial page load (after DOM + calculateCosts)
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                applyFeatureGating();
                updateNavbarAuthUI();
            }, 100);
        });
    </script>
<script src="rz-tracker.js"></script>
</body>
</html>
