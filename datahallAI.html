<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- SEO Meta Tags -->
<title>AI Data Hall Dashboard | GB200 NVL72 Live Operations | Bagus Dwi Permana</title>
<meta name="description" content="AI-ready data hall monitoring dashboard. Real-time rack density, liquid cooling metrics, GPU utilization, and power distribution analytics.">
<meta name="keywords" content="AI Data Center, GB200 NVL72, Blackwell GPU, Direct Liquid Cooling, DLC, Data Center Telemetry, BMS Dashboard, DCIM, HPC Infrastructure, NVLink, InfiniBand">
<meta name="author" content="Bagus Dwi Permana">
<meta name="robots" content="index, follow, max-image-preview:large">
<link rel="canonical" href="https://resistancezero.com/datahallAI.html">

    <link rel="alternate" hreflang="en" href="https://resistancezero.com/datahallAI.html">

    <!-- Resource Hints -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
<!-- Open Graph Meta Tags -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://resistancezero.com/datahallAI.html">
<meta property="og:site_name" content="Bagus Dwi Permana Portfolio">
<meta property="og:title" content="AI Data Hall Dashboard | GB200 NVL72 Live Operations">
<meta property="og:description" content="Interactive telemetry for next-gen AI infrastructure with Blackwell GPUs, direct liquid cooling, and comprehensive BMS/DCIM monitoring.">
<meta property="og:image" content="https://resistancezero.com/assets/DashboardDC_80.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="AI Data Hall GB200 NVL72 Dashboard Preview">
<meta property="og:locale" content="en_US">

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="AI Data Hall Dashboard | GB200 NVL72">
<meta name="twitter:description" content="Live telemetry for AI/HPC infrastructure - Blackwell GPUs, DLC cooling, power distribution, and BMS monitoring.">
<meta name="twitter:image" content="https://resistancezero.com/assets/DashboardDC_80.jpg">
<meta name="twitter:image:alt" content="AI Data Hall Dashboard">

<!-- Favicon -->
<link rel="icon" type="image/png" href="assets/Favicon.png"><link rel="apple-touch-icon" href="assets/Favicon.png">

<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');
:root{--bg:#050810;--bg1:#0a0e17;--bg2:#0f1420;--bg3:#161c2b;--g:#22c55e;--b:#3b82f6;--c:#06b6d4;--o:#f59e0b;--r:#ef4444;--p:#8b5cf6;--pk:#ec4899;--t1:#e2e5ea;--t2:#8b919c;--t3:#5a6070;--bd:#1a2030;--bd2:#2a3148}
*{margin:0;padding:0;box-sizing:border-box}html,body{background:var(--bg);color:var(--t1);font-family:'Space Grotesk',sans-serif;height:100%;overflow:hidden}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:2px}a{color:var(--c);text-decoration:none}
.hdr{background:linear-gradient(180deg,rgba(10,14,23,.98),rgba(5,8,16,.95));border-bottom:1px solid var(--bd);padding:8px 12px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:60;backdrop-filter:blur(10px);height:44px}
.hdr h1{font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
.chip{color:var(--g);font-family:'JetBrains Mono';font-size:9px;padding:3px 8px;background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.18);border-radius:4px;animation:gp 2.5s ease infinite}
@keyframes gp{0%,100%{box-shadow:0 0 3px rgba(34,197,94,.15)}50%{box-shadow:0 0 10px rgba(34,197,94,.3)}}
.hdr-r{display:flex;gap:5px;align-items:center;font-family:'JetBrains Mono';font-size:8px;color:var(--t2)}
.dot{width:4px;height:4px;border-radius:50%;background:var(--g);animation:bk 2s ease infinite}
@keyframes bk{0%,100%{opacity:.3}50%{opacity:1}}
.bbtn{font-family:'JetBrains Mono';font-size:10px;padding:8px 12px;background:rgba(6,182,212,.08);border:1px solid rgba(6,182,212,.2);border-radius:4px;color:var(--c);text-decoration:none;display:inline-flex;align-items:center;gap:4px;transition:.2s;min-height:36px}.bbtn:hover{background:rgba(6,182,212,.15)}
.tabs{display:flex;gap:2px;padding:4px 12px;background:var(--bg1);border-bottom:1px solid var(--bd);overflow-x:auto;height:36px}
.tabs button{font-family:'Space Grotesk';font-size:10px;font-weight:500;padding:6px 10px;border:none;background:0;color:var(--t3);cursor:pointer;border-radius:4px;transition:.2s;white-space:nowrap;min-height:32px}
.tabs button:hover{background:rgba(255,255,255,.03);color:var(--t2)}
.tabs button.on{background:rgba(34,197,94,.07);color:var(--g);border:1px solid rgba(34,197,94,.18)}
.wrap{display:flex;height:calc(100vh - 66px)}
.side{width:180px;min-width:180px;background:var(--bg1);border-right:1px solid var(--bd);overflow-y:auto;padding:6px;font-size:10px}
.sb{background:var(--bg2);border:1px solid var(--bd);border-radius:4px;padding:3px 4px;margin-bottom:2px}
.sb h4{font-size:10px;font-weight:600;margin-bottom:2px;display:flex;align-items:center;gap:3px}
.sb h4 i{width:3px;height:3px;border-radius:50%;display:inline-block}
.rw{display:flex;justify-content:space-between;padding:2px 0;font-size:9px;line-height:1.4}.rw .l{color:var(--t3)}.rw .v{font-family:'JetBrains Mono';font-size:9px;font-weight:500}
.vg{color:var(--g)}.vo{color:var(--o)}.vr{color:var(--r)}.vc{color:var(--c)}.vb{color:var(--b)}.vp{color:var(--p)}
.mn{flex:1;overflow:auto;padding:4px}.pn{display:none}.pn.on{display:block}
.svg-zw{position:relative}.svg-zi{overflow:auto;cursor:grab;max-height:calc(100vh - 160px)}
.svg-zi:active{cursor:grabbing}
.svg-zi svg{display:block}
.svg-zb{position:sticky;top:0;float:right;display:flex;gap:3px;z-index:5;margin:4px 4px 0 0}
.svg-zb button{width:28px;height:28px;border:1px solid var(--bd2);border-radius:5px;background:var(--bg2);color:var(--t1);cursor:pointer;font-family:'JetBrains Mono';font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:.15s;opacity:.7}
.svg-zb button:hover{background:var(--bg3);opacity:1}
.svg-zb .zlv{font-size:9px;font-weight:500;padding:0 4px;min-width:38px;cursor:default;justify-content:center}
[data-theme="light"] .svg-zb button{background:var(--bg2);border-color:var(--bd);color:var(--t1)}
.kpi{display:flex;gap:2px;flex-wrap:wrap;margin-bottom:4px}
.k{background:var(--bg2);border:1px solid var(--bd);border-radius:3px;padding:2px 5px;flex:1;min-width:70px}
.k .kl{font-family:'JetBrains Mono';font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.4px}
.k .kv{font-family:'JetBrains Mono';font-size:10px;font-weight:700;margin-top:0;line-height:1.2}
.k .ks{font-size:8px;color:var(--t3)}
.gr{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:4px;margin-bottom:4px}
.cd{background:var(--bg2);border:1px solid var(--bd);border-radius:4px;padding:5px 6px}
.cd h4{font-size:9px;font-weight:600;margin-bottom:0;display:flex;align-items:center;gap:3px}
.cd h4 b{width:3px;height:3px;border-radius:50%;display:inline-block}
.cd .su{font-size:9px;color:var(--t3);margin-bottom:3px}
.cd table{width:100%;font-size:10px;border-collapse:collapse}
.cd td{padding:1px 0;border-bottom:1px solid rgba(255,255,255,.015)}
.cd td:first-child{color:var(--t3);width:40%}
.cd td:last-child{font-family:'JetBrains Mono';font-size:9px;text-align:right}
.cd tr:last-child td{border:0}
.bx{background:var(--bg2);border:1px solid var(--bd);border-radius:4px;padding:5px;margin-bottom:4px}
.bx h3{font-size:10px;font-weight:600;margin-bottom:0}.bx .su{font-size:9px;color:var(--t3);margin-bottom:4px}
.lg{display:flex;flex-wrap:wrap;gap:6px;padding:3px 0;font-size:9px;color:var(--t2)}
.lg span{display:flex;align-items:center;gap:2px}.lg i{width:5px;height:5px;border-radius:1px;display:inline-block}
svg text{user-select:none}
@keyframes fR{0%{stroke-dashoffset:24}100%{stroke-dashoffset:0}}
@keyframes fL{0%{stroke-dashoffset:-24}100%{stroke-dashoffset:0}}
@keyframes fU{0%{stroke-dashoffset:16}100%{stroke-dashoffset:0}}
@keyframes fD{0%{stroke-dashoffset:-16}100%{stroke-dashoffset:0}}
.fR{stroke-dasharray:10 5;animation:fR .8s linear infinite}.fL{stroke-dasharray:10 5;animation:fL .8s linear infinite}
.fU{stroke-dasharray:6 4;animation:fU 1s linear infinite}.fD{stroke-dasharray:6 4;animation:fD 1s linear infinite}
@keyframes rG{0%,100%{opacity:.72}50%{opacity:1}}.rg{animation:rG 3s ease infinite}
@keyframes hR{0%{transform:translateY(0);opacity:.3}50%{opacity:.12}100%{transform:translateY(-28px);opacity:0}}.hp{animation:hR 2s ease-out infinite}
@keyframes cP{0%{transform:translateY(0);opacity:.2}100%{transform:translateY(15px);opacity:0}}.cp{animation:cP 2.5s ease-out infinite}
@keyframes wR{0%{transform:translateX(0);opacity:.25}100%{transform:translateX(42px);opacity:0}}.wr{animation:wR 1.6s ease-out infinite}
@keyframes wL{0%{transform:translateX(0);opacity:.25}100%{transform:translateX(-42px);opacity:0}}.wl{animation:wL 1.6s ease-out infinite}
@keyframes sh{0%{opacity:.02}50%{opacity:.07}100%{opacity:.02}}.sh{animation:sh 2.5s ease infinite}
@keyframes ep{0%,100%{opacity:.4}50%{opacity:.9}}.ep{animation:ep 1.5s ease infinite}
@keyframes lv{0%,100%{fill-opacity:.6}50%{fill-opacity:1}}.lv{animation:lv 2s ease infinite}
@keyframes pmp{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.pmp{animation:pmp 2s linear infinite;transform-origin:center}
/* Responsive - Comprehensive Mobile Support */
@media(max-width:1024px){
    .wrap{flex-direction:column;height:auto}
    .side{width:100%;min-width:100%;max-height:200px;font-size:9px}
    .sb h4{font-size:9px}
    .rw{font-size:8px}.rw .v{font-size:8px}
    .gr{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:800px){
    .wrap{flex-direction:column;height:auto}
    .side{width:100%;min-width:100%;max-height:180px;font-size:10px}
    .sb{padding:6px 8px;margin-bottom:4px}
    .sb h4{font-size:10px}
    .rw{font-size:9px;padding:2px 0}.rw .v{font-size:9px}
    .kpi{flex-direction:column}
    .gr{grid-template-columns:1fr}
    .k{padding:8px 10px;min-width:auto}
    .k .kl{font-size:9px}
    .k .kv{font-size:14px}
    .k .ks{font-size:8px}
}
@media(max-width:600px){
    .hdr{height:auto;min-height:44px;padding:8px 10px;flex-wrap:wrap;gap:6px}
    .hdr h1{font-size:11px}
    .chip{font-size:9px;padding:3px 6px}
    .hdr-r{font-size:9px}
    .bbtn{padding:10px 12px;font-size:10px;min-height:44px}
    .tabs{height:auto;min-height:36px;padding:4px 8px;flex-wrap:wrap;gap:4px}
    .tabs button{padding:8px 10px;font-size:10px;min-height:36px}
    .side{max-height:220px;padding:8px;font-size:11px}
    .sb{padding:8px 10px}
    .sb h4{font-size:11px;margin-bottom:4px}
    .rw{font-size:10px;padding:3px 0;min-height:24px}.rw .v{font-size:10px}
    .mn{padding:8px}
    .k{padding:10px 12px}
    .k .kl{font-size:10px}
    .k .kv{font-size:16px}
    .k .ks{font-size:9px}
    .cd{padding:10px}
    .cd h4{font-size:11px}
    .cd .su{font-size:9px}
    .cd table{font-size:10px}
    .cd td:last-child{font-size:9px}
    .bx h3{font-size:12px}
    .bx .su{font-size:9px}
    .lg{font-size:9px}
}
@media(max-width:480px){
    .hdr h1{font-size:10px}
    .bbtn{padding:8px 10px;font-size:9px}
    .tabs button{font-size:9px;padding:6px 8px}
    .side{font-size:10px}
    .rw{font-size:9px}.rw .v{font-size:9px}
    .k .kl{font-size:9px}
    .k .kv{font-size:14px}
}
/* Light Mode Theme */
[data-theme="light"]{--bg:#f8fafc;--bg1:#ffffff;--bg2:#f1f5f9;--bg3:#e2e8f0;--t1:#1e293b;--t2:#475569;--t3:#64748b;--bd:#cbd5e1;--bd2:#94a3b8}
[data-theme="light"] html,[data-theme="light"] body{background:var(--bg);color:var(--t1)}
[data-theme="light"] .hdr{background:linear-gradient(180deg,rgba(255,255,255,.98),rgba(248,250,252,.95));border-bottom-color:var(--bd)}
[data-theme="light"] .tabs{background:var(--bg1);border-bottom-color:var(--bd)}
[data-theme="light"] .tabs button{color:var(--t3)}
[data-theme="light"] .tabs button:hover{background:rgba(0,0,0,.03);color:var(--t2)}
[data-theme="light"] .tabs button.on{background:rgba(34,197,94,.1);color:#16a34a;border-color:rgba(34,197,94,.3)}
[data-theme="light"] .side{background:var(--bg1);border-right-color:var(--bd)}
[data-theme="light"] .sb,[data-theme="light"] .cd,[data-theme="light"] .bx,[data-theme="light"] .k{background:var(--bg2);border-color:var(--bd)}
[data-theme="light"] .cd td{border-bottom-color:rgba(0,0,0,.05)}
[data-theme="light"] a{color:#0891b2}
[data-theme="light"] .chip{color:#16a34a;background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.3)}
[data-theme="light"] .bbtn{background:rgba(6,182,212,.1);border-color:rgba(6,182,212,.3);color:#0891b2}
[data-theme="light"] .bbtn:hover{background:rgba(6,182,212,.2)}
[data-theme="light"] ::-webkit-scrollbar-thumb{background:var(--bd)}
/* Theme Toggle Button */
.theme-toggle{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid rgba(6,182,212,.2);border-radius:6px;background:rgba(6,182,212,.08);color:var(--c);cursor:pointer;transition:.2s;font-size:12px}
.theme-toggle:hover{background:rgba(6,182,212,.15);transform:scale(1.05)}
[data-theme="light"] .theme-toggle{background:rgba(30,58,95,.08);border-color:rgba(30,58,95,.2);color:#1e3a5f}
[data-theme="light"] .theme-toggle:hover{background:rgba(30,58,95,.15)}
/* Top Legal Disclaimer */
.legal-disclaimer-wrap{padding:0 0 6px}
.calc-disclaimer{background:rgba(15,23,42,.72);border:1px solid rgba(148,163,184,.24);border-left:3px solid var(--o);border-radius:8px;padding:10px 12px}
.calc-disclaimer .disc-title{display:inline-flex;align-items:center;gap:6px;margin:0 0 5px;font-size:10px;letter-spacing:.08em;text-transform:uppercase;font-weight:700;color:#e2e8f0}
.calc-disclaimer .disc-text{font-size:10px;color:var(--t2);line-height:1.5;margin:0}
.calc-disclaimer .disc-text+.disc-text{margin-top:4px}
.calc-disclaimer a{color:var(--c);text-decoration:underline}
.calc-disclaimer strong{color:#cbd5e1}
[data-theme="light"] .calc-disclaimer{background:rgba(255,255,255,.92);border-color:rgba(148,163,184,.45)}
[data-theme="light"] .calc-disclaimer .disc-title{color:#1e293b}
[data-theme="light"] .calc-disclaimer .disc-text{color:#334155}
[data-theme="light"] .calc-disclaimer strong{color:#0f172a}
[data-theme="light"] .calc-disclaimer a{color:#1d4ed8}
        /* Cookie Banner */
        .cookie-banner { position: fixed; bottom: 0; left: 0; right: 0; z-index: 10002; display: flex; align-items: center; justify-content: center; gap: 1.5rem; padding: 1rem 2rem; background: rgba(255,255,255,0.92); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(0,0,0,0.08); box-shadow: 0 -2px 16px rgba(0,0,0,0.06); font-size: 0.85rem; color: #374151; transform: translateY(0); transition: transform 0.4s cubic-bezier(0.4,0,0.2,1); }
        .cookie-banner.hidden { transform: translateY(100%); pointer-events: none; }
        .cookie-banner p { margin: 0; line-height: 1.5; }
        .cookie-banner a { color: #2563eb; text-decoration: underline; }
        .cookie-actions { display: flex; gap: 0.75rem; align-items: center; flex-shrink: 0; }
        .cookie-accept { padding: 0.45rem 1.2rem; background: #2563eb; color: #fff; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .cookie-accept:hover { background: #1d4ed8; }
        .cookie-decline { padding: 0.45rem 1.2rem; background: transparent; color: #6b7280; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .cookie-decline:hover { background: #f3f4f6; color: #374151; }
        @media (max-width: 768px) { .cookie-banner { flex-direction: column; gap: 0.75rem; text-align: center; padding: 1rem; } }
        @media print { .cookie-banner { display: none; } }
/* CDU HMI Mimic Popup */
.cdu-hmi{position:fixed;z-index:200;display:none;width:760px;max-width:92vw;max-height:88vh;overflow-y:auto;background:linear-gradient(180deg,#0a1628,#050c18);border:1px solid rgba(6,182,212,.4);border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,.7);backdrop-filter:blur(12px)}
.cdu-hmi.show{display:block}
.cdu-hmi-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:linear-gradient(90deg,rgba(6,182,212,.12),rgba(59,130,246,.08));border-bottom:1px solid rgba(6,182,212,.2)}
.cdu-hmi-hdr h4{font-family:'JetBrains Mono';font-size:12px;font-weight:600;color:var(--c);margin:0}
.cdu-hmi-hdr .mode{font-family:'JetBrains Mono';font-size:9px;padding:2px 8px;border-radius:3px;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3);color:var(--g)}
.cdu-hmi-close{background:none;border:1px solid rgba(239,68,68,.3);border-radius:4px;color:var(--r);cursor:pointer;font-size:14px;width:24px;height:24px;display:flex;align-items:center;justify-content:center;transition:.2s}
.cdu-hmi-close:hover{background:rgba(239,68,68,.15)}
.cdu-hmi-body{padding:10px 14px}
.cdu-hmi svg{width:100%;border-radius:4px;background:#080e1a}
[data-theme="light"] .cdu-hmi{background:linear-gradient(180deg,#f1f5f9,#e2e8f0);border-color:rgba(6,182,212,.5)}
[data-theme="light"] .cdu-hmi-hdr{background:linear-gradient(90deg,rgba(6,182,212,.1),rgba(59,130,246,.06))}
[data-theme="light"] .cdu-hmi-hdr h4{color:#0891b2}
[data-theme="light"] .cdu-hmi svg{background:#f8fafc}
/* Chiller HMI Modal */
.ch-hmi{position:fixed;z-index:200;display:none;width:760px;max-width:92vw;max-height:88vh;overflow-y:auto;background:linear-gradient(180deg,#0a1628,#050c18);border:1px solid rgba(245,158,11,.4);border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,.7);backdrop-filter:blur(12px)}
.ch-hmi.show{display:block}
.ch-hmi-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:linear-gradient(90deg,rgba(245,158,11,.12),rgba(34,197,94,.08));border-bottom:1px solid rgba(245,158,11,.2)}
.ch-hmi-hdr h4{font-family:'JetBrains Mono';font-size:12px;font-weight:600;color:var(--o);margin:0}
.ch-hmi-hdr .mode{font-family:'JetBrains Mono';font-size:9px;padding:2px 8px;border-radius:3px;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3);color:var(--g)}
.ch-hmi-close{background:none;border:1px solid rgba(239,68,68,.3);border-radius:4px;color:var(--r);cursor:pointer;font-size:14px;width:24px;height:24px;display:flex;align-items:center;justify-content:center;transition:.2s}
.ch-hmi-close:hover{background:rgba(239,68,68,.15)}
.ch-hmi-body{padding:10px 14px}
.ch-hmi svg{width:100%;border-radius:4px;background:#080e1a}
[data-theme="light"] .ch-hmi{background:linear-gradient(180deg,#f1f5f9,#e2e8f0);border-color:rgba(245,158,11,.5)}
[data-theme="light"] .ch-hmi-hdr{background:linear-gradient(90deg,rgba(245,158,11,.1),rgba(34,197,94,.06))}
[data-theme="light"] .ch-hmi-hdr h4{color:#d97706}
[data-theme="light"] .ch-hmi svg{background:#f8fafc}
/* Cooling Tower HMI Modal */
.ct-hmi{position:fixed;z-index:200;display:none;width:760px;max-width:92vw;max-height:88vh;overflow-y:auto;background:linear-gradient(180deg,#0a1628,#050c18);border:1px solid rgba(139,92,246,.4);border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,.7);backdrop-filter:blur(12px)}
.ct-hmi.show{display:block}
.ct-hmi-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:linear-gradient(90deg,rgba(139,92,246,.12),rgba(6,182,212,.08));border-bottom:1px solid rgba(139,92,246,.2)}
.ct-hmi-hdr h4{font-family:'JetBrains Mono';font-size:12px;font-weight:600;color:var(--p);margin:0}
.ct-hmi-hdr .mode{font-family:'JetBrains Mono';font-size:9px;padding:2px 8px;border-radius:3px;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3);color:var(--g)}
.ct-hmi-close{background:none;border:1px solid rgba(239,68,68,.3);border-radius:4px;color:var(--r);cursor:pointer;font-size:14px;width:24px;height:24px;display:flex;align-items:center;justify-content:center;transition:.2s}
.ct-hmi-close:hover{background:rgba(239,68,68,.15)}
.ct-hmi-body{padding:10px 14px}
.ct-hmi svg{width:100%;border-radius:4px;background:#080e1a}
[data-theme="light"] .ct-hmi{background:linear-gradient(180deg,#f1f5f9,#e2e8f0);border-color:rgba(139,92,246,.5)}
[data-theme="light"] .ct-hmi-hdr{background:linear-gradient(90deg,rgba(139,92,246,.1),rgba(6,182,212,.06))}
[data-theme="light"] .ct-hmi-hdr h4{color:#7c3aed}
[data-theme="light"] .ct-hmi svg{background:#f8fafc}
/* Equipment HMI Modal (CW Pump, FWS Pump, TCS Manifold) */
.eq-hmi{position:fixed;z-index:200;display:none;width:800px;max-width:94vw;max-height:90vh;overflow-y:auto;background:linear-gradient(180deg,#0a1628,#050c18);border:1px solid rgba(6,182,212,.4);border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,.7);backdrop-filter:blur(12px)}
.eq-hmi.show{display:block}
.eq-hmi-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:linear-gradient(90deg,rgba(6,182,212,.12),rgba(59,130,246,.08));border-bottom:1px solid rgba(6,182,212,.2)}
.eq-hmi-hdr h4{font-family:'JetBrains Mono';font-size:12px;font-weight:600;color:var(--c);margin:0}
.eq-hmi-hdr .mode{font-family:'JetBrains Mono';font-size:9px;padding:2px 8px;border-radius:3px;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3);color:var(--g)}
.eq-hmi-close{background:none;border:1px solid rgba(239,68,68,.3);border-radius:4px;color:var(--r);cursor:pointer;font-size:14px;width:24px;height:24px;display:flex;align-items:center;justify-content:center;transition:.2s}
.eq-hmi-close:hover{background:rgba(239,68,68,.15)}
.eq-hmi-body{padding:10px 14px}
.eq-hmi svg{width:100%;border-radius:4px;background:#080e1a}
[data-theme="light"] .eq-hmi{background:linear-gradient(180deg,#f1f5f9,#e2e8f0);border-color:rgba(6,182,212,.5)}
[data-theme="light"] .eq-hmi-hdr{background:linear-gradient(90deg,rgba(6,182,212,.1),rgba(59,130,246,.06))}
[data-theme="light"] .eq-hmi-hdr h4{color:#0891b2}
[data-theme="light"] .eq-hmi svg{background:#f8fafc}
/* Rack Detail Modal */
.rack-modal{position:fixed;z-index:200;display:none;width:820px;max-width:94vw;max-height:90vh;overflow-y:auto;background:linear-gradient(180deg,#0a1628,#050c18);border:1px solid rgba(34,197,94,.4);border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,.7);backdrop-filter:blur(12px)}
.rack-modal.show{display:block}
.rack-modal-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:linear-gradient(90deg,rgba(34,197,94,.12),rgba(6,182,212,.08));border-bottom:1px solid rgba(34,197,94,.2)}
.rack-modal-hdr h4{font-family:'JetBrains Mono';font-size:12px;font-weight:600;color:var(--g);margin:0}
.rack-modal-hdr .mode{font-family:'JetBrains Mono';font-size:9px;padding:2px 8px;border-radius:3px;background:rgba(6,182,212,.12);border:1px solid rgba(6,182,212,.3);color:var(--c)}
.rack-modal-close{background:none;border:1px solid rgba(239,68,68,.3);border-radius:4px;color:var(--r);cursor:pointer;font-size:14px;width:24px;height:24px;display:flex;align-items:center;justify-content:center;transition:.2s}
.rack-modal-close:hover{background:rgba(239,68,68,.15)}
.rack-modal-body{padding:10px 14px}
.rack-modal svg{width:100%;border-radius:4px;background:#080e1a}
[data-theme="light"] .rack-modal{background:linear-gradient(180deg,#f1f5f9,#e2e8f0);border-color:rgba(34,197,94,.5)}
[data-theme="light"] .rack-modal-hdr{background:linear-gradient(90deg,rgba(34,197,94,.1),rgba(6,182,212,.06))}
[data-theme="light"] .rack-modal-hdr h4{color:#16a34a}
[data-theme="light"] .rack-modal svg{background:#f8fafc}
/* Overview Tab */
[data-tab]{cursor:pointer;transition:filter .2s,transform .15s}
[data-tab]:hover{filter:brightness(1.3);transform:translateY(-1px)}
</style></head><body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<header class="hdr">
<div style="display:flex;align-items:center;gap:8px">
<a href="index.html" class="bbtn">&#8592; Portfolio</a>
<a href="datacenter-solutions.html" class="bbtn" style="background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.25);color:var(--g)">&#8592; DC Solutions</a>
<h1>AI Data Hall<span class="chip">GB200 NVL72 LIVE</span></h1>
</div>
<div class="hdr-r"><button class="theme-toggle" id="themeToggle" title="Toggle theme">&#9790;</button><span class="dot"></span>&nbsp;<span id="clk">--:--:--</span> WIB</div>
</header>
<nav class="tabs" id="tabs">
<button class="on" data-t="dash">DC Dashboard</button>
<button data-t="hall">Data Hall</button>
<button data-t="over">Overview</button>
<button data-t="rack">Rack Architecture</button>
<button data-t="cool">Cooling &amp; Piping</button>
<button data-t="elec">Electrical SLD</button>
<button data-t="net">Network</button>
<button data-t="fire">Fire &amp; Safety</button>
<button data-t="bms">BMS</button>
</nav>
<div class="wrap">
<aside class="side">
<div class="sb"><h4><i style="background:var(--g)"></i>Compute</h4>
<div class="rw"><span class="l" title="NVIDIA GB200 NVL36×2 — 2 racks form one NVL72 domain">Platform</span><span class="v vg">GB200 NVL36&#215;2</span></div>
<div class="rw"><span class="l" title="NVL72 domains — each domain = 72 GPUs, 36 Grace CPUs, 1 rack pair">Domains</span><span class="v vg" id="sDom">27/27</span></div>
<div class="rw"><span class="l" title="NVIDIA Blackwell B200 GPU — 4th gen data center GPU architecture">Blackwell</span><span class="v">1,944 GPU</span></div>
<div class="rw"><span class="l" title="NVIDIA Grace ARM-based CPU — paired with Blackwell GPU">Grace</span><span class="v">972 CPU</span></div>
<div class="rw"><span class="l" title="Thermal Design Power — maximum sustained power per B200 GPU chip">GPU TDP</span><span class="v vo">1,000-1,200W</span></div>
<div class="rw"><span class="l" title="High Bandwidth Memory 3e — stacked on-package GPU memory, 192GB per GPU">HBM3e</span><span class="v">373 TB</span></div>
<div class="rw"><span class="l" title="AI precision formats — FP4: 1,400 EFLOPS, FP8: 720 EFLOPS, BF16: 360 EFLOPS per NVL72">FP4/FP8/BF16</span><span class="v vo">1400/720/360 EF</span></div>
<div class="rw"><span class="l" title="NVLink5 bandwidth per domain — 130 TB/s all-to-all between 72 GPUs">NVLink/dom</span><span class="v">130 TB/s</span></div></div>
<div class="sb"><h4><i style="background:var(--o)"></i>Power</h4>
<div class="rw"><span class="l" title="Total IT compute power consumption (GPUs + CPUs + NICs + switches)">IT Load</span><span class="v vo" id="sPit">7,128 kW</span></div>
<div class="rw"><span class="l" title="Mechanical + Auxiliary — cooling systems, lighting, BMS, fire systems power">Mech+Aux</span><span class="v">555 kW</span></div>
<div class="rw"><span class="l" title="Total facility power draw — IT Load + Mechanical + Auxiliary">Total</span><span class="v vo">7,683 kW</span></div>
<div class="rw"><span class="l" title="Power per NVL72 domain — 132kW for 72 GPUs + networking per rack pair">Per NVL72</span><span class="v vr">132 kW</span></div>
<div class="rw"><span class="l" title="Uninterruptible Power Supply Feed A — 4.5MW Li-Ion double conversion">UPS A</span><span class="v vg" id="sUA">Online 68%</span></div>
<div class="rw"><span class="l" title="Uninterruptible Power Supply Feed B — 4.5MW Li-Ion double conversion">UPS B</span><span class="v vg" id="sUB">Online 67%</span></div>
<div class="rw"><span class="l" title="Diesel Generator Set — 2×2.5MW backup power, <10s auto-start">GenSet</span><span class="v vg">Standby OK</span></div></div>
<div class="sb"><h4><i style="background:var(--c)"></i>Cooling</h4>
<div class="rw"><span class="l" title="Direct Liquid Cooling — handles 85% of heat via cold plates on GPU/CPU">DLC 85%</span><span class="v vc">6,060 kW</span></div>
<div class="rw"><span class="l" title="Air cooling — handles 15% residual heat (VRM, DIMM, SSD, NIC)">Air 15%</span><span class="v">1,070 kW</span></div>
<div class="rw"><span class="l" title="Technology Cooling System Supply — coolant temperature to racks (35°C nominal)">TCS Sup</span><span class="v vc" id="sTS">35.2&#176;C</span></div>
<div class="rw"><span class="l" title="Technology Cooling System Return — heated coolant from racks (45°C nominal)">TCS Ret</span><span class="v vo" id="sTR">44.8&#176;C</span></div>
<div class="rw"><span class="l" title="TCS temperature differential — Return minus Supply, target ~10°C">TCS &#916;T</span><span class="v vc" id="sDT">9.6&#176;C</span></div>
<div class="rw"><span class="l" title="Coolant Distribution Units — end-of-row L2L heat exchangers, 350kW each">CDUs</span><span class="v vg">5/6 N+1 (2/RP EoR)</span></div>
<div class="rw"><span class="l" title="Centrifugal water-cooled chillers — COP 5.5, provides 12°C facility water">Chillers</span><span class="v vg" id="sCH">3/4 Run</span></div>
<div class="rw"><span class="l" title="Computer Room Air Handlers — CW fan-wall units for 15% air-side cooling">CRAHs</span><span class="v vg">5/6 Act</span></div></div>
<div class="sb"><h4><i style="background:var(--b)"></i>Network</h4>
<div class="rw"><span class="l" title="NVLink 5th gen — 130 TB/s intra-domain GPU-to-GPU interconnect">NVLink5</span><span class="v vg">All Up</span></div>
<div class="rw"><span class="l" title="InfiniBand Extended Data Rate — 800 Gb/s per port, 4-Rail Fat-Tree topology">IB XDR</span><span class="v vg">800G Online</span></div>
<div class="rw"><span class="l" title="Out-of-Band / Baseboard Management Controller — 25GbE management network">OOB/BMC</span><span class="v vg">Active</span></div></div>
<div class="sb"><h4><i style="background:var(--r)"></i>Safety</h4>
<div class="rw"><span class="l" title="VESDA: Very Early Smoke Detection Apparatus — aspirating laser detector">Fire/VESDA</span><span class="v vg" id="sbFire">Normal</span></div>
<div class="rw"><span class="l" title="Emergency Power Off — dual-confirm shunt-trip, cuts all electrical power">EPO</span><span class="v vg">Armed</span></div>
<div class="rw"><span class="l" title="Liquid leak detection system — TTK/RLE rope sensors, 24 zones">Leak</span><span class="v vg" id="sbLeak">Clear</span></div></div>
<div class="sb"><h4><i style="background:var(--p)"></i>Alarms</h4>
<div class="rw"><span class="l" title="Addressable photoelectric smoke detectors — point-type ceiling mounted">Smoke Det</span><span class="v vg" id="sbSmoke">48 OK</span></div>
<div class="rw"><span class="l" title="Rate-of-rise + fixed-temp heat detectors — 57°C alarm threshold">Heat Det</span><span class="v vg" id="sbHeat">24 OK</span></div>
<div class="rw"><span class="l" title="Very Early Smoke Detection Apparatus — LaserPLUS aspirating, pre-fire alert">VESDA</span><span class="v vg" id="sbVesda">4 OK</span></div>
<div class="rw"><span class="l" title="Continuous leak detection rope sensor — under raised floor and rack manifolds">Leak Rope</span><span class="v vg" id="sbRope">24z OK</span></div>
<div class="rw"><span class="l" title="Number of fire/safety devices currently disabled or bypassed">Disabled</span><span class="v vo" id="sbDisabled">0</span></div>
<div class="rw"><span class="l" title="Number of devices currently in active alarm state">In Alarm</span><span class="v vg" id="sbInAlarm">0</span></div>
<div class="rw"><span class="l" title="Devices in scheduled maintenance mode — temporarily suppressed from alarms">Maint</span><span class="v vc" id="sbMaint">2 sched</span></div></div>
</aside>
<main class="mn" id="main-content">

<div class="legal-disclaimer-wrap" aria-label="Legal Disclaimer">
<div class="calc-disclaimer">
<p class="disc-title"><span aria-hidden="true">&#9888;</span>Legal Notice</p>
<p class="disc-text">This AI data hall dashboard is independent personal research based on publicly available standards and references. It does not represent any current or former employer.</p>
<p class="disc-text">All metrics and calculations are for educational and estimation purposes only, not legal, financial, investment, procurement, safety, or engineering advice. Validate final decisions with qualified professionals and local regulations.</p>
<p class="disc-text">Use of this site is subject to our <a href="terms.html">Terms</a> and <a href="privacy.html">Privacy Policy</a>. All rendering runs in-browser.</p>
</div>
</div>

<div class="pn" id="p-over">
<div class="bx"><h3>System Overview</h3><div class="su">Power → Cooling → Compute → Network → Protection — click any block for detail tab</div>
<svg id="overSvg" viewBox="0 0 960 470" style="width:100%" xmlns="http://www.w3.org/2000/svg"><g id="overC"></g></svg></div>
</div>

<div class="pn on" id="p-dash">
<!-- KPI Strip at Top -->
<div style="display:grid;grid-template-columns:repeat(8,1fr);gap:4px;margin-bottom:6px">
<div class="k"><div class="kl" title="Power Usage Effectiveness — Total Facility Power ÷ IT Load (ideal = 1.0)">PUE</div><div class="kv" style="color:var(--g)" id="dkPue">1.08</div><div class="ks">Target ≤1.12</div></div>
<div class="k"><div class="kl" title="Water Usage Effectiveness — liters of water consumed per kWh of IT load">WUE</div><div class="kv" style="color:var(--c)" id="dkWue">0.42</div><div class="ks">L/kWh</div></div>
<div class="k"><div class="kl" title="Carbon Usage Effectiveness — kg CO₂ emitted per kWh of IT load">CUE</div><div class="kv" style="color:var(--p)" id="dkCue">0.38</div><div class="ks">kgCO₂/kWh</div></div>
<div class="k"><div class="kl" title="Total IT compute power consumption across all 4 halls">IT Load</div><div class="kv" style="color:var(--o)" id="dkIt">28.5</div><div class="ks">MW (4 Halls)</div></div>
<div class="k"><div class="kl" title="NVIDIA Blackwell B200 GPUs — total count across all halls">GPUs</div><div class="kv" style="color:var(--g)" id="dkGpu">7,776</div><div class="ks">Blackwell</div></div>
<div class="k"><div class="kl" title="NVL72 domains — each domain = 72 GPUs with 130 TB/s NVLink5 interconnect">NVL72</div><div class="kv" style="color:var(--pk)" id="dkDom">108</div><div class="ks">Domains</div></div>
<div class="k"><div class="kl" title="Facility uptime percentage — year-to-date availability">Uptime</div><div class="kv" style="color:var(--g)">99.99</div><div class="ks">% YTD</div></div>
<div class="k"><div class="kl" title="Active alarm count — critical and warning events requiring attention">Alarms</div><div class="kv" style="color:var(--g)" id="dkAlm">0</div><div class="ks">Active</div></div>
</div>
<!-- Main Dashboard Area -->
<div style="display:grid;grid-template-columns:1fr 280px;gap:6px;height:calc(100% - 80px)">
<!-- Left: DC Image with Callouts -->
<div style="position:relative;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;overflow:hidden">
<img loading="lazy" src="assets/DashboardDC_80.jpg" alt="Data Center Facility" style="width:100%;height:100%;object-fit:cover;opacity:0.9">
<div id="dcCallouts"></div>
</div>
<!-- Right: Status Panels -->
<div style="display:flex;flex-direction:column;gap:4px;overflow-y:auto">
<div class="cd"><h4><b style="background:var(--o)"></b>Electrical</h4><table>
<tr><td title="Transformer A/B — 5MVA cast-resin dry-type, 20kV→400V">TX-A/B</td><td style="color:var(--g)">5MVA Online</td></tr>
<tr><td title="Uninterruptible Power Supply A/B — 4.5MW Li-Ion double conversion">UPS-A/B</td><td style="color:var(--g)">4.5MW Online</td></tr>
<tr><td title="Overhead copper busduct — 4,000A per feed, tap-off per rack pair">Busway</td><td>2×4,000A</td></tr>
<tr><td title="Diesel Generator Set — backup power, <10s auto-start on utility fail">GenSet</td><td style="color:var(--g)">4×2.5MW Standby</td></tr>
</table></div>
<div class="cd"><h4><b style="background:var(--c)"></b>Cooling</h4><table>
<tr><td title="Technology Cooling System Supply — coolant to racks (35°C nominal)">TCS Sup</td><td style="color:var(--c)" id="dkTcs">35.2°C</td></tr>
<tr><td title="Technology Cooling System Return — heated coolant from racks (45°C nominal)">TCS Ret</td><td style="color:var(--o)" id="dkTcr">44.8°C</td></tr>
<tr><td title="Coolant Distribution Units — end-of-row L2L heat exchangers, 350kW each">CDUs</td><td style="color:var(--g)">96/96 N+1</td></tr>
<tr><td title="Centrifugal water-cooled chillers — COP 5.5, provides 12°C facility water">Chillers</td><td style="color:var(--g)">12/16 Run</td></tr>
</table></div>
<div class="cd"><h4><b style="background:var(--b)"></b>Network</h4><table>
<tr><td title="NVLink 5th gen — 130 TB/s intra-domain GPU interconnect">NVLink5</td><td style="color:var(--g)">All Up</td></tr>
<tr><td title="InfiniBand Extended Data Rate — 800 Gb/s per port, Fat-Tree topology">IB XDR</td><td style="color:var(--g)">800G Online</td></tr>
<tr><td title="Out-of-Band / Baseboard Management Controller — 25GbE management network">OOB/BMC</td><td style="color:var(--g)">Active</td></tr>
</table></div>
<div class="cd"><h4><b style="background:var(--r)"></b>Safety</h4><table>
<tr><td title="VESDA: Very Early Smoke Detection Apparatus — aspirating laser detector">Fire/VESDA</td><td style="color:var(--g)">Normal</td></tr>
<tr><td title="Emergency Power Off — dual-confirm shunt-trip, cuts all electrical power">EPO</td><td style="color:var(--g)">Armed</td></tr>
<tr><td title="Liquid leak detection system — TTK/RLE rope sensors, 24 zones">Leak Detect</td><td style="color:var(--g)">Clear</td></tr>
</table></div>
<div class="cd"><h4><b style="background:var(--p)"></b>Access</h4><table>
<tr><td>Personnel</td><td style="color:var(--c)" id="dkPpl">3 Inside</td></tr>
<tr><td>Last Entry</td><td id="dkEntry">12:34</td></tr>
</table></div>
</div>
</div>
</div>

<div class="pn" id="p-hall">
<div class="kpi">
<div class="k"><div class="kl" title="Power Usage Effectiveness — Total Power ÷ IT Load (ideal = 1.0)">PUE</div><div class="kv" style="color:var(--g)" id="kP">1.08</div><div class="ks">&#8804;1.12</div></div>
<div class="k"><div class="kl" title="IT compute power load — GPUs + CPUs + NICs + switches">IT</div><div class="kv" style="color:var(--o)">7,128</div><div class="ks">kW</div></div>
<div class="k"><div class="kl" title="GPU utilization percentage across all 1,944 Blackwell B200 GPUs">GPU%</div><div class="kv" style="color:var(--g)" id="kG">94</div><div class="ks">1,944</div></div>
<div class="k"><div class="kl" title="NVLink5 health — 130 TB/s intra-domain GPU interconnect">NVLink</div><div class="kv" style="color:var(--g)">100%</div><div class="ks">27dom</div></div>
<div class="k"><div class="kl" title="TCS temperature differential — Return minus Supply, target ~10°C">&#916;T</div><div class="kv" style="color:var(--c)" id="kD">9.6</div><div class="ks">&#176;C</div></div>
<div class="k"><div class="kl" title="Direct Liquid Cooling — percentage of heat removed by cold plates">DLC</div><div class="kv" style="color:var(--c)" id="kC">84%</div><div class="ks">7.2MW</div></div>
<div class="k"><div class="kl" title="Facility uptime — year-to-date availability percentage">Up</div><div class="kv" style="color:var(--g)">99.998</div><div class="ks">%</div></div>
<div class="k"><div class="kl" title="Average watts per GPU — real-time power draw per B200 chip">W/GPU</div><div class="kv" style="color:var(--o)" id="kW">1050</div><div class="ks">avg</div></div>
<div class="k"><div class="kl" title="FP4 AI performance — 4-bit floating point EFLOPS per NVL72 domain">FP4</div><div class="kv" style="color:var(--p)">1400</div><div class="ks">EF</div></div>
</div>
<svg id="hSvg" viewBox="0 0 960 480" style="width:100%;background:var(--bg2);border:1px solid var(--bd);border-radius:5px" xmlns="http://www.w3.org/2000/svg">
<defs>
<pattern id="gd" width="25" height="25" patternUnits="userSpaceOnUse"><path d="M25 0L0 0 0 25" fill="none" stroke="rgba(255,255,255,.012)" stroke-width=".3"/></pattern>
<filter id="gG"><feGaussianBlur stdDeviation="1.8" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
<filter id="gB"><feGaussianBlur stdDeviation="1.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
<filter id="gC"><feGaussianBlur stdDeviation="1.2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
<linearGradient id="hotG" x1="0" y1="1" x2="0" y2="0"><stop offset="0%" stop-color="rgba(239,68,68,.08)"/><stop offset="100%" stop-color="rgba(239,68,68,.01)"/></linearGradient>
</defs>
<rect width="960" height="480" fill="url(#gd)"/>
<rect x="10" y="8" width="940" height="464" rx="3" fill="none" stroke="var(--bd2)" stroke-width="1"/>
<text x="22" y="21" fill="var(--t3)" font-family="JetBrains Mono" font-size="7" font-weight="600">DATA HALL &#8212; 32m&#215;20m &#8212; 640m&#178; &#8212; &#8805;3,500kg/m&#178; &#8212; 4.2m clear &#8212; Zone 4</text>
<g id="hc"></g></svg>
<div class="lg"><span><i style="background:#22c55e;box-shadow:0 0 3px rgba(34,197,94,.5)"></i>AI Rack</span><span><i style="background:#3b82f6"></i>Network</span><span><i style="background:#555"></i>Passive</span><span><i style="background:var(--c)"></i>CDU (EoR)</span><span style="color:var(--r)">&#9650;Hot</span><span style="color:var(--c)">&#9660;Cold</span><span style="color:var(--o)">&#9670;TTHT</span><span style="color:rgba(6,182,212,.4)">&#8213; OH Pipe</span></div>
</div>

<div class="pn" id="p-rack">
<div class="bx"><h3>Rack Architecture</h3><div class="su" id="rackSu"></div>
<svg id="rackSvg" viewBox="0 0 960 470" style="width:100%" xmlns="http://www.w3.org/2000/svg"><g id="rackC"></g></svg></div>
<div class="gr" id="rackCards"></div></div>
<div class="pn" id="p-cool">
<div class="bx"><h3>Cooling & Piping P&ID</h3><div class="su" id="coolSu"></div>
<svg id="coolSvg" viewBox="0 0 960 560" style="width:100%" xmlns="http://www.w3.org/2000/svg"><g id="coolC"></g></svg></div>
<div class="gr" id="coolCards"></div></div>
<div class="pn" id="p-elec">
<div class="bx"><h3>Electrical SLD</h3><div class="su" id="elecSu"></div>
<svg id="elecSvg" viewBox="0 0 960 480" style="width:100%" xmlns="http://www.w3.org/2000/svg"><g id="elecC"></g></svg></div>
<div class="gr" id="elecCards"></div></div>
<div class="pn" id="p-net">
<div class="bx"><h3>Network Fabric Topology</h3><div class="su" id="netSu"></div>
<svg id="netSvg" viewBox="0 0 960 520" style="width:100%" xmlns="http://www.w3.org/2000/svg"><g id="netC"></g></svg></div>
<div class="gr" id="netCards"></div></div>
<div class="pn" id="p-fire">
<div class="bx"><h3>Fire Detection & Suppression P&ID</h3><div class="su" id="fireSu"></div>
<svg id="fireSvg" viewBox="0 0 960 580" style="width:100%" xmlns="http://www.w3.org/2000/svg"><g id="fireC"></g></svg></div>
<div class="gr" id="fireCards"></div></div>
<div class="pn" id="p-bms">
<div class="bx"><h3>BMS/DCIM Architecture</h3><div class="su" id="bmsSu"></div>
<svg id="bmsSvg" viewBox="0 0 960 480" style="width:100%" xmlns="http://www.w3.org/2000/svg"><g id="bmsC"></g></svg></div>
<div class="gr" id="bmsCards"></div></div>

    </main></div>
<div class="cdu-hmi" id="cduHmi">
<div class="cdu-hmi-hdr"><h4 id="cduHmiTitle">CDU-01 HMI</h4><span class="mode" id="cduHmiMode">Online</span><button class="cdu-hmi-close" onclick="$('cduHmi').classList.remove('show')">&times;</button></div>
<div class="cdu-hmi-body"><svg id="cduHmiSvg" viewBox="0 0 720 440" xmlns="http://www.w3.org/2000/svg"></svg></div>
</div>
<div class="rack-modal" id="rackModal">
<div class="rack-modal-hdr"><h4 id="rackModalTitle">Component Detail</h4><span class="mode" id="rackModalType">Block Diagram</span><button class="rack-modal-close" id="rackModalClose">&times;</button></div>
<div class="rack-modal-body"><svg id="rackModalSvg" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg"></svg></div>
</div>
<div class="ch-hmi" id="chHmi">
<div class="ch-hmi-hdr"><h4 id="chHmiTitle">CH-1 HMI</h4><span class="mode" id="chHmiMode">RUN</span><button class="ch-hmi-close" onclick="$('chHmi').classList.remove('show')">&times;</button></div>
<div class="ch-hmi-body"><svg id="chHmiSvg" viewBox="0 0 720 460" xmlns="http://www.w3.org/2000/svg"></svg></div>
</div>
<div class="ct-hmi" id="ctHmiModal">
<div class="ct-hmi-hdr"><h4 id="ctHmiTitle">CT-1 HMI</h4><span class="mode" id="ctHmiMode">RUN</span><button class="ct-hmi-close" onclick="$('ctHmiModal').classList.remove('show')">&times;</button></div>
<div class="ct-hmi-body"><svg id="ctHmiSvg" viewBox="0 0 720 560" xmlns="http://www.w3.org/2000/svg"></svg></div>
</div>
<div class="eq-hmi" id="eqHmi">
<div class="eq-hmi-hdr"><h4 id="eqHmiTitle">Equipment HMI</h4><span class="mode" id="eqHmiMode">Online</span><button class="eq-hmi-close" onclick="$('eqHmi').classList.remove('show')">&times;</button></div>
<div class="eq-hmi-body"><svg id="eqHmiSvg" viewBox="0 0 780 480" xmlns="http://www.w3.org/2000/svg"></svg></div>
</div>
<script>

const $=id=>document.getElementById(id),R=(a,b)=>(Math.random()*(b-a)+a).toFixed(1),RI=(a,b)=>Math.floor(Math.random()*(b-a)+a),J='JetBrains Mono';
setInterval(()=>{$('clk').textContent=new Date().toLocaleTimeString('en-GB')},1000);
$('tabs').addEventListener('click',e=>{if(e.target.tagName!=='BUTTON')return;document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('on'));e.target.classList.add('on');document.querySelectorAll('.pn').forEach(p=>p.classList.remove('on'));const el=$('p-'+e.target.dataset.t);if(el)el.classList.add('on')});
function tx(x,y,t,c,s,a,w){return`<text x="${x}" y="${y}" fill="${c||'var(--t2)'}" font-family="${J}" font-size="${s||6}" ${a?`text-anchor="${a}"`:''} ${w?'font-weight="600"':''}>${t}</text>`}
function bx(x,y,w,h,c,r){return`<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="${r||3}" fill="rgba(255,255,255,.015)" stroke="${c}" stroke-width=".7"/>`}
function fl(x1,y1,x2,y2,c,cls,op,sw){return`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${c}" stroke-width="${sw||2}" class="${cls}" opacity="${op||.5}"/>`}
// IEC SYMBOLS as SVG snippets
function symTX(cx,cy,c){return`<circle cx="${cx}" cy="${cy}" r="8" fill="none" stroke="${c}" stroke-width=".8"/><circle cx="${cx}" cy="${cy+7}" r="8" fill="none" stroke="${c}" stroke-width=".8"/><text x="${cx}" y="${cy-2}" fill="${c}" font-family="${J}" font-size="5" text-anchor="middle">Y</text><text x="${cx}" y="${cy+12}" fill="${c}" font-family="${J}" font-size="5" text-anchor="middle">\u0394</text>`}
function symCB(cx,cy,c,closed){return`<line x1="${cx-4}" y1="${cy+4}" x2="${cx}" y2="${cy-4}" stroke="${c}" stroke-width="1.2"/><line x1="${cx}" y1="${cy-4}" x2="${cx+4}" y2="${cy+4}" stroke="${c}" stroke-width="${closed?'1.2':'0'}"/><circle cx="${cx-4}" cy="${cy+5}" r="1.5" fill="none" stroke="${c}" stroke-width=".6"/><circle cx="${cx+4}" cy="${cy+5}" r="1.5" fill="none" stroke="${c}" stroke-width=".6"/>`}
function symGen(cx,cy,c){return`<circle cx="${cx}" cy="${cy}" r="10" fill="none" stroke="${c}" stroke-width="1"/><text x="${cx}" y="${cy+4}" fill="${c}" font-family="${J}" font-size="9" text-anchor="middle" font-weight="700">G</text>`}
function symUPS(cx,cy,c){return`<rect x="${cx-12}" y="${cy-8}" width="24" height="16" rx="2" fill="none" stroke="${c}" stroke-width=".8"/><text x="${cx}" y="${cy+4}" fill="${c}" font-family="${J}" font-size="7" text-anchor="middle" font-weight="700">UPS</text>`}
function symMotor(cx,cy,c){return`<circle cx="${cx}" cy="${cy}" r="7" fill="none" stroke="${c}" stroke-width=".8"/><text x="${cx}" y="${cy+3}" fill="${c}" font-family="${J}" font-size="7" text-anchor="middle">M</text>`}
function symValve(cx,cy,c){return`<polygon points="${cx-4},${cy-3} ${cx+4},${cy} ${cx-4},${cy+3}" fill="none" stroke="${c}" stroke-width=".8"/><polygon points="${cx+4},${cy-3} ${cx-4},${cy} ${cx+4},${cy+3}" fill="none" stroke="${c}" stroke-width=".8"/>`}
// FIRE P&ID SYMBOLS (NFPA/IEC standard)
function symSmokeDet(cx,cy,c){return`<circle cx="${cx}" cy="${cy}" r="8" fill="rgba(245,158,11,.1)" stroke="${c}" stroke-width="1"/><path d="M${cx-4} ${cy+2} Q${cx} ${cy-4} ${cx+4} ${cy+2}" fill="none" stroke="${c}" stroke-width=".8"/><circle cx="${cx}" cy="${cy+3}" r="1.5" fill="${c}"/><text x="${cx}" y="${cy+11}" fill="${c}" font-family="${J}" font-size="3" text-anchor="middle">SD</text>`}
function symHeatDet(cx,cy,c){return`<circle cx="${cx}" cy="${cy}" r="8" fill="rgba(239,68,68,.1)" stroke="${c}" stroke-width="1"/><path d="M${cx-3} ${cy+3} L${cx} ${cy-4} L${cx+3} ${cy+3}" fill="none" stroke="${c}" stroke-width="1.2"/><circle cx="${cx}" cy="${cy-2}" r="2" fill="${c}" opacity=".5"/><text x="${cx}" y="${cy+11}" fill="${c}" font-family="${J}" font-size="3" text-anchor="middle">HD</text>`}
function symVESDA(cx,cy,c){return`<rect x="${cx-10}" y="${cy-12}" width="20" height="24" rx="2" fill="rgba(139,92,246,.15)" stroke="${c}" stroke-width="1"/><circle cx="${cx}" cy="${cy-5}" r="4" fill="none" stroke="${c}" stroke-width=".6" stroke-dasharray="2 1"/><line x1="${cx}" y1="${cy-1}" x2="${cx}" y2="${cy+8}" stroke="${c}" stroke-width=".8"/><circle cx="${cx-5}" cy="${cy+5}" r="1.5" fill="${c}" opacity=".6"/><circle cx="${cx+5}" cy="${cy+5}" r="1.5" fill="${c}" opacity=".6"/><text x="${cx}" y="${cy+18}" fill="${c}" font-family="${J}" font-size="3" text-anchor="middle">VESDA</text>`}
function symNozzle(cx,cy,c){return`<polygon points="${cx-6},${cy-2} ${cx+6},${cy-2} ${cx+3},${cy+8} ${cx-3},${cy+8}" fill="rgba(239,68,68,.2)" stroke="${c}" stroke-width=".8"/><line x1="${cx-4}" y1="${cy+8}" x2="${cx-6}" y2="${cy+14}" stroke="${c}" stroke-width=".5" stroke-dasharray="2 1"/><line x1="${cx}" y1="${cy+8}" x2="${cx}" y2="${cy+15}" stroke="${c}" stroke-width=".5" stroke-dasharray="2 1"/><line x1="${cx+4}" y1="${cy+8}" x2="${cx+6}" y2="${cy+14}" stroke="${c}" stroke-width=".5" stroke-dasharray="2 1"/><text x="${cx}" y="${cy+20}" fill="${c}" font-family="${J}" font-size="3" text-anchor="middle">NZ</text>`}
function symMCP(cx,cy,c){return`<rect x="${cx-7}" y="${cy-9}" width="14" height="18" rx="1" fill="rgba(239,68,68,.2)" stroke="${c}" stroke-width="1"/><rect x="${cx-4}" y="${cy-6}" width="8" height="8" rx="1" fill="rgba(239,68,68,.3)" stroke="${c}" stroke-width=".5"/><line x1="${cx}" y1="${cy+2}" x2="${cx}" y2="${cy+6}" stroke="${c}" stroke-width="1.5"/><text x="${cx}" y="${cy+14}" fill="${c}" font-family="${J}" font-size="3" text-anchor="middle">MCP</text>`}
function symEPO(cx,cy,c){return`<circle cx="${cx}" cy="${cy}" r="12" fill="rgba(239,68,68,.15)" stroke="${c}" stroke-width="1.5"/><circle cx="${cx}" cy="${cy}" r="8" fill="rgba(239,68,68,.25)" stroke="${c}" stroke-width=".8"/><text x="${cx}" y="${cy+3}" fill="${c}" font-family="${J}" font-size="7" text-anchor="middle" font-weight="700">E</text><text x="${cx}" y="${cy+18}" fill="${c}" font-family="${J}" font-size="3" text-anchor="middle">EPO</text>`}
function symFACP(cx,cy,c,w,h){return`<rect x="${cx-w/2}" y="${cy-h/2}" width="${w}" height="${h}" rx="3" fill="rgba(245,158,11,.12)" stroke="${c}" stroke-width="1.2"/><rect x="${cx-w/2+3}" y="${cy-h/2+3}" width="${w-6}" height="12" rx="1" fill="rgba(0,0,0,.3)"/><circle cx="${cx-w/4}" cy="${cy+h/4-3}" r="3" fill="var(--g)" opacity=".7"/><circle cx="${cx}" cy="${cy+h/4-3}" r="3" fill="var(--o)" opacity=".3"/><circle cx="${cx+w/4}" cy="${cy+h/4-3}" r="3" fill="var(--r)" opacity=".3"/>`}
function symCylinder(cx,cy,c,h){return`<ellipse cx="${cx}" cy="${cy-h/2+4}" rx="6" ry="3" fill="rgba(239,68,68,.15)" stroke="${c}" stroke-width=".6"/><rect x="${cx-6}" y="${cy-h/2+4}" width="12" height="${h-8}" fill="rgba(239,68,68,.1)" stroke="${c}" stroke-width=".6"/><ellipse cx="${cx}" cy="${cy+h/2-4}" rx="6" ry="3" fill="rgba(239,68,68,.15)" stroke="${c}" stroke-width=".6"/><circle cx="${cx}" cy="${cy-h/2}" r="2" fill="${c}" opacity=".6"/>`}
function symBeamDet(cx,cy,c){return`<rect x="${cx-15}" y="${cy-5}" width="10" height="10" rx="1" fill="rgba(6,182,212,.15)" stroke="${c}" stroke-width=".8"/><rect x="${cx+5}" y="${cy-5}" width="10" height="10" rx="1" fill="rgba(6,182,212,.15)" stroke="${c}" stroke-width=".8"/><line x1="${cx-5}" y1="${cy}" x2="${cx+5}" y2="${cy}" stroke="${c}" stroke-width=".5" stroke-dasharray="3 2"/><path d="M${cx-5} ${cy-2} L${cx+5} ${cy-2}" stroke="var(--r)" stroke-width=".3" opacity=".5"/><text x="${cx}" y="${cy+12}" fill="${c}" font-family="${J}" font-size="3" text-anchor="middle">BEAM</text>`}
function symSolenoid(cx,cy,c){return`<rect x="${cx-8}" y="${cy-6}" width="16" height="12" rx="1" fill="rgba(139,92,246,.1)" stroke="${c}" stroke-width=".8"/><line x1="${cx-5}" y1="${cy-3}" x2="${cx-5}" y2="${cy+3}" stroke="${c}" stroke-width="1.5"/><line x1="${cx}" y1="${cy-3}" x2="${cx}" y2="${cy+3}" stroke="${c}" stroke-width="1.5"/><line x1="${cx+5}" y1="${cy-3}" x2="${cx+5}" y2="${cy+3}" stroke="${c}" stroke-width="1.5"/><text x="${cx}" y="${cy+12}" fill="${c}" font-family="${J}" font-size="3" text-anchor="middle">SOL</text>`}
function symPump(cx,cy,c){return`<circle cx="${cx}" cy="${cy}" r="7" fill="none" stroke="${c}" stroke-width=".8"/><polygon points="${cx-3},${cy-4} ${cx+5},${cy} ${cx-3},${cy+4}" fill="${c}" fill-opacity=".3" stroke="none"/>`}
function symHX(cx,cy,c){return`<circle cx="${cx}" cy="${cy}" r="9" fill="none" stroke="${c}" stroke-width=".8"/><line x1="${cx-6}" y1="${cy+4}" x2="${cx+6}" y2="${cy-4}" stroke="${c}" stroke-width=".6"/><line x1="${cx-6}" y1="${cy-4}" x2="${cx+6}" y2="${cy+4}" stroke="${c}" stroke-width=".6"/>`}
function symSensor(cx,cy,c,label){return`<circle cx="${cx}" cy="${cy}" r="5" fill="none" stroke="${c}" stroke-width=".6"/><text x="${cx}" y="${cy+2}" fill="${c}" font-family="${J}" font-size="4" text-anchor="middle">${label}</text>`}
function symMeter(cx,cy,c,label){return`<circle cx="${cx}" cy="${cy}" r="5" fill="none" stroke="${c}" stroke-width=".5" stroke-dasharray="1 1"/><text x="${cx}" y="${cy+2}" fill="${c}" font-family="${J}" font-size="4" text-anchor="middle">${label}</text>`}
function mc(c,t,su,rows){let h='<div class="cd"><h4><b style="background:'+c+'"></b>'+t+'</h4><div class="su">'+su+'</div><table>';rows.forEach(r=>h+='<tr><td>'+r[0]+'</td><td>'+r[1]+'</td></tr>');return h+'</table></div>'}

// ===== SYSTEM OVERVIEW TAB =====
(function(){var el=$('overC');if(!el)return;var s='';
s+='<rect width="960" height="470" fill="var(--bg2)"/>';
s+='<pattern id="ovGrid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M20 0L0 0 0 20" fill="none" stroke="rgba(255,255,255,.015)" stroke-width=".3"/></pattern>';
s+='<rect width="960" height="470" fill="url(#ovGrid)"/>';
s+=tx(480,18,'SYSTEM OVERVIEW \u2014 GB200 NVL72 AI DATA HALL','var(--t3)',9,'middle',1);
// === POWER CHAIN ===
s+=tx(30,48,'\u26A1 POWER CHAIN','var(--o)',7,0,1);
s+='<line x1="30" y1="72" x2="615" y2="72" stroke="rgba(245,158,11,.15)" stroke-width="3" stroke-dasharray="12 6"><animate attributeName="stroke-dashoffset" values="0;-36" dur="2s" repeatCount="indefinite"/></line>';
var pwrB=[{x:30,w:85,l:'PLN 20kV',s1:'2N Dual Feed',s2:'150kV Substation',tip:'PLN 20kV: Dual independent utility feeds from 150kV substation, 2N redundancy',tab:'elec'},{x:130,w:85,l:'TX 2\u00D75MVA',s1:'\u0394-Y11 Dry',s2:'20kV\u2192400V',tip:'Transformer: 2\u00D75MVA cast-resin dry-type, 20kV\u2192400V, \u0394-Y11, Zk=6%',tab:'elec'},{x:230,w:90,l:'UPS 2\u00D74.5MW',s1:'Li-Ion 10min',s2:'Double Conv',tip:'UPS: 2\u00D74.5MW double-conversion online, Li-Ion NMC 10min, THDi&lt;3%, STS &lt;4ms',tab:'elec'},{x:335,w:85,l:'BUSWAY',s1:'2\u00D74,000A Cu',s2:'OH Busduct',tip:'Busway A/B: 2\u00D74,000A Cu overhead, 12\u00D7RPP 630A MCCB tap-off to racks',tab:'elec'},{x:435,w:170,l:'27\u00D7 NVL72 RACKS',s1:'132kW each = 3,564kW',s2:'72\u00D7B200 + 36\u00D7Grace72',tip:'27 NVL72 pairs: 132kW each, 72\u00D7B200 GPU 1kW + 36\u00D7Grace72 CPU, PSU 400V\u219250VDC \u03B7>97%',tab:'hall'}];
pwrB.forEach(function(b){s+='<rect x="'+b.x+'" y="55" width="'+b.w+'" height="38" rx="4" fill="rgba(245,158,11,.08)" stroke="var(--o)" stroke-width=".8" data-tab="'+b.tab+'" data-tip="'+b.tip+'"/>';s+=tx(b.x+b.w/2,67,b.l,'var(--o)',6,'middle',1);s+=tx(b.x+b.w/2,78,b.s1,'var(--t2)',4.5,'middle');s+=tx(b.x+b.w/2,88,b.s2,'var(--t3)',4,'middle')});
// GenSet
s+='<rect x="30" y="102" width="85" height="30" rx="4" fill="rgba(239,68,68,.08)" stroke="var(--r)" stroke-width=".8" data-tab="elec" data-tip="GenSet: 4\u00D72.5MW diesel, &lt;10s auto-start, 48hr fuel, ATS-LV &lt;100ms transfer"/>';
s+=tx(72,115,'GenSet 4\u00D72.5MW','var(--r)',5,'middle',1);s+=tx(72,127,'Diesel N+1','var(--t3)',4,'middle');
s+='<line x1="72" y1="102" x2="72" y2="95" stroke="var(--r)" stroke-width="1" stroke-dasharray="3 2"/>';
// === COOLING CHAIN ===
s+=tx(30,150,'\u2744 COOLING CHAIN','var(--c)',7,0,1);
s+='<line x1="30" y1="180" x2="440" y2="180" stroke="rgba(6,182,212,.15)" stroke-width="3" stroke-dasharray="12 6"><animate attributeName="stroke-dashoffset" values="0;-36" dur="2.5s" repeatCount="indefinite"/></line>';
var coolB=[{x:30,w:85,l:'COOLING TOWER',s1:'3-Cell N+1',s2:'Induced Draft',tip:'Cooling Tower: 3 cells N+1, induced draft VFD fans, WB design 28\u00B0C, CW 28\u219235\u00B0C',tab:'cool'},{x:130,w:85,l:'CHILLER',s1:'4\u00D72.5MW COP5.5',s2:'R-1234ze(E)',tip:'Chiller: 4\u00D72.5MW centrifugal N+1, COP 5.5 / IPLV 7.2, low-GWP, FWS 12\u219222\u00B0C',tab:'cool'},{x:230,w:85,l:'CDU 22\u00D7EoR',s1:'350kW L2L HX',s2:'TCS 35\u219245\u00B0C',tip:'CDU: 22 end-of-row units N+1, 350kW plate HX, TCS 35\u00B0C supply / 45\u00B0C return, DI &lt;5\u00B5S/cm',tab:'cool'}];
coolB.forEach(function(b){s+='<rect x="'+b.x+'" y="163" width="'+b.w+'" height="38" rx="4" fill="rgba(6,182,212,.08)" stroke="var(--c)" stroke-width=".8" data-tab="'+b.tab+'" data-tip="'+b.tip+'"/>';s+=tx(b.x+b.w/2,175,b.l,'var(--c)',6,'middle',1);s+=tx(b.x+b.w/2,186,b.s1,'var(--t2)',4.5,'middle');s+=tx(b.x+b.w/2,196,b.s2,'var(--t3)',4,'middle')});
// CRAH
s+='<rect x="330" y="163" width="85" height="38" rx="4" fill="rgba(59,130,246,.08)" stroke="var(--b)" stroke-width=".8" data-tab="cool" data-tip="CRAH: 6\u00D7N+1 EC fan wall, 178kW each, 1,070kW total air cooling (15% IT load) for VRM/DIMM/SSD/NIC"/>';
s+=tx(372,175,'CRAH 6\u00D7N+1','var(--b)',6,'middle',1);s+=tx(372,186,'Air 15% 1,070kW','var(--t2)',4.5,'middle');s+=tx(372,196,'VRM/DIMM/SSD','var(--t3)',4,'middle');
// DLC connection to racks
s+='<line x1="315" y1="163" x2="520" y2="93" stroke="rgba(6,182,212,.2)" stroke-width="2" stroke-dasharray="8 4"><animate attributeName="stroke-dashoffset" values="0;-24" dur="2s" repeatCount="indefinite"/></line>';
s+=tx(430,128,'DLC 85%','var(--c)',5,'middle');
s+='<line x1="372" y1="163" x2="520" y2="93" stroke="rgba(59,130,246,.15)" stroke-width="1.5" stroke-dasharray="6 4"><animate attributeName="stroke-dashoffset" values="0;-20" dur="2.5s" repeatCount="indefinite"/></line>';
s+=tx(460,138,'Air 15%','var(--b)',4,'middle');
// === DATA FABRIC ===
s+=tx(30,222,'\uD83D\uDD17 DATA FABRIC','var(--pk)',7,0,1);
s+='<line x1="30" y1="250" x2="450" y2="250" stroke="rgba(236,72,153,.12)" stroke-width="2" stroke-dasharray="8 8"><animate attributeName="stroke-dashoffset" values="0;-32" dur="1.5s" repeatCount="indefinite"/></line>';
var netB=[{x:30,w:120,l:'NVLink5 130TB/s',s1:'Intra-Rack All-to-All',s2:'18\u00D7NVSwitch5/dom',tip:'NVLink5: 130 TB/s bisection per NVL72 domain, 18\u00D7NVSwitch5, passive Cu coax, &lt;1\u00B5s latency',tab:'net'},{x:165,w:120,l:'IB XDR 800G',s1:'4-Rail Fat-Tree 1:1',s2:'8\u00D7Leaf + 4\u00D7Spine',tip:'InfiniBand XDR: 800G/port, 4-rail fat-tree 1:1, 8\u00D7QX800 leaf + 4\u00D7QX800 spine, GPUDirect RDMA',tab:'net'},{x:300,w:120,l:'OOB 25GbE',s1:'BMC Management',s2:'Prometheus/Grafana',tip:'Out-of-Band: 25GbE ToR/rack, 1GbE BMC/tray, SNMP v3, Redfish API, dcgm_exporter telemetry',tab:'net'}];
netB.forEach(function(b){s+='<rect x="'+b.x+'" y="235" width="'+b.w+'" height="38" rx="4" fill="rgba(236,72,153,.08)" stroke="var(--pk)" stroke-width=".8" data-tab="'+b.tab+'" data-tip="'+b.tip+'"/>';s+=tx(b.x+b.w/2,248,b.l,'var(--pk)',6,'middle',1);s+=tx(b.x+b.w/2,259,b.s1,'var(--t2)',4.5,'middle');s+=tx(b.x+b.w/2,269,b.s2,'var(--t3)',4,'middle')});
// === PROTECTION ===
s+=tx(30,295,'\uD83D\uDEE1 PROTECTION','var(--r)',7,0,1);
var safeB=[{x:30,w:85,l:'VESDA',s1:'4\u00D7 LaserPLUS',st:'OK',tip:'VESDA: 4\u00D7 LaserPLUS aspirating detectors, 100 sample pts each, 4-tier sensitivity, pre-fire warning',tab:'fire'},{x:130,w:85,l:'FACP',s1:'640pt 12 SLC',st:'OK',tip:'FACP: Notifier NFS2-3030, 640 addressable points, 12 SLC loops, 48 smoke + 24 heat + 2 beam detectors',tab:'fire'},{x:230,w:85,l:'NOVEC 1230',s1:'4\u00D7180L 42bar',st:'ARMED',tip:'Novec 1230: 4\u00D7180L at 42bar N\u2082, 5.3% concentration, double-interlock, \u226410s discharge, NFPA 2001',tab:'fire'},{x:330,w:85,l:'LEAK DET',s1:'24z 800m rope',st:'CLEAR',tip:'Leak Detection: TTK/RLE 24 zones, 800m rope + 180 point sensors, auto shutoff &lt;3s, BMS alarm',tab:'fire'},{x:430,w:85,l:'BMS/DCIM',s1:'EcoStruxure',st:'ONLINE',tip:'BMS/DCIM: Schneider EcoStruxure, redundant MMR01/02 servers, fiber ring, Modbus/BACnet/SNMP/OPC-UA',tab:'bms'}];
safeB.forEach(function(b){s+='<rect x="'+b.x+'" y="308" width="'+b.w+'" height="45" rx="4" fill="rgba(239,68,68,.06)" stroke="var(--g)" stroke-width=".8" data-tab="'+b.tab+'" data-tip="'+b.tip+'"/>';s+=tx(b.x+b.w/2,322,b.l,'var(--g)',6,'middle',1);s+=tx(b.x+b.w/2,333,b.s1,'var(--t2)',4.5,'middle');s+='<circle cx="'+(b.x+b.w/2-15)+'" cy="347" r="3" fill="var(--g)"><animate attributeName="opacity" values="0.5;1;0.5" dur="2s" repeatCount="indefinite"/></circle>';s+=tx(b.x+b.w/2+2,350,b.st,'var(--g)',4.5,'middle',1)});
// === RIGHT PANEL: QUICK REFERENCE ===
s+='<rect x="630" y="40" width="320" height="315" rx="6" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".8"/>';
s+=tx(790,58,'QUICK REFERENCE','var(--t1)',7,'middle',1);
var qS=[{c:'var(--g)',t:'COMPUTE',r:[['Platform','GB200 NVL36\u00D72'],['Racks','27 NVL72 = 54 racks'],['GPU','1,944\u00D7 B200 Blackwell'],['CPU','972\u00D7 Grace72 V2'],['GPU TDP','1,000-1,200W'],['HBM3e','192GB/GPU = 373TB'],['FP4','1,400 ExaFLOPS']]},{c:'var(--o)',t:'POWER',r:[['IT Load','7,128 kW'],['Total','7,683 kW (PUE 1.08)'],['Per NVL72','132 kW pair'],['UPS','2\u00D74.5MW 10min'],['GenSet','4\u00D72.5MW <10s']]},{c:'var(--c)',t:'COOLING',r:[['DLC','85% = 6,060 kW'],['Air','15% = 1,070 kW'],['TCS','35/45\u00B0C sup/ret'],['CDU','22\u00D7 350kW EoR'],['Chiller','4\u00D72.5MW COP5.5']]},{c:'var(--b)',t:'NETWORK',r:[['NVLink5','130 TB/s/dom'],['IB XDR','800G Fat-Tree'],['OOB','25GbE + BMC']]}];
var qY=72;qS.forEach(function(qs){s+=tx(642,qY,qs.t,qs.c,6,0,1);qY+=12;qs.r.forEach(function(r){s+=tx(646,qY,r[0],'var(--t3)',4.5);s+=tx(940,qY,r[1],'var(--t2)',4.5,'end');qY+=10});qY+=5});
// === BOTTOM KPI BAR ===
s+='<rect x="10" y="365" width="940" height="50" rx="5" fill="rgba(34,197,94,.04)" stroke="rgba(34,197,94,.2)" stroke-width="1"/>';
var ovK=[{x:30,l:'PUE',id:'ovPue',v:'1.08',c:'var(--g)'},{x:120,l:'IT LOAD',id:'ovIt',v:'7,128 kW',c:'var(--o)'},{x:260,l:'GPUs',v:'1,944',c:'var(--g)'},{x:360,l:'NVL72',v:'27',c:'var(--pk)'},{x:440,l:'UPTIME',v:'99.999%',c:'var(--g)'},{x:560,l:'WUE',id:'ovWue',v:'0.42',c:'var(--c)'},{x:660,l:'TCS \u0394T',id:'ovDt',v:'9.6\u00B0C',c:'var(--c)'},{x:800,l:'ALARMS',id:'ovAlm',v:'0',c:'var(--g)'}];
ovK.forEach(function(k){s+=tx(k.x,380,k.l,'var(--t3)',5);s+='<text x="'+k.x+'" y="402" fill="'+k.c+'" font-family="'+J+'" font-size="12" font-weight="700" '+(k.id?'id="'+k.id+'"':'')+'>'+k.v+'</text>'});
// Legend
s+=tx(30,435,'Click any block to navigate to its detail tab \u2502 Hover for specifications','var(--t3)',5);
s+=tx(30,450,'Flow:','var(--t3)',5,0,1);
s+='<line x1="60" y1="447" x2="100" y2="447" stroke="var(--o)" stroke-width="2" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;-18" dur="1.5s" repeatCount="indefinite"/></line>';s+=tx(108,450,'Power','var(--o)',5);
s+='<line x1="145" y1="447" x2="185" y2="447" stroke="var(--c)" stroke-width="2" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;-18" dur="2s" repeatCount="indefinite"/></line>';s+=tx(193,450,'Cooling','var(--c)',5);
s+='<line x1="238" y1="447" x2="278" y2="447" stroke="var(--pk)" stroke-width="2" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;-18" dur="1.5s" repeatCount="indefinite"/></line>';s+=tx(286,450,'Data','var(--pk)',5);
el.innerHTML=s;
// Click handler
$('overSvg').addEventListener('click',function(e){var bl=e.target.closest('[data-tab]');if(!bl)return;var t=bl.getAttribute('data-tab');var btn=document.querySelector('.tabs button[data-t="'+t+'"]');if(btn)btn.click()});
// Live KPI
setInterval(function(){var p=$('ovPue');if(p)p.textContent=R(1.07,1.12);var i=$('ovIt');if(i)i.textContent=(7e3+RI(0,200)).toLocaleString()+' kW';var w=$('ovWue');if(w)w.textContent=R(.40,.45);var d=$('ovDt');if(d)d.textContent=R(9,10.5)+'\u00B0C';var a=$('ovAlm');if(a)a.textContent=RI(0,2)},3000)})();

(function(){const hc=$('hc');if(!hc)return;let s='';
const LX=32,RW=26,RH=18,GAP=3,CG=12,PR=RW*2+GAP,COLS=9,TW=COLS*(PR+CG)-CG;
const LH=6,SH=8,HAH=14,CLH=18,GV=2;
function rpY(b){return{la:b,rA:b+LH+2,sH:b+LH+2+RH+GV,hot:b+LH+2+RH+GV+SH+2,lB:b+LH+2+RH+GV+SH+2+HAH+2,rB:b+LH+2+RH+GV+SH+2+HAH+2+LH+2,cold:b+LH+2+RH+GV+SH+2+HAH+2+LH+2+RH+GV,sC:b+LH+2+RH+GV+SH+2+HAH+2+LH+2+RH+GV+CLH-SH-2}}
const RP=[{y:rpY(30),lA:'ROW A',lB:'ROW B',p:'1'},{y:rpY(126),lA:'ROW C',lB:'ROW D',p:'2'},{y:rpY(222),lA:'ROW E',lB:'ROW F',p:'3'}];
function rk(x,y,id){let r=`<g class="rg" filter="url(#gG)"><rect x="${x}" y="${y}" width="${RW}" height="${RH}" rx="2" fill="rgba(34,197,94,.18)" stroke="rgba(34,197,94,.5)" stroke-width=".6"/>`;for(let i=0;i<3;i++)r+=`<rect x="${x+2}" y="${y+2+i*3.5}" width="${RW-4}" height="2" rx=".3" fill="rgba(34,197,94,${.4-i*.07})"/>`;r+=`<circle cx="${x+RW-3}" cy="${y+RH-3}" r="1" fill="var(--g)" opacity=".8"/><text x="${x+RW/2}" y="${y+RH-1.5}" fill="var(--t3)" font-family="${J}" font-size="3" text-anchor="middle">${id}</text></g>`;return r}
// === OVERHEAD TCS PIPING (ceiling level, DN150 SS316L) — extends to CDU risers ===
const cduX0=LX+TW+20;
s+=`<line x1="${LX}" y1="26" x2="${cduX0+35}" y2="26" stroke="rgba(6,182,212,.2)" stroke-width="2" stroke-dasharray="10 5"><animate attributeName="stroke-dashoffset" values="0;-30" dur="2s" repeatCount="indefinite"/></line>`;
s+=`<line x1="${LX}" y1="29" x2="${cduX0+35}" y2="29" stroke="rgba(239,68,68,.15)" stroke-width="2" stroke-dasharray="10 5"><animate attributeName="stroke-dashoffset" values="0;30" dur="2s" repeatCount="indefinite"/></line>`;
s+=tx(LX+TW/2,22,'OVERHEAD TCS PIPING DN150 SS316L','rgba(6,182,212,.25)',4,'middle');
RP.forEach((rp,ri)=>{const Y=rp.y;
s+=tx(LX,Y.la+6,rp.lA+' \u2014 NVL36-L','var(--g)',6,0,1);
for(let c=0;c<COLS;c++){const x=LX+c*(PR+CG);s+=rk(x,Y.rA,rp.p+'.'+String(c+1).padStart(2,'0'));s+=rk(x+RW+GAP,Y.rA,rp.p+'.'+String(c+1).padStart(2,'0')+'b')}
for(let si=0;si<4;si++){const sx=LX+20+si*(TW/4),sy=Y.sH;s+=`<rect x="${sx}" y="${sy}" width="52" height="${SH}" rx="2" fill="rgba(239,68,68,.06)" stroke="rgba(239,68,68,.18)" stroke-width=".4"/>`+tx(sx+2,sy+3.5,'\u25C6 TTHT-H'+(ri+1)+'.'+(si+1),'var(--o)',3)+`<text x="${sx+16}" y="${sy+7}" fill="var(--r)" font-family="${J}" font-size="4" font-weight="600" id="H${ri}${si}t">--</text><text x="${sx+36}" y="${sy+7}" fill="var(--o)" font-family="${J}" font-size="4" font-weight="600" id="H${ri}${si}h">--</text>`}
s+=`<rect x="${LX}" y="${Y.hot}" width="${TW}" height="${HAH}" rx="3" fill="url(#hotG)" stroke="rgba(239,68,68,.15)" stroke-width=".6"/><rect x="${LX}" y="${Y.hot}" width="${TW}" height="${HAH}" rx="3" fill="rgba(245,158,11,.02)" class="sh"/>`;
s+=tx(LX+TW/2,Y.hot+7,'HOT AISLE CONTAINMENT 32-40\u00B0C','rgba(239,68,68,.2)',5,'middle');
for(let p=0;p<16;p++){const px=LX+6+p*(TW/16),dl=(p*.2)%2;s+=`<text x="${px}" y="${Y.hot+13}" fill="rgba(239,68,68,.18)" font-size="5" class="hp" style="animation-delay:${dl.toFixed(1)}s">\u25B2</text>`}
s+=tx(LX,Y.lB+6,rp.lB+' \u2014 NVL36-R','var(--g)',6,0,1);
for(let c=0;c<COLS;c++){const x=LX+c*(PR+CG);s+=rk(x,Y.rB,rp.p+'.'+String(c+10).padStart(2,'0'));s+=rk(x+RW+GAP,Y.rB,rp.p+'.'+String(c+10).padStart(2,'0')+'b')}
s+=`<rect x="${LX}" y="${Y.cold}" width="${TW}" height="${CLH}" rx="3" fill="rgba(6,182,212,.04)" stroke="rgba(6,182,212,.12)" stroke-width=".6"/>`;
s+=tx(LX+TW/2,Y.cold+7,'COLD AISLE 18\u00B0C \u2014 CRAH Supply','rgba(6,182,212,.2)',5,'middle');
for(let p=0;p<14;p++){const px=LX+5+p*(TW/14),dl=(p*.22)%2.2;
s+=`<text x="${px}" y="${Y.cold+15}" fill="rgba(6,182,212,.15)" font-size="4" class="cp" style="animation-delay:${dl}s">\u25BC</text>`;
}
for(let si=0;si<4;si++){const sx=LX+20+si*(TW/4),sy=Y.sC;s+=`<rect x="${sx}" y="${sy}" width="52" height="${SH}" rx="2" fill="rgba(6,182,212,.05)" stroke="rgba(6,182,212,.15)" stroke-width=".4"/>`+tx(sx+2,sy+3.5,'\u25C6 TTHT-C'+(ri+1)+'.'+(si+1),'var(--c)',3)+`<text x="${sx+16}" y="${sy+7}" fill="var(--g)" font-family="${J}" font-size="4" font-weight="600" id="C${ri}${si}t">--</text><text x="${sx+36}" y="${sy+7}" fill="var(--c)" font-family="${J}" font-size="4" font-weight="600" id="C${ri}${si}h">--</text>`}});
RP.forEach((rp,i)=>{const cy=rp.y.cold+CLH/2-11;
s+=`<g class="crah-unit" data-crah="CRAH-L${i+1}">`;s+=`<rect x="13" y="${cy}" width="14" height="22" rx="2" fill="rgba(6,182,212,.08)" stroke="var(--c)" stroke-width=".7" filter="url(#gC)"/>`;
s+=`<text x="20" y="${cy+13}" fill="var(--c)" font-family="${J}" font-size="3.5" text-anchor="middle" font-weight="600" transform="rotate(-90,20,${cy+11})">CRAH-L${i+1}</text>`;
for(let a=0;a<4;a++)s+=`<text x="${30+a*11}" y="${cy+13}" fill="rgba(6,182,212,.18)" font-size="5" class="wr" style="animation-delay:${a*.25}s">\u203A</text>`;
s+=`</g>`;
const rx=LX+TW+6;s+=`<g class="crah-unit" data-crah="CRAH-R${i+1}">`;s+=`<rect x="${rx}" y="${cy}" width="14" height="22" rx="2" fill="rgba(6,182,212,.08)" stroke="var(--c)" stroke-width=".7" filter="url(#gC)"/>`;
s+=`<text x="${rx+7}" y="${cy+13}" fill="var(--c)" font-family="${J}" font-size="3.5" text-anchor="middle" font-weight="600" transform="rotate(-90,${rx+7},${cy+11})">CRAH-R${i+1}</text>`;
for(let a=0;a<4;a++)s+=`<text x="${rx-5-a*11}" y="${cy+13}" fill="rgba(6,182,212,.18)" font-size="5" class="wl" style="animation-delay:${a*.25}s">\u2039</text>`;
s+=`</g>`});
const nwY=332;s+=tx(LX,nwY-4,'NETWORK / DWDM','var(--b)',5,0,1);['IB-Leaf','IB-Spine','ODF','DWDM','OOB','Storage'].forEach((l,i)=>{const x=LX+i*78;s+=`<g filter="url(#gB)"><rect x="${x}" y="${nwY}" width="62" height="22" rx="2" fill="rgba(59,130,246,.1)" stroke="rgba(59,130,246,.4)" stroke-width=".6"/>`+tx(x+31,nwY+9,l,'var(--b)',5,'middle',1)+tx(x+31,nwY+18,'N.0'+(i+1),'var(--t3)',3.5,'middle')+'</g>'});
s+=tx(LX+490,nwY-4,'PASSIVE','var(--t3)',5,0,1);['CblMgmt','PDU/Mtr','Patch','Spare'].forEach((l,i)=>{const x=LX+490+i*68;s+=`<rect x="${x}" y="${nwY}" width="55" height="22" rx="2" fill="rgba(107,114,128,.06)" stroke="rgba(107,114,128,.2)" stroke-width=".5"/>`+tx(x+27,nwY+9,l,'var(--t3)',4.5,'middle')+tx(x+27,nwY+18,'P.0'+(i+1),'var(--t3)',3.5,'middle')});
// CDUs at End-of-Row (2 per row-pair, right side) — clickable for HMI mimic
RP.forEach(function(rr,ri){const cY=rr.y.cold,cH=CLH;
const cduX=LX+TW+20,cduW=42,cduH=14;
for(let ci=0;ci<2;ci++){const cy=rr.y.rA+ci*(rr.y.rB-rr.y.rA);
const cduId=ri*2+ci+1;const cduLabel='CDU-'+String(cduId).padStart(2,'0');
// CDU box — clickable
s+=`<g class="cdu-click" data-cdu="${cduId}" style="cursor:pointer">`;
s+=`<rect x="${cduX}" y="${cy}" width="${cduW}" height="${cduH}" rx="3" fill="rgba(6,182,212,.15)" stroke="var(--c)" stroke-width=".8" filter="url(#gC)"/>`;
s+=tx(cduX+cduW/2,cy+6,cduLabel,'var(--c)',3.5,'middle',1);
// Status: Online indicator + DP + Flow
s+=`<circle cx="${cduX+5}" cy="${cy+11}" r="1.2" fill="var(--g)"><animate attributeName="opacity" values=".5;1;.5" dur="2s" repeatCount="indefinite"/></circle>`;
s+=tx(cduX+9,cy+12.5,'Online','var(--g)',2.5);
s+=`<text x="${cduX+cduW-2}" y="${cy+12.5}" fill="var(--c)" font-family="${J}" font-size="2.5" text-anchor="end" id="cduSt${cduId}">1.8bar 400L/m</text>`;
s+=`</g>`;
// Vertical riser from overhead TCS down to CDU (supply)
s+=`<line x1="${cduX+10}" y1="26" x2="${cduX+10}" y2="${cy}" stroke="rgba(6,182,212,.25)" stroke-width="1.5" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;-18" dur="1.5s" repeatCount="indefinite"/></line>`;
s+=`<line x1="${cduX+32}" y1="29" x2="${cduX+32}" y2="${cy+cduH}" stroke="rgba(239,68,68,.2)" stroke-width="1.5" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;18" dur="1.5s" repeatCount="indefinite"/></line>`;
s+=`<circle cx="${cduX+10}" cy="${cy}" r="2.5" fill="rgba(6,182,212,.4)" stroke="var(--c)" stroke-width=".4"><animate attributeName="r" values="1.5;3;1.5" dur="2s" repeatCount="indefinite"/></circle>`;
s+=`<circle cx="${cduX+32}" cy="${cy+cduH}" r="2.5" fill="rgba(239,68,68,.35)" stroke="var(--r)" stroke-width=".4"><animate attributeName="r" values="1.5;3;1.5" dur="2s" repeatCount="indefinite"/></circle>`;
s+=`<line x1="${cduX}" y1="${cy+5}" x2="${LX+TW}" y2="${cy+5}" stroke="rgba(6,182,212,.12)" stroke-width="1" stroke-dasharray="5 4"><animate attributeName="stroke-dashoffset" values="0;-18" dur="1.2s" repeatCount="indefinite"/></line>`;
s+=`<line x1="${cduX}" y1="${cy+9}" x2="${LX+TW}" y2="${cy+9}" stroke="rgba(239,68,68,.09)" stroke-width="1" stroke-dasharray="5 4"><animate attributeName="stroke-dashoffset" values="0;18" dur="1.2s" repeatCount="indefinite"/></line>`;
}
});
const pY=365;s+=tx(LX,pY,'CORRIDOR SERVICES','var(--t1)',5,0,1);
// Pipe rack frame
s+=`<rect x="${LX}" y="${pY+3}" width="${TW}" height="72" rx="2" fill="rgba(107,114,128,.01)" stroke="rgba(107,114,128,.06)" stroke-width=".3" stroke-dasharray="4 3"/>`;
s+=tx(LX+TW-2,pY+8,'PIPE RACK','var(--t3)',3,'end');
// === FWS SUPPLY DN250 CS (insulated double-line, green) ===
const sY=pY+12,ej1=LX+Math.round(TW/3),ej2=LX+Math.round(2*TW/3);
s+=`<rect x="${LX+8}" y="${sY-3.5}" width="${TW-16}" height="7" rx="3" fill="rgba(34,197,94,.025)" stroke="rgba(34,197,94,.1)" stroke-width=".4"/>`;
s+=fl(LX+8,sY,LX+TW-8,sY,'var(--g)','fR',.5,2);
s+=tx(LX+TW/2,sY-5.5,'FWS SUP DN250 CS 12\u00B0C 500m\u00B3/h  INSULATED','var(--g)',3.5,'middle');
// Butterfly valves (BV) at entry/exit — ISA diamond
s+=symValve(LX+15,sY,'var(--g)');s+=tx(LX+15,sY-5,'BV','var(--g)',2.5,'middle');
s+=symValve(LX+TW-15,sY,'var(--g)');s+=tx(LX+TW-15,sY-5,'BV','var(--g)',2.5,'middle');
// Expansion joints (EJ) — bellows zigzag at 1/3 and 2/3 span
[ej1,ej2].forEach(ex=>{s+=`<path d="M${ex-5} ${sY} L${ex-3} ${sY-3} L${ex-1} ${sY+3} L${ex+1} ${sY-3} L${ex+3} ${sY+3} L${ex+5} ${sY}" fill="none" stroke="var(--g)" stroke-width=".7"/>`});
// Flow direction arrows
for(let i=0;i<5;i++){const ax=LX+60+i*115;s+=`<polygon points="${ax},${sY-2} ${ax+4},${sY} ${ax},${sY+2}" fill="var(--g)" opacity=".5"/>`}
// T-branch stubs to CDU risers (3 per row pair, upward)
for(let i=0;i<3;i++){const brX=LX+Math.round(TW*(i+1)/4);s+=`<line x1="${brX}" y1="${sY-3.5}" x2="${brX}" y2="${sY-10}" stroke="rgba(34,197,94,.25)" stroke-width="1" stroke-dasharray="2 1.5"/><circle cx="${brX}" cy="${sY-10}" r="1.2" fill="rgba(34,197,94,.35)"/>`}
// === FWS RETURN DN250 CS (insulated double-line, orange) ===
const rY=pY+26;
s+=`<rect x="${LX+8}" y="${rY-3.5}" width="${TW-16}" height="7" rx="3" fill="rgba(245,158,11,.025)" stroke="rgba(245,158,11,.1)" stroke-width=".4"/>`;
s+=fl(LX+8,rY,LX+TW-8,rY,'var(--o)','fL',.5,2);
s+=tx(LX+TW/2,rY-5.5,'FWS RET DN250 CS 22\u00B0C  INSULATED','var(--o)',3.5,'middle');
s+=symValve(LX+15,rY,'var(--o)');s+=tx(LX+15,rY-5,'BV','var(--o)',2.5,'middle');
s+=symValve(LX+TW-15,rY,'var(--o)');s+=tx(LX+TW-15,rY-5,'BV','var(--o)',2.5,'middle');
[ej1,ej2].forEach(ex=>{s+=`<path d="M${ex-5} ${rY} L${ex-3} ${rY-3} L${ex-1} ${rY+3} L${ex+1} ${rY-3} L${ex+3} ${rY+3} L${ex+5} ${rY}" fill="none" stroke="var(--o)" stroke-width=".7"/>`});
for(let i=0;i<5;i++){const ax=LX+60+i*115;s+=`<polygon points="${ax},${rY-2} ${ax-4},${rY} ${ax},${rY+2}" fill="var(--o)" opacity=".5"/>`}
// === INSTRUMENTATION PANEL (PI/TI/FM, right side) ===
const ipX=LX+TW+8;
s+=`<rect x="${ipX}" y="${pY+4}" width="108" height="36" rx="3" fill="rgba(34,197,94,.015)" stroke="rgba(34,197,94,.08)" stroke-width=".4"/>`;
s+=tx(ipX+54,pY+10,'FWS INSTRUMENTS','var(--g)',3.5,'middle',1);
s+=symSensor(ipX+20,pY+24,'var(--g)','P');s+=`<text x="${ipX+20}" y="${pY+34}" fill="var(--g)" font-family="${J}" font-size="3" text-anchor="middle" id="fwsPI">2.1bar</text>`;
s+=symSensor(ipX+54,pY+24,'var(--g)','T');s+=`<text x="${ipX+54}" y="${pY+34}" fill="var(--g)" font-family="${J}" font-size="3" text-anchor="middle" id="fwsTI">12.0\u00B0C</text>`;
s+=symSensor(ipX+88,pY+24,'var(--g)','F');s+=`<text x="${ipX+88}" y="${pY+34}" fill="var(--g)" font-family="${J}" font-size="3" text-anchor="middle" id="fwsFM">500m\u00B3/h</text>`;
s+=fl(LX+TW-8,sY,ipX,sY,'rgba(34,197,94,.12)','','.3',1);
// === TCS NOTE (overhead) ===
s+=tx(LX+TW/2,pY+38,'TCS SUP/RET DN150 SS316L \u2192 OVERHEAD (see top)','rgba(6,182,212,.2)',3,'middle');
// === CONDENSATE DRAIN DN50 CPVC ===
const cdY=pY+45;
s+=fl(LX,cdY,LX+TW,cdY,'rgba(139,92,246,.3)','fR',.25,1.5);
s+=tx(LX+TW/2-40,cdY-3,'CONDENSATE DRAIN DN50 CPVC','var(--p)',3.5,'middle');
// Slope indicator (1:100 grade)
s+=`<path d="M${LX+TW/2+50} ${cdY-1.5} L${LX+TW/2+80} ${cdY}" stroke="var(--p)" stroke-width=".5" opacity=".5"/>`;
s+=tx(LX+TW/2+65,cdY-3,'1:100','var(--p)',2.5,'middle');
// Drain valve (DV)
s+=symValve(LX+TW-35,cdY,'var(--p)');s+=tx(LX+TW-35,cdY-5,'DV','var(--p)',2.5,'middle');
// Clean-out point (CO)
s+=`<circle cx="${LX+TW-12}" cy="${cdY}" r="2.5" fill="none" stroke="var(--p)" stroke-width=".5"/><line x1="${LX+TW-12}" y1="${cdY-2.5}" x2="${LX+TW-12}" y2="${cdY+2.5}" stroke="var(--p)" stroke-width=".4"/>`;
s+=tx(LX+TW-12,cdY-5,'CO','var(--p)',2.5,'middle');
// === LEAK DETECTION ROPE (24 ZONES) ===
const lrY=pY+54;
s+=`<line x1="${LX}" y1="${lrY}" x2="${LX+TW}" y2="${lrY}" stroke="rgba(245,158,11,.3)" stroke-width="1.2" stroke-dasharray="3 2"/>`;
s+=tx(LX+45,lrY-3,'LEAK DETECTION ROPE','var(--o)',3.5,'middle');
[1,4,8,12,16,20,24].forEach(z=>{const zx=LX+Math.round(z/24*TW);s+=`<line x1="${zx}" y1="${lrY-2.5}" x2="${zx}" y2="${lrY+2.5}" stroke="var(--o)" stroke-width=".6"/>`;s+=tx(zx,lrY+6,'Z'+z,'var(--o)',2.5,'middle')});
// === CABLE TRAY (3 separated sections) ===
const ctY=pY+65,ctW=Math.round((TW-12)/3);
s+=`<rect x="${LX}" y="${ctY}" width="${ctW}" height="7" rx="1.5" fill="rgba(245,158,11,.03)" stroke="rgba(245,158,11,.12)" stroke-width=".4"/>`;
s+=tx(LX+ctW/2,ctY+5,'PWR 300mm','var(--o)',3,'middle');
s+=`<rect x="${LX+ctW+6}" y="${ctY}" width="${ctW}" height="7" rx="1.5" fill="rgba(59,130,246,.03)" stroke="rgba(59,130,246,.12)" stroke-width=".4"/>`;
s+=tx(LX+ctW+6+ctW/2,ctY+5,'FIBER 450mm','var(--b)',3,'middle');
s+=`<rect x="${LX+2*(ctW+6)}" y="${ctY}" width="${ctW}" height="7" rx="1.5" fill="rgba(139,92,246,.03)" stroke="rgba(139,92,246,.12)" stroke-width=".4"/>`;
s+=tx(LX+2*(ctW+6)+ctW/2,ctY+5,'Cu 300mm','var(--p)',3,'middle');
s+=tx(LX+TW,ctY+5,'CABLE TRAY','var(--t3)',3,'end');
s+=bx(752,28,190,105,'rgba(245,158,11,.12)',4)+tx(847,39,'ELECTRICAL','var(--o)',6,'middle',1);['TX-A/B 5MVA','UPS-A/B 4.5MW','Busway 2\u00D74,000A','RPP 12\u00D7 630A','GenSet 4\u00D72.5MW','ATS-LV <100ms','Battery 10min'].forEach((l,i)=>s+=tx(847,50+i*9.5,l,'var(--t2)',4,'middle'));
s+=bx(752,140,190,55,'rgba(59,130,246,.12)',4)+tx(847,152,'NETWORK MDF','var(--b)',6,'middle',1);['IB Leaf\u00D78 Spine\u00D74','OOB 25G BMC 1G','DWDM ODF Patch'].forEach((l,i)=>s+=tx(847,163+i*10,l,'var(--t2)',4,'middle'));
s+=bx(752,202,90,42,'rgba(239,68,68,.12)',4)+tx(797,214,'FIRE','var(--r)',6,'middle',1)+tx(797,225,'Novec 1230','var(--t3)',4,'middle')+tx(797,238,'\u25CF NORMAL','var(--g)',4,'middle',1);
s+=bx(852,202,90,42,'rgba(34,197,94,.12)',4)+tx(897,214,'BMS','var(--g)',6,'middle',1)+tx(897,225,'DCIM','var(--t3)',4,'middle')+tx(897,238,'\u25CF ONLINE','var(--g)',4,'middle',1);
// ===== ACCESS CONTROL =====
s+=`<rect x="752" y="252" width="190" height="55" rx="4" fill="rgba(139,92,246,.03)" stroke="rgba(139,92,246,.2)" stroke-width=".8"/>`;
s+=tx(847,264,'ACCESS CONTROL','var(--p)',6,'middle',1);
s+=`<rect x="762" y="272" width="30" height="30" rx="2" fill="rgba(139,92,246,.08)" stroke="var(--p)" stroke-width=".6"/>`;
s+=`<rect x="769" y="277" width="16" height="18" rx="1" fill="rgba(139,92,246,.15)" stroke="var(--p)" stroke-width=".8"/>`;
s+=`<circle cx="780" cy="286" r="1.5" fill="var(--p)"/>`;
s+=tx(777,300,'MANTRAP','var(--t3)',3,'middle');
s+=`<rect x="800" y="272" width="70" height="14" rx="2" fill="var(--bg3)" stroke="var(--bd)" stroke-width=".4"/>`;
s+=tx(804,281,'Inside:','var(--t3)',4);
s+=`<text x="866" y="281" fill="var(--g)" font-family="${J}" font-size="5" text-anchor="end" font-weight="600" id="pplCount">3</text>`;
s+=`<rect x="800" y="290" width="70" height="14" rx="2" fill="var(--bg3)" stroke="var(--bd)" stroke-width=".4"/>`;
s+=tx(804,300,'Entry:','var(--t3)',4);
s+=`<text x="866" y="300" fill="var(--c)" font-family="${J}" font-size="4" text-anchor="end" id="lastEntry">12:34</text>`;
s+=`<circle cx="777" cy="272" r="2" fill="var(--g)" opacity=".5"><animate attributeName="opacity" values="0.2;0.8;0.2" dur="2s" repeatCount="indefinite"/></circle>`;
hc.innerHTML=s;
function upd(){for(let r=0;r<3;r++)for(let si=0;si<4;si++){const ht=$('H'+r+si+'t'),hh=$('H'+r+si+'h'),ct=$('C'+r+si+'t'),ch=$('C'+r+si+'h');if(ht)ht.textContent=R(32,40)+'\u00B0C';if(hh)hh.textContent=R(40,65)+'%';if(ct)ct.textContent=R(18,25)+'\u00B0C';if(ch)ch.textContent=R(45,70)+'%'}
$('kP').textContent=R(1.07,1.12);$('kG').textContent=RI(88,98);$('kD').textContent=R(9,10.5);$('kC').textContent=RI(80,92)+'%';$('kW').textContent=RI(980,1180);
const ts=parseFloat(R(34.5,35.8)),tr=parseFloat(R(44.2,45.5));$('sTS').textContent=ts+'\u00B0C';$('sTR').textContent=tr+'\u00B0C';$('sDT').textContent=(tr-ts).toFixed(1)+'\u00B0C';
$('sUA').textContent='Online '+RI(64,72)+'%';$('sUB').textContent='Online '+RI(63,71)+'%';
// People count update
const ppl=$('pplCount');if(ppl)ppl.textContent=RI(0,6);
const le=$('lastEntry');if(le){const now=new Date();le.textContent=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0')}
// Sidebar alarm status updates
const sbSmk=$('sbSmoke');if(sbSmk)sbSmk.textContent=RI(46,48)+' OK';
const sbHt=$('sbHeat');if(sbHt)sbHt.textContent='24 OK';
const sbVd=$('sbVesda');if(sbVd)sbVd.textContent='4 OK';
const sbRp=$('sbRope');if(sbRp)sbRp.textContent='24z OK';
const sbDis=$('sbDisabled');if(sbDis)sbDis.textContent=RI(0,2);
const sbMt=$('sbMaint');if(sbMt)sbMt.textContent=RI(1,4)+' sched';
// CDU status updates
for(let c=1;c<=6;c++){const el=$('cduSt'+c);if(el)el.textContent=R(1.5,2.5)+'bar '+RI(350,450)+'L/m'}
// FWS corridor instruments
const fPI=$('fwsPI');if(fPI)fPI.textContent=R(1.8,2.4)+'bar';
const fTI=$('fwsTI');if(fTI)fTI.textContent=R(11.5,12.5)+'\u00B0C';
const fFM=$('fwsFM');if(fFM)fFM.textContent=RI(480,520)+'m\u00B3/h';
}
upd();setInterval(upd,3000)})();


$('elecSu').textContent='20kV PLN \u2192 TX 2\u00D75MVA \u2192 LV 400V MSB \u2192 ATS-LV \u2190 GenSet 4\u00D72.5MW \u2192 UPS 2\u00D74.5MW Li-Ion \u2192 Busway 4,000A \u2192 RPP \u2192 Rack PSU 400V\u219250VDC \u2192 Bus Bar \u2192 VRM \u2192 GPU';
(function(){const el=$('elecC');if(!el)return;let s='';
const Y1=40,Y2=140,Y3=240,Y4=340,Y5=420; // vertical levels
// ===== FEED A (top) =====
// PLN 20kV Source A
s+=bx(5,10,65,40,'var(--o)');s+=tx(37,25,'PLN 20kV','var(--o)',7,'middle',1);s+=tx(37,40,'Source A','var(--t3)',5,'middle');
s+=fl(70,30,95,30,'var(--o)','fR',.6,1.5);s+=tx(80,25,'20kV','var(--t3)',4);
// Metering
s+=symMeter(95,30,'var(--o)','kW');s+=tx(95,40,'CT/VT','var(--t3)',3.5,'middle');
s+=fl(100,30,115,30,'var(--o)','','.5',1);
// VCB 20kV
s+=`<g data-tip="Vacuum Circuit Breaker: 20kV 25kA, provides MV switching/protection, SF6-free">`;s+=symCB(120,30,'var(--o)',true);s+=tx(120,22,'VCB','var(--t3)',3.5,'middle');s+='</g>';
s+=fl(125,30,140,30,'var(--o)','','.5',1);
// TX-A symbol
s+=`<g data-tip="Transformer TX-A: 5MVA cast-resin dry-type, 20kV\u2192400V, \u0394-Y11, impedance Zk=6%, Ik=62.5kA, ONAN/ONAF cooling">`;s+=symTX(155,27,'var(--o)');s+=tx(155,48,'TX-A 5MVA','var(--o)',5,'middle',1);s+=tx(155,56,'Dry \u0394Y-11','var(--t3)',4,'middle');
s+=tx(155,64,'20/0.4kV','var(--t3)',4,'middle');s+=tx(155,72,'Ik=62.5kA','var(--t3)',4,'middle');s+='</g>';
// ACB out
s+=fl(163,35,195,35,'var(--o)','fR',.5,1.5);s+=tx(175,31,'400V','var(--t3)',4);
s+=`<g data-tip="Air Circuit Breaker ACB-A: 5,000A rated, LV main incoming protection, selective coordination">`;s+=symCB(195,35,'var(--o)',true);s+=tx(195,25,'ACB-A','var(--t3)',3.5,'middle');s+=tx(195,45,'5000A','var(--t3)',3.5,'middle');s+='</g>';

// MSB-A Bus
s+=`<g data-tip="Main Switchboard A: 400V 5,000A copper bus, dual feed with bus tie, metering kW/kWh/PF/THD">`;s+=`<rect x="210" y="33" width="120" height="4" rx="1" fill="rgba(245,158,11,.15)" stroke="var(--o)" stroke-width=".6"/>`;
s+=tx(270,30,'MSB-A BUS 400V 5,000A','var(--o)',5,'middle',1);s+='</g>';
// Live values on bus
s+=`<text x="270" y="46" fill="var(--g)" font-family="${J}" font-size="4.5" text-anchor="middle" class="lv" id="eMSBa">398V | 3,420A | PF 0.98</text>`;

// ATS-LV (between MSB-A and GenSet)
// Bus-section tie from MSB-A
s+=fl(330,35,355,35,'var(--o)','fR',.5,1);
s+=`<g data-tip="Automatic Transfer Switch: &lt;100ms motorized transfer to GenSet on utility failure, LV side 400V">`;s+=bx(355,20,55,32,'var(--p)');s+=tx(382,33,'ATS-LV','var(--p)',6,'middle',1);s+=tx(382,46,'<100ms','var(--t3)',4,'middle');s+='</g>';
// GenSet feeds into ATS
s+=`<g data-tip="Generator Set A: 2\u00D72.5MW diesel, &lt;10s auto-start on LV bus undervoltage, 48hr base tank, auto-sync paralleling N+1">`;s+=bx(355,65,55,35,'var(--r)');s+=symGen(382,80,'var(--r)');s+=tx(382,98,'GenSet A','var(--t3)',4,'middle');s+=tx(382,106,'2\u00D72.5MW','var(--t3)',4,'middle');s+='</g>';
s+=fl(382,65,382,52,'var(--r)','','.4',1);s+=tx(388,60,'<10s','var(--t3)',3.5);
// ATS output
s+=fl(410,36,430,36,'var(--o)','fR',.5,1.5);

// UPS-A
s+=`<g data-tip="UPS-A: 4.5MW double-conversion online (VFI-SS-111), modular 6\u00D7750kW, Li-Ion NMC 10min runtime, THDi &lt;3%, \u03B7>96%">`;s+=symUPS(450,36,'var(--g)');s+=tx(450,52,'UPS-A','var(--g)',5,'middle',1);s+=tx(450,60,'4.5MW','var(--t3)',4,'middle');
s+=tx(450,68,'Li-Ion 10min','var(--t3)',4,'middle');s+='</g>';
// Battery symbol
s+=`<rect x="470" y="28" width="8" height="6" rx="1" fill="none" stroke="var(--g)" stroke-width=".5"/><rect x="474" y="30" width="3" height="2" rx=".5" fill="var(--g)" fill-opacity=".4"/>`;
s+=`<text x="478" y="28" fill="var(--g)" font-family="${J}" font-size="3.5" id="eBatA">SOC 98%</text>`;
s+=fl(462,36,490,36,'var(--g)','fR',.5,1.5);

// STS-A
s+=`<g data-tip="Static Transfer Switch: &lt;4ms break-before-make transfer between UPS A/B paths, thyristor-based, zero-downtime maintenance">`;s+=bx(490,26,30,20,'var(--p)');s+=tx(505,38,'STS','var(--p)',5,'middle');s+=tx(505,44,'<4ms','var(--t3)',3.5,'middle');s+='</g>';
s+=fl(520,36,535,36,'var(--o)','fR',.5,1.5);

// BUSWAY-A
s+=`<g data-tip="Busway-A: 4,000A copper overhead busduct, Feed A path, 6\u00D7 RPP tap-off (630A MCCB each) to rack pairs">`;
s+=`<rect x="535" y="32" width="180" height="8" rx="1.5" fill="rgba(245,158,11,.08)" stroke="var(--o)" stroke-width=".7"/>`;
s+=tx(625,30,'BUSWAY-A: 4,000A Cu OH Busduct \u2014 Feed A path','var(--o)',4.5,'middle',1);s+='</g>';
// Animated power flow
s+=fl(535,36,715,36,'var(--o)','fR',.25,4);
// Live
s+=`<text x="625" y="47" fill="var(--g)" font-family="${J}" font-size="4" text-anchor="middle" class="lv" id="eBwA">397V | 2,810A | 67%</text>`;

// RPP tap-offs from busway
for(let i=0;i<6;i++){const tx1=545+i*27;
s+=`<line x1="${tx1}" y1="40" x2="${tx1}" y2="54" stroke="var(--o)" stroke-width=".6"/>`;
s+=symCB(tx1,50,'var(--o)',true)}
s+=`<text x="625" y="60" fill="var(--t3)" font-family="${J}" font-size="4" text-anchor="middle" data-tip="Remote Power Panel: 630A MCCB, distributes busway power to individual racks via 200A flex conduit whip">RPP-A1\u2026A6 (630A MCCB Tap-off \u00D76)</text>`;

// ===== FEED B (mirror below) =====
const BY=110;
s+=bx(5,BY,65,40,'var(--o)');s+=tx(37,BY+15,'PLN 20kV','var(--o)',7,'middle',1);s+=tx(37,BY+30,'Source B','var(--t3)',5,'middle');
s+=fl(70,BY+20,95,BY+20,'var(--o)','fR',.6,1.5);
s+=symMeter(95,BY+20,'var(--o)','kW');
s+=fl(100,BY+20,115,BY+20,'var(--o)','','.5',1);
s+=`<g data-tip="Vacuum Circuit Breaker B: 20kV 25kA, MV switching/protection for Feed B">`;s+=symCB(120,BY+20,'var(--o)',true);s+=tx(120,BY+12,'VCB','var(--t3)',3.5,'middle');s+='</g>';
s+=fl(125,BY+20,140,BY+20,'var(--o)','','.5',1);
s+=`<g data-tip="Transformer TX-B: 5MVA cast-resin dry-type, 20kV\u2192400V, \u0394-Y11, Zk=6%, redundant Feed B path">`;s+=symTX(155,BY+17,'var(--o)');s+=tx(155,BY+38,'TX-B 5MVA','var(--o)',5,'middle',1);s+=tx(155,BY+46,'Dry \u0394Y-11','var(--t3)',4,'middle');s+='</g>';
s+=fl(163,BY+25,195,BY+25,'var(--o)','fR',.5,1.5);
s+=symCB(195,BY+25,'var(--o)',true);s+=tx(195,BY+15,'ACB-B','var(--t3)',3.5,'middle');
s+=`<rect x="210" y="${BY+23}" width="120" height="4" rx="1" fill="rgba(245,158,11,.15)" stroke="var(--o)" stroke-width=".6"/>`;
s+=tx(270,BY+20,'MSB-B BUS 400V 5,000A','var(--o)',5,'middle',1);
s+=`<text x="270" y="${BY+36}" fill="var(--g)" font-family="${J}" font-size="4.5" text-anchor="middle" class="lv" id="eMSBb">399V | 3,380A | PF 0.97</text>`;
s+=fl(330,BY+25,355,BY+25,'var(--o)','fR',.5,1);
s+=`<g data-tip="ATS-LV B: Automatic Transfer Switch, &lt;100ms motorized transfer to GenSet B on utility failure">`;s+=bx(355,BY+10,55,32,'var(--p)');s+=tx(382,BY+23,'ATS-LV','var(--p)',6,'middle',1);s+=tx(382,BY+36,'<100ms','var(--t3)',4,'middle');s+='</g>';
s+=`<g data-tip="Generator Set B: 2\u00D72.5MW diesel, &lt;10s auto-start, auto-sync paralleling, 48hr fuel">`;s+=bx(355,BY+55,55,35,'var(--r)');s+=symGen(382,BY+70,'var(--r)');s+=tx(382,BY+88,'GenSet B','var(--t3)',4,'middle');s+='</g>';
s+=fl(382,BY+55,382,BY+42,'var(--r)','','.4',1);
s+=fl(410,BY+26,430,BY+26,'var(--o)','fR',.5,1.5);
s+=`<g data-tip="UPS-B: 4.5MW double-conversion online, modular 6\u00D7750kW, Li-Ion NMC 10min, Feed B path">`;s+=symUPS(450,BY+26,'var(--g)');s+=tx(450,BY+42,'UPS-B','var(--g)',5,'middle',1);s+=tx(450,BY+50,'4.5MW','var(--t3)',4,'middle');s+='</g>';
s+=fl(462,BY+26,490,BY+26,'var(--g)','fR',.5,1.5);
s+=`<g data-tip="Static Transfer Switch B: &lt;4ms break-before-make between UPS paths">`;s+=bx(490,BY+16,30,20,'var(--p)');s+=tx(505,BY+28,'STS','var(--p)',5,'middle');s+='</g>';
s+=fl(520,BY+26,535,BY+26,'var(--o)','fR',.5,1.5);
s+=`<rect x="535" y="${BY+22}" width="180" height="8" rx="1.5" fill="rgba(245,158,11,.08)" stroke="var(--o)" stroke-width=".7"/>`;
s+=tx(625,BY+20,'BUSWAY-B: 4,000A Cu OH Busduct \u2014 Feed B path','var(--o)',4.5,'middle',1);
s+=fl(535,BY+26,715,BY+26,'var(--o)','fR',.25,4);
for(let i=0;i<6;i++){const tx1=545+i*27;s+=`<line x1="${tx1}" y1="${BY+30}" x2="${tx1}" y2="${BY+44}" stroke="var(--o)" stroke-width=".6"/>`;s+=symCB(tx1,BY+40,'var(--o)',true)}
s+=tx(625,BY+50,'RPP-B1\u2026B6 (630A MCCB Tap-off \u00D76)','var(--t3)',4,'middle');

// ===== BUS TIE BREAKERS =====
// MV Bus Tie (between VCB-A and VCB-B) - OPEN
s+=`<line x1="120" y1="40" x2="120" y2="${BY+10}" stroke="var(--p)" stroke-width="1" stroke-dasharray="4 3"/>`;
s+=symCB(120,75,'var(--p)',false);
s+=`<rect x="100" y="68" width="40" height="14" rx="2" fill="rgba(139,92,246,.08)" stroke="var(--p)" stroke-width=".5"/>`;
s+=tx(120,77,'MV TIE','var(--p)',4,'middle',1);
s+=tx(120,92,'OPEN','var(--o)',4,'middle');
// LV Bus Tie (between MSB-A and MSB-B) - OPEN
s+=`<line x1="270" y1="41" x2="270" y2="${BY+19}" stroke="var(--p)" stroke-width="1" stroke-dasharray="4 3"/>`;
s+=symCB(270,80,'var(--p)',false);
s+=`<rect x="245" y="73" width="50" height="14" rx="2" fill="rgba(139,92,246,.08)" stroke="var(--p)" stroke-width=".5"/>`;
s+=tx(270,82,'LV BUS TIE','var(--p)',4,'middle',1);
s+=tx(270,98,'OPEN','var(--o)',4,'middle');

// ===== DOWNSTREAM: RPP -> Rack -> 50VDC -> GPU =====
const DY=210;
// Converge A+B into rack
s+=fl(580,65,580,DY,'var(--o)','','.15',.5);s+=fl(580,BY+50,580,DY,'var(--o)','','.15',.5);
s+=bx(530,DY,100,25,'var(--b)');s+=tx(580,DY+10,'RACK PSU: 400V 3ph \u2192 50VDC','var(--b)',5,'middle',1);s+=tx(580,DY+20,'2\u00D7 shelf (A+B) N+1 hot-swap | \u03B7>97%','var(--t3)',4,'middle');
s+=fl(580,DY+25,580,DY+40,'var(--o)','','.4',.8);
s+=`<rect x="555" y="${DY+40}" width="50" height="10" rx="1.5" fill="rgba(245,158,11,.06)" stroke="var(--o)" stroke-width=".5"/>`;
s+=tx(580,DY+48,'50VDC BUS 4,000A Cu','var(--o)',4,'middle',1);
s+=fl(580,DY+50,580,DY+62,'var(--o)','','.4',.6);
// VRM + GPU
s+=bx(520,DY+62,120,22,'rgba(34,197,94,.08)');
s+=tx(580,DY+72,'VRM \u2192 GPU 1.0-1.2kW | CPU 250W | NVS 350W','var(--g)',4,'middle',1);
s+=tx(580,DY+82,'Per rack total: 66 kW | Per NVL72 pair: 132 kW','var(--t3)',4,'middle');

// SPD symbols
s+=tx(535,DY+96,'SPD: T1+T2 @ TX | T2 @ RPP | T3 @ Rack','var(--c)',4);
// Ground symbol
s+=tx(535,DY+106,'Ground: TN-S <1\u03A9 Cu mesh | Equipotential bonding','var(--c)',4);
s+=tx(535,DY+116,'Metering: kW/kWh/V/I/PF/THD per branch (Modbus TCP)','var(--c)',4);
s+=tx(535,DY+126,'Arc Flash: PPE Cat 2 @ LV | Cat 4 @ MV | NFPA 70E','var(--r)',4);

// RIGHT PANEL: Detailed specs with live values
s+=`<rect x="730" y="5" width="225" height="460" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
const eSpec=[
['var(--o)',8,'MEDIUM VOLTAGE (20kV)'],
['',0,'Source: PLN 20kV/50Hz dual feeder (150kV sub)'],
['',0,'VCB: 20kV 25kA SF6/vacuum circuit breaker'],
['',0,'CT/VT: 20kV 200/5A cl.0.5 + 20/0.1kV cl.0.5'],
['',0,'Protection: IDMT OC 50/51, E/F 50N/51N, U/V 27'],
['',0,'Bus-section: MV tie breaker (manual/auto)'],
['var(--o)',0,'TRANSFORMER (20/0.4kV)'],
['',0,'Rating: 2\u00D7 5,000 kVA (A+B paths)'],
['',0,'Type: Cast-resin dry \u0394Y-11 ONAN/ONAF'],
['',0,'Impedance: Zk=6% | Ik=62.5kA at 400V'],
['',0,'Cooling: AN/AF (forced air at 80% load)'],
['',0,'Tap: \u00B12.5% \u00D72 OCTC (off-circuit)'],
['var(--g)',0,'LV SWITCHBOARD (400V)'],
['',0,'MSB: 400V 5,000A rated | ACB incoming 5,000A'],
['',0,'Bus-section: ACB tie (normally open)'],
['',0,'ATS-LV: Motorized <100ms transfer (LV side)'],
['',0,'GenSet: 4\u00D72.5MW diesel N+1 <10s auto-start'],
['',0,'GenSet fuel: 48hr base tank + day tank auto-fill'],
['',0,'Sync: Auto-sync paralleling for load share'],
['var(--g)',0,'UPS SYSTEM'],
['',0,'Rating: 2\u00D7 4,500 kW double-conversion online'],
['',0,'Topology: Modular (6\u00D7750kW per frame)'],
['',0,'Battery: Li-Ion NMC 10min @ full IT load'],
['',0,'THDi: <3% | THDv: <1% | \u03B7 >96% (>99% eco)'],
['',0,'STS: Static Transfer <4ms break-before-make'],
['var(--o)',0,'DISTRIBUTION'],
['',0,'Busway: 2\u00D74,000A Cu overhead busduct'],
['',0,'RPP: 12\u00D7 (6A+6B) 630A MCCB tap-off box'],
['',0,'Whip: 200A 400V flex conduit to rack'],
['',0,'Rack PSU: 400V AC \u2192 50VDC rectifier \u03B7>97%'],
['',0,'Bus bar: 50VDC 4,000A Cu vertical in-rack'],
['',0,'Fusing: Semiconductor fuse per tray tap'],
['var(--r)',0,'PROTECTION & COMPLIANCE'],
['',0,'OC: Selective time-graded per IEC 60947/61439'],
['',0,'SPD: T1+2 MOV+GDT at TX | T2 at RPP | T3 rack'],
['',0,'Ground: TN-S <1\u03A9 Cu bus + equipotential grid'],
['',0,'Arc flash: PPE Cat 2 LV | Cat 4 MV | NFPA 70E'],
['',0,'Metering: Schneider PM5xxx per branch Modbus TCP'],
['',0,'SCADA: IEC 61850 / Modbus TCP \u2192 BMS/DCIM'],
['',0,'Standard: SNI 0225 (PUIL) / IEC 60364 / Permenaker'],
['',0,'IUPTLS: Annual generation permit reporting'],
];
let ey=18;
eSpec.forEach(l=>{
if(l[0]){s+=tx(742,ey,l[2],l[0],6.5,0,1);ey+=12}
else{s+=tx(742,ey,l[2],'var(--t2)',5);ey+=10}});

// Live values update targets
s+=`<text x="742" y="${ey+5}" fill="var(--g)" font-family="${J}" font-size="5.5" font-weight="600" class="lv" id="eLive">TX-A: 397V 3,420A PF0.98 | TX-B: 399V 3,380A PF0.97</text>`;

el.innerHTML=s;
// Live electrical updates
setInterval(()=>{
$('eMSBa').textContent=RI(396,400)+'V | '+RI(3350,3500)+'A | PF '+R(.96,.99);
$('eMSBb').textContent=RI(396,400)+'V | '+RI(3300,3450)+'A | PF '+R(.96,.99);
$('eBwA').textContent=RI(396,400)+'V | '+RI(2750,2900)+'A | '+RI(64,72)+'%';
$('eBatA').textContent='SOC '+RI(95,100)+'%';
$('eLive').textContent='TX-A: '+RI(396,400)+'V '+RI(3350,3500)+'A | TX-B: '+RI(397,400)+'V '+RI(3300,3450)+'A';
},4000)})();


$('coolSu').textContent='Comprehensive P&ID: Cooling Tower → Chiller Plant → Overhead TCS Header → End-of-Row CDU → Rack Cold Plates | All flows, temps, pressures shown';
(function(){const el=$('coolC');if(!el)return;let s='';
// Background
s+=`<rect width="960" height="560" fill="var(--bg2)"/>`;
s+=`<pattern id="coolGrid" width="15" height="15" patternUnits="userSpaceOnUse"><path d="M15 0L0 0 0 15" fill="none" stroke="rgba(255,255,255,.015)" stroke-width=".2"/></pattern>`;
s+=`<rect width="960" height="560" fill="url(#coolGrid)"/>`;
s+=tx(480,16,'COOLING & PIPING P&ID — DLC 85% (6,060 kW) + AIR 15% (1,070 kW) = 7,130 kW TOTAL','var(--t3)',8,'middle',1);
// ===== OUTDOOR / COOLING TOWER SECTION =====
s+=`<rect x="10" y="28" width="180" height="165" rx="4" fill="rgba(139,92,246,.03)" stroke="rgba(139,92,246,.2)" stroke-width="1"/>`;
s+=tx(100,42,'COOLING TOWER','var(--p)',7,'middle',1);
// CT cells
for(let i=0;i<3;i++){
const cx=35+i*55,cy=85;
s+=`<g class="ct-click" data-ct="${i+1}" style="cursor:pointer" data-tip="Cooling Tower Cell CT-${i+1}: Induced draft, VFD fan, wet-bulb design 28\u00B0C, N+1 redundancy, CW 28\u219235\u00B0C. Click for HMI.">`;
s+=`<rect x="${cx-20}" y="${cy-25}" width="40" height="50" rx="3" fill="rgba(139,92,246,.1)" stroke="var(--p)" stroke-width=".6"/>`;
s+=`<polygon points="${cx-12},${cy-20} ${cx},${cy-28} ${cx+12},${cy-20}" fill="none" stroke="var(--p)" stroke-width=".5"/>`;
s+=tx(cx,cy-8,'CT-'+(i+1),'var(--p)',5,'middle',1);
// Fan symbol
s+=`<circle cx="${cx}" cy="${cy+5}" r="8" fill="none" stroke="var(--p)" stroke-width=".5"/>`;
s+=`<line x1="${cx-5}" y1="${cy+5}" x2="${cx+5}" y2="${cy+5}" stroke="var(--p)" stroke-width=".5"/>`;
s+=`<line x1="${cx}" y1="${cy}" x2="${cx}" y2="${cy+10}" stroke="var(--p)" stroke-width=".5"/>`;
s+=`<g data-tip="Variable Frequency Drive - Controls fan speed to optimize cooling efficiency based on ambient temperature. Reduces energy 20-40% vs fixed speed."><text x="${cx}" y="${cy+22}" fill="var(--t3)" font-family="${J}" font-size="4" text-anchor="middle">VFD</text></g>`;
s+='</g>'}
s+=tx(100,130,'Induced Draft | N+1','var(--t2)',5,'middle');
// CT parameters
s+=`<rect x="20" y="140" width="160" height="45" rx="2" fill="var(--bg3)" stroke="var(--bd)" stroke-width=".4"/>`;
s+=tx(30,153,'WB Design','var(--t3)',4.5);s+=`<text x="170" y="153" fill="var(--c)" font-family="${J}" font-size="6" text-anchor="end" id="ctWB">28°C</text>`;
s+=tx(30,165,'CW In','var(--t3)',4.5);s+=`<text x="170" y="165" fill="var(--r)" font-family="${J}" font-size="6" text-anchor="end" id="ctIn">35.2°C</text>`;
s+=tx(30,177,'CW Out','var(--t3)',4.5);s+=`<text x="170" y="177" fill="var(--c)" font-family="${J}" font-size="6" text-anchor="end" id="ctOut">28.1°C</text>`;
// Flow from CT
s+=`<line x1="190" y1="85" x2="195" y2="85" stroke="var(--c)" stroke-width="2.5" class="fR"/>`;
s+=tx(192,78,'600','var(--c)',3.5,'middle');
s+=tx(192,83,'m\u00B3/h','var(--t3)',2.5,'middle');
// ===== CW PUMP STATION =====
s+=`<g class="cw-pump-click" style="cursor:pointer">`;
s+=`<rect x="195" y="28" width="100" height="165" rx="4" fill="rgba(6,182,212,.04)" stroke="rgba(6,182,212,.35)" stroke-width="1"/>`;
s+=tx(245,42,'CW PUMP STATION','var(--c)',6,'middle',1);
s+=tx(245,52,'Condenser Water','var(--t3)',4,'middle');
// 3 individual pumps (P1 run, P2 run, P3 standby)
var cwPumps=[{id:'P1',st:'RUN',y:62},{id:'P2',st:'RUN',y:98},{id:'P3',st:'STBY',y:134}];
cwPumps.forEach(function(p){
var pc=p.st==='RUN'?'var(--c)':'var(--t3)';
var bg=p.st==='RUN'?'rgba(6,182,212,.08)':'rgba(107,114,128,.04)';
s+=`<rect x="200" y="${p.y}" width="90" height="30" rx="2" fill="${bg}" stroke="${pc}" stroke-width=".5"/>`;
// Motor circle
s+=`<circle cx="215" cy="${p.y+15}" r="8" fill="none" stroke="${pc}" stroke-width=".8"/>`;
if(p.st==='RUN'){
s+=`<g><animateTransform attributeName="transform" type="rotate" from="0 215 ${p.y+15}" to="360 215 ${p.y+15}" dur="2s" repeatCount="indefinite"/>`;
s+=`<polygon points="210,${p.y+11} 220,${p.y+15} 210,${p.y+19}" fill="${pc}" fill-opacity=".4"/>`;
s+=`</g>`;
}else{
s+=`<text x="215" y="${p.y+18}" fill="${pc}" font-family="${J}" font-size="5" text-anchor="middle">M</text>`;
}
// Pump ID + status
s+=`<text x="232" y="${p.y+10}" fill="${pc}" font-family="${J}" font-size="5" font-weight="600">${p.id}</text>`;
s+=`<circle cx="245" cy="${p.y+7}" r="2" fill="${p.st==='RUN'?'var(--g)':'var(--o)'}" opacity=".8"/>`;
s+=`<text x="250" y="${p.y+10}" fill="${p.st==='RUN'?'var(--g)':'var(--o)'}" font-family="${J}" font-size="3.5">${p.st}</text>`;
// VFD + Amps
if(p.st==='RUN'){
s+=`<text x="232" y="${p.y+20}" fill="var(--c)" font-family="${J}" font-size="4">${RI(72,85)}%</text>`;
s+=`<text x="260" y="${p.y+20}" fill="var(--t3)" font-family="${J}" font-size="3.5">${RI(85,105)}A</text>`;
}
// Discharge pressure
s+=`<text x="232" y="${p.y+28}" fill="var(--t3)" font-family="${J}" font-size="3.5">${p.st==='RUN'?R(4.2,4.8)+' bar':'--'}</text>`;
// Check valve symbol (triangle)
s+=`<polygon points="278,${p.y+12} 285,${p.y+15} 278,${p.y+18}" fill="none" stroke="${pc}" stroke-width=".5"/>`;
s+=`<line x1="285" y1="${p.y+11}" x2="285" y2="${p.y+19}" stroke="${pc}" stroke-width=".5"/>`;
});
// Suction header
s+=`<line x1="200" y1="77" x2="200" y2="149" stroke="var(--c)" stroke-width="1.5" opacity=".4"/>`;
s+=tx(197,172,'DN300','var(--t3)',3,'end');
// Discharge header
s+=`<line x1="290" y1="77" x2="290" y2="149" stroke="var(--c)" stroke-width="1.5" opacity=".4"/>`;
// Pressure gauge symbol at discharge
s+=symSensor(290,170,'var(--o)','P');
s+=tx(290,180,'4.5 bar','var(--c)',3.5,'middle');
// Flow meter at discharge
s+=symSensor(270,170,'var(--c)','F');
s+=tx(270,180,'600','var(--c)',3.5,'middle');
s+=`</g>`;
// Flow to chillers
s+=`<line x1="295" y1="95" x2="305" y2="95" stroke="var(--c)" stroke-width="2.5" class="fR"/>`;
s+=tx(300,88,'4.5 bar','var(--c)',3.5,'middle');
// ===== CHILLER PLANT =====
s+=`<rect x="305" y="28" width="215" height="165" rx="4" fill="rgba(34,197,94,.03)" stroke="rgba(34,197,94,.2)" stroke-width="1"/>`;
s+=tx(412,42,'CHILLER PLANT — 4× 2.5MW (N+1)','var(--g)',7,'middle',1);
// Chillers - positioned to fit within box (305 to 520)
const chillers=[{x:315,id:'CH-1',st:'RUN'},{x:360,id:'CH-2',st:'RUN'},{x:405,id:'CH-3',st:'RUN'},{x:450,id:'CH-4',st:'STBY'}];
chillers.forEach((ch,i)=>{
const stC=ch.st==='RUN'?'var(--g)':'var(--o)';
s+=`<g class="ch-click" data-ch="${i+1}" data-st="${ch.st}" style="cursor:pointer" data-tip="Chiller ${ch.id}: Centrifugal water-cooled, 2.5MW, COP 5.5 AHRI / IPLV 7.2, R-1234ze(E) low-GWP, evap 12\u00B0C LWT, ${ch.st==='RUN'?'currently running':'standby N+1'}. Click for HMI.">`;
s+=`<rect x="${ch.x}" y="52" width="40" height="62" rx="3" fill="rgba(34,197,94,.08)" stroke="${stC}" stroke-width=".7"/>`;
s+=symHX(ch.x+20,72,'var(--c)');
s+=tx(ch.x+20,94,ch.id,stC,5,'middle',1);
s+=`<rect x="${ch.x+4}" y="102" width="32" height="10" rx="1.5" fill="rgba(34,197,94,.15)" stroke="${stC}" stroke-width=".3"/>`;
s+=tx(ch.x+20,109,ch.st,stC,4,'middle');
s+='</g>'});
// Chiller parameters
s+=`<rect x="315" y="118" width="195" height="68" rx="2" fill="var(--bg3)" stroke="var(--bd)" stroke-width=".4"/>`;
const chParams=[
['Evap LWT','var(--c)','12.1°C','chEvapL','Evaporator Leaving Water Temperature - Chilled water supply to FWS loop. Target 12°C for optimal cooling efficiency.'],
['Evap EWT','var(--o)','22.0°C','chEvapE','Evaporator Entering Water Temperature - Return water from FWS loop. ΔT ~10°C indicates proper heat load.'],
['Cond ECW','var(--c)','28.1°C','chCondE','Condenser Entering Water Temperature - Cooling tower water supply. Lower = better COP.'],
['Cond LCW','var(--r)','35.2°C','chCondL','Condenser Leaving Water Temperature - Water returning to cooling tower. Carries rejected heat.'],
['COP','var(--g)','5.52','chCOP','Coefficient of Performance - Cooling output ÷ electrical input. Higher = more efficient. Rated 5.5, IPLV 7.2.'],
['Load','var(--o)','78%','chLoad','Current chiller load percentage. Optimal efficiency at 60-80% load. Staging adds/removes chillers.']
];
chParams.forEach((p,i)=>{
const px=325+(i%3)*65,py=134+Math.floor(i/3)*20;
s+=`<g data-tip="${p[4]}"><text x="${px}" y="${py}" fill="var(--t3)" font-family="${J}" font-size="4.5">${p[0]}</text></g>`;
s+=`<text x="${px+55}" y="${py}" fill="${p[1]}" font-family="${J}" font-size="5.5" text-anchor="end" font-weight="600" id="${p[3]}">${p[2]}</text>`;
});
// Flow from chillers
s+=`<line x1="520" y1="85" x2="525" y2="85" stroke="var(--g)" stroke-width="2.5" class="fR"/>`;
s+=tx(522,78,'FWS 12\u00B0C','var(--g)',3.5,'middle');
// ===== FWS PUMP STATION =====
s+=`<g class="fws-pump-click" style="cursor:pointer">`;
s+=`<rect x="525" y="28" width="120" height="165" rx="4" fill="rgba(34,197,94,.04)" stroke="rgba(34,197,94,.35)" stroke-width="1"/>`;
s+=tx(585,42,'FWS PUMP STATION','var(--g)',6,'middle',1);
s+=tx(585,52,'Facility Water (30% PG)','var(--t3)',4,'middle');
// 3 individual pumps
var fwsPumps=[{id:'P1',st:'RUN',y:60},{id:'P2',st:'RUN',y:92},{id:'P3',st:'STBY',y:124}];
fwsPumps.forEach(function(p){
var pc=p.st==='RUN'?'var(--g)':'var(--t3)';
var bg=p.st==='RUN'?'rgba(34,197,94,.08)':'rgba(107,114,128,.04)';
s+=`<rect x="530" y="${p.y}" width="70" height="28" rx="2" fill="${bg}" stroke="${pc}" stroke-width=".5"/>`;
// Motor
s+=`<circle cx="543" cy="${p.y+14}" r="7" fill="none" stroke="${pc}" stroke-width=".7"/>`;
if(p.st==='RUN'){
s+=`<g><animateTransform attributeName="transform" type="rotate" from="0 543 ${p.y+14}" to="360 543 ${p.y+14}" dur="2.2s" repeatCount="indefinite"/>`;
s+=`<polygon points="539,${p.y+10} 547,${p.y+14} 539,${p.y+18}" fill="${pc}" fill-opacity=".4"/>`;
s+=`</g>`;
}else{
s+=`<text x="543" y="${p.y+17}" fill="${pc}" font-family="${J}" font-size="5" text-anchor="middle">M</text>`;
}
s+=`<text x="557" y="${p.y+10}" fill="${pc}" font-family="${J}" font-size="4.5" font-weight="600">${p.id}</text>`;
s+=`<circle cx="570" cy="${p.y+7}" r="1.8" fill="${p.st==='RUN'?'var(--g)':'var(--o)'}" opacity=".8"/>`;
s+=`<text x="574" y="${p.y+10}" fill="${p.st==='RUN'?'var(--g)':'var(--o)'}" font-family="${J}" font-size="3">${p.st}</text>`;
if(p.st==='RUN'){
s+=`<text x="557" y="${p.y+19}" fill="var(--g)" font-family="${J}" font-size="3.5">${RI(72,88)}%</text>`;
s+=`<text x="578" y="${p.y+19}" fill="var(--t3)" font-family="${J}" font-size="3">${RI(60,80)}A</text>`;
}
s+=`<text x="557" y="${p.y+26}" fill="var(--t3)" font-family="${J}" font-size="3">${p.st==='RUN'?R(5.5,6.2)+' bar':'--'}</text>`;
// Check valve
s+=`<polygon points="592,${p.y+11} 597,${p.y+14} 592,${p.y+17}" fill="none" stroke="${pc}" stroke-width=".4"/>`;
s+=`<line x1="597" y1="${p.y+10}" x2="597" y2="${p.y+18}" stroke="${pc}" stroke-width=".4"/>`;
});
// Suction header
s+=`<line x1="530" y1="74" x2="530" y2="138" stroke="var(--g)" stroke-width="1.2" opacity=".4"/>`;
// Discharge header
s+=`<line x1="600" y1="74" x2="600" y2="138" stroke="var(--g)" stroke-width="1.2" opacity=".4"/>`;
// Ancillaries below pumps
// BFV valve
s+=symValve(610,155,'var(--g)');
s+=tx(610,165,'BFV','var(--t3)',3,'middle');
// Strainer
s+=`<rect x="622" y="150" width="18" height="12" rx="1" fill="rgba(107,114,128,.06)" stroke="var(--t3)" stroke-width=".4"/>`;
s+=tx(631,158,'Y','var(--t3)',4,'middle');
s+=tx(631,165,'Str','var(--t3)',3,'middle');
// Flow meter + pressure
s+=symSensor(610,178,'var(--c)','F');
s+=`<text x="618" y="182" fill="var(--g)" font-family="${J}" font-size="4" id="fwsFlow">${RI(475,510)}</text>`;
s+=tx(636,182,'m\u00B3/h','var(--t3)',3);
s+=symSensor(584,178,'var(--o)','P');
s+=tx(584,188,'6 bar','var(--g)',3,'middle');
// Expansion tank indicator
s+=`<rect x="530" y="155" width="28" height="22" rx="2" fill="rgba(139,92,246,.06)" stroke="var(--p)" stroke-width=".4"/>`;
s+=tx(544,164,'EXP','var(--p)',3.5,'middle');
s+=tx(544,173,RI(78,88)+'%','var(--p)',4,'middle');
s+=`</g>`;
// Flow to CDUs
s+=`<line x1="645" y1="88" x2="655" y2="88" stroke="var(--g)" stroke-width="2.5" class="fR"/>`;
s+=tx(650,81,'6 bar','var(--g)',3.5,'middle');
// ===== CDU SECTION =====
s+=`<rect x="650" y="28" width="150" height="165" rx="4" fill="rgba(6,182,212,.03)" stroke="rgba(6,182,212,.2)" stroke-width="1" data-tip="CDU Array: 24 units (N+1), 350kW rated / ~265kW actual per CDU. SS316L plate counter-flow HX. Primary: FWS 12\u219222\u00B0C (30% PG glycol). Secondary: TCS 35\u219245\u00B0C (DI water <5\u00B5S). Flow: ~400 L/min TCS per unit. Click any CDU cell for HMI."/>`;
s+=tx(725,42,'CDU ARRAY \u2014 24\u00D7 (N+1)','var(--c)',6,'middle',1);
// CDU grid (8×3) - compact layout to fit within box — clickable for HMI
for(let r=0;r<3;r++){
for(let c=0;c<8;c++){
const cx=655+c*18,cy=52+r*24;
const idx=r*8+c;
const active=idx<24;
if(active){
s+=`<g class="cdu-click" data-cdu="${idx+1}" style="cursor:pointer">`;
s+=`<rect x="${cx}" y="${cy}" width="15" height="18" rx="1.5" fill="rgba(6,182,212,.12)" stroke="var(--c)" stroke-width=".4"/>`;
s+=tx(cx+7.5,cy+12,String(idx+1).padStart(2,'0'),'var(--c)',3.5,'middle');
s+=`</g>`;
}else{
s+=`<rect x="${cx}" y="${cy}" width="15" height="18" rx="1.5" fill="rgba(6,182,212,.03)" stroke="var(--t3)" stroke-width=".4"/>`;
}
}
}
// CDU parameters - at bottom of CDU box
s+=`<rect x="655" y="130" width="140" height="58" rx="2" fill="var(--bg3)" stroke="var(--bd)" stroke-width=".4"/>`;
s+=`<g data-tip="FWS In/Out (T-FWS-01/02): 30% PG glycol. Supply 12\u00B0C from chiller, return 22\u00B0C. Pt100 RTD, range 0-50\u00B0C, alarm HH 25\u00B0C / LL 8\u00B0C."><text x="660" y="143" fill="var(--t3)" font-family="${J}" font-size="4">FWS In/Out</text></g>`;s+=`<text x="790" y="143" fill="var(--c)" font-family="${J}" font-size="5" text-anchor="end" id="cduFWS">12→22°C</text>`;
s+=`<g data-tip="TCS Supply (T-TCS-01): DI water to GPU cold plates. SP 35\u00B0C \u00B12\u00B0C. Pt100 RTD, range 0-60\u00B0C, alarm HH 40\u00B0C. ~400 L/min per CDU."><text x="660" y="157" fill="var(--t3)" font-family="${J}" font-size="4">TCS Supply</text></g>`;s+=`<text x="790" y="157" fill="var(--c)" font-family="${J}" font-size="5" text-anchor="end" id="cduTCSo">35.1°C</text>`;
s+=`<g data-tip="TCS Return (T-TCS-02): From GPU/CPU cold plates. Max 45\u00B0C. Pt100 RTD, range 0-60\u00B0C, alarm HH 48\u00B0C. \u0394T ~10\u00B0C nominal."><text x="660" y="171" fill="var(--t3)" font-family="${J}" font-size="4">TCS Return</text></g>`;s+=`<text x="790" y="171" fill="var(--o)" font-family="${J}" font-size="5" text-anchor="end" id="cduTCSi">44.8°C</text>`;
s+=tx(725,185,'350kW ea | N+1 redundancy','var(--t3)',4,'middle');
// Flow to TCS
s+=`<line x1="800" y1="88" x2="825" y2="88" stroke="var(--c)" stroke-width="2" class="fR"/>`;
s+=tx(812,81,'4 bar','var(--c)',4,'middle');
// ===== TCS TO RACKS =====
s+=`<g class="tcs-click" style="cursor:pointer">`;
s+=`<rect x="825" y="28" width="125" height="165" rx="4" fill="rgba(236,72,153,.03)" stroke="rgba(236,72,153,.2)" stroke-width="1"/>`;
s+=`<g data-tip="TCS to Rack Cold Plates: DI water <5\u00B5S/cm pH 7-9 via DN150 SS316L manifold. 72 Cu microchannel cold plates per rack, 80 LPM each. Click for detail."><text x="887" y="42" fill="var(--pk)" font-family="${J}" font-size="6" text-anchor="middle" font-weight="600">TCS\u2192RACKS</text></g>`;
// Manifold & rack branches
s+=tx(855,70,'SUP','var(--c)',4);
s+=tx(855,145,'DN150','var(--t3)',4);
// Rack branches
for(let i=0;i<6;i++){
const ry=70+i*13;
s+=`<line x1="850" y1="${ry}" x2="890" y2="${ry}" stroke="var(--c)" stroke-width="1" class="fR"/>`;
s+=`<rect x="890" y="${ry-5}" width="25" height="10" rx="2" fill="rgba(34,197,94,.1)" stroke="var(--g)" stroke-width=".4"/>`;
s+=tx(902,ry+2,'R'+(i+1),'var(--g)',4,'middle');
// Return
s+=`<line x1="915" y1="${ry}" x2="925" y2="${ry}" stroke="var(--o)" stroke-width=".8" class="fL"/>`;
}
s+=`<line x1="925" y1="60" x2="925" y2="150" stroke="var(--o)" stroke-width="2" stroke-dasharray="8 4"><animate attributeName="stroke-dashoffset" values="0;24" dur="1s" repeatCount="indefinite"/></line>`;
s+=tx(930,70,'RET','var(--o)',4);
// Animated supply manifold
s+=`<line x1="850" y1="60" x2="850" y2="150" stroke="var(--c)" stroke-width="3" stroke-dasharray="10 5"><animate attributeName="stroke-dashoffset" values="0;-30" dur="1s" repeatCount="indefinite"/></line>`;
// Cold plate detail
s+=`<rect x="835" y="158" width="105" height="30" rx="2" fill="var(--bg3)" stroke="var(--bd)" stroke-width=".4"/>`;
s+=tx(845,170,'ΔT Rack','var(--t3)',4);s+=`<text x="930" y="170" fill="var(--c)" font-family="${J}" font-size="6" text-anchor="end" id="rackDT">9.7°C</text>`;
s+=tx(845,182,'72 plates/rack','var(--t3)',4);s+=tx(930,182,'80 LPM','var(--c)',4,'end');
s+=`</g>`; // close tcs-click
// ===== RETURN FLOW LINES (bottom of P&ID upper section) =====
// TCS Return: Racks → CDU array
s+=`<line x1="925" y1="155" x2="800" y2="155" stroke="var(--o)" stroke-width="2" class="fL"/>`;
s+=tx(860,165,'TCS Return 45\u00B0C','var(--o)',4,'middle');
// FWS Return: CDU → FWS Pump Station → Chiller
s+=`<line x1="650" y1="155" x2="645" y2="155" stroke="var(--o)" stroke-width="2" class="fL"/>`;
s+=`<line x1="525" y1="155" x2="520" y2="155" stroke="var(--o)" stroke-width="2" class="fL"/>`;
s+=tx(585,197,'FWS Return 22\u00B0C','var(--o)',4,'middle');
// CW Return: Chiller → CW Pump Station → CT
s+=`<line x1="305" y1="155" x2="295" y2="155" stroke="var(--o)" stroke-width="2" class="fL"/>`;
s+=`<line x1="195" y1="155" x2="190" y2="155" stroke="var(--o)" stroke-width="2" class="fL"/>`;
s+=tx(245,197,'CW Return 35\u00B0C','var(--o)',4,'middle');
// Sensor symbols on return lines
s+=symSensor(660,155,'var(--o)','T');s+=tx(660,148,'22\u00B0C','var(--o)',3,'middle');
s+=symSensor(810,155,'var(--o)','T');s+=tx(810,148,'45\u00B0C','var(--o)',3,'middle');
// ===== LOWER SECTION: DETAILED SPECS =====
const PY=200;
// Chiller Plant Details
s+=`<rect x="10" y="${PY}" width="230" height="175" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(125,PY+14,'CHILLER PLANT SPECS','var(--g)',7,'middle',1);
const chSpecs=[
['Type','Centrifugal water-cooled'],['Capacity','4× 2,500 kW = 10 MW'],['Available','N+1 → 7.5 MW usable'],
['Refrigerant','R-1234ze(E) GWP<1'],['COP Rated','5.5 AHRI | IPLV 7.2'],['Evap Temp','12°C LWT / 22°C EWT'],
['Cond Temp','28°C ECW / 35°C LCW'],['CW Flow','200 m³/h per chiller'],['CW Pump','N+1 VFD 75kW η>85%'],
['FWS Flow','500 m³/h total'],['FWS Pump','N+1 VFD 55kW η>85%'],['Staging','Auto 1-2-3 by ΔT'],
['Start','VFD 2min soft-start'],['Water Treat','Chem dose + 5µm filter']
];
chSpecs.forEach((sp,i)=>{s+=tx(20,PY+28+i*10,sp[0],'var(--t3)',4.5);s+=tx(85,PY+28+i*10,sp[1],'var(--t2)',4.5)});
// CDU & TCS Details
s+=`<rect x="250" y="${PY}" width="230" height="175" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(365,PY+14,'CDU & TCS CIRCUIT','var(--c)',7,'middle',1);
const cduSpecs=[
['CDU Model','L2L 350kW plate HX'],['CDU Count','24 units (N+1)'],['HX Type','SS316L plate counter-flow'],
['Primary In','FWS 12°C (facility)'],['Primary Out','FWS 22°C return'],['Secondary Out','TCS 35°C ±2°C'],
['Secondary In','TCS 45°C max'],['TCS Pump','N+1 VFD internal'],['TCS Pressure','4 bar sup / 3 bar ret'],
['Coolant','DI <5µS/cm pH 7-9'],['Filter','25µm per branch'],['Conductivity','Inline alarm >10µS'],
['Fill/Degas','CDU-mounted skid'],['Failover','Auto-redirect adj CDU']
];
cduSpecs.forEach((sp,i)=>{s+=tx(260,PY+28+i*10,sp[0],'var(--t3)',4.5);s+=tx(335,PY+28+i*10,sp[1],'var(--t2)',4.5)});
// Piping & Safety
s+=`<rect x="490" y="${PY}" width="230" height="175" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(605,PY+14,'PIPING & SAFETY','var(--r)',7,'middle',1);
const pipeSpecs=[
['FWS Supply','DN250 CS A106 Sch40'],['FWS Return','DN250 CS + BFV isol'],['FWS Insul','50mm PIR + vapor'],
['TCS Supply','DN150 SS316L orbital'],['TCS Return','DN150 SS316L bare'],['Branch','DN50 SS flex + QD'],
['Internal','DN15-25 to cold plate'],['Isolation','Ball valve per CDU/rack'],['PRV','FWS 6bar / TCS 4bar'],
['Leak Rope','800m all piping'],['Point Sensor','180 probes at QD'],['Drip Tray','SS 1mm under CDU'],
['Floor Drain','1:100 slope 500L/min'],['Auto Shutoff','Motor valve <3s']
];
pipeSpecs.forEach((sp,i)=>{s+=tx(500,PY+28+i*10,sp[0],'var(--t3)',4.5);s+=tx(580,PY+28+i*10,sp[1],'var(--t2)',4.5)});
// CRAH Section
s+=`<rect x="730" y="${PY}" width="220" height="175" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(840,PY+14,'CRAH — AIR 15%','var(--b)',7,'middle',1);
const crahSpecs=[
['Purpose','NIC/SSD/DIMM/VRM 15%'],['Capacity','6× N+1 = 1,070 kW'],['Type','CW CRAH EC fan wall'],
['Coil Temp','FWS 12→22°C'],['Supply Air','18°C ASHRAE A1'],['Return Air','35-40°C HAC'],
['Containment','Hot aisle ceiling+door'],['Fan','EC axial VFD N+1'],['Filter','MERV 11 quarterly'],
['Pre-filter','MERV 8 monthly'],['Controls','BACnet PID loop'],['Failover','Auto lead-lag'],
['Pressure','+5 to +10 Pa'],['Redundancy','5 run + 1 standby']
];
crahSpecs.forEach((sp,i)=>{s+=tx(740,PY+28+i*10,sp[0],'var(--t3)',4.5);s+=tx(815,PY+28+i*10,sp[1],'var(--t2)',4.5)});
// ===== BOTTOM: KPI STRIP =====
s+=`<rect x="10" y="385" width="940" height="55" rx="4" fill="rgba(34,197,94,.03)" stroke="rgba(34,197,94,.2)" stroke-width="1"/>`;
s+=tx(480,400,'COOLING SYSTEM LIVE KPIs','var(--g)',7,'middle',1);
const coolKPIs=[
{x:30,l:'DLC Load',v:'6,060',u:'kW',c:'var(--c)',id:'kDLC'},
{x:120,l:'Air Load',v:'1,070',u:'kW',c:'var(--b)',id:'kAir'},
{x:210,l:'Total',v:'7,130',u:'kW',c:'var(--g)',id:'kTot'},
{x:300,l:'Chiller',v:'3/4',u:'run',c:'var(--g)',id:'kCH'},
{x:380,l:'CDU',v:'23/24',u:'run',c:'var(--g)',id:'kCDU'},
{x:460,l:'CRAH',v:'5/6',u:'run',c:'var(--g)',id:'kCRAH'},
{x:540,l:'CT Fan',v:'78',u:'%',c:'var(--p)',id:'kCTF'},
{x:620,l:'CW ΔT',v:'7.1',u:'°C',c:'var(--c)',id:'kCWdT'},
{x:700,l:'FWS ΔT',v:'10.0',u:'°C',c:'var(--g)',id:'kFWSdT'},
{x:780,l:'TCS ΔT',v:'9.7',u:'°C',c:'var(--c)',id:'kTCSdT'},
{x:860,l:'WUE',v:'0.42',u:'L/kWh',c:'var(--c)',id:'kWUEc'}
];
coolKPIs.forEach(k=>{
s+=tx(k.x,415,k.l,'var(--t3)',5);
s+=`<text x="${k.x}" y="430" fill="${k.c}" font-family="${J}" font-size="10" font-weight="700" id="${k.id}">${k.v}</text>`;
s+=tx(k.x,438,k.u,'var(--t3)',4);
});
// ===== LEGEND =====
s+=`<rect x="10" y="445" width="940" height="110" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(480,460,'P&ID LEGEND & SYMBOLS','var(--t3)',7,'middle',1);
// Symbol legend
const symbols=[
{x:30,sym:'pump',c:'var(--c)',t:'Pump'},
{x:100,sym:'hx',c:'var(--c)',t:'Heat Exchanger'},
{x:190,sym:'valve',c:'var(--g)',t:'Valve (BFV/Ball)'},
{x:280,sym:'sensor',c:'var(--o)',t:'Sensor (T/P/F)'},
{x:370,sym:'motor',c:'var(--b)',t:'Motor/Fan'}
];
symbols.forEach(sym=>{
if(sym.sym==='pump')s+=symPump(sym.x+15,485,'var(--c)');
else if(sym.sym==='hx')s+=symHX(sym.x+15,485,'var(--c)');
else if(sym.sym==='valve')s+=symValve(sym.x+15,485,'var(--g)');
else if(sym.sym==='sensor')s+=symSensor(sym.x+15,485,'var(--o)','T');
else if(sym.sym==='motor')s+=symMotor(sym.x+15,485,'var(--b)');
s+=tx(sym.x+35,488,sym.t,'var(--t2)',5);
});
// Flow colors
s+=tx(470,480,'Flow Lines:','var(--t3)',5,0,1);
s+=`<line x1="530" y1="478" x2="580" y2="478" stroke="var(--c)" stroke-width="2.5" class="fR"/>`;s+=tx(590,480,'Supply (cold)','var(--t2)',5);
s+=`<line x1="670" y1="478" x2="720" y2="478" stroke="var(--o)" stroke-width="2" class="fL"/>`;s+=tx(730,480,'Return (warm)','var(--t2)',5);
s+=`<line x1="820" y1="478" x2="870" y2="478" stroke="var(--g)" stroke-width="2.5" class="fR"/>`;s+=tx(880,480,'FWS','var(--t2)',5);
// Fluid specs
s+=tx(30,510,'Fluid Specifications:','var(--t3)',5,0,1);
const fluids=[
{l:'CW (Condenser Water)',v:'Treated water + inhibitor, 28-35°C, DN300 CS'},
{l:'FWS (Facility Water Supply)',v:'Closed loop glycol 30%, 12-22°C, DN250 CS insulated'},
{l:'TCS (Technology Cooling Supply)',v:'DI water <5µS/cm pH 7-9, 35-45°C, DN150 SS316L'},
{l:'Refrigerant',v:'R-1234ze(E) low-GWP (<1) in chiller circuit only'}
];
fluids.forEach((f,i)=>{
s+=tx(30,525+i*12,f.l,'var(--c)',5);
s+=tx(200,525+i*12,f.v,'var(--t2)',5);
});
el.innerHTML=s;
// Live updates
setInterval(()=>{
const ctI=$('ctIn');if(ctI)ctI.textContent=R(34.5,35.8)+'°C';
const ctO=$('ctOut');if(ctO)ctO.textContent=R(27.5,28.5)+'°C';
const chE=$('chEvapL');if(chE)chE.textContent=R(11.5,12.5)+'°C';
const chC=$('chCOP');if(chC)chC.textContent=R(5.3,5.7);
const chL=$('chLoad');if(chL)chL.textContent=RI(70,85)+'%';
const cduTo=$('cduTCSo');if(cduTo)cduTo.textContent=R(34.5,35.8)+'°C';
const cduTi=$('cduTCSi');if(cduTi)cduTi.textContent=R(44.0,45.5)+'°C';
const rDT=$('rackDT');if(rDT)rDT.textContent=R(9.2,10.2)+'°C';
const fF=$('fwsFlow');if(fF)fF.textContent=RI(475,510)+' m³/h';
const kDLC=$('kDLC');if(kDLC)kDLC.textContent=(5900+RI(0,200)).toLocaleString();
const kTCS=$('kTCSdT');if(kTCS)kTCS.textContent=R(9.2,10.2);
},4000)})();


$('rackSu').textContent='48U OCP rack \u00D7 2 = NVL72 pair | 9\u00D7 Compute Tray (2U) + 9\u00D7 NVSwitch (1U) + 2\u00D7 PSU Shelf (3U) + Manifold + Bus Bar + Backplane';
(function(){const el=$('rackC');if(!el)return;let s='';
const RK=440;
// Rack A — compressed
s+=bx(15,10,190,RK,'rgba(34,197,94,.3)',4)+tx(110,6,'RACK A \u2014 NVL36-LEFT (48U)','var(--g)',7,'middle',1);
s+=`<g data-tip="PSU Shelf A: 6\u00D73kW rectifier modules (400VAC\u219248VDC), N+1 redundancy, \u03B7>97%, hot-swap front-load" data-rack="psu" data-id="A" style="cursor:pointer">`;s+=bx(23,16,175,16,'rgba(245,158,11,.12)',2)+tx(110,27,'\u26A1 PWR-A: 400V\u219250VDC | 6\u00D7PSU N+1 | \u03B7>97% [3U]','var(--o)',4,'middle');s+='</g>';
s+=`<g data-tip="PSU Shelf B: Redundant feed B path, 6\u00D73kW rectifier modules, N+1, hot-swap" data-rack="psu" data-id="B" style="cursor:pointer">`;s+=bx(23,35,175,16,'rgba(245,158,11,.1)',2)+tx(110,46,'\u26A1 PWR-B: 400V\u219250VDC | Feed B [3U]','var(--o)',4,'middle');s+='</g>';
// 9 Compute Trays (22px each → 198px total)
for(let i=0;i<9;i++){const y=55+i*22;
s+=`<g data-tip="Compute Tray CT-${i+1}: 4\u00D7B200 GPU (1,000W each) + 2\u00D7Grace72 CPU (250W) + 1\u00D7CX-8 NIC (800G IB), Cu microchannel cold plates, blind-mate hot-swap" data-rack="ct" data-id="${i+1}" style="cursor:pointer">`;
s+=`<rect x="23" y="${y}" width="175" height="19" rx="2" fill="rgba(34,197,94,${.12-.007*i})" stroke="rgba(34,197,94,${.32-.02*i})" stroke-width=".5"/>`;
for(let g=0;g<4;g++)s+=`<rect x="${25+g*18}" y="${y+2}" width="16" height="4" rx=".5" fill="rgba(34,197,94,.35)"/>`;
s+=`<rect x="${99}" y="${y+2}" width="14" height="4" rx=".5" fill="rgba(6,182,212,.3)"/><rect x="${117}" y="${y+2}" width="14" height="4" rx=".5" fill="rgba(6,182,212,.3)"/>`;
for(let g=0;g<4;g++)s+=`<rect x="${25+g*18}" y="${y+7}" width="16" height="2.5" rx=".3" fill="rgba(139,92,246,.18)"/>`;
s+=`<rect x="${140}" y="${y+2}" width="24" height="4" rx=".5" fill="rgba(236,72,153,.2)"/>`;
s+=`<rect x="${140}" y="${y+7}" width="24" height="2.5" rx=".3" fill="rgba(6,182,212,.12)"/>`;
s+=tx(110,y+16,'CT-'+(i+1)+' [2U] 4\u00D7B200 + 2\u00D7Grace72 + CX-8','var(--g)',4,'middle');
s+=`<circle cx="192" cy="${y+16}" r="1" fill="var(--g)" opacity=".7"/>`;s+='</g>'}
// 9 NVSwitch Trays (14px each → 126px total, start at y=253)
for(let i=0;i<9;i++){const y=257+i*14;
s+=`<g data-tip="NVSwitch Tray NS-${i+1}: 2\u00D7NVSwitch5 ASIC \u2014 128 NVLink5 ports, 28.8 Tb/s per ASIC, 130 TB/s bisection per domain, Cu microchannel cold plate" data-rack="ns" data-id="${i+1}" style="cursor:pointer">`;
s+=`<rect x="23" y="${y}" width="175" height="12" rx="1.5" fill="rgba(236,72,153,${.1-.005*i})" stroke="rgba(236,72,153,${.25-.02*i})" stroke-width=".4"/>`;
for(let n=0;n<2;n++)s+=`<rect x="${26+n*42}" y="${y+2}" width="38" height="3" rx=".5" fill="rgba(236,72,153,.22)"/>`;
s+=`<rect x="${115}" y="${y+2}" width="50" height="3" rx=".5" fill="rgba(139,92,246,.12)"/>`;
s+=tx(110,y+10,'NS-'+(i+1)+' [1U] 2\u00D7NVS5 28.8Tb/s','var(--pk)',4,'middle');s+='</g>'}
// Bottom components (manifold, bus, leak, backplane)
s+=`<g data-tip="DLC Manifold: Quick-disconnect blind-mate SS316L couplings, DN50 flex hose, isolation ball valve per rack, TCS supply 35\u00B0C / return 45\u00B0C" data-rack="manifold" style="cursor:pointer">`;s+=bx(23,387,175,10,'rgba(6,182,212,.12)',2)+tx(110,394,'\u2744 MANIFOLD: QD SS DN50 + Isol.Valve + Flex + Leak','var(--c)',3.5,'middle');s+='</g>';
s+=`<g data-tip="48VDC Bus Bar: 4,000A copper vertical, connects all PSU shelves to compute trays, sense wires + semiconductor fuse per tray tap" data-rack="busbar" style="cursor:pointer">`;s+=bx(23,400,175,8,'rgba(245,158,11,.08)',2)+tx(110,406,'\u26A1 50VDC BUS: 4,000A Cu + Sense + Semi-fuse/tray','var(--o)',3.5,'middle');s+='</g>';
s+=`<g data-tip="Leak Detection: Continuous rope sensor full manifold length + 2\u00D7 point sensors at QD connections, SS drip tray underneath" data-rack="leak" style="cursor:pointer">`;s+=bx(23,411,175,8,'rgba(239,68,68,.07)',2)+tx(110,417,'\u26A0 LEAK ROPE + 2\u00D7Point + SS Drip Tray','var(--r)',3.5,'middle');s+='</g>';
s+=`<g data-tip="NVLink Backplane: Passive copper cable cartridge with blind-mate connectors, 5,000+ coaxial lanes, 200 Gb/s NRZ per lane" data-rack="backplane" style="cursor:pointer">`;s+=bx(23,422,175,8,'rgba(139,92,246,.07)',2)+tx(110,428,'\u2B50 BACKPLANE: NVLink Cu blind-mate','var(--p)',3.5,'middle');s+='</g>';
// Cooling distribution lines
s+=fl(110,51,110,385,'rgba(34,197,94,.06)','fD',.5,1)+fl(95,385,95,395,'var(--c)','fD',.3,1)+fl(125,395,125,385,'var(--r)','fU',.3,1);
for(let i=0;i<9;i++){const y=62+i*22;
s+=`<line x1="28" y1="${y}" x2="28" y2="${y+16}" stroke="var(--c)" stroke-width="1.5" opacity=".4"><animate attributeName="stroke-opacity" values="0.2;0.7;0.2" dur="${1.2+i*0.1}s" repeatCount="indefinite"/></line>`;
s+=`<line x1="192" y1="${y}" x2="192" y2="${y+16}" stroke="var(--r)" stroke-width="1.5" opacity=".3"><animate attributeName="stroke-opacity" values="0.2;0.6;0.2" dur="${1.3+i*0.1}s" repeatCount="indefinite"/></line>`;
s+=`<circle cx="28" cy="${y+8}" r="1.5" fill="var(--c)"><animate attributeName="cy" values="${y};${y+16};${y}" dur="${0.8+i*0.05}s" repeatCount="indefinite"/></circle>`;
s+=`<circle cx="192" cy="${y+8}" r="1.5" fill="var(--r)"><animate attributeName="cy" values="${y+16};${y};${y+16}" dur="${0.9+i*0.05}s" repeatCount="indefinite"/></circle>`;
}
s+=`<line x1="28" y1="55" x2="28" y2="253" stroke="var(--c)" stroke-width="2.5" opacity=".5"><animate attributeName="stroke-width" values="2;3;2" dur="2s" repeatCount="indefinite"/></line>`;
s+=`<line x1="192" y1="55" x2="192" y2="253" stroke="var(--r)" stroke-width="2.5" opacity=".4"><animate attributeName="stroke-width" values="2;3;2" dur="2.2s" repeatCount="indefinite"/></line>`;
// Rack B — compressed
s+=bx(225,10,135,RK,'rgba(34,197,94,.22)',4)+tx(292,6,'RACK B (48U)','var(--g)',7,'middle',1);
s+=bx(230,16,125,26,'rgba(245,158,11,.1)',2)+tx(292,32,'PWR [6U]','var(--o)',5,'middle');
for(let i=0;i<9;i++){const y=46+i*22;
s+=`<rect x="230" y="${y}" width="125" height="19" rx="2" fill="rgba(34,197,94,.08)" stroke="rgba(34,197,94,.25)" stroke-width=".4"/>`;
for(let w=0;w<3;w++){
s+=`<line x1="${235+w*12}" y1="${y+7}" x2="${235+w*12+20}" y2="${y+7}" stroke="var(--c)" stroke-width=".5" opacity=".4"><animate attributeName="stroke-opacity" values="0.2;0.8;0.2" dur="${1.2+w*0.3}s" repeatCount="indefinite"/></line>`;
s+=`<line x1="${285+w*12}" y1="${y+13}" x2="${285+w*12+20}" y2="${y+13}" stroke="var(--p)" stroke-width=".4" opacity=".3"><animate attributeName="stroke-opacity" values="0.1;0.6;0.1" dur="${1.5+w*0.2}s" repeatCount="indefinite"/></line>`;
}
s+=`<circle cx="${350}" cy="${y+10}" r="1.5" fill="var(--g)"><animate attributeName="fill-opacity" values="0.3;1;0.3" dur="${0.8+i*0.1}s" repeatCount="indefinite"/></circle>`;
s+=tx(292,y+16,'CT-'+(i+1),'var(--g)',3.5,'middle');
}
for(let i=0;i<9;i++){const y=249+i*14;
s+=`<rect x="230" y="${y}" width="125" height="12" rx="1.5" fill="rgba(236,72,153,.08)" stroke="rgba(236,72,153,.2)" stroke-width=".3"/>`;
s+=`<line x1="235" y1="${y+6}" x2="280" y2="${y+6}" stroke="var(--pk)" stroke-width=".7" opacity=".5"><animate attributeName="stroke-opacity" values="0.2;0.7;0.2" dur="${1+i*0.15}s" repeatCount="indefinite"/></line>`;
s+=tx(320,y+9,'NS-'+(i+1),'var(--pk)',3,'middle');
}
s+=bx(230,380,125,50,'rgba(139,92,246,.06)',2)+tx(292,400,'BACKPLANE','var(--p)',5,'middle')+tx(292,412,'NVLink Cu','var(--p)',4,'middle');
// NVLink connections A↔B
for(let i=0;i<5;i++){
s+=`<line x1="198" y1="${70+i*42}" x2="230" y2="${70+i*42}" stroke="var(--pk)" stroke-width="1" opacity=".4"><animate attributeName="stroke-opacity" values="0.2;0.8;0.2" dur="${1.3+i*0.2}s" repeatCount="indefinite"/></line>`;
}
// Rack C (Network) — compressed
s+=bx(375,10,135,RK,'rgba(59,130,246,.22)',4)+tx(442,6,'RACK C (Network)','var(--b)',7,'middle',1);
s+=bx(380,16,125,40,'rgba(59,130,246,.1)',2)+tx(442,38,'IB LEAF \u00D72','var(--b)',5,'middle');
s+=bx(380,62,125,40,'rgba(139,92,246,.1)',2)+tx(442,84,'IB SPINE \u00D71','var(--p)',5,'middle');
s+=bx(380,108,125,45,'rgba(6,182,212,.1)',2)+tx(442,128,'ODF/PATCH','var(--c)',5,'middle')+tx(442,142,'LC/MPO','var(--t3)',4,'middle');
s+=bx(380,160,125,45,'rgba(245,158,11,.1)',2)+tx(442,180,'PDU/METER','var(--o)',5,'middle')+tx(442,194,'kWh/PF','var(--t3)',4,'middle');
s+=bx(380,212,125,55,'rgba(34,197,94,.1)',2)+tx(442,232,'OOB SWITCH','var(--g)',5,'middle')+tx(442,248,'25GbE ToR','var(--t3)',4,'middle')+tx(442,260,'BMC 1GbE','var(--t3)',4,'middle');
s+=bx(380,274,125,55,'rgba(236,72,153,.1)',2)+tx(442,294,'STORAGE','var(--pk)',5,'middle')+tx(442,310,'NVMe-oF','var(--t3)',4,'middle');
s+=bx(380,336,125,RK-336,'rgba(107,114,128,.1)',2)+tx(442,360,'SPARE','var(--t3)',5,'middle')+tx(442,376,'Patch/Tools','var(--t3)',4,'middle');
for(let i=0;i<4;i++){
s+=`<line x1="355" y1="${80+i*60}" x2="380" y2="${80+i*60}" stroke="var(--b)" stroke-width=".8" stroke-dasharray="3 2" opacity=".5"><animate attributeName="stroke-opacity" values="0.2;0.6;0.2" dur="${1.5+i*0.2}s" repeatCount="indefinite"/></line>`;
}
// Detail panels — compressed row spacing (11px per row)
const rP=[
{y:5,c:'var(--g)',t:'COMPUTE TRAY (2U)',r:[
['Board','2\u00D7 Bianca baseplate'],
['GPU','4\u00D7 B200 Blackwell/tray'],
['CPU','2\u00D7 Grace72 Neoverse V2'],
['C2C','900 GB/s NVLink-C2C'],
['HBM3e','192 GB/GPU = 8 TB/s BW'],
['LPDDR5X','480 GB/CPU = 546 GB/s'],
['NIC','1\u00D7 CX-8 800G OSFP/tray'],
['NVLink','Blind-mate backplane (rear)'],
['Cold plate','Cu \u00B5ch: 2\u00D7GPU+1\u00D7CPU/board'],
['Fan','Axial NIC/SSD/VRM (15% air)'],
['BMC','Per-tray HMC Redfish T/P/FW'],
['Hot-swap','Front-load blind-mate pwr+liq'],
]},
{y:165,c:'var(--pk)',t:'NVSwitch TRAY (1U)',r:[
['ASIC','2\u00D7 NVSwitch5 (28.8Tb/s ea)'],
['Rear','72 NVLink \u2192 backplane'],
['Front','18\u00D7 1.6T OSFP multi-rack'],
['Per rack','9 trays = 18 NVS5 ASICs'],
['Domain BW','130 TB/s all-to-all'],
['Cold plate','Cu \u00B5ch per NVS5 ASIC'],
['Power','~700W/tray (350W/ASIC)'],
]},
{y:272,c:'var(--o)',t:'POWER IN-RACK',r:[
['Input','400V 3ph 50Hz via RPP whip'],
['PSU','3U\u00D72 = 6U, 6\u00D7/shelf N+1 \u03B7>97%'],
['Bus bar','50VDC Cu 4,000A vertical'],
['Fuse','Semi-fuse per tray bus tap'],
['GPU TDP','1,000\u20131,200W per B200'],
['CPU TDP','~250W per Grace (capped)'],
['NVSwitch','~350W per NVS5 ASIC'],
['Total','~66 kW (132 kW/NVL72)'],
['Monitor','V/I/kW per-shelf + BMC'],
]},
];
rP.forEach(p=>{
const h=16+p.r.length*11;
s+=`<rect x="530" y="${p.y}" width="425" height="${h}" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(542,p.y+13,p.t,p.c,6,0,1);
p.r.forEach((r,i)=>{s+=tx(542,p.y+24+i*11,r[0],'var(--t3)',5);s+=tx(625,p.y+24+i*11,r[1],'var(--t2)',5)})});
el.innerHTML=s})();


// RACK CARDS
$('rackCards').innerHTML=[
mc('var(--c)','Liquid Cooling Per Rack','DLC Cold Plate Circuit',[['Path','OH TCS \u2192 EoR CDU \u2192 rack manifold \u2192 cold plates'],['Supply','35\u00B0C \u00B12\u00B0C from CDU'],['Return','45\u00B0C max to CDU'],['\u0394T','10\u00B0C nominal design'],['Flow','4.8 m\u00B3/h (80 LPM) per rack'],['Plates/rack','36 GPU + 18 CPU + 18 NVS = 72'],['Plate type','Cu microchannel brazed'],['Manifold','SS316L + QD drip-free'],['Hose','DN25 flex EPDM 6 bar rated'],['Coolant','DI water <5\u00B5S/cm pH 7-9'],['Pressure','2-3 bar at rack inlet'],['Filter','25\u00B5m inline per branch'],['Leak','Rope full length + 2\u00D7point at QD'],['Drip tray','SS under manifold'],['TIM','Indium/graphite on cold plate'],['Test','Annual thermal resistance check']]),
mc('var(--p)','NVLink Cable System','Passive Cu Interconnect',[['Type','Passive coaxial copper'],['Count','5,000+ per NVL72 pair'],['Cartridge','Pre-assembled blind-mate module'],['Mating','~6,000 lbs per rack pair'],['Lane speed','200 Gb/s NRZ (NVLink5)'],['Lanes/GPU','36 Tx + 36 Rx bidirectional'],['Cross-rack','18\u00D71.6T OSFP front NVS'],['Insertion loss','<20 dB at 56 GHz'],['BER','<1E-12 post-FEC target'],['Retimer','None (passive direct)'],['Maintenance','Cartridge hot-swap as unit'],['Spare','1 cartridge per 9 domains'],['Bend radius','Per NVIDIA mech spec'],['Shielding','Individual coax + tray EMI']]),
mc('var(--t2)','Physical Rack','Mechanical Specs',[['Standard','48U OCP Open Rack v3'],['Width','600mm (19\" EIA)'],['Depth','1,200mm + rear extension'],['Height','2,200mm (48U usable)'],['Weight empty','~350 kg steel frame'],['Weight loaded','~2,700 kg operational'],['Anchor','4\u00D7 M16 expansion \u226550kN shear'],['Seismic brace','Top-of-rack tie to grid'],['ESD','Bonded to building ground bus'],['Leveling','\u00B120mm adjustable feet'],['Door','Perforated front 65% open'],['Rear','Open + cable cartridge mount'],['Entry','Top (overhead tray) + rear'],['Paint','RAL 7016 powder coat']]),
].join('');

// COOLING CARDS
$('coolCards').innerHTML=[
mc('var(--g)','Water Treatment','Chemical & Filtration',[['FWS','Closed-loop: inhibitor + biocide'],['FWS glycol','30% PG (freeze protection)'],['TCS purity','DI <5\u00B5S/cm conductivity'],['TCS pH','7.0-9.0 range'],['Filtration','25\u00B5m inline per CDU'],['Side-stream','5\u00B5m bag filter FWS header'],['Monitoring','Inline cond + pH + ORP'],['Lab test','Monthly: pH, cond, bacteria, TSS'],['Blowdown','CT auto on conductivity SP'],['Make-up','RO + DI polisher for TCS']]),
mc('var(--o)','Performance Targets','Design & Operating KPIs',[['Total cooling','7,130 kW (DLC + air)'],['DLC capacity','6,060 kW (85%)'],['Air capacity','1,070 kW (15%)'],['PUE cooling','0.02-0.04 contribution'],['Approach \u0394T','3\u00B0C CDU (FWS\u2192TCS)'],['CW approach','7\u00B0C (CT to ambient WB)'],['Pump energy','~180 kW total (all pumps)'],['Fan energy','~80 kW total (CT + CRAH)'],['WUE target','<0.5 L/kWh'],['Availability','99.999% (N+1 all paths)']])
].join('');

// ELECTRICAL CARDS
$('elecCards').innerHTML=[
mc('var(--r)','Generator System','Backup Power N+1',[['Units','4\u00D7 2,500 kW diesel (N+1)'],['Engine','MTU 16V4000 DS3000 (or equiv)'],['Alternator','Stamford/Leroy-Somer 400V 50Hz'],['Fuel','ASTM D975 No.2 diesel'],['Tank','48hr base + 500L day tank'],['Start','Auto <10s on LV bus undervoltage'],['ATS','LV motorized <100ms transfer'],['Sync','Auto-sync paralleling for N+1'],['Cooling','Radiator + remote condenser option'],['Exhaust','SCR/DPF emission (Jakarta reg)'],['Load bank','Monthly 1hr at 75% load'],['Maintenance','250hr: oil/filter | 1000hr: major']]),
mc('var(--g)','UPS System','2N Concurrent Maintainable',[['Rating','2\u00D7 4,500 kW (A+B paths)'],['Type','Double-conversion online VFI-SS-111'],['Topology','Modular: 6\u00D7750kW per frame'],['Battery','Li-Ion NMC parallel strings'],['Runtime','10 min @ full IT load (7,128 kW)'],['Efficiency','\u03B7>96% double-conv | >99% eco'],['THDi/THDv','<3% / <1% at rated load'],['STS','Static Transfer <4ms BBM'],['Monitoring','Per-module V/I/T + SOC/SOH'],['Lifecycle','10yr battery, 15yr electronics'],['Testing','Annual capacity discharge test'],['Standard','IEC 62040-3 VFI-SS-111']]),
mc('var(--c)','Metering & SCADA','Power Monitoring',[['Branch meter','Schneider PM5xxx (Modbus TCP)'],['Parameters','V/I/kW/kWh/kVAr/PF/THD per phase'],['Resolution','1-second polling to BMS'],
['PUE calc','Real-time: Total facility / IT load'],['Busway monitor','Per tap-off kW + thermal'],['UPS monitor','SOC, SOH, load%, transfer events'],
['GenSet monitor','Run status, fuel, coolant T, oil P'],['Data export','Modbus TCP + IEC 61850 to SCADA'],['Historian','1yr high-res + 5yr daily agg'],['Dashboard','Real-time web + mobile alerts']])
].join('');


// NETWORK TOPOLOGY SVG - LIVE with laser animations and alarm simulation
$('netSu').textContent='NVLink5 Intra-Domain (130 TB/s) + InfiniBand XDR 800G Scale-Out (4-Rail Fat-Tree) + 25GbE OOB Management';
(function(){const el=$('netC');if(!el)return;let s='';
// Laser animation definition
s+=`<defs>
<linearGradient id="laserG" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="rgba(139,92,246,0)"/><stop offset="50%" stop-color="rgba(139,92,246,.8)"/><stop offset="100%" stop-color="rgba(139,92,246,0)"/></linearGradient>
<filter id="glow"><feGaussianBlur stdDeviation="1" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
</defs>`;
s+=`<style>.laser{stroke:url(#laserG);stroke-width:2;stroke-dasharray:15 85;animation:laserMove 2s linear infinite;filter:url(#glow)}@keyframes laserMove{0%{stroke-dashoffset:100}100%{stroke-dashoffset:0}}.linkUp{stroke:rgba(34,197,94,.4)}.linkDown{stroke:rgba(239,68,68,.6);stroke-dasharray:4 4}</style>`;
s+=`<rect width="960" height="520" fill="var(--bg2)"/>`;
s+=`<pattern id="netGrid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M20 0L0 0 0 20" fill="none" stroke="rgba(255,255,255,.02)" stroke-width=".3"/></pattern>`;
s+=`<rect width="960" height="520" fill="url(#netGrid)"/>`;
// Title with live status
s+=tx(480,18,'NETWORK FABRIC TOPOLOGY — 27 NVL72 DOMAINS — 1,944 GPU','var(--t3)',8,'middle',1);
// Alarm indicator
s+=`<rect x="850" y="8" width="100" height="18" rx="3" fill="rgba(34,197,94,.1)" stroke="var(--g)" stroke-width=".5" id="netAlarmBox"/>`;
s+=`<text x="900" y="20" fill="var(--g)" font-family="${J}" font-size="6" text-anchor="middle" font-weight="600" id="netAlarm">ALL LINKS UP</text>`;
// SPINE LAYER with live ports
s+=`<rect x="200" y="35" width="560" height="55" rx="4" fill="rgba(139,92,246,.08)" stroke="rgba(139,92,246,.3)" stroke-width="1"/>`;
s+=tx(480,48,'SPINE LAYER — 4× QX800 Q3400 (64-port 800G each)','var(--p)',7,'middle',1);
const spines=[{x:250,id:'SP-1'},{x:380,id:'SP-2'},{x:520,id:'SP-3'},{x:650,id:'SP-4'}];
spines.forEach((sp,si)=>{
s+=`<g data-tip="Spine Switch ${sp.id}: QX800 Q3400, 64\u00D7800G IB XDR ports, 51.2 Tb/s switching capacity, SHARP in-network allreduce">`;
s+=`<rect x="${sp.x}" y="55" width="80" height="28" rx="3" fill="rgba(139,92,246,.15)" stroke="var(--p)" stroke-width=".6"/>`;
s+=tx(sp.x+40,66,sp.id,'var(--p)',6,'middle',1);
s+=`<text x="${sp.x+40}" y="78" fill="var(--g)" font-family="${J}" font-size="4" text-anchor="middle" id="sp${si}bw">782 Gb/s</text>`;
s+='</g>'});
// LEAF LAYER with live ports
s+=`<rect x="50" y="100" width="860" height="58" rx="4" fill="rgba(59,130,246,.08)" stroke="rgba(59,130,246,.3)" stroke-width="1"/>`;
s+=tx(480,113,'LEAF LAYER — 8× QX800 Q3400 (64-port 800G each) — 4-Rail Fat-Tree 1:1','var(--b)',7,'middle',1);
const leaves=[];
for(let i=0;i<8;i++){leaves.push({x:70+i*108,id:'LF-'+(i+1)})}
leaves.forEach((lf,li)=>{
s+=`<g data-tip="Leaf Switch ${lf.id}: QX800 Q3400, 64\u00D7800G IB XDR ports, connects to compute NICs via 800G OSFP, 4-Rail Fat-Tree 1:1">`;
s+=`<rect x="${lf.x}" y="125" width="88" height="28" rx="3" fill="rgba(59,130,246,.15)" stroke="var(--b)" stroke-width=".6"/>`;
s+=tx(lf.x+44,136,lf.id,'var(--b)',5,'middle',1);
s+=`<text x="${lf.x+44}" y="148" fill="var(--g)" font-family="${J}" font-size="4" text-anchor="middle" id="lf${li}bw">756 Gb/s</text>`;
s+='</g>'});
// Spine-Leaf connections with laser effect
spines.forEach((sp,si)=>{
leaves.forEach((lf,li)=>{
const x1=sp.x+40,y1=83,x2=lf.x+44,y2=125;
const linkId='sl'+si+''+li;
// Base link
s+=`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="rgba(139,92,246,.15)" stroke-width=".6" id="${linkId}"/>`;
// Laser overlay (animated)
s+=`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="laser" style="animation-delay:${(si*8+li)*0.06}s"/>`;
});});
// NVL72 DOMAIN LAYER with live stats
s+=`<rect x="10" y="170" width="940" height="175" rx="4" fill="rgba(34,197,94,.05)" stroke="rgba(34,197,94,.2)" stroke-width="1"/>`;
s+=tx(480,185,'NVL72 COMPUTE DOMAINS — 27 DOMAINS × 72 GPU = 1,944 GPU — NVLink5 130 TB/s per domain','var(--g)',7,'middle',1);
// Draw 27 domains in 3 rows of 9
const domRows=[[],[],[]];
for(let d=0;d<27;d++){domRows[Math.floor(d/9)].push(d+1)}
domRows.forEach((row,ri)=>{
row.forEach((dom,di)=>{
const x=25+di*103,y=198+ri*48;
s+=`<g data-tip="NVL72 Domain DOM-${dom}: 72 GPUs (2 racks), 130 TB/s NVLink5 bisection, 18\u00D7NVSwitch5, full-mesh all-to-all, 132kW total">`;
s+=`<rect x="${x}" y="${y}" width="95" height="40" rx="3" fill="rgba(34,197,94,.1)" stroke="rgba(34,197,94,.35)" stroke-width=".6" class="rg"/>`;
s+=tx(x+48,y+11,'DOM-'+dom,'var(--g)',5.5,'middle',1);
s+=`<text x="${x+48}" y="${y+23}" fill="var(--c)" font-family="${J}" font-size="4" text-anchor="middle" id="dom${dom-1}nvl">128 TB/s</text>`;
s+=`<text x="${x+48}" y="${y+33}" fill="var(--o)" font-family="${J}" font-size="4" text-anchor="middle" id="dom${dom-1}util">87%</text>`;s+='</g>';
// Connect to leaf with animated data flow
const lfIdx=di%8;
const lfX=leaves[lfIdx].x+44;
s+=`<line x1="${x+48}" y1="${y}" x2="${lfX}" y2="153" stroke="rgba(59,130,246,.12)" stroke-width=".5"/>`;
s+=`<line x1="${x+48}" y1="${y}" x2="${lfX}" y2="153" class="laser" style="animation-delay:${(dom*0.1)}s;stroke-width:1"/>`;
});});
// NVLink Detail Panel with live values
s+=`<rect x="10" y="355" width="310" height="155" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(165,372,'NVLINK5 INTRA-DOMAIN','var(--pk)',7,'middle',1);
const nvlSpec=[
['Generation','5th Gen NVLink5'],['BW per GPU','1.8 TB/s'],['Total NVL5 BW','var(--c)','nvlTot','3,510 TB/s'],
['Active Links','var(--g)','nvlAct','135,000/135,000'],['Lane Errors','var(--g)','nvlErr','0'],['Retrains/hr','var(--g)','nvlRet','2'],
['Avg Latency','var(--c)','nvlLat','0.42 µs'],['BER','var(--g)','nvlBer','<1E-15'],['NVSwitch Util','var(--o)','nvlNvs','78%'],['Temp Max','var(--o)','nvlTmp','72°C']
];
nvlSpec.forEach((r,i)=>{
s+=tx(20,388+i*13,r[0],'var(--t3)',5);
if(r.length>2){s+=`<text x="300" y="${388+i*13}" fill="${r[1]}" font-family="${J}" font-size="5.5" text-anchor="end" font-weight="600" id="${r[2]}">${r[3]}</text>`}
else{s+=tx(300,388+i*13,r[1],'var(--t2)',5,'end')}
});
// IB XDR Detail Panel with live values
s+=`<rect x="330" y="355" width="310" height="155" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(485,372,'INFINIBAND XDR 800G','var(--p)',7,'middle',1);
const ibSpec=[
['Port Speed','800 Gb/s'],['Total IB BW','var(--p)','ibTot','409.6 Tb/s'],
['Active Ports','var(--g)','ibAct','512/512'],['Link Errors','var(--g)','ibErr','0'],['Congestion','var(--g)','ibCong','0.2%'],
['RDMA Ops/s','var(--c)','ibRdma','12.4M'],['Allreduce/s','var(--c)','ibAll','847K'],['Avg Latency','var(--c)','ibLat','1.2 µs'],['Spine Util','var(--o)','ibSpn','65%'],['Leaf Util','var(--o)','ibLf','72%']
];
ibSpec.forEach((r,i)=>{
s+=tx(340,388+i*13,r[0],'var(--t3)',5);
if(r.length>2){s+=`<text x="630" y="${388+i*13}" fill="${r[1]}" font-family="${J}" font-size="5.5" text-anchor="end" font-weight="600" id="${r[2]}">${r[3]}</text>`}
else{s+=tx(630,388+i*13,r[1],'var(--t2)',5,'end')}
});
// OOB Management Panel
s+=`<rect x="650" y="355" width="300" height="155" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(800,372,'OOB MANAGEMENT NETWORK','var(--c)',7,'middle',1);
const oobSpec=[['ToR Switch','25GbE per rack pair'],['BMC','1GbE/tray IPMI/Redfish'],['Storage','100GbE NVMe-oF RDMA'],['Protocol','SNMP v3 + syslog + REST'],['NTP','Stratum 2 GPS-synced'],['DNS','Redundant internal'],['Telemetry','Prometheus + dcgm_exporter'],['Dashboard','Grafana real-time'],['Alerting','PagerDuty + SMS'],['KVM','IP-KVM 1/rack pair']];
oobSpec.forEach((r,i)=>{s+=tx(660,388+i*13,r[0],'var(--t3)',5);s+=tx(940,388+i*13,r[1],'var(--t2)',5,'end')});
el.innerHTML=s;
// Live network updates
setInterval(()=>{
// Spine bandwidth
for(let i=0;i<4;i++){const e=$('sp'+i+'bw');if(e)e.textContent=RI(750,795)+' Gb/s'}
// Leaf bandwidth
for(let i=0;i<8;i++){const e=$('lf'+i+'bw');if(e)e.textContent=RI(720,780)+' Gb/s'}
// Domain stats
for(let i=0;i<27;i++){
const nvl=$('dom'+i+'nvl');if(nvl)nvl.textContent=RI(120,130)+' TB/s';
const ut=$('dom'+i+'util');if(ut)ut.textContent=RI(75,95)+'%';
}
// NVLink panel
const nvlT=$('nvlTot');if(nvlT)nvlT.textContent=(3400+RI(0,200))+' TB/s';
const nvlL=$('nvlLat');if(nvlL)nvlL.textContent=R(0.38,0.48)+' µs';
const nvlU=$('nvlNvs');if(nvlU)nvlU.textContent=RI(72,85)+'%';
const nvlTm=$('nvlTmp');if(nvlTm)nvlTm.textContent=RI(68,76)+'°C';
// IB panel
const ibT=$('ibTot');if(ibT)ibT.textContent=(400+RI(0,20))+' Tb/s';
const ibR=$('ibRdma');if(ibR)ibR.textContent=R(11,14)+'M';
const ibA=$('ibAll');if(ibA)ibA.textContent=RI(800,900)+'K';
const ibS=$('ibSpn');if(ibS)ibS.textContent=RI(60,72)+'%';
const ibL=$('ibLf');if(ibL)ibL.textContent=RI(68,78)+'%';
// Simulate occasional alarm (5% chance)
if(Math.random()<0.05){
const ab=$('netAlarmBox'),at=$('netAlarm');
if(ab&&at){ab.style.fill='rgba(239,68,68,.15)';ab.style.stroke='var(--r)';at.style.fill='var(--r)';at.textContent='LINK WARN: LF-'+RI(1,8)}
setTimeout(()=>{if(ab&&at){ab.style.fill='rgba(34,197,94,.1)';ab.style.stroke='var(--g)';at.style.fill='var(--g)';at.textContent='ALL LINKS UP'}},3000);
}
},4000);
})();
$('netCards').innerHTML=[
mc('var(--pk)','NVLink5 Intra-Domain','72-GPU All-to-All',[['Generation','5th Gen NVLink5'],['BW/GPU','1.8 TB/s bidirectional'],['Lane speed','200 Gb/s NRZ per lane'],['Lanes/GPU','36 Tx + 36 Rx'],['Domain BW','130 TB/s bisection'],['NVSwitch5','18\u00D7 per domain (28.8 Tb/s ea)'],['Topology','Full-mesh all-to-all'],['Cable','Passive coax Cu 5,000+'],['Backplane','Cable cartridge blind-mate'],['Cross-rack','18\u00D71.6T OSFP (NVS front)'],['Latency','<1\u00B5s intra-domain'],['BER','<1E-12 post-FEC'],['Error','Auto-retrain + lane remap'],['Telemetry','NVOS 2.0 per-port counters']]),
mc('var(--p)','IB XDR 800G Scale-Out','Inter-Domain Fabric',[['Standard','InfiniBand XDR'],['Speed','800 Gb/s per port'],['NIC','CX-8 twin OSFP (9/rack)'],['Optics','800G DR4/SR4 OSFP'],['Leaf','QX800 Q3400 \u00D78 (64p ea)'],['Spine','QX800 Q3400 \u00D74 (64p ea)'],['Topology','4-Rail Fat-Tree 1:1'],['RDMA','GPUDirect RDMA v3'],['SHARP','In-network allreduce'],['Congestion','DCQCN + adaptive routing'],['WJH','What Just Happened telemetry'],['Firmware','MLNX-OS / NVOS 2.0']]),
mc('var(--b)','Structured Cabling','Physical Layer (DLC-Adapted)',[['SM fiber','OS2 9/125\u00B5m LC/APC'],['MM fiber','OM5 50/125\u00B5m MPO-16'],['Fiber count','~4,200 LC/MPO per hall'],['Cu','~540 Cat6A drops (OOB+BMC)'],['Coax','~135K NVLink lanes total'],['Tray','3-tier overhead SS ladder'],['Power tray','Left 300mm (A+B sep)'],['Fiber tray','Center 450mm'],['Cu tray','Right 300mm + NVLink'],['TCS pipe','OH DN150 SS316L \u2192 EoR CDU \u2192 rack'],['Slab','Solid slab-on-grade (no raised floor)'],['Labeling','TIA-606-C structured']]),
mc('var(--g)','Management OOB','BMC / Storage / Telemetry',[['OOB','25GbE ToR per rack'],['BMC','1GbE/tray mgmt VLAN'],['HMC','Host Mgmt Controller'],['Storage','100GbE NVMe-oF RDMA'],['NTP','Stratum 2 GPS-synced'],['DNS','Redundant internal'],['Syslog','rsyslog \u2192 ELK'],['SNMP','v3 encrypted to NMS'],['Prometheus','dcgm_exporter/GPU'],['Grafana','Real-time dashboards'],['IP-KVM','1/rack pair (console)'],['Firmware','Centralized FOTA']])
].join('');
// FIRE
$('fireCards').innerHTML=[
mc('var(--r)','Novec 1230 Suppression','NFPA 2001 / ISO 14520',[['Agent','3M Novec 1230 FK-5-1-12'],['Design','5.3% at 21\u00B0C (NOAEL 10%)'],['Discharge','\u226410s full flood'],['Hold','\u226510 min (integrity tested)'],['Nozzle','360\u00B0 ceiling SS \u00D712'],['Cylinder','180L \u00D74 (N\u2082 42bar)'],['Actuation','Double-interlock 2-zone'],['Abort','30s delay + manual \u00D72'],['HVAC','Damper close + fan stop'],['Post','Exhaust ventilation seq'],['Pipe','SS Sch40 hydraulic calc'],['Annual','Cylinder weigh + nozzle inspect']]),
mc('var(--o)','Detection Multi-Layer','Aspirating + Spot + Linear',[['VESDA','LaserPLUS aspirating ASD'],['Zones','Alert/Action/Fire1/Fire2'],['Sensitivity','0.005% obs/m (Alert)'],['Spot smoke','Photoelectric \u00D748'],['Spot heat','RoR + 57\u00B0C fixed \u00D724'],['Linear heat','DTS fiber under tray'],['Beam','Reflected \u00D72 (high ceiling)'],['Manual call','At exits + EPO stations'],['FACP','Addressable (Notifier/Simplex)'],['Zone map','12 zones hall+elec+MDF'],['Annunciation','Strobe+horn+BMS+SMS'],['Testing','Quarterly det + annual full']]),
mc('var(--c)','Leak Detection','Water Protection',[['Rope','800m total all piping'],['Point','180 probes at QD/valve'],['Panel','TTK/RLE dedicated controller'],['Zones','24 zones matching CDU'],['Response','<3s alarm to BMS'],['Shutoff','Motorized valve <3s'],['Containment','SS drip + membrane'],['Drain','1:100 slope + 500L/min pump'],['Sump','200L capacity per zone'],['Testing','Monthly + quarterly wet']]),
mc('var(--g)','Emergency EPO/Egress','Life Safety',[['EPO','Dual-confirmed (key+button)'],['Location','4 stations at exits+NOC'],['Scope','IT pwr + CDU pumps + CRAH'],['Lighting','Battery LED 90min \u226510lux'],['Exit','Illuminated + photoluminescent'],['Access','Biometric + card + PIN'],['Mantrap','Airlock entry to hall'],['CCTV','16\u00D7 IP 4MP PTZ 90-day NVR'],['PA','Zoned evacuation announce'],['Drill','Quarterly fire + leak drill']])
].join('');

// FIRE P&ID COMPREHENSIVE SVG
$('fireSu').textContent='Comprehensive Fire P&ID: VESDA Aspirating + Addressable FACP + Novec 1230 Suppression + Leak Detection + EPO Integration';
(function(){const el=$('fireC');if(!el)return;let s='';
// Background with grid
s+=`<rect width="960" height="580" fill="var(--bg2)"/>`;
s+=`<pattern id="fGrid" width="15" height="15" patternUnits="userSpaceOnUse"><path d="M15 0L0 0 0 15" fill="none" stroke="rgba(255,255,255,.015)" stroke-width=".2"/></pattern>`;
s+=`<rect width="960" height="580" fill="url(#fGrid)"/>`;
s+=tx(480,16,'FIRE DETECTION & SUPPRESSION P&ID — DATA HALL + ELECTRICAL + MDF','var(--t3)',8,'middle',1);
// ===== VESDA SYSTEM (Top Section) =====
s+=`<rect x="10" y="25" width="620" height="135" rx="4" fill="rgba(139,92,246,.03)" stroke="rgba(139,92,246,.2)" stroke-width="1"/>`;
s+=tx(320,40,'VESDA ASPIRATING DETECTION SYSTEM','var(--p)',7,'middle',1);
// VESDA Detectors
const vesdas=[{x:30,id:'VD-1',zone:'Z1-Z3'},{x:170,id:'VD-2',zone:'Z4-Z6'},{x:310,id:'VD-3',zone:'Z7-Z9'},{x:450,id:'VD-4',zone:'Z10-Z12'}];
vesdas.forEach(v=>{
s+=`<g data-tip="VESDA ${v.id}: LaserPLUS aspirating smoke detector, ~100 sample points, 4-tier sensitivity (Alert/Action/Fire1/Fire2), pre-fire warning, zones ${v.zone}">`;
s+=`<rect x="${v.x}" y="50" width="120" height="55" rx="3" fill="rgba(139,92,246,.1)" stroke="var(--p)" stroke-width=".8"/>`;
s+=`<circle cx="${v.x+20}" cy="${v.y||70}" r="6" fill="rgba(139,92,246,.2)" stroke="var(--p)" stroke-width=".5" class="ep"/>`;
s+=tx(v.x+60,62,v.id,'var(--p)',6,'middle',1);
s+=tx(v.x+60,75,'LaserPLUS','var(--t2)',5,'middle');
s+=tx(v.x+60,87,'Zones: '+v.zone,'var(--t3)',4,'middle');
s+=`<text x="${v.x+60}" y="98" fill="var(--g)" font-family="${J}" font-size="4" text-anchor="middle" id="vd${vesdas.indexOf(v)}st">Status: NORMAL</text>`;
// Sampling pipes
for(let i=0;i<4;i++){
s+=`<line x1="${v.x+30+i*22}" y1="105" x2="${v.x+30+i*22}" y2="125" stroke="var(--p)" stroke-width=".5" stroke-dasharray="3 2"/>`;
s+=`<circle cx="${v.x+30+i*22}" cy="128" r="2" fill="none" stroke="var(--p)" stroke-width=".4"/>`;
}
s+=tx(v.x+60,140,'~100 sample pts','var(--t3)',4,'middle');
s+='</g>'});
// VESDA Panel
s+=`<rect x="580" y="50" width="40" height="90" rx="3" fill="rgba(139,92,246,.15)" stroke="var(--p)" stroke-width=".8"/>`;
s+=tx(600,70,'V','var(--p)',8,'middle',1);
s+=tx(600,85,'E','var(--p)',8,'middle',1);
s+=tx(600,100,'S','var(--p)',8,'middle',1);
s+=tx(600,115,'D','var(--p)',8,'middle',1);
s+=tx(600,130,'A','var(--p)',8,'middle',1);
// Connection to FACP
s+=fl(620,95,640,95,'var(--p)','fR',.6,1.5);
s+=tx(628,90,'SLC','var(--t3)',4,'middle');
// ===== FACP & ADDRESSABLE DETECTION =====
s+=`<rect x="640" y="25" width="310" height="135" rx="4" fill="rgba(245,158,11,.03)" stroke="rgba(245,158,11,.2)" stroke-width="1"/>`;
s+=tx(795,40,'FIRE ALARM CONTROL PANEL','var(--o)',7,'middle',1);
// Main FACP
s+=`<g data-tip="Fire Alarm Control Panel: Notifier NFS2-3030, 640 addressable points, 12 SLC loops, integrates smoke/heat/beam/VESDA detectors, BMS/SCADA interface">`;
s+=`<rect x="660" y="50" width="100" height="100" rx="4" fill="rgba(245,158,11,.12)" stroke="var(--o)" stroke-width="1"/>`;
s+=tx(710,68,'NOTIFIER','var(--o)',6,'middle',1);
s+=tx(710,80,'NFS2-3030','var(--o)',5,'middle');
s+=tx(710,95,'640 points','var(--t2)',5,'middle');
s+=tx(710,107,'12 SLC loops','var(--t2)',4,'middle');
s+=tx(710,120,'Status:','var(--t3)',4,'middle');
s+=`<rect x="693" y="125" width="34" height="12" rx="2" fill="rgba(34,197,94,.2)" stroke="var(--g)" stroke-width=".4" id="facpBox"/>`;
s+=`<text x="710" y="133" fill="var(--g)" font-family="${J}" font-size="4" text-anchor="middle" font-weight="600" id="facpSt">NORMAL</text>`;
s+='</g>';
// Detector types with P&ID symbols
s+=`<rect x="770" y="50" width="85" height="48" rx="3" fill="rgba(245,158,11,.06)" stroke="rgba(245,158,11,.3)" stroke-width=".6"/>`;
s+=symSmokeDet(790,70,'var(--o)');
s+=tx(835,65,'SMOKE','var(--o)',5,'middle',1);
s+=tx(835,78,'48× Photo','var(--t2)',4,'middle');
s+=tx(835,90,'Addressable','var(--t3)',3.5,'middle');
s+=`<rect x="860" y="50" width="85" height="48" rx="3" fill="rgba(239,68,68,.06)" stroke="rgba(239,68,68,.3)" stroke-width=".6"/>`;
s+=symHeatDet(880,70,'var(--r)');
s+=tx(922,65,'HEAT','var(--r)',5,'middle',1);
s+=tx(922,78,'24× RoR/Fix','var(--t2)',4,'middle');
s+=tx(922,90,'57°C setpt','var(--t3)',3.5,'middle');
s+=`<rect x="770" y="102" width="85" height="48" rx="3" fill="rgba(6,182,212,.06)" stroke="rgba(6,182,212,.3)" stroke-width=".6"/>`;
s+=symBeamDet(810,122,'var(--c)');
s+=tx(835,140,'2× Reflect','var(--t2)',4,'middle');
s+=`<rect x="860" y="102" width="85" height="48" rx="3" fill="rgba(236,72,153,.06)" stroke="rgba(236,72,153,.3)" stroke-width=".6"/>`;
// Linear Heat Cable symbol
s+=`<path d="M875 115 Q885 120 895 115 Q905 110 915 115 Q925 120 935 115" fill="none" stroke="var(--pk)" stroke-width="1.5" stroke-dasharray="none"/>`;
s+=`<circle cx="875" cy="115" r="2" fill="var(--pk)"/><circle cx="935" cy="115" r="2" fill="var(--pk)"/>`;
s+=tx(905,132,'LHC/DTS','var(--pk)',5,'middle',1);
s+=tx(905,142,'400m fiber','var(--t2)',4,'middle');
// ===== SUPPRESSION SYSTEM =====
s+=`<rect x="10" y="165" width="470" height="200" rx="4" fill="rgba(239,68,68,.03)" stroke="rgba(239,68,68,.2)" stroke-width="1"/>`;
s+=tx(245,180,'NOVEC 1230 SUPPRESSION SYSTEM — NFPA 2001 / ISO 14520','var(--r)',7,'middle',1);
// Cylinder bank
s+=`<g data-tip="Novec 1230 Cylinder Bank: 4\u00D7180L at 42bar N\u2082 superpressurization, 5.3% design concentration at 21\u00B0C, total 720L agent, NFPA 2001 / ISO 14520 compliant">`;
s+=`<rect x="25" y="195" width="130" height="155" rx="4" fill="rgba(239,68,68,.08)" stroke="var(--r)" stroke-width=".8"/>`;
s+=tx(90,210,'CYLINDER BANK','var(--r)',6,'middle',1);
for(let i=0;i<4;i++){
const cx=50+i*28,cy=260;
s+=`<rect x="${cx-10}" y="${cy-35}" width="20" height="70" rx="3" fill="rgba(239,68,68,.15)" stroke="var(--r)" stroke-width=".6"/>`;
s+=tx(cx,cy-25,'CYL','var(--t3)',4,'middle');
s+=tx(cx,cy-15,(i+1),'var(--r)',5,'middle',1);
s+=tx(cx,cy,'180L','var(--t3)',3.5,'middle');
s+=tx(cx,cy+10,'42bar','var(--o)',3.5,'middle');
s+=tx(cx,cy+25,'N₂','var(--c)',4,'middle');
// Pressure gauge
s+=`<circle cx="${cx}" cy="${cy+40}" r="5" fill="none" stroke="var(--g)" stroke-width=".5"/>`;
s+=tx(cx,cy+42,'P','var(--g)',4,'middle');
}
s+=tx(90,340,'Total: 720L | 5.3% design','var(--t2)',5,'middle');
s+='</g>';
// Piping network
s+=`<rect x="165" y="195" width="305" height="155" rx="4" fill="rgba(239,68,68,.05)" stroke="rgba(239,68,68,.15)" stroke-width=".5"/>`;
s+=tx(317,210,'DISTRIBUTION NETWORK','var(--r)',6,'middle',1);
// Main header
s+=`<line x1="175" y1="240" x2="460" y2="240" stroke="var(--r)" stroke-width="2"/>`;
s+=tx(317,235,'DN50 SS Sch40 Header','var(--t3)',4,'middle');
// Branch lines with nozzles
const nozzleX=[195,235,275,315,355,395,435];
nozzleX.forEach((nx,i)=>{
s+=`<line x1="${nx}" y1="240" x2="${nx}" y2="280" stroke="var(--r)" stroke-width="1.2"/>`;
s+=`<polygon points="${nx-6},280 ${nx+6},280 ${nx},295" fill="rgba(239,68,68,.3)" stroke="var(--r)" stroke-width=".5"/>`;
s+=tx(nx,305,'NZ-'+(i+1),'var(--t3)',4,'middle');
});
// Control components with P&ID symbols - NORMAL STATE
// ABORT button symbol
s+=`<g id="fireAbortG">`;
s+=`<rect x="175" y="310" width="55" height="38" rx="3" fill="rgba(245,158,11,.08)" stroke="var(--o)" stroke-width=".8"/>`;
s+=`<circle cx="202" cy="325" r="10" fill="rgba(245,158,11,.15)" stroke="var(--o)" stroke-width="1"/>`;
s+=`<rect x="198" y="321" width="8" height="8" rx="1" fill="var(--o)" opacity=".4"/>`;
s+=tx(202,343,'ABORT','var(--o)',4,'middle',1);
s+=`</g>`;
// RELEASE solenoid symbol
s+=`<g id="fireReleaseG">`;
s+=`<rect x="240" y="310" width="55" height="38" rx="3" fill="rgba(34,197,94,.08)" stroke="var(--g)" stroke-width=".8"/>`;
s+=symSolenoid(267,325,'var(--g)');
s+=`<circle cx="267" cy="315" r="3" fill="var(--g)" opacity=".7"><animate attributeName="opacity" values="0.4;1;0.4" dur="2s" repeatCount="indefinite"/></circle>`;
s+=tx(267,343,'ARMED','var(--g)',4,'middle',1);
s+=`</g>`;
// INTERLOCK - double zone requirement
s+=`<g id="fireInterlockG">`;
s+=`<rect x="305" y="310" width="65" height="38" rx="3" fill="rgba(34,197,94,.12)" stroke="var(--g)" stroke-width="1"/>`;
s+=`<circle cx="325" cy="325" r="6" fill="rgba(34,197,94,.2)" stroke="var(--g)" stroke-width=".6"/><text x="325" y="327" fill="var(--g)" font-family="${J}" font-size="5" text-anchor="middle">1</text>`;
s+=`<circle cx="350" cy="325" r="6" fill="rgba(34,197,94,.2)" stroke="var(--g)" stroke-width=".6"/><text x="350" y="327" fill="var(--g)" font-family="${J}" font-size="5" text-anchor="middle">2</text>`;
s+=`<line x1="331" y1="325" x2="344" y2="325" stroke="var(--g)" stroke-width=".8"/>`;
s+=tx(337,343,'INTERLOCK','var(--g)',4,'middle',1);
s+=`</g>`;
// DISCHARGE nozzle array symbol
s+=`<g id="fireDischargeG">`;
s+=`<rect x="380" y="310" width="85" height="38" rx="3" fill="rgba(34,197,94,.08)" stroke="var(--g)" stroke-width=".8"/>`;
s+=symNozzle(400,322,'var(--g)');
s+=symNozzle(422,322,'var(--g)');
s+=symNozzle(444,322,'var(--g)');
s+=tx(422,343,'READY','var(--g)',4,'middle',1);
s+=`</g>`;
// ===== ZONE MAP =====
s+=`<rect x="490" y="165" width="460" height="200" rx="4" fill="rgba(34,197,94,.03)" stroke="rgba(34,197,94,.2)" stroke-width="1"/>`;
s+=tx(720,180,'PROTECTION ZONE MAP — 12 ZONES','var(--g)',7,'middle',1);
// Zone grid 4x3
const zW=105,zH=52,zX=500,zY=190;
const zones=[
{id:'Z1',eq:'CDU 1-6',det:'V+4S',st:1},{id:'Z2',eq:'CDU 7-12',det:'V+4S',st:1},{id:'Z3',eq:'CDU 13-18',det:'V+4S',st:1},{id:'Z4',eq:'CDU 19-24',det:'V+4S',st:1},
{id:'Z5',eq:'Rack Row A-B',det:'V+S+H+L',st:1},{id:'Z6',eq:'Rack Row C-D',det:'V+S+H+L',st:1},{id:'Z7',eq:'Rack Row E-F',det:'V+S+H+L',st:1},{id:'Z8',eq:'Rack Row G-H',det:'V+S+H+L',st:1},
{id:'Z9',eq:'Elec Room A',det:'V+B+S',st:1},{id:'Z10',eq:'Elec Room B',det:'V+B+S',st:1},{id:'Z11',eq:'UPS+Batt',det:'V+H₂+S',st:1},{id:'Z12',eq:'MDF/Network',det:'V+6S',st:1}
];
zones.forEach((z,i)=>{
const col=i%4,row=Math.floor(i/4);
const x=zX+col*(zW+5),y=zY+row*(zH+4);
const stCol=z.st===1?'var(--g)':z.st===2?'var(--o)':'var(--r)';
s+=`<rect x="${x}" y="${y}" width="${zW}" height="${zH}" rx="3" fill="rgba(34,197,94,.06)" stroke="${stCol}" stroke-width=".7" id="zn${i}box"/>`;
s+=`<circle cx="${x+12}" cy="${y+12}" r="6" fill="rgba(34,197,94,.15)" stroke="${stCol}" stroke-width=".5" id="zn${i}circ"/>`;
s+=`<text x="${x+12}" y="${y+14}" fill="${stCol}" font-family="${J}" font-size="5" text-anchor="middle" font-weight="600" id="zn${i}id">${z.id}</text>`;
s+=tx(x+60,y+18,z.eq,'var(--t2)',5,'middle');
s+=tx(x+60,y+32,z.det,'var(--c)',4.5,'middle');
s+=`<rect x="${x+zW-35}" y="${y+zH-16}" width="30" height="11" rx="2" fill="rgba(34,197,94,.15)" stroke="${stCol}" stroke-width=".3" id="zn${i}stbox"/>`;
s+=`<text x="${x+zW-20}" y="${y+zH-8}" fill="${stCol}" font-family="${J}" font-size="4" text-anchor="middle" font-weight="600" id="zn${i}st">OK</text>`;
});
// ===== LEAK DETECTION =====
s+=`<rect x="10" y="370" width="310" height="130" rx="4" fill="rgba(6,182,212,.03)" stroke="rgba(6,182,212,.2)" stroke-width="1"/>`;
s+=tx(165,385,'WATER LEAK DETECTION SYSTEM','var(--c)',7,'middle',1);
// Leak controller
s+=`<g data-tip="Leak Detection Controller: TTK/RLE dedicated panel, 24 zones matching CDU layout, 800m rope sensor + 180 point sensors, &lt;3s alarm to BMS, auto motor valve shutoff">`;
s+=`<rect x="25" y="395" width="80" height="90" rx="3" fill="rgba(6,182,212,.1)" stroke="var(--c)" stroke-width=".8"/>`;
s+=tx(65,412,'LEAK','var(--c)',6,'middle',1);
s+=tx(65,425,'CTRL','var(--c)',6,'middle');
s+=tx(65,445,'TTK/RLE','var(--t2)',5,'middle');
s+=tx(65,458,'24 zones','var(--t3)',4,'middle');
s+=`<rect x="${40}" y="468" width="50" height="12" rx="2" fill="rgba(34,197,94,.2)" stroke="var(--g)" stroke-width=".4" id="leakBox"/>`;
s+=`<text x="65" y="476" fill="var(--g)" font-family="${J}" font-size="4" text-anchor="middle" font-weight="600" id="leakSt">CLEAR</text>`;
s+='</g>';
// Rope sensors
s+=`<rect x="115" y="395" width="95" height="90" rx="3" fill="rgba(6,182,212,.06)" stroke="rgba(6,182,212,.3)" stroke-width=".5"/>`;
s+=tx(162,410,'ROPE SENSOR','var(--c)',5,'middle',1);
s+=`<path d="M125,430 Q135,420 145,430 Q155,440 165,430 Q175,420 185,430 Q195,440 200,430" fill="none" stroke="var(--c)" stroke-width="1.5"/>`;
s+=tx(162,455,'800m total','var(--t2)',5,'middle');
s+=tx(162,470,'All piping runs','var(--t3)',4,'middle');
// Point sensors
s+=`<rect x="220" y="395" width="90" height="90" rx="3" fill="rgba(6,182,212,.06)" stroke="rgba(6,182,212,.3)" stroke-width=".5"/>`;
s+=tx(265,410,'POINT SENS','var(--c)',5,'middle',1);
for(let i=0;i<6;i++){s+=`<circle cx="${235+i*10}" cy="435" r="3" fill="none" stroke="var(--c)" stroke-width=".5"/><circle cx="${235+i*10}" cy="435" r="1" fill="var(--c)"/>`;}
s+=tx(265,455,'180 probes','var(--t2)',5,'middle');
s+=tx(265,470,'QD + valve pts','var(--t3)',4,'middle');
// ===== EPO & SAFETY with proper P&ID symbols =====
s+=`<rect x="330" y="370" width="310" height="130" rx="4" fill="rgba(239,68,68,.03)" stroke="rgba(239,68,68,.2)" stroke-width="1"/>`;
s+=tx(485,385,'EMERGENCY POWER OFF & SAFETY','var(--r)',7,'middle',1);
// EPO stations with proper symbols
const epos=[{x:350,id:'EPO-1',loc:'Exit N'},{x:410,id:'EPO-2',loc:'Exit S'},{x:470,id:'EPO-3',loc:'NOC'},{x:530,id:'EPO-4',loc:'Elec'},{x:590,id:'MCP-1',loc:'Hall'}];
epos.forEach((e,ei)=>{
if(ei<4){
s+=`<g data-tip="Emergency Power Off ${e.id}: Dual-confirm (key + button), shunt-trips all breakers, location: ${e.loc}">`;
s+=symEPO(e.x+25,418,'var(--r)');
s+=tx(e.x+25,445,e.loc,'var(--t3)',3.5,'middle');s+='</g>';
}else{
s+=`<g data-tip="Manual Call Point ${e.id}: Break-glass fire alarm activation, direct FACP zone trigger, location: ${e.loc}">`;
s+=symMCP(e.x+25,418,'var(--r)');
s+=tx(e.x+25,445,e.loc,'var(--t3)',3.5,'middle');s+='</g>';
}
});
s+=tx(485,458,'Dual-Confirm: Key + Button | Shunt trip breakers','var(--t2)',4.5,'middle');
// Safety integration with symbols
s+=`<rect x="345" y="468" width="135" height="28" rx="2" fill="rgba(34,197,94,.08)" stroke="var(--g)" stroke-width=".5"/>`;
s+=`<polygon points="355,482 365,475 365,489" fill="var(--g)" opacity=".4"/>`;
s+=tx(420,480,'HVAC Damper','var(--t2)',4.5,'middle');
s+=tx(420,490,'Auto Close','var(--g)',3.5,'middle');
s+=`<rect x="490" y="468" width="145" height="28" rx="2" fill="rgba(245,158,11,.08)" stroke="var(--o)" stroke-width=".5"/>`;
s+=`<rect x="500" y="475" width="8" height="14" rx="1" fill="var(--o)" opacity=".4"/>`;
s+=tx(565,480,'Mag Door Hold','var(--t2)',4.5,'middle');
s+=tx(565,490,'Release','var(--o)',3.5,'middle');
// ===== BMS INTEGRATION =====
s+=`<rect x="650" y="370" width="300" height="130" rx="4" fill="rgba(59,130,246,.03)" stroke="rgba(59,130,246,.2)" stroke-width="1"/>`;
s+=tx(800,385,'BMS/DCIM INTEGRATION','var(--b)',7,'middle',1);
// Integration diagram
s+=`<rect x="665" y="400" width="70" height="35" rx="3" fill="rgba(139,92,246,.1)" stroke="var(--p)" stroke-width=".5"/>`;
s+=tx(700,420,'VESDA','var(--p)',5,'middle');
s+=`<rect x="665" y="445" width="70" height="35" rx="3" fill="rgba(245,158,11,.1)" stroke="var(--o)" stroke-width=".5"/>`;
s+=tx(700,465,'FACP','var(--o)',5,'middle');
s+=fl(735,417,780,417,'var(--p)','fR',.5,1);
s+=fl(735,462,780,462,'var(--o)','fR',.5,1);
s+=`<rect x="780" y="405" width="80" height="70" rx="4" fill="rgba(59,130,246,.12)" stroke="var(--b)" stroke-width=".8"/>`;
s+=tx(820,430,'BMS/SCADA','var(--b)',6,'middle',1);
s+=tx(820,445,'Modbus TCP','var(--t2)',4,'middle');
s+=tx(820,458,'BACnet/IP','var(--t2)',4,'middle');
s+=fl(860,440,900,420,'var(--b)','fR',.5,1);
s+=fl(860,450,900,460,'var(--b)','fR',.5,1);
s+=`<rect x="900" y="405" width="45" height="25" rx="2" fill="rgba(34,197,94,.1)" stroke="var(--g)" stroke-width=".5"/>`;
s+=tx(922,420,'NOC','var(--g)',5,'middle');
s+=`<rect x="900" y="445" width="45" height="25" rx="2" fill="rgba(239,68,68,.1)" stroke="var(--r)" stroke-width=".5"/>`;
s+=tx(922,460,'SMS','var(--r)',5,'middle');
// ===== LEGEND =====
s+=`<rect x="10" y="505" width="940" height="70" rx="4" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(480,520,'P&ID LEGEND & EQUIPMENT SYMBOLS','var(--t3)',7,'middle',1);
const legends=[
{x:25,sym:'V',c:'var(--p)',t:'VESDA Aspirating'},{x:130,sym:'S',c:'var(--o)',t:'Smoke Detector'},
{x:235,sym:'H',c:'var(--r)',t:'Heat Detector'},{x:340,sym:'B',c:'var(--c)',t:'Beam Detector'},
{x:445,sym:'L',c:'var(--pk)',t:'LHC/DTS Fiber'},{x:550,sym:'M',c:'var(--g)',t:'Manual Call Point'},
{x:655,sym:'N',c:'var(--r)',t:'Nozzle 360°'},{x:760,sym:'C',c:'var(--r)',t:'Cylinder N₂'},
{x:865,sym:'E',c:'var(--r)',t:'EPO Station'}
];
legends.forEach(l=>{
s+=`<circle cx="${l.x+12}" cy="545" r="8" fill="none" stroke="${l.c}" stroke-width=".6"/>`;
s+=tx(l.x+12,548,l.sym,l.c,6,'middle',1);
s+=tx(l.x+55,548,l.t,'var(--t2)',5,'middle');
});
// Status indicators
s+=tx(25,565,'Zone Status:','var(--t3)',5,0,1);
s+=`<rect x="90" y="556" width="40" height="14" rx="2" fill="rgba(34,197,94,.2)" stroke="var(--g)" stroke-width=".4"/>`;
s+=tx(110,565,'OK','var(--g)',5,'middle');
s+=`<rect x="140" y="556" width="50" height="14" rx="2" fill="rgba(245,158,11,.2)" stroke="var(--o)" stroke-width=".4"/>`;
s+=tx(165,565,'ALERT','var(--o)',5,'middle');
s+=`<rect x="200" y="556" width="50" height="14" rx="2" fill="rgba(239,68,68,.2)" stroke="var(--r)" stroke-width=".4"/>`;
s+=tx(225,565,'ALARM','var(--r)',5,'middle');
s+=tx(280,565,'│ Flow:','var(--t3)',5,0,1);
s+=`<line x1="315" y1="562" x2="355" y2="562" stroke="var(--c)" stroke-width="1.5" class="fR"/>`;
s+=tx(365,565,'Agent','var(--t2)',5);
s+=`<line x1="400" y1="562" x2="440" y2="562" stroke="var(--p)" stroke-width="1" stroke-dasharray="3 2"/>`;
s+=tx(450,565,'Sample','var(--t2)',5);
el.innerHTML=s;
// FIRE SYSTEM LIVE DATA
let fireAlarmActive=false;
setInterval(()=>{
// Update VESDA detectors with varying sensitivity levels
for(let i=0;i<4;i++){
const vdst=$('vd'+i+'st');
if(vdst){
const obs=(Math.random()*0.003).toFixed(4);
vdst.textContent='Obs: '+obs+'%/m';
vdst.style.fill=parseFloat(obs)<0.002?'var(--g)':'var(--c)';
}
}
// Occasional fire alarm simulation (2% chance)
if(!fireAlarmActive&&Math.random()<0.02){
fireAlarmActive=true;
const alertZone=RI(0,11);
const zbox=$('zn'+alertZone+'box'),zcirc=$('zn'+alertZone+'circ'),zid=$('zn'+alertZone+'id'),zstbox=$('zn'+alertZone+'stbox'),zst=$('zn'+alertZone+'st');
const facp=$('facpSt'),facpB=$('facpBox');
if(zbox){zbox.style.stroke='var(--o)';zbox.style.fill='rgba(245,158,11,.1)';}
if(zcirc){zcirc.style.stroke='var(--o)';zcirc.style.fill='rgba(245,158,11,.2)';}
if(zid)zid.style.fill='var(--o)';
if(zstbox){zstbox.style.stroke='var(--o)';zstbox.style.fill='rgba(245,158,11,.2)';}
if(zst){zst.textContent='ALERT';zst.style.fill='var(--o)';}
if(facp){facp.textContent='ALERT Z'+(alertZone+1);facp.style.fill='var(--o)';}
if(facpB){facpB.style.stroke='var(--o)';facpB.style.fill='rgba(245,158,11,.2)';}
// Auto-recover after 5 seconds
setTimeout(()=>{
if(zbox){zbox.style.stroke='var(--g)';zbox.style.fill='rgba(34,197,94,.06)';}
if(zcirc){zcirc.style.stroke='var(--g)';zcirc.style.fill='rgba(34,197,94,.15)';}
if(zid)zid.style.fill='var(--g)';
if(zstbox){zstbox.style.stroke='var(--g)';zstbox.style.fill='rgba(34,197,94,.15)';}
if(zst){zst.textContent='OK';zst.style.fill='var(--g)';}
if(facp){facp.textContent='NORMAL';facp.style.fill='var(--g)';}
if(facpB){facpB.style.stroke='var(--g)';facpB.style.fill='rgba(34,197,94,.2)';}
fireAlarmActive=false;
},5000);
}
// Leak detection occasional alert (1% chance)
const leakB=$('leakBox'),leakS=$('leakSt');
if(leakB&&leakS&&Math.random()<0.01){
leakB.style.stroke='var(--o)';leakB.style.fill='rgba(245,158,11,.2)';
leakS.textContent='CHECK';leakS.style.fill='var(--o)';
setTimeout(()=>{
leakB.style.stroke='var(--g)';leakB.style.fill='rgba(34,197,94,.2)';
leakS.textContent='CLEAR';leakS.style.fill='var(--g)';
},4000);
}
},3000);
})();
// DC DASHBOARD — 4× DATA HALLS with DC Image + Callouts
if($('dashSu'))$('dashSu').textContent='4× AI Data Halls | 28.5 MW IT | 7,776 GPU | PUE 1.08 | WUE 0.42 L/kWh | CUE 0.38 kgCO₂/kWh';
(function(){
// DC Image Callouts - READABLE SIZES
const callEl=$('dcCallouts');
if(callEl){
const callouts=[
{x:'2%',y:'3%',l:'PUE',v:'1.08',c:'var(--g)',id:'dcPUE'},
{x:'2%',y:'16%',l:'WUE',v:'0.42',c:'var(--c)',id:'dcWUE'},
{x:'2%',y:'29%',l:'CUE',v:'0.38',c:'var(--p)',id:'dcCUE'},
{x:'2%',y:'42%',l:'IT Load',v:'28.5MW',c:'var(--o)',id:'dcIT'},
{x:'75%',y:'3%',l:'GPUs',v:'7,776',c:'var(--g)',id:'dcGPU'},
{x:'75%',y:'16%',l:'NVL72',v:'108',c:'var(--pk)',id:'dcDom'},
{x:'75%',y:'29%',l:'Outdoor',v:'32°C',c:'var(--o)',id:'dcOut'},
{x:'75%',y:'42%',l:'Humidity',v:'75%',c:'var(--c)',id:'dcRH'},
{x:'2%',y:'82%',l:'Seismic',v:'Zone 4',c:'var(--r)'},
{x:'30%',y:'82%',l:'Wind',v:'12m/s',c:'var(--b)',id:'dcWind'},
{x:'55%',y:'82%',l:'Floor',v:'3.5t/m²',c:'var(--t2)'},
{x:'75%',y:'82%',l:'Uptime',v:'99.99%',c:'var(--g)'}
];
let ch='';
callouts.forEach(c=>{
ch+=`<div style="position:absolute;left:${c.x};top:${c.y};background:rgba(5,8,16,.9);border:1px solid ${c.c};border-radius:6px;padding:6px 10px;backdrop-filter:blur(6px)">
<div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px">${c.l}</div>
<div style="font-family:'JetBrains Mono';font-size:16px;font-weight:700;color:${c.c}" ${c.id?'id="'+c.id+'"':''}>${c.v}</div>
</div>`;
});
callEl.innerHTML=ch;
}
// Dashboard KPI Updates
function updateDashKPI(){
const pue=R(1.06,1.10),wue=R(0.40,0.45),cue=R(0.36,0.40);
const el=id=>$(id);
if(el('dkPue'))el('dkPue').textContent=pue;
if(el('dkWue'))el('dkWue').textContent=wue;
if(el('dkCue'))el('dkCue').textContent=cue;
if(el('dkIt'))el('dkIt').textContent=R(27.8,29.2);
if(el('dkTcs'))el('dkTcs').textContent=R(34.5,35.8)+'°C';
if(el('dkTcr'))el('dkTcr').textContent=R(44.2,45.5)+'°C';
if(el('dkPpl'))el('dkPpl').textContent=RI(0,8)+' Inside';
if(el('dkEntry')){const now=new Date();el('dkEntry').textContent=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0')}
if(el('dkAlm'))el('dkAlm').textContent=RI(0,2);
// Update image callouts
if(el('dcPUE'))el('dcPUE').textContent=pue;
if(el('dcWUE'))el('dcWUE').textContent=wue;
if(el('dcCUE'))el('dcCUE').textContent=cue;
if(el('dcOut'))el('dcOut').textContent=RI(30,35)+'°C';
if(el('dcRH'))el('dcRH').textContent=RI(65,80)+'%';
if(el('dcWind'))el('dcWind').textContent=RI(8,15)+'m/s';
}
updateDashKPI();
setInterval(updateDashKPI,4000);
})();

// Legacy code compatibility - keep dashC empty
(function(){const el=$('dashC');if(!el)return;
const H={it:7128,cool:7130,pue:1.08,gpu:1944,dom:27};
const F={halls:4,it:H.it*4,cool:H.cool*4,total:H.it*4*H.pue,gpu:H.gpu*4,dom:H.dom*4};
const WUE=0.42,CUE=0.38,annualHrs=8760;
const waterAnnual=F.it*annualHrs*WUE/1000000;
const carbonAnnual=F.total*annualHrs*CUE/1000;
s+=`<rect width="400" height="420" fill="var(--bg2)"/>`;
s+=tx(200,14,'LIVE METRICS — 4× HALLS','var(--t3)',7,'middle',1);
// 4 Hall status cards (2x2) - COMPACT
const halls=[{id:'A',st:'RUN'},{id:'B',st:'RUN'},{id:'C',st:'RUN'},{id:'D',st:'RUN'}];
halls.forEach((h,i)=>{
const hx=5+(i%2)*198,hy=22+Math.floor(i/2)*62;
s+=`<rect x="${hx}" y="${hy}" width="193" height="58" rx="3" fill="var(--bg3)" stroke="rgba(34,197,94,.3)" stroke-width=".7"/>`;
s+=tx(hx+97,hy+12,'HALL-'+h.id,'var(--g)',7,'middle',1);
s+=`<rect x="${hx+62}" y="${hy+15}" width="70" height="10" rx="2" fill="rgba(34,197,94,.15)" stroke="var(--g)" stroke-width=".3"/>`;
s+=tx(hx+97,hy+22,'OPERATIONAL','var(--g)',4,'middle');
s+=tx(hx+8,hy+36,'IT:','var(--t3)',4.5);s+=`<text x="${hx+38}" y="${hy+36}" fill="var(--o)" font-family="${J}" font-size="5.5" id="dH${i}IT">7,128kW</text>`;
s+=tx(hx+100,hy+36,'PUE:','var(--t3)',4.5);s+=`<text x="${hx+130}" y="${hy+36}" fill="var(--g)" font-family="${J}" font-size="5.5" id="dH${i}PUE">1.08</text>`;
s+=tx(hx+8,hy+48,'GPU:','var(--t3)',4.5);s+=`<text x="${hx+38}" y="${hy+48}" fill="var(--g)" font-family="${J}" font-size="5.5">1,944</text>`;
s+=tx(hx+100,hy+48,'ΔT:','var(--t3)',4.5);s+=`<text x="${hx+130}" y="${hy+48}" fill="var(--c)" font-family="${J}" font-size="5.5" id="dH${i}DT">9.6°C</text>`;
});
// Totals section - COMPACT
s+=`<rect x="5" y="148" width="390" height="50" rx="3" fill="rgba(245,158,11,.03)" stroke="rgba(245,158,11,.2)" stroke-width=".8"/>`;
s+=tx(200,160,'CAMPUS TOTALS','var(--o)',6,'middle',1);
const tots=[
{l:'IT',v:'28.5MW',c:'var(--o)',id:'dTotIT'},{l:'Fac',v:'30.8MW',c:'var(--o)',id:'dTotFac'},
{l:'GPU',v:'7,776',c:'var(--g)'},{l:'NVL72',v:'108',c:'var(--pk)'},
{l:'PUE',v:'1.08',c:'var(--g)',id:'dTotPUE'},{l:'Up',v:'99.99%',c:'var(--g)'}
];
tots.forEach((t,i)=>{
const tx2=12+i*65,ty=180;
s+=tx(tx2,ty,t.l+':','var(--t3)',4);
s+=`<text x="${tx2+40}" y="${ty}" fill="${t.c}" font-family="${J}" font-size="5" font-weight="600" ${t.id?'id="'+t.id+'"':''}>${t.v}</text>`;
});
// Environmental + Outdoor in one row
s+=`<rect x="5" y="202" width="192" height="68" rx="3" fill="rgba(6,182,212,.03)" stroke="rgba(6,182,212,.2)" stroke-width=".8"/>`;
s+=tx(100,214,'SUSTAINABILITY','var(--c)',5.5,'middle',1);
const sust=[
{l:'WUE',v:'0.42',c:'var(--c)',id:'dWUE'},{l:'H₂O/yr',v:Math.round(waterAnnual)+'ML',c:'var(--c)'},
{l:'CUE',v:'0.38',c:'var(--p)',id:'dCUE'},{l:'CO₂/yr',v:Math.round(carbonAnnual/1000)+'kt',c:'var(--p)'},
{l:'Green',v:'45%',c:'var(--g)'},{l:'Grid',v:'0.70',c:'var(--t2)'}
];
sust.forEach((su,i)=>{
const sx=12+(i%3)*62,sy=228+Math.floor(i/3)*18;
s+=tx(sx,sy,su.l+':','var(--t3)',4);
s+=`<text x="${sx+45}" y="${sy}" fill="${su.c}" font-family="${J}" font-size="5" text-anchor="end" ${su.id?'id="'+su.id+'"':''}>${su.v}</text>`;
});
s+=`<rect x="203" y="202" width="192" height="68" rx="3" fill="rgba(139,92,246,.03)" stroke="rgba(139,92,246,.2)" stroke-width=".8"/>`;
s+=tx(300,214,'OUTDOOR','var(--p)',5.5,'middle',1);
const outd=[
{l:'Temp',v:'32°C',c:'var(--o)',id:'dOutT'},{l:'RH',v:'75%',c:'var(--c)',id:'dOutH'},{l:'Wind',v:'8m/s',c:'var(--b)',id:'dOutW'},
{l:'WB',v:'28°C',c:'var(--c)'},{l:'Seis',v:'Z4',c:'var(--r)'},{l:'Pr',v:'1013hPa',c:'var(--t2)'}
];
outd.forEach((od,i)=>{
const ox=210+(i%3)*62,oy=228+Math.floor(i/3)*18;
s+=tx(ox,oy,od.l+':','var(--t3)',4);
s+=`<text x="${ox+48}" y="${oy}" fill="${od.c}" font-family="${J}" font-size="5" text-anchor="end" ${od.id?'id="'+od.id+'"':''}>${od.v}</text>`;
});
// Power + Cooling in one row
s+=`<rect x="5" y="274" width="192" height="65" rx="3" fill="rgba(245,158,11,.03)" stroke="rgba(245,158,11,.2)" stroke-width=".8"/>`;
s+=tx(100,286,'POWER','var(--o)',5.5,'middle',1);
const pwr=[['UPS','36MW'],['Gen','10MW'],['Sub','2×40MVA'],['2N','N+1']];
pwr.forEach((p,i)=>{const px=12+(i%2)*95,py=300+Math.floor(i/2)*16;s+=tx(px,py,p[0]+':','var(--t3)',4);s+=`<text x="${px+55}" y="${py}" fill="var(--g)" font-family="${J}" font-size="5" text-anchor="end">${p[1]}</text>`;});
s+=`<rect x="203" y="274" width="192" height="65" rx="3" fill="rgba(6,182,212,.03)" stroke="rgba(6,182,212,.2)" stroke-width=".8"/>`;
s+=tx(300,286,'COOLING','var(--c)',5.5,'middle',1);
const cool=[['DLC','24MW'],['Air','4MW'],['CH','16×2.5'],['CDU','96']];
cool.forEach((c,i)=>{const cx=210+(i%2)*95,cy=300+Math.floor(i/2)*16;s+=tx(cx,cy,c[0]+':','var(--t3)',4);s+=`<text x="${cx+55}" y="${cy}" fill="var(--c)" font-family="${J}" font-size="5" text-anchor="end">${c[1]}</text>`;});
// System status - compact
s+=`<rect x="5" y="343" width="390" height="72" rx="3" fill="var(--bg3)" stroke="var(--bd2)" stroke-width=".5"/>`;
s+=tx(200,355,'SYSTEM STATUS','var(--g)',6,'middle',1);
const alarms=[
{l:'Fire',v:'NORMAL',c:'var(--g)'},{l:'Leak',v:'CLEAR',c:'var(--g)'},{l:'UPS',v:'ON',c:'var(--g)'},
{l:'Gen',v:'STBY',c:'var(--g)'},{l:'Cool',v:'RUN',c:'var(--g)'},{l:'Net',v:'UP',c:'var(--g)'},
{l:'BMS',v:'OK',c:'var(--g)'},{l:'Secu',v:'OK',c:'var(--g)'},{l:'EPO',v:'SAFE',c:'var(--g)'}
];
alarms.forEach((a,i)=>{
const ax=12+(i%3)*130,ay=370+Math.floor(i/3)*14;
s+=tx(ax,ay,a.l+':','var(--t3)',4);
s+=`<text x="${ax+42}" y="${ay}" fill="${a.c}" font-family="${J}" font-size="4.5" font-weight="600">${a.v}</text>`;
});
el.innerHTML=s;
// Live updates - COMPACT
setInterval(()=>{
// DC Callouts (shorter format)
const dcP=$('dcPUE');if(dcP)dcP.textContent=R(1.06,1.10);
const dcW=$('dcWUE');if(dcW)dcW.textContent=R(0.40,0.45);
const dcC=$('dcCUE');if(dcC)dcC.textContent=R(0.36,0.40);
const dcI=$('dcIT');if(dcI)dcI.textContent=R(28.0,28.6)+'MW';
const dcO=$('dcOut');if(dcO)dcO.textContent=RI(30,35)+'°C';
const dcR=$('dcRH');if(dcR)dcR.textContent=RI(65,85)+'%';
const dcWi=$('dcWind');if(dcWi)dcWi.textContent=RI(5,15)+'m/s';
// Hall metrics (compact)
for(let i=0;i<4;i++){
const hI=$('dH'+i+'IT');if(hI)hI.textContent=(7000+RI(0,200))+'kW';
const hP=$('dH'+i+'PUE');if(hP)hP.textContent=R(1.06,1.10);
const hD=$('dH'+i+'DT');if(hD)hD.textContent=R(9.2,10.2)+'°C';
}
// Totals (compact)
const tI=$('dTotIT');if(tI)tI.textContent=R(28.0,28.6)+'MW';
const tP=$('dTotPUE');if(tP)tP.textContent=R(1.06,1.10);
// Outdoor
const oT=$('dOutT');if(oT)oT.textContent=RI(30,35)+'°C';
const oH=$('dOutH');if(oH)oH.textContent=RI(65,85)+'%';
const oW=$('dOutW');if(oW)oW.textContent=RI(5,15)+'m/s';
},5000);
})();
// Dashboard Cards (moved to right panel, keeping for compatibility)
if($('dashCards'))$('dashCards').innerHTML=[
mc('var(--t2)','Floor Slab-on-Grade','No Raised Floor',[['Type','Post-tensioned RC slab'],['Thickness','300mm + 150mm sub-base'],['Live load','\u22653,500 kg/m\u00B2'],['Point load','\u22651,500 kg per foot'],['Concrete','C40/50 (40 MPa)'],['Finish','Epoxy ESD conductive'],['ESD','<1M\u03A9 (IEC 61340)'],['Flatness','FM2 / DIN 18202'],['Drain','Trapped 1:100 under CDU'],['Membrane','2mm PU waterproof']]),
mc('var(--o)','Seismic Zone 4','SNI 1726:2019',[['Zone','4 (high seismicity)'],['Building','SMRF moment frame'],['Rack','M16 anchor \u226550kN shear'],['Brace','Top-of-rack to ceiling'],['Tray','Lateral+long brace @6m'],['Busway','Seismic hanger + exp joint'],['Piping','Brace @3m + flex joint'],['CDU','Anti-vib + M12 anchor'],['Chiller','Spring + snubber'],['Standard','SNI 1726 + ASCE 7-22']]),
mc('var(--c)','Environmental','ASHRAE A1 + DLC',[['Dry bulb','18-27\u00B0C'],['Humidity','20-80% RH'],['TCS supply','35\u00B0C \u00B12\u00B0C'],['TCS return','45\u00B0C max'],['Filtration','MERV 11 min'],['Pressure','+5 to +10 Pa positive'],['Particulate','ISO 14644-1 Class 8'],['Vibration','<0.5 mm/s RMS'],['Noise','<85 dBA at 1m'],['Lighting','500 lux LED 4000K']]),
mc('var(--p)','Hall Layout','Dimensions (DLC-Adapted)',[['Size','32m\u00D720m (640m\u00B2)'],['Height','4.2m clear'],['Floor','Slab-on-grade (no raised floor)'],['Hot aisle','1.2m contained'],['Cold aisle','1.2m supply air'],['End-of-row','1.5m CDU + walkway'],['CDU','2\u00D7 EoR per row-pair (6 total)'],['TCS routing','Overhead \u2192 vertical riser \u2192 CDU \u2192 rack'],['Elec room','80m\u00B2 adjacent'],['Emergency exit','2\u00D7 opposite corners']])
].join('');
// BMS ARCHITECTURE DIAGRAM - Ring Topology with Field to Server
$('bmsSu').textContent='Field Devices → Gateways → PLC/DDC → Ring Network → Redundant Servers (MMR01/MMR02) → DCIM/SCADA';
(function(){const el=$('bmsC');if(!el)return;let s='';
s+=`<rect width="960" height="480" fill="var(--bg2)"/>`;
s+=`<pattern id="bmsGrid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M20 0L0 0 0 20" fill="none" stroke="rgba(255,255,255,.015)" stroke-width=".3"/></pattern>`;
s+=`<rect width="960" height="480" fill="url(#bmsGrid)"/>`;
s+=tx(480,16,'BMS/DCIM ARCHITECTURE — RING TOPOLOGY — REDUNDANT SERVERS','var(--t3)',8,'middle',1);
// ===== FIELD LAYER (Bottom) =====
s+=`<rect x="10" y="380" width="940" height="90" rx="4" fill="rgba(34,197,94,.03)" stroke="rgba(34,197,94,.2)" stroke-width="1"/>`;
s+=tx(480,395,'FIELD LAYER — SENSORS & ACTUATORS','var(--g)',7,'middle',1);
const fieldDevs=[
{x:30,t:'TTHT',n:'48×',c:'var(--g)',d:'Temp/Humidity'},{x:100,t:'kWh',n:'96×',c:'var(--o)',d:'Power Meter'},
{x:170,t:'P/T',n:'64×',c:'var(--c)',d:'Press/Temp'},{x:240,t:'Flow',n:'24×',c:'var(--c)',d:'Flow Meter'},
{x:310,t:'VFD',n:'32×',c:'var(--p)',d:'Drives'},{x:380,t:'Vlv',n:'48×',c:'var(--b)',d:'Valves'},
{x:450,t:'CDU',n:'24×',c:'var(--c)',d:'CDU Ctrl'},{x:520,t:'UPS',n:'12×',c:'var(--o)',d:'UPS/Batt'},
{x:590,t:'Gen',n:'4×',c:'var(--r)',d:'GenSet'},{x:660,t:'FACP',n:'2×',c:'var(--r)',d:'Fire Panel'},
{x:730,t:'VESDA',n:'4×',c:'var(--p)',d:'Aspirating'},{x:800,t:'Leak',n:'24×',c:'var(--c)',d:'Leak Det'},
{x:870,t:'Access',n:'8×',c:'var(--pk)',d:'Door/CCTV'}
];
fieldDevs.forEach(f=>{
s+=`<g data-tip="${f.d}: ${f.n} field devices \u2014 ${f.t} sensors/actuators connected via gateway to BMS network">`;
s+=`<rect x="${f.x}" y="408" width="60" height="55" rx="2" fill="rgba(34,197,94,.08)" stroke="${f.c}" stroke-width=".6"/>`;
s+=`<circle cx="${f.x+30}" cy="423" r="8" fill="rgba(34,197,94,.15)" stroke="${f.c}" stroke-width=".5"/>`;
s+=tx(f.x+30,426,f.t,f.c,4.5,'middle',1);
s+=tx(f.x+30,442,f.n,'var(--t2)',4.5,'middle');
s+=tx(f.x+30,455,f.d,'var(--t3)',3.5,'middle');
s+='</g>'});
// ===== GATEWAY/PROTOCOL LAYER =====
s+=`<rect x="10" y="290" width="940" height="80" rx="4" fill="rgba(59,130,246,.03)" stroke="rgba(59,130,246,.2)" stroke-width="1"/>`;
s+=tx(480,305,'GATEWAY & PROTOCOL CONVERSION LAYER','var(--b)',7,'middle',1);
const gateways=[
{x:50,t:'Modbus RTU',n:'GW-01~04',p:'RS485 → TCP'},{x:180,t:'Modbus TCP',n:'GW-05~08',p:'Native IP'},
{x:310,t:'BACnet MS/TP',n:'GW-09~12',p:'RS485 → IP'},{x:440,t:'BACnet/IP',n:'Native',p:'UDP/47808'},
{x:570,t:'SNMP v3',n:'Network',p:'UDP/161-162'},{x:700,t:'OPC-UA',n:'GW-13~14',p:'TCP/4840'},
{x:830,t:'REST API',n:'Cloud GW',p:'HTTPS/443'}
];
gateways.forEach(g=>{
s+=`<g data-tip="${g.t}: ${g.n} \u2014 Protocol conversion ${g.p}, connects field devices to PLC/DDC controllers via IP network">`;
s+=`<rect x="${g.x}" y="318" width="110" height="45" rx="3" fill="rgba(59,130,246,.1)" stroke="var(--b)" stroke-width=".7"/>`;
s+=tx(g.x+55,332,g.t,'var(--b)',5,'middle',1);
s+=tx(g.x+55,345,g.n,'var(--t2)',4,'middle');
s+=tx(g.x+55,357,g.p,'var(--t3)',3.5,'middle');
s+='</g>'});
// Vertical connections from field to gateway with flowing animation
for(let i=0;i<13;i++){
const fx=60+i*70;
s+=`<line x1="${fx}" y1="408" x2="${fx}" y2="363" stroke="var(--g)" stroke-width="1" stroke-dasharray="4 3" opacity=".5"><animate attributeName="stroke-dashoffset" values="0;-14" dur="${1.2+i*0.08}s" repeatCount="indefinite"/></line>`;
}
// ===== PLC/DDC LAYER =====
s+=`<rect x="10" y="195" width="940" height="85" rx="4" fill="rgba(139,92,246,.03)" stroke="rgba(139,92,246,.2)" stroke-width="1"/>`;
s+=tx(480,210,'PLC / DDC / ASP CONTROLLERS','var(--p)',7,'middle',1);
const plcs=[
{x:40,t:'ASP-01',s:'HVAC Hall A',c:'Siemens S7'},{x:160,t:'ASP-02',s:'HVAC Hall B',c:'Siemens S7'},
{x:280,t:'DDC-01',s:'Chiller Plant',c:'JCI N2'},{x:400,t:'DDC-02',s:'Cooling Tower',c:'JCI N2'},
{x:520,t:'PLC-01',s:'Power Mon A',c:'Modicon'},{x:640,t:'PLC-02',s:'Power Mon B',c:'Modicon'},
{x:760,t:'DDC-03',s:'Fire/Safety',c:'Notifier'},{x:880,t:'ASP-03',s:'Access/CCTV',c:'Lenel'}
];
plcs.forEach(p=>{
s+=`<g data-tip="${p.t}: ${p.c} controller for ${p.s}. Modbus TCP/BACnet gateway, redundant network connection via fiber ring.">`;
s+=`<rect x="${p.x}" y="225" width="105" height="48" rx="3" fill="rgba(139,92,246,.12)" stroke="var(--p)" stroke-width=".8"/>`;
s+=tx(p.x+52,240,p.t,'var(--p)',6,'middle',1);
s+=tx(p.x+52,253,p.s,'var(--t2)',4.5,'middle');
s+=tx(p.x+52,265,p.c,'var(--t3)',3.5,'middle');
// Status LED
s+=`<circle cx="${p.x+95}" cy="232" r="3" fill="var(--g)"><animate attributeName="opacity" values="0.4;1;0.4" dur="1.5s" repeatCount="indefinite"/></circle>`;
s+='</g>'});
// Connections from gateway to PLC with flowing animation
s+=`<line x1="480" y1="318" x2="480" y2="273" stroke="var(--b)" stroke-width="1.5" stroke-dasharray="5 3"><animate attributeName="stroke-dashoffset" values="0;-16" dur="1.5s" repeatCount="indefinite"/></line>`;
// ===== RING NETWORK =====
// Ring ellipse drawn first (behind the blocks)
s+=`<ellipse cx="480" cy="145" rx="400" ry="35" fill="none" stroke="var(--o)" stroke-width="2" stroke-dasharray="8 4"><animate attributeName="stroke-dashoffset" values="0;-24" dur="2s" repeatCount="indefinite"/></ellipse>`;
s+=tx(480,120,'REDUNDANT FIBER RING — 10GbE — RSTP/MRP','var(--o)',6,'middle',1);
// Ring nodes (switches) - drawn on TOP of ring line
const ringNodes=[{x:80,l:'SW-01'},{x:210,l:'SW-02'},{x:340,l:'SW-03'},{x:480,l:'CORE'},{x:620,l:'SW-04'},{x:750,l:'SW-05'},{x:880,l:'SW-06'}];
ringNodes.forEach((rn,ri)=>{
const isCore=rn.l==='CORE';
// White background to cover ring line behind block
s+=`<rect x="${rn.x-27}" y="133" width="54" height="26" rx="3" fill="var(--bg2)"/>`;
s+=`<rect x="${rn.x-25}" y="135" width="50" height="22" rx="2" fill="${isCore?'rgba(245,158,11,.25)':'rgba(245,158,11,.12)'}" stroke="var(--o)" stroke-width="${isCore?'1.5':'.8'}"/>`;
s+=tx(rn.x,148,rn.l,'var(--o)',isCore?6:4.5,'middle',1);
// Status indicator - ONLY PULSE/GLOW, NOT MOVE
s+=`<circle cx="${rn.x+18}" cy="140" r="3" fill="var(--g)"><animate attributeName="opacity" values="0.4;1;0.4" dur="${1.5+ri*0.1}s" repeatCount="indefinite"/><animate attributeName="r" values="2.5;3.5;2.5" dur="${1.5+ri*0.1}s" repeatCount="indefinite"/></circle>`;
});
// Connections from PLC to ring with flowing animation
for(let i=0;i<8;i++){
const px=92+i*120;
s+=`<line x1="${px}" y1="225" x2="${px}" y2="157" stroke="var(--p)" stroke-width="1" stroke-dasharray="5 3" opacity=".6"><animate attributeName="stroke-dashoffset" values="0;-16" dur="${1.5+i*0.1}s" repeatCount="indefinite"/></line>`;
}
// ===== SERVER LAYER (Top) =====
s+=`<rect x="250" y="25" width="460" height="80" rx="4" fill="rgba(239,68,68,.03)" stroke="rgba(239,68,68,.2)" stroke-width="1"/>`;
s+=tx(480,40,'REDUNDANT SERVERS — MMR01 / MMR02','var(--r)',7,'middle',1);
// Server 1 (MMR01)
s+=`<rect x="270" y="50" width="100" height="48" rx="3" fill="rgba(34,197,94,.12)" stroke="var(--g)" stroke-width="1"/>`;
s+=`<rect x="275" y="55" width="90" height="8" rx="1" fill="rgba(34,197,94,.2)"/>`;
for(let i=0;i<4;i++)s+=`<rect x="${280+i*20}" y="67" width="15" height="3" rx=".5" fill="var(--g)" opacity=".5"/>`;
s+=tx(320,85,'MMR01','var(--g)',6,'middle',1);
s+=tx(320,95,'PRIMARY','var(--g)',4,'middle');
// Server 2 (MMR02)
s+=`<rect x="390" y="50" width="100" height="48" rx="3" fill="rgba(245,158,11,.1)" stroke="var(--o)" stroke-width=".8"/>`;
s+=`<rect x="395" y="55" width="90" height="8" rx="1" fill="rgba(245,158,11,.15)"/>`;
for(let i=0;i<4;i++)s+=`<rect x="${400+i*20}" y="67" width="15" height="3" rx=".5" fill="var(--o)" opacity=".4"/>`;
s+=tx(440,85,'MMR02','var(--o)',6,'middle',1);
s+=tx(440,95,'STANDBY','var(--o)',4,'middle');
// Heartbeat between servers
s+=`<line x1="370" y1="74" x2="390" y2="74" stroke="var(--g)" stroke-width="1"><animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="1s" repeatCount="indefinite"/></line>`;
s+=tx(380,68,'HB','var(--g)',3.5,'middle');
// DCIM/SCADA applications
s+=`<rect x="510" y="50" width="90" height="22" rx="2" fill="rgba(59,130,246,.1)" stroke="var(--b)" stroke-width=".5" data-tip="DCIM Platform: Schneider EcoStruxure / Nlyte \u2014 capacity planning, asset tracking, real-time monitoring, API integration"/>`;
s+=tx(555,64,'DCIM','var(--b)',5,'middle',1);
s+=`<rect x="510" y="76" width="90" height="22" rx="2" fill="rgba(139,92,246,.1)" stroke="var(--p)" stroke-width=".5" data-tip="SCADA: Supervisory control and data acquisition \u2014 real-time process visualization, alarm management, cause-effect matrix"/>`;
s+=tx(555,90,'SCADA','var(--p)',5,'middle',1);
s+=`<rect x="610" y="50" width="90" height="22" rx="2" fill="rgba(6,182,212,.1)" stroke="var(--c)" stroke-width=".5" data-tip="Data Historian: 1-year high-resolution + 5-year daily aggregation, trend analysis, compliance reporting"/>`;
s+=tx(655,64,'Historian','var(--c)',5,'middle',1);
s+=`<rect x="610" y="76" width="90" height="22" rx="2" fill="rgba(236,72,153,.1)" stroke="var(--pk)" stroke-width=".5" data-tip="Dashboard: Grafana real-time web + mobile dashboards, GPU telemetry, PUE/WUE/CUE metrics, PagerDuty alerting"/>`;
s+=tx(655,90,'Dashboard','var(--pk)',5,'middle',1);
// Connection from ring to servers with flowing animation
s+=`<line x1="480" y1="135" x2="480" y2="105" stroke="var(--o)" stroke-width="1.5" stroke-dasharray="4 2"><animate attributeName="stroke-dashoffset" values="0;-12" dur="1.2s" repeatCount="indefinite"/></line>`;
s+=`<line x1="480" y1="105" x2="320" y2="105" stroke="var(--g)" stroke-width="1.2" stroke-dasharray="4 2"><animate attributeName="stroke-dashoffset" values="0;-12" dur="1s" repeatCount="indefinite"/></line>`;
s+=`<line x1="320" y1="105" x2="320" y2="98" stroke="var(--g)" stroke-width="1.2" stroke-dasharray="3 2"><animate attributeName="stroke-dashoffset" values="0;-10" dur="0.8s" repeatCount="indefinite"/></line>`;
s+=`<line x1="480" y1="105" x2="440" y2="105" stroke="var(--o)" stroke-width="1.2" stroke-dasharray="4 2"><animate attributeName="stroke-dashoffset" values="0;-12" dur="1.1s" repeatCount="indefinite"/></line>`;
s+=`<line x1="440" y1="105" x2="440" y2="98" stroke="var(--o)" stroke-width="1.2" stroke-dasharray="3 2"><animate attributeName="stroke-dashoffset" values="0;-10" dur="0.9s" repeatCount="indefinite"/></line>`;
el.innerHTML=s;
})();
// BMS
$('bmsCards').innerHTML=[
mc('var(--g)','DCIM/BMS Platform','Monitoring & Control',[['Platform','Schneider EcoStruxure / Nlyte'],['BMS','Siemens Desigo / Honeywell EBI'],['Protocols','BACnet/Modbus/SNMP/REST/OPC-UA'],['Dashboard','Real-time web + mobile'],['Env sensors','24\u00D7TTHT (T+H per row)'],['Power meter','Per-branch kW/kWh/PF/THD'],['PUE','Real-time continuous calc'],['Alarms','Info/Warning/Critical 3-tier'],['Historian','1yr hi-res + 5yr daily'],['Reports','Daily/weekly/monthly auto'],['Capacity','kW headroom per rack+cooling'],['API','REST API for integration']]),
mc('var(--p)','GPU Telemetry NVOS 2.0','NVIDIA Intelligence',[['GPU health','T/P/Util/Clock/ECC'],['HBM','ECC bit-flip + page retirement'],['NVLink','Per-lane BER + retrain count'],['NVSwitch','Port Tx/Rx + error counters'],['XID','Error codes + severity + trend'],['Collection','DCGM daemon per host'],['Export','Prometheus + OpenTelemetry'],['Dashboard','Grafana pre-built GPU'],['Alerting','SNMP+syslog+PagerDuty'],['Predictive','XID trend + failure ML'],['Firmware','FOTA + rollback'],['Inventory','Auto-discover serial+MAC']]),
mc('var(--r)','Safety Integration','Cross-System Response',[['Leak\u2192BMS','Auto shutoff + alert NOC'],['Fire\u2192BMS','HVAC stop + damper close'],['VESDA','4-level escalation'],['EPO','Activation logged'],['UPS\u2192BMS','SOC/SOH + transfer events'],['GenSet','Run/fuel/coolant/oil'],['Cause-effect','Matrix: trigger\u2192action'],['Escalation','SMS\u2192call\u2192ticket'],['SOP popup','Auto-display on alarm'],['RCA','Event timeline capture'],['Audit','Immutable who/what/when'],['Testing','Quarterly C-E matrix verify']]),
mc('var(--o)','Maintenance PM/PdM','Preventive & Predictive',[['CMMS','Maximo/Fiix/eMaint WO'],['CDU','Monthly filter+leak+pump'],['CRAH','Quarterly filter+coil+fan'],['UPS','Semi-annual module+battery'],['GenSet','Monthly 1hr load bank'],['Busway','Quarterly IR thermal scan'],['Fire','Semi-annual det+cylinder'],['Leak','Monthly continuity+point'],['Coolant','Monthly pH/cond/bacteria'],['Battery','Annual Li-Ion discharge'],['Vibration','Quarterly pump+fan+chiller'],['KPI','MTBF/MTTR/PM%/WO backlog']])
].join('');

// Theme Toggle
(function initTheme(){
const toggle=document.getElementById('themeToggle');
const prefersDark=window.matchMedia('(prefers-color-scheme: dark)');
function getTheme(){const s=localStorage.getItem('theme');return s||(prefersDark.matches?'dark':'light');}
function applyTheme(t){
document.documentElement.setAttribute('data-theme',t);
localStorage.setItem('theme',t);
if(toggle)toggle.innerHTML=t==='dark'?'&#9790;':'&#9728;';
}
applyTheme(getTheme());
if(toggle)toggle.addEventListener('click',function(){
const curr=document.documentElement.getAttribute('data-theme');
applyTheme(curr==='dark'?'light':'dark');
});
prefersDark.addEventListener('change',e=>{if(!localStorage.getItem('theme'))applyTheme(e.matches?'dark':'light');});
})();

// ===== CDU HMI MIMIC — Coolant Distribution Unit P&ID =====
(function(){
const hmi=$('cduHmi'),svg=$('cduHmiSvg'),title=$('cduHmiTitle'),mode=$('cduHmiMode');
if(!hmi||!svg)return;
// Close on outside click
document.addEventListener('click',function(e){
if(hmi.classList.contains('show')&&!hmi.contains(e.target)&&!e.target.closest('.cdu-click'))hmi.classList.remove('show');
});
// CDU click handler
document.addEventListener('click',function(e){
const cdu=e.target.closest('.cdu-click');
if(!cdu)return;
const id=parseInt(cdu.dataset.cdu);
const label='CDU-'+String(id).padStart(2,'0');
title.textContent=label+' HMI';
mode.textContent='Online';
mode.style.color='var(--g)';mode.style.borderColor='rgba(34,197,94,.3)';mode.style.background='rgba(34,197,94,.12)';
renderCduHmi(svg,id);
// Position popup centered on screen
hmi.style.left=Math.max(10,(window.innerWidth-760)/2)+'px';
hmi.style.top=Math.max(10,(window.innerHeight-480)/2)+'px';
hmi.classList.add('show');
e.stopPropagation();
});
function renderCduHmi(el,cduId){
var F='JetBrains Mono',W=720,H=440;
var t1=R(21.0,22.5),t2=R(11.5,12.5),t3=R(34.5,35.8),t4=R(44.0,45.5);
var ps1=R(1.5,2.0),dp=R(1.5,2.5);
var flow=RI(350,450),fan=RI(68,82),p1pct=RI(75,90),p2pct=RI(72,88),p3pct=0;
var rpm=RI(1800,2200),amps=R(5.5,8.0);
var hxDuty=RI(240,290),glycol=30,valvePct=RI(65,80),expLvl=RI(75,88),strDP=R(0.1,0.3);
var s='';
// Background
s+=`<rect width="${W}" height="${H}" fill="#080e1a" rx="4"/>`;
// Defs
s+=`<defs><linearGradient id="hxG" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="rgba(239,68,68,.1)"/><stop offset="100%" stop-color="rgba(59,130,246,.1)"/></linearGradient></defs>`;
// ===== HEADER BAR =====
s+=`<rect x="0" y="0" width="${W}" height="26" fill="rgba(6,182,212,.08)"/>`;
s+=`<text x="10" y="17" fill="var(--c)" font-family="${F}" font-size="10" font-weight="600">CDU-${String(cduId).padStart(2,'0')} HMI</text>`;
s+=`<circle cx="130" cy="13" r="4" fill="var(--g)" opacity=".8"/><text x="138" y="17" fill="var(--g)" font-family="${F}" font-size="8">Online</text>`;
s+=`<text x="${W/2}" y="17" fill="var(--t2)" font-family="${F}" font-size="8" text-anchor="middle">Coolant Distribution Unit</text>`;
s+=`<text x="${W-10}" y="17" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="end">IP: 192.168.11.${170+cduId}</text>`;
// ===== KPI STRIP (6 boxes) =====
var iy=30,bw=108;
var kpis=[
{l:'Fan Speed',v:fan+'%',c:'var(--o)',bg:'rgba(245,158,11,.06)',bc:'var(--o)'},
{l:'Mode',v:'Online',c:'var(--g)',bg:'rgba(34,197,94,.06)',bc:'var(--g)'},
{l:'Sec Flow',v:flow+' L/m',c:'var(--c)',bg:'rgba(6,182,212,.06)',bc:'var(--c)'},
{l:'Supply T3',v:t3+'\u00B0C',c:'var(--c)',bg:'rgba(6,182,212,.06)',bc:'var(--c)'},
{l:'HX Duty',v:hxDuty+' kW',c:'var(--p)',bg:'rgba(139,92,246,.06)',bc:'var(--p)'},
{l:'Glycol',v:glycol+'%',c:'var(--pk)',bg:'rgba(236,72,153,.06)',bc:'var(--pk)'}
];
for(var k=0;k<kpis.length;k++){var kx=10+k*(bw+4);
s+=`<rect x="${kx}" y="${iy}" width="${bw}" height="30" rx="3" fill="${kpis[k].bg}" stroke="${kpis[k].bc}" stroke-width=".6"/>`;
s+=`<text x="${kx+bw/2}" y="${iy+11}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">${kpis[k].l}</text>`;
s+=`<text x="${kx+bw/2}" y="${iy+24}" fill="${kpis[k].c}" font-family="${F}" font-size="11" text-anchor="middle" font-weight="600">${kpis[k].v}</text>`;
}
// ===== HEAT EXCHANGER (left side) =====
var hxX=15,hxY=74,hxW=80,hxH=195;
s+=`<rect x="${hxX}" y="${hxY}" width="${hxW}" height="${hxH}" rx="4" fill="url(#hxG)" stroke="var(--c)" stroke-width="1.2"/>`;
s+=`<circle cx="${hxX-1}" cy="${hxY+10}" r="3" fill="var(--g)"/>`;
s+=`<text x="${hxX+hxW/2}" y="${hxY+12}" fill="var(--c)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600">PLATE HX</text>`;
// V-coils inside HX
for(var i=0;i<6;i++){var cy=hxY+22+i*24;s+=`<polyline points="${hxX+10},${cy} ${hxX+hxW/2},${cy+12} ${hxX+hxW-10},${cy}" fill="none" stroke="var(--c)" stroke-width="1.2" opacity=".35"/>`}
// Red triangles (hot side LEFT — FWS out)
for(var i=0;i<3;i++){var ty=hxY+40+i*50;s+=`<polygon points="${hxX-2},${ty} ${hxX+10},${ty-7} ${hxX+10},${ty+7}" fill="var(--r)" opacity=".6"/>`}
// Blue triangles (cold side RIGHT — FWS in)
for(var i=0;i<3;i++){var ty=hxY+40+i*50;s+=`<polygon points="${hxX+hxW+2},${ty} ${hxX+hxW-10},${ty-7} ${hxX+hxW-10},${ty+7}" fill="var(--b)" opacity=".6"/>`}
// HX Duty label
s+=`<text x="${hxX+hxW/2}" y="${hxY+hxH-8}" fill="var(--c)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">${hxDuty} kW</text>`;
s+=`<text x="${hxX+hxW/2}" y="${hxY+hxH+10}" fill="var(--c)" font-family="${F}" font-size="6" text-anchor="middle">Heat Exchanger</text>`;
// 3 rotating fans inside HX
var fCx=hxX+hxW/2;
for(var i=0;i<3;i++){var fy=hxY+48+i*48,dur=(1.5+i*0.2).toFixed(1);
s+=`<circle cx="${fCx}" cy="${fy}" r="11" fill="rgba(0,0,0,.3)" stroke="rgba(245,158,11,.5)" stroke-width=".8"/>`;
s+=`<g><animateTransform attributeName="transform" type="rotate" from="0 ${fCx} ${fy}" to="360 ${fCx} ${fy}" dur="${dur}s" repeatCount="indefinite"/>`;
for(var d=0;d<4;d++){var ang=d*90*Math.PI/180;var dx=Math.sin(ang)*8,dy=-Math.cos(ang)*8;
s+=`<line x1="${fCx}" y1="${fy}" x2="${fCx+dx}" y2="${fy+dy}" stroke="var(--o)" stroke-width="2" stroke-linecap="round" opacity=".7"/>`;}
s+=`</g><circle cx="${fCx}" cy="${fy}" r="2" fill="var(--o)" opacity=".5"/>`}
// ===== FWS INLET T2 (right of HX, top) =====
s+=`<rect x="110" y="82" width="80" height="28" rx="3" fill="rgba(59,130,246,.06)" stroke="var(--b)" stroke-width=".6"/>`;
s+=`<circle cx="112" cy="84" r="3" fill="var(--g)"/>`;
s+=`<text x="150" y="94" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">FWS Inlet T2</text>`;
s+=`<text x="150" y="105" fill="var(--b)" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${t2}\u00B0C</text>`;
s+=`<line x1="${hxX+hxW}" y1="96" x2="110" y2="96" stroke="var(--b)" stroke-width="1.5" opacity=".4"/>`;
// ===== STRAINER / Y-FILTER =====
s+=`<rect x="205" y="82" width="55" height="28" rx="3" fill="rgba(107,114,128,.06)" stroke="var(--t3)" stroke-width=".6"/>`;
s+=`<text x="232" y="93" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Strainer [Y]</text>`;
s+=`<text x="232" y="105" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">\u0394P ${strDP}bar</text>`;
s+=`<line x1="190" y1="96" x2="205" y2="96" stroke="var(--b)" stroke-width="1" opacity=".3"/>`;
// ===== SUPPLY LINE (cyan, left-to-right through pump) =====
var supY=155;
s+=`<line x1="${hxX+hxW}" y1="${supY}" x2="672" y2="${supY}" stroke="var(--c)" stroke-width="3" opacity=".5" stroke-dasharray="12 6"><animate attributeName="stroke-dashoffset" values="0;-36" dur="1s" repeatCount="indefinite"/></line>`;
s+=`<text x="${hxX+hxW+15}" y="${supY-7}" fill="var(--c)" font-family="${F}" font-size="6" opacity=".7" font-weight="600">SUPPLY \u25B6\u25B6\u25B6</text>`;
for(var i=0;i<5;i++){s+=`<polygon points="${210+i*85},${supY-4} ${218+i*85},${supY} ${210+i*85},${supY+4}" fill="var(--c)" opacity=".5"><animate attributeName="opacity" values=".2;.7;.2" dur="${1+i*.15}s" repeatCount="indefinite"/></polygon>`}
s+=`<polygon points="678,${supY-5} ${W-28},${supY} 678,${supY+5}" fill="var(--c)" opacity=".8"/>`;
s+=`<text x="${W-32}" y="${supY-8}" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="end">TCS Supply</text>`;
// ===== VFD PUMPS — 2+1 (N+1) =====
var pmpX=320;
// VFD banner above pumps
s+=`<rect x="${pmpX}" y="${supY-44}" width="148" height="14" rx="2" fill="rgba(34,197,94,.08)" stroke="var(--g)" stroke-width=".4"/>`;
s+=`<text x="${pmpX+74}" y="${supY-34}" fill="var(--g)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600">VFD Pumps \u2014 2+1 (N+1)</text>`;
// --- Pump P1 (active) ---
s+=`<rect x="${pmpX}" y="${supY-27}" width="46" height="56" rx="3" fill="rgba(34,197,94,.06)" stroke="var(--g)" stroke-width=".8"/>`;
s+=`<text x="${pmpX+23}" y="${supY-16}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">P1</text>`;
s+=`<circle cx="${pmpX+23}" cy="${supY}" r="12" fill="none" stroke="var(--g)" stroke-width="1.2"/>`;
s+=`<g><animateTransform attributeName="transform" type="rotate" from="0 ${pmpX+23} ${supY}" to="360 ${pmpX+23} ${supY}" dur="2s" repeatCount="indefinite"/>`;
s+=`<polygon points="${pmpX+16},${supY-7} ${pmpX+30},${supY} ${pmpX+16},${supY+7}" fill="var(--g)" fill-opacity=".5"/>`;
s+=`</g>`;
s+=`<text x="${pmpX+23}" y="${supY+20}" fill="var(--g)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">${p1pct}%</text>`;
// --- Pump P2 (active) ---
s+=`<rect x="${pmpX+51}" y="${supY-27}" width="46" height="56" rx="3" fill="rgba(34,197,94,.06)" stroke="var(--g)" stroke-width=".8"/>`;
s+=`<text x="${pmpX+74}" y="${supY-16}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">P2</text>`;
s+=`<circle cx="${pmpX+74}" cy="${supY}" r="12" fill="none" stroke="var(--g)" stroke-width="1.2"/>`;
s+=`<g><animateTransform attributeName="transform" type="rotate" from="0 ${pmpX+74} ${supY}" to="360 ${pmpX+74} ${supY}" dur="2.2s" repeatCount="indefinite"/>`;
s+=`<polygon points="${pmpX+67},${supY-7} ${pmpX+81},${supY} ${pmpX+67},${supY+7}" fill="var(--g)" fill-opacity=".5"/>`;
s+=`</g>`;
s+=`<text x="${pmpX+74}" y="${supY+20}" fill="var(--g)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">${p2pct}%</text>`;
// --- Pump P3 (standby) ---
s+=`<rect x="${pmpX+102}" y="${supY-27}" width="46" height="56" rx="3" fill="rgba(107,114,128,.06)" stroke="var(--t3)" stroke-width=".6"/>`;
s+=`<text x="${pmpX+125}" y="${supY-16}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">P3</text>`;
s+=`<circle cx="${pmpX+125}" cy="${supY}" r="12" fill="none" stroke="var(--t3)" stroke-width=".8"/>`;
s+=`<polygon points="${pmpX+118},${supY-7} ${pmpX+132},${supY} ${pmpX+118},${supY+7}" fill="var(--t3)" fill-opacity=".3"/>`;
s+=`<text x="${pmpX+125}" y="${supY+20}" fill="var(--t3)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">Stby</text>`;
// ===== SEC FLOW METER (on supply line, right of pump) =====
s+=`<rect x="500" y="${supY-22}" width="68" height="44" rx="3" fill="rgba(6,182,212,.06)" stroke="var(--c)" stroke-width=".6"/>`;
s+=`<text x="534" y="${supY-9}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Sec Flow [FM]</text>`;
s+=`<text x="534" y="${supY+5}" fill="var(--c)" font-family="${F}" font-size="12" text-anchor="middle" font-weight="600">${flow}</text>`;
s+=`<text x="534" y="${supY+16}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">L/min</text>`;
// ===== AAV (Automatic Air Vent) =====
s+=`<rect x="275" y="120" width="50" height="22" rx="2" fill="rgba(107,114,128,.06)" stroke="var(--t3)" stroke-width=".5"/>`;
s+=`<text x="300" y="133" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">AAV Air Vent</text>`;
s+=`<text x="300" y="140" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">Auto</text>`;
// ===== FILL PUMP P4 =====
s+=`<rect x="210" y="120" width="55" height="22" rx="3" fill="rgba(107,114,128,.06)" stroke="var(--t3)" stroke-width=".5"/>`;
s+=`<text x="237" y="132" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">Fill P4 Off</text>`;
// ===== FILL PUMP P3 =====
s+=`<rect x="210" y="190" width="55" height="22" rx="3" fill="rgba(107,114,128,.06)" stroke="var(--t3)" stroke-width=".5"/>`;
s+=`<text x="237" y="202" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">Fill P3 Off</text>`;
// ===== FWS OUTLET T1 (right of HX, bottom) =====
s+=`<rect x="110" y="235" width="80" height="28" rx="3" fill="rgba(239,68,68,.06)" stroke="var(--r)" stroke-width=".6"/>`;
s+=`<circle cx="112" cy="237" r="3" fill="var(--g)"/>`;
s+=`<text x="150" y="247" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">FWS Outlet T1</text>`;
s+=`<text x="150" y="258" fill="var(--r)" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${t1}\u00B0C</text>`;
s+=`<line x1="${hxX+hxW}" y1="249" x2="110" y2="249" stroke="var(--r)" stroke-width="1.5" opacity=".4"/>`;
// ===== RETURN LINE (red, right-to-left) =====
var retY=300;
s+=`<line x1="${hxX+hxW}" y1="${retY}" x2="672" y2="${retY}" stroke="var(--r)" stroke-width="3" opacity=".45" stroke-dasharray="12 6"><animate attributeName="stroke-dashoffset" values="0;36" dur="1s" repeatCount="indefinite"/></line>`;
s+=`<text x="${hxX+hxW+15}" y="${retY-7}" fill="var(--r)" font-family="${F}" font-size="6" opacity=".7" font-weight="600">\u25C0\u25C0\u25C0 RETURN</text>`;
// Vertical riser IT side
s+=`<line x1="672" y1="${supY+5}" x2="672" y2="${retY}" stroke="var(--r)" stroke-width="2.5" opacity=".3" stroke-dasharray="8 4"><animate attributeName="stroke-dashoffset" values="0;-24" dur="1.2s" repeatCount="indefinite"/></line>`;
for(var i=0;i<5;i++){s+=`<polygon points="${600-i*100},${retY-4} ${592-i*100},${retY} ${600-i*100},${retY+4}" fill="var(--r)" opacity=".5"><animate attributeName="opacity" values=".2;.6;.2" dur="${1.1+i*.12}s" repeatCount="indefinite"/></polygon>`}
s+=`<polygon points="${hxX+hxW+5},${retY-5} ${hxX+hxW-7},${retY} ${hxX+hxW+5},${retY+5}" fill="var(--r)" opacity=".7"/>`;
// IT Load label (vertical)
s+=`<rect x="678" y="${supY}" width="30" height="${retY-supY}" rx="3" fill="rgba(239,68,68,.04)" stroke="var(--r)" stroke-width=".4"/>`;
s+=`<text x="693" y="${(supY+retY)/2+3}" fill="var(--r)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600" transform="rotate(-90,693,${(supY+retY)/2})">IT LOAD</text>`;
// ===== 3-WAY MIXING VALVE (on return, left side) =====
s+=`<rect x="110" y="${retY-18}" width="75" height="36" rx="3" fill="rgba(139,92,246,.06)" stroke="var(--p)" stroke-width=".6"/>`;
s+=`<circle cx="112" cy="${retY-16}" r="3" fill="var(--g)"/>`;
s+=`<text x="147" y="${retY-6}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">3-Way Valve</text>`;
s+=`<text x="147" y="${retY+6}" fill="var(--p)" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${valvePct}%</text>`;
s+=`<text x="147" y="${retY+15}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">Actuator</text>`;
// ===== DIFF PRESSURE =====
s+=`<rect x="${pmpX}" y="${supY+35}" width="148" height="28" rx="3" fill="rgba(6,182,212,.06)" stroke="var(--c)" stroke-width=".6"/>`;
s+=`<text x="${pmpX+74}" y="${supY+48}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Diff Pressure DP</text>`;
s+=`<text x="${pmpX+74}" y="${supY+59}" fill="var(--c)" font-family="${F}" font-size="11" text-anchor="middle" font-weight="600">${dp} bar</text>`;
// ===== BOTTOM ROW: PS1, T4, Glycol, Expansion Tank, PSV =====
var btY=330;
// Pressure PS1
s+=`<rect x="200" y="${btY}" width="85" height="28" rx="3" fill="rgba(245,158,11,.06)" stroke="var(--o)" stroke-width=".6"/>`;
s+=`<text x="242" y="${btY+12}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">TCS-Int PS1</text>`;
s+=`<text x="242" y="${btY+24}" fill="var(--o)" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${ps1} bar</text>`;
// Return Temp T4
s+=`<rect x="295" y="${btY}" width="85" height="28" rx="3" fill="rgba(239,68,68,.06)" stroke="var(--r)" stroke-width=".6"/>`;
s+=`<text x="337" y="${btY+12}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Return T4</text>`;
s+=`<text x="337" y="${btY+24}" fill="var(--r)" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${t4}\u00B0C</text>`;
// Glycol concentration
s+=`<rect x="390" y="${btY}" width="75" height="28" rx="3" fill="rgba(236,72,153,.06)" stroke="var(--pk)" stroke-width=".6"/>`;
s+=`<text x="427" y="${btY+12}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Glycol</text>`;
s+=`<text x="427" y="${btY+24}" fill="var(--pk)" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${glycol}%</text>`;
// Expansion Tank
s+=`<rect x="20" y="${btY}" width="80" height="28" rx="3" fill="rgba(139,92,246,.06)" stroke="var(--p)" stroke-width=".6"/>`;
s+=`<circle cx="22" cy="${btY+2}" r="3" fill="var(--g)"/>`;
s+=`<text x="60" y="${btY+12}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">Exp Tank Level</text>`;
s+=`<text x="60" y="${btY+24}" fill="var(--p)" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${expLvl}%</text>`;
// PSV (safety valve)
s+=`<rect x="110" y="${btY}" width="75" height="28" rx="3" fill="rgba(239,68,68,.06)" stroke="var(--r)" stroke-width=".5"/>`;
s+=`<text x="147" y="${btY+12}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">PSV Relief</text>`;
s+=`<text x="147" y="${btY+24}" fill="var(--g)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">Sealed</text>`;
// ON / OFF buttons
s+=`<rect x="20" y="${btY+38}" width="35" height="18" rx="3" fill="rgba(34,197,94,.15)" stroke="var(--g)" stroke-width=".8"/>`;
s+=`<text x="37" y="${btY+50}" fill="var(--g)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">ON</text>`;
s+=`<rect x="62" y="${btY+38}" width="35" height="18" rx="3" fill="rgba(107,114,128,.08)" stroke="var(--t3)" stroke-width=".6"/>`;
s+=`<text x="79" y="${btY+50}" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="middle">OFF</text>`;
// Alarm indicator
s+=`<text x="${W-40}" y="${btY+50}" fill="var(--g)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">0 Alarms</text>`;
// ===== BOTTOM STATUS BAR =====
s+=`<rect x="0" y="${H-24}" width="${W}" height="24" fill="rgba(6,182,212,.06)"/>`;
s+=`<text x="10" y="${H-9}" fill="var(--t3)" font-family="${F}" font-size="7">IP: 192.168.11.${170+cduId} (A) | 192.168.11.${170+cduId+1} (B)</text>`;
s+=`<text x="${W-10}" y="${H-9}" fill="var(--c)" font-family="${F}" font-size="7" text-anchor="end">\u0394P ${dp}bar | ${flow}L/m | ${t3}/${t4}\u00B0C</text>`;
el.innerHTML=s;
}
// Auto-refresh CDU HMI values when visible
setInterval(function(){
if(!hmi.classList.contains('show'))return;
const cdu=hmi.querySelector('.cdu-hmi-hdr h4');
if(!cdu)return;
const m=cdu.textContent.match(/CDU-(\d+)/);
if(m)renderCduHmi(svg,parseInt(m[1]));
},3000);
})();

// ===== CHILLER HMI MIMIC =====
(function(){
const hmi=$('chHmi'),svg=$('chHmiSvg'),title=$('chHmiTitle'),mode=$('chHmiMode');
if(!hmi||!svg)return;
document.addEventListener('click',function(e){
if(hmi.classList.contains('show')&&!hmi.contains(e.target)&&!e.target.closest('.ch-click'))hmi.classList.remove('show');
});
document.addEventListener('click',function(e){
const ch=e.target.closest('.ch-click');
if(!ch)return;
const id=parseInt(ch.dataset.ch);
const st=ch.dataset.st||'RUN';
title.textContent='CH-'+id+' HMI';
mode.textContent=st;
mode.style.color=st==='RUN'?'var(--g)':'var(--o)';
mode.style.borderColor=st==='RUN'?'rgba(34,197,94,.3)':'rgba(245,158,11,.3)';
mode.style.background=st==='RUN'?'rgba(34,197,94,.12)':'rgba(245,158,11,.12)';
renderChillerHmi(svg,id,st);
hmi.style.left=Math.max(10,(window.innerWidth-760)/2)+'px';
hmi.style.top=Math.max(10,(window.innerHeight-400)/2)+'px';
hmi.classList.add('show');
e.stopPropagation();
});
function renderChillerHmi(el,chId,st){
var F='JetBrains Mono',W=720,H=460;
var cop=R(5.3,5.7),loadPct=RI(70,85),evapT=R(11.5,12.5),condT=R(34.5,35.8);
var evapEWT=R(21.0,22.5),condECW=R(27.5,28.5);
var vfdPct=RI(70,85),motorAmps=RI(230,260),bearingT=RI(58,66),oilT=RI(42,48);
var hpPress=R(7.8,8.5),lpPress=R(2.8,3.4),sh=R(5.5,7.0),sc=R(4.2,5.5);
var evapFlow=RI(480,520),condFlow=RI(580,620);
var oilPress=R(3.5,4.5),oilFilter=R(0.2,0.5),runHrs=RI(12000,28000),starts=RI(400,1500);
var evapApp=R(1.5,3.0),condApp=R(1.8,3.5),eer=R(14,18),kWton=R(0.55,0.65);
var s='';
s+=`<rect width="${W}" height="${H}" fill="#080e1a" rx="4"/>`;
// Header
s+=`<rect x="0" y="0" width="${W}" height="26" fill="rgba(245,158,11,.08)"/>`;
s+=`<text x="10" y="17" fill="var(--o)" font-family="${F}" font-size="10" font-weight="600">CHILLER CH-${chId} HMI</text>`;
s+=`<circle cx="155" cy="13" r="4" fill="${st==='RUN'?'var(--g)':'var(--o)'}" opacity=".8"/>`;
s+=`<text x="163" y="17" fill="${st==='RUN'?'var(--g)':'var(--o)'}" font-family="${F}" font-size="8">${st}</text>`;
s+=`<text x="${W/2}" y="17" fill="var(--t2)" font-family="${F}" font-size="8" text-anchor="middle">Centrifugal Water-Cooled Chiller</text>`;
s+=`<text x="${W-10}" y="17" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="end">IP: 192.168.11.15${chId}</text>`;
// KPI Strip
var iy=30,bw=108;
var kpis=[
{l:'COP',v:cop,c:'var(--g)',bg:'rgba(34,197,94,.06)',bc:'var(--g)'},
{l:'Load',v:loadPct+'%',c:'var(--o)',bg:'rgba(245,158,11,.06)',bc:'var(--o)'},
{l:'Evap LWT',v:evapT+'\u00B0C',c:'var(--c)',bg:'rgba(6,182,212,.06)',bc:'var(--c)'},
{l:'Cond LCW',v:condT+'\u00B0C',c:'var(--r)',bg:'rgba(239,68,68,.06)',bc:'var(--r)'},
{l:'Capacity',v:'2,500 kW',c:'var(--p)',bg:'rgba(139,92,246,.06)',bc:'var(--p)'},
{l:'Refrigerant',v:'R-1234ze',c:'var(--pk)',bg:'rgba(236,72,153,.06)',bc:'var(--pk)'}
];
for(var k=0;k<kpis.length;k++){var kx=10+k*(bw+4);
s+=`<rect x="${kx}" y="${iy}" width="${bw}" height="30" rx="3" fill="${kpis[k].bg}" stroke="${kpis[k].bc}" stroke-width=".6"/>`;
s+=`<text x="${kx+bw/2}" y="${iy+11}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">${kpis[k].l}</text>`;
s+=`<text x="${kx+bw/2}" y="${iy+24}" fill="${kpis[k].c}" font-family="${F}" font-size="11" text-anchor="middle" font-weight="600">${kpis[k].v}</text>`;
}
// ===== EVAPORATOR =====
var evX=15,evY=74,evW=200,evH=140;
s+=`<rect x="${evX}" y="${evY}" width="${evW}" height="${evH}" rx="4" fill="rgba(6,182,212,.06)" stroke="var(--c)" stroke-width="1"/>`;
s+=`<text x="${evX+evW/2}" y="${evY+14}" fill="var(--c)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">EVAPORATOR</text>`;
s+=`<text x="${evX+evW/2}" y="${evY+26}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Shell & Tube</text>`;
// Tube representation
for(var i=0;i<5;i++){var ty=evY+36+i*16;
s+=`<line x1="${evX+15}" y1="${ty}" x2="${evX+evW-15}" y2="${ty}" stroke="var(--c)" stroke-width="2" opacity=".3"/>`;
s+=`<circle cx="${evX+15}" cy="${ty}" r="3" fill="none" stroke="var(--c)" stroke-width=".5" opacity=".4"/>`;
s+=`<circle cx="${evX+evW-15}" cy="${ty}" r="3" fill="none" stroke="var(--c)" stroke-width=".5" opacity=".4"/>`;
}
// Flow animation through evap
s+=`<line x1="${evX}" y1="${evY+60}" x2="${evX+evW}" y2="${evY+60}" stroke="var(--g)" stroke-width="2" opacity=".4" stroke-dasharray="8 4"><animate attributeName="stroke-dashoffset" values="0;-24" dur="1s" repeatCount="indefinite"/></line>`;
// Evap labels
s+=`<text x="${evX+10}" y="${evY+evH-20}" fill="var(--c)" font-family="${F}" font-size="7" font-weight="600">FWS ${evapEWT}\u2192${evapT}\u00B0C</text>`;
s+=`<text x="${evX+10}" y="${evY+evH-8}" fill="var(--t3)" font-family="${F}" font-size="6">${evapFlow} m\u00B3/h | \u0394T ${(evapEWT-evapT).toFixed(1)}\u00B0C</text>`;
// ===== COMPRESSOR =====
var cpX=240,cpY=74,cpW=200,cpH=140;
s+=`<rect x="${cpX}" y="${cpY}" width="${cpW}" height="${cpH}" rx="4" fill="rgba(245,158,11,.06)" stroke="var(--o)" stroke-width="1"/>`;
s+=`<text x="${cpX+cpW/2}" y="${cpY+14}" fill="var(--o)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">COMPRESSOR</text>`;
s+=`<text x="${cpX+cpW/2}" y="${cpY+26}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Centrifugal VFD</text>`;
// Impeller animation
s+=`<circle cx="${cpX+cpW/2}" cy="${cpY+65}" r="30" fill="none" stroke="var(--o)" stroke-width="1.5"/>`;
s+=`<g><animateTransform attributeName="transform" type="rotate" from="0 ${cpX+cpW/2} ${cpY+65}" to="360 ${cpX+cpW/2} ${cpY+65}" dur="1.5s" repeatCount="indefinite"/>`;
for(var d=0;d<6;d++){var ang=d*60*Math.PI/180;var dx=Math.sin(ang)*22,dy=-Math.cos(ang)*22;
s+=`<line x1="${cpX+cpW/2}" y1="${cpY+65}" x2="${cpX+cpW/2+dx}" y2="${cpY+65+dy}" stroke="var(--o)" stroke-width="2.5" stroke-linecap="round" opacity=".6"/>`;
}
s+=`</g>`;
s+=`<circle cx="${cpX+cpW/2}" cy="${cpY+65}" r="5" fill="var(--o)" opacity=".3"/>`;
// Compressor labels
s+=`<text x="${cpX+10}" y="${cpY+cpH-20}" fill="var(--o)" font-family="${F}" font-size="7" font-weight="600">VFD ${vfdPct}% | ${motorAmps}A</text>`;
s+=`<text x="${cpX+10}" y="${cpY+cpH-8}" fill="var(--t3)" font-family="${F}" font-size="6">\u03B7 96% | R-1234ze(E)</text>`;
// ===== CONDENSER =====
var cdX=465,cdY=74,cdW=240,cdH=140;
s+=`<rect x="${cdX}" y="${cdY}" width="${cdW}" height="${cdH}" rx="4" fill="rgba(239,68,68,.06)" stroke="var(--r)" stroke-width="1"/>`;
s+=`<text x="${cdX+cdW/2}" y="${cdY+14}" fill="var(--r)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">CONDENSER</text>`;
s+=`<text x="${cdX+cdW/2}" y="${cdY+26}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Shell & Tube</text>`;
// Tube representation
for(var i=0;i<5;i++){var ty=cdY+36+i*16;
s+=`<line x1="${cdX+15}" y1="${ty}" x2="${cdX+cdW-15}" y2="${ty}" stroke="var(--r)" stroke-width="2" opacity=".3"/>`;
s+=`<circle cx="${cdX+15}" cy="${ty}" r="3" fill="none" stroke="var(--r)" stroke-width=".5" opacity=".4"/>`;
s+=`<circle cx="${cdX+cdW-15}" cy="${ty}" r="3" fill="none" stroke="var(--r)" stroke-width=".5" opacity=".4"/>`;
}
// Flow animation
s+=`<line x1="${cdX}" y1="${cdY+60}" x2="${cdX+cdW}" y2="${cdY+60}" stroke="var(--o)" stroke-width="2" opacity=".4" stroke-dasharray="8 4"><animate attributeName="stroke-dashoffset" values="0;24" dur="1s" repeatCount="indefinite"/></line>`;
// Condenser labels
s+=`<text x="${cdX+10}" y="${cdY+cdH-20}" fill="var(--r)" font-family="${F}" font-size="7" font-weight="600">CW ${condECW}\u2192${condT}\u00B0C</text>`;
s+=`<text x="${cdX+10}" y="${cdY+cdH-8}" fill="var(--t3)" font-family="${F}" font-size="6">${condFlow} m\u00B3/h | \u0394T ${(condT-condECW).toFixed(1)}\u00B0C</text>`;
// ===== REFRIGERANT CYCLE ARROWS =====
// Evap → Compressor
s+=`<line x1="${evX+evW}" y1="${evY+50}" x2="${cpX}" y2="${cpY+50}" stroke="var(--c)" stroke-width="2" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;-18" dur=".8s" repeatCount="indefinite"/></line>`;
s+=`<text x="${(evX+evW+cpX)/2}" y="${evY+44}" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">Low-P Gas</text>`;
// Compressor → Condenser
s+=`<line x1="${cpX+cpW}" y1="${cpY+50}" x2="${cdX}" y2="${cdY+50}" stroke="var(--r)" stroke-width="2" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;-18" dur=".8s" repeatCount="indefinite"/></line>`;
s+=`<text x="${(cpX+cpW+cdX)/2}" y="${cpY+44}" fill="var(--r)" font-family="${F}" font-size="5" text-anchor="middle">High-P Gas</text>`;
// ===== EXV + Return Path =====
var exvY=230;
s+=`<line x1="${cdX+cdW/2}" y1="${cdY+cdH}" x2="${cdX+cdW/2}" y2="${exvY+5}" stroke="var(--o)" stroke-width="1.5" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;18" dur=".8s" repeatCount="indefinite"/></line>`;
// EXV box
s+=`<rect x="${cdX+cdW/2-40}" y="${exvY}" width="80" height="22" rx="3" fill="rgba(139,92,246,.08)" stroke="var(--p)" stroke-width=".6"/>`;
s+=`<text x="${cdX+cdW/2}" y="${exvY+14}" fill="var(--p)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">EXV (Exp Valve)</text>`;
// EXV → Evaporator (bottom return)
s+=`<line x1="${cdX+cdW/2-40}" y1="${exvY+11}" x2="${evX+evW/2}" y2="${exvY+11}" stroke="var(--p)" stroke-width="1.5" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;18" dur=".8s" repeatCount="indefinite"/></line>`;
s+=`<line x1="${evX+evW/2}" y1="${exvY+11}" x2="${evX+evW/2}" y2="${evY+evH}" stroke="var(--p)" stroke-width="1.5" stroke-dasharray="6 3"><animate attributeName="stroke-dashoffset" values="0;18" dur=".8s" repeatCount="indefinite"/></line>`;
s+=`<text x="${(evX+evW/2+cdX+cdW/2-40)/2}" y="${exvY+6}" fill="var(--p)" font-family="${F}" font-size="5" text-anchor="middle">Liquid Refrigerant</text>`;
// ===== BOTTOM: Operating Parameters =====
var btY=260;
s+=`<rect x="10" y="${btY}" width="${W-20}" height="52" rx="3" fill="rgba(107,114,128,.04)" stroke="var(--bd)" stroke-width=".4"/>`;
s+=`<text x="20" y="${btY+14}" fill="var(--t3)" font-family="${F}" font-size="6">VFD Speed</text>`;
s+=`<text x="90" y="${btY+14}" fill="var(--o)" font-family="${F}" font-size="8" font-weight="600">${vfdPct}%</text>`;
s+=`<text x="130" y="${btY+14}" fill="var(--t3)" font-family="${F}" font-size="6">Motor Amps</text>`;
s+=`<text x="210" y="${btY+14}" fill="var(--o)" font-family="${F}" font-size="8" font-weight="600">${motorAmps}A</text>`;
s+=`<text x="250" y="${btY+14}" fill="var(--t3)" font-family="${F}" font-size="6">Bearing Temp</text>`;
s+=`<text x="340" y="${btY+14}" fill="${bearingT>65?'var(--o)':'var(--g)'}" font-family="${F}" font-size="8" font-weight="600">${bearingT}\u00B0C</text>`;
s+=`<text x="380" y="${btY+14}" fill="var(--t3)" font-family="${F}" font-size="6">Oil Temp</text>`;
s+=`<text x="440" y="${btY+14}" fill="var(--g)" font-family="${F}" font-size="8" font-weight="600">${oilT}\u00B0C</text>`;
s+=`<text x="20" y="${btY+32}" fill="var(--t3)" font-family="${F}" font-size="6">Ref Press HP</text>`;
s+=`<text x="110" y="${btY+32}" fill="var(--r)" font-family="${F}" font-size="8" font-weight="600">${hpPress} bar</text>`;
s+=`<text x="170" y="${btY+32}" fill="var(--t3)" font-family="${F}" font-size="6">LP</text>`;
s+=`<text x="195" y="${btY+32}" fill="var(--c)" font-family="${F}" font-size="8" font-weight="600">${lpPress} bar</text>`;
s+=`<text x="250" y="${btY+32}" fill="var(--t3)" font-family="${F}" font-size="6">Superheat</text>`;
s+=`<text x="320" y="${btY+32}" fill="var(--c)" font-family="${F}" font-size="8" font-weight="600">${sh}\u00B0C</text>`;
s+=`<text x="360" y="${btY+32}" fill="var(--t3)" font-family="${F}" font-size="6">Subcool</text>`;
s+=`<text x="420" y="${btY+32}" fill="var(--c)" font-family="${F}" font-size="8" font-weight="600">${sc}\u00B0C</text>`;
s+=`<text x="480" y="${btY+14}" fill="var(--t3)" font-family="${F}" font-size="6">Evap Flow</text>`;
s+=`<text x="560" y="${btY+14}" fill="var(--g)" font-family="${F}" font-size="8" font-weight="600">${evapFlow} m\u00B3/h</text>`;
s+=`<text x="480" y="${btY+32}" fill="var(--t3)" font-family="${F}" font-size="6">Cond Flow</text>`;
s+=`<text x="560" y="${btY+32}" fill="var(--o)" font-family="${F}" font-size="8" font-weight="600">${condFlow} m\u00B3/h</text>`;
s+=`<text x="${W-60}" y="${btY+14}" fill="var(--t3)" font-family="${F}" font-size="6">COP</text>`;
s+=`<text x="${W-20}" y="${btY+14}" fill="var(--g)" font-family="${F}" font-size="10" text-anchor="end" font-weight="700">${cop}</text>`;
s+=`<text x="${W-60}" y="${btY+32}" fill="var(--t3)" font-family="${F}" font-size="6">Load</text>`;
s+=`<text x="${W-20}" y="${btY+32}" fill="var(--o)" font-family="${F}" font-size="10" text-anchor="end" font-weight="700">${loadPct}%</text>`;
// ON/OFF buttons + alarms
s+=`<rect x="20" y="${btY+40}" width="35" height="16" rx="3" fill="rgba(34,197,94,.15)" stroke="var(--g)" stroke-width=".8"/>`;
s+=`<text x="37" y="${btY+51}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">START</text>`;
s+=`<rect x="62" y="${btY+40}" width="35" height="16" rx="3" fill="rgba(107,114,128,.08)" stroke="var(--t3)" stroke-width=".6"/>`;
s+=`<text x="79" y="${btY+51}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">STOP</text>`;
s+=`<text x="${W-40}" y="${btY+51}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">0 Alarms</text>`;
// ===== OIL SYSTEM & EXTENDED PARAMETERS =====
var oY=btY+62;
s+=`<rect x="10" y="${oY}" width="345" height="52" rx="3" fill="rgba(245,158,11,.04)" stroke="var(--o)" stroke-width=".4"/>`;
s+=`<text x="20" y="${oY+12}" fill="var(--o)" font-family="${F}" font-size="6" font-weight="600">OIL SYSTEM</text>`;
s+=`<text x="20" y="${oY+24}" fill="var(--t3)" font-family="${F}" font-size="5">Oil Press</text>`;
s+=`<text x="80" y="${oY+24}" fill="var(--o)" font-family="${F}" font-size="6" font-weight="600">${oilPress} bar</text>`;
s+=`<text x="130" y="${oY+24}" fill="var(--t3)" font-family="${F}" font-size="5">Oil Temp</text>`;
s+=`<text x="185" y="${oY+24}" fill="var(--g)" font-family="${F}" font-size="6" font-weight="600">${oilT}\u00B0C</text>`;
s+=`<text x="220" y="${oY+24}" fill="var(--t3)" font-family="${F}" font-size="5">Filter \u0394P</text>`;
s+=`<text x="280" y="${oY+24}" fill="var(--g)" font-family="${F}" font-size="6" font-weight="600">${oilFilter} bar</text>`;
s+=`<text x="20" y="${oY+38}" fill="var(--t3)" font-family="${F}" font-size="5">Oil Heater</text>`;
s+=`<text x="80" y="${oY+38}" fill="var(--g)" font-family="${F}" font-size="6" font-weight="600">OFF</text>`;
s+=`<text x="130" y="${oY+38}" fill="var(--t3)" font-family="${F}" font-size="5">Oil Level</text>`;
s+=`<text x="185" y="${oY+38}" fill="var(--g)" font-family="${F}" font-size="6" font-weight="600">Normal</text>`;
s+=`<text x="220" y="${oY+38}" fill="var(--t3)" font-family="${F}" font-size="5">Oil Type</text>`;
s+=`<text x="280" y="${oY+38}" fill="var(--t3)" font-family="${F}" font-size="6">POE 68</text>`;
// Extended performance
s+=`<rect x="365" y="${oY}" width="345" height="52" rx="3" fill="rgba(34,197,94,.04)" stroke="var(--g)" stroke-width=".4"/>`;
s+=`<text x="375" y="${oY+12}" fill="var(--g)" font-family="${F}" font-size="6" font-weight="600">PERFORMANCE & MAINTENANCE</text>`;
s+=`<text x="375" y="${oY+24}" fill="var(--t3)" font-family="${F}" font-size="5">kW/ton</text>`;
s+=`<text x="425" y="${oY+24}" fill="var(--g)" font-family="${F}" font-size="6" font-weight="600">${kWton}</text>`;
s+=`<text x="470" y="${oY+24}" fill="var(--t3)" font-family="${F}" font-size="5">EER</text>`;
s+=`<text x="500" y="${oY+24}" fill="var(--g)" font-family="${F}" font-size="6" font-weight="600">${eer}</text>`;
s+=`<text x="545" y="${oY+24}" fill="var(--t3)" font-family="${F}" font-size="5">Run Hours</text>`;
s+=`<text x="620" y="${oY+24}" fill="var(--t3)" font-family="${F}" font-size="6" font-weight="600">${runHrs} h</text>`;
s+=`<text x="375" y="${oY+38}" fill="var(--t3)" font-family="${F}" font-size="5">Evap Approach</text>`;
s+=`<text x="460" y="${oY+38}" fill="var(--c)" font-family="${F}" font-size="6" font-weight="600">${evapApp}\u00B0C</text>`;
s+=`<text x="510" y="${oY+38}" fill="var(--t3)" font-family="${F}" font-size="5">Cond Approach</text>`;
s+=`<text x="600" y="${oY+38}" fill="var(--o)" font-family="${F}" font-size="6" font-weight="600">${condApp}\u00B0C</text>`;
s+=`<text x="650" y="${oY+38}" fill="var(--t3)" font-family="${F}" font-size="5">Starts</text>`;
s+=`<text x="690" y="${oY+38}" fill="var(--t3)" font-family="${F}" font-size="6" font-weight="600">${starts}</text>`;
// Bottom status bar
s+=`<rect x="0" y="${H-24}" width="${W}" height="24" fill="rgba(245,158,11,.06)"/>`;
s+=`<text x="10" y="${H-9}" fill="var(--t3)" font-family="${F}" font-size="7">IP: 192.168.11.15${chId} | R-1234ze(E) GWP<1 | Centrifugal | 2,500 kW rated</text>`;
s+=`<text x="${W-10}" y="${H-9}" fill="var(--o)" font-family="${F}" font-size="7" text-anchor="end">COP ${cop} | Load ${loadPct}% | kW/ton ${kWton} | ${runHrs}h</text>`;
el.innerHTML=s;
}
// Auto-refresh chiller HMI
setInterval(function(){
if(!hmi.classList.contains('show'))return;
var m=title.textContent.match(/CH-(\d+)/);
if(m)renderChillerHmi(svg,parseInt(m[1]),mode.textContent);
},3000);
})();

// ===== COOLING TOWER HMI MIMIC =====
(function(){
const hmi=$('ctHmiModal'),svg=$('ctHmiSvg'),title=$('ctHmiTitle'),mode=$('ctHmiMode');
if(!hmi||!svg)return;
document.addEventListener('click',function(e){
if(hmi.classList.contains('show')&&!hmi.contains(e.target)&&!e.target.closest('.ct-click'))hmi.classList.remove('show');
});
document.addEventListener('click',function(e){
const ct=e.target.closest('.ct-click');
if(!ct)return;
const id=parseInt(ct.dataset.ct);
title.textContent='CT-'+id+' HMI';
mode.textContent='RUN';
mode.style.color='var(--g)';mode.style.borderColor='rgba(34,197,94,.3)';mode.style.background='rgba(34,197,94,.12)';
renderCtHmi(svg,id);
hmi.style.left=Math.max(10,(window.innerWidth-760)/2)+'px';
hmi.style.top=Math.max(10,(window.innerHeight-380)/2)+'px';
hmi.classList.add('show');
e.stopPropagation();
});
function renderCtHmi(el,ctId){
var F='JetBrains Mono',W=720,H=560;
el.setAttribute('viewBox','0 0 '+W+' '+H);
var wb=R(27.5,28.5),cwIn=R(34.5,35.8),cwOut=R(27.5,28.5);
var approach=(cwOut-wb).toFixed(1),range=(cwIn-cwOut).toFixed(1);
var eff=((1-approach/range)*100).toFixed(1);
if(eff>99.9)eff='99.5';if(eff<80)eff='95.2';
var fanPct=[RI(70,85),RI(72,88),RI(68,82)];
var fanAmps=[R(12.5,16.0),R(13.0,16.5),R(12.0,15.5)];
var fanBrgDE=[R(42,48),R(43,49),R(41,47)];
var fanBrgNDE=[R(38,44),R(39,45),R(37,43)];
var fanVib=[R(1.8,3.2),R(1.5,2.8),R(2.0,3.5)];
var fanRPM=[RI(280,320),RI(275,315),RI(282,322)];
var makeUp=RI(10,14),blowdown=RI(3,5),coc=RI(4,6);
var basinLvl=RI(78,88),basinTemp=R(27.0,29.0);
var conductivity=RI(1200,1600),pH=R(7.8,8.4),tds=RI(800,1200);
var biocide=RI(85,100),scaleInh=RI(80,95),corrInh=RI(82,98);
var driftLoss=R(0.001,0.003),evapRate=R(1.2,1.8);
var cwFlow=RI(550,650),totalFanPwr=(45*3);
var runHrs=RI(12000,18000),starts=RI(150,250);
var s='';
s+=`<rect width="${W}" height="${H}" fill="#080e1a" rx="4"/>`;
// Header
s+=`<rect x="0" y="0" width="${W}" height="26" fill="rgba(139,92,246,.08)"/>`;
s+=`<text x="10" y="17" fill="var(--p)" font-family="${F}" font-size="10" font-weight="600">COOLING TOWER CT-${ctId} HMI</text>`;
s+=`<circle cx="200" cy="13" r="4" fill="var(--g)" opacity=".8"/>`;
s+=`<text x="208" y="17" fill="var(--g)" font-family="${F}" font-size="8">RUN</text>`;
s+=`<text x="${W/2}" y="17" fill="var(--t2)" font-family="${F}" font-size="8" text-anchor="middle">Induced Draft Counter-Flow | 3-Cell</text>`;
s+=`<text x="${W-10}" y="17" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="end">${runHrs} hrs | ${starts} starts</text>`;
// KPI strip
var iy=30,bw=110;
var avgFan=Math.round((fanPct[0]+fanPct[1]+fanPct[2])/3);
var kpis=[
{l:'Avg Fan Speed',v:avgFan+'%',c:'var(--o)',bg:'rgba(245,158,11,.06)',bc:'var(--o)'},
{l:'WB Temp',v:wb+'\u00B0C',c:'var(--c)',bg:'rgba(6,182,212,.06)',bc:'var(--c)'},
{l:'CW In',v:cwIn+'\u00B0C',c:'var(--r)',bg:'rgba(239,68,68,.06)',bc:'var(--r)'},
{l:'CW Out',v:cwOut+'\u00B0C',c:'var(--c)',bg:'rgba(6,182,212,.06)',bc:'var(--c)'},
{l:'CW Flow',v:cwFlow+' m\u00B3/h',c:'var(--c)',bg:'rgba(6,182,212,.06)',bc:'var(--c)'},
{l:'3 Cells',v:'Active',c:'var(--g)',bg:'rgba(34,197,94,.06)',bc:'var(--g)'}
];
for(var k=0;k<kpis.length;k++){var kx=10+k*(bw+5);
s+=`<rect x="${kx}" y="${iy}" width="${bw}" height="30" rx="3" fill="${kpis[k].bg}" stroke="${kpis[k].bc}" stroke-width=".6"/>`;
s+=`<text x="${kx+bw/2}" y="${iy+11}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">${kpis[k].l}</text>`;
s+=`<text x="${kx+bw/2}" y="${iy+24}" fill="${kpis[k].c}" font-family="${F}" font-size="11" text-anchor="middle" font-weight="600">${kpis[k].v}</text>`;
}
// ===== CT CROSS-SECTION =====
var tX=10,tY=74,tW=700,tH=210;
s+=`<rect x="${tX}" y="${tY}" width="${tW}" height="${tH}" rx="4" fill="rgba(139,92,246,.04)" stroke="var(--p)" stroke-width="1"/>`;
s+=`<text x="${tX+6}" y="${tY+12}" fill="var(--p)" font-family="${F}" font-size="6" font-weight="600">CROSS-SECTION VIEW</text>`;
// 3 Fan cells at top with individual motor parameters
var fanNames=['Cell-1','Cell-2','Cell-3'];
for(var i=0;i<3;i++){var fx=tX+95+i*220,fy=tY+32;
// Fan housing
s+=`<rect x="${fx-45}" y="${fy-14}" width="90" height="32" rx="3" fill="rgba(245,158,11,.08)" stroke="var(--o)" stroke-width=".6"/>`;
// Motor circle + animated blades
s+=`<circle cx="${fx}" cy="${fy+2}" r="10" fill="none" stroke="var(--o)" stroke-width="1"/>`;
s+=`<g><animateTransform attributeName="transform" type="rotate" from="0 ${fx} ${fy+2}" to="360 ${fx} ${fy+2}" dur="${1.2+i*0.2}s" repeatCount="indefinite"/>`;
for(var d=0;d<6;d++){var ang=d*60*Math.PI/180;var ddx=Math.sin(ang)*7,ddy=-Math.cos(ang)*7;
s+=`<line x1="${fx}" y1="${fy+2}" x2="${fx+ddx}" y2="${fy+2+ddy}" stroke="var(--o)" stroke-width="1.5" stroke-linecap="round" opacity=".6"/>`;
}
s+=`</g>`;
// Fan label + VFD
s+=`<text x="${fx-38}" y="${fy}" fill="var(--o)" font-family="${F}" font-size="5" font-weight="600">${fanNames[i]}</text>`;
s+=`<text x="${fx+38}" y="${fy-2}" fill="var(--o)" font-family="${F}" font-size="5" text-anchor="end">${fanPct[i]}%</text>`;
s+=`<text x="${fx+38}" y="${fy+6}" fill="var(--t3)" font-family="${F}" font-size="4" text-anchor="end">${fanRPM[i]}rpm</text>`;
// Exhaust arrows
s+=`<text x="${fx}" y="${fy-18}" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="middle" opacity=".4">\u25B2\u25B2</text>`;
// Motor detail box below fan
var mbY=fy+20;
s+=`<rect x="${fx-45}" y="${mbY}" width="90" height="38" rx="2" fill="rgba(245,158,11,.03)" stroke="var(--o)" stroke-width=".3"/>`;
s+=`<text x="${fx-42}" y="${mbY+8}" fill="var(--o)" font-family="${F}" font-size="4.5" font-weight="600">Motor 45kW VFD</text>`;
s+=`<text x="${fx-42}" y="${mbY+15}" fill="var(--t3)" font-family="${F}" font-size="4">Amps: <tspan fill="var(--c)">${fanAmps[i].toFixed(1)}A</tspan></text>`;
s+=`<text x="${fx+3}" y="${mbY+15}" fill="var(--t3)" font-family="${F}" font-size="4">Vib: <tspan fill="${fanVib[i]>3?'var(--r)':'var(--g)'}">${fanVib[i].toFixed(1)}mm/s</tspan></text>`;
s+=`<text x="${fx-42}" y="${mbY+22}" fill="var(--t3)" font-family="${F}" font-size="4">Brg DE: <tspan fill="${fanBrgDE[i]>46?'var(--o)':'var(--c)'}">${fanBrgDE[i].toFixed(0)}\u00B0C</tspan></text>`;
s+=`<text x="${fx+3}" y="${mbY+22}" fill="var(--t3)" font-family="${F}" font-size="4">NDE: <tspan fill="${fanBrgNDE[i]>43?'var(--o)':'var(--c)'}">${fanBrgNDE[i].toFixed(0)}\u00B0C</tspan></text>`;
s+=`<circle cx="${fx+40}" cy="${mbY+32}" r="3" fill="${fanVib[i]>3?'rgba(239,68,68,.3)':'rgba(34,197,94,.3)'}" stroke="${fanVib[i]>3?'var(--r)':'var(--g)'}" stroke-width=".5"/>`;
s+=`<text x="${fx+40}" y="${mbY+34}" fill="${fanVib[i]>3?'var(--r)':'var(--g)'}" font-family="${F}" font-size="3.5" text-anchor="middle">${fanVib[i]>3?'!':'\u2713'}</text>`;
s+=`<text x="${fx-42}" y="${mbY+34}" fill="var(--t3)" font-family="${F}" font-size="3.5">Belt: <tspan fill="var(--g)">OK</tspan></text>`;
}
s+=`<text x="${tX+tW-8}" y="${tY+30}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="end">\u2190 Induced draft</text>`;
s+=`<text x="${tX+tW-8}" y="${tY+39}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="end">exhaust air</text>`;
// Drift eliminators
var deY=tY+98;
s+=`<rect x="${tX+20}" y="${deY}" width="${tW-40}" height="12" rx="2" fill="rgba(107,114,128,.08)" stroke="var(--t3)" stroke-width=".4"/>`;
s+=`<text x="${tX+tW/2}" y="${deY+9}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">DRIFT ELIMINATORS | Drift Loss: ${driftLoss.toFixed(3)}%</text>`;
// Hot water distribution
var hwY=deY+17;
s+=`<rect x="${tX+20}" y="${hwY}" width="${tW-40}" height="12" rx="2" fill="rgba(239,68,68,.08)" stroke="var(--r)" stroke-width=".4"/>`;
s+=`<text x="${tX+tW/2}" y="${hwY+9}" fill="var(--r)" font-family="${F}" font-size="6" text-anchor="middle">HOT WATER DISTRIBUTION (spray nozzles) | Evap Rate: ${evapRate.toFixed(1)} m\u00B3/h</text>`;
// CW In arrow
s+=`<text x="${tX+tW+5}" y="${hwY+8}" fill="var(--r)" font-family="${F}" font-size="6">CW In ${cwIn}\u00B0C</text>`;
s+=`<line x1="${tX+tW}" y1="${hwY+5}" x2="${tX+tW-20}" y2="${hwY+5}" stroke="var(--r)" stroke-width="2" class="fL"/>`;
// Fill media
var fmY=hwY+17;
s+=`<rect x="${tX+60}" y="${fmY}" width="${tW-120}" height="50" rx="3" fill="rgba(139,92,246,.06)" stroke="var(--p)" stroke-width=".6"/>`;
s+=`<text x="${tX+tW/2}" y="${fmY+14}" fill="var(--p)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">FILL MEDIA</text>`;
s+=`<text x="${tX+tW/2}" y="${fmY+26}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">Cross-fluted PVC/PP | Surface Area: 250 m\u00B2/m\u00B3</text>`;
s+=`<text x="${tX+tW/2}" y="${fmY+36}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">Counter-flow heat/mass transfer | Height: 1.8m</text>`;
// Water drip animation inside fill
for(var i=0;i<10;i++){var ddx=tX+90+i*55;
s+=`<circle cx="${ddx}" cy="${fmY+25}" r="1.5" fill="var(--c)" opacity=".4"><animate attributeName="cy" values="${fmY+16};${fmY+45};${fmY+16}" dur="${1.5+i*0.15}s" repeatCount="indefinite"/></circle>`;
}
// Cold water basin (expanded)
var baY=fmY+55;
s+=`<rect x="${tX+20}" y="${baY}" width="${tW-40}" height="32" rx="2" fill="rgba(6,182,212,.08)" stroke="var(--c)" stroke-width=".6"/>`;
s+=`<text x="${tX+40}" y="${baY+12}" fill="var(--c)" font-family="${F}" font-size="6" font-weight="600">COLD WATER BASIN</text>`;
s+=`<text x="${tX+200}" y="${baY+12}" fill="var(--t3)" font-family="${F}" font-size="5">Temp: <tspan fill="var(--c)">${basinTemp.toFixed(1)}\u00B0C</tspan></text>`;
s+=`<text x="${tX+310}" y="${baY+12}" fill="var(--t3)" font-family="${F}" font-size="5">Vol: <tspan fill="var(--c)">45 m\u00B3</tspan></text>`;
s+=`<text x="${tX+410}" y="${baY+12}" fill="var(--t3)" font-family="${F}" font-size="5">Material: <tspan fill="var(--t2)">FRP</tspan></text>`;
// Basin level bar
s+=`<rect x="${tX+35}" y="${baY+18}" width="${tW-70}" height="8" rx="2" fill="rgba(6,182,212,.06)" stroke="var(--c)" stroke-width=".3"/>`;
var lvlW=(tW-70)*basinLvl/100;
var lvlCol=basinLvl<75?'rgba(239,68,68,.3)':basinLvl>90?'rgba(245,158,11,.3)':'rgba(6,182,212,.25)';
s+=`<rect x="${tX+35}" y="${baY+18}" width="${lvlW}" height="8" rx="2" fill="${lvlCol}"/>`;
s+=`<text x="${tX+tW/2}" y="${baY+25}" fill="var(--c)" font-family="${F}" font-size="4" text-anchor="middle">Level ${basinLvl}% | Lo Alarm 60% | Hi Alarm 95% | Overflow at 100%</text>`;
// CW Out arrow
s+=`<text x="${tX+tW+5}" y="${baY+14}" fill="var(--c)" font-family="${F}" font-size="6">CW Out ${cwOut}\u00B0C</text>`;
s+=`<line x1="${tX+tW-20}" y1="${baY+12}" x2="${tX+tW}" y2="${baY+12}" stroke="var(--c)" stroke-width="2" class="fR"/>`;
// Air intake arrows at sides
s+=`<text x="${tX-5}" y="${fmY+25}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="end" opacity=".5">\u25B6</text>`;
s+=`<text x="${tX+tW+5}" y="${fmY+25}" fill="var(--t3)" font-family="${F}" font-size="7" opacity=".5">\u25C0</text>`;
// ===== WATER TREATMENT & CHEMISTRY =====
var wtY=292;
s+=`<rect x="10" y="${wtY}" width="345" height="95" rx="3" fill="rgba(139,92,246,.04)" stroke="var(--p)" stroke-width=".6"/>`;
s+=`<text x="20" y="${wtY+14}" fill="var(--p)" font-family="${F}" font-size="7" font-weight="600">WATER TREATMENT & CHEMISTRY</text>`;
// Row 1 - water quality
s+=`<text x="20" y="${wtY+28}" fill="var(--t3)" font-family="${F}" font-size="5">Conductivity:</text>`;
s+=`<text x="85" y="${wtY+28}" fill="${conductivity>1500?'var(--o)':'var(--c)'}" font-family="${F}" font-size="6" font-weight="600">${conductivity} \u00B5S/cm</text>`;
s+=`<text x="160" y="${wtY+28}" fill="var(--t3)" font-family="${F}" font-size="5">pH:</text>`;
s+=`<text x="178" y="${wtY+28}" fill="${pH>8.3?'var(--o)':'var(--g)'}" font-family="${F}" font-size="6" font-weight="600">${pH.toFixed(1)}</text>`;
s+=`<text x="210" y="${wtY+28}" fill="var(--t3)" font-family="${F}" font-size="5">TDS:</text>`;
s+=`<text x="233" y="${wtY+28}" fill="var(--c)" font-family="${F}" font-size="6" font-weight="600">${tds} ppm</text>`;
s+=`<text x="290" y="${wtY+28}" fill="var(--t3)" font-family="${F}" font-size="5">CoC:</text>`;
s+=`<text x="310" y="${wtY+28}" fill="var(--g)" font-family="${F}" font-size="6" font-weight="600">${coc}</text>`;
// Row 2 - chemical dosing
s+=`<text x="20" y="${wtY+42}" fill="var(--t3)" font-family="${F}" font-size="5">Biocide:</text>`;
var bcCol=biocide<90?'var(--o)':'var(--g)';
s+=`<rect x="62" y="${wtY+36}" width="50" height="7" rx="1" fill="rgba(107,114,128,.06)" stroke="var(--bd)" stroke-width=".3"/>`;
s+=`<rect x="62" y="${wtY+36}" width="${50*biocide/100}" height="7" rx="1" fill="${bcCol}" opacity=".2"/>`;
s+=`<text x="87" y="${wtY+42}" fill="${bcCol}" font-family="${F}" font-size="4" text-anchor="middle">${biocide}%</text>`;
s+=`<text x="125" y="${wtY+42}" fill="var(--t3)" font-family="${F}" font-size="5">Scale Inh:</text>`;
var siCol=scaleInh<85?'var(--o)':'var(--g)';
s+=`<rect x="172" y="${wtY+36}" width="50" height="7" rx="1" fill="rgba(107,114,128,.06)" stroke="var(--bd)" stroke-width=".3"/>`;
s+=`<rect x="172" y="${wtY+36}" width="${50*scaleInh/100}" height="7" rx="1" fill="${siCol}" opacity=".2"/>`;
s+=`<text x="197" y="${wtY+42}" fill="${siCol}" font-family="${F}" font-size="4" text-anchor="middle">${scaleInh}%</text>`;
s+=`<text x="235" y="${wtY+42}" fill="var(--t3)" font-family="${F}" font-size="5">Corr Inh:</text>`;
var ciCol=corrInh<85?'var(--o)':'var(--g)';
s+=`<rect x="278" y="${wtY+36}" width="50" height="7" rx="1" fill="rgba(107,114,128,.06)" stroke="var(--bd)" stroke-width=".3"/>`;
s+=`<rect x="278" y="${wtY+36}" width="${50*corrInh/100}" height="7" rx="1" fill="${ciCol}" opacity=".2"/>`;
s+=`<text x="303" y="${wtY+42}" fill="${ciCol}" font-family="${F}" font-size="4" text-anchor="middle">${corrInh}%</text>`;
// Row 3 - dosing mode
s+=`<text x="20" y="${wtY+55}" fill="var(--t3)" font-family="${F}" font-size="5">Dosing Mode:</text>`;
s+=`<text x="85" y="${wtY+55}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">AUTO</text>`;
s+=`<text x="115" y="${wtY+55}" fill="var(--t3)" font-family="${F}" font-size="5">Cond SP:</text>`;
s+=`<text x="157" y="${wtY+55}" fill="var(--c)" font-family="${F}" font-size="5" font-weight="600">1500 \u00B5S/cm</text>`;
s+=`<text x="225" y="${wtY+55}" fill="var(--t3)" font-family="${F}" font-size="5">pH SP:</text>`;
s+=`<text x="258" y="${wtY+55}" fill="var(--c)" font-family="${F}" font-size="5" font-weight="600">8.2</text>`;
// Row 4 - blowdown
s+=`<text x="20" y="${wtY+68}" fill="var(--t3)" font-family="${F}" font-size="5">Blowdown:</text>`;
s+=`<text x="75" y="${wtY+68}" fill="var(--o)" font-family="${F}" font-size="6" font-weight="600">${blowdown} m\u00B3/h</text>`;
s+=`<text x="130" y="${wtY+68}" fill="var(--t3)" font-family="${F}" font-size="5">Mode: <tspan fill="var(--g)">Auto-Cond</tspan></text>`;
s+=`<text x="225" y="${wtY+68}" fill="var(--t3)" font-family="${F}" font-size="5">BD Valve:</text>`;
s+=`<text x="275" y="${wtY+68}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">OPEN</text>`;
// Row 5 - make-up & legionella
s+=`<text x="20" y="${wtY+81}" fill="var(--t3)" font-family="${F}" font-size="5">Make-up:</text>`;
s+=`<text x="67" y="${wtY+81}" fill="var(--c)" font-family="${F}" font-size="6" font-weight="600">${makeUp} m\u00B3/h</text>`;
s+=`<text x="130" y="${wtY+81}" fill="var(--t3)" font-family="${F}" font-size="5">Legionella Risk:</text>`;
s+=`<text x="210" y="${wtY+81}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">LOW</text>`;
s+=`<text x="240" y="${wtY+81}" fill="var(--t3)" font-family="${F}" font-size="5">Last Test:</text>`;
s+=`<text x="283" y="${wtY+81}" fill="var(--t2)" font-family="${F}" font-size="5">7d ago</text>`;
// ===== PERFORMANCE & MAINTENANCE =====
var pmY=wtY;
s+=`<rect x="365" y="${pmY}" width="345" height="95" rx="3" fill="rgba(107,114,128,.04)" stroke="var(--bd)" stroke-width=".4"/>`;
s+=`<text x="375" y="${pmY+14}" fill="var(--o)" font-family="${F}" font-size="7" font-weight="600">PERFORMANCE & MAINTENANCE</text>`;
// Performance row 1
s+=`<text x="375" y="${pmY+28}" fill="var(--t3)" font-family="${F}" font-size="5">Approach:</text>`;
s+=`<text x="425" y="${pmY+28}" fill="var(--c)" font-family="${F}" font-size="7" font-weight="600">${approach}\u00B0C</text>`;
s+=`<text x="475" y="${pmY+28}" fill="var(--t3)" font-family="${F}" font-size="5">Range:</text>`;
s+=`<text x="510" y="${pmY+28}" fill="var(--o)" font-family="${F}" font-size="7" font-weight="600">${range}\u00B0C</text>`;
s+=`<text x="560" y="${pmY+28}" fill="var(--t3)" font-family="${F}" font-size="5">Efficiency:</text>`;
s+=`<text x="615" y="${pmY+28}" fill="var(--g)" font-family="${F}" font-size="7" font-weight="600">${eff}%</text>`;
// Performance row 2
s+=`<text x="375" y="${pmY+42}" fill="var(--t3)" font-family="${F}" font-size="5">Total Fan Power:</text>`;
s+=`<text x="455" y="${pmY+42}" fill="var(--o)" font-family="${F}" font-size="6" font-weight="600">${totalFanPwr} kW</text>`;
s+=`<text x="510" y="${pmY+42}" fill="var(--t3)" font-family="${F}" font-size="5">kW/ton:</text>`;
var kwTon=R(0.015,0.025);
s+=`<text x="550" y="${pmY+42}" fill="var(--c)" font-family="${F}" font-size="6" font-weight="600">${kwTon.toFixed(3)}</text>`;
s+=`<text x="600" y="${pmY+42}" fill="var(--t3)" font-family="${F}" font-size="5">Drift:</text>`;
s+=`<text x="628" y="${pmY+42}" fill="var(--c)" font-family="${F}" font-size="6" font-weight="600">${driftLoss.toFixed(3)}%</text>`;
// Performance row 3
s+=`<text x="375" y="${pmY+55}" fill="var(--t3)" font-family="${F}" font-size="5">Evap Rate:</text>`;
s+=`<text x="428" y="${pmY+55}" fill="var(--c)" font-family="${F}" font-size="6" font-weight="600">${evapRate.toFixed(1)} m\u00B3/h</text>`;
s+=`<text x="510" y="${pmY+55}" fill="var(--t3)" font-family="${F}" font-size="5">Heat Rej:</text>`;
var heatRej=RI(2800,3200);
s+=`<text x="555" y="${pmY+55}" fill="var(--o)" font-family="${F}" font-size="6" font-weight="600">${heatRej} kW</text>`;
// Maintenance row
s+=`<text x="375" y="${pmY+68}" fill="var(--t3)" font-family="${F}" font-size="5">Run Hours:</text>`;
s+=`<text x="430" y="${pmY+68}" fill="var(--t2)" font-family="${F}" font-size="6" font-weight="600">${runHrs}</text>`;
s+=`<text x="475" y="${pmY+68}" fill="var(--t3)" font-family="${F}" font-size="5">Starts:</text>`;
s+=`<text x="510" y="${pmY+68}" fill="var(--t2)" font-family="${F}" font-size="6" font-weight="600">${starts}</text>`;
s+=`<text x="550" y="${pmY+68}" fill="var(--t3)" font-family="${F}" font-size="5">Next PM:</text>`;
s+=`<text x="600" y="${pmY+68}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">1200h</text>`;
// Nozzle & fill condition
s+=`<text x="375" y="${pmY+81}" fill="var(--t3)" font-family="${F}" font-size="5">Nozzle Cond:</text>`;
s+=`<text x="440" y="${pmY+81}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">GOOD</text>`;
s+=`<text x="475" y="${pmY+81}" fill="var(--t3)" font-family="${F}" font-size="5">Fill Cond:</text>`;
s+=`<text x="525" y="${pmY+81}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">GOOD</text>`;
s+=`<text x="565" y="${pmY+81}" fill="var(--t3)" font-family="${F}" font-size="5">Fouling:</text>`;
s+=`<text x="600" y="${pmY+81}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">LOW</text>`;
// ===== FAN MOTOR DETAILS TABLE =====
var ftY=395;
s+=`<rect x="10" y="${ftY}" width="${W-20}" height="62" rx="3" fill="rgba(245,158,11,.03)" stroke="var(--o)" stroke-width=".4"/>`;
s+=`<text x="20" y="${ftY+13}" fill="var(--o)" font-family="${F}" font-size="7" font-weight="600">FAN MOTOR DETAILS</text>`;
// Table header
var cols=['','VFD %','RPM','Amps','Brg DE','Brg NDE','Vib','Belt','Status'];
var cxs=[20,75,125,175,225,285,345,400,445];
for(var c=0;c<cols.length;c++){
s+=`<text x="${cxs[c]}" y="${ftY+25}" fill="var(--t3)" font-family="${F}" font-size="5" font-weight="600">${cols[c]}</text>`;
}
// Table rows for each fan
for(var i=0;i<3;i++){var ry=ftY+35+i*10;
s+=`<text x="${cxs[0]}" y="${ry}" fill="var(--o)" font-family="${F}" font-size="5" font-weight="600">${fanNames[i]}</text>`;
s+=`<text x="${cxs[1]}" y="${ry}" fill="var(--c)" font-family="${F}" font-size="5">${fanPct[i]}%</text>`;
s+=`<text x="${cxs[2]}" y="${ry}" fill="var(--c)" font-family="${F}" font-size="5">${fanRPM[i]}</text>`;
s+=`<text x="${cxs[3]}" y="${ry}" fill="var(--c)" font-family="${F}" font-size="5">${fanAmps[i].toFixed(1)}A</text>`;
s+=`<text x="${cxs[4]}" y="${ry}" fill="${fanBrgDE[i]>46?'var(--o)':'var(--c)'}" font-family="${F}" font-size="5">${fanBrgDE[i].toFixed(0)}\u00B0C</text>`;
s+=`<text x="${cxs[5]}" y="${ry}" fill="${fanBrgNDE[i]>43?'var(--o)':'var(--c)'}" font-family="${F}" font-size="5">${fanBrgNDE[i].toFixed(0)}\u00B0C</text>`;
s+=`<text x="${cxs[6]}" y="${ry}" fill="${fanVib[i]>3?'var(--r)':'var(--g)'}" font-family="${F}" font-size="5">${fanVib[i].toFixed(1)}mm/s</text>`;
s+=`<text x="${cxs[7]}" y="${ry}" fill="var(--g)" font-family="${F}" font-size="5">OK</text>`;
s+=`<circle cx="${cxs[8]+6}" cy="${ry-2}" r="3" fill="rgba(34,197,94,.2)" stroke="var(--g)" stroke-width=".5"/>`;
s+=`<text x="${cxs[8]+6}" y="${ry}" fill="var(--g)" font-family="${F}" font-size="4" text-anchor="middle">\u2713</text>`;
s+=`<text x="${cxs[8]+16}" y="${ry}" fill="var(--g)" font-family="${F}" font-size="5">RUN</text>`;
}
// Motor spec labels
s+=`<text x="500" y="${ftY+35}" fill="var(--t3)" font-family="${F}" font-size="4.5">Type: Squirrel Cage Induction</text>`;
s+=`<text x="500" y="${ftY+43}" fill="var(--t3)" font-family="${F}" font-size="4.5">Rating: 45kW / 415V / 50Hz</text>`;
s+=`<text x="500" y="${ftY+51}" fill="var(--t3)" font-family="${F}" font-size="4.5">IP55 | F-Class | TEFC</text>`;
// ON/OFF + alarms
s+=`<rect x="20" y="${ftY+66}" width="35" height="16" rx="3" fill="rgba(34,197,94,.15)" stroke="var(--g)" stroke-width=".8"/>`;
s+=`<text x="37" y="${ftY+77}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">START</text>`;
s+=`<rect x="62" y="${ftY+66}" width="35" height="16" rx="3" fill="rgba(107,114,128,.08)" stroke="var(--t3)" stroke-width=".6"/>`;
s+=`<text x="79" y="${ftY+77}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">STOP</text>`;
s+=`<text x="${W-40}" y="${ftY+77}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">0 Alarms</text>`;
// ===== ENVIRONMENTAL =====
s+=`<text x="130" y="${ftY+77}" fill="var(--t3)" font-family="${F}" font-size="5">Ambient: <tspan fill="var(--c)">${R(30,34).toFixed(1)}\u00B0C</tspan></text>`;
s+=`<text x="230" y="${ftY+77}" fill="var(--t3)" font-family="${F}" font-size="5">RH: <tspan fill="var(--c)">${RI(65,80)}%</tspan></text>`;
s+=`<text x="290" y="${ftY+77}" fill="var(--t3)" font-family="${F}" font-size="5">Wind: <tspan fill="var(--c)">${R(1.5,4.0).toFixed(1)} m/s</tspan></text>`;
s+=`<text x="390" y="${ftY+77}" fill="var(--t3)" font-family="${F}" font-size="5">Noise: <tspan fill="var(--c)">${RI(72,82)} dBA</tspan></text>`;
// Bottom status bar
s+=`<rect x="0" y="${H-24}" width="${W}" height="24" fill="rgba(139,92,246,.06)"/>`;
s+=`<text x="10" y="${H-9}" fill="var(--t3)" font-family="${F}" font-size="7">Water Treat: Auto | Cond ${conductivity}\u00B5S | pH ${pH.toFixed(1)} | Basin ${basinLvl}% | CW Flow ${cwFlow}m\u00B3/h</text>`;
s+=`<text x="${W-10}" y="${H-9}" fill="var(--p)" font-family="${F}" font-size="7" text-anchor="end">Approach ${approach}\u00B0C | Range ${range}\u00B0C | \u03B7 ${eff}% | Heat Rej ${heatRej}kW</text>`;
el.innerHTML=s;
}
// Auto-refresh CT HMI
setInterval(function(){
if(!hmi.classList.contains('show'))return;
var m=title.textContent.match(/CT-(\d+)/);
if(m)renderCtHmi(svg,parseInt(m[1]));
},3000);
})();

// ===== EQUIPMENT HMI MODALS (CW Pump, FWS Pump, TCS Manifold) =====
(function(){
const hmi=$('eqHmi'),svg=$('eqHmiSvg'),title=$('eqHmiTitle'),mode=$('eqHmiMode');
if(!hmi||!svg)return;
document.addEventListener('click',function(e){
if(hmi.classList.contains('show')&&!hmi.contains(e.target)&&!e.target.closest('.cw-pump-click')&&!e.target.closest('.fws-pump-click')&&!e.target.closest('.tcs-click'))hmi.classList.remove('show');
});
function openEq(type){
title.textContent=type;mode.textContent='Online';
mode.style.color='var(--g)';mode.style.borderColor='rgba(34,197,94,.3)';mode.style.background='rgba(34,197,94,.12)';
if(type==='CW Pump Station')renderCwPumpHmi(svg);
else if(type==='FWS Pump Station')renderFwsPumpHmi(svg);
else if(type==='TCS Manifold')renderTcsHmi(svg);
hmi.style.left=Math.max(10,(window.innerWidth-800)/2)+'px';
hmi.style.top=Math.max(10,(window.innerHeight-480)/2)+'px';
hmi.classList.add('show');
}
document.addEventListener('click',function(e){
if(e.target.closest('.cw-pump-click')){openEq('CW Pump Station');e.stopPropagation();}
else if(e.target.closest('.fws-pump-click')){openEq('FWS Pump Station');e.stopPropagation();}
else if(e.target.closest('.tcs-click')){openEq('TCS Manifold');e.stopPropagation();}
});
// ===== CW PUMP STATION HMI =====
function renderCwPumpHmi(el){
var F='JetBrains Mono',W=780,H=480;var s='';
s+=`<rect width="${W}" height="${H}" fill="#080e1a" rx="4"/>`;
// Header
s+=`<rect x="0" y="0" width="${W}" height="26" fill="rgba(6,182,212,.08)"/>`;
s+=`<text x="10" y="17" fill="var(--c)" font-family="${F}" font-size="10" font-weight="600">CW PUMP STATION — Condenser Water Circulation</text>`;
s+=`<circle cx="340" cy="13" r="4" fill="var(--g)" opacity=".8"/><text x="348" y="17" fill="var(--g)" font-family="${F}" font-size="8">Online</text>`;
s+=`<text x="${W-10}" y="17" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="end">3\u00D7 P-CW (N+1)</text>`;
// KPI strip
var kpis=[{l:'Total Flow',v:RI(580,620)+' m\u00B3/h',c:'var(--c)'},{l:'Discharge P',v:R(4.2,4.8)+' bar',c:'var(--g)'},{l:'Suction P',v:R(1.8,2.4)+' bar',c:'var(--c)'},{l:'\u0394P',v:R(2.0,2.8)+' bar',c:'var(--o)'},{l:'Total kW',v:RI(120,155),c:'var(--o)'},{l:'Pumps Active',v:'2/3',c:'var(--g)'}];
for(var k=0;k<kpis.length;k++){var kx=10+k*127;
s+=`<rect x="${kx}" y="30" width="122" height="28" rx="3" fill="rgba(6,182,212,.04)" stroke="var(--c)" stroke-width=".4"/>`;
s+=`<text x="${kx+61}" y="41" fill="var(--t3)" font-family="${F}" font-size="5.5" text-anchor="middle">${kpis[k].l}</text>`;
s+=`<text x="${kx+61}" y="53" fill="${kpis[k].c}" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${kpis[k].v}</text>`;
}
// ===== SUCTION HEADER =====
s+=`<rect x="10" y="68" width="30" height="350" rx="3" fill="rgba(6,182,212,.04)" stroke="var(--c)" stroke-width=".8"/>`;
s+=`<text x="25" y="245" fill="var(--c)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600" transform="rotate(-90,25,245)">SUCTION HEADER DN300</text>`;
// Suction from CT
s+=`<line x1="0" y1="100" x2="10" y2="100" stroke="var(--c)" stroke-width="3" class="fR"/>`;
s+=`<text x="5" y="92" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">From CT</text>`;
s+=`<text x="5" y="115" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">28\u00B0C</text>`;
// ===== 3 PUMPS =====
var pumps=[{id:'P-CW-1',st:'RUN',y:80,vfd:RI(72,85),amp:RI(85,105),dp:R(4.2,4.8),flow:RI(190,210),temp:R(38,42)},
{id:'P-CW-2',st:'RUN',y:200,vfd:RI(70,82),amp:RI(82,100),dp:R(4.1,4.7),flow:RI(185,205),temp:R(37,41)},
{id:'P-CW-3',st:'STBY',y:320,vfd:0,amp:0,dp:0,flow:0,temp:R(25,28)}];
pumps.forEach(function(p){
var pc=p.st==='RUN'?'var(--c)':'var(--t3)';
var gc=p.st==='RUN'?'var(--g)':'var(--o)';
var bg=p.st==='RUN'?'rgba(6,182,212,.05)':'rgba(107,114,128,.03)';
// Pump train box
s+=`<rect x="50" y="${p.y}" width="680" height="105" rx="4" fill="${bg}" stroke="${pc}" stroke-width=".7"/>`;
s+=`<text x="60" y="${p.y+15}" fill="${pc}" font-family="${F}" font-size="9" font-weight="600">${p.id}</text>`;
s+=`<circle cx="120" cy="${p.y+12}" r="4" fill="${gc}"/><text x="128" y="${p.y+15}" fill="${gc}" font-family="${F}" font-size="7">${p.st}</text>`;
// Suction line from header
s+=`<line x1="40" y1="${p.y+50}" x2="80" y2="${p.y+50}" stroke="var(--c)" stroke-width="2" class="fR"/>`;
// Suction isolation valve
s+=symValve(90,p.y+50,'var(--c)');
s+=`<text x="90" y="${p.y+62}" fill="var(--t3)" font-family="${F}" font-size="4" text-anchor="middle">SIV</text>`;
// Suction strainer
s+=`<rect x="105" y="${p.y+42}" width="25" height="16" rx="2" fill="rgba(107,114,128,.06)" stroke="var(--t3)" stroke-width=".4"/>`;
s+=`<text x="117" y="${p.y+53}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">STR</text>`;
s+=`<text x="117" y="${p.y+62}" fill="var(--t3)" font-family="${F}" font-size="3.5" text-anchor="middle">\u0394P ${p.st==='RUN'?R(0.1,0.3):'--'} bar</text>`;
// Suction pressure
s+=`<circle cx="145" cy="${p.y+42}" r="5" fill="none" stroke="var(--o)" stroke-width=".5"/>`;
s+=`<text x="145" y="${p.y+44}" fill="var(--o)" font-family="${F}" font-size="4" text-anchor="middle">P</text>`;
s+=`<text x="145" y="${p.y+35}" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">${p.st==='RUN'?R(1.8,2.4):'--'}</text>`;
// Pump line
s+=`<line x1="130" y1="${p.y+50}" x2="165" y2="${p.y+50}" stroke="${pc}" stroke-width="2"/>`;
// VFD Motor box
s+=`<rect x="165" y="${p.y+28}" width="80" height="48" rx="3" fill="rgba(245,158,11,.06)" stroke="var(--o)" stroke-width=".6"/>`;
s+=`<text x="205" y="${p.y+38}" fill="var(--o)" font-family="${F}" font-size="5" text-anchor="middle" font-weight="600">VFD MOTOR 75kW</text>`;
// Motor circle with impeller
s+=`<circle cx="195" cy="${p.y+58}" r="12" fill="none" stroke="${pc}" stroke-width="1.2"/>`;
if(p.st==='RUN'){
s+=`<g><animateTransform attributeName="transform" type="rotate" from="0 195 ${p.y+58}" to="360 195 ${p.y+58}" dur="1.8s" repeatCount="indefinite"/>`;
for(var d=0;d<4;d++){var ang=d*90*Math.PI/180;var dx=Math.sin(ang)*9,dy=-Math.cos(ang)*9;
s+=`<line x1="195" y1="${p.y+58}" x2="${195+dx}" y2="${p.y+58+dy}" stroke="${pc}" stroke-width="2" stroke-linecap="round" opacity=".6"/>`;}
s+=`</g>`;
}else{s+=`<text x="195" y="${p.y+61}" fill="${pc}" font-family="${F}" font-size="8" text-anchor="middle">M</text>`;}
// VFD details
s+=`<text x="225" y="${p.y+48}" fill="${pc}" font-family="${F}" font-size="6" font-weight="600">${p.st==='RUN'?p.vfd+'%':'OFF'}</text>`;
s+=`<text x="225" y="${p.y+58}" fill="var(--t3)" font-family="${F}" font-size="5">${p.st==='RUN'?p.amp+'A':'0A'}</text>`;
s+=`<text x="225" y="${p.y+68}" fill="var(--t3)" font-family="${F}" font-size="5">Wdg: ${p.st==='RUN'?p.temp+'\u00B0C':'--'}</text>`;
// Pump casing
s+=`<line x1="245" y1="${p.y+50}" x2="275" y2="${p.y+50}" stroke="${pc}" stroke-width="2"/>`;
// Discharge check valve
s+=`<polygon points="280,${p.y+44} 290,${p.y+50} 280,${p.y+56}" fill="none" stroke="${pc}" stroke-width=".7"/>`;
s+=`<line x1="290" y1="${p.y+43}" x2="290" y2="${p.y+57}" stroke="${pc}" stroke-width=".7"/>`;
s+=`<text x="285" y="${p.y+68}" fill="var(--t3)" font-family="${F}" font-size="4" text-anchor="middle">NRV</text>`;
// Discharge line
s+=`<line x1="290" y1="${p.y+50}" x2="320" y2="${p.y+50}" stroke="${pc}" stroke-width="2" class="fR"/>`;
// Discharge isolation valve
s+=symValve(330,p.y+50,'var(--c)');
s+=`<text x="330" y="${p.y+62}" fill="var(--t3)" font-family="${F}" font-size="4" text-anchor="middle">DIV</text>`;
// Discharge pressure
s+=`<circle cx="350" cy="${p.y+42}" r="5" fill="none" stroke="var(--o)" stroke-width=".5"/>`;
s+=`<text x="350" y="${p.y+44}" fill="var(--o)" font-family="${F}" font-size="4" text-anchor="middle">P</text>`;
s+=`<text x="350" y="${p.y+35}" fill="var(--g)" font-family="${F}" font-size="5" text-anchor="middle">${p.st==='RUN'?p.dp:'--'}</text>`;
// Flow meter
s+=`<circle cx="375" cy="${p.y+42}" r="5" fill="none" stroke="var(--c)" stroke-width=".5"/>`;
s+=`<text x="375" y="${p.y+44}" fill="var(--c)" font-family="${F}" font-size="4" text-anchor="middle">F</text>`;
s+=`<text x="375" y="${p.y+35}" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">${p.st==='RUN'?p.flow:'0'}</text>`;
// Line to discharge header
s+=`<line x1="340" y1="${p.y+50}" x2="390" y2="${p.y+50}" stroke="${pc}" stroke-width="2" class="fR"/>`;
// Parameters box
s+=`<rect x="405" y="${p.y+6}" width="320" height="92" rx="3" fill="rgba(107,114,128,.03)" stroke="var(--bd)" stroke-width=".3"/>`;
s+=`<text x="415" y="${p.y+18}" fill="var(--t3)" font-family="${F}" font-size="5">Motor</text>`;
s+=`<text x="500" y="${p.y+18}" fill="${pc}" font-family="${F}" font-size="5" font-weight="600">75kW / 400V / IE4 Premium</text>`;
s+=`<text x="415" y="${p.y+30}" fill="var(--t3)" font-family="${F}" font-size="5">Speed</text>`;
s+=`<text x="500" y="${p.y+30}" fill="${pc}" font-family="${F}" font-size="5" font-weight="600">${p.st==='RUN'?RI(1350,1480):0} RPM (${p.st==='RUN'?p.vfd:0}%)</text>`;
s+=`<text x="415" y="${p.y+42}" fill="var(--t3)" font-family="${F}" font-size="5">Vibration</text>`;
s+=`<text x="500" y="${p.y+42}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">${p.st==='RUN'?R(1.2,3.5):'--'} mm/s</text>`;
s+=`<text x="415" y="${p.y+54}" fill="var(--t3)" font-family="${F}" font-size="5">Bearing DE</text>`;
s+=`<text x="500" y="${p.y+54}" fill="${p.st==='RUN'&&parseFloat(p.temp)>40?'var(--o)':'var(--g)'}" font-family="${F}" font-size="5" font-weight="600">${p.st==='RUN'?R(35,42):'--'}\u00B0C</text>`;
s+=`<text x="415" y="${p.y+66}" fill="var(--t3)" font-family="${F}" font-size="5">Bearing NDE</text>`;
s+=`<text x="500" y="${p.y+66}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">${p.st==='RUN'?R(33,40):'--'}\u00B0C</text>`;
s+=`<text x="415" y="${p.y+78}" fill="var(--t3)" font-family="${F}" font-size="5">Seal</text>`;
s+=`<text x="500" y="${p.y+78}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">Mechanical — No leak</text>`;
s+=`<text x="600" y="${p.y+42}" fill="var(--t3)" font-family="${F}" font-size="5">Run Hours</text>`;
s+=`<text x="700" y="${p.y+42}" fill="var(--t3)" font-family="${F}" font-size="5" font-weight="600">${p.st==='RUN'?RI(8000,18000):'--'} h</text>`;
s+=`<text x="600" y="${p.y+54}" fill="var(--t3)" font-family="${F}" font-size="5">Starts</text>`;
s+=`<text x="700" y="${p.y+54}" fill="var(--t3)" font-family="${F}" font-size="5" font-weight="600">${p.st==='RUN'?RI(200,1200):'--'}</text>`;
s+=`<text x="600" y="${p.y+66}" fill="var(--t3)" font-family="${F}" font-size="5">Efficiency</text>`;
s+=`<text x="700" y="${p.y+66}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">${p.st==='RUN'?R(85,91):'--'}%</text>`;
s+=`<text x="600" y="${p.y+78}" fill="var(--t3)" font-family="${F}" font-size="5">Alarm</text>`;
s+=`<text x="700" y="${p.y+78}" fill="var(--g)" font-family="${F}" font-size="5" font-weight="600">None</text>`;
});
// ===== DISCHARGE HEADER =====
s+=`<rect x="740" y="68" width="30" height="350" rx="3" fill="rgba(34,197,94,.04)" stroke="var(--g)" stroke-width=".8"/>`;
s+=`<text x="755" y="245" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600" transform="rotate(-90,755,245)">DISCHARGE HEADER DN300</text>`;
// Discharge to chillers
s+=`<line x1="770" y1="100" x2="${W}" y2="100" stroke="var(--g)" stroke-width="3" class="fR"/>`;
s+=`<text x="${W-5}" y="92" fill="var(--g)" font-family="${F}" font-size="5" text-anchor="end">To Chillers</text>`;
s+=`<text x="${W-5}" y="115" fill="var(--g)" font-family="${F}" font-size="5" text-anchor="end">4.5 bar</text>`;
// Bottom status
s+=`<rect x="0" y="${H-24}" width="${W}" height="24" fill="rgba(6,182,212,.06)"/>`;
s+=`<text x="10" y="${H-9}" fill="var(--t3)" font-family="${F}" font-size="7">Condenser Water: Treated + inhibitor | DN300 CS | 28-35\u00B0C | 600 m\u00B3/h nominal</text>`;
s+=`<text x="${W-10}" y="${H-9}" fill="var(--c)" font-family="${F}" font-size="7" text-anchor="end">Auto lead-lag staging | VFD 30-100% | \u03B7>85%</text>`;
el.innerHTML=s;
}
// ===== FWS PUMP STATION HMI =====
function renderFwsPumpHmi(el){
var F='JetBrains Mono',W=780,H=480;var s='';
s+=`<rect width="${W}" height="${H}" fill="#080e1a" rx="4"/>`;
s+=`<rect x="0" y="0" width="${W}" height="26" fill="rgba(34,197,94,.08)"/>`;
s+=`<text x="10" y="17" fill="var(--g)" font-family="${F}" font-size="10" font-weight="600">FWS PUMP STATION — Facility Water (30% Propylene Glycol)</text>`;
s+=`<circle cx="400" cy="13" r="4" fill="var(--g)" opacity=".8"/><text x="408" y="17" fill="var(--g)" font-family="${F}" font-size="8">Online</text>`;
s+=`<text x="${W-10}" y="17" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="end">3\u00D7 P-FWS (N+1)</text>`;
// KPI strip
var kpis=[{l:'Total Flow',v:RI(480,520)+' m\u00B3/h',c:'var(--g)'},{l:'Discharge P',v:R(5.5,6.2)+' bar',c:'var(--g)'},{l:'Suction P',v:R(2.0,2.8)+' bar',c:'var(--c)'},{l:'Glycol',v:'30%',c:'var(--pk)'},{l:'Exp Tank',v:RI(78,88)+'%',c:'var(--p)'},{l:'Pumps',v:'2/3',c:'var(--g)'}];
for(var k=0;k<kpis.length;k++){var kx=10+k*127;
s+=`<rect x="${kx}" y="30" width="122" height="28" rx="3" fill="rgba(34,197,94,.04)" stroke="var(--g)" stroke-width=".4"/>`;
s+=`<text x="${kx+61}" y="41" fill="var(--t3)" font-family="${F}" font-size="5.5" text-anchor="middle">${kpis[k].l}</text>`;
s+=`<text x="${kx+61}" y="53" fill="${kpis[k].c}" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${kpis[k].v}</text>`;
}
// Suction header
s+=`<rect x="10" y="68" width="25" height="245" rx="3" fill="rgba(34,197,94,.04)" stroke="var(--g)" stroke-width=".8"/>`;
s+=`<text x="22" y="192" fill="var(--g)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600" transform="rotate(-90,22,192)">SUCTION DN250</text>`;
s+=`<line x1="0" y1="90" x2="10" y2="90" stroke="var(--g)" stroke-width="3" class="fR"/>`;
s+=`<text x="5" y="82" fill="var(--g)" font-family="${F}" font-size="5" text-anchor="middle">From Chiller</text>`;
s+=`<text x="5" y="105" fill="var(--g)" font-family="${F}" font-size="5" text-anchor="middle">12\u00B0C</text>`;
// 3 Pumps (compressed layout)
var fp=[{id:'P-FWS-1',st:'RUN',y:72,vfd:RI(72,88),amp:RI(60,80),dp:R(5.5,6.2),flow:RI(235,265)},
{id:'P-FWS-2',st:'RUN',y:152,vfd:RI(70,85),amp:RI(58,78),dp:R(5.4,6.1),flow:RI(230,260)},
{id:'P-FWS-3',st:'STBY',y:232,vfd:0,amp:0,dp:0,flow:0}];
fp.forEach(function(p){
var pc=p.st==='RUN'?'var(--g)':'var(--t3)';
var bg=p.st==='RUN'?'rgba(34,197,94,.04)':'rgba(107,114,128,.03)';
s+=`<rect x="45" y="${p.y}" width="690" height="72" rx="3" fill="${bg}" stroke="${pc}" stroke-width=".5"/>`;
s+=`<text x="55" y="${p.y+14}" fill="${pc}" font-family="${F}" font-size="8" font-weight="600">${p.id}</text>`;
s+=`<circle cx="125" cy="${p.y+11}" r="3.5" fill="${p.st==='RUN'?'var(--g)':'var(--o)'}"/><text x="132" y="${p.y+14}" fill="${p.st==='RUN'?'var(--g)':'var(--o)'}" font-family="${F}" font-size="6">${p.st}</text>`;
// Suction line
s+=`<line x1="35" y1="${p.y+40}" x2="70" y2="${p.y+40}" stroke="${pc}" stroke-width="1.5" class="fR"/>`;
s+=symValve(80,p.y+40,pc);
s+=`<text x="80" y="${p.y+52}" fill="var(--t3)" font-family="${F}" font-size="3.5" text-anchor="middle">SIV</text>`;
// Strainer
s+=`<rect x="95" y="${p.y+33}" width="20" height="14" rx="1.5" fill="rgba(107,114,128,.06)" stroke="var(--t3)" stroke-width=".3"/>`;
s+=`<text x="105" y="${p.y+43}" fill="var(--t3)" font-family="${F}" font-size="4" text-anchor="middle">STR</text>`;
s+=`<line x1="115" y1="${p.y+40}" x2="150" y2="${p.y+40}" stroke="${pc}" stroke-width="1.5"/>`;
// VFD Motor
s+=`<rect x="150" y="${p.y+22}" width="75" height="40" rx="3" fill="rgba(245,158,11,.05)" stroke="var(--o)" stroke-width=".5"/>`;
s+=`<text x="187" y="${p.y+32}" fill="var(--o)" font-family="${F}" font-size="5" text-anchor="middle" font-weight="600">VFD 55kW</text>`;
s+=`<circle cx="175" cy="${p.y+48}" r="10" fill="none" stroke="${pc}" stroke-width="1"/>`;
if(p.st==='RUN'){
s+=`<g><animateTransform attributeName="transform" type="rotate" from="0 175 ${p.y+48}" to="360 175 ${p.y+48}" dur="2s" repeatCount="indefinite"/>`;
s+=`<polygon points="170,${p.y+44} 180,${p.y+48} 170,${p.y+52}" fill="${pc}" fill-opacity=".4"/>`;
s+=`</g>`;
}else{s+=`<text x="175" y="${p.y+51}" fill="${pc}" font-family="${F}" font-size="7" text-anchor="middle">M</text>`;}
s+=`<text x="200" y="${p.y+46}" fill="${pc}" font-family="${F}" font-size="6" font-weight="600">${p.st==='RUN'?p.vfd+'%':'OFF'}</text>`;
s+=`<text x="200" y="${p.y+56}" fill="var(--t3)" font-family="${F}" font-size="5">${p.st==='RUN'?p.amp+'A':'0A'}</text>`;
// Discharge
s+=`<line x1="225" y1="${p.y+40}" x2="260" y2="${p.y+40}" stroke="${pc}" stroke-width="1.5"/>`;
// NRV
s+=`<polygon points="265,${p.y+35} 273,${p.y+40} 265,${p.y+45}" fill="none" stroke="${pc}" stroke-width=".5"/>`;
s+=`<line x1="273" y1="${p.y+34}" x2="273" y2="${p.y+46}" stroke="${pc}" stroke-width=".5"/>`;
s+=`<text x="269" y="${p.y+54}" fill="var(--t3)" font-family="${F}" font-size="3.5" text-anchor="middle">NRV</text>`;
s+=`<line x1="273" y1="${p.y+40}" x2="300" y2="${p.y+40}" stroke="${pc}" stroke-width="1.5" class="fR"/>`;
s+=symValve(310,p.y+40,pc);
s+=`<text x="310" y="${p.y+52}" fill="var(--t3)" font-family="${F}" font-size="3.5" text-anchor="middle">DIV</text>`;
s+=`<line x1="320" y1="${p.y+40}" x2="340" y2="${p.y+40}" stroke="${pc}" stroke-width="1.5" class="fR"/>`;
// Sensors
s+=`<circle cx="345" cy="${p.y+34}" r="4" fill="none" stroke="var(--o)" stroke-width=".4"/>`;
s+=`<text x="345" y="${p.y+36}" fill="var(--o)" font-family="${F}" font-size="3.5" text-anchor="middle">P</text>`;
s+=`<text x="345" y="${p.y+27}" fill="var(--g)" font-family="${F}" font-size="5" text-anchor="middle">${p.st==='RUN'?p.dp:'--'}</text>`;
s+=`<circle cx="365" cy="${p.y+34}" r="4" fill="none" stroke="var(--c)" stroke-width=".4"/>`;
s+=`<text x="365" y="${p.y+36}" fill="var(--c)" font-family="${F}" font-size="3.5" text-anchor="middle">F</text>`;
s+=`<text x="365" y="${p.y+27}" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">${p.st==='RUN'?p.flow:'0'}</text>`;
// Parameters
s+=`<rect x="395" y="${p.y+6}" width="330" height="60" rx="2" fill="rgba(107,114,128,.03)" stroke="var(--bd)" stroke-width=".3"/>`;
var params=[['Motor','55kW/400V/IE4'],['Vibration',p.st==='RUN'?R(1.0,3.2)+' mm/s':'--'],['Brg DE',p.st==='RUN'?R(32,40)+'\u00B0C':'--'],['Brg NDE',p.st==='RUN'?R(30,38)+'\u00B0C':'--'],['Run Hrs',p.st==='RUN'?RI(6000,15000)+'h':'--'],['Seal','Mech. OK']];
params.forEach(function(pr,i){var px=405+(i%3)*110,py=p.y+20+Math.floor(i/3)*18;
s+=`<text x="${px}" y="${py}" fill="var(--t3)" font-family="${F}" font-size="4.5">${pr[0]}</text>`;
s+=`<text x="${px+65}" y="${py}" fill="var(--g)" font-family="${F}" font-size="4.5" font-weight="600">${pr[1]}</text>`;
});
});
// Discharge header
s+=`<rect x="745" y="68" width="25" height="245" rx="3" fill="rgba(34,197,94,.04)" stroke="var(--g)" stroke-width=".8"/>`;
s+=`<text x="757" y="192" fill="var(--g)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600" transform="rotate(-90,757,192)">DISCHARGE DN250</text>`;
s+=`<line x1="770" y1="90" x2="${W}" y2="90" stroke="var(--g)" stroke-width="3" class="fR"/>`;
s+=`<text x="${W-5}" y="82" fill="var(--g)" font-family="${F}" font-size="5" text-anchor="end">To CDUs</text>`;
s+=`<text x="${W-5}" y="105" fill="var(--g)" font-family="${F}" font-size="5" text-anchor="end">6 bar | 12\u00B0C</text>`;
// ===== ANCILLARIES =====
var aY=325;
s+=`<rect x="10" y="${aY}" width="760" height="115" rx="4" fill="rgba(139,92,246,.03)" stroke="var(--p)" stroke-width=".5"/>`;
s+=tx(390,aY+14,'ANCILLARY EQUIPMENT','var(--p)',7,'middle',1);
// Expansion tank
s+=`<rect x="20" y="${aY+22}" width="110" height="85" rx="3" fill="rgba(139,92,246,.05)" stroke="var(--p)" stroke-width=".5"/>`;
s+=tx(75,aY+34,'EXPANSION TANK','var(--p)',5,'middle',1);
s+=`<rect x="50" y="${aY+40}" width="50" height="40" rx="2" fill="rgba(139,92,246,.08)" stroke="var(--p)" stroke-width=".4"/>`;
var expLvl=RI(78,88);
s+=`<rect x="50" y="${aY+40+(40*(100-expLvl)/100)}" width="50" height="${40*expLvl/100}" rx="1" fill="rgba(139,92,246,.2)"/>`;
s+=`<text x="75" y="${aY+63}" fill="var(--p)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">${expLvl}%</text>`;
s+=tx(75,aY+90,'Bladder 500L','var(--t3)',4,'middle');
s+=tx(75,aY+100,'PRV 6 bar','var(--t3)',4,'middle');
// Chemical dosing
s+=`<rect x="145" y="${aY+22}" width="110" height="85" rx="3" fill="rgba(236,72,153,.05)" stroke="var(--pk)" stroke-width=".5"/>`;
s+=tx(200,aY+34,'CHEM DOSING','var(--pk)',5,'middle',1);
s+=tx(200,aY+48,'Glycol','var(--t3)',4.5,'middle');
s+=`<text x="200" y="${aY+58}" fill="var(--pk)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">30% PG</text>`;
s+=tx(200,aY+72,'pH','var(--t3)',4.5,'middle');
s+=`<text x="200" y="${aY+82}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">${R(7.2,8.5)}</text>`;
s+=tx(200,aY+95,'Inhibitor','var(--t3)',4.5,'middle');
s+=`<text x="200" y="${aY+105}" fill="var(--g)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600">Auto-dose</text>`;
// Air separator
s+=`<rect x="270" y="${aY+22}" width="110" height="85" rx="3" fill="rgba(107,114,128,.05)" stroke="var(--t3)" stroke-width=".5"/>`;
s+=tx(325,aY+34,'AIR SEPARATOR','var(--t3)',5,'middle',1);
s+=tx(325,aY+50,'Tangential vortex','var(--t3)',4.5,'middle');
s+=tx(325,aY+62,'Auto air vent','var(--t3)',4.5,'middle');
s+=`<text x="325" y="${aY+78}" fill="var(--g)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600">Active</text>`;
// Strainer
s+=`<rect x="395" y="${aY+22}" width="110" height="85" rx="3" fill="rgba(107,114,128,.05)" stroke="var(--t3)" stroke-width=".5"/>`;
s+=tx(450,aY+34,'Y-STRAINER','var(--t3)',5,'middle',1);
s+=tx(450,aY+48,'Mesh: 25\u00B5m','var(--t3)',4.5,'middle');
s+=`<text x="450" y="${aY+62}" fill="var(--c)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600">\u0394P ${R(0.1,0.3)} bar</text>`;
s+=tx(450,aY+78,'DN250 SS basket','var(--t3)',4.5,'middle');
// Make-up water
s+=`<rect x="520" y="${aY+22}" width="110" height="85" rx="3" fill="rgba(6,182,212,.05)" stroke="var(--c)" stroke-width=".5"/>`;
s+=tx(575,aY+34,'MAKE-UP WATER','var(--c)',5,'middle',1);
s+=tx(575,aY+48,'DI water fill','var(--t3)',4.5,'middle');
s+=`<text x="575" y="${aY+62}" fill="var(--c)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600">Auto level</text>`;
s+=tx(575,aY+78,'Backflow preventer','var(--t3)',4.5,'middle');
// Pressure relief
s+=`<rect x="645" y="${aY+22}" width="115" height="85" rx="3" fill="rgba(239,68,68,.05)" stroke="var(--r)" stroke-width=".5"/>`;
s+=tx(702,aY+34,'SAFETY','var(--r)',5,'middle',1);
s+=tx(702,aY+48,'PRV: 6 bar set','var(--t3)',4.5,'middle');
s+=`<text x="702" y="${aY+62}" fill="var(--g)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600">Sealed</text>`;
s+=tx(702,aY+78,'PSV: 8 bar burst','var(--t3)',4.5,'middle');
s+=tx(702,aY+92,'Drain: manual valve','var(--t3)',4.5,'middle');
// Bottom status
s+=`<rect x="0" y="${H-24}" width="${W}" height="24" fill="rgba(34,197,94,.06)"/>`;
s+=`<text x="10" y="${H-9}" fill="var(--t3)" font-family="${F}" font-size="7">FWS: 30% PG glycol | DN250 CS insulated | 12-22\u00B0C | 500 m\u00B3/h nominal | Cp\u22483.85 kJ/kg\u00B7K</text>`;
s+=`<text x="${W-10}" y="${H-9}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="end">Auto lead-lag | VFD 30-100% | \u03B7>85%</text>`;
el.innerHTML=s;
}
// ===== TCS MANIFOLD HMI =====
function renderTcsHmi(el){
var F='JetBrains Mono',W=780,H=480;var s='';
s+=`<rect width="${W}" height="${H}" fill="#080e1a" rx="4"/>`;
s+=`<rect x="0" y="0" width="${W}" height="26" fill="rgba(236,72,153,.08)"/>`;
s+=`<text x="10" y="17" fill="var(--pk)" font-family="${F}" font-size="10" font-weight="600">TCS MANIFOLD & RACK DISTRIBUTION</text>`;
s+=`<circle cx="310" cy="13" r="4" fill="var(--g)" opacity=".8"/><text x="318" y="17" fill="var(--g)" font-family="${F}" font-size="8">Online</text>`;
s+=`<text x="${W-10}" y="17" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="end">DI Water <5\u00B5S/cm</text>`;
// KPI strip
var kpis=[{l:'TCS Supply',v:R(34.5,35.8)+'\u00B0C',c:'var(--c)'},{l:'TCS Return',v:R(44.0,45.5)+'\u00B0C',c:'var(--o)'},{l:'\u0394T',v:R(9.2,10.2)+'\u00B0C',c:'var(--g)'},{l:'Total Flow',v:RI(8500,9500)+' LPM',c:'var(--c)'},{l:'Pressure',v:'4/3 bar',c:'var(--o)'},{l:'Racks',v:'12/12',c:'var(--g)'}];
for(var k=0;k<kpis.length;k++){var kx=10+k*127;
s+=`<rect x="${kx}" y="30" width="122" height="28" rx="3" fill="rgba(236,72,153,.04)" stroke="var(--pk)" stroke-width=".4"/>`;
s+=`<text x="${kx+61}" y="41" fill="var(--t3)" font-family="${F}" font-size="5.5" text-anchor="middle">${kpis[k].l}</text>`;
s+=`<text x="${kx+61}" y="53" fill="${kpis[k].c}" font-family="${F}" font-size="10" text-anchor="middle" font-weight="600">${kpis[k].v}</text>`;
}
// Supply header
s+=`<rect x="10" y="68" width="${W-20}" height="18" rx="3" fill="rgba(6,182,212,.06)" stroke="var(--c)" stroke-width=".8"/>`;
s+=`<text x="20" y="80" fill="var(--c)" font-family="${F}" font-size="7" font-weight="600">SUPPLY HEADER DN150 SS316L — ${R(34.5,35.8)}\u00B0C — 4 bar</text>`;
s+=`<line x1="0" y1="77" x2="10" y2="77" stroke="var(--c)" stroke-width="3" class="fR"/>`;
s+=`<text x="5" y="69" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">From CDU</text>`;
// Supply flow animation
s+=`<line x1="10" y1="77" x2="${W-10}" y2="77" stroke="var(--c)" stroke-width="2" stroke-dasharray="12 6"><animate attributeName="stroke-dashoffset" values="0;-36" dur="1s" repeatCount="indefinite"/></line>`;
// 12 Rack branches
var rackY=95;
for(var i=0;i<12;i++){
var rx=15+i*63,ry=rackY;
var rFlow=RI(72,88),rIn=R(34.5,35.8),rOut=R(43.5,45.2);
s+=`<rect x="${rx}" y="${ry}" width="58" height="145" rx="3" fill="rgba(34,197,94,.04)" stroke="var(--g)" stroke-width=".4"/>`;
// Rack label
s+=`<text x="${rx+29}" y="${ry+12}" fill="var(--g)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600">R${String(i+1).padStart(2,'0')}</text>`;
// Supply drop
s+=`<line x1="${rx+15}" y1="86" x2="${rx+15}" y2="${ry+18}" stroke="var(--c)" stroke-width="1.5" stroke-dasharray="4 2"><animate attributeName="stroke-dashoffset" values="0;-12" dur=".8s" repeatCount="indefinite"/></line>`;
// Ball valve
s+=`<circle cx="${rx+15}" cy="${ry+22}" r="3" fill="none" stroke="var(--g)" stroke-width=".5"/>`;
s+=`<line x1="${rx+12}" y1="${ry+22}" x2="${rx+18}" y2="${ry+22}" stroke="var(--g)" stroke-width=".5"/>`;
// QD connector
s+=`<rect x="${rx+8}" y="${ry+28}" width="14" height="6" rx="1" fill="rgba(6,182,212,.15)" stroke="var(--c)" stroke-width=".3"/>`;
s+=`<text x="${rx+15}" y="${ry+33}" fill="var(--c)" font-family="${F}" font-size="3" text-anchor="middle">QD</text>`;
// Cold plates representation
for(var cp=0;cp<4;cp++){
s+=`<rect x="${rx+3}" y="${ry+38+cp*16}" width="52" height="13" rx="1" fill="rgba(34,197,94,.06)" stroke="var(--g)" stroke-width=".2"/>`;
s+=`<text x="${rx+29}" y="${ry+47+cp*16}" fill="var(--g)" font-family="${F}" font-size="3" text-anchor="middle">${cp<3?'GPU \u00D74':'NVS \u00D72'}</text>`;
// Flow animation inside
s+=`<line x1="${rx+5}" y1="${ry+44+cp*16}" x2="${rx+53}" y2="${ry+44+cp*16}" stroke="var(--c)" stroke-width=".5" opacity=".3" stroke-dasharray="3 2"><animate attributeName="stroke-dashoffset" values="0;-10" dur="${.6+cp*.1}s" repeatCount="indefinite"/></line>`;
}
// Return riser
s+=`<line x1="${rx+43}" y1="${ry+105}" x2="${rx+43}" y2="${ry+140}" stroke="var(--o)" stroke-width="1.5" stroke-dasharray="4 2"><animate attributeName="stroke-dashoffset" values="0;12" dur=".8s" repeatCount="indefinite"/></line>`;
// Parameters
s+=`<text x="${rx+29}" y="${ry+116}" fill="var(--c)" font-family="${F}" font-size="3.5" text-anchor="middle">${rIn}\u00B0C</text>`;
s+=`<text x="${rx+29}" y="${ry+124}" fill="var(--o)" font-family="${F}" font-size="3.5" text-anchor="middle">${rOut}\u00B0C</text>`;
s+=`<text x="${rx+29}" y="${ry+132}" fill="var(--t3)" font-family="${F}" font-size="3.5" text-anchor="middle">${rFlow} LPM</text>`;
// Leak sensor indicator
s+=`<circle cx="${rx+50}" cy="${ry+138}" r="2" fill="var(--g)" opacity=".6"><animate attributeName="opacity" values=".3;.8;.3" dur="2s" repeatCount="indefinite"/></circle>`;
}
// Return header
var retY=rackY+150;
s+=`<rect x="10" y="${retY}" width="${W-20}" height="18" rx="3" fill="rgba(239,68,68,.06)" stroke="var(--o)" stroke-width=".8"/>`;
s+=`<text x="20" y="${retY+12}" fill="var(--o)" font-family="${F}" font-size="7" font-weight="600">RETURN HEADER DN150 SS316L — ${R(44.0,45.5)}\u00B0C — 3 bar</text>`;
s+=`<line x1="10" y1="${retY+9}" x2="${W-10}" y2="${retY+9}" stroke="var(--o)" stroke-width="2" stroke-dasharray="12 6"><animate attributeName="stroke-dashoffset" values="0;36" dur="1s" repeatCount="indefinite"/></line>`;
s+=`<line x1="${W-10}" y1="${retY+9}" x2="${W}" y2="${retY+9}" stroke="var(--o)" stroke-width="3" class="fL"/>`;
s+=`<text x="${W-5}" y="${retY+1}" fill="var(--o)" font-family="${F}" font-size="5" text-anchor="end">To CDU</text>`;
// ===== SAFETY & MONITORING =====
var saY=retY+28;
s+=`<rect x="10" y="${saY}" width="370" height="100" rx="4" fill="rgba(239,68,68,.03)" stroke="var(--r)" stroke-width=".5"/>`;
s+=tx(195,saY+14,'LEAK DETECTION & SAFETY','var(--r)',7,'middle',1);
var safety=[['Leak Rope','800m continuous | All piping runs','var(--g)','OK'],['Point Sensors','180 probes at QD connections','var(--g)','All Clear'],['Drip Trays','SS 1mm under every CDU/rack','var(--g)','Dry'],['Auto Shutoff','Motor valve <3s on detection','var(--g)','Armed'],['Floor Drain','1:100 slope | 500 L/min capacity','var(--g)','Clear'],['Conductivity','Inline <5\u00B5S/cm alarm >10\u00B5S','var(--g)',R(2.5,4.5)+' \u00B5S']];
safety.forEach(function(sa,i){var sy=saY+26+i*12;
s+=`<text x="20" y="${sy}" fill="var(--t3)" font-family="${F}" font-size="5">${sa[0]}</text>`;
s+=`<text x="100" y="${sy}" fill="var(--t2)" font-family="${F}" font-size="5">${sa[1]}</text>`;
s+=`<text x="360" y="${sy}" fill="${sa[2]}" font-family="${F}" font-size="5" text-anchor="end" font-weight="600">${sa[3]}</text>`;
});
// Fluid specs
s+=`<rect x="395" y="${saY}" width="375" height="100" rx="4" fill="rgba(6,182,212,.03)" stroke="var(--c)" stroke-width=".5"/>`;
s+=tx(582,saY+14,'TCS FLUID SPECIFICATIONS','var(--c)',7,'middle',1);
var specs=[['Fluid','Deionized water (DI)'],['Conductivity','<5 \u00B5S/cm (alarm >10)'],['pH Range','7.0 - 9.0'],['Piping Material','SS316L orbital welded'],['Supply Header','DN150 | 4 bar'],['Return Header','DN150 | 3 bar'],['Branch','DN50 SS flex + QD blind-mate'],['Cold Plates','Cu microchannel | 72 per rack']];
specs.forEach(function(sp,i){var sy=saY+26+i*12;
s+=`<text x="405" y="${sy}" fill="var(--t3)" font-family="${F}" font-size="5">${sp[0]}</text>`;
s+=`<text x="500" y="${sy}" fill="var(--t2)" font-family="${F}" font-size="5">${sp[1]}</text>`;
});
// Bottom status
s+=`<rect x="0" y="${H-24}" width="${W}" height="24" fill="rgba(236,72,153,.06)"/>`;
s+=`<text x="10" y="${H-9}" fill="var(--t3)" font-family="${F}" font-size="7">TCS: DI water | DN150 SS316L | 35-45\u00B0C | \u0394T ~10\u00B0C | 80 LPM per rack</text>`;
s+=`<text x="${W-10}" y="${H-9}" fill="var(--pk)" font-family="${F}" font-size="7" text-anchor="end">12 racks \u00D7 72 cold plates = 864 total | Leak detection: All zones OK</text>`;
el.innerHTML=s;
}
// Auto-refresh equipment HMI
setInterval(function(){
if(!hmi.classList.contains('show'))return;
var t=title.textContent;
if(t==='CW Pump Station')renderCwPumpHmi(svg);
else if(t==='FWS Pump Station')renderFwsPumpHmi(svg);
else if(t==='TCS Manifold')renderTcsHmi(svg);
},3000);
})();

// ===== RACK COMPONENT DETAIL MODALS =====
(function(){
var modal=$('rackModal'),svg=$('rackModalSvg'),titleEl=$('rackModalTitle'),typeEl=$('rackModalType'),closeBtn=$('rackModalClose');
var rackSvg=$('rackSvg');
if(!modal||!svg||!rackSvg)return;
// Close handlers
closeBtn.addEventListener('click',function(){modal.classList.remove('show')});
document.addEventListener('click',function(e){
if(modal.classList.contains('show')&&!modal.contains(e.target)&&!e.target.closest('[data-rack]'))modal.classList.remove('show');
});
// Click handler — event delegation on rackSvg
rackSvg.addEventListener('click',function(e){
var g=e.target.closest('[data-rack]');
if(!g)return;
var type=g.getAttribute('data-rack'),id=g.getAttribute('data-id')||'';
if(type==='ct'){titleEl.textContent='COMPUTE TRAY CT-'+id+' \u2014 GB200 NVL72';typeEl.textContent='Block Diagram';renderComputeTray(svg,parseInt(id));}
else if(type==='ns'){titleEl.textContent='NVSwitch TRAY NS-'+id+' \u2014 NVLink5 Fabric';typeEl.textContent='Block Diagram';renderNVSwitchTray(svg,parseInt(id));}
else{var labels={psu:'PSU Shelf '+id,manifold:'DLC Manifold',busbar:'48VDC Bus Bar',backplane:'NVLink Backplane',leak:'Leak Detection'};
titleEl.textContent=labels[type]||type;typeEl.textContent='Detail';renderInfraDetail(svg,type,id);}
modal.style.left=Math.max(10,(window.innerWidth-820)/2)+'px';
modal.style.top=Math.max(10,(window.innerHeight-540)/2)+'px';
modal.classList.add('show');
e.stopPropagation();
});
// ===== RENDER: Compute Tray Block Diagram =====
function renderComputeTray(el,id){
var F='JetBrains Mono',W=800,H=500;var s='';
s+=`<rect width="${W}" height="${H}" fill="#080e1a" rx="4"/>`;
// Header
s+=`<rect x="0" y="0" width="${W}" height="28" fill="rgba(34,197,94,.08)"/>`;
s+=`<text x="10" y="18" fill="var(--g)" font-family="${F}" font-size="11" font-weight="600">COMPUTE TRAY CT-${id} \u2014 GB200 NVL72 \u2014 Block Diagram</text>`;
s+=`<text x="${W-10}" y="18" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="end">2U Blind-Mate Hot-Swap</text>`;
// 4x B200 GPU boxes
var gpuW=120,gpuH=140,gpuY=48,gpuGap=12;
var gpuStartX=40;
for(var i=0;i<4;i++){var gx=gpuStartX+i*(gpuW+gpuGap);
s+=`<rect x="${gx}" y="${gpuY}" width="${gpuW}" height="${gpuH}" rx="4" fill="rgba(34,197,94,.06)" stroke="var(--g)" stroke-width="1"/>`;
s+=`<circle cx="${gx+2}" cy="${gpuY+2}" r="3" fill="var(--g)" opacity=".7"/>`;
s+=`<text x="${gx+gpuW/2}" y="${gpuY+16}" fill="var(--g)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">B200 GPU</text>`;
s+=`<text x="${gx+gpuW/2}" y="${gpuY+30}" fill="var(--t2)" font-family="${F}" font-size="7" text-anchor="middle">Blackwell Arch</text>`;
s+=`<rect x="${gx+8}" y="${gpuY+38}" width="${gpuW-16}" height="14" rx="2" fill="rgba(139,92,246,.08)" stroke="var(--p)" stroke-width=".4"/>`;
s+=`<text x="${gx+gpuW/2}" y="${gpuY+48}" fill="var(--p)" font-family="${F}" font-size="7" text-anchor="middle">HBM3e 192 GB</text>`;
s+=`<text x="${gx+gpuW/2}" y="${gpuY+66}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">BW: 8 TB/s</text>`;
s+=`<text x="${gx+gpuW/2}" y="${gpuY+78}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">FP4: 20 PFLOPS</text>`;
s+=`<text x="${gx+gpuW/2}" y="${gpuY+90}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">FP8: 10 PFLOPS</text>`;
s+=`<text x="${gx+gpuW/2}" y="${gpuY+104}" fill="var(--o)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">1,000W TDP</text>`;
// PCIe6 connection arrow down
s+=`<line x1="${gx+gpuW/2}" y1="${gpuY+gpuH}" x2="${gx+gpuW/2}" y2="${gpuY+gpuH+22}" stroke="var(--c)" stroke-width="1.5" stroke-dasharray="4 2"/>`;
s+=`<text x="${gx+gpuW/2}" y="${gpuY+gpuH+18}" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">PCIe6</text>`;
s+=`<text x="${gx+gpuW/2}" y="${gpuY+gpuH+32}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">128GB/s</text>`;
}
// CX-8 NIC box (right side)
var nicX=gpuStartX+4*(gpuW+gpuGap)+20,nicY=gpuY;
s+=`<rect x="${nicX}" y="${nicY}" width="105" height="${gpuH}" rx="4" fill="rgba(59,130,246,.06)" stroke="var(--b)" stroke-width="1"/>`;
s+=`<circle cx="${nicX+2}" cy="${nicY+2}" r="3" fill="var(--g)" opacity=".7"/>`;
s+=`<text x="${nicX+52}" y="${nicY+16}" fill="var(--b)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">CX-8 NIC</text>`;
s+=`<text x="${nicX+52}" y="${nicY+30}" fill="var(--t2)" font-family="${F}" font-size="7" text-anchor="middle">ConnectX-8</text>`;
s+=`<text x="${nicX+52}" y="${nicY+46}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">800G InfiniBand</text>`;
s+=`<text x="${nicX+52}" y="${nicY+60}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">4\u00D7 OSFP ports</text>`;
s+=`<text x="${nicX+52}" y="${nicY+74}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">XDR 200Gb/s/ln</text>`;
s+=`<text x="${nicX+52}" y="${nicY+90}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">RDMA / GPUDirect</text>`;
// PCIe6 down from NIC
s+=`<line x1="${nicX+52}" y1="${nicY+gpuH}" x2="${nicX+52}" y2="${nicY+gpuH+22}" stroke="var(--c)" stroke-width="1.5" stroke-dasharray="4 2"/>`;
s+=`<text x="${nicX+52}" y="${nicY+gpuH+18}" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">PCIe6</text>`;
// 2x Grace72 CPU boxes
var cpuY=gpuY+gpuH+40,cpuW=220,cpuH=85;
for(var c=0;c<2;c++){var cx=gpuStartX+c*(cpuW+80);
s+=`<rect x="${cx}" y="${cpuY}" width="${cpuW}" height="${cpuH}" rx="4" fill="rgba(6,182,212,.06)" stroke="var(--c)" stroke-width="1"/>`;
s+=`<circle cx="${cx+2}" cy="${cpuY+2}" r="3" fill="var(--g)" opacity=".7"/>`;
s+=`<text x="${cx+cpuW/2}" y="${cpuY+16}" fill="var(--c)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">Grace72 CPU</text>`;
s+=`<text x="${cx+cpuW/2}" y="${cpuY+30}" fill="var(--t2)" font-family="${F}" font-size="7" text-anchor="middle">72 ARM Neoverse V2 cores</text>`;
s+=`<text x="${cx+cpuW/2}" y="${cpuY+44}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">512 GB LPDDR5X</text>`;
s+=`<text x="${cx+cpuW/2}" y="${cpuY+58}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">BW: 546 GB/s</text>`;
s+=`<text x="${cx+cpuW/2}" y="${cpuY+72}" fill="var(--o)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">250W TDP</text>`;
}
// C2C link between CPUs
var c2cY=cpuY+cpuH/2;
s+=`<line x1="${gpuStartX+cpuW}" y1="${c2cY}" x2="${gpuStartX+cpuW+80}" y2="${c2cY}" stroke="var(--pk)" stroke-width="2.5"/>`;
s+=`<text x="${gpuStartX+cpuW+40}" y="${c2cY-6}" fill="var(--pk)" font-family="${F}" font-size="7" text-anchor="middle" font-weight="600">C2C 900 GB/s</text>`;
s+=`<polygon points="${gpuStartX+cpuW+2},${c2cY-3} ${gpuStartX+cpuW+8},${c2cY} ${gpuStartX+cpuW+2},${c2cY+3}" fill="var(--pk)"/>`;
s+=`<polygon points="${gpuStartX+cpuW+78},${c2cY-3} ${gpuStartX+cpuW+72},${c2cY} ${gpuStartX+cpuW+78},${c2cY+3}" fill="var(--pk)"/>`;
// NVLink section
var nvY=cpuY+cpuH+20;
s+=`<text x="${W/2}" y="${nvY}" fill="var(--pk)" font-family="${F}" font-size="7" text-anchor="middle">\u2193\u2193\u2193 18 NVLink5 per GPU \u2193\u2193\u2193</text>`;
s+=`<rect x="30" y="${nvY+6}" width="${W-60}" height="22" rx="3" fill="rgba(236,72,153,.06)" stroke="var(--pk)" stroke-width="1.2"/>`;
s+=`<text x="${W/2}" y="${nvY+21}" fill="var(--pk)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">\u2550\u2550\u2550 NVLink Backplane (900 GB/s per GPU) \u2550\u2550\u2550</text>`;
// Power & Cooling bottom strip
var bsY=nvY+40;
s+=`<rect x="30" y="${bsY}" width="${W-60}" height="34" rx="3" fill="rgba(245,158,11,.04)" stroke="var(--bd2)" stroke-width=".6"/>`;
s+=`<text x="50" y="${bsY+14}" fill="var(--o)" font-family="${F}" font-size="8" font-weight="600">PWR:</text>`;
s+=`<text x="85" y="${bsY+14}" fill="var(--t2)" font-family="${F}" font-size="7">48VDC \u2500[\u2500Fuse\u2500]\u2500\u25B6 4,800W total (4\u00D71000W GPU + 2\u00D7250W CPU + NIC)</text>`;
s+=`<text x="50" y="${bsY+28}" fill="var(--c)" font-family="${F}" font-size="8" font-weight="600">COOL:</text>`;
s+=`<text x="90" y="${bsY+28}" fill="var(--t2)" font-family="${F}" font-size="7">TCS IN 35\u00B0C \u2500[Cu Cold Plate]\u2500\u25B6 TCS OUT 45\u00B0C | Blind-mate QD | \u0394T ~10\u00B0C</text>`;
el.innerHTML=s;
}
// ===== RENDER: NVSwitch Tray Block Diagram =====
function renderNVSwitchTray(el,id){
var F='JetBrains Mono',W=800,H=500;var s='';
s+=`<rect width="${W}" height="${H}" fill="#080e1a" rx="4"/>`;
// Header
s+=`<rect x="0" y="0" width="${W}" height="28" fill="rgba(236,72,153,.08)"/>`;
s+=`<text x="10" y="18" fill="var(--pk)" font-family="${F}" font-size="11" font-weight="600">NVSwitch TRAY NS-${id} \u2014 NVLink5 Fabric Switch</text>`;
s+=`<text x="${W-10}" y="18" fill="var(--t3)" font-family="${F}" font-size="8" text-anchor="end">1U Blind-Mate</text>`;
// Left CT connections
var ctStartY=55,ctH=32,ctGap=6;
s+=`<text x="20" y="46" fill="var(--t3)" font-family="${F}" font-size="7" font-weight="600">LOCAL RACK</text>`;
for(var i=0;i<9;i++){var cy=ctStartY+i*(ctH+ctGap);
s+=`<rect x="20" y="${cy}" width="80" height="${ctH}" rx="3" fill="rgba(34,197,94,.06)" stroke="var(--g)" stroke-width=".6"/>`;
s+=`<text x="60" y="${cy+14}" fill="var(--g)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">CT-${i+1}</text>`;
s+=`<text x="60" y="${cy+26}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">4\u00D7B200</text>`;
// Connection lines to ASIC #1
s+=`<line x1="100" y1="${cy+ctH/2}" x2="230" y2="${cy+ctH/2}" stroke="var(--pk)" stroke-width="1" opacity=".4" stroke-dasharray="4 2"/>`;
}
// NVSwitch ASIC #1 (center-left)
var asicW=150,asicH=300,asic1X=230,asicY=55;
s+=`<rect x="${asic1X}" y="${asicY}" width="${asicW}" height="${asicH}" rx="5" fill="rgba(236,72,153,.06)" stroke="var(--pk)" stroke-width="1.2"/>`;
s+=`<circle cx="${asic1X+2}" cy="${asicY+2}" r="4" fill="var(--g)"/>`;
s+=`<text x="${asic1X+asicW/2}" y="${asicY+22}" fill="var(--pk)" font-family="${F}" font-size="11" text-anchor="middle" font-weight="600">NVSwitch5</text>`;
s+=`<text x="${asic1X+asicW/2}" y="${asicY+38}" fill="var(--t2)" font-family="${F}" font-size="8" text-anchor="middle">ASIC #1</text>`;
s+=`<rect x="${asic1X+10}" y="${asicY+50}" width="${asicW-20}" height="16" rx="2" fill="rgba(139,92,246,.08)" stroke="var(--p)" stroke-width=".4"/>`;
s+=`<text x="${asic1X+asicW/2}" y="${asicY+62}" fill="var(--p)" font-family="${F}" font-size="7" text-anchor="middle">64 NVLink5 Ports</text>`;
s+=`<text x="${asic1X+asicW/2}" y="${asicY+82}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">28.8 Tb/s bandwidth</text>`;
s+=`<text x="${asic1X+asicW/2}" y="${asicY+98}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">Full Crossbar</text>`;
s+=`<text x="${asic1X+asicW/2}" y="${asicY+114}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">All-reduce in-network</text>`;
s+=`<text x="${asic1X+asicW/2}" y="${asicY+140}" fill="var(--o)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">400W</text>`;
// ASIC-to-ASIC link
var a2aY=asicY+asicH/2;
s+=`<line x1="${asic1X+asicW}" y1="${a2aY}" x2="${asic1X+asicW+60}" y2="${a2aY}" stroke="var(--pk)" stroke-width="3"/>`;
s+=`<text x="${asic1X+asicW+30}" y="${a2aY-8}" fill="var(--pk)" font-family="${F}" font-size="6" text-anchor="middle" font-weight="600">Internal</text>`;
s+=`<text x="${asic1X+asicW+30}" y="${a2aY+14}" fill="var(--pk)" font-family="${F}" font-size="6" text-anchor="middle">Crossbar</text>`;
s+=`<polygon points="${asic1X+asicW+2},${a2aY-3} ${asic1X+asicW+8},${a2aY} ${asic1X+asicW+2},${a2aY+3}" fill="var(--pk)"/>`;
s+=`<polygon points="${asic1X+asicW+58},${a2aY-3} ${asic1X+asicW+52},${a2aY} ${asic1X+asicW+58},${a2aY+3}" fill="var(--pk)"/>`;
// NVSwitch ASIC #2 (center-right)
var asic2X=asic1X+asicW+60;
s+=`<rect x="${asic2X}" y="${asicY}" width="${asicW}" height="${asicH}" rx="5" fill="rgba(236,72,153,.06)" stroke="var(--pk)" stroke-width="1.2"/>`;
s+=`<circle cx="${asic2X+2}" cy="${asicY+2}" r="4" fill="var(--g)"/>`;
s+=`<text x="${asic2X+asicW/2}" y="${asicY+22}" fill="var(--pk)" font-family="${F}" font-size="11" text-anchor="middle" font-weight="600">NVSwitch5</text>`;
s+=`<text x="${asic2X+asicW/2}" y="${asicY+38}" fill="var(--t2)" font-family="${F}" font-size="8" text-anchor="middle">ASIC #2</text>`;
s+=`<rect x="${asic2X+10}" y="${asicY+50}" width="${asicW-20}" height="16" rx="2" fill="rgba(139,92,246,.08)" stroke="var(--p)" stroke-width=".4"/>`;
s+=`<text x="${asic2X+asicW/2}" y="${asicY+62}" fill="var(--p)" font-family="${F}" font-size="7" text-anchor="middle">64 NVLink5 Ports</text>`;
s+=`<text x="${asic2X+asicW/2}" y="${asicY+82}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">28.8 Tb/s bandwidth</text>`;
s+=`<text x="${asic2X+asicW/2}" y="${asicY+98}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">Full Crossbar</text>`;
s+=`<text x="${asic2X+asicW/2}" y="${asicY+114}" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="middle">All-reduce in-network</text>`;
s+=`<text x="${asic2X+asicW/2}" y="${asicY+140}" fill="var(--o)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">400W</text>`;
// Right CT connections (adjacent rack)
s+=`<text x="${W-20}" y="46" fill="var(--t3)" font-family="${F}" font-size="7" text-anchor="end" font-weight="600">ADJACENT RACK</text>`;
for(var i=0;i<9;i++){var cy=ctStartY+i*(ctH+ctGap);
s+=`<rect x="${W-100}" y="${cy}" width="80" height="${ctH}" rx="3" fill="rgba(34,197,94,.04)" stroke="var(--g)" stroke-width=".4"/>`;
s+=`<text x="${W-60}" y="${cy+14}" fill="var(--g)" font-family="${F}" font-size="8" text-anchor="middle">CT-${i+1}</text>`;
s+=`<text x="${W-60}" y="${cy+26}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">4\u00D7B200</text>`;
s+=`<line x1="${asic2X+asicW}" y1="${cy+ctH/2}" x2="${W-100}" y2="${cy+ctH/2}" stroke="var(--pk)" stroke-width="1" opacity=".4" stroke-dasharray="4 2"/>`;
}
// Bottom info strip
var bsY=asicY+asicH+18;
s+=`<rect x="20" y="${bsY}" width="${W-40}" height="48" rx="3" fill="rgba(107,114,128,.04)" stroke="var(--bd2)" stroke-width=".6"/>`;
s+=`<text x="40" y="${bsY+14}" fill="var(--t2)" font-family="${F}" font-size="7">Interface: Blind-mate passive Cu cartridge, NRZ 200 Gb/s per lane</text>`;
s+=`<text x="40" y="${bsY+28}" fill="var(--t2)" font-family="${F}" font-size="7">Mgmt: BMC via OOB 25GbE, Redfish API | SRAM ECC, hardware watchdog</text>`;
s+=`<text x="40" y="${bsY+42}" fill="var(--t2)" font-family="${F}" font-size="7">Power: ~800W (2\u00D7 400W ASIC) | Cool: Cu cold plate on TCS 35/45\u00B0C loop</text>`;
el.innerHTML=s;
}
// ===== RENDER: Infrastructure Detail (PSU, Manifold, BusBar, Backplane, Leak) =====
function renderInfraDetail(el,type,id){
var F='JetBrains Mono',W=800,H=500;var s='';
s+=`<rect width="${W}" height="${H}" fill="#080e1a" rx="4"/>`;
switch(type){
case 'psu':
s+=`<rect x="0" y="0" width="${W}" height="28" fill="rgba(245,158,11,.08)"/>`;
s+=`<text x="10" y="18" fill="var(--o)" font-family="${F}" font-size="11" font-weight="600">PSU Shelf ${id} \u2014 400VAC \u2192 48VDC Rectifier Assembly [3U]</text>`;
// 6 PSU modules
var mW=105,mH=200,mY=50,mGap=15;
for(var i=0;i<6;i++){var mx=30+i*(mW+mGap);
s+=`<rect x="${mx}" y="${mY}" width="${mW}" height="${mH}" rx="4" fill="rgba(245,158,11,.05)" stroke="var(--o)" stroke-width="${i<5?'1':'.5'}"/>`;
s+=`<circle cx="${mx+mW-8}" cy="${mY+8}" r="4" fill="${i<5?'var(--g)':'var(--t3)'}" opacity=".7"/>`;
s+=`<text x="${mx+mW/2}" y="${mY+22}" fill="var(--o)" font-family="${F}" font-size="9" text-anchor="middle" font-weight="600">PSU-${i+1}</text>`;
s+=`<text x="${mx+mW/2}" y="${mY+38}" fill="var(--t2)" font-family="${F}" font-size="7" text-anchor="middle">${i<5?'Active':'N+1 Stby'}</text>`;
s+=`<rect x="${mx+8}" y="${mY+48}" width="${mW-16}" height="14" rx="2" fill="rgba(6,182,212,.06)" stroke="var(--c)" stroke-width=".3"/>`;
s+=`<text x="${mx+mW/2}" y="${mY+58}" fill="var(--c)" font-family="${F}" font-size="6" text-anchor="middle">3 kW Module</text>`;
s+=`<text x="${mx+mW/2}" y="${mY+78}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">400VAC 3\u03D5 Input</text>`;
s+=`<text x="${mx+mW/2}" y="${mY+92}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">48VDC Output</text>`;
s+=`<text x="${mx+mW/2}" y="${mY+106}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">\u03B7 > 97.5%</text>`;
s+=`<text x="${mx+mW/2}" y="${mY+120}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">PF > 0.99</text>`;
s+=`<text x="${mx+mW/2}" y="${mY+138}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Hot-swap</text>`;
s+=`<text x="${mx+mW/2}" y="${mY+152}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">Front-load</text>`;
s+=`<text x="${mx+mW/2}" y="${mY+170}" fill="var(--t3)" font-family="${F}" font-size="6" text-anchor="middle">PMBus 1.3</text>`;
s+=`<text x="${mx+mW/2}" y="${mY+188}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">DCOK+OTP+OCP</text>`;
}
// Bus connection at bottom
var busY=mY+mH+20;
s+=`<rect x="30" y="${busY}" width="${W-60}" height="18" rx="2" fill="rgba(245,158,11,.04)" stroke="var(--o)" stroke-width=".8"/>`;
s+=`<text x="${W/2}" y="${busY+13}" fill="var(--o)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">\u2550\u2550\u2550 48VDC Output Bus \u2192 Vertical Cu Bus Bar (4,000A) \u2550\u2550\u2550</text>`;
// Specs strip
var spY=busY+30;
s+=`<rect x="30" y="${spY}" width="${W-60}" height="48" rx="3" fill="rgba(107,114,128,.04)" stroke="var(--bd2)" stroke-width=".6"/>`;
s+=`<text x="50" y="${spY+14}" fill="var(--t2)" font-family="${F}" font-size="7">Configuration: 5+1 (N+1 redundancy) | Total capacity: 18 kW | Operating: 15 kW</text>`;
s+=`<text x="50" y="${spY+28}" fill="var(--t2)" font-family="${F}" font-size="7">Monitoring: PMBus 1.3 \u2014 Voltage, Current, Temperature, Status per module</text>`;
s+=`<text x="50" y="${spY+42}" fill="var(--t2)" font-family="${F}" font-size="7">Protection: OVP, OCP, OTP, Short-circuit | Inrush: Soft-start, active PFC</text>`;
break;
case 'manifold':
s+=`<rect x="0" y="0" width="${W}" height="28" fill="rgba(6,182,212,.08)"/>`;
s+=`<text x="10" y="18" fill="var(--c)" font-family="${F}" font-size="11" font-weight="600">DLC Manifold \u2014 Coolant Distribution Assembly</text>`;
// Supply header
var shY=50,shH=60;
s+=`<rect x="40" y="${shY}" width="${W-80}" height="${shH}" rx="4" fill="rgba(6,182,212,.06)" stroke="var(--c)" stroke-width="1.2"/>`;
s+=`<text x="60" y="${shY+16}" fill="var(--c)" font-family="${F}" font-size="9" font-weight="600">SUPPLY HEADER (TCS IN 35\u00B0C)</text>`;
s+=`<text x="60" y="${shY+32}" fill="var(--t2)" font-family="${F}" font-size="7">SS316L DN50 manifold | 25 bar rated | Welded construction</text>`;
s+=`<text x="60" y="${shY+46}" fill="var(--t2)" font-family="${F}" font-size="7">Isolation ball valve (manual lockout) + Motorised shut-off valve</text>`;
// Supply flow arrows
s+=`<line x1="50" y1="${shY+shH/2}" x2="${W-50}" y2="${shY+shH/2}" stroke="var(--c)" stroke-width="3" opacity=".3" stroke-dasharray="12 6"><animate attributeName="stroke-dashoffset" values="0;-36" dur="1s" repeatCount="indefinite"/></line>`;
// QD couplings (9 taps)
var qdY=shY+shH+15;
s+=`<text x="40" y="${qdY}" fill="var(--t3)" font-family="${F}" font-size="7" font-weight="600">QUICK-DISCONNECT COUPLINGS (Blind-Mate, SS316L, Dripless)</text>`;
for(var i=0;i<9;i++){var qx=50+i*78;
s+=`<rect x="${qx}" y="${qdY+8}" width="68" height="55" rx="3" fill="rgba(34,197,94,.04)" stroke="var(--g)" stroke-width=".5"/>`;
s+=`<text x="${qx+34}" y="${qdY+22}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle">CT-${i+1}</text>`;
s+=`<circle cx="${qx+20}" cy="${qdY+36}" r="6" fill="none" stroke="var(--c)" stroke-width="1"/>`;
s+=`<text x="${qx+20}" y="${qdY+39}" fill="var(--c)" font-family="${F}" font-size="5" text-anchor="middle">S</text>`;
s+=`<circle cx="${qx+48}" cy="${qdY+36}" r="6" fill="none" stroke="var(--r)" stroke-width="1"/>`;
s+=`<text x="${qx+48}" y="${qdY+39}" fill="var(--r)" font-family="${F}" font-size="5" text-anchor="middle">R</text>`;
s+=`<text x="${qx+34}" y="${qdY+55}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">QD pair</text>`;
}
// Return header
var rhY=qdY+80;
s+=`<rect x="40" y="${rhY}" width="${W-80}" height="${shH}" rx="4" fill="rgba(239,68,68,.06)" stroke="var(--r)" stroke-width="1.2"/>`;
s+=`<text x="60" y="${rhY+16}" fill="var(--r)" font-family="${F}" font-size="9" font-weight="600">RETURN HEADER (TCS OUT 45\u00B0C)</text>`;
s+=`<text x="60" y="${rhY+32}" fill="var(--t2)" font-family="${F}" font-size="7">SS316L DN50 manifold | 25 bar rated | Welded construction</text>`;
s+=`<text x="60" y="${rhY+46}" fill="var(--t2)" font-family="${F}" font-size="7">Isolation ball valve (manual lockout) + Motorised shut-off valve</text>`;
s+=`<line x1="${W-50}" y1="${rhY+shH/2}" x2="50" y2="${rhY+shH/2}" stroke="var(--r)" stroke-width="3" opacity=".3" stroke-dasharray="12 6"><animate attributeName="stroke-dashoffset" values="0;36" dur="1s" repeatCount="indefinite"/></line>`;
// Bottom specs
var spY=rhY+shH+18;
s+=`<rect x="30" y="${spY}" width="${W-60}" height="60" rx="3" fill="rgba(107,114,128,.04)" stroke="var(--bd2)" stroke-width=".6"/>`;
s+=`<text x="50" y="${spY+14}" fill="var(--t2)" font-family="${F}" font-size="7">Material: SS316L headers, DN50 flex hoses, brass QD couplings with dripless valves</text>`;
s+=`<text x="50" y="${spY+28}" fill="var(--t2)" font-family="${F}" font-size="7">Instrumentation: Temp sensor (PT100) + Pressure transducer per header | Flow via CDU</text>`;
s+=`<text x="50" y="${spY+42}" fill="var(--t2)" font-family="${F}" font-size="7">Leak protection: SS drip tray full length + rope sensor + 2\u00D7 point sensors at QD</text>`;
s+=`<text x="50" y="${spY+56}" fill="var(--t2)" font-family="${F}" font-size="7">Coolant: PG/Water mix (30% glycol) | Design: ASME B31.3 process piping</text>`;
break;
case 'busbar':
s+=`<rect x="0" y="0" width="${W}" height="28" fill="rgba(245,158,11,.08)"/>`;
s+=`<text x="10" y="18" fill="var(--o)" font-family="${F}" font-size="11" font-weight="600">48VDC Vertical Bus Bar \u2014 4,000A Copper Distribution</text>`;
// Vertical bus bar (center)
var bbX=W/2-25,bbW=50;
s+=`<rect x="${bbX}" y="42" width="${bbW}" height="360" rx="3" fill="rgba(245,158,11,.06)" stroke="var(--o)" stroke-width="1.5"/>`;
s+=`<text x="${W/2}" y="56" fill="var(--o)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">Cu BUS</text>`;
s+=`<text x="${W/2}" y="68" fill="var(--o)" font-family="${F}" font-size="7" text-anchor="middle">4,000A</text>`;
// PSU input (top)
s+=`<rect x="100" y="42" width="160" height="30" rx="3" fill="rgba(245,158,11,.04)" stroke="var(--o)" stroke-width=".8"/>`;
s+=`<text x="180" y="62" fill="var(--o)" font-family="${F}" font-size="8" text-anchor="middle" font-weight="600">PSU Shelf A/B Input</text>`;
s+=`<line x1="260" y1="57" x2="${bbX}" y2="57" stroke="var(--o)" stroke-width="2.5"/>`;
// Tap-offs for 9 compute trays
for(var i=0;i<9;i++){var ty=88+i*35;
// Left side: fuse + sense
s+=`<rect x="100" y="${ty}" width="180" height="28" rx="3" fill="rgba(34,197,94,.04)" stroke="var(--g)" stroke-width=".5"/>`;
s+=`<text x="115" y="${ty+12}" fill="var(--g)" font-family="${F}" font-size="7">CT-${i+1}</text>`;
s+=`<rect x="150" y="${ty+3}" width="40" height="10" rx="1" fill="rgba(239,68,68,.08)" stroke="var(--r)" stroke-width=".4"/>`;
s+=`<text x="170" y="${ty+11}" fill="var(--r)" font-family="${F}" font-size="5" text-anchor="middle">Semi-Fuse</text>`;
s+=`<text x="200" y="${ty+11}" fill="var(--t3)" font-family="${F}" font-size="5">100A</text>`;
s+=`<text x="115" y="${ty+24}" fill="var(--t3)" font-family="${F}" font-size="5">Sense wire + OCP trip</text>`;
// Right side: output values
s+=`<rect x="${bbX+bbW+20}" y="${ty}" width="160" height="28" rx="3" fill="rgba(6,182,212,.03)" stroke="var(--bd)" stroke-width=".4"/>`;
s+=`<text x="${bbX+bbW+30}" y="${ty+12}" fill="var(--t2)" font-family="${F}" font-size="6">${R(47.5,48.5)}V | ${RI(85,100)}A</text>`;
s+=`<text x="${bbX+bbW+30}" y="${ty+24}" fill="var(--t3)" font-family="${F}" font-size="5">${R(4.0,4.8)} kW delivered</text>`;
// Connection lines
s+=`<line x1="280" y1="${ty+14}" x2="${bbX}" y2="${ty+14}" stroke="var(--o)" stroke-width="1.5" opacity=".4"/>`;
s+=`<line x1="${bbX+bbW}" y1="${ty+14}" x2="${bbX+bbW+20}" y2="${ty+14}" stroke="var(--o)" stroke-width="1.5" opacity=".4"/>`;
}
// Bottom specs
var spY=415;
s+=`<rect x="30" y="${spY}" width="${W-60}" height="48" rx="3" fill="rgba(107,114,128,.04)" stroke="var(--bd2)" stroke-width=".6"/>`;
s+=`<text x="50" y="${spY+14}" fill="var(--t2)" font-family="${F}" font-size="7">Material: Oxygen-free copper (C101), tin-plated joints | Rated: 4,000A continuous</text>`;
s+=`<text x="50" y="${spY+28}" fill="var(--t2)" font-family="${F}" font-size="7">Protection: Semiconductor fuse per tap (100A, I\u00B2t < 500 A\u00B2s) + voltage sense wires</text>`;
s+=`<text x="50" y="${spY+42}" fill="var(--t2)" font-family="${F}" font-size="7">Monitoring: Per-tap V/I via PMBus | Thermal: IR window per joint, 70\u00B0C alarm</text>`;
break;
case 'backplane':
s+=`<rect x="0" y="0" width="${W}" height="28" fill="rgba(139,92,246,.08)"/>`;
s+=`<text x="10" y="18" fill="var(--p)" font-family="${F}" font-size="11" font-weight="600">NVLink Backplane \u2014 Passive Copper Cable Cartridge</text>`;
// Grid of connections
s+=`<text x="40" y="52" fill="var(--t3)" font-family="${F}" font-size="8" font-weight="600">CONNECTION MATRIX \u2014 CT \u2194 NS (Blind-Mate Cartridges)</text>`;
// Column headers (NS trays)
for(var n=0;n<9;n++){var nx=130+n*68;
s+=`<rect x="${nx}" y="60" width="60" height="20" rx="2" fill="rgba(236,72,153,.06)" stroke="var(--pk)" stroke-width=".5"/>`;
s+=`<text x="${nx+30}" y="74" fill="var(--pk)" font-family="${F}" font-size="7" text-anchor="middle">NS-${n+1}</text>`;
}
// Row headers (CT trays) + connection dots
for(var c=0;c<9;c++){var ry=88+c*32;
s+=`<rect x="40" y="${ry}" width="70" height="24" rx="2" fill="rgba(34,197,94,.06)" stroke="var(--g)" stroke-width=".5"/>`;
s+=`<text x="75" y="${ry+16}" fill="var(--g)" font-family="${F}" font-size="7" text-anchor="middle">CT-${c+1}</text>`;
for(var n=0;n<9;n++){var nx=130+n*68;
var connected=true;
s+=`<rect x="${nx}" y="${ry}" width="60" height="24" rx="1" fill="rgba(139,92,246,.03)" stroke="var(--bd)" stroke-width=".3"/>`;
s+=`<circle cx="${nx+30}" cy="${ry+12}" r="5" fill="${connected?'rgba(34,197,94,.3)':'rgba(107,114,128,.1)'}" stroke="${connected?'var(--g)':'var(--t3)'}" stroke-width=".5"/>`;
s+=`<text x="${nx+30}" y="${ry+15}" fill="${connected?'var(--g)':'var(--t3)'}" font-family="${F}" font-size="5" text-anchor="middle">${connected?'18L':'--'}</text>`;
}}
// Bottom specs
var spY=385;
s+=`<rect x="30" y="${spY}" width="${W-60}" height="75" rx="3" fill="rgba(107,114,128,.04)" stroke="var(--bd2)" stroke-width=".6"/>`;
s+=`<text x="50" y="${spY+14}" fill="var(--t2)" font-family="${F}" font-size="7">Type: Passive copper cable cartridge, blind-mate connectors, tool-less insertion</text>`;
s+=`<text x="50" y="${spY+28}" fill="var(--t2)" font-family="${F}" font-size="7">Lanes: 5,000+ coaxial lanes total | Speed: NRZ 200 Gb/s per lane (NVLink5)</text>`;
s+=`<text x="50" y="${spY+42}" fill="var(--t2)" font-family="${F}" font-size="7">Per GPU: 18 NVLink5 lanes \u2192 900 GB/s bidirectional to NVSwitch fabric</text>`;
s+=`<text x="50" y="${spY+56}" fill="var(--t2)" font-family="${F}" font-size="7">Insertion: Spring-loaded blind-mate, 500+ mating cycles rated, gold-plated contacts</text>`;
s+=`<text x="50" y="${spY+70}" fill="var(--t2)" font-family="${F}" font-size="7">Domain: 72 GPUs all-to-all via 9\u00D7 NVSwitch5 = 130 TB/s aggregate bisection BW</text>`;
break;
case 'leak':
s+=`<rect x="0" y="0" width="${W}" height="28" fill="rgba(239,68,68,.08)"/>`;
s+=`<text x="10" y="18" fill="var(--r)" font-family="${F}" font-size="11" font-weight="600">Leak Detection System \u2014 Continuous Monitoring</text>`;
// Rope sensor layout
s+=`<text x="40" y="52" fill="var(--t3)" font-family="${F}" font-size="8" font-weight="600">SENSOR LAYOUT \u2014 Under Manifold (Full Rack Length)</text>`;
// Rope sensor (horizontal zig-zag)
var ropeY=80;
s+=`<rect x="40" y="${ropeY}" width="${W-80}" height="100" rx="4" fill="rgba(239,68,68,.03)" stroke="var(--r)" stroke-width=".8"/>`;
s+=`<text x="60" y="${ropeY+16}" fill="var(--r)" font-family="${F}" font-size="8" font-weight="600">Rope Sensor (TTK/RLE FG-NET)</text>`;
// Zig-zag rope pattern
var pts='';
for(var i=0;i<14;i++){var rx=60+i*50,ry2=ropeY+35+(i%2?30:0);pts+=(i?'L':'M')+rx+','+ry2+' ';}
s+=`<polyline points="${pts}" fill="none" stroke="var(--r)" stroke-width="2" opacity=".5" stroke-dasharray="8 4"><animate attributeName="stroke-dashoffset" values="0;24" dur="2s" repeatCount="indefinite"/></polyline>`;
s+=`<text x="60" y="${ropeY+85}" fill="var(--t3)" font-family="${F}" font-size="6">Continuous conductive polymer rope | Locates leak within \u00B11m | Response < 3s</text>`;
// Point sensors at QD
var psY=ropeY+120;
s+=`<text x="40" y="${psY}" fill="var(--t3)" font-family="${F}" font-size="8" font-weight="600">POINT SENSORS \u2014 At Quick-Disconnect Couplings (18 total)</text>`;
for(var i=0;i<9;i++){var px=50+i*78;
s+=`<rect x="${px}" y="${psY+10}" width="68" height="40" rx="3" fill="rgba(239,68,68,.03)" stroke="var(--r)" stroke-width=".4"/>`;
s+=`<text x="${px+34}" y="${psY+24}" fill="var(--r)" font-family="${F}" font-size="7" text-anchor="middle">QD-${i+1}</text>`;
s+=`<circle cx="${px+20}" cy="${psY+36}" r="4" fill="var(--g)" opacity=".6"/>`;
s+=`<circle cx="${px+48}" cy="${psY+36}" r="4" fill="var(--g)" opacity=".6"/>`;
s+=`<text x="${px+34}" y="${psY+46}" fill="var(--t3)" font-family="${F}" font-size="5" text-anchor="middle">2\u00D7 sensors</text>`;
}
// Drip tray
var dtY=psY+65;
s+=`<rect x="40" y="${dtY}" width="${W-80}" height="45" rx="4" fill="rgba(107,114,128,.04)" stroke="var(--t3)" stroke-width=".8"/>`;
s+=`<text x="60" y="${dtY+16}" fill="var(--t3)" font-family="${F}" font-size="8" font-weight="600">SS316L Drip Tray</text>`;
s+=`<text x="60" y="${dtY+30}" fill="var(--t3)" font-family="${F}" font-size="6">Full manifold length | 3mm thick | Welded seams | Drain port \u2192 containment</text>`;
s+=`<text x="60" y="${dtY+42}" fill="var(--t3)" font-family="${F}" font-size="6">Capacity: 5L holding | Slope: 2\u00B0 to drain</text>`;
// BMS connection
var bmsY=dtY+60;
s+=`<rect x="40" y="${bmsY}" width="${W-80}" height="60" rx="3" fill="rgba(59,130,246,.04)" stroke="var(--b)" stroke-width=".6"/>`;
s+=`<text x="60" y="${bmsY+16}" fill="var(--b)" font-family="${F}" font-size="8" font-weight="600">BMS Integration</text>`;
s+=`<text x="60" y="${bmsY+30}" fill="var(--t2)" font-family="${F}" font-size="7">Controller: Modbus RTU \u2192 BMS gateway | 24 zones monitored</text>`;
s+=`<text x="60" y="${bmsY+44}" fill="var(--t2)" font-family="${F}" font-size="7">Actions: Alert \u2192 Alarm \u2192 Auto-isolate (close motorised manifold valve)</text>`;
s+=`<text x="60" y="${bmsY+56}" fill="var(--t2)" font-family="${F}" font-size="7">Escalation: > 50mL \u2192 page on-call | > 500mL \u2192 CDU shutdown + EPO warning</text>`;
break;
}
el.innerHTML=s;
}
})();

// ===== TOOLTIP for all SVG objects on Data Hall =====
(function(){
var tip=document.createElement('div');
tip.className='rack-tip';tip.id='floorTip';
tip.style.cssText='position:fixed;z-index:100;background:rgba(10,14,23,.95);border:1px solid rgba(6,182,212,.3);border-radius:6px;padding:8px 10px;font-family:JetBrains\u0020Mono;font-size:9px;color:#e2e5ea;pointer-events:none;display:none;backdrop-filter:blur(8px);max-width:260px;box-shadow:0 4px 20px rgba(0,0,0,.5)';
document.body.appendChild(tip);
// Light mode
var style=document.createElement('style');
style.textContent='[data-theme="light"] #floorTip{background:rgba(255,255,255,.95);border-color:rgba(6,182,212,.4);color:#1e293b;box-shadow:0 4px 20px rgba(0,0,0,.15)}';
document.head.appendChild(style);
var hSvg=$('hSvg');
if(!hSvg)return;
hSvg.addEventListener('mousemove',function(e){
var t=e.target;
// Rack hover
var rack=t.closest('.rg');
if(rack){
var rects=rack.querySelectorAll('rect');
var idText=rack.querySelector('text');
var id=idText?idText.textContent:'';
var gpuU=RI(85,98),gpuT=RI(68,82),pwr=RI(58,70);
var dIn=R(34.5,35.5),dOut=R(43.5,45.2),dF=RI(72,88);
tip.innerHTML='<div style="color:var(--g);font-weight:600;margin-bottom:4px">NVL36 Rack '+id+'</div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">GPUs</span><span>36 B200</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">GPU Util</span><span style="color:var(--g)">'+gpuU+'%</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">GPU Temp</span><span style="color:'+(gpuT>78?'var(--o)':'var(--g)')+'">'+gpuT+'\u00B0C</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Power</span><span style="color:var(--o)">'+pwr+' kW</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">DLC In/Out</span><span style="color:var(--c)">'+dIn+'/'+dOut+'\u00B0C</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">DLC Flow</span><span>'+dF+' LPM</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">NVLink</span><span style="color:var(--g)">All Up</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Status</span><span style="color:var(--g)">NORMAL</span></div>';
showTip(e);return;
}
// CDU hover
var cduG=t.closest('.cdu-click');
if(cduG){
var cid=cduG.dataset.cdu;
tip.innerHTML='<div style="color:var(--c);font-weight:600;margin-bottom:4px">CDU-'+String(cid).padStart(2,'0')+'</div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Mode</span><span style="color:var(--g)">Online</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Supply</span><span style="color:var(--c)">'+R(34.5,35.8)+'\u00B0C</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Return</span><span style="color:var(--r)">'+R(44.0,45.5)+'\u00B0C</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">FWS In</span><span style="color:var(--b)">'+R(11.5,12.5)+'\u00B0C</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">FWS Out</span><span>'+R(21.0,22.5)+'\u00B0C</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">TCS-Int \u0394P</span><span>'+R(1.5,2.5)+' bar</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Flow</span><span>'+RI(350,450)+' L/min</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Pump</span><span>P1 '+RI(75,90)+'% | P2 Stby</span></div>'+
'<div style="color:var(--t3);margin-top:3px;font-size:8px">\u25B6 Click for HMI mimic</div>';
showTip(e);return;
}
// CRAH hover
var crahG=t.closest('.crah-unit');
if(crahG){
var crahId=crahG.dataset.crah||'CRAH';
var crahCap=RI(165,185);
tip.innerHTML='<div style="color:var(--c);font-weight:600;margin-bottom:4px">'+crahId+'</div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Type</span><span>CW CRAH EC Fan Wall</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Supply Air</span><span style="color:var(--c)">18\u00B0C</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Return Air</span><span style="color:var(--r)">'+R(32,38)+'\u00B0C</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Capacity</span><span>~'+crahCap+' kW</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Status</span><span style="color:var(--g)">Active</span></div>'+
'<div style="color:var(--t3);margin-top:3px;font-size:8px">Cools residual 15% air-side heat<br>(VRM, DIMM, SSD, NIC)</div>';
showTip(e);return;
}
// Network boxes
var nb=t.closest('g[filter]');
if(nb&&nb.querySelector('rect')&&nb.querySelector('text')){
var ntxt=nb.querySelectorAll('text');
if(ntxt.length>=1){
var label=ntxt[0].textContent;
if(['IB-Leaf','IB-Spine','ODF','DWDM','OOB','Storage'].indexOf(label)>=0){
tip.innerHTML='<div style="color:var(--b);font-weight:600;margin-bottom:4px">'+label+'</div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Status</span><span style="color:var(--g)">Online</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Ports</span><span>'+RI(24,48)+'/'+RI(48,64)+'</span></div>'+
'<div style="display:flex;justify-content:space-between;padding:1px 0"><span style="color:var(--t3)">Throughput</span><span>'+RI(60,95)+'%</span></div>';
showTip(e);return;
}
}
}
tip.style.display='none';
});
hSvg.addEventListener('mouseleave',function(){tip.style.display='none'});
function showTip(e){
tip.style.display='block';
var left=e.clientX+12,top=e.clientY+12;
if(left+260>window.innerWidth)left=e.clientX-268;
if(top+200>window.innerHeight)top=window.innerHeight-210;
tip.style.left=left+'px';tip.style.top=Math.max(4,top)+'px';
}
// === UNIVERSAL TOOLTIP for ALL other SVGs (data-tip attribute) ===
['overSvg','rackSvg','coolSvg','elecSvg','netSvg','fireSvg','bmsSvg'].forEach(function(id){
var svg=$(id);if(!svg)return;
svg.addEventListener('mousemove',function(e){
var el=e.target.closest('[data-tip]');
if(el){tip.innerHTML=el.getAttribute('data-tip');showTip(e)}
else{tip.style.display='none'}
});
svg.addEventListener('mouseleave',function(){tip.style.display='none'});
});
})();

// ===== SVG ZOOM CONTROLS (+/- buttons, scroll-wheel, drag-pan) =====
(function(){
var IDS=['overSvg','hSvg','rackSvg','coolSvg','elecSvg','netSvg','fireSvg','bmsSvg'];
var STEPS=[0.5,0.75,1,1.25,1.5,2,2.5,3,4];
IDS.forEach(function(id){
var svg=$(id);if(!svg)return;
var par=svg.parentElement;// .bx
if(!par)return;
// Wrap: create .svg-zw > .svg-zi > svg
var wrap=document.createElement('div');wrap.className='svg-zw';
var inner=document.createElement('div');inner.className='svg-zi';
par.insertBefore(wrap,svg);
wrap.appendChild(inner);
inner.appendChild(svg);
// Zoom bar
var bar=document.createElement('div');bar.className='svg-zb';
var btnM=document.createElement('button');btnM.textContent='\u2212';btnM.title='Zoom out';
var btnP=document.createElement('button');btnP.textContent='+';btnP.title='Zoom in';
var btnR=document.createElement('button');btnR.textContent='\u21BA';btnR.title='Reset zoom';
var lvl=document.createElement('button');lvl.className='zlv';lvl.textContent='100%';
bar.appendChild(btnM);bar.appendChild(lvl);bar.appendChild(btnP);bar.appendChild(btnR);
wrap.appendChild(bar);
var si=2;// index into STEPS, starts at 1 (100%)
function applyZoom(){
var z=STEPS[si];
svg.style.width=(z*100)+'%';
lvl.textContent=Math.round(z*100)+'%';
}
btnP.addEventListener('click',function(e){e.stopPropagation();if(si<STEPS.length-1){si++;applyZoom()}});
btnM.addEventListener('click',function(e){e.stopPropagation();if(si>0){si--;applyZoom()}});
btnR.addEventListener('click',function(e){e.stopPropagation();si=2;applyZoom()});
// Scroll-wheel zoom on SVG area
inner.addEventListener('wheel',function(e){
if(!e.ctrlKey)return;
e.preventDefault();
if(e.deltaY<0&&si<STEPS.length-1){si++;applyZoom()}
else if(e.deltaY>0&&si>0){si--;applyZoom()}
},{passive:false});
// Drag-pan
var dragging=false,sx,sy,sl,st;
inner.addEventListener('mousedown',function(e){
if(e.button!==0)return;
dragging=true;sx=e.clientX;sy=e.clientY;sl=inner.scrollLeft;st=inner.scrollTop;
});
window.addEventListener('mousemove',function(e){
if(!dragging)return;
inner.scrollLeft=sl-(e.clientX-sx);
inner.scrollTop=st-(e.clientY-sy);
});
window.addEventListener('mouseup',function(){dragging=false});
});
})();

</script><script src="auth.js?v=20260225"></script>
<script src="rz-tracker.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-banner hidden" id="cookieBanner">
    <p>We use cookies for analytics to improve your experience. <a href="privacy.html">Learn more</a></p>
    <div class="cookie-actions">
        <button class="cookie-accept" id="cookieAccept">Accept</button>
        <button class="cookie-decline" id="cookieDecline">Decline</button>
    </div>
</div>

<!-- Scroll to Top -->
<button class="scroll-top-btn" id="scrollTopBtn" aria-label="Scroll to top">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
</button>

<script>
(function(){
    // Cookie Banner
    var cb = document.getElementById('cookieBanner');
    var consent = localStorage.getItem('rz_cookie_consent');
    if (!consent && cb) {
        cb.classList.remove('hidden');
    }
    var acceptBtn = document.getElementById('cookieAccept');
    var declineBtn = document.getElementById('cookieDecline');
    if (acceptBtn) acceptBtn.addEventListener('click', function(){
        localStorage.setItem('rz_cookie_consent', 'accepted');
        cb.classList.add('hidden');
    });
    if (declineBtn) declineBtn.addEventListener('click', function(){
        localStorage.setItem('rz_cookie_consent', 'declined');
        cb.classList.add('hidden');
        // Disable GA
        window['ga-disable-G-GED7FX8RTV'] = true;
    });

    // Scroll to Top
    var sBtn = document.getElementById('scrollTopBtn');
    if (sBtn) {
        var ticking = false;
        window.addEventListener('scroll', function(){
            if (!ticking) {
                window.requestAnimationFrame(function(){
                    if (window.scrollY > 500) {
                        sBtn.classList.add('visible');
                    } else {
                        sBtn.classList.remove('visible');
                    }
                    ticking = false;
                });
                ticking = true;
            }
        });
        sBtn.addEventListener('click', function(){
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
})();
</script>

</body></html>
