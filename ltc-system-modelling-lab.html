<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Root Engineering Lab | Liquid-to-Chip System Modelling Laboratory | ResistanceZero</title>
    <meta name="description" content="Root-only liquid-to-chip system modelling laboratory with comprehensive input-processing-output flow, calibration mode, and advanced control logic visualization.">
    <meta name="author" content="Bagus Dwi Permana">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#0f172a">

    <link rel="icon" type="image/png" href="assets/Favicon.png">
    <link rel="apple-touch-icon" href="assets/Favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3a7ca5 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: rgba(255, 255, 255, 0.88);
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --text-muted: #64748b;
            --border: rgba(30, 58, 95, 0.16);
            --shadow: 0 10px 28px rgba(15, 23, 42, 0.12);
            --accent-gold: #f59e0b;
            --accent-cyan: #06b6d4;
            --accent-emerald: #10b981;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
        }

        [data-theme="dark"] {
            --bg-primary: #0a0f1d;
            --bg-secondary: #0f172a;
            --bg-card: rgba(15, 23, 42, 0.82);
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: rgba(148, 163, 184, 0.2);
            --shadow: 0 12px 30px rgba(2, 6, 23, 0.45);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .page-background {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background:
                radial-gradient(ellipse at top right, rgba(74, 144, 184, 0.14), transparent 48%),
                radial-gradient(ellipse at bottom left, rgba(245, 158, 11, 0.1), transparent 55%);
        }

        .navbar {
            position: sticky;
            top: 0;
            z-index: 40;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] .navbar {
            background: rgba(10, 15, 29, 0.84);
        }

        .nav-container {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0.95rem clamp(0.85rem, 1.1vw, 1.5rem);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .nav-brand {
            display: inline-flex;
            align-items: center;
            gap: 0.7rem;
            text-decoration: none;
            color: inherit;
        }

        .brand-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            background: var(--primary-gradient);
            box-shadow: 0 8px 18px rgba(30, 58, 95, 0.35);
        }

        .brand-title {
            font-size: 0.96rem;
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .brand-subtitle {
            display: block;
            font-size: 0.73rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-top: 0.1rem;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 0.65rem;
        }

        .nav-back {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.52rem 0.9rem;
            border-radius: 9px;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 600;
            color: #fff;
            background: var(--primary-gradient);
            box-shadow: 0 6px 16px rgba(30, 58, 95, 0.28);
        }

        .theme-toggle {
            width: 38px;
            height: 38px;
            border: 1px solid var(--border);
            border-radius: 9px;
            cursor: pointer;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.55);
            transition: transform 0.18s ease;
        }

        .theme-toggle:hover {
            transform: translateY(-1px);
        }

        [data-theme="dark"] .theme-toggle {
            background: rgba(15, 23, 42, 0.7);
            color: #f8fafc;
        }

        .main-content {
            position: relative;
            z-index: 2;
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 1.4rem clamp(0.85rem, 1.1vw, 1.5rem) 2.4rem;
        }

        .hero {
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.06), rgba(6, 182, 212, 0.06));
            box-shadow: var(--shadow);
        }

        [data-theme="dark"] .hero {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.35), rgba(15, 23, 42, 0.75));
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.38rem 0.85rem;
            border-radius: 999px;
            font-size: 0.73rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #fff;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            margin-bottom: 1rem;
        }

        .hero h1 {
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            line-height: 1.2;
            margin-bottom: 0.85rem;
            color: var(--text-primary);
        }

        .hero p {
            max-width: 860px;
            color: var(--text-secondary);
            line-height: 1.75;
            font-size: 1rem;
        }

        .hero-kpis {
            margin-top: 1.45rem;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.75rem;
        }

        .hero-kpi {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.8rem 0.9rem;
            background: var(--bg-card);
        }

        .hero-kpi .kpi-label {
            font-size: 0.67rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            font-weight: 700;
        }

        .hero-kpi .kpi-value {
            font-size: 1.2rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
        }

        .legal-disclaimer-wrap {
            margin-top: 1rem;
        }

        .legal-disclaimer {
            border-radius: 14px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-left: 4px solid var(--accent-gold);
            background: var(--bg-card);
            padding: 1rem 1.15rem;
            box-shadow: var(--shadow);
        }

        .legal-disclaimer-title {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            margin: 0 0 0.45rem;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-primary);
        }

        .legal-disclaimer p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.8rem;
            line-height: 1.6;
        }

        .legal-disclaimer p + p {
            margin-top: 0.35rem;
        }

        .legal-disclaimer a {
            color: #2563eb;
            text-decoration: underline;
            font-weight: 600;
        }

        .section {
            margin-top: 1.35rem;
        }

        .section-header {
            margin-bottom: 0.85rem;
        }

        .section-header h2 {
            font-size: 1.35rem;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .section-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .standards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 0.75rem;
        }

        .standard-card {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 0.95rem;
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }

        .standard-card-link {
            display: block;
            text-decoration: none;
            color: inherit;
            transition: transform 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease;
            border-color: rgba(245, 158, 11, 0.35);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(30, 58, 95, 0.08));
        }

        .standard-card-link:hover {
            transform: translateY(-3px);
            border-color: rgba(245, 158, 11, 0.55);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.16);
        }

        [data-theme="dark"] .standard-card-link {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(30, 58, 95, 0.25));
        }

        .standard-card-link .open-link {
            margin-top: 0.55rem;
            font-size: 0.74rem;
            font-weight: 700;
            color: #b45309;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        [data-theme="dark"] .standard-card-link .open-link {
            color: #fbbf24;
        }

        .standard-card h3 {
            font-size: 0.95rem;
            margin-bottom: 0.55rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .standard-card h3 i {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.76rem;
        }

        .standard-card ul {
            list-style: none;
            display: grid;
            gap: 0.38rem;
        }

        .standard-card li {
            font-size: 0.76rem;
            color: var(--text-secondary);
            line-height: 1.45;
            padding-left: 0.95rem;
            position: relative;
        }

        .standard-card li::before {
            content: '';
            width: 5px;
            height: 5px;
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 0.45rem;
            background: #60a5fa;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.75rem;
        }

        .detail-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.85rem 0.9rem;
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }

        .detail-card .route-id {
            display: inline-block;
            margin-bottom: 0.45rem;
            font-size: 0.66rem;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.02em;
            color: var(--text-muted);
            background: rgba(148, 163, 184, 0.14);
            border: 1px solid rgba(148, 163, 184, 0.22);
            border-radius: 999px;
            padding: 0.16rem 0.46rem;
        }

        .detail-card h4 {
            font-size: 0.88rem;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .detail-card p {
            margin: 0;
            font-size: 0.78rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .architecture-layout {
            display: grid;
            grid-template-columns: 1.35fr 1fr;
            gap: 0.75rem;
        }

        .panel {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1rem;
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }

        .panel h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .panel p {
            font-size: 0.84rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 0.6rem;
        }

        .pipeline {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 0.5rem;
            margin-top: 0.4rem;
        }

        .step {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.65rem 0.55rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.42);
        }

        [data-theme="dark"] .step {
            background: rgba(30, 41, 59, 0.6);
        }

        .step .num {
            display: inline-flex;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            align-items: center;
            justify-content: center;
            background: #1e3a5f;
            color: #fff;
            font-size: 0.72rem;
            font-weight: 700;
            margin-bottom: 0.35rem;
        }

        .step h4 {
            font-size: 0.73rem;
            margin-bottom: 0.15rem;
        }

        .step p {
            font-size: 0.69rem;
            line-height: 1.35;
            margin: 0;
            color: var(--text-muted);
        }

        .calculator-layout {
            display: grid;
            grid-template-columns: minmax(320px, var(--calc-left-width, 42%)) minmax(520px, 1fr);
            gap: 0.75rem;
            align-items: start;
        }

        .workspace-toolbar {
            margin-bottom: 0.58rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.46rem 0.58rem;
            background: rgba(255, 255, 255, 0.62);
        }

        [data-theme="dark"] .workspace-toolbar {
            background: rgba(15, 23, 42, 0.68);
        }

        .workspace-toolbar .toolbar-title {
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding-right: 0.3rem;
            margin-right: 0.1rem;
            border-right: 1px dashed rgba(148, 163, 184, 0.42);
        }

        .workspace-toolbar .toolbar-label {
            font-size: 0.66rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 700;
        }

        .split-range {
            width: min(260px, 52vw);
            accent-color: #2563eb;
        }

        .toolbar-pill {
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.16rem 0.48rem;
            font-size: 0.68rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.62);
        }

        [data-theme="dark"] .toolbar-pill {
            background: rgba(15, 23, 42, 0.72);
        }

        .btn-chip {
            padding: 0.34rem 0.58rem;
            font-size: 0.71rem;
            border-radius: 8px;
        }

        .calc-card {
            border: 1px solid var(--border);
            border-radius: 14px;
            background: var(--bg-card);
            box-shadow: var(--shadow);
            padding: 1rem;
            min-height: 0;
        }

        .calc-panel-scroll {
            scrollbar-gutter: stable;
        }

        .calc-panel-scroll::-webkit-scrollbar {
            width: 9px;
            height: 9px;
        }

        .calc-panel-scroll::-webkit-scrollbar-thumb {
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.56);
        }

        .calc-panel-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .calc-input-panel {
            max-height: calc(100vh - 108px);
            overflow: auto;
            padding-right: 0.55rem;
        }

        .calc-output-panel {
            position: sticky;
            top: 76px;
            max-height: calc(100vh - 92px);
            overflow: auto;
            padding-right: 0.55rem;
        }

        .calc-card h3 {
            font-size: 1rem;
            margin-bottom: 0.7rem;
        }

        .output-quickbar {
            position: sticky;
            top: 0;
            z-index: 4;
            margin-bottom: 0.56rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.4rem 0.45rem;
            background: rgba(241, 245, 249, 0.92);
            backdrop-filter: blur(4px);
        }

        [data-theme="dark"] .output-quickbar {
            background: rgba(15, 23, 42, 0.9);
        }

        .quickbar-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.42rem;
            margin-bottom: 0.36rem;
            flex-wrap: wrap;
        }

        .quickbar-head h4 {
            margin: 0;
            font-size: 0.73rem;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .quick-kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.35rem;
        }

        .quick-kpi {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.32rem 0.38rem;
            background: rgba(255, 255, 255, 0.72);
        }

        [data-theme="dark"] .quick-kpi {
            background: rgba(30, 41, 59, 0.72);
        }

        .quick-kpi .k {
            font-size: 0.62rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 700;
        }

        .quick-kpi .v {
            display: block;
            margin-top: 0.15rem;
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.58rem;
        }

        .input-group {
            display: grid;
            gap: 0.25rem;
        }

        .input-group label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--text-muted);
            font-weight: 700;
        }

        .input-hint {
            font-size: 0.64rem;
            color: var(--text-muted);
            line-height: 1.35;
        }

        .calc-label {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .calc-label .tooltip-trigger {
            margin-left: 0;
        }

        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(37, 99, 235, 0.16);
            color: #2563eb;
            font-size: 0.65rem;
            font-weight: 700;
            cursor: help;
            position: relative;
            flex-shrink: 0;
            margin-left: 6px;
            vertical-align: middle;
        }

        [data-theme="dark"] .tooltip-trigger {
            background: rgba(96, 165, 250, 0.22);
            color: #93c5fd;
        }

        .tooltip-content {
            display: none;
            position: fixed;
            width: 320px;
            background: #1e293b;
            border: 1px solid rgba(37, 99, 235, 0.35);
            border-radius: 10px;
            padding: 14px;
            z-index: 10020;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            pointer-events: none;
        }

        .tooltip-title {
            font-size: 0.82rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 6px;
        }

        .tooltip-desc {
            font-size: 0.78rem;
            color: #cbd5e1;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .tooltip-formula {
            font-size: 0.72rem;
            color: #94a3b8;
            padding-top: 6px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-style: italic;
        }

        .tooltip-impact {
            font-size: 0.72rem;
            color: #cbd5e1;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed rgba(148, 163, 184, 0.35);
            line-height: 1.4;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 9px;
            padding: 0.56rem 0.62rem;
            font-size: 0.84rem;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.7);
            font-family: 'Inter', sans-serif;
        }

        [data-theme="dark"] .input-group input,
        [data-theme="dark"] .input-group select {
            background: rgba(30, 41, 59, 0.7);
        }

        .check-wrap {
            margin-top: 0.2rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .form-actions {
            margin-top: 0.8rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .autorun-row {
            margin-top: 0.48rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .autorun-row .check-wrap {
            margin-top: 0;
            font-weight: 600;
        }

        .mode-row {
            margin-top: 0.35rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .mode-row .check-wrap {
            margin-top: 0;
            font-weight: 600;
        }

        .mode-state {
            font-size: 0.72rem;
            font-weight: 700;
            color: #1d4ed8;
            border: 1px solid rgba(29, 78, 216, 0.32);
            border-radius: 999px;
            padding: 0.15rem 0.52rem;
            background: rgba(59, 130, 246, 0.1);
            white-space: nowrap;
        }

        .mode-state.off {
            color: #64748b;
            border-color: rgba(100, 116, 139, 0.32);
            background: rgba(148, 163, 184, 0.12);
        }

        .input-mode-note {
            margin-top: 0.2rem;
        }

        [data-theme="dark"] .mode-state {
            color: #93c5fd;
            border-color: rgba(147, 197, 253, 0.36);
            background: rgba(37, 99, 235, 0.2);
        }

        [data-theme="dark"] .mode-state.off {
            color: #94a3b8;
            border-color: rgba(148, 163, 184, 0.36);
            background: rgba(71, 85, 105, 0.24);
        }

        .input-group.hidden-by-mode {
            display: none !important;
        }

        .autorun-state {
            font-size: 0.72rem;
            font-weight: 700;
            color: #0f766e;
            border: 1px solid rgba(15, 118, 110, 0.28);
            border-radius: 999px;
            padding: 0.15rem 0.52rem;
            background: rgba(20, 184, 166, 0.12);
            white-space: nowrap;
        }

        .autorun-state.off {
            color: #64748b;
            border-color: rgba(100, 116, 139, 0.32);
            background: rgba(148, 163, 184, 0.12);
        }

        [data-theme="dark"] .autorun-state {
            color: #67e8f9;
            border-color: rgba(103, 232, 249, 0.32);
            background: rgba(34, 211, 238, 0.16);
        }

        [data-theme="dark"] .autorun-state.off {
            color: #94a3b8;
            border-color: rgba(148, 163, 184, 0.36);
            background: rgba(71, 85, 105, 0.24);
        }

        .btn-primary,
        .btn-secondary,
        .btn-accent {
            border: none;
            border-radius: 10px;
            padding: 0.62rem 0.9rem;
            font-size: 0.83rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .btn-primary {
            color: #fff;
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            flex: 1;
        }

        .btn-secondary {
            color: var(--text-primary);
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.6);
        }

        .btn-accent {
            color: #fff;
            background: linear-gradient(135deg, #0ea5e9, #0369a1);
        }

        [data-theme="dark"] .btn-secondary {
            background: rgba(30, 41, 59, 0.8);
            color: #e2e8f0;
        }

        .btn-primary:hover,
        .btn-secondary:hover,
        .btn-accent:hover {
            transform: translateY(-1px);
        }

        .calc-footnote {
            margin-top: 0.65rem;
            font-size: 0.73rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .input-quality-block {
            margin-top: 0.54rem;
            border: 1px solid var(--border);
            border-radius: 11px;
            padding: 0.48rem 0.5rem;
            background: rgba(255, 255, 255, 0.52);
        }

        [data-theme="dark"] .input-quality-block {
            background: rgba(15, 23, 42, 0.7);
        }

        .input-quality-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            flex-wrap: wrap;
            margin-bottom: 0.3rem;
        }

        .input-quality-head h4 {
            margin: 0;
            font-size: 0.74rem;
            color: var(--text-primary);
        }

        .quality-list {
            margin: 0;
            padding-left: 1rem;
            display: grid;
            gap: 0.2rem;
        }

        .quality-list li {
            font-size: 0.69rem;
            line-height: 1.38;
            color: var(--text-secondary);
        }

        .quality-list li.warn {
            color: #b45309;
        }

        .quality-list li.err {
            color: #b91c1c;
        }

        [data-theme="dark"] .quality-list li.warn {
            color: #fbbf24;
        }

        [data-theme="dark"] .quality-list li.err {
            color: #f87171;
        }

        .calibration-block {
            margin-top: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.66rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(16, 185, 129, 0.08));
        }

        [data-theme="dark"] .calibration-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.42), rgba(15, 23, 42, 0.76));
        }

        .calibration-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.45rem;
            margin-bottom: 0.24rem;
        }

        .calibration-head h4 {
            margin: 0;
            font-size: 0.82rem;
            color: var(--text-primary);
        }

        .calibration-status {
            font-size: 0.67rem;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.14rem 0.42rem;
            background: rgba(255, 255, 255, 0.65);
            color: var(--text-primary);
            white-space: nowrap;
        }

        [data-theme="dark"] .calibration-status {
            background: rgba(15, 23, 42, 0.72);
        }

        .calibration-status.ok {
            border-color: rgba(16, 185, 129, 0.6);
            color: #047857;
        }

        [data-theme="dark"] .calibration-status.ok {
            color: #34d399;
        }

        .calibration-status.stale {
            border-color: rgba(245, 158, 11, 0.65);
            color: #b45309;
        }

        [data-theme="dark"] .calibration-status.stale {
            color: #fbbf24;
        }

        .calibration-note {
            margin: 0 0 0.45rem;
            font-size: 0.72rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.55rem;
        }

        .calibration-actions {
            margin-top: 0.55rem;
        }

        .calibration-summary {
            margin-top: 0.45rem;
            font-size: 0.72rem;
            color: var(--text-secondary);
            line-height: 1.45;
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-line;
        }

        .telemetry-import {
            margin-top: 0.55rem;
            border: 1px dashed rgba(59, 130, 246, 0.36);
            border-radius: 10px;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.54);
        }

        [data-theme="dark"] .telemetry-import {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(125, 211, 252, 0.34);
        }

        .telemetry-import-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.42rem;
            flex-wrap: wrap;
        }

        .telemetry-import-head h5 {
            margin: 0;
            font-size: 0.73rem;
            color: var(--text-primary);
        }

        .telemetry-import-note {
            margin: 0.25rem 0 0;
            font-size: 0.69rem;
            color: var(--text-secondary);
            line-height: 1.42;
        }

        .telemetry-import-grid {
            margin-top: 0.38rem;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.42rem;
        }

        .telemetry-import-grid .field textarea.telemetry-paste {
            min-height: 86px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            line-height: 1.4;
        }

        .check-wrap.tight {
            margin-top: 0;
            font-size: 0.72rem;
            line-height: 1.34;
        }

        .telemetry-import-actions {
            margin-top: 0.44rem;
            display: flex;
            align-items: center;
            gap: 0.42rem;
            flex-wrap: wrap;
        }

        .telemetry-map-grid {
            margin-top: 0.42rem;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.42rem;
        }

        .telemetry-map-grid .field select {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.69rem;
        }

        .telemetry-import-meta {
            margin-top: 0.28rem;
            font-size: 0.66rem;
            color: var(--text-muted);
            line-height: 1.4;
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-line;
        }

        .telemetry-import-status {
            margin-top: 0.36rem;
            font-size: 0.69rem;
            color: var(--text-secondary);
            line-height: 1.43;
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-line;
        }

        .selftest-pass {
            color: #047857;
            font-weight: 700;
        }

        .selftest-fail {
            color: #b91c1c;
            font-weight: 700;
        }

        [data-theme="dark"] .selftest-pass {
            color: #34d399;
        }

        [data-theme="dark"] .selftest-fail {
            color: #f87171;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.7rem;
        }

        .result-card {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.58rem 0.65rem;
            background: rgba(255, 255, 255, 0.44);
        }

        [data-theme="dark"] .result-card {
            background: rgba(30, 41, 59, 0.58);
        }

        .result-card .label {
            display: block;
            font-size: 0.68rem;
            color: var(--text-muted);
            margin-bottom: 0.18rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 700;
        }

        .result-card .value {
            font-size: 0.95rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--text-primary);
            overflow-wrap: anywhere;
            word-break: break-word;
            line-height: 1.35;
        }

        .scoreboard {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.75rem 0.8rem;
            margin-bottom: 0.65rem;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(37, 99, 235, 0.1));
        }

        .score-row {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 0.6rem;
        }

        .score-title {
            font-size: 0.76rem;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
        }

        .score-value {
            font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
            color: var(--text-primary);
        }

        .score-grade {
            margin-top: 0.2rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .compliance-grid {
            display: grid;
            gap: 0.4rem;
            margin-bottom: 0.7rem;
        }

        .compliance-item {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem 0.58rem;
            background: rgba(255, 255, 255, 0.4);
        }

        [data-theme="dark"] .compliance-item {
            background: rgba(30, 41, 59, 0.58);
        }

        .compliance-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.55rem;
            margin-bottom: 0.3rem;
        }

        .compliance-name {
            font-size: 0.77rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .compliance-score {
            font-size: 0.74rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            font-weight: 700;
        }

        .progress {
            height: 7px;
            border-radius: 99px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.3);
        }

        .progress > i {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            transition: width 0.4s ease;
        }

        .method-block {
            border: 1px dashed rgba(148, 163, 184, 0.5);
            border-radius: 10px;
            padding: 0.65rem;
        }

        .method-block h4 {
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
            color: var(--text-primary);
        }

        .method-block ul {
            list-style: none;
            display: grid;
            gap: 0.3rem;
        }

        .method-block li {
            font-size: 0.74rem;
            color: var(--text-secondary);
            line-height: 1.45;
            padding-left: 0.95rem;
            position: relative;
        }

        .method-block li::before {
            content: '';
            width: 5px;
            height: 5px;
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 0.45rem;
            background: var(--accent-cyan);
        }

        .model-block {
            margin-bottom: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.72rem 0.76rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(16, 185, 129, 0.08));
        }

        [data-theme="dark"] .model-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.45), rgba(15, 23, 42, 0.75));
        }

        .model-head {
            margin-bottom: 0.45rem;
        }

        .model-head h4 {
            font-size: 0.82rem;
            margin-bottom: 0.2rem;
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .model-head p {
            margin: 0;
            font-size: 0.74rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        .diagram-canvas {
            margin-bottom: 0.56rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.5);
            overflow-x: auto;
        }

        [data-theme="dark"] .diagram-canvas {
            background: rgba(15, 23, 42, 0.64);
        }

        .diagram-svg {
            width: 100%;
            min-width: 760px;
            height: auto;
            display: block;
            font-family: 'Inter', sans-serif;
            text-rendering: geometricPrecision;
        }

        .diagram-svg .diag-box {
            stroke: rgba(30, 58, 95, 0.42);
            stroke-width: 1.4;
            fill: rgba(255, 255, 255, 0.78);
        }

        [data-theme="dark"] .diagram-svg .diag-box {
            stroke: rgba(148, 163, 184, 0.34);
            fill: rgba(30, 41, 59, 0.86);
        }

        .diagram-svg .diag-box-input { fill: rgba(59, 130, 246, 0.12); }
        .diagram-svg .diag-box-thermal { fill: rgba(6, 182, 212, 0.12); }
        .diagram-svg .diag-box-hydraulic { fill: rgba(139, 92, 246, 0.12); }
        .diagram-svg .diag-box-impact { fill: rgba(16, 185, 129, 0.12); }
        .diagram-svg .diag-box-cost { fill: rgba(245, 158, 11, 0.12); }
        .diagram-svg .diag-box-compliance { fill: rgba(239, 68, 68, 0.12); }
        .diagram-svg .diag-box-control { fill: rgba(14, 165, 233, 0.12); }

        [data-theme="dark"] .diagram-svg .diag-box-input { fill: rgba(59, 130, 246, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-thermal { fill: rgba(6, 182, 212, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-hydraulic { fill: rgba(139, 92, 246, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-impact { fill: rgba(16, 185, 129, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-cost { fill: rgba(245, 158, 11, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-compliance { fill: rgba(239, 68, 68, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-control { fill: rgba(14, 165, 233, 0.22); }

        .diagram-svg .diag-title {
            fill: var(--text-primary);
            font-size: 12px;
            font-weight: 700;
        }

        .diagram-svg .diag-value {
            fill: var(--text-secondary);
            font-size: 10.2px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }

        .diagram-svg .diag-caption {
            fill: var(--text-muted);
            font-size: 11.2px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
        }

        .diagram-svg .diag-line {
            stroke: rgba(100, 116, 139, 0.8);
            stroke-width: 2.2;
            fill: none;
            marker-end: url(#diagArrow);
        }

        .diagram-svg .diag-gate-shape {
            stroke: rgba(30, 58, 95, 0.42);
            stroke-width: 1.3;
            fill: rgba(148, 163, 184, 0.16);
        }

        .diagram-svg .diag-gate-shape.ok {
            fill: rgba(16, 185, 129, 0.2);
            stroke: rgba(5, 150, 105, 0.58);
        }

        .diagram-svg .diag-gate-shape.warn {
            fill: rgba(245, 158, 11, 0.2);
            stroke: rgba(217, 119, 6, 0.58);
        }

        .diagram-svg .diag-gate-link {
            stroke: rgba(100, 116, 139, 0.72);
            stroke-width: 1.8;
            stroke-dasharray: 5 4;
            fill: none;
            marker-end: url(#diagArrowCtrl);
        }

        .diagram-svg .diag-gate-note-bg {
            fill: rgba(255, 255, 255, 0.72);
            stroke: rgba(148, 163, 184, 0.34);
            stroke-width: 0.9;
        }

        .diagram-svg .diag-gate-note {
            fill: var(--text-primary);
            font-size: 11.2px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
        }

        [data-theme="dark"] .diagram-svg .diag-gate-shape {
            fill: rgba(71, 85, 105, 0.3);
            stroke: rgba(148, 163, 184, 0.42);
        }

        [data-theme="dark"] .diagram-svg .diag-gate-shape.ok {
            fill: rgba(16, 185, 129, 0.26);
            stroke: rgba(52, 211, 153, 0.62);
        }

        [data-theme="dark"] .diagram-svg .diag-gate-shape.warn {
            fill: rgba(245, 158, 11, 0.26);
            stroke: rgba(251, 191, 36, 0.68);
        }

        [data-theme="dark"] .diagram-svg .diag-gate-note-bg {
            fill: rgba(15, 23, 42, 0.78);
            stroke: rgba(148, 163, 184, 0.42);
        }

        .diagram-svg [data-block-popup] {
            cursor: pointer;
        }

        .diagram-svg rect[data-block-popup],
        .diagram-svg polygon[data-block-popup] {
            transition: stroke 0.16s ease, stroke-width 0.16s ease, filter 0.16s ease;
        }

        .diagram-svg rect[data-block-popup]:hover,
        .diagram-svg rect[data-block-popup]:focus,
        .diagram-svg polygon[data-block-popup]:hover,
        .diagram-svg polygon[data-block-popup]:focus {
            stroke-width: 2.3;
            stroke: rgba(37, 99, 235, 0.85);
            filter: brightness(1.08) saturate(1.08);
            outline: none;
        }

        .diagram-svg text[data-block-popup]:hover,
        .diagram-svg text[data-block-popup]:focus {
            fill: #2563eb;
            opacity: 1;
            outline: none;
        }

        [data-theme="dark"] .diagram-svg text[data-block-popup]:hover,
        [data-theme="dark"] .diagram-svg text[data-block-popup]:focus {
            fill: #60a5fa;
        }

        body.block-popup-open {
            overflow: hidden;
        }

        .block-detail-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10040;
            padding: 1rem;
        }

        .block-detail-modal.open {
            display: flex;
        }

        .block-detail-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(2, 6, 23, 0.62);
            backdrop-filter: blur(2px);
        }

        .block-detail-card {
            position: relative;
            width: min(1040px, calc(100vw - 1.4rem));
            max-height: calc(100vh - 1.4rem);
            overflow: auto;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.34);
            background: #0f172a;
            box-shadow: 0 24px 70px rgba(2, 6, 23, 0.58);
            color: #cbd5e1;
            padding: 0.86rem 0.9rem;
        }

        .block-detail-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.7rem;
            margin-bottom: 0.55rem;
            padding-bottom: 0.52rem;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.38);
        }

        .block-detail-head h4 {
            margin: 0;
            font-size: 0.9rem;
            color: #e2e8f0;
            letter-spacing: 0.01em;
        }

        .block-detail-head p {
            margin: 0.14rem 0 0;
            font-size: 0.74rem;
            color: #93c5fd;
            line-height: 1.45;
        }

        .block-detail-head-actions {
            display: inline-flex;
            align-items: center;
            gap: 0.42rem;
            flex-wrap: wrap;
        }

        .block-detail-body {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.58rem;
        }

        .block-detail-section {
            border: 1px solid rgba(148, 163, 184, 0.24);
            border-radius: 10px;
            padding: 0.52rem 0.56rem;
            background: rgba(30, 41, 59, 0.62);
        }

        .block-detail-section h5 {
            margin: 0 0 0.28rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #bfdbfe;
        }

        .block-detail-pre {
            margin: 0;
            white-space: pre-wrap;
            font-size: 0.75rem;
            line-height: 1.45;
            color: #cbd5e1;
            font-family: 'JetBrains Mono', monospace;
        }

        .block-detail-list {
            margin: 0;
            padding-left: 1rem;
            display: grid;
            gap: 0.2rem;
        }

        .block-detail-list li {
            font-size: 0.74rem;
            line-height: 1.4;
        }

        .block-detail-list li.ok { color: #34d399; }
        .block-detail-list li.warn { color: #fbbf24; }
        .block-detail-list li.err { color: #f87171; }

        .block-detail-foot {
            display: flex;
            justify-content: flex-end;
            gap: 0.42rem;
            flex-wrap: wrap;
            margin-top: 0.64rem;
            padding-top: 0.52rem;
            border-top: 1px dashed rgba(148, 163, 184, 0.34);
        }

        .model-track {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr auto 1fr;
            align-items: center;
            gap: 0.45rem;
        }

        .model-arrow {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 700;
            text-align: center;
        }

        .model-node {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.46rem 0.5rem;
            background: rgba(255, 255, 255, 0.5);
        }

        [data-theme="dark"] .model-node {
            background: rgba(30, 41, 59, 0.7);
        }

        .model-node .tag {
            display: block;
            font-size: 0.64rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            margin-bottom: 0.18rem;
            font-weight: 700;
        }

        .model-node .val {
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
            white-space: normal;
            overflow-wrap: anywhere;
            line-height: 1.35;
        }

        .model-impact-grid {
            margin-top: 0.52rem;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.45rem;
        }

        .model-impact {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.4rem 0.46rem;
            background: rgba(255, 255, 255, 0.52);
        }

        [data-theme="dark"] .model-impact {
            background: rgba(30, 41, 59, 0.7);
        }

        .model-impact .k {
            display: block;
            font-size: 0.61rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.1rem;
            font-weight: 700;
        }

        .model-impact .v {
            font-size: 0.78rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            font-weight: 700;
        }

        .flow-block {
            margin-top: 0.68rem;
            margin-bottom: 0.68rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.68rem 0.72rem;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.08), rgba(245, 158, 11, 0.08));
        }

        [data-theme="dark"] .flow-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.4), rgba(15, 23, 42, 0.78));
        }

        .flow-head {
            margin-bottom: 0.42rem;
        }

        .flow-head h4 {
            font-size: 0.81rem;
            color: var(--text-primary);
            margin-bottom: 0.16rem;
            display: inline-flex;
            align-items: center;
            gap: 0.34rem;
        }

        .flow-head p {
            margin: 0;
            font-size: 0.73rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .flow-row {
            display: grid;
            grid-template-columns: 130px 1fr auto;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.32rem;
        }

        .flow-row span:first-child {
            font-size: 0.69rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .flow-row span:last-child {
            font-size: 0.68rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            text-align: right;
            min-width: 58px;
        }

        .flow-bar {
            height: 8px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.24);
        }

        .flow-bar > i {
            display: block;
            width: 0%;
            height: 100%;
            transition: width 0.35s ease;
            background: linear-gradient(90deg, #0ea5e9, #22c55e);
        }

        #barFlowIt { background: linear-gradient(90deg, #38bdf8, #3b82f6); }
        #barFlowLiquid { background: linear-gradient(90deg, #06b6d4, #10b981); }
        #barFlowAir { background: linear-gradient(90deg, #f59e0b, #f97316); }
        #barFlowPump { background: linear-gradient(90deg, #8b5cf6, #6366f1); }
        #barFlowElecLoss { background: linear-gradient(90deg, #ef4444, #f97316); }
        #barFlowAux { background: linear-gradient(90deg, #64748b, #475569); }

        .control-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.66rem 0.72rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(37, 99, 235, 0.08));
        }

        [data-theme="dark"] .control-block {
            background: linear-gradient(135deg, rgba(76, 29, 149, 0.35), rgba(15, 23, 42, 0.72));
        }

        .control-loop {
            stroke: rgba(100, 116, 139, 0.78);
            stroke-width: 2.2;
            fill: none;
        }

        .logic-seq-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.62rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(16, 185, 129, 0.08));
        }

        [data-theme="dark"] .logic-seq-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.44), rgba(15, 23, 42, 0.74));
        }

        .logic-seq {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 0.4rem;
            align-items: stretch;
        }

        .logic-step {
            border: 1px solid var(--border);
            border-radius: 9px;
            background: rgba(255, 255, 255, 0.6);
            padding: 0.35rem 0.4rem;
            position: relative;
        }

        [data-theme="dark"] .logic-step {
            background: rgba(15, 23, 42, 0.68);
        }

        .logic-step:not(:last-child)::after {
            content: '\f061';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: -0.31rem;
            top: 0.46rem;
            font-size: 0.62rem;
            color: rgba(59, 130, 246, 0.74);
            z-index: 2;
        }

        .logic-step .n {
            display: inline-flex;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            background: rgba(37, 99, 235, 0.16);
            color: #2563eb;
            margin-right: 0.26rem;
        }

        [data-theme="dark"] .logic-step .n {
            background: rgba(96, 165, 250, 0.22);
            color: #93c5fd;
        }

        .logic-step h5 {
            margin: 0 0 0.18rem;
            font-size: 0.66rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .logic-step p {
            margin: 0;
            font-size: 0.66rem;
            color: var(--text-secondary);
            line-height: 1.36;
            font-family: 'Inter', sans-serif;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .trace-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px dashed rgba(148, 163, 184, 0.55);
            border-radius: 11px;
            padding: 0.58rem;
            background: rgba(255, 255, 255, 0.42);
        }

        [data-theme="dark"] .trace-block {
            background: rgba(30, 41, 59, 0.54);
        }

        .trace-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.38rem;
        }

        .trace-head h4 {
            font-size: 0.8rem;
            color: var(--text-primary);
            margin: 0;
        }

        .trace-badge {
            font-size: 0.66rem;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.14rem 0.4rem;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.66);
        }

        [data-theme="dark"] .trace-badge {
            background: rgba(15, 23, 42, 0.72);
        }

        .trace-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .trace-col {
            border: 1px solid var(--border);
            border-radius: 9px;
            padding: 0.45rem 0.5rem;
            background: rgba(255, 255, 255, 0.48);
            min-height: 170px;
        }

        [data-theme="dark"] .trace-col {
            background: rgba(15, 23, 42, 0.66);
        }

        .trace-col h5 {
            margin: 0 0 0.3rem;
            font-size: 0.71rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
        }

        .trace-list {
            display: grid;
            gap: 0.18rem;
            max-height: 200px;
            overflow: auto;
            padding-right: 0.2rem;
        }

        .trace-item {
            font-size: 0.69rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.38;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.22);
            padding-bottom: 0.12rem;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .sensitivity-block {
            margin-top: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.45);
        }

        [data-theme="dark"] .sensitivity-block {
            background: rgba(15, 23, 42, 0.68);
        }

        .sensitivity-block h4 {
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            color: var(--text-primary);
        }

        .sensitivity-block p {
            font-size: 0.72rem;
            color: var(--text-secondary);
            margin-bottom: 0.38rem;
            line-height: 1.45;
        }

        .pipeline-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.66rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(20, 184, 166, 0.08));
        }

        [data-theme="dark"] .pipeline-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.42), rgba(15, 23, 42, 0.76));
        }

        .pipeline-head {
            margin-bottom: 0.42rem;
        }

        .pipeline-head h4 {
            margin: 0 0 0.18rem;
            font-size: 0.82rem;
            color: var(--text-primary);
        }

        .pipeline-head p {
            margin: 0;
            font-size: 0.73rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        .pipeline-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.45rem;
        }

        .pipeline-stage {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.52);
            padding: 0.45rem 0.5rem;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        [data-theme="dark"] .pipeline-stage {
            background: rgba(15, 23, 42, 0.66);
        }

        .pipeline-stage h5 {
            margin: 0 0 0.25rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            font-weight: 700;
        }

        .stage-lines {
            display: grid;
            gap: 0.16rem;
            max-height: 180px;
            overflow: auto;
            padding-right: 0.1rem;
        }

        .stage-line {
            font-size: 0.68rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            line-height: 1.34;
            overflow-wrap: anywhere;
            word-break: break-word;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.2);
            padding-bottom: 0.08rem;
        }

        .fullmap-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.66rem;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(99, 102, 241, 0.08));
        }

        [data-theme="dark"] .fullmap-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.42), rgba(30, 27, 75, 0.52));
        }

        .fullmap-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.5rem;
            position: relative;
        }

        .fullmap-col {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.52);
            padding: 0.45rem 0.48rem;
            min-height: 210px;
            position: relative;
        }

        [data-theme="dark"] .fullmap-col {
            background: rgba(15, 23, 42, 0.68);
        }

        .fullmap-col:not(:last-child)::after {
            content: '\f061';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: -0.42rem;
            top: 0.72rem;
            color: rgba(59, 130, 246, 0.72);
            font-size: 0.68rem;
            z-index: 2;
        }

        .fullmap-col h5 {
            margin: 0 0 0.25rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            font-weight: 700;
        }

        .fullmap-nodes {
            display: grid;
            gap: 0.22rem;
            max-height: 260px;
            overflow: auto;
            padding-right: 0.1rem;
        }

        .fullmap-node {
            border: 1px solid rgba(148, 163, 184, 0.28);
            border-radius: 8px;
            padding: 0.24rem 0.32rem;
            background: rgba(255, 255, 255, 0.6);
            animation: nodePulse 0.8s ease;
            transform-origin: center;
        }

        [data-theme="dark"] .fullmap-node {
            background: rgba(30, 41, 59, 0.6);
        }

        .fullmap-key {
            font-size: 0.66rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.34;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .fullmap-val {
            margin-top: 0.08rem;
            font-size: 0.68rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .fullmap-note {
            margin-top: 0.36rem;
            margin-bottom: 0;
            font-size: 0.71rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        @keyframes nodePulse {
            0% { opacity: 0; transform: translateY(3px) scale(0.995); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .term-tooltip {
            position: relative;
            border-bottom: 1px dotted rgba(37, 99, 235, 0.75);
            cursor: help;
            color: inherit;
            text-decoration: none;
        }

        .term-hotspot {
            cursor: help;
        }

        .term-tooltip.auto-term {
            border-bottom-style: dashed;
            border-bottom-color: rgba(2, 132, 199, 0.72);
            border-bottom-width: 1px;
        }

        [data-theme="dark"] .term-tooltip {
            border-bottom-color: rgba(96, 165, 250, 0.8);
        }

        .term-tooltip::after {
            content: none;
        }

        .term-tooltip-panel {
            position: fixed;
            display: none;
            width: 320px;
            background: #1e293b;
            border: 1px solid rgba(37, 99, 235, 0.35);
            border-radius: 10px;
            padding: 12px;
            z-index: 10030;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            pointer-events: none;
        }

        [data-theme="dark"] .term-tooltip-panel {
            border-color: rgba(96, 165, 250, 0.35);
        }

        .term-tooltip-panel .term-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 6px;
        }

        .term-tooltip-panel .term-desc {
            font-size: 0.76rem;
            color: #cbd5e1;
            line-height: 1.45;
        }

        .term-tooltip-panel .term-impact {
            margin-top: 7px;
            padding-top: 7px;
            border-top: 1px dashed rgba(148, 163, 184, 0.35);
            font-size: 0.72rem;
            color: #cbd5e1;
            line-height: 1.42;
        }

        .target-block {
            margin-top: 0.65rem;
            border: 1px dashed rgba(148, 163, 184, 0.55);
            border-radius: 10px;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.42);
        }

        [data-theme="dark"] .target-block {
            background: rgba(30, 41, 59, 0.55);
        }

        .target-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
            margin-bottom: 0.35rem;
        }

        .target-head h4 {
            font-size: 0.8rem;
            margin: 0;
            color: var(--text-primary);
        }

        .target-badge {
            font-size: 0.68rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.16rem 0.42rem;
            background: rgba(255, 255, 255, 0.65);
        }

        [data-theme="dark"] .target-badge {
            background: rgba(15, 23, 42, 0.72);
        }

        .target-list {
            list-style: none;
            display: grid;
            gap: 0.3rem;
            margin: 0 0 0.45rem;
            padding: 0;
        }

        .target-list li {
            font-size: 0.76rem;
            color: var(--text-secondary);
            line-height: 1.45;
            padding-left: 1rem;
            position: relative;
        }

        .target-list li::before {
            content: '';
            width: 5px;
            height: 5px;
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 0.43rem;
            background: var(--accent-emerald);
        }

        .scenario-table-wrap {
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.42);
        }

        [data-theme="dark"] .scenario-table-wrap {
            background: rgba(15, 23, 42, 0.65);
        }

        .scenario-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.72rem;
            table-layout: fixed;
        }

        .scenario-table th {
            text-align: left;
            padding: 0.45rem 0.5rem;
            background: rgba(30, 58, 95, 0.12);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.62rem;
        }

        .scenario-table td {
            padding: 0.42rem 0.5rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
            color: var(--text-primary);
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .scenario-table tbody tr:last-child td {
            border-bottom: none;
        }

        .feature-block {
            margin-top: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.46);
        }

        [data-theme="dark"] .feature-block {
            background: rgba(15, 23, 42, 0.66);
        }

        .feature-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.36rem;
            flex-wrap: wrap;
        }

        .feature-head h4 {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .feature-head p {
            margin: 0;
            font-size: 0.71rem;
            color: var(--text-secondary);
            line-height: 1.42;
            width: 100%;
        }

        .explorer-controls {
            margin-top: 0.28rem;
            display: flex;
            align-items: center;
            gap: 0.42rem;
            flex-wrap: wrap;
        }

        .explorer-controls .field {
            min-width: 150px;
        }

        .explorer-meta {
            margin-top: 0.34rem;
            border: 1px dashed rgba(148, 163, 184, 0.44);
            border-radius: 9px;
            padding: 0.32rem 0.4rem;
            font-size: 0.68rem;
            color: var(--text-secondary);
            line-height: 1.45;
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-line;
        }

        .explorer-accordion {
            margin-top: 0.4rem;
            display: grid;
            gap: 0.38rem;
        }

        .exp-block {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.6);
            overflow: hidden;
        }

        [data-theme="dark"] .exp-block {
            background: rgba(15, 23, 42, 0.72);
        }

        .exp-block[open] {
            border-color: rgba(59, 130, 246, 0.45);
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
        }

        .exp-block.pinned {
            order: -1;
            border-color: rgba(14, 116, 144, 0.5);
        }

        .exp-block summary {
            list-style: none;
            cursor: pointer;
            padding: 0.44rem 0.5rem;
            display: grid;
            gap: 0.18rem;
        }

        .exp-block summary::-webkit-details-marker {
            display: none;
        }

        .exp-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .exp-title {
            font-size: 0.74rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .exp-sub {
            font-size: 0.68rem;
            color: var(--text-secondary);
            line-height: 1.38;
            font-family: 'JetBrains Mono', monospace;
        }

        .exp-tags {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .exp-body {
            border-top: 1px solid var(--border);
            padding: 0.42rem 0.48rem 0.5rem;
        }

        .exp-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.38rem;
        }

        .exp-panel {
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.58);
            padding: 0.34rem 0.4rem;
            min-height: 84px;
        }

        [data-theme="dark"] .exp-panel {
            background: rgba(30, 41, 59, 0.64);
        }

        .exp-panel h5 {
            margin: 0 0 0.18rem;
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .exp-list {
            margin: 0;
            padding-left: 0.9rem;
            display: grid;
            gap: 0.16rem;
        }

        .exp-list li {
            font-size: 0.68rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .exp-list li.ok {
            color: #047857;
        }

        .exp-list li.warn {
            color: #b45309;
        }

        .exp-list li.err {
            color: #b91c1c;
        }

        [data-theme="dark"] .exp-list li.ok {
            color: #34d399;
        }

        [data-theme="dark"] .exp-list li.warn {
            color: #fbbf24;
        }

        [data-theme="dark"] .exp-list li.err {
            color: #f87171;
        }

        .exp-pre {
            margin: 0;
            font-size: 0.67rem;
            line-height: 1.42;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-line;
        }

        .exp-spark {
            width: 100%;
            height: 56px;
            display: block;
        }

        .exp-actions {
            margin-top: 0.36rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .exp-note {
            margin-top: 0.35rem;
            display: grid;
            gap: 0.2rem;
        }

        .exp-note textarea {
            width: 100%;
            min-height: 62px;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.4rem 0.48rem;
            font-size: 0.71rem;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.74);
            line-height: 1.42;
            font-family: 'Inter', sans-serif;
            resize: vertical;
        }

        [data-theme="dark"] .exp-note textarea {
            background: rgba(15, 23, 42, 0.8);
        }

        .exp-checks {
            margin-top: 0.28rem;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.3rem;
        }

        .exp-checks label {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.67rem;
            color: var(--text-secondary);
        }

        .exp-compare {
            margin-top: 0.38rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.4rem 0.44rem;
            background: rgba(255, 255, 255, 0.56);
        }

        [data-theme="dark"] .exp-compare {
            background: rgba(15, 23, 42, 0.72);
        }

        .exp-compare-grid {
            margin-top: 0.3rem;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.34rem;
        }

        .exp-compare-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.34rem 0.4rem;
            background: rgba(255, 255, 255, 0.64);
        }

        [data-theme="dark"] .exp-compare-card {
            background: rgba(30, 41, 59, 0.68);
        }

        .exp-compare-card h5 {
            margin: 0 0 0.14rem;
            font-size: 0.69rem;
            color: var(--text-primary);
        }

        .exp-compare-card .exp-pre {
            font-size: 0.66rem;
        }

        .exp-diag {
            margin-top: 0.36rem;
            border: 1px dashed rgba(148, 163, 184, 0.5);
            border-radius: 8px;
            padding: 0.3rem 0.36rem;
            font-size: 0.66rem;
            line-height: 1.4;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-line;
        }

        .exp-skeleton {
            height: 74px;
            border-radius: 8px;
            background: linear-gradient(90deg, rgba(148,163,184,0.16), rgba(148,163,184,0.28), rgba(148,163,184,0.16));
            background-size: 200% 100%;
            animation: expShimmer 1.2s infinite;
        }

        @keyframes expShimmer {
            0% { background-position: 180% 0; }
            100% { background-position: -20% 0; }
        }

        body.explorer-focus .calc-output-panel > .feature-block:not(.explorer-block),
        body.explorer-focus .calc-output-panel > .logic-seq-block,
        body.explorer-focus .calc-output-panel > .pipeline-block,
        body.explorer-focus .calc-output-panel > .fullmap-block,
        body.explorer-focus .calc-output-panel > .flow-block,
        body.explorer-focus .calc-output-panel > .target-block,
        body.explorer-focus .calc-output-panel > .control-block,
        body.explorer-focus .calc-output-panel > .model-block {
            display: none;
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.42rem;
        }

        .field {
            display: grid;
            gap: 0.2rem;
        }

        .field label {
            font-size: 0.66rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        .field input,
        .field select,
        .field textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.46rem 0.52rem;
            font-size: 0.75rem;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.68);
            font-family: 'Inter', sans-serif;
        }

        [data-theme="dark"] .field input,
        [data-theme="dark"] .field select,
        [data-theme="dark"] .field textarea {
            background: rgba(30, 41, 59, 0.74);
        }

        .field textarea {
            min-height: 58px;
            resize: vertical;
            line-height: 1.38;
        }

        .inline-actions {
            margin-top: 0.45rem;
            display: flex;
            align-items: center;
            gap: 0.45rem;
            flex-wrap: wrap;
        }

        .status-pill {
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.2rem 0.5rem;
            font-size: 0.67rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.66);
        }

        [data-theme="dark"] .status-pill {
            background: rgba(15, 23, 42, 0.72);
        }

        .status-pill.ok {
            color: #047857;
            border-color: rgba(16, 185, 129, 0.55);
        }

        .status-pill.warn {
            color: #b45309;
            border-color: rgba(245, 158, 11, 0.6);
        }

        .status-pill.err {
            color: #b91c1c;
            border-color: rgba(239, 68, 68, 0.58);
        }

        [data-theme="dark"] .status-pill.ok {
            color: #34d399;
        }

        [data-theme="dark"] .status-pill.warn {
            color: #fbbf24;
        }

        [data-theme="dark"] .status-pill.err {
            color: #f87171;
        }

        .equation-list {
            display: grid;
            gap: 0.25rem;
            max-height: 220px;
            overflow: auto;
            padding-right: 0.2rem;
        }

        .equation-line {
            font-size: 0.71rem;
            line-height: 1.4;
            color: var(--text-secondary);
            border-bottom: 1px dashed rgba(148, 163, 184, 0.24);
            padding-bottom: 0.14rem;
            font-family: 'JetBrains Mono', monospace;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .equation-line strong {
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }

        .scenario-list {
            width: 100%;
            min-height: 88px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.68);
            color: var(--text-primary);
            padding: 0.34rem;
            font-size: 0.74rem;
        }

        [data-theme="dark"] .scenario-list {
            background: rgba(30, 41, 59, 0.74);
        }

        .note-box {
            margin-top: 0.35rem;
            border: 1px dashed rgba(148, 163, 184, 0.46);
            border-radius: 8px;
            padding: 0.42rem;
            font-size: 0.71rem;
            line-height: 1.44;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.42);
            white-space: pre-line;
        }

        [data-theme="dark"] .note-box {
            background: rgba(30, 41, 59, 0.5);
        }

        .chart-panel {
            margin-top: 0.42rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.46rem;
            background: rgba(255, 255, 255, 0.56);
        }

        [data-theme="dark"] .chart-panel {
            background: rgba(15, 23, 42, 0.72);
        }

        .chart-panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.42rem;
            flex-wrap: wrap;
            margin-bottom: 0.32rem;
        }

        .chart-panel-head h5 {
            margin: 0;
            font-size: 0.74rem;
            color: var(--text-primary);
            letter-spacing: 0.01em;
        }

        .chart-canvas {
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.68);
            overflow: auto;
        }

        [data-theme="dark"] .chart-canvas {
            background: rgba(15, 23, 42, 0.74);
        }

        .chart-svg {
            width: 100%;
            min-width: 500px;
            height: auto;
            display: block;
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
        }

        .pareto-insight {
            margin-top: 0.42rem;
            border: 1px solid var(--border);
            border-radius: 9px;
            padding: 0.42rem 0.46rem;
            background: rgba(255, 255, 255, 0.58);
        }

        [data-theme="dark"] .pareto-insight {
            background: rgba(15, 23, 42, 0.74);
        }

        .pareto-insight-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.38rem;
            flex-wrap: wrap;
        }

        .pareto-insight-title {
            font-size: 0.73rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .pareto-insight-line {
            margin-top: 0.22rem;
            font-size: 0.68rem;
            color: var(--text-secondary);
            line-height: 1.4;
            font-family: 'JetBrains Mono', monospace;
            overflow-wrap: anywhere;
        }

        .histogram-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.42rem;
        }

        .hist-placeholder {
            grid-column: 1 / -1;
            border: 1px dashed rgba(148, 163, 184, 0.5);
            border-radius: 8px;
            padding: 0.66rem;
            font-size: 0.72rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.58);
        }

        [data-theme="dark"] .hist-placeholder {
            background: rgba(30, 41, 59, 0.58);
        }

        .hist-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.4rem 0.44rem;
            background: rgba(255, 255, 255, 0.62);
        }

        [data-theme="dark"] .hist-card {
            background: rgba(30, 41, 59, 0.66);
        }

        .hist-head {
            display: flex;
            justify-content: space-between;
            gap: 0.35rem;
            align-items: baseline;
            margin-bottom: 0.24rem;
        }

        .hist-title {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .hist-range {
            font-size: 0.64rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .hist-bars {
            height: 96px;
            display: grid;
            grid-template-columns: repeat(14, minmax(0, 1fr));
            align-items: end;
            gap: 2px;
            padding: 0 1px;
        }

        .hist-bar {
            border-radius: 4px 4px 1px 1px;
            min-height: 2px;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.94), rgba(6, 182, 212, 0.85));
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .hist-bar.warn {
            background: linear-gradient(180deg, rgba(245, 158, 11, 0.92), rgba(251, 191, 36, 0.86));
            border-color: rgba(245, 158, 11, 0.48);
        }

        .hist-bar.err {
            background: linear-gradient(180deg, rgba(239, 68, 68, 0.92), rgba(248, 113, 113, 0.86));
            border-color: rgba(239, 68, 68, 0.48);
        }

        .hist-footer {
            margin-top: 0.26rem;
            font-size: 0.65rem;
            color: var(--text-muted);
            line-height: 1.45;
            font-family: 'JetBrains Mono', monospace;
        }

        .sankey-canvas {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.62);
            overflow: auto;
        }

        [data-theme="dark"] .sankey-canvas {
            background: rgba(15, 23, 42, 0.74);
        }

        .sankey-svg {
            width: 100%;
            min-width: 740px;
            height: auto;
            display: block;
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
        }

        .sankey-svg .sankey-node {
            cursor: pointer;
            outline: none;
        }

        .sankey-svg .sankey-node rect {
            transition: stroke 0.16s ease, stroke-width 0.16s ease, filter 0.16s ease;
        }

        .sankey-svg .sankey-node:hover rect,
        .sankey-svg .sankey-node:focus rect {
            stroke: rgba(59, 130, 246, 0.94);
            stroke-width: 1.8;
            filter: brightness(1.12) saturate(1.08);
        }

        .sankey-svg .sankey-node:hover text,
        .sankey-svg .sankey-node:focus text {
            fill: #2563eb;
            opacity: 1;
        }

        [data-theme="dark"] .sankey-svg .sankey-node:hover text,
        [data-theme="dark"] .sankey-svg .sankey-node:focus text {
            fill: #7dd3fc;
        }

        body.sankey-popup-open {
            overflow: hidden;
        }

        .sankey-drill-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10045;
            padding: 0.9rem;
        }

        .sankey-drill-modal.open {
            display: flex;
        }

        .sankey-drill-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(2, 6, 23, 0.66);
            backdrop-filter: blur(3px);
        }

        .sankey-drill-card {
            position: relative;
            width: min(1180px, calc(100vw - 1rem));
            max-height: calc(100vh - 1rem);
            overflow: auto;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: #0b1531;
            box-shadow: 0 28px 70px rgba(2, 6, 23, 0.62);
            color: #cbd5e1;
            padding: 0.8rem 0.9rem;
        }

        .sankey-drill-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.72rem;
            margin-bottom: 0.55rem;
            padding-bottom: 0.52rem;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.4);
        }

        .sankey-drill-head h4 {
            margin: 0;
            font-size: 0.9rem;
            letter-spacing: 0.01em;
            color: #e2e8f0;
        }

        .sankey-drill-head p {
            margin: 0.15rem 0 0;
            font-size: 0.75rem;
            color: #93c5fd;
            line-height: 1.44;
        }

        .sankey-drill-actions {
            display: inline-flex;
            align-items: center;
            gap: 0.42rem;
            flex-wrap: wrap;
        }

        .sankey-drill-grid {
            display: grid;
            grid-template-columns: minmax(0, 2.15fr) minmax(0, 1.35fr);
            gap: 0.62rem;
        }

        .sankey-drill-canvas {
            border: 1px solid rgba(148, 163, 184, 0.24);
            border-radius: 11px;
            background: rgba(15, 23, 42, 0.58);
            padding: 0.36rem;
            overflow: auto;
        }

        .sankey-drill-svg {
            width: 100%;
            min-width: 680px;
            height: auto;
            display: block;
            color: #cbd5e1;
            font-family: 'Inter', sans-serif;
        }

        .mode-help-btn {
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(30, 64, 175, 0.14);
            color: #93c5fd;
            border-radius: 999px;
            font-size: 0.64rem;
            font-weight: 700;
            letter-spacing: 0.01em;
            line-height: 1;
            padding: 0.18rem 0.42rem;
            margin-left: 0.3rem;
            cursor: pointer;
        }

        .mode-help-btn:hover,
        .mode-help-btn:focus {
            background: rgba(30, 64, 175, 0.28);
            color: #bfdbfe;
            outline: none;
        }

        .mode-help-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10048;
            padding: 0.9rem;
        }

        .mode-help-modal.open {
            display: flex;
        }

        .mode-help-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(2, 6, 23, 0.68);
            backdrop-filter: blur(3px);
        }

        .mode-help-card {
            position: relative;
            width: min(980px, calc(100vw - 1rem));
            max-height: calc(100vh - 1rem);
            overflow: auto;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: #0b1531;
            box-shadow: 0 28px 70px rgba(2, 6, 23, 0.62);
            color: #cbd5e1;
            padding: 0.78rem 0.86rem;
        }

        .mode-help-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.7rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.38);
        }

        .mode-help-head h4 {
            margin: 0;
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        .mode-help-head p {
            margin: 0.15rem 0 0;
            font-size: 0.74rem;
            color: #93c5fd;
            line-height: 1.44;
        }

        .mode-help-body {
            display: grid;
            gap: 0.55rem;
        }

        .mode-help-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.73rem;
        }

        .mode-help-table th,
        .mode-help-table td {
            padding: 0.31rem 0.16rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            vertical-align: top;
            text-align: left;
        }

        .mode-help-table th {
            font-size: 0.66rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #93c5fd;
        }

        .mode-help-table tr:last-child td {
            border-bottom: none;
        }

        .mode-help-list {
            margin: 0;
            padding-left: 1rem;
            display: grid;
            gap: 0.2rem;
        }

        .mode-help-list li {
            font-size: 0.73rem;
            line-height: 1.44;
        }

        .sankey-drill-side {
            display: grid;
            gap: 0.56rem;
            align-content: start;
        }

        .sankey-drill-panel {
            border: 1px solid rgba(148, 163, 184, 0.24);
            border-radius: 10px;
            background: rgba(30, 41, 59, 0.6);
            padding: 0.5rem 0.56rem;
        }

        .sankey-drill-panel h5 {
            margin: 0 0 0.32rem;
            font-size: 0.74rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #bfdbfe;
        }

        .sankey-drill-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.72rem;
        }

        .sankey-drill-table th,
        .sankey-drill-table td {
            padding: 0.27rem 0.14rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.21);
            vertical-align: top;
        }

        .sankey-drill-table th {
            color: #93c5fd;
            font-size: 0.66rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            text-align: left;
        }

        .sankey-drill-table td:last-child {
            color: #9ca3af;
        }

        .sankey-drill-table tr:last-child td {
            border-bottom: none;
        }

        .sankey-drill-pre {
            margin: 0;
            white-space: pre-wrap;
            font-size: 0.72rem;
            line-height: 1.45;
            color: #cbd5e1;
            font-family: 'JetBrains Mono', monospace;
        }

        .sankey-drill-list {
            margin: 0;
            padding-left: 1rem;
            display: grid;
            gap: 0.2rem;
        }

        .sankey-drill-list li {
            font-size: 0.72rem;
            line-height: 1.42;
            color: #cbd5e1;
        }

        .scenario-table tbody tr.clickable {
            cursor: pointer;
        }

        .scenario-table tbody tr.clickable:hover {
            background: rgba(59, 130, 246, 0.08);
        }

        .scenario-table tbody tr.clickable.selected {
            background: rgba(16, 185, 129, 0.14);
            outline: 1px solid rgba(16, 185, 129, 0.4);
        }

        .model-block.focus-flash {
            animation: focusPulse 0.9s ease;
        }

        @keyframes focusPulse {
            0% { box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
            50% { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.32); }
            100% { box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
        }

        .footer {
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            display: flex;
            justify-content: space-between;
            gap: 0.8rem;
            flex-wrap: wrap;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .footer a {
            color: inherit;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .root-gate {
            position: fixed;
            inset: 0;
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.2rem;
            background: rgba(2, 6, 23, 0.72);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }

        body.locked .root-gate {
            display: flex;
        }

        body.locked .navbar,
        body.locked .main-content,
        body.locked .page-background {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
        }

        .root-gate-card {
            width: 100%;
            max-width: 460px;
            border-radius: 16px;
            background: #0f172a;
            border: 1px solid rgba(245, 158, 11, 0.32);
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 20px 45px rgba(2, 6, 23, 0.5);
        }

        .root-gate-card .lock {
            width: 58px;
            height: 58px;
            border-radius: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            margin-bottom: 0.65rem;
        }

        .root-gate-card h2 {
            font-size: 1.2rem;
            color: #f8fafc;
            margin-bottom: 0.45rem;
        }

        .root-gate-card p {
            font-size: 0.84rem;
            color: #cbd5e1;
            line-height: 1.6;
        }

        .root-gate-actions {
            margin-top: 0.8rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .root-gate-actions button,
        .root-gate-actions a {
            border: none;
            border-radius: 10px;
            padding: 0.56rem 0.8rem;
            font-size: 0.8rem;
            font-weight: 700;
            text-decoration: none;
            cursor: pointer;
        }

        .root-gate-actions .login {
            color: #fff;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .root-gate-actions .back {
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: transparent;
            color: #e2e8f0;
        }

        .root-gate-note {
            margin-top: 0.55rem;
            font-size: 0.72rem;
            color: #94a3b8;
        }

        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 0.9rem 1.2rem;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 -2px 18px rgba(0, 0, 0, 0.08);
            font-size: 0.83rem;
            color: #334155;
            transition: transform 0.35s ease;
        }

        [data-theme="dark"] .cookie-banner {
            background: rgba(10, 15, 29, 0.95);
            color: #cbd5e1;
            border-top-color: rgba(148, 163, 184, 0.2);
        }

        .cookie-banner.hidden {
            transform: translateY(120%);
            pointer-events: none;
        }

        .cookie-banner a {
            color: #2563eb;
            text-decoration: underline;
        }

        .cookie-actions {
            display: flex;
            gap: 0.6rem;
            flex-shrink: 0;
        }

        .cookie-accept,
        .cookie-decline {
            border: 1px solid #cbd5e1;
            border-radius: 7px;
            padding: 0.42rem 0.8rem;
            font-size: 0.75rem;
            cursor: pointer;
            background: #fff;
        }

        .cookie-accept {
            border-color: #2563eb;
            background: #2563eb;
            color: #fff;
            font-weight: 700;
        }

        @media (max-width: 1180px) {
            .standards-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .calculator-layout {
                grid-template-columns: 1fr;
            }

            .calc-input-panel,
            .calc-output-panel {
                position: static;
                max-height: none;
                overflow: visible;
                padding-right: 0;
            }

            .output-quickbar {
                position: static;
            }

            .architecture-layout {
                grid-template-columns: 1fr;
            }

            .pipeline-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .fullmap-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .logic-seq {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .mini-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .telemetry-map-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .exp-grid,
            .exp-compare-grid {
                grid-template-columns: 1fr;
            }

            .block-detail-body {
                grid-template-columns: 1fr;
            }

            .exp-checks {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 860px) {
            .hero-kpis {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .standards-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .pipeline {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .model-track {
                grid-template-columns: 1fr;
            }

            .model-arrow {
                display: none;
            }

            .pipeline-grid {
                grid-template-columns: 1fr;
            }

            .fullmap-grid {
                grid-template-columns: 1fr;
            }

            .fullmap-col:not(:last-child)::after {
                content: none;
            }

            .logic-seq {
                grid-template-columns: 1fr;
            }

            .logic-step:not(:last-child)::after {
                content: none;
            }

            .fullmap-col {
                min-height: 0;
            }

            .fullmap-nodes {
                max-height: 220px;
            }

            .mini-grid {
                grid-template-columns: 1fr;
            }

            .telemetry-map-grid {
                grid-template-columns: 1fr;
            }

            .exp-checks {
                grid-template-columns: 1fr;
            }

            .histogram-grid {
                grid-template-columns: 1fr;
            }

            .block-detail-modal {
                padding: 0.5rem;
            }

            .block-detail-card {
                width: calc(100vw - 1rem);
                max-height: calc(100vh - 1rem);
                padding: 0.66rem;
            }

            .block-detail-head {
                flex-direction: column;
            }

            .block-detail-head-actions {
                width: 100%;
                justify-content: space-between;
            }

            .sankey-drill-modal {
                padding: 0.5rem;
            }

            .sankey-drill-card {
                width: calc(100vw - 1rem);
                max-height: calc(100vh - 1rem);
                padding: 0.66rem;
            }

            .sankey-drill-head {
                flex-direction: column;
            }

            .sankey-drill-actions {
                width: 100%;
                justify-content: space-between;
            }

            .sankey-drill-grid {
                grid-template-columns: 1fr;
            }

            .mode-help-modal {
                padding: 0.5rem;
            }

            .mode-help-card {
                width: calc(100vw - 1rem);
                max-height: calc(100vh - 1rem);
                padding: 0.66rem;
            }

            .mode-help-head {
                flex-direction: column;
            }

            .chart-svg {
                min-width: 420px;
            }

            .sankey-svg {
                min-width: 640px;
            }

            .sankey-drill-svg {
                min-width: 620px;
            }
        }

        @media (max-width: 640px) {
            .nav-container {
                padding: 0.75rem 0.9rem;
            }

            .brand-subtitle {
                display: none;
            }

            .main-content {
                padding: 1rem 0.9rem 2.5rem;
            }

            .hero {
                padding: 1.2rem;
            }

            .hero-kpis,
            .standards-grid,
            .input-grid,
            .cal-grid,
            .telemetry-import-grid,
            .result-grid {
                grid-template-columns: 1fr;
            }

            .workspace-toolbar {
                padding: 0.46rem;
            }

            .workspace-toolbar .toolbar-title {
                border-right: none;
                margin-right: 0;
                padding-right: 0;
                width: 100%;
            }

            .split-range {
                width: 100%;
            }

            .quick-kpi-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .pipeline {
                grid-template-columns: 1fr;
            }

            .flow-row {
                grid-template-columns: 1fr;
                gap: 0.2rem;
            }

            .flow-row span:last-child {
                text-align: left;
            }

            .trace-grid {
                grid-template-columns: 1fr;
            }

            .fullmap-block {
                padding: 0.52rem;
            }

            .fullmap-col {
                padding: 0.36rem 0.38rem;
            }

            .fullmap-col h5 {
                font-size: 0.64rem;
                margin-bottom: 0.2rem;
            }

            .fullmap-nodes {
                max-height: 180px;
                gap: 0.16rem;
            }

            .fullmap-node {
                padding: 0.18rem 0.24rem;
                border-radius: 7px;
            }

            .fullmap-key,
            .fullmap-val {
                font-size: 0.62rem;
                line-height: 1.3;
            }

            .fullmap-note {
                font-size: 0.66rem;
                margin-top: 0.3rem;
            }

            .logic-seq-block {
                padding: 0.5rem;
            }

            .logic-step {
                padding: 0.3rem 0.34rem;
            }

            .logic-step h5,
            .logic-step p {
                font-size: 0.62rem;
            }

            .diagram-svg {
                min-width: 700px;
            }

            .tooltip-content,
            .term-tooltip-panel {
                width: min(280px, calc(100vw - 16px));
            }

            .chart-svg {
                min-width: 360px;
            }

            .sankey-svg {
                min-width: 560px;
            }

            .sankey-drill-svg {
                min-width: 520px;
            }

            .cookie-banner {
                flex-direction: column;
                text-align: center;
                gap: 0.55rem;
            }
        }
    </style>
</head>
<body class="locked">
    <div class="page-background" aria-hidden="true"></div>

    <nav class="navbar">
        <div class="nav-container">
            <a href="datacenter-solutions.html" class="nav-brand">
                <span class="brand-icon"><i class="fas fa-microchip"></i></span>
                <span>
                    <span class="brand-title">LTC System Modelling Lab</span>
                    <span class="brand-subtitle">Comprehensive Input-Process-Output Simulation</span>
                </span>
            </a>

            <div class="nav-links">
                <a href="datacenter-solutions.html" class="nav-back"><i class="fas fa-arrow-left"></i> DC Solutions</a>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme" title="Toggle dark/light mode">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="main-content" id="main-content">
        <section class="hero">
            <span class="hero-badge"><i class="fas fa-lock"></i> Root Only Module</span>
            <h1>Liquid-to-Chip System Modelling Laboratory</h1>
            <p>
                This page is dedicated to ultra-comprehensive modelling simulation: complete parameter traceability from all inputs,
                processing logic blocks, solver internals, control loops, calibration fitting, and final engineering outputs.
            </p>

            <div class="hero-kpis">
                <div class="hero-kpi">
                    <div class="kpi-label">Model Coverage</div>
                    <div class="kpi-value">Input-Process-Output</div>
                </div>
                <div class="hero-kpi">
                    <div class="kpi-label">Solver Scope</div>
                    <div class="kpi-value">Thermal + Hydraulic + Control</div>
                </div>
                <div class="hero-kpi">
                    <div class="kpi-label">Calibration</div>
                    <div class="kpi-value">Telemetry Fit Enabled</div>
                </div>
                <div class="hero-kpi">
                    <div class="kpi-label">Access Level</div>
                    <div class="kpi-value">Root</div>
                </div>
            </div>
        </section>

        <section class="legal-disclaimer-wrap" aria-label="Legal Disclaimer">
            <div class="legal-disclaimer">
                <p class="legal-disclaimer-title"><span aria-hidden="true">&#9888;</span> Legal Notice</p>
                <p>All dashboards, calculators, and technical materials are independent personal research based on public standards and references. They do not represent any current or former employer.</p>
                <p>Outputs are for educational and planning context only, not legal, financial, investment, procurement, safety, or engineering advice. Always validate final decisions with licensed professionals and applicable regulations.</p>
                <p>Use of this website is subject to our <a href="terms.html">Terms</a> and <a href="privacy.html">Privacy Policy</a>.</p>
            </div>
        </section>

        <section class="section" id="architecture">
            <div class="section-header">
                <h2>Integrated Engineering Architecture Focus</h2>
                <p>The model treats liquid cooling as one subsystem in a broader standards-driven engineering chain.</p>
            </div>
            <div class="architecture-layout">
                <div class="panel">
                    <h3>Thermal-Hydraulic Engineering Chain</h3>
                    <p>
                        The sizing model follows end-to-end heat transport: chip load capture, coolant transport, pumping duty,
                        CDU losses, and rejection path energy. This prevents underestimating total cooling parasitics.
                    </p>
                    <div class="pipeline">
                        <div class="step">
                            <div class="num">1</div>
                            <h4>Chip Heat</h4>
                            <p>GPU/CPU thermal load</p>
                        </div>
                        <div class="step">
                            <div class="num">2</div>
                            <h4>Cold Plate</h4>
                            <p>Capture ratio tuning</p>
                        </div>
                        <div class="step">
                            <div class="num">3</div>
                            <h4>CDU Loop</h4>
                            <p>Flow, head, pump duty</p>
                        </div>
                        <div class="step">
                            <div class="num">4</div>
                            <h4>Heat Rejection</h4>
                            <p>COP and climate effects</p>
                        </div>
                        <div class="step">
                            <div class="num">5</div>
                            <h4>Compliance</h4>
                            <p>Standards score fusion</p>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>Advanced Modeling Dimensions</h3>
                    <p>Calculator outputs include:</p>
                    <ul class="method-list" style="list-style:none;display:grid;gap:0.35rem;">
                        <li style="font-size:0.8rem;color:var(--text-secondary);">Thermal capture, coolant flow, and pumping power.</li>
                        <li style="font-size:0.8rem;color:var(--text-secondary);">CDU sizing under N, N+1, and 2N configurations.</li>
                        <li style="font-size:0.8rem;color:var(--text-secondary);">Composite PUE, WUE, annual energy, and OPEX.</li>
                        <li style="font-size:0.8rem;color:var(--text-secondary);">Cross-standard alignment score with weighted grading.</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="section" id="calculator">
            <div class="section-header">
                <h2>High-Fidelity Engineering Calculator</h2>
                <p>Use this model for detailed scenario comparison before final validation with licensed engineering teams.</p>
            </div>

            <div class="workspace-toolbar">
                <span class="toolbar-title"><i class="fas fa-sliders"></i> Workspace Controls</span>
                <label class="toolbar-label" for="layoutSplit">Input Width</label>
                <input class="split-range" id="layoutSplit" type="range" min="34" max="58" step="1" value="42">
                <span class="toolbar-pill" id="layoutSplitLabel">42% / 58%</span>
                <button class="btn-secondary btn-chip" id="layoutResetSplit" type="button">Reset Split</button>
                <button class="btn-secondary btn-chip" id="focusDiagramBtn" type="button">Focus Diagram</button>
            </div>

            <div class="calculator-layout">
                <div class="calc-card calc-input-panel calc-panel-scroll">
                    <h3>Design Inputs</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="inItLoad">IT Load (MW)</label>
                            <input id="inItLoad" type="number" min="0.5" step="0.1" value="12">
                        </div>
                        <div class="input-group">
                            <label for="inRackCount">Rack Count</label>
                            <input id="inRackCount" type="number" min="20" step="1" value="360">
                        </div>
                        <div class="input-group">
                            <label for="inRackType">Rack Type Profile</label>
                            <select id="inRackType">
                                <option value="ai_hpc_direct_liquid">AI/HPC Direct Liquid</option>
                                <option value="enterprise_mixed">Enterprise Mixed</option>
                                <option value="immersion_single_phase">Immersion Single-Phase</option>
                                <option value="immersion_two_phase">Immersion Two-Phase</option>
                                <option value="legacy_air_plus_rdhx">Legacy Air + RDHx</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inRackDensityTarget">Target Rack Density (kW/rack)</label>
                            <input id="inRackDensityTarget" type="number" min="5" max="180" step="1" value="35">
                        </div>
                        <div class="input-group">
                            <label for="inHighDensityShare">High-Density Rack Share (%)</label>
                            <input id="inHighDensityShare" type="number" min="0" max="100" step="1" value="45">
                        </div>
                        <div class="input-group">
                            <label for="inModelYear">Model Horizon Year</label>
                            <input id="inModelYear" type="number" min="2026" max="2045" step="1" value="2026">
                        </div>
                        <div class="input-group">
                            <label for="inCountryProfile">Country Profile</label>
                            <select id="inCountryProfile">
                                <option value="custom">Custom Manual</option>
                                <option value="sg">Singapore</option>
                                <option value="us_va">USA - Virginia</option>
                                <option value="nl">Netherlands</option>
                                <option value="id_jkt">Indonesia - Jakarta</option>
                                <option value="in_mum">India - Mumbai</option>
                                <option value="ie">Ireland</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inClimate">Climate Profile</label>
                            <select id="inClimate">
                                <option value="tropical">Tropical</option>
                                <option value="temperate">Temperate</option>
                                <option value="dry">Dry</option>
                                <option value="continental">Continental</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inCoolingArchitecture">Cooling Architecture Preset</label>
                            <select id="inCoolingArchitecture">
                                <option value="direct_liquid">Direct Liquid (Warm-Water LTC)</option>
                                <option value="hybrid">Hybrid Liquid + Air</option>
                                <option value="air_inrow_dahu">Air-Cooling In-Row / DAHU</option>
                                <option value="manual">Manual (No Auto-Adjust)</option>
                            </select>
                            <span class="input-hint" id="coolingArchNote">Direct-liquid preset uses warm-water coolant loop (liquid, not supply-air).</span>
                        </div>
                        <div class="input-group">
                            <label for="inLiquidCapture">Liquid Capture (%)</label>
                            <input id="inLiquidCapture" type="number" min="0" max="100" step="1" value="85">
                        </div>
                        <div class="input-group">
                            <label for="inCoolant">Coolant Type</label>
                            <select id="inCoolant">
                                <option value="water">Water</option>
                                <option value="pg20">20% Propylene Glycol</option>
                                <option value="pg30">30% Propylene Glycol</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inSupplyTemp">Liquid Supply Temp (C)</label>
                            <input id="inSupplyTemp" type="number" step="0.1" value="30">
                        </div>
                        <div class="input-group">
                            <label for="inReturnTemp">Liquid Return Temp (C)</label>
                            <input id="inReturnTemp" type="number" step="0.1" value="38.5">
                        </div>
                        <div class="input-group">
                            <label for="inPumpHead">Pump Head (m)</label>
                            <input id="inPumpHead" type="number" min="5" step="0.5" value="28">
                        </div>
                        <div class="input-group">
                            <label for="inPumpEff">Pump Efficiency (%)</label>
                            <input id="inPumpEff" type="number" min="35" max="95" step="1" value="78">
                        </div>
                        <div class="input-group">
                            <label for="inHydraulicMargin">Hydraulic Margin (%)</label>
                            <input id="inHydraulicMargin" type="number" min="0" max="45" step="1" value="12">
                        </div>
                        <div class="input-group">
                            <label for="inControlQuality">BMS / Control Quality (%)</label>
                            <input id="inControlQuality" type="number" min="0" max="100" step="1" value="86">
                        </div>
                        <div class="input-group">
                            <label for="inPredictiveGain">Predictive Control Effectiveness (%)</label>
                            <input id="inPredictiveGain" type="number" min="0" max="60" step="1" value="12">
                            <span class="input-hint">Represents predictive optimization strength in BMS/DCIM logic (MPC-like), not a physical device.</span>
                        </div>
                        <div class="input-group advanced-param">
                            <label for="inCoefHeatTransfer">Thermal Transfer Effectiveness (%)</label>
                            <input id="inCoefHeatTransfer" type="number" min="60" max="99" step="0.5" value="93">
                        </div>
                        <div class="input-group advanced-param">
                            <label for="inCoefCduLoss">CDU Loss Coefficient (% Heat)</label>
                            <input id="inCoefCduLoss" type="number" min="0.5" max="4.5" step="0.1" value="1.8">
                        </div>
                        <div class="input-group advanced-param">
                            <label for="inCoefPipeLoss">Pipe Loss Multiplier</label>
                            <input id="inCoefPipeLoss" type="number" min="0.75" max="1.8" step="0.01" value="1.00">
                        </div>
                        <div class="input-group advanced-param">
                            <label for="inCoefFutureTech">Future Tech Multiplier (%)</label>
                            <input id="inCoefFutureTech" type="number" min="-10" max="45" step="1" value="0">
                        </div>
                        <div class="input-group">
                            <label for="inCduUnit">CDU Unit Capacity (kW)</label>
                            <input id="inCduUnit" type="number" min="300" step="50" value="1200">
                        </div>
                        <div class="input-group">
                            <label for="inRedundancy">Redundancy Topology</label>
                            <select id="inRedundancy">
                                <option value="N">N</option>
                                <option value="N1">N+1</option>
                                <option value="2N">2N</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inAirCop">Air Path COP</label>
                            <input id="inAirCop" type="number" min="1.5" step="0.1" value="4.2">
                        </div>
                        <div class="input-group">
                            <label for="inEconomizerHours">Economizer Availability (%)</label>
                            <input id="inEconomizerHours" type="number" min="0" max="95" step="1" value="28">
                        </div>
                        <div class="input-group">
                            <label for="inFanPower">Facility Airflow Fan Power (% IT)</label>
                            <input id="inFanPower" type="number" min="0.5" max="12" step="0.1" value="3.2">
                            <span class="input-hint">Includes CRAH/CRAC, in-row, and DAHU/AHU fan energy on facility side (excluding server internal fans).</span>
                        </div>
                        <div class="input-group">
                            <label for="inUpsEff">UPS Efficiency (%)</label>
                            <input id="inUpsEff" type="number" min="90" max="99.5" step="0.1" value="96.5">
                        </div>
                        <div class="input-group">
                            <label for="inDistLoss">Power Distribution Loss (% Input)</label>
                            <input id="inDistLoss" type="number" min="0.5" max="8" step="0.1" value="2.1">
                        </div>
                        <div class="input-group">
                            <label for="inHeatReuse">Heat Reuse Rate (% Liquid Path)</label>
                            <input id="inHeatReuse" type="number" min="0" max="80" step="1" value="18">
                        </div>
                        <div class="input-group">
                            <label for="inElecPrice">Electricity Price (USD/kWh)</label>
                            <input id="inElecPrice" type="number" min="0.02" step="0.005" value="0.11">
                        </div>
                        <div class="input-group">
                            <label for="inWaterTariff">Water Tariff (USD/m3)</label>
                            <input id="inWaterTariff" type="number" min="0.1" step="0.1" value="1.6">
                        </div>
                        <div class="input-group">
                            <label for="inCarbonIntensity">Grid Carbon Intensity (kgCO2e/kWh)</label>
                            <input id="inCarbonIntensity" type="number" min="0.05" max="1.1" step="0.01" value="0.42">
                        </div>
                        <div class="input-group">
                            <label for="inMonitoring">Monitoring Coverage (%)</label>
                            <input id="inMonitoring" type="number" min="0" max="100" step="1" value="92">
                        </div>
                        <div class="input-group">
                            <label for="inFireType">Fire Suppression Strategy</label>
                            <select id="inFireType">
                                <option value="clean_agent">Clean Agent</option>
                                <option value="water_mist">Water Mist</option>
                                <option value="double_interlock">Double-Interlock Pre-Action</option>
                                <option value="dry_pipe">Dry Pipe</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inTargetPue">Target PUE</label>
                            <input id="inTargetPue" type="number" min="1.05" step="0.01" value="1.20">
                        </div>
                        <div class="input-group">
                            <label for="inTargetCop">Target System COP</label>
                            <input id="inTargetCop" type="number" min="3" step="0.1" value="8.2">
                        </div>
                    </div>

                    <label class="check-wrap" for="inConcurrent">
                        <input id="inConcurrent" type="checkbox" checked>
                        Concurrent maintainability verified.
                    </label>

                    <div class="form-actions">
                        <button class="btn-primary" id="runCalc" type="button">Run High-Fidelity Model</button>
                        <button class="btn-accent" id="optimizeTarget" type="button">Optimize To Target</button>
                        <button class="btn-secondary" id="resetCalc" type="button">Reset</button>
                    </div>

                    <div class="autorun-row">
                        <label class="check-wrap" for="autoRunToggle">
                            <input id="autoRunToggle" type="checkbox" checked>
                            Auto-Run while editing
                        </label>
                        <span class="autorun-state" id="autoRunState">Auto-Run ON (220ms)</span>
                    </div>

                    <div class="mode-row">
                        <label class="check-wrap" for="advancedInputToggle">
                            <input id="advancedInputToggle" type="checkbox">
                            Show advanced lab coefficients
                        </label>
                        <span class="mode-state off" id="inputModeState">Operational Mode</span>
                    </div>
                    <p class="input-hint input-mode-note" id="inputModeNote">Operational mode hides lab-only coefficient tuning and keeps field-operational parameters visible.</p>

                    <div class="input-quality-block">
                        <div class="input-quality-head">
                            <h4>Input Quality Guardrails</h4>
                            <span class="status-pill" id="inputQualityStatus">Awaiting Model Run</span>
                        </div>
                        <ul class="quality-list" id="inputQualityList">
                            <li>Run model to evaluate assumption quality and operational realism checks.</li>
                        </ul>
                    </div>

                    <div class="calibration-block">
                        <div class="calibration-head">
                            <h4>Calibration Mode (Telemetry Fit)</h4>
                            <span class="calibration-status" id="calStatus">Not Calibrated</span>
                        </div>
                        <p class="calibration-note">Input measured telemetry to calibrate model coefficients. Minimum 2 measured KPI targets required.</p>
                        <div class="cal-grid">
                            <div class="input-group">
                                <label for="calTargetPue">Measured PUE</label>
                                <input id="calTargetPue" type="number" min="1.01" step="0.001" placeholder="e.g. 1.28">
                            </div>
                            <div class="input-group">
                                <label for="calTargetCop">Measured System COP</label>
                                <input id="calTargetCop" type="number" min="1.2" step="0.01" placeholder="e.g. 7.6">
                            </div>
                            <div class="input-group">
                                <label for="calTargetEnergy">Measured Annual Energy (GWh)</label>
                                <input id="calTargetEnergy" type="number" min="0.1" step="0.01" placeholder="e.g. 142.4">
                            </div>
                            <div class="input-group">
                                <label for="calTargetNetOpex">Measured Net OPEX (USD/year)</label>
                                <input id="calTargetNetOpex" type="number" min="1000" step="1000" placeholder="e.g. 14500000">
                            </div>
                            <div class="input-group">
                                <label for="calTargetCarbon">Measured Carbon (tCO2e/year)</label>
                                <input id="calTargetCarbon" type="number" min="1" step="1" placeholder="e.g. 42000">
                            </div>
                            <div class="input-group">
                                <label for="calTargetPump">Measured Pump Power (kW)</label>
                                <input id="calTargetPump" type="number" min="1" step="0.1" placeholder="e.g. 188">
                            </div>
                        </div>
                        <div class="telemetry-import">
                            <div class="telemetry-import-head">
                                <h5>Telemetry CSV Import</h5>
                                <span class="status-pill" id="telemetryImportStatusPill">Idle</span>
                            </div>
                            <p class="telemetry-import-note">Auto-map CSV columns to calibration KPIs (`pue`, `cop`, `annual_energy_gwh`, `net_opex`, `carbon`, `pump_kw`) and optional operational inputs.</p>
                            <div class="telemetry-import-grid">
                                <div class="field">
                                    <label for="telemetryFile">CSV File</label>
                                    <input id="telemetryFile" type="file" accept=".csv,text/csv">
                                </div>
                                <div class="field">
                                    <label for="telemetryApplyInputs">Apply Matching Operational Fields</label>
                                    <label class="check-wrap tight" for="telemetryApplyInputs">
                                        <input id="telemetryApplyInputs" type="checkbox">
                                        Apply mapped operational columns (for example `liquid_capture`, `pump_eff`, `fan_power`, `monitoring`) to input form.
                                    </label>
                                </div>
                                <div class="field" style="grid-column:1 / -1;">
                                    <label for="telemetryPaste">CSV Paste (Optional)</label>
                                    <textarea id="telemetryPaste" class="telemetry-paste" placeholder="timestamp,pue,cop,annual_energy_gwh,net_opex,carbon,pump_kw"></textarea>
                                </div>
                                <div class="field">
                                    <label for="telemetryAggMode">Aggregation Mode</label>
                                    <select id="telemetryAggMode">
                                        <option value="mean">Average (Mean)</option>
                                        <option value="p50">P50 (Median)</option>
                                        <option value="p90">P90</option>
                                        <option value="latest">Latest Row</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="telemetryWindowRows">Window Rows (0 = all)</label>
                                    <input id="telemetryWindowRows" type="number" min="0" step="1" value="0">
                                </div>
                            </div>
                            <div class="telemetry-import-actions">
                                <button class="btn-secondary" id="detectTelemetryCols" type="button">Detect Columns</button>
                                <button class="btn-secondary" id="applyTelemetryCsv" type="button">Parse + Apply Telemetry</button>
                                <button class="btn-secondary" id="loadTelemetryTemplate" type="button">Load CSV Template</button>
                            </div>
                            <div class="telemetry-map-grid">
                                <div class="field"><label for="mapColPue">Map PUE</label><select id="mapColPue"><option value="__auto__">Auto Detect</option></select></div>
                                <div class="field"><label for="mapColCop">Map COP</label><select id="mapColCop"><option value="__auto__">Auto Detect</option></select></div>
                                <div class="field"><label for="mapColEnergy">Map Annual Energy</label><select id="mapColEnergy"><option value="__auto__">Auto Detect</option></select></div>
                                <div class="field"><label for="mapColOpex">Map Net OPEX</label><select id="mapColOpex"><option value="__auto__">Auto Detect</option></select></div>
                                <div class="field"><label for="mapColCarbon">Map Carbon</label><select id="mapColCarbon"><option value="__auto__">Auto Detect</option></select></div>
                                <div class="field"><label for="mapColPump">Map Pump Power</label><select id="mapColPump"><option value="__auto__">Auto Detect</option></select></div>
                                <div class="field"><label for="mapColLiquidCapture">Map Liquid Capture</label><select id="mapColLiquidCapture"><option value="__auto__">Auto Detect</option></select></div>
                                <div class="field"><label for="mapColPumpEff">Map Pump Eff</label><select id="mapColPumpEff"><option value="__auto__">Auto Detect</option></select></div>
                                <div class="field"><label for="mapColFanPower">Map Fan Power</label><select id="mapColFanPower"><option value="__auto__">Auto Detect</option></select></div>
                                <div class="field"><label for="mapColMonitoring">Map Monitoring</label><select id="mapColMonitoring"><option value="__auto__">Auto Detect</option></select></div>
                            </div>
                            <div class="telemetry-import-meta" id="telemetryImportMeta">Column mapping not detected yet. Click "Detect Columns" to preview and override mapping.</div>
                            <div class="telemetry-import-status" id="telemetryImportStatus">Telemetry import idle. Provide CSV via file or paste area, then run parse.</div>
                        </div>
                        <label class="check-wrap" for="calLockApply">
                            <input id="calLockApply" type="checkbox" checked>
                            Apply calibrated coefficients to active model inputs.
                        </label>
                        <div class="form-actions calibration-actions">
                            <button class="btn-accent" id="runCalibration" type="button">Run Calibration Fit</button>
                            <button class="btn-secondary" id="clearCalibration" type="button">Clear Calibration</button>
                        </div>
                        <p class="calibration-summary" id="calSummary">Calibration idle. Provide telemetry targets and run calibration.</p>
                    </div>

                    <p class="calc-footnote">
                        The model estimates thermodynamic and economic behavior using engineering assumptions for early-stage design screening. Note: "Liquid Supply/Return Temp" are coolant loop values, different from supply-air setpoint in DAHU/in-row systems.
                    </p>
                </div>

                <div class="calc-card calc-output-panel calc-panel-scroll">
                    <h3>Engineering Output</h3>
                    <div class="output-quickbar">
                        <div class="quickbar-head">
                            <h4>Quick KPI Snapshot</h4>
                            <span class="status-pill" id="quickConstraintState">Constraint Check Pending</span>
                        </div>
                        <div class="quick-kpi-grid">
                            <div class="quick-kpi"><span class="k">PUE</span><span class="v" id="quickPue">-</span></div>
                            <div class="quick-kpi"><span class="k">System COP</span><span class="v" id="quickCop">-</span></div>
                            <div class="quick-kpi"><span class="k">Net OPEX</span><span class="v" id="quickOpex">-</span></div>
                            <div class="quick-kpi"><span class="k">Risk Index</span><span class="v" id="quickRisk">-</span></div>
                        </div>
                    </div>
                    <div class="result-grid">
                        <div class="result-card"><span class="label">Country Profile</span><span class="value" id="outCountry">-</span></div>
                        <div class="result-card"><span class="label">Liquid Heat Captured</span><span class="value" id="outLiquidLoad">-</span></div>
                        <div class="result-card"><span class="label">Residual Air Heat</span><span class="value" id="outAirLoad">-</span></div>
                        <div class="result-card"><span class="label">Coolant Flow (Design)</span><span class="value" id="outFlow">-</span></div>
                        <div class="result-card"><span class="label">Pump Power</span><span class="value" id="outPump">-</span></div>
                        <div class="result-card"><span class="label">CDU Count</span><span class="value" id="outCdu">-</span></div>
                        <div class="result-card"><span class="label">Projected PUE</span><span class="value" id="outPue">-</span></div>
                        <div class="result-card"><span class="label">Projected System COP</span><span class="value" id="outCop">-</span></div>
                        <div class="result-card"><span class="label">Projected WUE</span><span class="value" id="outWue">-</span></div>
                        <div class="result-card"><span class="label">Annual Energy</span><span class="value" id="outEnergy">-</span></div>
                        <div class="result-card"><span class="label">Gross Annual OPEX</span><span class="value" id="outOpex">-</span></div>
                        <div class="result-card"><span class="label">Heat-Reuse Credit</span><span class="value" id="outHeatCredit">-</span></div>
                        <div class="result-card"><span class="label">Net Annual OPEX</span><span class="value" id="outNetOpex">-</span></div>
                        <div class="result-card"><span class="label">Annual Carbon</span><span class="value" id="outCarbon">-</span></div>
                        <div class="result-card"><span class="label">Carbon Avoided</span><span class="value" id="outCarbonAvoided">-</span></div>
                        <div class="result-card"><span class="label">Rack Type Profile</span><span class="value" id="outRackType">-</span></div>
                        <div class="result-card"><span class="label">Design Density</span><span class="value" id="outDesignDensity">-</span></div>
                        <div class="result-card"><span class="label">Control Logic Index</span><span class="value" id="outControlIndex">-</span></div>
                        <div class="result-card"><span class="label">Future Factor</span><span class="value" id="outFutureFactor">-</span></div>
                        <div class="result-card"><span class="label">Rack Density</span><span class="value" id="outRackDensity">-</span></div>
                        <div class="result-card"><span class="label">Risk Index</span><span class="value" id="outRisk">-</span></div>
                        <div class="result-card"><span class="label">Data Confidence</span><span class="value" id="outConfidence">-</span></div>
                        <div class="result-card"><span class="label">Calibration Fit</span><span class="value" id="outCalFit">-</span></div>
                    </div>

                    <div class="model-block">
                        <div class="model-head">
                            <h4><i class="fas fa-diagram-project"></i> Advanced Modelling Block Diagram</h4>
                            <p>Input profiles flow through thermal-hydraulic engine and produce quantified impact to efficiency, cost, and compliance.</p>
                        </div>
                        <div class="diagram-canvas" role="img" aria-label="End-to-end modelling block diagram showing input validation, thermal and hydraulic solver, control gates, cost, and compliance layers">
                            <svg class="diagram-svg" viewBox="0 0 1120 350" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <defs>
                                    <marker id="diagArrow" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
                                        <path d="M0,0 L10,4 L0,8 Z" fill="#64748b"></path>
                                    </marker>
                                </defs>

                                <path class="diag-line" d="M220 85 L300 85"></path>
                                <path class="diag-line" d="M500 85 L580 85"></path>
                                <path class="diag-line" d="M780 85 L860 85"></path>
                                <path class="diag-line" d="M690 145 L690 220"></path>
                                <path class="diag-line" d="M970 145 L970 220"></path>
                                <path class="diag-line" d="M780 265 L860 265"></path>
                                <path class="diag-line" d="M400 145 L400 220"></path>
                                <path class="diag-line" d="M500 275 L580 275"></path>
                                <path class="diag-line" d="M860 305 L500 305"></path>
                                <rect class="diag-gate-note-bg" x="220" y="14" rx="6" ry="6" width="152" height="20"></rect>
                                <text class="diag-caption" x="232" y="28" data-term-key="conEnforce" data-term-layer="processing">Validation + Bounds</text>
                                <rect class="diag-gate-note-bg" x="488" y="14" rx="6" ry="6" width="124" height="20"></rect>
                                <text class="diag-caption" x="500" y="28" data-term-key="deltaT" data-term-layer="processing">Thermal Solver</text>
                                <rect class="diag-gate-note-bg" x="760" y="14" rx="6" ry="6" width="150" height="20"></rect>
                                <text class="diag-caption" x="772" y="28" data-term-key="flowLpm" data-term-layer="processing">Hydraulic + Energy</text>
                                <rect class="diag-gate-note-bg" x="492" y="186" rx="6" ry="6" width="204" height="20"></rect>
                                <text class="diag-caption" x="504" y="200" data-term-key="calibrationFit" data-term-layer="processing">Calibration + Optimization Loop</text>

                                <rect class="diag-box diag-box-input" x="20" y="35" rx="12" ry="12" width="200" height="110" data-block-popup="input"></rect>
                                <text class="diag-title" x="35" y="60" data-term-key="itLoadMw" data-term-layer="processing" data-block-popup="input">Input Profile</text>
                                <text class="diag-value" x="35" y="84" id="diagInputMain" data-block-popup="input">-</text>
                                <text class="diag-value" x="35" y="104" id="diagInputSub" data-block-popup="input">-</text>

                                <rect class="diag-box diag-box-thermal" x="300" y="35" rx="12" ry="12" width="200" height="110" data-block-popup="thermal"></rect>
                                <text class="diag-title" x="315" y="60" data-term-key="effectiveCapture" data-term-layer="processing" data-block-popup="thermal">Thermal Layer</text>
                                <text class="diag-value" x="315" y="84" id="diagThermalMain" data-block-popup="thermal">-</text>
                                <text class="diag-value" x="315" y="104" id="diagThermalSub" data-block-popup="thermal">-</text>

                                <rect class="diag-box diag-box-hydraulic" x="580" y="35" rx="12" ry="12" width="200" height="110" data-block-popup="hydraulic"></rect>
                                <text class="diag-title" x="595" y="60" data-term-key="flowLpm" data-term-layer="processing" data-block-popup="hydraulic">Hydraulic Layer</text>
                                <text class="diag-value" x="595" y="84" id="diagHydraulicMain" data-block-popup="hydraulic">-</text>
                                <text class="diag-value" x="595" y="104" id="diagHydraulicSub" data-block-popup="hydraulic">-</text>

                                <rect class="diag-box diag-box-impact" x="860" y="35" rx="12" ry="12" width="240" height="110" data-block-popup="impact"></rect>
                                <text class="diag-title" x="875" y="60" data-term-key="pue" data-term-layer="processing" data-block-popup="impact">Impact Layer</text>
                                <text class="diag-value" x="875" y="84" id="diagImpactMain" data-block-popup="impact">-</text>
                                <text class="diag-value" x="875" y="104" id="diagImpactSub" data-block-popup="impact">-</text>

                                <rect class="diag-box diag-box-cost" x="580" y="220" rx="12" ry="12" width="200" height="110" data-block-popup="cost"></rect>
                                <text class="diag-title" x="595" y="245" data-term-key="netOpex" data-term-layer="processing" data-block-popup="cost">Cost + Carbon</text>
                                <text class="diag-value" x="595" y="269" id="diagCostMain" data-block-popup="cost">-</text>
                                <text class="diag-value" x="595" y="289" id="diagCostSub" data-block-popup="cost">-</text>

                                <rect class="diag-box diag-box-control" x="300" y="220" rx="12" ry="12" width="200" height="110" data-block-popup="control"></rect>
                                <text class="diag-title" x="315" y="245" data-term-key="controlIndex" data-term-layer="processing" data-block-popup="control">Constraint + Control</text>
                                <text class="diag-value" x="315" y="269" id="diagControlMain" data-block-popup="control">-</text>
                                <text class="diag-value" x="315" y="289" id="diagControlSub" data-block-popup="control">-</text>

                                <rect class="diag-box diag-box-compliance" x="860" y="220" rx="12" ry="12" width="240" height="110" data-block-popup="compliance"></rect>
                                <text class="diag-title" x="875" y="245" data-term-key="scores.total" data-term-layer="processing" data-block-popup="compliance">Compliance + Risk</text>
                                <text class="diag-value" x="875" y="269" id="diagComplianceMain" data-block-popup="compliance">-</text>
                                <text class="diag-value" x="875" y="289" id="diagComplianceSub" data-block-popup="compliance">-</text>
                            </svg>
                        </div>
                        <div class="model-track">
                            <div class="model-node">
                                <span class="tag">Input Profile</span>
                                <span class="val" id="modelInputNode">-</span>
                            </div>
                            <div class="model-arrow">&#8594;</div>
                            <div class="model-node">
                                <span class="tag">Thermal Engine</span>
                                <span class="val" id="modelEngineNode">-</span>
                            </div>
                            <div class="model-arrow">&#8594;</div>
                            <div class="model-node">
                                <span class="tag">Constraint + Control</span>
                                <span class="val" id="modelControlNode">-</span>
                            </div>
                            <div class="model-arrow">&#8594;</div>
                            <div class="model-node">
                                <span class="tag">Impact Layer</span>
                                <span class="val" id="modelImpactNode">-</span>
                            </div>
                        </div>
                        <div class="model-impact-grid">
                            <div class="model-impact">
                                <span class="k">PUE Gap to Target</span>
                                <span class="v" id="impactPueGap">-</span>
                            </div>
                            <div class="model-impact">
                                <span class="k">COP Gap to Target</span>
                                <span class="v" id="impactCopGap">-</span>
                            </div>
                            <div class="model-impact">
                                <span class="k">OPEX Delta vs Target Mode</span>
                                <span class="v" id="impactOpexDelta">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="control-block">
                        <div class="model-head">
                            <h4><i class="fas fa-arrows-spin"></i> Control/Logic Feedback Diagram</h4>
                            <p>Shows how sensor confidence, controller tuning, and predictive logic affect plant behavior and KPI outcomes in closed loop.</p>
                        </div>
                        <div class="diagram-canvas" role="img" aria-label="Control loop diagram for sensor-controller-actuator-feedback architecture with explicit decision gates">
                            <svg class="diagram-svg" viewBox="0 0 1120 340" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <defs>
                                    <marker id="diagArrowCtrl" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
                                        <path d="M0,0 L10,4 L0,8 Z" fill="#64748b"></path>
                                    </marker>
                                </defs>
                                <path class="control-loop" marker-end="url(#diagArrowCtrl)" d="M220 85 L320 85"></path>
                                <path class="control-loop" marker-end="url(#diagArrowCtrl)" d="M520 85 L620 85"></path>
                                <path class="control-loop" marker-end="url(#diagArrowCtrl)" d="M820 85 L920 85"></path>
                                <path class="control-loop" marker-end="url(#diagArrowCtrl)" d="M1040 140 L1040 245 L120 245 L120 140"></path>
                                <path class="diag-gate-link" d="M420 145 L420 170"></path>
                                <path class="diag-gate-link" d="M720 145 L720 170"></path>
                                <path class="diag-gate-link" d="M1010 145 L1010 170"></path>

                                <rect class="diag-box diag-box-input" x="20" y="35" rx="12" ry="12" width="200" height="110" data-block-popup="sensor"></rect>
                                <text class="diag-title" x="35" y="60" data-term-key="monitoring" data-term-layer="processing" data-block-popup="sensor">Sensor Layer</text>
                                <text class="diag-value" x="35" y="84" id="ctrlSensorMain" data-block-popup="sensor">-</text>
                                <text class="diag-value" x="35" y="104" id="ctrlSensorSub" data-block-popup="sensor">-</text>

                                <rect class="diag-box diag-box-hydraulic" x="320" y="35" rx="12" ry="12" width="200" height="110" data-block-popup="controller"></rect>
                                <text class="diag-title" x="335" y="60" data-term-key="controlIndex" data-term-layer="processing" data-block-popup="controller">Controller</text>
                                <text class="diag-value" x="335" y="84" id="ctrlControllerMain" data-block-popup="controller">-</text>
                                <text class="diag-value" x="335" y="104" id="ctrlControllerSub" data-block-popup="controller">-</text>

                                <rect class="diag-box diag-box-thermal" x="620" y="35" rx="12" ry="12" width="200" height="110" data-block-popup="actuator"></rect>
                                <text class="diag-title" x="635" y="60" data-term-key="supplyTemp" data-term-layer="processing" data-block-popup="actuator">Actuator Setpoint</text>
                                <text class="diag-value" x="635" y="84" id="ctrlActuatorMain" data-block-popup="actuator">-</text>
                                <text class="diag-value" x="635" y="104" id="ctrlActuatorSub" data-block-popup="actuator">-</text>

                                <rect class="diag-box diag-box-impact" x="920" y="35" rx="12" ry="12" width="180" height="110" data-block-popup="plant"></rect>
                                <text class="diag-title" x="935" y="60" data-term-key="pue" data-term-layer="processing" data-block-popup="plant">Plant + KPI</text>
                                <text class="diag-value" x="935" y="84" id="ctrlPlantMain" data-block-popup="plant">-</text>
                                <text class="diag-value" x="935" y="104" id="ctrlPlantSub" data-block-popup="plant">-</text>

                                <polygon id="ctrlGateAPoly" class="diag-gate-shape" points="420,170 445,190 420,210 395,190" data-block-popup="gate1"></polygon>
                                <text class="diag-title" x="404" y="193" style="font-size:11px;" id="ctrlGateAMain" data-block-popup="gate1">G1</text>
                                <rect class="diag-gate-note-bg" x="336" y="257" rx="6" ry="6" width="170" height="20"></rect>
                                <text class="diag-gate-note" x="346" y="271" id="ctrlGateASub" data-block-popup="gate1">-</text>

                                <polygon id="ctrlGateBPoly" class="diag-gate-shape" points="720,170 745,190 720,210 695,190" data-block-popup="gate2"></polygon>
                                <text class="diag-title" x="704" y="193" style="font-size:11px;" id="ctrlGateBMain" data-block-popup="gate2">G2</text>
                                <rect class="diag-gate-note-bg" x="636" y="257" rx="6" ry="6" width="170" height="20"></rect>
                                <text class="diag-gate-note" x="646" y="271" id="ctrlGateBSub" data-block-popup="gate2">-</text>

                                <polygon id="ctrlGateCPoly" class="diag-gate-shape" points="1010,170 1035,190 1010,210 985,190" data-block-popup="gate3"></polygon>
                                <text class="diag-title" x="994" y="193" style="font-size:11px;" id="ctrlGateCMain" data-block-popup="gate3">G3</text>
                                <rect class="diag-gate-note-bg" x="930" y="257" rx="6" ry="6" width="170" height="20"></rect>
                                <text class="diag-gate-note" x="940" y="271" id="ctrlGateCSub" data-block-popup="gate3">-</text>
                            </svg>
                        </div>
                    </div>

                    <div class="block-detail-modal" id="blockDetailModal" aria-hidden="true">
                        <div class="block-detail-backdrop" data-block-modal-close></div>
                        <section class="block-detail-card" role="dialog" aria-modal="true" aria-labelledby="blockDetailTitle">
                            <header class="block-detail-head">
                                <div>
                                    <h4 id="blockDetailTitle">Block Deep Dive</h4>
                                    <p id="blockDetailMeta">Click any box in block diagram to inspect process internals.</p>
                                </div>
                                <div class="block-detail-head-actions">
                                    <span class="status-pill" id="blockDetailBadge">Ready</span>
                                    <button class="btn-secondary btn-chip" type="button" id="blockDetailClose" data-block-modal-close>Close</button>
                                </div>
                            </header>
                            <div class="block-detail-body" id="blockDetailBody"></div>
                            <footer class="block-detail-foot">
                                <button class="btn-secondary btn-chip" type="button" id="blockDetailOpenExplorer">Open In Explorer</button>
                                <button class="btn-secondary btn-chip" type="button" id="blockDetailApplySuggestion">Apply Suggested Fix</button>
                            </footer>
                        </section>
                    </div>

                    <div class="feature-block explorer-block" id="modellingExplorer">
                        <div class="feature-head">
                            <h4>Expandable Block Explorer</h4>
                            <span class="status-pill" id="explorerStatus">Explorer Idle</span>
                            <p>Progressive-disclosure workspace for per-block process transparency, dependency tracing, diagnostics, QA checks, and export/share controls.</p>
                        </div>
                        <div class="explorer-controls">
                            <button class="btn-secondary" id="explorerExpandAll" type="button">Expand All</button>
                            <button class="btn-secondary" id="explorerCollapseAll" type="button">Collapse All</button>
                            <button class="btn-secondary" id="explorerToggleMode" type="button">Mode: Single Open</button>
                            <button class="btn-secondary" id="explorerFocusToggle" type="button">Focus Explorer</button>
                            <button class="btn-secondary" id="explorerCopyLink" type="button">Copy Deep Link</button>
                            <button class="btn-secondary" id="explorerExportJson" type="button">Export Block JSON</button>
                            <button class="btn-secondary" id="explorerExportReport" type="button">Export Block Report</button>
                            <button class="btn-secondary" id="explorerRunDiag" type="button">Run UI Diagnostics</button>
                        </div>
                        <div class="explorer-controls">
                            <div class="field">
                                <label for="explorerCompareLeft">Compare Block A</label>
                                <select id="explorerCompareLeft"></select>
                            </div>
                            <div class="field">
                                <label for="explorerCompareRight">Compare Block B</label>
                                <select id="explorerCompareRight"></select>
                            </div>
                            <button class="btn-secondary" id="explorerSwapCompare" type="button">Swap Compare</button>
                        </div>
                        <div class="explorer-meta" id="explorerMeta">Run model to initialize explorer analytics.</div>
                        <div class="explorer-accordion" id="explorerAccordion">
                            <div class="exp-skeleton" aria-hidden="true"></div>
                        </div>
                        <div class="exp-compare" id="explorerCompare">
                            <div class="exp-compare-grid">
                                <article class="exp-compare-card">
                                    <h5 id="explorerCompareTitleA">Block A</h5>
                                    <div class="exp-pre" id="explorerCompareBodyA">Run model to compare block perspectives.</div>
                                </article>
                                <article class="exp-compare-card">
                                    <h5 id="explorerCompareTitleB">Block B</h5>
                                    <div class="exp-pre" id="explorerCompareBodyB">Run model to compare block perspectives.</div>
                                </article>
                            </div>
                        </div>
                        <div class="exp-diag" id="explorerDiag">Diagnostics pending. Click "Run UI Diagnostics" after a model run.</div>
                    </div>

                    <div class="logic-seq-block">
                        <div class="model-head">
                            <h4><i class="fas fa-shuffle"></i> Execution Flow: Input -> Processing -> Control -> Output -> Re-Processing</h4>
                            <p>This chain is the canonical execution order used by the model engine on every run.</p>
                        </div>
                        <div class="logic-seq">
                            <article class="logic-step">
                                <h5><span class="n">1</span>Input Vector</h5>
                                <p id="seqInput">-</p>
                            </article>
                            <article class="logic-step">
                                <h5><span class="n">2</span>Processing Algorithm</h5>
                                <p id="seqProcessing">-</p>
                            </article>
                            <article class="logic-step">
                                <h5><span class="n">3</span>Control Logic Gates</h5>
                                <p id="seqControl">-</p>
                            </article>
                            <article class="logic-step">
                                <h5><span class="n">4</span>Output Vector</h5>
                                <p id="seqOutput">-</p>
                            </article>
                            <article class="logic-step">
                                <h5><span class="n">5</span>Feedback Processing</h5>
                                <p id="seqFeedback">-</p>
                            </article>
                        </div>
                    </div>

                    <div class="pipeline-block">
                        <div class="pipeline-head">
                            <h4><i class="fas fa-network-wired"></i> Complete Variable Processing Flow</h4>
                            <p>Full chain from all input variables, derived/control processing, solver internals, and final outputs.</p>
                        </div>
                        <div class="pipeline-grid">
                            <article class="pipeline-stage">
                                <h5>Stage 1 - Input Vector (<span id="stageInputCount">0</span>)</h5>
                                <div class="stage-lines" id="stageInputLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 2 - Derived Core</h5>
                                <div class="stage-lines" id="stageDerivedLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 3 - Control Logic</h5>
                                <div class="stage-lines" id="stageControlLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 4 - Thermal/Hydraulic Solver</h5>
                                <div class="stage-lines" id="stageSolverLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 5 - Energy/Economic</h5>
                                <div class="stage-lines" id="stageEconomicLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 6 - Output Vector (<span id="stageOutputCount">0</span>)</h5>
                                <div class="stage-lines" id="stageOutputLines"></div>
                            </article>
                        </div>
                    </div>

                    <div class="fullmap-block">
                        <div class="pipeline-head">
                            <h4><i class="fas fa-diagram-project"></i> Complete Input-Processing-Output Block Map</h4>
                            <p>Every active variable is rendered as a live node. Hover each parameter for technical meaning, benchmark, and formula context.</p>
                        </div>
                        <div class="fullmap-grid">
                            <article class="fullmap-col">
                                <h5>Input Nodes (<span id="mapInputCount">0</span>)</h5>
                                <div class="fullmap-nodes" id="mapInputNodes"></div>
                            </article>
                            <article class="fullmap-col">
                                <h5>Processing Nodes (<span id="mapProcessCount">0</span>)</h5>
                                <div class="fullmap-nodes" id="mapProcessNodes"></div>
                            </article>
                            <article class="fullmap-col">
                                <h5>Output Nodes (<span id="mapOutputCount">0</span>)</h5>
                                <div class="fullmap-nodes" id="mapOutputNodes"></div>
                            </article>
                        </div>
                        <p class="fullmap-note">Block map updates on every model run, optimization run, and calibration run. Text wrapping is forced to avoid overflow for long variables.</p>
                    </div>

                    <div class="flow-block">
                        <div class="flow-head">
                            <h4><i class="fas fa-sitemap"></i> Dynamic Energy + Loss Breakdown</h4>
                            <p>Live share of major loads from IT input to final facility demand.</p>
                        </div>
                        <div class="flow-row">
                            <span>IT Core Load</span>
                            <div class="flow-bar"><i id="barFlowIt"></i></div>
                            <span id="flowIt">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Liquid Cooling</span>
                            <div class="flow-bar"><i id="barFlowLiquid"></i></div>
                            <span id="flowLiquid">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Air Path Cooling</span>
                            <div class="flow-bar"><i id="barFlowAir"></i></div>
                            <span id="flowAir">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Pump + Hydraulics</span>
                            <div class="flow-bar"><i id="barFlowPump"></i></div>
                            <span id="flowPump">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Electrical Losses</span>
                            <div class="flow-bar"><i id="barFlowElecLoss"></i></div>
                            <span id="flowElecLoss">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Other Aux + Fan</span>
                            <div class="flow-bar"><i id="barFlowAux"></i></div>
                            <span id="flowAux">-</span>
                        </div>
                    </div>

                    <div class="target-block">
                        <div class="target-head">
                            <h4>Target Guidance Engine</h4>
                            <span class="target-badge" id="targetGapBadge">Gap: -</span>
                        </div>
                        <ul class="target-list" id="targetActions">
                            <li>Run model to generate optimization actions.</li>
                        </ul>
                        <div class="scenario-table-wrap">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Scenario</th>
                                        <th>PUE</th>
                                        <th>System COP</th>
                                        <th>Annual OPEX</th>
                                        <th>Annual Carbon</th>
                                        <th>WUE</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Baseline</td>
                                        <td id="basePue">-</td>
                                        <td id="baseCop">-</td>
                                        <td id="baseNetOpex">-</td>
                                        <td id="baseCarbon">-</td>
                                        <td id="baseWue">-</td>
                                    </tr>
                                    <tr>
                                        <td>Optimized</td>
                                        <td id="optPue">-</td>
                                        <td id="optCop">-</td>
                                        <td id="optNetOpex">-</td>
                                        <td id="optCarbon">-</td>
                                        <td id="optWue">-</td>
                                    </tr>
                                    <tr>
                                        <td>Delta</td>
                                        <td id="deltaPue">-</td>
                                        <td id="deltaCop">-</td>
                                        <td id="deltaNetOpex">-</td>
                                        <td id="deltaCarbon">-</td>
                                        <td id="deltaWue">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Constraint + Degraded Mode Engine</h4>
                            <span class="status-pill" id="constraintStatus">Constraints Pending</span>
                            <p>Define hard engineering limits and test degraded operating modes. Optimizer can enforce these constraints.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="inFailureMode">Failure / Degraded Mode</label>
                                <select id="inFailureMode">
                                    <option value="normal">Normal Operation</option>
                                    <option value="pump_degraded">Pump Degraded</option>
                                    <option value="sensor_degraded">Sensor Degraded</option>
                                    <option value="heatwave">Heatwave Stress</option>
                                    <option value="grid_stress">Grid Stress</option>
                                    <option value="redundancy_degraded">Redundancy Degraded</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="conPueMax">Hard PUE Max</label>
                                <input id="conPueMax" type="number" step="0.001" min="1.01" value="1.250">
                            </div>
                            <div class="field">
                                <label for="conCopMin">Hard COP Min</label>
                                <input id="conCopMin" type="number" step="0.01" min="1.0" value="7.00">
                            </div>
                            <div class="field">
                                <label for="conRiskMax">Hard Risk Max</label>
                                <input id="conRiskMax" type="number" step="0.1" min="1" max="100" value="40">
                            </div>
                            <div class="field">
                                <label for="conPumpPctMax">Hard Pump % of IT Max</label>
                                <input id="conPumpPctMax" type="number" step="0.1" min="0.5" max="20" value="3.0">
                            </div>
                            <div class="field">
                                <label for="conEnforce">Enforce Hard Constraints</label>
                                <select id="conEnforce">
                                    <option value="yes">Yes (Hard)</option>
                                    <option value="no">No (Soft Ranking)</option>
                                </select>
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-secondary" id="applyConstraintBtn" type="button">Apply Constraint Set</button>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Control Logic DSL / Rule Editor</h4>
                            <span class="status-pill" id="ruleStatus">Rule Set: Default</span>
                            <p>Editable gate rules for G1/G2/G3. Variables available: monitoring, controlIndex, deltaT, pumpPowerPctIt, riskIndex, pue, targetPue, cop, targetCop.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="ruleG1">Rule G1 (Sensor Quality Gate)</label>
                                <textarea id="ruleG1">monitoring >= 85 && controlIndex >= 78</textarea>
                            </div>
                            <div class="field">
                                <label for="ruleG2">Rule G2 (Actuator Limit Gate)</label>
                                <textarea id="ruleG2">deltaT >= 7.5 && pumpPowerPctIt <= 3</textarea>
                            </div>
                            <div class="field">
                                <label for="ruleG3">Rule G3 (Risk Guard Gate)</label>
                                <textarea id="ruleG3">riskIndex <= 35 && pue <= targetPue + 0.02</textarea>
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-secondary" id="applyRulesBtn" type="button">Apply Rule Set</button>
                            <button class="btn-secondary" id="resetRulesBtn" type="button">Reset Default Rules</button>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Equation Inspector Panel</h4>
                            <p>Live substituted equations with units and active values from the current simulation state.</p>
                        </div>
                        <div class="equation-list" id="equationList">
                            <div class="equation-line">Run model to populate equations.</div>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Pareto Frontier Explorer (Multi-Objective)</h4>
                            <span class="status-pill" id="paretoStatus">Frontier Not Generated</span>
                            <p>Generate non-dominated trade-offs across PUE, Net OPEX, Carbon, and Risk. Click a row to apply that scenario.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="paretoSamples">Pareto Samples</label>
                                <input id="paretoSamples" type="number" min="200" step="100" value="1400">
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-accent" id="runPareto" type="button">Generate Pareto Frontier</button>
                            <button class="btn-secondary" id="applyParetoBest" type="button">Apply Best Feasible Point</button>
                        </div>
                        <div class="scenario-table-wrap" style="margin-top:0.38rem;">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Point</th>
                                        <th>PUE</th>
                                        <th>COP</th>
                                        <th>Net OPEX</th>
                                        <th>Carbon</th>
                                        <th>Risk</th>
                                    </tr>
                                </thead>
                                <tbody id="paretoRows">
                                    <tr><td colspan="6">Generate Pareto frontier to view non-dominated points.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="chart-panel">
                            <div class="chart-panel-head">
                                <h5>Pareto Scatter (PUE vs Net OPEX)</h5>
                                <span class="status-pill" id="paretoScatterMeta">No Pareto Points</span>
                            </div>
                            <div class="chart-canvas">
                                <svg id="paretoScatterSvg" class="chart-svg" viewBox="0 0 560 260" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Pareto scatter plot for PUE and Net OPEX">
                                    <text x="18" y="26" fill="currentColor" opacity="0.7" font-size="12">Generate Pareto frontier to render scatter chart.</text>
                                </svg>
                            </div>
                        </div>
                        <div class="pareto-insight" id="paretoInsight">
                            <div class="pareto-insight-head">
                                <span class="pareto-insight-title" id="paretoInsightTitle">No Pareto point selected yet.</span>
                                <span class="status-pill" id="paretoInsightFeasibility">N/A</span>
                            </div>
                            <div class="pareto-insight-line" id="paretoInsightMetrics">Generate frontier and click point/row to inspect detailed trade-off metrics.</div>
                            <div class="pareto-insight-line" id="paretoInsightDelta">Delta summary vs baseline will appear here.</div>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Monte Carlo Uncertainty Mode</h4>
                            <span class="status-pill" id="mcStatus">Distribution Not Generated</span>
                            <p>Uncertainty propagation around current assumptions (P10/P50/P90) for KPI robustness checks.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="mcSamples">Simulation Samples</label>
                                <input id="mcSamples" type="number" min="200" step="100" value="1200">
                            </div>
                            <div class="field">
                                <label for="mcUncertainty">Input Uncertainty (%)</label>
                                <input id="mcUncertainty" type="number" min="1" max="30" step="1" value="7">
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-accent" id="runMonteCarlo" type="button">Run Monte Carlo</button>
                        </div>
                        <div class="scenario-table-wrap" style="margin-top:0.38rem;">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>P10</th>
                                        <th>P50</th>
                                        <th>P90</th>
                                    </tr>
                                </thead>
                                <tbody id="mcRows">
                                    <tr><td colspan="4">Run Monte Carlo to generate uncertainty bands.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="chart-panel">
                            <div class="chart-panel-head">
                                <h5>Monte Carlo Distribution Charts</h5>
                                <span class="status-pill" id="mcDistributionMeta">No Distribution Yet</span>
                            </div>
                            <div class="histogram-grid" id="mcDistributionCharts">
                                <div class="hist-placeholder">Run Monte Carlo to render distribution histograms.</div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Facility Distribution Sankey Chart</h4>
                            <span class="status-pill" id="sankeyStatus">Waiting Model State</span>
                            <p>Live flow map of facility power distribution from total input toward compute, thermal branches, electrical loss, and auxiliary load.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="sankeyMode">Sankey View Mode</label>
                                <select id="sankeyMode">
                                    <option value="auto">Auto (Active Model)</option>
                                    <option value="baseline">Baseline Only</option>
                                    <option value="optimized">Optimized Only</option>
                                    <option value="compare">Compare Baseline vs Optimized</option>
                                </select>
                            </div>
                        </div>
                        <div class="sankey-canvas">
                            <svg id="energySankeySvg" class="sankey-svg" viewBox="0 0 860 360" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Sankey chart of facility load distribution">
                                <text x="18" y="28" fill="currentColor" opacity="0.7" font-size="12">Run model to render Sankey distribution.</text>
                            </svg>
                        </div>
                        <div class="note-box" id="sankeySummary">Sankey summary will appear after model execution.</div>
                    </div>

                    <div class="sankey-drill-modal" id="sankeyDrillModal" aria-hidden="true">
                        <div class="sankey-drill-backdrop" data-sankey-modal-close></div>
                        <section class="sankey-drill-card" role="dialog" aria-modal="true" aria-labelledby="sankeyDrillTitle">
                            <header class="sankey-drill-head">
                                <div>
                                    <h4 id="sankeyDrillTitle">Sankey Drill-Down</h4>
                                    <p id="sankeyDrillMeta">Click any Sankey node to inspect deeper distribution and formula contribution.</p>
                                </div>
                                <div class="sankey-drill-actions">
                                    <span class="status-pill" id="sankeyDrillBadge">Ready</span>
                                    <button class="btn-secondary btn-chip" id="sankeyDrillClose" type="button" data-sankey-modal-close>Close</button>
                                </div>
                            </header>
                            <div class="sankey-drill-grid">
                                <div class="sankey-drill-canvas" id="sankeyDrillCanvas">
                                    <svg id="sankeyDrillSvg" class="sankey-drill-svg" viewBox="0 0 840 360" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Detailed Sankey drill-down for selected node">
                                        <text x="18" y="28" fill="currentColor" opacity="0.72" font-size="12">Select Sankey node to render detailed drill-down.</text>
                                    </svg>
                                </div>
                                <div class="sankey-drill-side">
                                    <article class="sankey-drill-panel">
                                        <h5>Parameter Sensitivity -> kW</h5>
                                        <div id="sankeyDrillCorrelation">No parameter sensitivity map yet.</div>
                                    </article>
                                    <article class="sankey-drill-panel">
                                        <h5>Detailed Split</h5>
                                        <div id="sankeyDrillRows">No node selected yet.</div>
                                    </article>
                                    <article class="sankey-drill-panel">
                                        <h5>Formula Trace</h5>
                                        <pre class="sankey-drill-pre" id="sankeyDrillFormula">No formula trace yet.</pre>
                                    </article>
                                    <article class="sankey-drill-panel">
                                        <h5>Engineering Notes</h5>
                                        <ul class="sankey-drill-list" id="sankeyDrillNotes">
                                            <li>Select a node in Sankey to inspect sub-distribution, assumptions, and model-layer interpretation.</li>
                                        </ul>
                                    </article>
                                </div>
                            </div>
                        </section>
                    </div>

                    <div class="mode-help-modal" id="modeHelpModal" aria-hidden="true">
                        <div class="mode-help-backdrop" data-mode-help-close></div>
                        <section class="mode-help-card" role="dialog" aria-modal="true" aria-labelledby="modeHelpTitle">
                            <header class="mode-help-head">
                                <div>
                                    <h4 id="modeHelpTitle">Mode Guide</h4>
                                    <p id="modeHelpMeta">Detailed explanation for this mode, when to use it, and operational impact.</p>
                                </div>
                                <button class="btn-secondary btn-chip" id="modeHelpClose" type="button" data-mode-help-close>Close</button>
                            </header>
                            <div class="mode-help-body">
                                <div id="modeHelpOverview" class="note-box">No mode selected.</div>
                                <div id="modeHelpOptions">No option details.</div>
                                <div>
                                    <h5 style="margin:0 0 0.24rem;font-size:0.73rem;color:#bfdbfe;letter-spacing:0.04em;text-transform:uppercase;">How To Set + Impact</h5>
                                    <ul class="mode-help-list" id="modeHelpTips">
                                        <li>Select any mode field and click Guide.</li>
                                    </ul>
                                </div>
                            </div>
                        </section>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Calibration Quality Layer</h4>
                            <span class="status-pill" id="calQualityStatus">No Calibration Quality Data</span>
                            <p>Residual diagnostics with train/validation split and 95% confidence interval of relative residual error.</p>
                        </div>
                        <div class="note-box" id="calQualitySummary">Calibration quality pending. Run calibration to evaluate fit quality.</div>
                        <div class="scenario-table-wrap" style="margin-top:0.36rem;">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Target</th>
                                        <th>Predicted</th>
                                        <th>Residual %</th>
                                    </tr>
                                </thead>
                                <tbody id="calQualityRows">
                                    <tr><td colspan="4">No residual diagnostics yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Model Self-Test + Regression</h4>
                            <span class="status-pill" id="selfTestStatus">Not Run</span>
                            <p>Deterministic fixture tests to validate KPI behavior, degraded mode responses, and hard-rule blocking after UI/model changes.</p>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-secondary" id="runSelfTest" type="button">Run Model Self-Test</button>
                        </div>
                        <div class="note-box" id="selfTestSummary">Self-test pending. Run self-test to generate pass/fail regression report.</div>
                        <div class="scenario-table-wrap" style="margin-top:0.36rem;">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Test Case</th>
                                        <th>Status</th>
                                        <th>Check</th>
                                        <th>Detail</th>
                                    </tr>
                                </thead>
                                <tbody id="selfTestRows">
                                    <tr><td colspan="4">No self-test execution yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Scenario Manager (Versioned)</h4>
                            <p>Save, load, delete, and compare named scenario snapshots with assumption version metadata.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="scenarioName">Scenario Name</label>
                                <input id="scenarioName" type="text" placeholder="e.g. SG-AI-Heatwave-v2">
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-secondary" id="saveScenarioBtn" type="button">Save Scenario</button>
                            <button class="btn-secondary" id="loadScenarioBtn" type="button">Load Selected</button>
                            <button class="btn-secondary" id="deleteScenarioBtn" type="button">Delete Selected</button>
                        </div>
                        <select class="scenario-list" id="scenarioSelect" size="5"></select>
                        <div class="note-box" id="scenarioDiff">Select two scenarios sequentially to compare deltas.</div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Data Provenance + Assumption Ledger</h4>
                            <p>Parameter source tracking with owner, confidence score, and timestamp for governance/audit context.</p>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-secondary" id="refreshLedger" type="button">Refresh Timestamps</button>
                        </div>
                        <div class="scenario-table-wrap" style="margin-top:0.36rem;">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Parameter</th>
                                        <th>Source</th>
                                        <th>Owner</th>
                                        <th>Confidence</th>
                                        <th>Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody id="ledgerRows">
                                    <tr><td colspan="5">Ledger not loaded.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Executive + Engineering Export Packs</h4>
                            <p>Generate downloadable report packs for board-level communication, engineering deep-dive review, and printable PDF reports (single or compare mode).</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="pdfSingleSource">PDF Single Source</label>
                                <select id="pdfSingleSource">
                                    <option value="live_baseline">Current Baseline Model</option>
                                    <option value="live_optimized">Current Optimized Model</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="pdfCompareLeft">PDF Compare Left</label>
                                <select id="pdfCompareLeft">
                                    <option value="live_baseline">Current Baseline Model</option>
                                    <option value="live_optimized">Current Optimized Model</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="pdfCompareRight">PDF Compare Right</label>
                                <select id="pdfCompareRight">
                                    <option value="live_optimized">Current Optimized Model</option>
                                    <option value="live_baseline">Current Baseline Model</option>
                                </select>
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-accent" id="exportExecutive" type="button">Export Executive Pack</button>
                            <button class="btn-secondary" id="exportEngineering" type="button">Export Engineering Pack</button>
                            <button class="btn-secondary" id="exportPdfSingle" type="button">Export PDF (Single)</button>
                            <button class="btn-secondary" id="exportPdfCompare" type="button">Export PDF (Compare)</button>
                            <span class="status-pill" id="exportStatus">No Export Yet</span>
                        </div>
                        <div class="note-box">PDF export opens a print-ready report in a new tab. Use browser option "Save as PDF" for final file output.</div>
                    </div>

                    <div class="trace-block">
                        <div class="trace-head">
                            <h4>100% Parameter Coverage Matrix</h4>
                            <span class="trace-badge" id="traceSummary">Inputs - | Outputs -</span>
                        </div>
                        <div class="trace-grid">
                            <div class="trace-col">
                                <h5>Input Parameters (<span id="inParamCount">0</span>)</h5>
                                <div class="trace-list" id="inputTraceList"></div>
                            </div>
                            <div class="trace-col">
                                <h5>Output Parameters (<span id="outParamCount">0</span>)</h5>
                                <div class="trace-list" id="outputTraceList"></div>
                            </div>
                        </div>
                    </div>

                    <div class="sensitivity-block">
                        <h4>Logic Impact Matrix (Editable Algorithm Effects)</h4>
                        <p>Each row estimates local sensitivity: if one parameter shifts by one step, how key outputs are affected.</p>
                        <div class="scenario-table-wrap">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Input Parameter</th>
                                        <th>Step</th>
                                        <th>Delta PUE</th>
                                        <th>Delta COP</th>
                                        <th>Delta Net OPEX</th>
                                        <th>Delta Carbon</th>
                                        <th>Delta Risk</th>
                                    </tr>
                                </thead>
                                <tbody id="impactRows">
                                    <tr><td colspan="7">Run model to generate impact matrix.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="scoreboard">
                        <div class="score-row">
                            <span class="score-title">Composite Standards Alignment</span>
                            <span class="score-value" id="outScore">-</span>
                        </div>
                        <p class="score-grade" id="outGrade">Grade: -</p>
                    </div>

                    <div class="compliance-grid">
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">ASHRAE Thermal Envelope</span><span class="compliance-score" id="scoreAshrae">-</span></div>
                            <div class="progress"><i id="barAshrae"></i></div>
                        </div>
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">ANSI/TIA Infrastructure Readiness</span><span class="compliance-score" id="scoreAnsi">-</span></div>
                            <div class="progress"><i id="barAnsi"></i></div>
                        </div>
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">ISO Energy Governance</span><span class="compliance-score" id="scoreIso">-</span></div>
                            <div class="progress"><i id="barIso"></i></div>
                        </div>
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">NFPA Safety Posture</span><span class="compliance-score" id="scoreNfpa">-</span></div>
                            <div class="progress"><i id="barNfpa"></i></div>
                        </div>
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">Uptime Tier Alignment</span><span class="compliance-score" id="scoreUptime">-</span></div>
                            <div class="progress"><i id="barUptime"></i></div>
                        </div>
                    </div>

                    <div class="method-block">
                        <h4>Methodology Snapshot</h4>
                        <ul>
                            <li>Mass flow uses Q = m * Cp * deltaT with coolant-specific properties.</li>
                            <li>Pump duty includes redundancy factor, hydraulic margin, and efficiency correction.</li>
                            <li>Cooling energy blends liquid + air path with economizer and part-load corrections.</li>
                            <li>PUE includes UPS and distribution losses, fan load, and auxiliary systems.</li>
                            <li>Net OPEX and carbon include heat reuse credit and displacement benefit.</li>
                            <li>Composite score uses weighted standard-specific criteria plus risk modifiers.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <p>LTC System Modelling Lab - ResistanceZero - 2026</p>
            <p><a href="terms.html">Terms</a> - <a href="privacy.html">Privacy</a> - <a href="datacenter-solutions.html">Back to DC Solutions</a></p>
        </footer>
    </main>

    <div class="root-gate" id="rootGate" aria-live="polite">
        <div class="root-gate-card">
            <div class="lock"><i class="fas fa-lock"></i></div>
            <h2>Root Access Required</h2>
            <p>This page is restricted. Sign in with a root account to open the standards and liquid-to-chip lab.</p>
            <div class="root-gate-actions">
                <button class="login" id="rootLoginBtn" type="button">Sign In as Root</button>
                <a class="back" href="datacenter-solutions.html">Back</a>
            </div>
            <p class="root-gate-note">Sign in with your authorized root account to continue.</p>
        </div>
    </div>

    <div class="cookie-banner hidden" id="cookieBanner">
        <p>We use cookies for analytics to improve your experience. <a href="privacy.html">Learn more</a></p>
        <div class="cookie-actions">
            <button class="cookie-accept" id="cookieAccept">Accept</button>
            <button class="cookie-decline" id="cookieDecline">Decline</button>
        </div>
    </div>

    <script>
        (function initTheme() {
            var themeToggle = document.getElementById('themeToggle');
            var prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

            function preferredTheme() {
                var saved = localStorage.getItem('theme');
                if (saved) return saved;
                return prefersDark.matches ? 'dark' : 'light';
            }

            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                var icon = themeToggle.querySelector('i');
                if (icon) {
                    icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                }
                var metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) metaTheme.setAttribute('content', theme === 'dark' ? '#0a0f1d' : '#ffffff');
            }

            applyTheme(preferredTheme());

            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    var current = document.documentElement.getAttribute('data-theme');
                    applyTheme(current === 'dark' ? 'light' : 'dark');
                });
            }
        })();

        (function initCalculator() {
            var COUNTRY_PROFILES = {
                custom: { label: 'Custom Manual' },
                sg: { label: 'Singapore', climate: 'tropical', elecPrice: 0.22, waterTariff: 2.7, airCop: 4.0, targetPue: 1.23, targetCop: 7.8, economizerHours: 22, carbonIntensity: 0.41, upsEff: 96.8, distLoss: 2.2 },
                us_va: { label: 'USA - Virginia', climate: 'temperate', elecPrice: 0.11, waterTariff: 1.3, airCop: 4.9, targetPue: 1.18, targetCop: 8.8, economizerHours: 48, carbonIntensity: 0.31, upsEff: 97.2, distLoss: 1.9 },
                nl: { label: 'Netherlands', climate: 'temperate', elecPrice: 0.17, waterTariff: 1.9, airCop: 5.1, targetPue: 1.16, targetCop: 9.1, economizerHours: 52, carbonIntensity: 0.27, upsEff: 97.4, distLoss: 1.8 },
                id_jkt: { label: 'Indonesia - Jakarta', climate: 'tropical', elecPrice: 0.1, waterTariff: 1.6, airCop: 4.1, targetPue: 1.26, targetCop: 7.5, economizerHours: 18, carbonIntensity: 0.73, upsEff: 96.1, distLoss: 2.4 },
                in_mum: { label: 'India - Mumbai', climate: 'tropical', elecPrice: 0.12, waterTariff: 1.4, airCop: 4.2, targetPue: 1.24, targetCop: 7.7, economizerHours: 20, carbonIntensity: 0.69, upsEff: 96.0, distLoss: 2.5 },
                ie: { label: 'Ireland', climate: 'temperate', elecPrice: 0.18, waterTariff: 2.2, airCop: 5.0, targetPue: 1.15, targetCop: 9.3, economizerHours: 58, carbonIntensity: 0.29, upsEff: 97.5, distLoss: 1.7 }
            };

            var CLIMATE_FACTORS = {
                tropical: { wetBulb: 26, baseWue: 0.62, climateCopBias: -0.45 },
                temperate: { wetBulb: 17, baseWue: 0.22, climateCopBias: 0.38 },
                dry: { wetBulb: 16, baseWue: 0.30, climateCopBias: 0.55 },
                continental: { wetBulb: 19, baseWue: 0.38, climateCopBias: 0.22 }
            };

            var RACK_PROFILES = {
                ai_hpc_direct_liquid: { label: 'AI/HPC Direct Liquid', baseDensity: 70, liquidBias: 1.18, airResidual: 0.24, riskBias: 7, futureBias: 1.18 },
                enterprise_mixed: { label: 'Enterprise Mixed', baseDensity: 28, liquidBias: 0.86, airResidual: 0.56, riskBias: 3, futureBias: 0.72 },
                immersion_single_phase: { label: 'Immersion Single-Phase', baseDensity: 85, liquidBias: 1.28, airResidual: 0.14, riskBias: 6, futureBias: 1.28 },
                immersion_two_phase: { label: 'Immersion Two-Phase', baseDensity: 100, liquidBias: 1.36, airResidual: 0.08, riskBias: 7, futureBias: 1.4 },
                legacy_air_plus_rdhx: { label: 'Legacy Air + RDHx', baseDensity: 22, liquidBias: 0.62, airResidual: 0.72, riskBias: 11, futureBias: 0.42 }
            };

            var COOLANTS = {
                water: { cp: 4.186, rho: 997 },
                pg20: { cp: 3.92, rho: 1025 },
                pg30: { cp: 3.75, rho: 1038 }
            };

            var COOLING_ARCH_PROFILES = {
                direct_liquid: {
                    label: 'Direct Liquid (Warm-Water LTC)',
                    rackType: 'ai_hpc_direct_liquid',
                    liquidCapture: 85,
                    supplyTemp: 32.5,
                    returnTemp: 40.5,
                    airCop: 4.6,
                    fanPower: 2.8,
                    economizerHours: 34,
                    coefHeatTransfer: 94,
                    coefPipeLoss: 1.0
                },
                hybrid: {
                    label: 'Hybrid Liquid + Air',
                    rackType: 'enterprise_mixed',
                    liquidCapture: 55,
                    supplyTemp: 24,
                    returnTemp: 32,
                    airCop: 4.7,
                    fanPower: 4.1,
                    economizerHours: 34,
                    coefHeatTransfer: 89,
                    coefPipeLoss: 1.02
                },
                air_inrow_dahu: {
                    label: 'Air-Cooling In-Row / DAHU',
                    rackType: 'legacy_air_plus_rdhx',
                    liquidCapture: 12,
                    supplyTemp: 18,
                    returnTemp: 24,
                    airCop: 3.8,
                    fanPower: 5.0,
                    economizerHours: 22,
                    coefHeatTransfer: 76,
                    coefPipeLoss: 1.06
                }
            };

            var COOLING_ARCH_NOTES = {
                direct_liquid: 'Warm-water DLC baseline: liquid supply commonly high-20s to low-30s C (coolant loop, not supply-air).',
                hybrid: 'Hybrid baseline: partial liquid capture with meaningful air path contribution.',
                air_inrow_dahu: 'In-row/DAHU baseline: DAHU supply-air setpoint is separate from liquid/chilled-water temperature.',
                manual: 'Manual mode: no auto-adjustment. You control all parameters directly.'
            };

            var DEFAULTS = {
                inItLoad: 12,
                inRackCount: 360,
                inRackType: 'ai_hpc_direct_liquid',
                inRackDensityTarget: 35,
                inHighDensityShare: 45,
                inModelYear: 2026,
                inCoolingArchitecture: 'direct_liquid',
                inLiquidCapture: 85,
                inCoolant: 'water',
                inSupplyTemp: 32.5,
                inReturnTemp: 40.5,
                inPumpHead: 28,
                inPumpEff: 78,
                inHydraulicMargin: 12,
                inControlQuality: 86,
                inPredictiveGain: 12,
                inCoefHeatTransfer: 94,
                inCoefCduLoss: 1.8,
                inCoefPipeLoss: 1.0,
                inCoefFutureTech: 0,
                inCduUnit: 1200,
                inRedundancy: 'N1',
                inClimate: 'tropical',
                inCountryProfile: 'custom',
                inAirCop: 4.6,
                inEconomizerHours: 34,
                inFanPower: 2.8,
                inUpsEff: 96.5,
                inDistLoss: 2.1,
                inHeatReuse: 18,
                inElecPrice: 0.11,
                inWaterTariff: 1.6,
                inCarbonIntensity: 0.42,
                inMonitoring: 92,
                inFireType: 'clean_agent',
                inTargetPue: 1.2,
                inTargetCop: 8.2,
                inFailureMode: 'normal',
                inConcurrent: true,
                conPueMax: 1.25,
                conCopMin: 7.0,
                conRiskMax: 40,
                conPumpPctMax: 3.0,
                conEnforce: 'yes',
                ruleG1: 'monitoring >= 85 && controlIndex >= 78',
                ruleG2: 'deltaT >= 7.5 && pumpPowerPctIt <= 3',
                ruleG3: 'riskIndex <= 35 && pue <= targetPue + 0.02',
                paretoSamples: 1400,
                mcSamples: 1200,
                mcUncertainty: 7,
                scenarioName: '',
                calTargetPue: '',
                calTargetCop: '',
                calTargetEnergy: '',
                calTargetNetOpex: '',
                calTargetCarbon: '',
                calTargetPump: '',
                calLockApply: true,
                telemetryPaste: '',
                telemetryApplyInputs: false,
                telemetryAggMode: 'mean',
                telemetryWindowRows: 0,
                mapColPue: '__auto__',
                mapColCop: '__auto__',
                mapColEnergy: '__auto__',
                mapColOpex: '__auto__',
                mapColCarbon: '__auto__',
                mapColPump: '__auto__',
                mapColLiquidCapture: '__auto__',
                mapColPumpEff: '__auto__',
                mapColFanPower: '__auto__',
                mapColMonitoring: '__auto__'
            };

            var IMPACT_PARAMS = [
                { key: 'itLoadMw', label: 'IT Load', step: 0.2, min: 0.5, max: 80, unit: 'MW' },
                { key: 'liquidCapture', label: 'Liquid Capture', step: 2, min: 0, max: 100, unit: '%' },
                { key: 'rackDensityTarget', label: 'Target Density', step: 2, min: 5, max: 180, unit: 'kW/rack' },
                { key: 'supplyTemp', label: 'Supply Temp', step: 0.5, min: 16, max: 42, unit: 'C' },
                { key: 'pumpEff', label: 'Pump Efficiency', step: 1, min: 35, max: 95, unit: '%' },
                { key: 'airCop', label: 'Air COP', step: 0.2, min: 1.5, max: 12, unit: '' },
                { key: 'economizerHours', label: 'Economizer', step: 3, min: 0, max: 95, unit: '%' },
                { key: 'controlQuality', label: 'Control Quality', step: 3, min: 0, max: 100, unit: '%' },
                { key: 'predictiveGain', label: 'Predictive Gain', step: 3, min: 0, max: 60, unit: '%' },
                { key: 'coefHeatTransfer', label: 'Heat Transfer Coef', step: 0.5, min: 60, max: 99, unit: '%' },
                { key: 'coefPipeLoss', label: 'Pipe Loss Multiplier', step: 0.02, min: 0.75, max: 1.8, unit: '' },
                { key: 'coefFutureTech', label: 'Future Tech Multiplier', step: 2, min: -10, max: 45, unit: '%' }
            ];

            var INPUT_KEY_BY_ID = {
                inItLoad: 'itLoadMw',
                inRackCount: 'rackCount',
                inRackType: 'rackType',
                inRackDensityTarget: 'rackDensityTarget',
                inHighDensityShare: 'highDensityShare',
                inModelYear: 'modelYear',
                inCountryProfile: 'countryKey',
                inClimate: 'climate',
                inCoolingArchitecture: 'architectureMode',
                inLiquidCapture: 'liquidCapture',
                inCoolant: 'coolantKey',
                inSupplyTemp: 'supplyTemp',
                inReturnTemp: 'returnTemp',
                inPumpHead: 'pumpHead',
                inPumpEff: 'pumpEff',
                inHydraulicMargin: 'hydraulicMargin',
                inControlQuality: 'controlQuality',
                inPredictiveGain: 'predictiveGain',
                inCoefHeatTransfer: 'coefHeatTransfer',
                inCoefCduLoss: 'coefCduLoss',
                inCoefPipeLoss: 'coefPipeLoss',
                inCoefFutureTech: 'coefFutureTech',
                inCduUnit: 'cduUnit',
                inRedundancy: 'redundancy',
                inAirCop: 'airCop',
                inEconomizerHours: 'economizerHours',
                inFanPower: 'fanPower',
                inUpsEff: 'upsEff',
                inDistLoss: 'distLoss',
                inHeatReuse: 'heatReuse',
                inElecPrice: 'elecPrice',
                inWaterTariff: 'waterTariff',
                inCarbonIntensity: 'carbonIntensity',
                inMonitoring: 'monitoring',
                inFireType: 'fireType',
                inTargetPue: 'targetPue',
                inTargetCop: 'targetCop',
                inFailureMode: 'failureMode',
                inConcurrent: 'concurrent',
                conPueMax: 'conPueMax',
                conCopMin: 'conCopMin',
                conRiskMax: 'conRiskMax',
                conPumpPctMax: 'conPumpPctMax',
                conEnforce: 'conEnforce',
                ruleG1: 'ruleG1',
                ruleG2: 'ruleG2',
                ruleG3: 'ruleG3',
                paretoSamples: 'paretoSamples',
                mcSamples: 'mcSamples',
                mcUncertainty: 'mcUncertainty',
                calTargetPue: 'calTargetPue',
                calTargetCop: 'calTargetCop',
                calTargetEnergy: 'calTargetEnergy',
                calTargetNetOpex: 'calTargetNetOpex',
                calTargetCarbon: 'calTargetCarbon',
                calTargetPump: 'calTargetPump',
                calLockApply: 'calLockApply'
            };

            var OUTPUT_KEY_BY_ID = {
                outCountry: 'countryKey',
                outLiquidLoad: 'liquidKw',
                outAirLoad: 'airKw',
                outFlow: 'flowLpm',
                outPump: 'pumpPowerKw',
                outCdu: 'cduCount',
                outPue: 'pue',
                outCop: 'systemCop',
                outWue: 'wue',
                outEnergy: 'annualGwh',
                outOpex: 'annualOpex',
                outHeatCredit: 'heatReuseCredit',
                outNetOpex: 'netOpex',
                outCarbon: 'netCarbonTons',
                outCarbonAvoided: 'avoidedCarbonTons',
                outRackType: 'rackType',
                outDesignDensity: 'designDensity',
                outControlIndex: 'controlIndex',
                outFutureFactor: 'futureFactor',
                outRackDensity: 'rackDensity',
                outRisk: 'riskIndex',
                outConfidence: 'confidence',
                outCalFit: 'calibrationFit'
            };

            var HOTSPOT_KEY_BY_ID = {
                quickPue: 'pue',
                quickCop: 'systemCop',
                quickOpex: 'netOpex',
                quickRisk: 'riskIndex',
                outScore: 'scores.total',
                outGrade: 'scores.total',
                scoreAshrae: 'scores.ashrae',
                scoreAnsi: 'scores.ansi',
                scoreIso: 'scores.iso',
                scoreNfpa: 'scores.nfpa',
                scoreUptime: 'scores.uptime',
                modelInputNode: 'itLoadMw',
                modelEngineNode: 'deltaT',
                modelControlNode: 'targetPue',
                modelImpactNode: 'pue',
                impactPueGap: 'pue',
                impactCopGap: 'systemCop',
                impactOpexDelta: 'netOpex',
                targetGapBadge: 'targetPue',
                seqInput: 'itLoadMw',
                seqProcessing: 'deltaT',
                seqControl: 'ruleG1',
                seqOutput: 'pue',
                seqFeedback: 'controlIndex',
                diagInputMain: 'itLoadMw',
                diagInputSub: 'rackDensityTarget',
                diagThermalMain: 'deltaT',
                diagThermalSub: 'effectiveCapture',
                diagHydraulicMain: 'flowLpm',
                diagHydraulicSub: 'coefPipeLoss',
                diagImpactMain: 'pue',
                diagImpactSub: 'wue',
                diagCostMain: 'netOpex',
                diagCostSub: 'netCarbonTons',
                diagControlMain: 'controlIndex',
                diagControlSub: 'targetPue',
                diagComplianceMain: 'scores.total',
                diagComplianceSub: 'scores.ashrae',
                ctrlSensorMain: 'monitoring',
                ctrlSensorSub: 'modelYear',
                ctrlControllerMain: 'controlQuality',
                ctrlControllerSub: 'controlIndex',
                ctrlActuatorMain: 'supplyTemp',
                ctrlActuatorSub: 'effectiveCapture',
                ctrlPlantMain: 'pue',
                ctrlPlantSub: 'netOpex',
                ctrlGateAMain: 'ruleG1',
                ctrlGateASub: 'ruleG1',
                ctrlGateBMain: 'ruleG2',
                ctrlGateBSub: 'ruleG2',
                ctrlGateCMain: 'ruleG3',
                ctrlGateCSub: 'ruleG3',
                basePue: 'pue',
                baseCop: 'systemCop',
                baseNetOpex: 'netOpex',
                baseCarbon: 'netCarbonTons',
                baseWue: 'wue',
                optPue: 'pue',
                optCop: 'systemCop',
                optNetOpex: 'netOpex',
                optCarbon: 'netCarbonTons',
                optWue: 'wue',
                deltaPue: 'pue',
                deltaCop: 'systemCop',
                deltaNetOpex: 'netOpex',
                deltaCarbon: 'netCarbonTons',
                deltaWue: 'wue'
            };

            var PARAM_TOOLTIPS = {
                itLoadMw: { title: 'IT Load', desc: 'Total critical IT heat load entering the facility thermal system. This is the main driver for cooling, electrical losses, and infrastructure sizing.', formula: 'Formula: Q_it = MW * 1000 kW.' },
                rackCount: { title: 'Rack Count', desc: 'Total number of active racks used to compute average rack density and stress multipliers. Higher count at constant load lowers average density.', formula: 'Formula: rackDensity = IT_kW / rackCount.' },
                rackType: { title: 'Rack Type Profile', desc: 'Technology profile that sets baseline thermal behavior, future bias, and residual air-cooling dependency. Different profiles shift capture and risk assumptions.', formula: 'Ref: profile factors apply to liquidBias, airResidual, and futureBias.' },
                rackDensityTarget: { title: 'Target Rack Density', desc: 'Design density objective used to evaluate design stress and optimization trade-offs. Higher target density demands stronger liquid capture and hydraulic performance.', formula: 'Ref: compared against model designDensity and rackDensityGap.' },
                highDensityShare: { title: 'High-Density Rack Share', desc: 'Share of racks expected to run in high-density mode. This pushes effective design density and cooling intensity.', formula: 'Ref: increases designDensity scaling term.' },
                modelYear: { title: 'Model Horizon Year', desc: 'Future projection horizon for technology and operating assumptions. Later years increase future factor influence in this model.', formula: 'Formula: yearDelta = modelYear - 2026.' },
                countryKey: { title: 'Country Profile', desc: 'Geographic profile that can preload energy, carbon, and infrastructure assumptions. It aligns baseline scenario to regional context.', formula: 'Ref: profile can set climate, tariff, target PUE/COP, and carbon intensity.' },
                climate: { title: 'Climate Profile', desc: 'Macro-climate class used to bias wet-bulb behavior, WUE baseline, and achievable cooling performance. Climate affects both energy and water behavior.', formula: 'Ref: climate factors include wetBulb, baseWue, and climateCopBias.' },
                architectureMode: { title: 'Cooling Architecture Preset', desc: 'Preset helper to align model assumptions with cooling style (direct liquid, hybrid, or air-cooling in-row/DAHU). This is a guidance preset and can still be overridden manually.', formula: 'Ref: preset updates rack profile, capture, liquid temperature pair, and air/fan assumptions.' },
                liquidCapture: { title: 'Liquid Capture', desc: 'Fraction of IT heat captured by liquid path before residual air cooling. Higher capture lowers fan/air burden and can improve facility efficiency.', formula: 'Ref: effectiveCapture uses capture, rack profile, heat transfer, and control index.' },
                coolantKey: { title: 'Coolant Type', desc: 'Coolant selection determines fluid properties used in mass-flow and pump calculations. Cp and density directly change required flow and hydraulic power.', formula: 'Formula: m = Q / (Cp * deltaT); hydraulic uses density.' },
                supplyTemp: { title: 'Liquid Supply Temperature', desc: 'Entering liquid coolant temperature to CDU/cold-plate loop (not supply air temperature). For warm-water direct liquid designs this is often high-20s to low-30s C; for air/in-row-chilled loops it can be lower.', formula: 'Ref: deltaT = returnTemp - supplyTemp with control and future adjustments.' },
                returnTemp: { title: 'Liquid Return Temperature', desc: 'Leaving liquid coolant temperature from IT loop. Together with liquid supply temperature it determines thermal delta-T and required flow.', formula: 'Formula: deltaT = returnTemp - supplyTemp.' },
                pumpHead: { title: 'Pump Head', desc: 'Hydraulic head requirement for the loop including elevation and friction assumptions. Higher head increases pump power demand.', formula: 'Formula: P_hyd = rho * g * flow * head.' },
                pumpEff: { title: 'Pump Efficiency', desc: 'Net pump efficiency assumption used to convert hydraulic to electrical pump power. Higher efficiency reduces electrical overhead.', formula: 'Formula: P_elec = P_hyd / pumpEff.' },
                hydraulicMargin: { title: 'Hydraulic Margin', desc: 'Design margin added to base flow to maintain operational resilience. Higher margin raises design flow and pump duty.', formula: 'Ref: designFlow *= (1 + margin/100).' },
                controlQuality: { title: 'BMS / Control Quality', desc: 'Quality score for BMS/DCIM control architecture and tuning. Better control improves capture effectiveness, COP, and risk posture.', formula: 'Ref: contributes to controlIndex.' },
                predictiveGain: { title: 'Predictive Control Effectiveness', desc: 'Effectiveness of predictive logic (MPC-like) in the control loop. This is a control-performance factor, not a standalone hardware device.', formula: 'Ref: contributes to controlIndex and controlBonus.' },
                coefHeatTransfer: { title: 'Thermal Transfer Effectiveness', desc: 'Heat exchanger effectiveness coefficient for IT-to-liquid transfer. Lower values reduce effective liquid capture and raise residual air load.', formula: 'Ref: effectiveCapture scales with coefHeatTransfer.' },
                coefCduLoss: { title: 'CDU Loss Coefficient', desc: 'Thermal/electrical overhead factor for CDU processing losses. Higher coefficient increases non-IT cooling load.', formula: 'Formula: cduLossKw = liquidKw * (coefCduLoss/100).' },
                coefPipeLoss: { title: 'Pipe Loss Multiplier', desc: 'Network loss multiplier for piping and distribution complexity. Higher multiplier increases effective head and design flow penalty.', formula: 'Ref: affects designFlow and pumpHeadEff.' },
                coefFutureTech: { title: 'Future Tech Multiplier', desc: 'Scenario lever for expected technology uplift relative to baseline year. Positive values model future capability gains.', formula: 'Ref: futureFactor = f(coefFutureTech, yearDelta, profile futureBias).' },
                cduUnit: { title: 'CDU Unit Capacity', desc: 'Nominal heat handling per CDU module. Used to estimate module count under selected redundancy topology.', formula: 'Formula: cduBase = ceil(liquidKw / cduUnit).' },
                redundancy: { title: 'Redundancy Topology', desc: 'Design redundancy level (N, N+1, 2N) applied to hydraulic and module sizing. Stronger redundancy improves resilience but increases overhead.', formula: 'Ref: redundancyFactor affects flow and cduCount.' },
                airCop: { title: 'Air Path COP', desc: 'Baseline coefficient of performance for residual air-cooling path. This impacts the non-liquid cooling energy burden.', formula: 'Formula: airCoolingKw = residualAirKw / airCopEff.' },
                economizerHours: { title: 'Economizer Availability', desc: 'Share of annual operation that can leverage economizer conditions. More economizer time improves effective air path efficiency.', formula: 'Ref: airCopEff scales with economizer fraction.' },
                fanPower: { title: 'Facility Airflow Fan Power', desc: 'Facility airflow fan overhead (e.g., CRAH/CRAC, in-row, DAHU/AHU fans) as a share of IT load before control/capture reductions.', formula: 'Formula: fanKw = IT_kW * fanPower% * modifiers.' },
                upsEff: { title: 'UPS Efficiency', desc: 'UPS conversion efficiency in the electrical chain. Lower efficiency increases power losses and worsens PUE.', formula: 'Formula: upsInputKw = IT_kW / upsEff.' },
                distLoss: { title: 'Power Distribution Loss', desc: 'Electrical distribution loss after UPS conversion. It captures cable, transformer, and distribution inefficiencies.', formula: 'Formula: distLossKw = upsInputKw * distLoss%.' },
                heatReuse: { title: 'Heat Reuse Rate', desc: 'Fraction of liquid path heat considered recoverable for beneficial reuse. Reuse reduces net OPEX and net carbon in this model.', formula: 'Ref: heatReuseCredit and avoidedCarbon scale with reuse share.' },
                elecPrice: { title: 'Electricity Price', desc: 'Energy tariff used for annual electricity cost projection. It is the main economic sensitivity driver.', formula: 'Formula: annualEnergyCost = annualKwh * elecPrice.' },
                waterTariff: { title: 'Water Tariff', desc: 'Water cost assumption applied to modelled water use. It affects total annual OPEX.', formula: 'Formula: annualWaterCost = annualWaterM3 * waterTariff.' },
                carbonIntensity: { title: 'Grid Carbon Intensity', desc: 'Grid emissions factor used to convert energy into carbon footprint. Lower intensity materially reduces annual carbon.', formula: 'Formula: annualCarbon = annualKwh * carbonIntensity / 1000.' },
                monitoring: { title: 'Monitoring Coverage', desc: 'Coverage level for sensing and telemetry points in the control system. Higher coverage improves confidence and control outcomes.', formula: 'Ref: contributes to controlIndex and confidence score.' },
                fireType: { title: 'Fire Suppression Strategy', desc: 'Fire suppression architecture used in safety/risk scoring. Strategy influences NFPA posture and risk modifiers.', formula: 'Ref: nfpaScore and riskIndex include fireType impact.' },
                targetPue: { title: 'Target PUE', desc: 'Efficiency target used by optimization and gap analysis. Model computes deviation to this value for action guidance.', formula: 'Formula: pueGap = modelPue - targetPue.' },
                targetCop: { title: 'Target System COP', desc: 'Cooling performance target used by optimization objective. Model computes COP gap and improvement recommendations.', formula: 'Formula: copGap = modelCop - targetCop.' },
                concurrent: { title: 'Concurrent Maintainability', desc: 'Flag indicating maintainability architecture support under maintenance events. It contributes to resilience and risk scoring.', formula: 'Ref: contributes to controlIndex, uptime score, and risk index.' },
                calTargetPue: { title: 'Measured PUE', desc: 'Measured telemetry value used as calibration target for model fit. Improves coefficient tuning when provided with other KPIs.', formula: 'Ref: calibration minimizes weighted relative error.' },
                calTargetCop: { title: 'Measured System COP', desc: 'Measured COP target for calibration fit loop. Helps align cooling model assumptions to real operation.', formula: 'Ref: included in weighted calibration objective.' },
                calTargetEnergy: { title: 'Measured Annual Energy', desc: 'Measured annual facility energy for calibration. Anchors energy and cost trajectory to telemetry.', formula: 'Ref: target annualGwh used in objective function.' },
                calTargetNetOpex: { title: 'Measured Net OPEX', desc: 'Measured net annual operating cost for economic calibration. Helps reconcile tariff, efficiency, and reuse assumptions.', formula: 'Ref: target netOpex used in objective function.' },
                calTargetCarbon: { title: 'Measured Carbon', desc: 'Measured annual carbon footprint for calibration. Aligns emissions projection to observed performance.', formula: 'Ref: target netCarbonTons used in objective function.' },
                calTargetPump: { title: 'Measured Pump Power', desc: 'Measured pump power telemetry for hydraulic calibration fit. Tunes flow/head/efficiency-related coefficients.', formula: 'Ref: target pumpPowerKw used in objective function.' },
                calLockApply: { title: 'Apply Calibrated Coefficients', desc: 'When enabled, tuned coefficients are written back to active design inputs. This allows immediate what-if testing from calibrated baseline.', formula: 'Ref: writes tuned values to control and coefficient inputs.' },
                failureMode: { title: 'Failure / Degraded Mode', desc: 'Selects degraded operating condition overlays for resilience simulation. This mode perturbs control, thermal, hydraulic, or economic terms.', formula: 'Ref: mode-specific modifiers are applied inside computeModel().' },
                conPueMax: { title: 'Hard PUE Max', desc: 'Upper hard limit for efficiency acceptance. When enforced, optimizer rejects solutions above this threshold.', formula: 'Constraint: model.pue <= conPueMax.' },
                conCopMin: { title: 'Hard COP Min', desc: 'Lower hard limit for cooling efficiency acceptance. Enforced during optimization and feasibility checks.', formula: 'Constraint: model.systemCop >= conCopMin.' },
                conRiskMax: { title: 'Hard Risk Max', desc: 'Upper bound for acceptable risk index. Tight values prioritize resilient solutions.', formula: 'Constraint: model.riskIndex <= conRiskMax.' },
                conPumpPctMax: { title: 'Hard Pump % of IT Max', desc: 'Maximum allowed pump overhead relative to IT load. Useful for hydraulic efficiency governance.', formula: 'Constraint: (pumpPowerKw / itKw)*100 <= conPumpPctMax.' },
                conEnforce: { title: 'Enforce Hard Constraints', desc: 'When enabled, infeasible solutions are heavily penalized and excluded from optimized recommendations.', formula: 'Ref: hard infeasibility penalty added in optimizeObjective().' },
                sankeyMode: { title: 'Sankey View Mode', desc: 'Selects which model state is visualized in Sankey: baseline, optimized, auto-active, or compare.', formula: 'Ref: Sankey uses activeModel based on selected mode.' },
                telemetryAggMode: { title: 'Telemetry Aggregation Mode', desc: 'Controls how imported telemetry rows are summarized into calibration targets.', formula: 'Ref: mean / p50 / p90 / latest selection affects calibration target vector.' },
                autoRunToggle: { title: 'Auto-Run Mode', desc: 'When ON, model reruns automatically while editing inputs. When OFF, run is manual.', formula: 'Ref: requestModelRun() is debounce-triggered only when enabled.' },
                advancedInputToggle: { title: 'Advanced Input Mode', desc: 'Shows or hides lab-only coefficient controls to switch between operational and deep-lab workflows.', formula: 'Ref: UI visibility mode only; model still uses current input values.' },
                pdfSingleSource: { title: 'PDF Single Source', desc: 'Chooses model source for single PDF report generation.', formula: 'Ref: resolveModelSource(pdfSingleSource).' },
                pdfCompareLeft: { title: 'PDF Compare Left Source', desc: 'Left-side reference source in compare PDF report.', formula: 'Ref: compare delta is Right - Left.' },
                pdfCompareRight: { title: 'PDF Compare Right Source', desc: 'Right-side candidate source in compare PDF report.', formula: 'Ref: compare delta is Right - Left.' },
                ruleG1: { title: 'Rule G1', desc: 'DSL expression for sensor-quality gate decision. Evaluates to OPEN/ADJ state in control diagram.', formula: 'Variables: monitoring, controlIndex, deltaT, pumpPowerPctIt, riskIndex, pue, targetPue, cop, targetCop.' },
                ruleG2: { title: 'Rule G2', desc: 'DSL expression for actuator-limit gate decision. Used to decide whether hydraulic/thermal actuation is within tolerance.', formula: 'Expression must resolve to boolean true/false.' },
                ruleG3: { title: 'Rule G3', desc: 'DSL expression for risk-guard gate decision. Governs final pass/action state in control loop.', formula: 'Expression must resolve to boolean true/false.' },
                paretoSamples: { title: 'Pareto Samples', desc: 'Number of candidate points sampled for multi-objective frontier generation. Higher values improve frontier resolution but require more compute.', formula: 'Ref: non-dominated filtering over sampled candidate pool.' },
                mcSamples: { title: 'Simulation Samples', desc: 'Number of Monte Carlo iterations. More samples reduce percentile estimation noise.', formula: 'Ref: uncertainty propagation using random perturbation of key inputs.' },
                mcUncertainty: { title: 'Input Uncertainty', desc: 'Relative perturbation band applied to selected numeric inputs during Monte Carlo.', formula: 'Formula: candidate = base * (1 +/- uncertainty).' },
                effectiveCapture: { title: 'Effective Capture', desc: 'Model-adjusted liquid heat capture after profile and control modifiers. Used as core split between liquid and air thermal paths.', formula: 'Formula: effectiveCapture = f(liquidCapture, profile, transfer, control).' },
                designDensity: { title: 'Design Density', desc: 'Projected design density considering target, high-density share, and horizon year adjustments. Used for stress and risk calculations.', formula: 'Ref: designDensity drives densityStress and risk terms.' },
                rackDensityGap: { title: 'Rack Density Gap', desc: 'Difference between achieved and target rack density. Used for diagnostics and optimization pressure.', formula: 'Formula: rackDensityGap = designDensity - rackDensityTarget.' },
                futureFactor: { title: 'Future Factor', desc: 'Technology-adjusted multiplier for horizon modelling. It influences thermal effectiveness and confidence projections.', formula: 'Ref: depends on model year and future-tech coefficient.' },
                controlIndex: { title: 'Control Index', desc: 'Composite control quality metric from telemetry coverage, predictive gain, and maintainability context. Used across thermal, efficiency, and risk logic.', formula: 'Ref: weighted sum with clamp to 0-100.' },
                flowLpm: { title: 'Coolant Flow', desc: 'Design coolant flow rate derived from thermal load and hydraulic assumptions. Central output for loop and pump sizing.', formula: 'Formula: flow from Q/(Cp*dT) with density conversion.' },
                pumpPowerKw: { title: 'Pump Power', desc: 'Total electrical pump demand after hydraulic and efficiency effects. Contributes directly to auxiliary load and OPEX.', formula: 'Formula: pumpPower = hydraulicPower / pumpEff.' },
                pue: { title: 'PUE', desc: 'Power Usage Effectiveness estimate from modeled facility and IT loads. Key KPI for overall data center efficiency.', formula: 'Formula: PUE = totalFacilityKw / itKw.' },
                systemCop: { title: 'System COP', desc: 'Composite cooling COP including liquid and air paths with controls and economizer influence. Higher values indicate better cooling efficiency.', formula: 'Formula: systemCOP = coolingDelivered / coolingPower.' },
                wue: { title: 'WUE', desc: 'Water Usage Effectiveness estimate based on climate and load-adjusted water model. Used for water sustainability assessment.', formula: 'Formula: WUE = annualWaterM3 / annualKwh.' },
                annualGwh: { title: 'Annual Energy', desc: 'Projected annual site energy use in GWh. Drives energy cost and carbon outcomes.', formula: 'Formula: annualGwh = annualKwh / 1,000,000.' },
                annualOpex: { title: 'Gross Annual OPEX', desc: 'Total modeled annual operating cost before reuse credit. Includes energy and water costs.', formula: 'Formula: annualOpex = annualEnergyCost + annualWaterCost.' },
                heatReuseCredit: { title: 'Heat-Reuse Credit', desc: 'Economic credit from useful recovered heat under reuse assumptions. Deducted from gross OPEX to estimate net OPEX.', formula: 'Ref: heatReuseCredit scales with recoverable thermal energy.' },
                netOpex: { title: 'Net Annual OPEX', desc: 'Gross annual OPEX reduced by heat reuse credit. Primary economic KPI for scenario comparison.', formula: 'Formula: netOpex = annualOpex - heatReuseCredit.' },
                netCarbonTons: { title: 'Annual Carbon', desc: 'Projected net carbon emissions after avoided-carbon credit from heat reuse. Used for sustainability and compliance decisions.', formula: 'Formula: netCarbon = annualCarbon - avoidedCarbon.' },
                avoidedCarbonTons: { title: 'Carbon Avoided', desc: 'Estimated emissions displaced by recovered heat use. Reported separately to show decarbonization impact.', formula: 'Ref: avoidedCarbon scales with recovered heat and grid intensity.' },
                rackDensity: { title: 'Rack Density', desc: 'Computed average rack density from IT load and rack count. Compared against design targets for planning.', formula: 'Formula: rackDensity = IT_kW / rackCount.' },
                riskIndex: { title: 'Risk Index', desc: 'Composite operational risk indicator based on redundancy, safety strategy, density stress, and controls. Lower is better.', formula: 'Ref: weighted modifier logic with bounds 0-100.' },
                confidence: { title: 'Data Confidence', desc: 'Confidence indicator for model trust based on telemetry richness and assumption quality. Higher confidence suggests stronger decision support.', formula: 'Ref: weighted by monitoring, controls, and parameter stability.' },
                calibrationFit: { title: 'Calibration Fit', desc: 'Fit score indicating how closely calibrated model output matches telemetry targets. Higher fit means lower weighted error.', formula: 'Formula: fit = 100 * exp(-error * factor).' }
            };

            var BENCHMARK_HINTS = {
                pue: 'Benchmark: modern hyperscale target range is commonly 1.10 to 1.25.',
                systemCop: 'Benchmark: liquid-assisted systems often target COP above 7 in favorable conditions.',
                wue: 'Benchmark: lower is better; dry/temperate designs target significantly below tropical baselines.',
                supplyTemp: 'Benchmark: this is liquid coolant temperature (not supply-air). Warm-water DLC is often ~28C to 35C.',
                returnTemp: 'Benchmark: maintain enough delta-T to reduce flow and pump overhead.',
                deltaT: 'Benchmark: practical liquid loop delta-T often targets at least 6C to 10C.',
                pumpPowerKw: 'Benchmark: pump power is often kept below ~3% of IT load for efficient designs.',
                controlIndex: 'Benchmark: sustained >75 usually indicates strong automation readiness.',
                riskIndex: 'Benchmark: lower is better; many screening models treat <=35 as low operational risk.',
                confidence: 'Benchmark: >85% indicates high telemetry-backed confidence for planning decisions.',
                netCarbonTons: 'Ref: carbon KPI should be interpreted with local grid intensity and reuse credit assumptions.',
                annualGwh: 'Ref: verify against metered baseline before investment decisions.',
                annualOpex: 'Ref: compare against measured tariff and utilization scenarios.',
                netOpex: 'Ref: net OPEX should include validated heat reuse monetization assumptions.',
                ashrae: 'Benchmark: thermal compliance score above 85 indicates strong envelope control.',
                ansi: 'Benchmark: infrastructure readiness above 85 indicates robust topology posture.',
                iso: 'Benchmark: governance score above 85 indicates mature energy management practices.',
                nfpa: 'Benchmark: safety posture above 85 indicates strong suppression and response readiness.',
                uptime: 'Benchmark: alignment above 85 indicates strong maintainability/tier posture.'
            };

            var SCENARIO_STORE_KEY = 'ltc_lab_scenarios_v1';
            var LEDGER_STORE_KEY = 'ltc_lab_provenance_v1';
            var UI_PREF_STORE_KEY = 'ltc_lab_ui_pref_v1';
            var EXPLORER_STORE_KEY = 'ltc_lab_block_explorer_v1';
            var DEFAULT_GATE_RULES = {
                g1: 'monitoring >= 85 && controlIndex >= 78',
                g2: 'deltaT >= 7.5 && pumpPowerPctIt <= 3',
                g3: 'riskIndex <= 35 && pue <= targetPue + 0.02'
            };
            var PROVENANCE_TEMPLATE = [
                { key: 'itLoadMw', label: 'IT Load', source: 'Facility telemetry + planning assumptions', owner: 'Engineering', confidence: 92 },
                { key: 'liquidCapture', label: 'Liquid Capture', source: 'Thermal lab benchmark / OEM data', owner: 'Thermal Team', confidence: 86 },
                { key: 'airCop', label: 'Air Path COP', source: 'Climate-adjusted baseline model', owner: 'Cooling Team', confidence: 83 },
                { key: 'pumpEff', label: 'Pump Efficiency', source: 'Pump curve datasheet + commissioning', owner: 'Mechanical Team', confidence: 87 },
                { key: 'elecPrice', label: 'Electricity Price', source: 'Utility tariff contract', owner: 'Finance + Ops', confidence: 95 },
                { key: 'carbonIntensity', label: 'Grid Carbon Intensity', source: 'Regional carbon inventory', owner: 'Sustainability', confidence: 88 },
                { key: 'monitoring', label: 'Monitoring Coverage', source: 'BMS/DCIM point inventory', owner: 'Controls Team', confidence: 90 },
                { key: 'targetPue', label: 'Target PUE', source: 'Program target / design brief', owner: 'Program Management', confidence: 82 },
                { key: 'targetCop', label: 'Target COP', source: 'Cooling program KPI', owner: 'Program Management', confidence: 80 }
            ];
            var TELEMETRY_ALIAS_MAP = {
                timestamp: ['timestamp', 'time', 'datetime', 'date'],
                pue: ['pue', 'site_pue', 'measured_pue'],
                cop: ['cop', 'system_cop', 'cooling_cop', 'cop_system'],
                energyGwh: ['annual_energy_gwh', 'energy_gwh', 'annual_gwh', 'annual_energy'],
                netOpex: ['net_opex', 'opex', 'net_opex_usd', 'annual_net_opex'],
                carbon: ['carbon', 'net_carbon', 'net_carbon_tco2e', 'carbon_tco2e'],
                pumpKw: ['pump_kw', 'pump_power_kw', 'pump_power', 'pump'],
                itLoadMw: ['it_load_mw', 'it_mw', 'load_mw'],
                liquidCapture: ['liquid_capture', 'capture', 'capture_pct'],
                supplyTemp: ['supply_temp', 'supply_temp_c', 'liquid_supply_temp'],
                returnTemp: ['return_temp', 'return_temp_c', 'liquid_return_temp'],
                pumpEff: ['pump_eff', 'pump_efficiency', 'pump_eff_pct'],
                fanPower: ['fan_power', 'fan_power_pct_it', 'facility_fan_power'],
                monitoring: ['monitoring', 'monitoring_pct', 'telemetry_coverage'],
                controlQuality: ['control_quality', 'control_quality_pct'],
                predictiveGain: ['predictive_gain', 'predictive_control_gain', 'pred_gain'],
                airCop: ['air_cop', 'air_path_cop'],
                economizerHours: ['economizer_hours', 'economizer_pct'],
                heatReuse: ['heat_reuse', 'heat_reuse_pct'],
                targetPue: ['target_pue'],
                targetCop: ['target_cop']
            };
            var TELEMETRY_CAL_TARGET_MAP = {
                pue: 'calTargetPue',
                cop: 'calTargetCop',
                energyGwh: 'calTargetEnergy',
                netOpex: 'calTargetNetOpex',
                carbon: 'calTargetCarbon',
                pumpKw: 'calTargetPump'
            };
            var TELEMETRY_OPERATIONAL_MAP = {
                itLoadMw: 'inItLoad',
                liquidCapture: 'inLiquidCapture',
                supplyTemp: 'inSupplyTemp',
                returnTemp: 'inReturnTemp',
                pumpEff: 'inPumpEff',
                fanPower: 'inFanPower',
                monitoring: 'inMonitoring',
                controlQuality: 'inControlQuality',
                predictiveGain: 'inPredictiveGain',
                airCop: 'inAirCop',
                economizerHours: 'inEconomizerHours',
                heatReuse: 'inHeatReuse',
                targetPue: 'inTargetPue',
                targetCop: 'inTargetCop'
            };
            var TELEMETRY_MANUAL_SELECT_ID = {
                pue: 'mapColPue',
                cop: 'mapColCop',
                energyGwh: 'mapColEnergy',
                netOpex: 'mapColOpex',
                carbon: 'mapColCarbon',
                pumpKw: 'mapColPump',
                liquidCapture: 'mapColLiquidCapture',
                pumpEff: 'mapColPumpEff',
                fanPower: 'mapColFanPower',
                monitoring: 'mapColMonitoring'
            };
            var TELEMETRY_DIGITS = {
                calTargetPue: 3,
                calTargetCop: 2,
                calTargetEnergy: 2,
                calTargetNetOpex: 0,
                calTargetCarbon: 0,
                calTargetPump: 1,
                inItLoad: 2,
                inLiquidCapture: 1,
                inSupplyTemp: 1,
                inReturnTemp: 1,
                inPumpEff: 1,
                inFanPower: 1,
                inMonitoring: 0,
                inControlQuality: 0,
                inPredictiveGain: 0,
                inAirCop: 2,
                inEconomizerHours: 0,
                inHeatReuse: 0,
                inTargetPue: 3,
                inTargetCop: 2
            };

            var baselineModel = null;
            var optimizedModel = null;
            var calibrationState = null;
            var calibrationDirty = false;
            var latestPareto = [];
            var selectedParetoIdx = -1;
            var latestMonteCarlo = null;
            var latestTelemetryParsed = null;
            var universalAliasCache = null;
            var scenarioSnapshots = [];
            var gateRules = Object.assign({}, DEFAULT_GATE_RULES);
            var explorerCurrentModel = null;
            var explorerRunHistory = [];
            var explorerOpenTimer = {};
            var explorerState = loadExplorerState();
            var EXPLORER_BLOCKS = [
                { key: 'input', label: 'Input Profile' },
                { key: 'thermal', label: 'Thermal Layer' },
                { key: 'hydraulic', label: 'Hydraulic Layer' },
                { key: 'control', label: 'Constraint + Control' },
                { key: 'cost', label: 'Cost + Carbon' },
                { key: 'compliance', label: 'Compliance + Risk' }
            ];
            var BLOCK_POPUP_CONFIG = {
                input: { label: 'Input Profile', explorerKey: 'input', doc: 'Input envelope, assumptions, and quality checks before solver execution.' },
                thermal: { label: 'Thermal Layer', explorerKey: 'thermal', doc: 'Thermal split and delta-T solver converting IT load into liquid and air burden.' },
                hydraulic: { label: 'Hydraulic Layer', explorerKey: 'hydraulic', doc: 'Flow/head/pump conversion and hydraulic constraint diagnostics.' },
                impact: { label: 'Impact Layer', explorerKey: 'compliance', doc: 'KPI aggregation (PUE, COP, WUE, risk) for decision impact tracking.' },
                cost: { label: 'Cost + Carbon', explorerKey: 'cost', doc: 'Annualized economics and emissions including heat-reuse effects.' },
                control: { label: 'Constraint + Control', explorerKey: 'control', doc: 'Control index synthesis and gate-rule influence to plant behavior.' },
                compliance: { label: 'Compliance + Risk', explorerKey: 'compliance', doc: 'Final standards posture, risk envelope, and hard-constraint state.' },
                sensor: { label: 'Sensor Layer', explorerKey: 'control', doc: 'Telemetry quality and sensing confidence entering the control loop.' },
                controller: { label: 'Controller', explorerKey: 'control', doc: 'Rule logic and setpoint strategy for stable closed-loop operation.' },
                actuator: { label: 'Actuator Setpoint', explorerKey: 'hydraulic', doc: 'Execution layer for thermal/hydraulic actuation and flow response.' },
                plant: { label: 'Plant + KPI', explorerKey: 'compliance', doc: 'Plant response and KPI outcome under current setpoints and constraints.' },
                gate1: { label: 'Gate G1', explorerKey: 'control', doc: 'Sensor quality gate that validates observability and control readiness.' },
                gate2: { label: 'Gate G2', explorerKey: 'control', doc: 'Actuator limit gate guarding hydraulic and thermal command envelope.' },
                gate3: { label: 'Gate G3', explorerKey: 'compliance', doc: 'Risk guard gate enforcing operational risk and target KPI boundaries.' }
            };
            var blockPopupState = { open: false, key: '', explorerKey: 'input', trigger: null };
            var sankeyDrillState = { open: false, nodeId: '', trigger: null };
            var modeHelpState = { open: false, key: '', trigger: null };
            var MODE_HELP_DOCS = {
                inFailureMode: {
                    title: 'Failure / Degraded Mode Engine',
                    overview: 'Applies stress overlays to simulate degraded operation. Use this to test resilience before deployment and validate guardrails under non-ideal conditions.',
                    options: [
                        { mode: 'Normal Operation', use: 'Baseline reference without stress overlay.', impact: 'No additional degradation modifiers.' },
                        { mode: 'Pump Degraded', use: 'Simulate pump wear/partial fault condition.', impact: 'Pump power rises, flow reduces, risk increases.' },
                        { mode: 'Sensor Degraded', use: 'Simulate weak telemetry / instrumentation failure.', impact: 'Control index drops and operational uncertainty rises.' },
                        { mode: 'Heatwave Stress', use: 'Stress test in extreme ambient condition.', impact: 'Air-path COP degrades and thermal overhead rises.' },
                        { mode: 'Grid Stress', use: 'Model tariff and carbon stress events.', impact: 'Electricity and carbon intensity increase.' },
                        { mode: 'Redundancy Degraded', use: 'Simulate compromised redundancy posture.', impact: 'Risk index rises and resilience margin drops.' }
                    ],
                    tips: [
                        'Set mode first, then run model/optimizer so all outputs reflect the same stress condition.',
                        'Use this together with hard constraints to validate feasible degraded-operation envelope.',
                        'When presenting results, always report failure mode explicitly with KPI deltas.'
                    ]
                },
                conEnforce: {
                    title: 'Constraint Enforcement Mode',
                    overview: 'Controls whether hard constraints are strict blockers or only soft-ranking signals in optimization and recommendation logic.',
                    options: [
                        { mode: 'Yes (Hard)', use: 'Use for production sign-off and governance.', impact: 'Infeasible scenarios are rejected/penalized heavily.' },
                        { mode: 'No (Soft Ranking)', use: 'Use for exploration and what-if tradeoff study.', impact: 'Infeasible points can appear but will be flagged as violations.' }
                    ],
                    tips: [
                        'Enable hard mode before final decision/export.',
                        'Use soft mode only for ideation, never for deployment gate approval.',
                        'If hard mode yields no feasible solution, relax targets or improve input assumptions.'
                    ]
                },
                sankeyMode: {
                    title: 'Sankey View Mode',
                    overview: 'Chooses model source used by Sankey visualization and drill-down analytics.',
                    options: [
                        { mode: 'Auto (Active Model)', use: 'Default daily use.', impact: 'Uses optimized model when available, otherwise baseline.' },
                        { mode: 'Baseline Only', use: 'Inspect original design envelope.', impact: 'All flows come from baseline model.' },
                        { mode: 'Optimized Only', use: 'Inspect optimized recommendation envelope.', impact: 'All flows come from optimized model.' },
                        { mode: 'Compare Baseline vs Optimized', use: 'Quick distribution delta review.', impact: 'Shows dual lane compare; node drill-down modal is disabled in this mode.' }
                    ],
                    tips: [
                        'Use baseline/optimized mode before opening detailed Sankey drill.',
                        'Compare mode is best for top-level delta communication, not deep node decomposition.',
                        'Switch mode after each optimization/calibration run to validate direction of change.'
                    ]
                },
                telemetryAggMode: {
                    title: 'Telemetry Aggregation Mode',
                    overview: 'Defines how imported telemetry rows are collapsed into calibration targets.',
                    options: [
                        { mode: 'Average (Mean)', use: 'General steady-state datasets.', impact: 'Smoothes noise, balanced central tendency.' },
                        { mode: 'P50 (Median)', use: 'Dataset with spikes/outliers.', impact: 'Robust center estimate with lower outlier sensitivity.' },
                        { mode: 'P90', use: 'Conservative/stress-biased calibration.', impact: 'Biases targets toward high-load/high-risk tail.' },
                        { mode: 'Latest Row', use: 'Recent snapshot alignment.', impact: 'Uses newest operational state only.' }
                    ],
                    tips: [
                        'Use Median/P50 when data quality is uneven.',
                        'Use P90 when designing for peak robustness.',
                        'After changing aggregation mode, re-apply telemetry and rerun calibration.'
                    ]
                },
                autoRunToggle: {
                    title: 'Auto-Run Mode',
                    overview: 'Controls whether model recomputes automatically while editing inputs.',
                    options: [
                        { mode: 'ON', use: 'Interactive design iteration and fast feedback.', impact: 'Model updates automatically with debounce delay.' },
                        { mode: 'OFF', use: 'Heavy editing or controlled test sequencing.', impact: 'Manual Run required; prevents accidental recompute churn.' }
                    ],
                    tips: [
                        'Keep ON for live tuning; switch OFF for batch edits.',
                        'Turn OFF when calibrating many fields to avoid intermediate noisy states.',
                        'Always run once manually before exporting reports.'
                    ]
                },
                advancedInputToggle: {
                    title: 'Input Mode (Operational vs Advanced Lab)',
                    overview: 'Toggles visibility of advanced coefficients and lab-only tuning knobs.',
                    options: [
                        { mode: 'Operational Mode', use: 'Production-facing parameter set.', impact: 'Shows practical field parameters only.' },
                        { mode: 'Advanced Lab Coefficients', use: 'R&D and sensitivity deep-dive.', impact: 'Shows additional coefficient controls with higher model sensitivity.' }
                    ],
                    tips: [
                        'Use Operational mode for stakeholder and deployment review.',
                        'Use Advanced mode only when you understand coefficient coupling effects.',
                        'Document any advanced-coefficient changes before handover.'
                    ]
                },
                inCoolingArchitecture: {
                    title: 'Cooling Architecture Preset Mode',
                    overview: 'Preset mode aligns baseline assumptions to cooling strategy archetype.',
                    options: [
                        { mode: 'Direct Liquid (Warm-Water LTC)', use: 'High-density liquid-forward design.', impact: 'Higher capture target, lower residual air fraction.' },
                        { mode: 'Hybrid Liquid + Air', use: 'Mixed retrofit/transition environments.', impact: 'Balanced liquid-air split with moderate fan burden.' },
                        { mode: 'Air-Cooling In-Row / DAHU', use: 'Air-centric legacy environments.', impact: 'Lower liquid capture and higher air/fan dependence.' }
                    ],
                    tips: [
                        'Preset is baseline guidance; you can still override individual parameters.',
                        'After preset change, verify supply/return temperature context (liquid vs air system).',
                        'Re-check risk and pump overhead after architecture switch.'
                    ]
                },
                pdfSingleSource: {
                    title: 'PDF Single Source Mode',
                    overview: 'Chooses the model state used for single-report export.',
                    options: [
                        { mode: 'Current Baseline Model', use: 'Document original design state.', impact: 'Report reflects baseline KPIs and matrices.' },
                        { mode: 'Current Optimized Model', use: 'Document recommended tuned state.', impact: 'Report reflects optimized KPIs and matrices.' }
                    ],
                    tips: [
                        'Use baseline report for as-is assessment.',
                        'Use optimized report for proposed to-be state.',
                        'Ensure model is freshly run before export.'
                    ]
                },
                pdfCompareLeft: {
                    title: 'PDF Compare Left Source',
                    overview: 'Selects reference model on the left side of compare report.',
                    options: [
                        { mode: 'Baseline / Scenario', use: 'Reference anchor.', impact: 'All deltas computed as Right minus Left.' }
                    ],
                    tips: [
                        'Place baseline on Left for consistent storytelling.',
                        'Do not use identical source on both sides.',
                        'Use scenario snapshots for versioned compare governance.'
                    ]
                },
                pdfCompareRight: {
                    title: 'PDF Compare Right Source',
                    overview: 'Selects candidate model on the right side of compare report.',
                    options: [
                        { mode: 'Optimized / Scenario', use: 'Candidate or improved state.', impact: 'Delta sign reflects improvement or regression against Left.' }
                    ],
                    tips: [
                        'Use optimized on Right for clear improvement narrative.',
                        'Validate constraint status for both sides before export.',
                        'Use right-side source for recommendation candidate.'
                    ]
                },
                inRedundancy: {
                    title: 'Redundancy Topology Mode',
                    overview: 'Defines resilience topology (N, N+1, 2N) that affects hydraulic sizing, module count, and risk posture.',
                    options: [
                        { mode: 'N', use: 'Minimum-overhead design where resilience margin is limited.', impact: 'Lowest overhead, higher operational risk.' },
                        { mode: 'N+1', use: 'Balanced default for most production environments.', impact: 'Moderate overhead with meaningful resilience uplift.' },
                        { mode: '2N', use: 'Mission-critical uptime-first deployments.', impact: 'Highest redundancy and overhead, strongest resilience.' }
                    ],
                    tips: [
                        'Re-check pump overhead and net OPEX after changing topology.',
                        'Use N+1 as default screening baseline.',
                        'For 2N, validate capex and energy trade-off explicitly.'
                    ]
                },
                inCoolant: {
                    title: 'Coolant Selection Mode',
                    overview: 'Coolant choice changes fluid properties used in thermal and hydraulic solver stages.',
                    options: [
                        { mode: 'Water', use: 'Baseline high heat-capacity case.', impact: 'Generally lower flow/pump burden for same duty.' },
                        { mode: 'PG20 / PG30', use: 'Freeze-protection or mixed-fluid operations.', impact: 'Changes Cp and density; may increase hydraulic demand.' }
                    ],
                    tips: [
                        'After coolant change, verify flow, pump kW, and COP movement.',
                        'Use actual plant coolant chemistry for final report accuracy.',
                        'Do not assume water-equivalent performance for glycol blends.'
                    ]
                },
                inClimate: {
                    title: 'Climate Profile Mode',
                    overview: 'Selects ambient climate class that influences cooling efficiency and water profile.',
                    options: [
                        { mode: 'Tropical', use: 'Warm/humid climate baseline.', impact: 'Higher cooling burden and WUE pressure.' },
                        { mode: 'Temperate', use: 'Moderate ambient profile.', impact: 'Balanced efficiency envelope.' },
                        { mode: 'Dry', use: 'Dry-air climate modeling.', impact: 'Often better air-side cooling potential.' },
                        { mode: 'Continental', use: 'Seasonal mixed climate profile.', impact: 'Intermediate behavior with seasonal stress spread.' }
                    ],
                    tips: [
                        'Match climate mode to actual deployment geography.',
                        'Revisit economizer assumptions after climate changes.',
                        'Compare carbon and water impacts jointly, not energy only.'
                    ]
                },
                inCountryProfile: {
                    title: 'Country Profile Mode',
                    overview: 'Applies regional baseline assumptions for tariff, carbon, and target context.',
                    options: [
                        { mode: 'Custom Manual', use: 'Manual scenario control.', impact: 'No auto regional preset override.' },
                        { mode: 'Preset Country', use: 'Faster regional baseline setup.', impact: 'Preloads representative regional assumptions.' }
                    ],
                    tips: [
                        'Use preset for starting point, then tune manually.',
                        'Always validate tariff/carbon values against latest contracts.',
                        'Document country profile in exported report context.'
                    ]
                },
                inRackType: {
                    title: 'Rack Profile Mode',
                    overview: 'Sets rack thermal profile assumptions and density behavior basis.',
                    options: [
                        { mode: 'AI/HPC Direct Liquid', use: 'High-density liquid-first workloads.', impact: 'Higher capture bias and thermal intensity.' },
                        { mode: 'Enterprise Mixed', use: 'Mixed legacy + modern workload footprint.', impact: 'Balanced capture and air residual profile.' },
                        { mode: 'Immersion Profiles', use: 'Immersion-oriented deployment modeling.', impact: 'Higher liquid bias with different risk behavior.' },
                        { mode: 'Legacy Air + RDHx', use: 'Air-centric infrastructure baseline.', impact: 'Higher residual air and fan dependence.' }
                    ],
                    tips: [
                        'Pick rack mode first before fine-tuning capture and temperatures.',
                        'Validate against actual workload and rack power distribution.',
                        'Rack profile changes can shift both risk and efficiency behavior.'
                    ]
                },
                inFireType: {
                    title: 'Fire Suppression Strategy Mode',
                    overview: 'Safety strategy selection feeds resilience and compliance scoring.',
                    options: [
                        { mode: 'Clean Agent', use: 'Electronics-friendly gaseous suppression.', impact: 'Usually stronger uptime/safety balance.' },
                        { mode: 'Water Mist', use: 'Water-based suppression strategy.', impact: 'Different risk/compliance profile trade-off.' },
                        { mode: 'Double-Interlock / Dry Pipe', use: 'Pipe-based suppression infrastructure.', impact: 'Can increase risk modifiers in model scoring.' }
                    ],
                    tips: [
                        'Align this mode with actual facility safety architecture.',
                        'Review NFPA score impact after changing fire strategy.',
                        'Do not optimize purely for efficiency while ignoring safety posture.'
                    ]
                },
                telemetryApplyInputs: {
                    title: 'Telemetry Apply-Inputs Mode',
                    overview: 'Controls whether mapped operational telemetry columns overwrite input form values during import.',
                    options: [
                        { mode: 'Enabled', use: 'Synchronize model inputs to measured operations.', impact: 'Input vector updates from telemetry mapping.' },
                        { mode: 'Disabled', use: 'Calibrate KPI targets only.', impact: 'Input form remains unchanged.' }
                    ],
                    tips: [
                        'Enable only when telemetry columns are validated and trustworthy.',
                        'Use disabled mode for KPI-only calibration runs.',
                        'Always inspect mapping preview before applying.'
                    ]
                },
                explorerToggleMode: {
                    title: 'Explorer Open Mode',
                    overview: 'Determines whether block explorer allows one expanded block at a time or multiple concurrent expanded blocks.',
                    options: [
                        { mode: 'Single Open', use: 'Focused review with less visual noise.', impact: 'Opening one block closes others automatically.' },
                        { mode: 'Multi Open', use: 'Cross-block parallel inspection.', impact: 'Multiple blocks stay expanded together.' }
                    ],
                    tips: [
                        'Use single mode for guided reviews and presentations.',
                        'Use multi mode during deep engineering diagnostics.',
                        'Combine with Compare Block A/B for fast differential checks.'
                    ]
                },
                ruleG1: {
                    title: 'Control Logic DSL Mode',
                    overview: 'Rule expressions (G1/G2/G3) define control gate behavior and affect closed-loop decision states.',
                    options: [
                        { mode: 'Default Rule Set', use: 'Stable baseline logic.', impact: 'Predictable gate behavior aligned with default guardrails.' },
                        { mode: 'Custom Rule Set', use: 'Tailored policy or experiment logic.', impact: 'Can open/close gates earlier and shift risk/KPI outcome.' }
                    ],
                    tips: [
                        'Edit rules incrementally and validate with self-test.',
                        'Keep hard constraints in sync with custom gate logic.',
                        'Record rule changes in change log before export.'
                    ]
                },
                paretoSamples: {
                    title: 'Pareto Frontier Mode',
                    overview: 'Sample count controls breadth of multi-objective exploration for PUE vs OPEX tradeoff frontier.',
                    options: [
                        { mode: 'Lower Sample Count', use: 'Fast rough exploration.', impact: 'Lower compute time, coarser frontier.' },
                        { mode: 'Higher Sample Count', use: 'Detailed tradeoff mapping.', impact: 'Higher compute cost, better frontier fidelity.' }
                    ],
                    tips: [
                        'Use 200-600 for quick iteration.',
                        'Use 800+ before decision review.',
                        'Always inspect feasibility flags, not just best objective point.'
                    ]
                },
                mcUncertainty: {
                    title: 'Monte Carlo Uncertainty Mode',
                    overview: 'Defines perturbation width around inputs for uncertainty propagation and robustness checks.',
                    options: [
                        { mode: 'Lower Uncertainty (%)', use: 'Stable operations with high data confidence.', impact: 'Narrower P10/P90 spread.' },
                        { mode: 'Higher Uncertainty (%)', use: 'Volatile or uncertain assumptions.', impact: 'Wider output distribution and risk spread.' }
                    ],
                    tips: [
                        'Pair uncertainty level with realistic data quality confidence.',
                        'Increase sample count when using high uncertainty settings.',
                        'Use P90 outputs for conservative governance decisions.'
                    ]
                },
                scenarioSelect: {
                    title: 'Scenario Manager Mode',
                    overview: 'Scenario manager provides versioned snapshots for load/compare/delete workflow.',
                    options: [
                        { mode: 'Save Snapshot', use: 'Preserve current model state for traceability.', impact: 'Stores input/rule/constraint context with version stamp.' },
                        { mode: 'Load Snapshot', use: 'Restore previous scenario for replay.', impact: 'Replaces current input state with selected snapshot.' },
                        { mode: 'Delete Snapshot', use: 'Clean stale versions.', impact: 'Removes selected scenario entry from local store.' }
                    ],
                    tips: [
                        'Name scenarios with clear context and revision (e.g., site-mode-v2).',
                        'Use scenario compare before final export decisions.',
                        'Avoid deleting snapshots used in published reports.'
                    ]
                },
                refreshLedger: {
                    title: 'Assumption Ledger Mode',
                    overview: 'Assumption ledger tracks data provenance ownership and confidence for governance/audit context.',
                    options: [
                        { mode: 'Refresh Timestamps', use: 'Update governance freshness metadata.', impact: 'All ledger timestamp values are renewed.' }
                    ],
                    tips: [
                        'Refresh ledger before generating formal reports.',
                        'Maintain owner and confidence discipline across key parameters.',
                        'Use ledger as audit artifact during review and sign-off.'
                    ]
                },
                runCalc: {
                    title: 'Run High-Fidelity Model',
                    overview: 'Executes full deterministic solve from current input vector and updates all KPI, diagrams, and matrices.',
                    options: [
                        { mode: 'Run Now', use: 'After any major parameter edit.', impact: 'Baseline model state is recalculated across all modules.' }
                    ],
                    tips: [
                        'Use this as your primary solve button before optimization/export.',
                        'Run once after toggling failure mode or constraint envelope.',
                        'Treat this as source of truth snapshot for current form state.'
                    ]
                },
                optimizeTarget: {
                    title: 'Optimize To Target',
                    overview: 'Runs multi-stage optimization search to improve KPI toward target PUE/COP while respecting guardrails.',
                    options: [
                        { mode: 'Optimization Run', use: 'When you need better target convergence.', impact: 'Creates optimized model and target action deltas.' }
                    ],
                    tips: [
                        'Set constraints and mode first, then run optimizer.',
                        'Review feasibility and risk after optimization, not KPI only.',
                        'Use compare and Sankey views to validate improvement quality.'
                    ]
                },
                resetCalc: {
                    title: 'Reset Model Inputs',
                    overview: 'Restores default inputs, clears transient states, and reruns base model.',
                    options: [
                        { mode: 'Reset', use: 'When scenario diverges too far or after testing.', impact: 'All current unsaved settings are replaced by defaults.' }
                    ],
                    tips: [
                        'Save scenario snapshot first if you may need current setup again.',
                        'Reset is useful before demos and clean validation runs.',
                        'Always confirm source selection before PDF export after reset.'
                    ]
                },
                detectTelemetryCols: {
                    title: 'Detect Telemetry Columns',
                    overview: 'Scans pasted/file CSV headers and proposes auto-mapping for KPI and operational fields.',
                    options: [
                        { mode: 'Auto Detect', use: 'Before parsing telemetry import.', impact: 'Mapping dropdowns populate with detected candidates.' }
                    ],
                    tips: [
                        'Run detect first, then verify each mapped field manually.',
                        'Use custom mapping overrides for ambiguous column names.',
                        'Re-run detect after changing CSV source.'
                    ]
                },
                applyTelemetryCsv: {
                    title: 'Parse + Apply Telemetry',
                    overview: 'Parses telemetry dataset, computes aggregated targets, and applies calibration context (and optional input updates).',
                    options: [
                        { mode: 'Apply Import', use: 'After mapping validation.', impact: 'Calibration targets and optional operational inputs are updated.' }
                    ],
                    tips: [
                        'Choose aggregation mode before applying.',
                        'Enable operational field apply only with trusted data.',
                        'Re-run model and calibration after telemetry apply.'
                    ]
                },
                loadTelemetryTemplate: {
                    title: 'Load CSV Template',
                    overview: 'Loads reference template structure for telemetry import formatting.',
                    options: [
                        { mode: 'Template', use: 'When preparing telemetry files.', impact: 'Provides expected header schema for easier mapping.' }
                    ],
                    tips: [
                        'Use template to reduce mapping ambiguity.',
                        'Keep unit conventions consistent with model expectations.',
                        'Add timestamp column for traceability.'
                    ]
                },
                runCalibration: {
                    title: 'Run Calibration Fit',
                    overview: 'Tunes selected model coefficients to minimize error against measured KPI targets.',
                    options: [
                        { mode: 'Calibration Fit', use: 'When telemetry targets are available.', impact: 'Generates calibrated optimized state and fit metrics.' }
                    ],
                    tips: [
                        'Provide at least two measured KPI targets.',
                        'Use lock-apply option carefully to write tuned coefficients into form.',
                        'Review calibration quality and residual plausibility before acceptance.'
                    ]
                },
                clearCalibration: {
                    title: 'Clear Calibration Targets',
                    overview: 'Clears calibration target fields and import mapping cache state.',
                    options: [
                        { mode: 'Clear', use: 'Reset calibration workflow.', impact: 'Telemetry calibration context is removed.' }
                    ],
                    tips: [
                        'Clear before switching to a different telemetry dataset.',
                        'Run model again after clear to verify baseline state.',
                        'Keep exported reports tagged with calibration status.'
                    ]
                },
                applyConstraintBtn: {
                    title: 'Apply Constraint Set',
                    overview: 'Applies current hard/soft constraint settings and reruns consistency checks.',
                    options: [
                        { mode: 'Apply', use: 'After editing any constraint threshold.', impact: 'Constraint status and feasibility outputs refresh immediately.' }
                    ],
                    tips: [
                        'Use hard mode for final governance.',
                        'Check pump%IT and risk thresholds after apply.',
                        'Re-optimize if constraints materially changed.'
                    ]
                },
                applyRulesBtn: {
                    title: 'Apply Rule Set',
                    overview: 'Compiles and activates current G1/G2/G3 DSL expressions for control gate evaluation.',
                    options: [
                        { mode: 'Apply Rules', use: 'After editing control DSL expressions.', impact: 'Gate logic updates in diagrams and decision chain.' }
                    ],
                    tips: [
                        'Validate syntax and semantics before apply.',
                        'Run self-test after rule changes.',
                        'Track rule revisions in scenario/version notes.'
                    ]
                },
                resetRulesBtn: {
                    title: 'Reset Default Rules',
                    overview: 'Restores control gate DSL expressions to default baseline logic.',
                    options: [
                        { mode: 'Reset Rules', use: 'Recover from unstable or experimental custom logic.', impact: 'G1/G2/G3 revert to default expressions.' }
                    ],
                    tips: [
                        'Use this when custom rules produce unexpected behavior.',
                        'Re-run model to refresh gate results after reset.',
                        'Save custom rules in scenario before reset if needed.'
                    ]
                },
                runPareto: {
                    title: 'Generate Pareto Frontier',
                    overview: 'Runs multi-objective sampling and extracts non-dominated PUE vs OPEX tradeoff frontier.',
                    options: [
                        { mode: 'Frontier Run', use: 'Design-option tradeoff analysis.', impact: 'Populates Pareto table/scatter and feasibility tags.' }
                    ],
                    tips: [
                        'Increase sample count for sharper frontier.',
                        'Inspect feasibility and risk class before selecting best point.',
                        'Use selected point apply to propagate into full model state.'
                    ]
                },
                applyParetoBest: {
                    title: 'Apply Best Feasible Pareto Point',
                    overview: 'Applies selected feasible Pareto candidate (or best available) to input state.',
                    options: [
                        { mode: 'Apply Best', use: 'Quickly move to tradeoff-optimal candidate.', impact: 'Form/model update to selected Pareto point inputs.' }
                    ],
                    tips: [
                        'Generate Pareto first.',
                        'Manually inspect chosen point metrics before finalizing.',
                        'Re-check constraints and degraded mode after apply.'
                    ]
                },
                runMonteCarlo: {
                    title: 'Run Monte Carlo',
                    overview: 'Performs uncertainty propagation around current inputs and outputs P10/P50/P90 envelopes.',
                    options: [
                        { mode: 'MC Run', use: 'Robustness assessment under input uncertainty.', impact: 'Distribution charts and percentile table are generated.' }
                    ],
                    tips: [
                        'Set uncertainty and sample count before run.',
                        'Use P90 for conservative planning decisions.',
                        'Re-run after major architecture/control changes.'
                    ]
                },
                runSelfTest: {
                    title: 'Run Model Self-Test',
                    overview: 'Executes deterministic fixture/regression checks on model behavior.',
                    options: [
                        { mode: 'Self-Test', use: 'After major logic/UI/rule changes.', impact: 'Pass/fail diagnostics with detail are produced.' }
                    ],
                    tips: [
                        'Run before releasing/reporting model changes.',
                        'Investigate any failed case before export.',
                        'Use together with scenario snapshots for reproducible QA.'
                    ]
                },
                saveScenarioBtn: {
                    title: 'Save Scenario Snapshot',
                    overview: 'Stores current model context (inputs/constraints/rules) as versioned scenario.',
                    options: [
                        { mode: 'Save', use: 'Capture milestone configuration.', impact: 'Scenario added to manager and source selectors.' }
                    ],
                    tips: [
                        'Use clear naming convention and version suffix.',
                        'Save before risky edits or optimization experiments.',
                        'Use saved snapshots for compare PDF provenance.'
                    ]
                },
                loadScenarioBtn: {
                    title: 'Load Selected Scenario',
                    overview: 'Loads scenario snapshot back into active form/model.',
                    options: [
                        { mode: 'Load', use: 'Replay previously saved configuration.', impact: 'Current state replaced with selected snapshot.' }
                    ],
                    tips: [
                        'Confirm selected scenario before loading.',
                        'Run model immediately after load for fresh outputs.',
                        'Compare against current state before overwriting if needed.'
                    ]
                },
                deleteScenarioBtn: {
                    title: 'Delete Selected Scenario',
                    overview: 'Removes selected scenario snapshot from local manager.',
                    options: [
                        { mode: 'Delete', use: 'Clean obsolete scenario versions.', impact: 'Scenario entry permanently removed from local store.' }
                    ],
                    tips: [
                        'Avoid deleting scenarios referenced in reports.',
                        'Export key scenario context before deletion if required.',
                        'Prefer archiving naming over deletion during active projects.'
                    ]
                },
                exportExecutive: {
                    title: 'Export Executive Pack',
                    overview: 'Exports concise management-focused report pack from current model state.',
                    options: [
                        { mode: 'Executive Pack', use: 'Leadership/board summary communication.', impact: 'Produces short high-level text artifact.' }
                    ],
                    tips: [
                        'Run model first to avoid stale outputs.',
                        'Pair with single PDF for detailed engineering appendix.',
                        'Include scenario/version name in distribution note.'
                    ]
                },
                exportEngineering: {
                    title: 'Export Engineering Pack',
                    overview: 'Exports technical deep-dive text pack with more model details.',
                    options: [
                        { mode: 'Engineering Pack', use: 'Technical review and handover.', impact: 'Produces detail-oriented text artifact.' }
                    ],
                    tips: [
                        'Use after calibration/optimization convergence.',
                        'Attach rule set and constraint context when sharing.',
                        'Keep with scenario snapshot for reproducibility.'
                    ]
                },
                exportPdfSingle: {
                    title: 'Export PDF (Single)',
                    overview: 'Generates full print-ready single-source engineering report.',
                    options: [
                        { mode: 'Single PDF', use: 'Formal documentation of one scenario/model source.', impact: 'Opens print tab for Save-as-PDF output.' }
                    ],
                    tips: [
                        'Choose correct single source before export.',
                        'Allow popup in browser.',
                        'Check report timestamp and source label in header.'
                    ]
                },
                exportPdfCompare: {
                    title: 'Export PDF (Compare)',
                    overview: 'Generates full print-ready compare report between two sources.',
                    options: [
                        { mode: 'Compare PDF', use: 'Option tradeoff decision documentation.', impact: 'Opens compare delta report for Save-as-PDF output.' }
                    ],
                    tips: [
                        'Ensure left and right sources are different.',
                        'Use baseline-left / optimized-right for readability.',
                        'Review constraint status and recommendation section before distribution.'
                    ]
                },
                explorerExpandAll: {
                    title: 'Explorer Controls',
                    overview: 'Explorer actions help inspect all modeling blocks in detail and run diagnostics/export.',
                    options: [
                        { mode: 'Expand/Collapse All', use: 'Batch open or close block details.', impact: 'Changes explorer readability and navigation speed.' },
                        { mode: 'Focus Explorer', use: 'Prioritize explorer workspace.', impact: 'UI focus shifts toward explorer analysis section.' },
                        { mode: 'Export/Diagnostics', use: 'Generate block-level artifacts or checks.', impact: 'Produces JSON/report or runs diagnostics output.' }
                    ],
                    tips: [
                        'Use with single-open mode for structured walkthroughs.',
                        'Run diagnostics after major UI/model edits.',
                        'Export block report for design review documentation.'
                    ]
                }
            };
            var selectedScenarioIdx = -1;
            var autoRunEnabled = true;
            var autoRunDebounceMs = 220;
            var autoRunTimer = null;
            var showAdvancedInputs = false;
            var layoutSplitPercent = 42;
            var uiPrefs = loadUiPrefs();

            function loadUiPrefs() {
                try {
                    var raw = localStorage.getItem(UI_PREF_STORE_KEY);
                    if (!raw) return {};
                    var parsed = JSON.parse(raw);
                    return parsed && typeof parsed === 'object' ? parsed : {};
                } catch (e) {
                    return {};
                }
            }

            function loadExplorerState() {
                var defaults = {
                    mode: 'single',
                    focus: false,
                    openBlocks: ['input'],
                    notes: {},
                    checks: {},
                    usage: {},
                    lastActive: 'input',
                    pinned: ''
                };
                try {
                    var raw = localStorage.getItem(EXPLORER_STORE_KEY);
                    if (!raw) return defaults;
                    var parsed = JSON.parse(raw);
                    if (!parsed || typeof parsed !== 'object') return defaults;
                    return {
                        mode: parsed.mode === 'multi' ? 'multi' : 'single',
                        focus: !!parsed.focus,
                        openBlocks: Array.isArray(parsed.openBlocks) && parsed.openBlocks.length ? parsed.openBlocks.slice(0, 6) : defaults.openBlocks,
                        notes: parsed.notes && typeof parsed.notes === 'object' ? parsed.notes : {},
                        checks: parsed.checks && typeof parsed.checks === 'object' ? parsed.checks : {},
                        usage: parsed.usage && typeof parsed.usage === 'object' ? parsed.usage : {},
                        lastActive: parsed.lastActive || defaults.lastActive,
                        pinned: parsed.pinned || ''
                    };
                } catch (e) {
                    return defaults;
                }
            }

            function saveExplorerState() {
                try {
                    localStorage.setItem(EXPLORER_STORE_KEY, JSON.stringify({
                        mode: explorerState.mode,
                        focus: explorerState.focus,
                        openBlocks: explorerState.openBlocks,
                        notes: explorerState.notes,
                        checks: explorerState.checks,
                        usage: explorerState.usage,
                        lastActive: explorerState.lastActive,
                        pinned: explorerState.pinned || ''
                    }));
                } catch (e) {}
            }

            function saveUiPrefs() {
                try {
                    localStorage.setItem(UI_PREF_STORE_KEY, JSON.stringify({
                        showAdvancedInputs: showAdvancedInputs,
                        layoutSplitPercent: layoutSplitPercent
                    }));
                } catch (e) {}
            }

            function n(id) {
                var el = document.getElementById(id);
                if (!el) return 0;
                return parseFloat(el.value || '0');
            }

            function maybeNum(id, minValue) {
                var el = document.getElementById(id);
                if (!el) return null;
                var raw = String(el.value || '').trim();
                if (!raw) return null;
                var value = parseFloat(raw);
                if (!isFinite(value)) return null;
                if (minValue !== undefined && value < minValue) return null;
                return value;
            }

            function clamp(v, min, max) {
                return Math.max(min, Math.min(max, v));
            }

            function setText(id, value) {
                var el = document.getElementById(id);
                if (el) el.textContent = value;
            }

            function setBar(id, value) {
                var el = document.getElementById(id);
                if (!el) return;
                el.style.width = clamp(value, 0, 100) + '%';
            }

            function setGateState(polyId, isOk) {
                var poly = document.getElementById(polyId);
                if (!poly) return;
                poly.classList.remove('ok', 'warn');
                poly.classList.add(isOk ? 'ok' : 'warn');
            }

            function nowIso() {
                return new Date().toISOString().replace('T', ' ').slice(0, 19) + ' UTC';
            }

            function gatherConstraintState() {
                return {
                    pueMax: Math.max(n('conPueMax'), 1.01),
                    copMin: Math.max(n('conCopMin'), 0.5),
                    riskMax: clamp(n('conRiskMax'), 1, 100),
                    pumpPctMax: Math.max(n('conPumpPctMax'), 0.5),
                    enforce: (document.getElementById('conEnforce').value === 'yes')
                };
            }

            function evaluateHardConstraints(model, constraints) {
                var pumpPctIt = (model.pumpPowerKw / Math.max(model.itKw, 1)) * 100;
                var issues = [];
                if (model.pue > constraints.pueMax) issues.push('PUE > max');
                if (model.systemCop < constraints.copMin) issues.push('COP < min');
                if (model.riskIndex > constraints.riskMax) issues.push('Risk > max');
                if (pumpPctIt > constraints.pumpPctMax) issues.push('Pump%IT > max');
                return { feasible: issues.length === 0, issues: issues, pumpPctIt: pumpPctIt };
            }

            function evaluateInputHardRules(input, model, constraints) {
                var hardStops = [];
                var warnings = [];
                var delta = input.returnTemp - input.supplyTemp;

                if (!isFinite(delta)) {
                    hardStops.push('Invalid supply/return temperature values.');
                } else {
                    if (input.returnTemp <= input.supplyTemp) hardStops.push('Return temperature must be higher than supply temperature.');
                    if (delta < 3) hardStops.push('Liquid delta-T below 3C is outside hard guardrail.');
                    else if (delta < 6) warnings.push('Liquid delta-T ' + fmtNum(delta, 1) + 'C is low; typical design screening targets >=6C.');
                }

                if (input.pumpEff < 45) hardStops.push('Pump efficiency below 45% is outside accepted operational envelope.');
                else if (input.pumpEff < 65) warnings.push('Pump efficiency below 65% can overstate pump energy and distort optimization trade-offs.');

                if (input.predictiveGain > 35 && input.monitoring < 35) {
                    hardStops.push('Predictive gain above 35% with monitoring below 35% is not admissible.');
                } else if (input.predictiveGain > 35 && input.monitoring < 80) {
                    warnings.push('High predictive effectiveness with monitoring <80% may be optimistic for real operations.');
                }

                if (input.architectureMode === 'direct_liquid' && input.liquidCapture < 40) {
                    hardStops.push('Direct liquid architecture requires liquid capture >=40% for valid optimization envelope.');
                }
                if (input.architectureMode === 'direct_liquid' && input.supplyTemp < 26) {
                    warnings.push('Direct liquid warm-water mode usually runs liquid supply around high-20s to low-30s C.');
                }
                if (input.architectureMode === 'air_inrow_dahu' && input.liquidCapture > 35) {
                    warnings.push('Air/in-row profile with liquid capture above 35% is atypical; re-check architecture intent.');
                }
                if (input.fanPower > 5 && input.liquidCapture > 80) {
                    warnings.push('Fan power >5% IT while liquid capture >80% is unusual; validate facility airflow assumption.');
                }

                if (constraints && constraints.enforce) {
                    if (constraints.copMin > input.targetCop + 1.5) warnings.push('Hard COP minimum is much tighter than target COP; feasible search region may collapse.');
                    if (constraints.pueMax < input.targetPue - 0.06) warnings.push('Hard PUE maximum is tighter than target PUE by >0.06; feasible search region may collapse.');
                }

                if (model) {
                    if (model.pue < 1.07) warnings.push('Projected PUE below 1.07 is very aggressive; verify loss assumptions and boundary conditions.');
                    if (model.systemCop < 3.5) warnings.push('System COP is low for modern liquid-assisted systems; review thermal/hydraulic controls.');
                    if (model.riskIndex > 50) warnings.push('Risk index above 50 indicates significant resilience/safety pressure in current setup.');
                    if (model.riskIndex > 70) hardStops.push('Risk index above 70 is blocked for optimizer and stochastic engines.');
                    if (model.pue > 1.75) hardStops.push('Projected PUE above 1.75 is outside supported optimization envelope.');
                }

                return {
                    blocked: hardStops.length > 0,
                    hardStops: hardStops,
                    warnings: warnings
                };
            }

            function enforceActionGuard(actionLabel) {
                var input = gatherInputs();
                var model = computeModel(input);
                var constraints = gatherConstraintState();
                var guard = evaluateInputHardRules(input, model, constraints);
                if (!guard.blocked) return true;

                var status = document.getElementById('inputQualityStatus');
                var list = document.getElementById('inputQualityList');
                if (status) {
                    status.className = 'status-pill err';
                    status.textContent = 'Hard-Stop Active';
                }
                if (list) {
                    var rows = guard.hardStops.map(function(t) {
                        return '<li class="err">' + escapeHtml('Hard-stop: ' + t) + '</li>';
                    }).concat(guard.warnings.map(function(t) {
                        return '<li class="warn">' + escapeHtml(t) + '</li>';
                    }));
                    list.innerHTML = rows.join('');
                }

                alert(actionLabel + ' blocked by hard guardrails:\n- ' + guard.hardStops.join('\n- '));
                return false;
            }

            function normalizeTelemetryHeader(value) {
                return String(value || '')
                    .toLowerCase()
                    .trim()
                    .replace(/[^a-z0-9]+/g, '_')
                    .replace(/^_+|_+$/g, '');
            }

            function splitCsvRow(line) {
                var cells = [];
                var cur = '';
                var inQuote = false;
                var src = String(line || '');
                for (var i = 0; i < src.length; i++) {
                    var ch = src.charAt(i);
                    if (ch === '"') {
                        if (inQuote && src.charAt(i + 1) === '"') {
                            cur += '"';
                            i += 1;
                        } else {
                            inQuote = !inQuote;
                        }
                    } else if (ch === ',' && !inQuote) {
                        cells.push(cur);
                        cur = '';
                    } else {
                        cur += ch;
                    }
                }
                cells.push(cur);
                return cells;
            }

            function findTelemetryColumn(headers, aliases) {
                if (!headers || !aliases) return null;
                for (var i = 0; i < aliases.length; i++) {
                    if (headers.indexOf(aliases[i]) >= 0) return aliases[i];
                }
                for (var h = 0; h < headers.length; h++) {
                    var head = headers[h];
                    for (var j = 0; j < aliases.length; j++) {
                        if (head.indexOf(aliases[j]) >= 0 || aliases[j].indexOf(head) >= 0) return head;
                    }
                }
                return null;
            }

            function parseTelemetryCsv(raw) {
                var text = String(raw || '').replace(/\uFEFF/g, '').trim();
                if (!text) return { ok: false, error: 'Telemetry source is empty.' };
                var lines = text.split(/\r?\n/).filter(function(line) { return String(line || '').trim().length > 0; });
                if (lines.length < 2) return { ok: false, error: 'Telemetry CSV needs header + at least one data row.' };

                var first = splitCsvRow(lines[0]);
                var seen = {};
                var headers = first.map(function(h, idx) {
                    var norm = normalizeTelemetryHeader(h) || ('col_' + idx);
                    if (seen[norm]) norm = norm + '_' + idx;
                    seen[norm] = true;
                    return norm;
                });

                var rows = [];
                for (var i = 1; i < lines.length; i++) {
                    var cells = splitCsvRow(lines[i]);
                    var nonEmpty = false;
                    var row = {};
                    for (var c = 0; c < headers.length; c++) {
                        var value = String(cells[c] == null ? '' : cells[c]).trim();
                        if (value !== '') nonEmpty = true;
                        row[headers[c]] = value;
                    }
                    if (nonEmpty) rows.push(row);
                }
                if (!rows.length) return { ok: false, error: 'Telemetry CSV has no usable data rows.' };

                var mapped = {};
                Object.keys(TELEMETRY_ALIAS_MAP).forEach(function(key) {
                    mapped[key] = findTelemetryColumn(headers, TELEMETRY_ALIAS_MAP[key]);
                });

                return {
                    ok: true,
                    rows: rows,
                    headers: headers,
                    mapped: mapped
                };
            }

            function telemetryNumericSeries(rows, column) {
                var out = [];
                if (!column) return out;
                rows.forEach(function(row) {
                    var raw = row[column];
                    if (raw === undefined || raw === null || raw === '') return;
                    var num = parseFloat(String(raw).replace(/,/g, ''));
                    if (isFinite(num)) out.push(num);
                });
                return out;
            }

            function telemetryMean(values) {
                if (!values || !values.length) return null;
                return values.reduce(function(sum, v) { return sum + v; }, 0) / values.length;
            }

            function toInputFixed(value, digits) {
                var nVal = Number(value);
                if (!isFinite(nVal)) return '';
                return nVal.toFixed(Math.max(0, digits || 0));
            }

            function setTelemetryImportStatus(state, text) {
                var pill = document.getElementById('telemetryImportStatusPill');
                var detail = document.getElementById('telemetryImportStatus');
                if (pill) {
                    if (state === 'ok') pill.className = 'status-pill ok';
                    else if (state === 'warn') pill.className = 'status-pill warn';
                    else if (state === 'err') pill.className = 'status-pill err';
                    else pill.className = 'status-pill';
                    pill.textContent = state === 'ok' ? 'Applied' : state === 'warn' ? 'Partial' : state === 'err' ? 'Failed' : 'Idle';
                }
                if (detail) detail.textContent = text || 'Telemetry import idle. Provide CSV via file or paste area, then run parse.';
            }

            function setTelemetryImportMeta(text) {
                var meta = document.getElementById('telemetryImportMeta');
                if (!meta) return;
                meta.textContent = text || 'Column mapping not detected yet. Click "Detect Columns" to preview and override mapping.';
            }

            function telemetryWindowRows() {
                var el = document.getElementById('telemetryWindowRows');
                var val = el ? parseInt(el.value, 10) : 0;
                return isFinite(val) && val > 0 ? val : 0;
            }

            function telemetryAggregationMode() {
                var el = document.getElementById('telemetryAggMode');
                var mode = el ? String(el.value || 'mean') : 'mean';
                if (['mean', 'p50', 'p90', 'latest'].indexOf(mode) === -1) return 'mean';
                return mode;
            }

            function telemetryAggregate(series, mode, windowRows) {
                if (!series || !series.length) return null;
                var arr = series.slice();
                if (windowRows > 0 && arr.length > windowRows) {
                    arr = arr.slice(arr.length - windowRows);
                }
                if (!arr.length) return null;
                if (mode === 'latest') return arr[arr.length - 1];
                if (mode === 'mean') return telemetryMean(arr);
                var sorted = arr.slice().sort(function(a, b) { return a - b; });
                if (mode === 'p50') return percentile(sorted, 0.5);
                if (mode === 'p90') return percentile(sorted, 0.9);
                return telemetryMean(arr);
            }

            function manualTelemetryColumn(metricKey, autoMapped) {
                var selectId = TELEMETRY_MANUAL_SELECT_ID[metricKey];
                var sel = selectId ? document.getElementById(selectId) : null;
                var val = sel ? String(sel.value || '__auto__') : '__auto__';
                if (val === '__none__') return null;
                if (val && val !== '__auto__') return val;
                return autoMapped && autoMapped[metricKey] ? autoMapped[metricKey] : null;
            }

            function populateTelemetryColumnSelectors(parsed) {
                if (!parsed || !parsed.headers) return;
                var headers = parsed.headers.slice();
                Object.keys(TELEMETRY_MANUAL_SELECT_ID).forEach(function(metricKey) {
                    var selectId = TELEMETRY_MANUAL_SELECT_ID[metricKey];
                    var sel = document.getElementById(selectId);
                    if (!sel) return;
                    var prior = String(sel.value || '__auto__');
                    var autoCandidate = parsed.mapped && parsed.mapped[metricKey] ? parsed.mapped[metricKey] : '';
                    var autoLabel = autoCandidate ? ('Auto Detect (' + autoCandidate + ')') : 'Auto Detect';
                    var options = ['<option value="__auto__">' + escapeHtml(autoLabel) + '</option>', '<option value="__none__">Do Not Map</option>'];
                    headers.forEach(function(h) {
                        options.push('<option value="' + escapeAttr(h) + '">' + escapeHtml(h) + '</option>');
                    });
                    sel.innerHTML = options.join('');
                    if (prior && (prior === '__auto__' || prior === '__none__' || headers.indexOf(prior) >= 0)) sel.value = prior;
                    else sel.value = '__auto__';
                });
            }

            function detectTelemetryColumns() {
                setTelemetryImportStatus('warn', 'Detecting telemetry columns...');
                readTelemetrySource(function(err, raw, sourceLabel) {
                    if (err) {
                        setTelemetryImportStatus('err', 'Telemetry source not found. Paste CSV text or choose a CSV file first.');
                        return;
                    }
                    var parsed = parseTelemetryCsv(raw);
                    if (!parsed.ok) {
                        setTelemetryImportStatus('err', parsed.error);
                        return;
                    }
                    latestTelemetryParsed = parsed;
                    populateTelemetryColumnSelectors(parsed);
                    var detected = Object.keys(parsed.mapped).filter(function(k) { return !!parsed.mapped[k]; });
                    var lines = [];
                    lines.push('Source: ' + sourceLabel + ' | rows=' + parsed.rows.length + ' | headers=' + parsed.headers.length);
                    lines.push('Detected aliases: ' + (detected.length ? detected.join(', ') : 'none'));
                    lines.push('You can override each mapping from dropdowns before apply.');
                    setTelemetryImportMeta('Headers: ' + parsed.headers.join(', '));
                    setTelemetryImportStatus('warn', lines.join('\n'));
                });
            }

            function loadTelemetryTemplate() {
                var area = document.getElementById('telemetryPaste');
                if (!area) return;
                latestTelemetryParsed = null;
                area.value = [
                    'timestamp,pue,cop,annual_energy_gwh,net_opex,carbon,pump_kw,liquid_capture,pump_eff,fan_power,monitoring',
                    '2026-02-01T00:00:00Z,1.278,5.41,136.9,14150961,53700,187.9,84,78,3.1,91',
                    '2026-02-01T01:00:00Z,1.281,5.36,137.1,14198944,53820,188.6,84,78,3.1,91',
                    '2026-02-01T02:00:00Z,1.276,5.43,136.6,14088210,53540,187.2,85,79,3.0,92'
                ].join('\n');
                setTelemetryImportMeta('Template loaded. Click "Detect Columns" to preview mapping, then "Parse + Apply Telemetry".');
                setTelemetryImportStatus('warn', 'Template loaded into paste area. Review/replace values, then click "Detect Columns" or "Parse + Apply Telemetry".');
            }

            function readTelemetrySource(callback) {
                var pasteEl = document.getElementById('telemetryPaste');
                var fileEl = document.getElementById('telemetryFile');
                var pasted = pasteEl ? String(pasteEl.value || '').trim() : '';
                if (pasted) {
                    callback(null, pasted, 'paste');
                    return;
                }
                var file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
                if (!file) {
                    callback(new Error('missing_source'));
                    return;
                }
                var reader = new FileReader();
                reader.onload = function() {
                    callback(null, String(reader.result || ''), 'file:' + file.name);
                };
                reader.onerror = function() {
                    callback(new Error('read_failed'));
                };
                reader.readAsText(file);
            }

            function applyTelemetryCsvImport() {
                setTelemetryImportStatus('warn', 'Parsing telemetry source...');
                readTelemetrySource(function(err, raw, sourceLabel) {
                    if (err) {
                        setTelemetryImportStatus('err', 'Telemetry source not found. Paste CSV text or choose a CSV file first.');
                        return;
                    }
                    var parsed = parseTelemetryCsv(raw);
                    if (!parsed.ok) {
                        setTelemetryImportStatus('err', parsed.error);
                        return;
                    }

                    latestTelemetryParsed = parsed;
                    populateTelemetryColumnSelectors(parsed);
                    var aggMode = telemetryAggregationMode();
                    var windowRows = telemetryWindowRows();

                    var mapped = parsed.mapped;
                    var calApplied = [];
                    Object.keys(TELEMETRY_CAL_TARGET_MAP).forEach(function(metricKey) {
                        var col = manualTelemetryColumn(metricKey, mapped);
                        var series = telemetryNumericSeries(parsed.rows, col);
                        var aggVal = telemetryAggregate(series, aggMode, windowRows);
                        if (!isFinite(aggVal)) return;
                        var fieldId = TELEMETRY_CAL_TARGET_MAP[metricKey];
                        var targetEl = document.getElementById(fieldId);
                        if (!targetEl) return;
                        targetEl.value = toInputFixed(aggVal, TELEMETRY_DIGITS[fieldId]);
                        calApplied.push(fieldId + ' <= ' + col + ' (' + aggMode + ')');
                    });

                    var opApplied = [];
                    var applyOps = !!(document.getElementById('telemetryApplyInputs') && document.getElementById('telemetryApplyInputs').checked);
                    if (applyOps) {
                        Object.keys(TELEMETRY_OPERATIONAL_MAP).forEach(function(metricKey) {
                            var col = manualTelemetryColumn(metricKey, mapped);
                            var series = telemetryNumericSeries(parsed.rows, col);
                            var aggVal = telemetryAggregate(series, aggMode, windowRows);
                            if (!isFinite(aggVal)) return;
                            var fieldId = TELEMETRY_OPERATIONAL_MAP[metricKey];
                            var inputEl = document.getElementById(fieldId);
                            if (!inputEl) return;
                            inputEl.value = toInputFixed(aggVal, TELEMETRY_DIGITS[fieldId]);
                            opApplied.push(fieldId + ' <= ' + col + ' (' + aggMode + ')');
                        });
                    }

                    var recognized = Object.keys(mapped).filter(function(k) { return !!mapped[k]; });
                    var lines = [];
                    lines.push('Source: ' + sourceLabel + ' | rows=' + parsed.rows.length + ' | recognized columns=' + recognized.length);
                    lines.push('Aggregation: ' + aggMode + ' | windowRows=' + (windowRows || 'all'));
                    lines.push('Calibration fields applied: ' + (calApplied.length ? calApplied.join(', ') : 'none'));
                    lines.push('Operational fields applied: ' + (opApplied.length ? opApplied.join(', ') : 'none'));

                    if (!calApplied.length && !opApplied.length) {
                        setTelemetryImportStatus('err', lines.join('\n') + '\nNo compatible numeric columns found.');
                        return;
                    }

                    setTelemetryImportMeta('Headers: ' + parsed.headers.join(', '));
                    var status = (calApplied.length >= 2) ? 'ok' : 'warn';
                    setTelemetryImportStatus(status, lines.join('\n'));
                    requestModelRun(true, true);
                });
            }

            function buildRuleContext(model) {
                return {
                    monitoring: model.input.monitoring,
                    controlIndex: model.controlIndex,
                    deltaT: model.deltaT,
                    pumpPowerPctIt: (model.pumpPowerKw / Math.max(model.itKw, 1)) * 100,
                    riskIndex: model.riskIndex,
                    pue: model.pue,
                    targetPue: model.input.targetPue,
                    cop: model.systemCop,
                    targetCop: model.input.targetCop
                };
            }

            function evaluateRuleExpression(expr, ctx) {
                var raw = String(expr || '').trim();
                if (!raw) return { ok: false, error: 'empty rule' };
                if (!/^[a-zA-Z0-9_().<>=!&|+\-*/%\s]+$/.test(raw)) {
                    return { ok: false, error: 'invalid character in rule' };
                }
                var blocked = ['window', 'document', 'localStorage', 'sessionStorage', 'fetch', 'constructor', 'Function', 'eval', 'this'];
                for (var i = 0; i < blocked.length; i++) {
                    if (raw.indexOf(blocked[i]) !== -1) return { ok: false, error: 'blocked token: ' + blocked[i] };
                }
                try {
                    var fn = new Function('v', 'with(v){ return !!(' + raw + '); }');
                    return { ok: true, value: !!fn(ctx) };
                } catch (e) {
                    return { ok: false, error: 'parse error' };
                }
            }

            function evaluateGateStates(model) {
                var ctx = buildRuleContext(model);
                var r1 = evaluateRuleExpression(gateRules.g1, ctx);
                var r2 = evaluateRuleExpression(gateRules.g2, ctx);
                var r3 = evaluateRuleExpression(gateRules.g3, ctx);
                return {
                    g1: !!r1.value,
                    g2: !!r2.value,
                    g3: !!r3.value,
                    errors: [r1, r2, r3].filter(function(r) { return !r.ok; }).map(function(r) { return r.error; }),
                    ctx: ctx
                };
            }

            function fmtNum(value, digits) {
                return Number(value).toLocaleString('en-US', { maximumFractionDigits: digits, minimumFractionDigits: digits });
            }

            function fmtUsd(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    maximumFractionDigits: 0
                }).format(value);
            }

            function fmtUsdCompact(value) {
                var abs = Math.abs(value);
                if (abs >= 1000000000) return '$' + fmtNum(value / 1000000000, 2) + 'B';
                if (abs >= 1000000) return '$' + fmtNum(value / 1000000, 2) + 'M';
                if (abs >= 1000) return '$' + fmtNum(value / 1000, 1) + 'K';
                return fmtUsd(value);
            }

            function signed(value, digits, suffix) {
                var sign = value > 0 ? '+' : '';
                return sign + fmtNum(value, digits) + (suffix || '');
            }

            function escapeHtml(value) {
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function escapeAttr(value) {
                return escapeHtml(value).replace(/`/g, '&#96;');
            }

            function prettifyKey(key) {
                return String(key || '')
                    .replace(/\./g, ' ')
                    .replace(/([a-z0-9])([A-Z])/g, '$1 $2')
                    .replace(/_/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .replace(/^./, function(m) { return m.toUpperCase(); });
            }

            function resolveTooltipMeta(key, layer, fallbackTitle) {
                var normKey = String(key || '').trim();
                var leafKey = normKey.indexOf('.') >= 0 ? normKey.split('.').pop() : normKey;
                var base = PARAM_TOOLTIPS[normKey] || PARAM_TOOLTIPS[leafKey];
                var hint = BENCHMARK_HINTS[normKey] || BENCHMARK_HINTS[leafKey] || '';

                function impactHint(k, l) {
                    var nk = String(k || '').toLowerCase();
                    if (nk.indexOf('pue') >= 0 || nk.indexOf('cop') >= 0) return 'Impact: directly shifts efficiency target gap and optimization priority.';
                    if (nk.indexOf('risk') >= 0 || nk.indexOf('fire') >= 0) return 'Impact: contributes to risk and compliance posture scoring.';
                    if (nk.indexOf('carbon') >= 0 || nk.indexOf('opex') >= 0 || nk.indexOf('energy') >= 0) return 'Impact: changes economic and sustainability output envelope.';
                    if (nk.indexOf('control') >= 0 || nk.indexOf('predictive') >= 0 || nk.indexOf('monitor') >= 0) return 'Impact: changes control stability, confidence, and dynamic response.';
                    if (nk.indexOf('pump') >= 0 || nk.indexOf('flow') >= 0 || nk.indexOf('hydraulic') >= 0) return 'Impact: alters hydraulic power, auxiliary load, and overall PUE.';
                    if (l === 'input') return 'Impact: input perturbation propagates through thermal, hydraulic, cost, and compliance layers.';
                    if (l === 'processing') return 'Impact: intermediate solver state affecting downstream KPI sensitivity.';
                    return 'Impact: output KPI used for target guidance and feedback actions.';
                }

                function normalize(meta) {
                    var out = {
                        title: meta.title || prettifyKey(normKey),
                        desc: meta.desc || 'Engineering parameter for modelling chain.',
                        formula: meta.formula || ('Ref: ' + (normKey || 'model variable')),
                        impact: meta.impact || impactHint(normKey || leafKey, layer)
                    };
                    if (!/^(Benchmark:|Formula:|Ref:)/.test(out.formula)) out.formula = 'Ref: ' + out.formula;
                    if (hint) out.formula = out.formula + ' ' + hint;
                    return out;
                }

                if (base) {
                    return normalize({
                        title: fallbackTitle || base.title || prettifyKey(normKey),
                        desc: base.desc,
                        formula: base.formula
                    });
                }

                var title = fallbackTitle || prettifyKey(normKey);
                var desc = 'Parameter used in this ' + layer + ' layer of the modelling engine. Hover values to trace interactions across thermal, hydraulic, economic, and risk logic.';
                var formula = 'Ref: Internal model variable (' + (normKey || 'n/a') + ') used in live solver and traceability matrix.';
                var impact = impactHint(normKey || leafKey, layer);

                if (normKey.indexOf('scores.') === 0) {
                    desc = 'Weighted compliance score generated from standard-specific criteria and risk modifiers. Higher score indicates stronger alignment readiness.';
                    formula = 'Formula: weighted score aggregate (0-100) with risk penalties.';
                } else if (normKey.indexOf('breakdown.') === 0) {
                    desc = 'Power component contribution used to decompose total facility load and visualize energy burden distribution.';
                    formula = 'Formula: component share = component_kW / totalFacilityKw.';
                } else if (normKey.indexOf('internals.') === 0) {
                    desc = 'Internal solver state variable used by thermal-hydraulic-energy calculations before final KPI projection.';
                    formula = 'Ref: intermediate state in computeModel() dependency chain.';
                }

                if (layer === 'input') {
                    desc = 'Primary input parameter for scenario definition. This value feeds the solver directly and influences multiple downstream outputs.';
                    formula = 'Ref: input vector term consumed by computeModel() with bounds, clamps, and unit normalization.';
                } else if (layer === 'output') {
                    desc = 'Computed output KPI from the model run. This value updates whenever input, optimization, or calibration changes.';
                    formula = 'Ref: output vector value generated by computeModel() and post-processing logic.';
                } else if (layer === 'processing') {
                    desc = 'Intermediate processing variable inside thermal-hydraulic and control calculations. It links raw inputs to final KPIs.';
                    formula = 'Ref: derived in staged solver pipeline and used by downstream blocks.';
                }
                return normalize({ title: title, desc: desc, formula: formula, impact: impact });
            }

            function tooltipText(meta) {
                return meta.title + ': ' + meta.desc + ' ' + meta.formula + ' ' + (meta.impact || '');
            }

            function createTooltipTrigger(meta) {
                var trigger = document.createElement('span');
                trigger.className = 'tooltip-trigger';
                trigger.textContent = '?';
                trigger.setAttribute('aria-label', 'Tooltip for ' + meta.title);
                trigger.setAttribute('tabindex', '0');

                var content = document.createElement('span');
                content.className = 'tooltip-content';
                content.innerHTML =
                    '<div class="tooltip-title">' + escapeHtml(meta.title) + '</div>' +
                    '<div class="tooltip-desc">' + escapeHtml(meta.desc) + '</div>' +
                    '<div class="tooltip-formula">' + escapeHtml(meta.formula) + '</div>' +
                    '<div class="tooltip-impact">' + escapeHtml(meta.impact || '') + '</div>';
                trigger.appendChild(content);
                return trigger;
            }

            function appendTooltip(el, meta, addCalcLabelClass) {
                if (!el || el.querySelector('.tooltip-trigger')) return;
                if (addCalcLabelClass) el.classList.add('calc-label');
                el.appendChild(createTooltipTrigger(meta));
            }

            function initInputTooltips() {
                document.querySelectorAll('#calculator .input-group label[for], #calculator .feature-block .field label[for]').forEach(function(labelEl) {
                    var id = labelEl.getAttribute('for');
                    var key = INPUT_KEY_BY_ID[id] || id;
                    var title = labelEl.childNodes[0] ? labelEl.childNodes[0].nodeValue : labelEl.textContent;
                    title = String(title || labelEl.textContent || '').trim().replace(/\s+/g, ' ');
                    appendTooltip(labelEl, resolveTooltipMeta(key, 'input', title), true);
                });

                ['inConcurrent', 'calLockApply', 'autoRunToggle', 'advancedInputToggle', 'telemetryApplyInputs'].forEach(function(id) {
                    var labelEl = document.querySelector('.check-wrap[for="' + id + '"]');
                    if (!labelEl) return;
                    var title = String(labelEl.textContent || '').trim().replace(/\s+/g, ' ');
                    if (!title) title = prettifyKey(id);
                    appendTooltip(labelEl, resolveTooltipMeta(INPUT_KEY_BY_ID[id] || id, 'input', title), false);
                });
            }

            function initOutputTooltips() {
                document.querySelectorAll('#calculator .result-card').forEach(function(card) {
                    var labelEl = card.querySelector('.label');
                    var valueEl = card.querySelector('.value[id]');
                    if (!labelEl || !valueEl) return;
                    var key = OUTPUT_KEY_BY_ID[valueEl.id] || valueEl.id;
                    var title = String(labelEl.textContent || '').trim().replace(/\s+/g, ' ');
                    appendTooltip(labelEl, resolveTooltipMeta(key, 'output', title), false);
                });
            }

            function initTooltipPositioning() {
                document.querySelectorAll('.tooltip-trigger').forEach(function(trigger) {
                    if (trigger.dataset.tooltipBound === '1') return;
                    trigger.dataset.tooltipBound = '1';
                    trigger.addEventListener('mouseenter', function() {
                        var content = this.querySelector('.tooltip-content');
                        if (!content) return;
                        content.style.display = 'block';
                        var rect = this.getBoundingClientRect();
                        var cRect = content.getBoundingClientRect();
                        var top = rect.bottom + 8;
                        var left = rect.left - (cRect.width / 2) + (rect.width / 2);
                        if (left < 8) left = 8;
                        if (left + cRect.width > window.innerWidth - 8) left = window.innerWidth - cRect.width - 8;
                        if (top + cRect.height > window.innerHeight - 8) top = rect.top - cRect.height - 8;
                        content.style.top = top + 'px';
                        content.style.left = left + 'px';
                    });
                    trigger.addEventListener('mouseleave', function() {
                        var content = this.querySelector('.tooltip-content');
                        if (content) content.style.display = 'none';
                    });
                    trigger.addEventListener('focus', function() {
                        var content = this.querySelector('.tooltip-content');
                        if (!content) return;
                        content.style.display = 'block';
                        var rect = this.getBoundingClientRect();
                        var cRect = content.getBoundingClientRect();
                        var top = rect.bottom + 8;
                        var left = rect.left - (cRect.width / 2) + (rect.width / 2);
                        if (left < 8) left = 8;
                        if (left + cRect.width > window.innerWidth - 8) left = window.innerWidth - cRect.width - 8;
                        if (top + cRect.height > window.innerHeight - 8) top = rect.top - cRect.height - 8;
                        content.style.top = top + 'px';
                        content.style.left = left + 'px';
                    });
                    trigger.addEventListener('blur', function() {
                        var content = this.querySelector('.tooltip-content');
                        if (content) content.style.display = 'none';
                    });
                });
            }

            function initTermTooltipPositioning() {
                if (document.body.dataset.termTooltipBound === '1') return;
                document.body.dataset.termTooltipBound = '1';

                var panel = document.getElementById('termTooltipPanel');
                if (!panel) {
                    panel = document.createElement('div');
                    panel.id = 'termTooltipPanel';
                    panel.className = 'term-tooltip-panel';
                    document.body.appendChild(panel);
                }

                var activeTerm = null;

                function setPanelContent(termEl) {
                    var title = termEl.getAttribute('data-term-title') || termEl.textContent || 'Term';
                    var desc = termEl.getAttribute('data-tooltip') || '';
                    var impact = termEl.getAttribute('data-term-impact') || '';
                    panel.innerHTML =
                        '<div class="term-title">' + escapeHtml(String(title).trim()) + '</div>' +
                        '<div class="term-desc">' + escapeHtml(String(desc).trim()) + '</div>' +
                        '<div class="term-impact">' + escapeHtml(String(impact).trim()) + '</div>';
                }

                function positionPanel(x, y) {
                    panel.style.display = 'block';
                    panel.style.visibility = 'hidden';

                    var w = panel.offsetWidth || 280;
                    var h = panel.offsetHeight || 120;
                    var left = x + 14;
                    var top = y + 16;

                    if (left + w > window.innerWidth - 8) left = window.innerWidth - w - 8;
                    if (left < 8) left = 8;
                    if (top + h > window.innerHeight - 8) top = y - h - 14;
                    if (top < 8) top = 8;

                    panel.style.left = left + 'px';
                    panel.style.top = top + 'px';
                    panel.style.visibility = 'visible';
                }

                function showPanel(termEl, x, y) {
                    activeTerm = termEl;
                    setPanelContent(termEl);
                    positionPanel(x, y);
                }

                function hidePanel() {
                    panel.style.display = 'none';
                    panel.style.visibility = 'hidden';
                }

                document.addEventListener('mouseover', function(ev) {
                    var term = findTermTooltipTarget(ev.target);
                    if (!term) return;
                    showPanel(term, ev.clientX, ev.clientY);
                });

                document.addEventListener('mousemove', function(ev) {
                    if (!activeTerm || panel.style.display !== 'block') return;
                    positionPanel(ev.clientX, ev.clientY);
                });

                document.addEventListener('mouseout', function(ev) {
                    if (!activeTerm) return;
                    var fromTerm = findTermTooltipTarget(ev.target);
                    var toTerm = findTermTooltipTarget(ev.relatedTarget);
                    if (fromTerm && fromTerm === activeTerm && toTerm !== activeTerm) {
                        activeTerm = null;
                        hidePanel();
                    }
                });

                document.addEventListener('focusin', function(ev) {
                    var term = findTermTooltipTarget(ev.target);
                    if (!term) return;
                    var rect = term.getBoundingClientRect();
                    showPanel(term, rect.left + (rect.width / 2), rect.top);
                });

                document.addEventListener('focusout', function(ev) {
                    var term = findTermTooltipTarget(ev.target);
                    if (!term) return;
                    activeTerm = null;
                    hidePanel();
                });

                window.addEventListener('scroll', function() {
                    if (!activeTerm || panel.style.display !== 'block') return;
                    var rect = activeTerm.getBoundingClientRect();
                    positionPanel(rect.left + (rect.width / 2), rect.top);
                }, true);
            }

            function termTooltipSpan(label, key, layer) {
                var meta = resolveTooltipMeta(key || label, layer || 'processing', label);
                var detail = meta.desc + ' ' + meta.formula;
                return '<span class="term-tooltip" tabindex="0" data-term-title="' + escapeAttr(meta.title) + '" data-tooltip="' + escapeAttr(detail) + '" data-term-impact="' + escapeAttr(meta.impact || '') + '">' + escapeHtml(label) + '</span>';
            }

            function createTermTooltipNode(label, key, layer, autoClass) {
                var text = String(label == null ? '' : label);
                var meta = resolveTooltipMeta(key || text, layer || 'processing', text);
                var detail = meta.desc + ' ' + meta.formula;
                var span = document.createElement('span');
                span.className = 'term-tooltip' + (autoClass ? (' ' + autoClass) : '');
                span.setAttribute('tabindex', '0');
                span.setAttribute('data-term-title', meta.title || text);
                span.setAttribute('data-tooltip', detail);
                span.setAttribute('data-term-impact', meta.impact || '');
                span.textContent = text;
                return span;
            }

            function findTermTooltipTarget(node) {
                if (!node || !node.closest) return null;
                if (node.closest('.tooltip-trigger, .tooltip-content')) return null;
                return node.closest('.term-tooltip, .term-hotspot');
            }

            function readElementValueForTooltip(el) {
                if (!el) return '';
                var tag = String(el.tagName || '').toUpperCase();
                if (tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') {
                    return String(el.value || '').trim();
                }
                return String(el.textContent || '').replace(/\s+/g, ' ').trim();
            }

            function inferTooltipTitleFromContext(el, key) {
                if (!el) return prettifyKey(key || 'term');
                var attrTitle = el.getAttribute('data-term-title');
                if (attrTitle) return String(attrTitle).trim();

                var card = el.closest('.result-card');
                if (card) {
                    var cardLabel = card.querySelector('.label');
                    if (cardLabel && cardLabel.textContent) return String(cardLabel.textContent).trim();
                }

                var quick = el.closest('.quick-kpi');
                if (quick) {
                    var quickLabel = quick.querySelector('.k');
                    if (quickLabel && quickLabel.textContent) return String(quickLabel.textContent).trim();
                }

                var impact = el.closest('.model-impact');
                if (impact) {
                    var impactLabel = impact.querySelector('.k');
                    if (impactLabel && impactLabel.textContent) return String(impactLabel.textContent).trim();
                }

                var node = el.closest('.model-node');
                if (node) {
                    var nodeLabel = node.querySelector('.tag');
                    if (nodeLabel && nodeLabel.textContent) return String(nodeLabel.textContent).trim();
                }

                return prettifyKey(key || el.id || 'term');
            }

            function bindTermHotspot(el, key, layer, title) {
                if (!el) return;
                var resolvedKey = key || el.getAttribute('data-term-key') || el.id || '';
                if (!resolvedKey) return;
                var resolvedLayer = layer || (OUTPUT_KEY_BY_ID[el.id] ? 'output' : (INPUT_KEY_BY_ID[el.id] ? 'input' : 'processing'));
                var fallbackTitle = title || inferTooltipTitleFromContext(el, resolvedKey);
                var meta = resolveTooltipMeta(resolvedKey, resolvedLayer, fallbackTitle);
                var detail = meta.desc + ' ' + meta.formula;
                var live = readElementValueForTooltip(el);
                if (live && live !== '-' && live !== 'N/A') detail += ' Current: ' + live + '.';
                el.classList.add('term-hotspot');
                el.setAttribute('data-term-key', resolvedKey);
                el.setAttribute('data-term-title', meta.title || fallbackTitle);
                el.setAttribute('data-tooltip', detail);
                el.setAttribute('data-term-impact', meta.impact || '');
                var nativeTitle = (meta.title || fallbackTitle) + ': ' + meta.desc;
                if (live && live !== '-' && live !== 'N/A') nativeTitle += ' Current: ' + live + '.';
                el.removeAttribute('title');
                el.setAttribute('aria-label', nativeTitle);
            }

            function refreshLiteralTermHotspots() {
                Object.keys(OUTPUT_KEY_BY_ID).forEach(function(id) {
                    var el = document.getElementById(id);
                    if (!el) return;
                    bindTermHotspot(el, OUTPUT_KEY_BY_ID[id], 'output');
                });

                Object.keys(HOTSPOT_KEY_BY_ID).forEach(function(id) {
                    var el = document.getElementById(id);
                    if (!el) return;
                    bindTermHotspot(el, HOTSPOT_KEY_BY_ID[id], 'processing');
                });

                document.querySelectorAll('#calculator [data-term-key]').forEach(function(el) {
                    var key = el.getAttribute('data-term-key') || '';
                    if (!key) return;
                    var layer = el.getAttribute('data-term-layer') || '';
                    var title = el.getAttribute('data-term-title') || '';
                    bindTermHotspot(el, key, layer, title);
                });
            }

            function normalizeTermAlias(str) {
                return String(str || '').toLowerCase().replace(/\s+/g, ' ').trim();
            }

            function escapeRegex(str) {
                return String(str || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            function buildUniversalAliasCache() {
                if (universalAliasCache) return universalAliasCache;
                var aliasToKey = {};

                function addAlias(key, alias) {
                    var norm = normalizeTermAlias(alias);
                    if (!norm || norm.length < 2) return;
                    if (!aliasToKey[norm]) aliasToKey[norm] = key;
                }

                Object.keys(PARAM_TOOLTIPS || {}).forEach(function(key) {
                    var meta = PARAM_TOOLTIPS[key] || {};
                    addAlias(key, key);
                    addAlias(key, prettifyKey(key));
                    if (meta.title) addAlias(key, meta.title);
                });

                [
                    ['controlIndex', 'control idx'],
                    ['controlIndex', 'controlidx'],
                    ['controlIndex', 'ctrl idx'],
                    ['controlIndex', 'ctrlidx'],
                    ['controlIndex', 'controlldx'],
                    ['riskIndex', 'risk idx'],
                    ['riskIndex', 'riskidx'],
                    ['deltaT', 'delta t'],
                    ['deltaT', 'delta-t'],
                    ['deltaT', 'deltat'],
                    ['pue', 'pue'],
                    ['systemCop', 'cop'],
                    ['systemCop', 'system cop'],
                    ['wue', 'wue'],
                    ['netOpex', 'net opex'],
                    ['annualOpex', 'annual opex'],
                    ['annualOpex', 'gross opex'],
                    ['netCarbonTons', 'net carbon'],
                    ['annualGwh', 'annual gwh'],
                    ['annualGwh', 'annual energy'],
                    ['flowLpm', 'flow lpm'],
                    ['flowLpm', 'lpm'],
                    ['pumpPowerKw', 'pump power'],
                    ['pumpPowerKw', 'pump kw'],
                    ['liquidCapture', 'liquid capture'],
                    ['monitoring', 'monitoring coverage'],
                    ['predictiveGain', 'predictive control gain'],
                    ['scores.total', 'composite score'],
                    ['scores.total', 'total score']
                ].forEach(function(row) {
                    addAlias(row[0], row[1]);
                });

                var aliases = Object.keys(aliasToKey).sort(function(a, b) { return b.length - a.length; });
                var pattern = aliases.map(function(alias) {
                    return escapeRegex(alias).replace(/\s+/g, '\\s+');
                }).join('|');
                var regex = pattern ? new RegExp(pattern, 'gi') : null;
                universalAliasCache = { aliasToKey: aliasToKey, regex: regex };
                return universalAliasCache;
            }

            function isWordChar(ch) {
                return !!ch && /[A-Za-z0-9_]/.test(ch);
            }

            function autoTooltipizeTextNode(node) {
                var cache = buildUniversalAliasCache();
                if (!cache.regex || !node || !node.nodeValue) return false;
                var parent = node.parentElement;
                if (!parent) return false;
                if (parent.namespaceURI === 'http://www.w3.org/2000/svg') return false;
                if (parent.closest('svg, text, tspan')) return false;
                var text = node.nodeValue;
                cache.regex.lastIndex = 0;
                var match;
                var has = false;
                var last = 0;
                var frag = document.createDocumentFragment();
                while ((match = cache.regex.exec(text))) {
                    var raw = match[0];
                    var start = match.index;
                    var end = start + raw.length;
                    var prev = start > 0 ? text.charAt(start - 1) : '';
                    var next = end < text.length ? text.charAt(end) : '';
                    if (isWordChar(prev) || isWordChar(next)) continue;
                    var aliasNorm = normalizeTermAlias(raw);
                    var key = cache.aliasToKey[aliasNorm];
                    if (!key) continue;
                    if (start > last) frag.appendChild(document.createTextNode(text.slice(last, start)));
                    frag.appendChild(createTermTooltipNode(raw, key, 'processing', 'auto-term'));
                    last = end;
                    has = true;
                }
                if (!has) return false;
                if (last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
                node.parentNode.replaceChild(frag, node);
                return true;
            }

            function applyUniversalTermTooltips(root) {
                var host = root || document.getElementById('calculator');
                if (!host) return;
                // Repair stale tooltip spans that were previously injected into SVG labels.
                host.querySelectorAll('svg .term-tooltip, .diagram-svg .term-tooltip').forEach(function(el) {
                    el.replaceWith(document.createTextNode(el.textContent || ''));
                });
                host.querySelectorAll('span.term-tooltip.auto-term').forEach(function(el) {
                    el.replaceWith(document.createTextNode(el.textContent || ''));
                });

                var walker = document.createTreeWalker(host, NodeFilter.SHOW_TEXT, {
                    acceptNode: function(node) {
                        if (!node || !node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
                        var p = node.parentElement;
                        if (!p) return NodeFilter.FILTER_REJECT;
                        // Never mutate SVG text nodes; injecting HTML spans there breaks diagram labels.
                        if (p.closest('svg, text, tspan')) return NodeFilter.FILTER_REJECT;
                        if (p.closest('.diagram-canvas, .diagram-svg, #paretoScatterSvg, #energySankeySvg')) return NodeFilter.FILTER_REJECT;
                        if (p.closest('.term-tooltip, .term-hotspot, .tooltip-content, script, style, textarea, select, option, button, .fa')) return NodeFilter.FILTER_REJECT;
                        return NodeFilter.FILTER_ACCEPT;
                    }
                });
                var nodes = [];
                var cur;
                while ((cur = walker.nextNode())) nodes.push(cur);
                nodes.forEach(function(nText) {
                    autoTooltipizeTextNode(nText);
                });
            }

            function renderStageLineContent(line) {
                if (line && typeof line === 'object') {
                    var relation = line.relation || '=';
                    var left = termTooltipSpan(line.label || line.key || '-', line.key || line.label, line.layer || 'processing');
                    var right = line.value == null ? '' : (' ' + relation + ' ' + escapeHtml(line.value));
                    return left + right;
                }

                var raw = String(line || '').trim();
                var eqPos = raw.indexOf('=');
                if (eqPos > 0) {
                    var leftEq = raw.slice(0, eqPos).trim();
                    var rightEq = raw.slice(eqPos + 1).trim();
                    return termTooltipSpan(leftEq, leftEq, 'processing') + ' = ' + escapeHtml(rightEq);
                }

                var arrowPos = raw.indexOf('->');
                if (arrowPos > 0) {
                    var leftArrow = raw.slice(0, arrowPos).trim();
                    var rightArrow = raw.slice(arrowPos + 2).trim();
                    return termTooltipSpan(leftArrow, leftArrow, 'processing') + ' -> ' + escapeHtml(rightArrow);
                }

                return escapeHtml(raw);
            }

            function shortText(value, maxLen) {
                var str = String(value == null ? '' : value);
                if (str.length <= maxLen) return str;
                return str.slice(0, Math.max(0, maxLen - 1)) + '';
            }

            function compactRuleText(value, maxLen) {
                var str = String(value == null ? '' : value).replace(/\s+/g, ' ').trim();
                if (!str) return '-';
                str = str
                    .replace(/\bmonitoring\b/gi, 'mon')
                    .replace(/\bcontrolIndex\b/gi, 'ctrl')
                    .replace(/\bpumpPowerPctIt\b/gi, 'pump%IT')
                    .replace(/\briskIndex\b/gi, 'risk')
                    .replace(/\btargetPue\b/gi, 'tPUE')
                    .replace(/\btargetCop\b/gi, 'tCOP')
                    .replace(/\bdeltaT\b/gi, 'dT')
                    .replace(/\s*&&\s*/g, ' & ')
                    .replace(/\s*\|\|\s*/g, ' | ')
                    .replace(/\s*<=\s*/g, '<=')
                    .replace(/\s*>=\s*/g, '>=')
                    .replace(/\s*<\s*/g, '<')
                    .replace(/\s*>\s*/g, '>')
                    .replace(/\s*\+\s*/g, '+')
                    .replace(/\s*-\s*/g, '-')
                    .replace(/\s+/g, ' ');
                return shortText(str, maxLen || 38);
            }

            function selectedCountryLabel() {
                var sel = document.getElementById('inCountryProfile');
                if (!sel) return 'Custom Manual';
                var key = sel.value;
                return (COUNTRY_PROFILES[key] && COUNTRY_PROFILES[key].label) ? COUNTRY_PROFILES[key].label : 'Custom Manual';
            }

            function selectedRackLabel() {
                var sel = document.getElementById('inRackType');
                if (!sel) return 'Unknown';
                var key = sel.value;
                return (RACK_PROFILES[key] && RACK_PROFILES[key].label) ? RACK_PROFILES[key].label : key;
            }

            function countryLabelByKey(key) {
                return (COUNTRY_PROFILES[key] && COUNTRY_PROFILES[key].label) ? COUNTRY_PROFILES[key].label : 'Custom Manual';
            }

            function rackLabelByKey(key) {
                return (RACK_PROFILES[key] && RACK_PROFILES[key].label) ? RACK_PROFILES[key].label : String(key || 'Unknown');
            }

            function gatherInputs() {
                return {
                    itLoadMw: Math.max(n('inItLoad'), 0.5),
                    rackCount: Math.max(n('inRackCount'), 10),
                    rackType: document.getElementById('inRackType').value,
                    rackDensityTarget: clamp(n('inRackDensityTarget'), 5, 180),
                    highDensityShare: clamp(n('inHighDensityShare'), 0, 100),
                    modelYear: clamp(Math.round(n('inModelYear')), 2026, 2045),
                    architectureMode: document.getElementById('inCoolingArchitecture').value,
                    liquidCapture: clamp(n('inLiquidCapture'), 0, 100),
                    coolantKey: document.getElementById('inCoolant').value,
                    supplyTemp: n('inSupplyTemp'),
                    returnTemp: n('inReturnTemp'),
                    pumpHead: Math.max(n('inPumpHead'), 5),
                    pumpEff: clamp(n('inPumpEff'), 35, 95),
                    hydraulicMargin: clamp(n('inHydraulicMargin'), 0, 45),
                    controlQuality: clamp(n('inControlQuality'), 0, 100),
                    predictiveGain: clamp(n('inPredictiveGain'), 0, 60),
                    coefHeatTransfer: clamp(n('inCoefHeatTransfer'), 60, 99),
                    coefCduLoss: clamp(n('inCoefCduLoss'), 0.5, 4.5),
                    coefPipeLoss: clamp(n('inCoefPipeLoss'), 0.75, 1.8),
                    coefFutureTech: clamp(n('inCoefFutureTech'), -10, 45),
                    cduUnit: Math.max(n('inCduUnit'), 300),
                    redundancy: document.getElementById('inRedundancy').value,
                    climate: document.getElementById('inClimate').value,
                    countryKey: document.getElementById('inCountryProfile').value,
                    airCop: Math.max(n('inAirCop'), 1.5),
                    economizerHours: clamp(n('inEconomizerHours'), 0, 95),
                    fanPower: clamp(n('inFanPower'), 0.5, 12),
                    upsEff: clamp(n('inUpsEff'), 90, 99.5),
                    distLoss: clamp(n('inDistLoss'), 0.5, 8),
                    heatReuse: clamp(n('inHeatReuse'), 0, 80),
                    elecPrice: Math.max(n('inElecPrice'), 0.01),
                    waterTariff: Math.max(n('inWaterTariff'), 0.1),
                    carbonIntensity: clamp(n('inCarbonIntensity'), 0.05, 1.1),
                    monitoring: clamp(n('inMonitoring'), 0, 100),
                    fireType: document.getElementById('inFireType').value,
                    targetPue: Math.max(n('inTargetPue'), 1.05),
                    targetCop: Math.max(n('inTargetCop'), 3),
                    failureMode: document.getElementById('inFailureMode').value,
                    concurrent: document.getElementById('inConcurrent').checked
                };
            }

            function gatherCalibrationTargets() {
                var targets = {
                    pue: maybeNum('calTargetPue', 1.01),
                    cop: maybeNum('calTargetCop', 1.2),
                    energyGwh: maybeNum('calTargetEnergy', 0.1),
                    netOpex: maybeNum('calTargetNetOpex', 1000),
                    carbon: maybeNum('calTargetCarbon', 1),
                    pumpKw: maybeNum('calTargetPump', 0.1)
                };
                var count = 0;
                Object.keys(targets).forEach(function(key) {
                    if (targets[key] !== null) count += 1;
                });
                targets.metricCount = count;
                return targets;
            }

            function calibrationError(model, targets) {
                var total = 0;
                var nMetrics = 0;

                function add(pred, tgt, weight, floorScale) {
                    if (tgt === null || tgt === undefined) return;
                    var scale = Math.max(Math.abs(tgt), floorScale);
                    var rel = (pred - tgt) / scale;
                    total += weight * rel * rel;
                    nMetrics += 1;
                }

                add(model.pue, targets.pue, 3.2, 1);
                add(model.systemCop, targets.cop, 2.6, 1);
                add(model.annualGwh, targets.energyGwh, 1.8, 1);
                add(model.netOpex, targets.netOpex, 2.2, 1000);
                add(model.netCarbonTons, targets.carbon, 1.6, 1);
                add(model.pumpPowerKw, targets.pumpKw, 1.2, 1);

                if (nMetrics === 0) return { error: Infinity, metrics: 0 };
                return { error: total / nMetrics, metrics: nMetrics };
            }

            function fitScoreFromError(err) {
                if (!isFinite(err)) return 0;
                return clamp(100 * Math.exp(-err * 1.35), 0, 99.9);
            }

            function renderCalibrationPanel() {
                var statusEl = document.getElementById('calStatus');
                var summaryEl = document.getElementById('calSummary');
                if (!statusEl || !summaryEl) return;

                if (!calibrationState) {
                    statusEl.textContent = 'Not Calibrated';
                    statusEl.className = 'calibration-status';
                    setText('outCalFit', '-');
                    summaryEl.textContent = 'Calibration idle. Provide telemetry targets and run calibration.';
                    return;
                }

                var fit = fitScoreFromError(calibrationState.bestError);
                var stale = calibrationDirty;
                statusEl.textContent = (stale ? 'Calibrated (Stale) ' : 'Calibrated ') + fmtNum(fit, 1) + '%';
                statusEl.className = 'calibration-status ' + (stale ? 'stale' : 'ok');
                setText('outCalFit', fmtNum(fit, 1) + '%');

                var lines = [];
                lines.push('Metrics: ' + calibrationState.metricCount + ' | baseline err ' + fmtNum(calibrationState.baseError, 4) + ' -> calibrated err ' + fmtNum(calibrationState.bestError, 4));
                lines.push('Tuned: control ' + fmtNum(calibrationState.tuned.controlQuality, 0) + '%, predictive ' + fmtNum(calibrationState.tuned.predictiveGain, 0) + '%, heatTransfer ' + fmtNum(calibrationState.tuned.coefHeatTransfer, 1) + '%, cduLoss ' + fmtNum(calibrationState.tuned.coefCduLoss, 2) + '%.');
                lines.push('pipeLoss ' + fmtNum(calibrationState.tuned.coefPipeLoss, 2) + 'x, future ' + fmtNum(calibrationState.tuned.coefFutureTech, 0) + '%, liquidCapture ' + fmtNum(calibrationState.tuned.liquidCapture, 0) + '%.');
                if (stale) lines.push('Status: inputs changed after calibration; run calibration again to refresh fit.');
                summaryEl.textContent = lines.join('\n');
            }

            function ashraeScore(supplyTemp, returnTemp, deltaT, effectiveCapture, designDensity, controlIndex) {
                var score = 100;
                if (supplyTemp < 18 || supplyTemp > 40) score -= 30;
                if (returnTemp > 50) score -= 18;
                if (deltaT < 6) score -= 14;
                if (deltaT > 14) score -= 8;
                if (effectiveCapture < 65) score -= 12;
                if (designDensity > 100) score -= 7;
                if (controlIndex < 60) score -= 9;
                return clamp(score, 0, 100);
            }

            function ansiScore(redundancy, monitoring, rackDensity, hydraulicMargin, rackProfileKey) {
                var base = redundancy === '2N' ? 88 : (redundancy === 'N1' ? 78 : 62);
                base += monitoring * 0.11;
                if (rackDensity > 80) base -= 6;
                if (hydraulicMargin > 25) base -= 4;
                if (rackProfileKey === 'legacy_air_plus_rdhx') base -= 6;
                return clamp(base, 0, 100);
            }

            function isoScore(monitoring, pue, netCarbonTons, annualGwh, futureFactor) {
                var score = 35 + monitoring * 0.42;
                if (pue <= 1.2) score += 21;
                else if (pue <= 1.3) score += 15;
                else if (pue <= 1.4) score += 9;
                else if (pue <= 1.5) score += 4;
                var intensity = annualGwh > 0 ? netCarbonTons / annualGwh : 0;
                if (intensity <= 250) score += 8;
                else if (intensity <= 350) score += 4;
                if (futureFactor > 1.15) score += 4;
                return clamp(score, 0, 100);
            }

            function nfpaScore(fireType, concurrent, designDensity) {
                var map = {
                    clean_agent: 94,
                    water_mist: 88,
                    double_interlock: 81,
                    dry_pipe: 72
                };
                var score = map[fireType] || 70;
                if (concurrent) score += 4;
                if (designDensity > 90) score -= 4;
                return clamp(score, 0, 100);
            }

            function uptimeScore(redundancy, monitoring, concurrent, upsEff, controlIndex) {
                var score = redundancy === '2N' ? 92 : (redundancy === 'N1' ? 80 : 58);
                score += monitoring * 0.1;
                score += (upsEff - 95) * 3.2;
                score += (controlIndex - 70) * 0.14;
                if (concurrent) score += 6;
                return clamp(score, 0, 100);
            }

            function grade(score) {
                if (score >= 90) return 'Grade A';
                if (score >= 80) return 'Grade B';
                if (score >= 70) return 'Grade C';
                if (score >= 60) return 'Grade D';
                return 'Grade E';
            }

            function computeModel(input) {
                var climateData = CLIMATE_FACTORS[input.climate] || CLIMATE_FACTORS.tropical;
                var coolant = COOLANTS[input.coolantKey] || COOLANTS.water;
                var rackProfile = RACK_PROFILES[input.rackType] || RACK_PROFILES.ai_hpc_direct_liquid;
                var failureMode = input.failureMode || 'normal';
                var failureNote = 'Normal operation profile';
                var elecPriceEff = input.elecPrice;
                var carbonIntensityEff = input.carbonIntensity;
                var failureRiskAdd = 0;

                var yearDelta = Math.max(input.modelYear - 2026, 0);
                var futureFactor = clamp(1 + ((input.coefFutureTech + (yearDelta * 0.9)) / 100) * rackProfile.futureBias, 0.8, 1.65);
                var controlIndex = clamp(
                    (input.controlQuality * 0.55) +
                    (input.predictiveGain * 0.95) +
                    (input.monitoring * 0.22) +
                    (input.concurrent ? 8 : 0),
                    0,
                    100
                );

                if (failureMode === 'sensor_degraded') {
                    controlIndex = clamp(controlIndex - 18, 0, 100);
                    failureRiskAdd += 13;
                    failureNote = 'Sensor degraded: reduced control observability';
                } else if (failureMode === 'redundancy_degraded') {
                    failureRiskAdd += 16;
                    failureNote = 'Redundancy degraded: resilience margin reduced';
                } else if (failureMode === 'grid_stress') {
                    elecPriceEff *= 1.18;
                    carbonIntensityEff *= 1.12;
                    failureRiskAdd += 6;
                    failureNote = 'Grid stress: tariff and carbon intensity elevated';
                }

                var designDensity = Math.max(5, input.rackDensityTarget * (1 + input.highDensityShare / 250) * (1 + yearDelta * 0.0045));
                var densityStress = clamp(designDensity / 70, 0.5, 2.8);
                var effectiveCapture = clamp(
                    input.liquidCapture * (0.74 + rackProfile.liquidBias * 0.26) * (input.coefHeatTransfer / 100) * (1 + controlIndex / 500),
                    20,
                    99
                );

                var itKw = Math.max(input.itLoadMw * 1000, 100);
                var liquidKw = itKw * (effectiveCapture / 100);
                var airKw = itKw - liquidKw;
                var baseDeltaT = Math.max(input.returnTemp - input.supplyTemp, 3);
                var deltaT = clamp(baseDeltaT * (0.9 + densityStress * 0.08), 3, 20);

                var massFlowKgS = liquidKw / (coolant.cp * deltaT);
                var baseFlowM3s = massFlowKgS / coolant.rho;
                var redundancyFactor = input.redundancy === '2N' ? 2 : (input.redundancy === 'N1' ? 1.15 : 1);
                var pipeFactor = input.coefPipeLoss;
                var designFlowM3s = baseFlowM3s * redundancyFactor * (1 + (input.hydraulicMargin / 100)) * pipeFactor;
                var flowLpm = designFlowM3s * 60000;

                var pumpHeadEff = input.pumpHead * pipeFactor * (1 + (densityStress - 1) * 0.22);
                var hydraulicPowerKw = (coolant.rho * 9.81 * pumpHeadEff * designFlowM3s) / 1000;
                var pumpPowerKw = hydraulicPowerKw / Math.max(input.pumpEff / 100, 0.35);

                var cduLossKw = liquidKw * (input.coefCduLoss / 100);
                var economizerFraction = input.economizerHours / 100;
                var supplyBonus = clamp((input.supplyTemp - 28) * 0.11, -0.45, 1.5);
                var controlBonus = (controlIndex - 60) / 180;

                var liquidCop = clamp(
                    (6.1 + climateData.climateCopBias + supplyBonus + economizerFraction * 1.05 + controlBonus) * futureFactor,
                    3.0,
                    19
                );

                var airCopEff = clamp(
                    input.airCop * (1 + economizerFraction * 0.58 + controlBonus * 0.32) * (0.92 + (1 - rackProfile.airResidual) * 0.12),
                    1.7,
                    16
                );

                if (failureMode === 'heatwave') {
                    airCopEff = clamp(airCopEff * 0.82, 1.4, 16);
                    failureRiskAdd += 9;
                    failureNote = 'Heatwave stress: reduced air-path cooling effectiveness';
                }

                var liquidCoolingKw = ((liquidKw + cduLossKw) / liquidCop) + pumpPowerKw;
                if (failureMode === 'pump_degraded') {
                    pumpPowerKw *= 1.28;
                    liquidCoolingKw *= 1.14;
                    flowLpm *= 0.9;
                    failureRiskAdd += 11;
                    failureNote = 'Pump degraded: lower flow and higher hydraulic overhead';
                }
                var airCoolingKw = airKw / airCopEff;
                var fanKw = itKw * (input.fanPower / 100) * (1 - effectiveCapture / 100 * 0.55) * (1 - controlBonus * 0.18);
                var totalCoolingKw = liquidCoolingKw + airCoolingKw + fanKw;
                var systemCop = itKw / Math.max(totalCoolingKw, 1);

                var upsInputKw = itKw / Math.max(input.upsEff / 100, 0.9);
                var upsLossKw = upsInputKw - itKw;
                var distLossKw = upsInputKw * (input.distLoss / 100);

                var auxKw = itKw * 0.03;
                var totalFacilityKw = itKw + totalCoolingKw + upsLossKw + distLossKw + auxKw;
                var pue = totalFacilityKw / itKw;

                var annualKwh = totalFacilityKw * 8760;
                var annualGwh = annualKwh / 1000000;
                var annualEnergyCost = annualKwh * elecPriceEff;

                var wue = climateData.baseWue * (1 - economizerFraction * 0.43) * (1 - effectiveCapture / 100 * 0.32) * (1 - (futureFactor - 1) * 0.18);
                wue = Math.max(wue, 0.04);
                var annualWaterM3 = (annualKwh * wue) / 1000;
                var annualWaterCost = annualWaterM3 * input.waterTariff;
                var grossOpex = annualEnergyCost + annualWaterCost;

                var heatReuseKwAvg = liquidKw * (input.heatReuse / 100) * (0.42 + rackProfile.futureBias * 0.1) * (1 + yearDelta * 0.012);
                var heatReuseKwh = heatReuseKwAvg * 8760;
                var heatReuseCredit = heatReuseKwh * elecPriceEff * 0.62;
                var netOpex = Math.max(grossOpex - heatReuseCredit, 0);

                var annualCarbonTons = (annualKwh * carbonIntensityEff) / 1000;
                var avoidedCarbonTons = (heatReuseKwh * carbonIntensityEff * 0.65) / 1000;
                var netCarbonTons = Math.max(annualCarbonTons - avoidedCarbonTons, 0);

                var cduBase = Math.max(1, Math.ceil(liquidKw / input.cduUnit));
                var cduCount = input.redundancy === '2N' ? cduBase * 2 : (input.redundancy === 'N1' ? cduBase + 1 : cduBase);
                var rackDensity = itKw / Math.max(input.rackCount, 1);
                var rackDensityGap = designDensity - rackDensity;

                var scoreA = ashraeScore(input.supplyTemp, input.returnTemp, deltaT, effectiveCapture, designDensity, controlIndex);
                var scoreB = ansiScore(input.redundancy, input.monitoring, rackDensity, input.hydraulicMargin, input.rackType);
                var scoreC = isoScore(input.monitoring, pue, netCarbonTons, annualGwh, futureFactor);
                var scoreD = nfpaScore(input.fireType, input.concurrent, designDensity);
                var scoreE = uptimeScore(input.redundancy, input.monitoring, input.concurrent, input.upsEff, controlIndex);
                var totalScore = (scoreA * 0.24) + (scoreB * 0.16) + (scoreC * 0.16) + (scoreD * 0.2) + (scoreE * 0.24);

                var riskIndex = 18;
                riskIndex += rackProfile.riskBias;
                if (input.redundancy === 'N') riskIndex += 12;
                if (!input.concurrent) riskIndex += 8;
                if (designDensity > 90) riskIndex += 8;
                if (rackDensity > 80) riskIndex += 8;
                if (input.fireType === 'dry_pipe') riskIndex += 6;
                riskIndex += Math.max(0, (80 - input.monitoring) * 0.2);
                riskIndex += Math.max(0, (input.upsEff < 96 ? (96 - input.upsEff) * 3 : 0));
                riskIndex -= Math.max(0, (controlIndex - 70) * 0.18);
                riskIndex -= yearDelta * 0.12;
                riskIndex += failureRiskAdd;
                riskIndex = clamp(riskIndex, 5, 95);

                var confidence = clamp(
                    45 +
                    (input.monitoring * 0.32) +
                    (input.concurrent ? 6 : 0) +
                    (input.countryKey !== 'custom' ? 8 : 0) +
                    ((deltaT >= 6 && deltaT <= 14) ? 6 : 0) +
                    ((input.hydraulicMargin <= 20) ? 3 : 0) +
                    ((input.coefPipeLoss >= 0.9 && input.coefPipeLoss <= 1.2) ? 2 : 0),
                    0,
                    99
                );

                var pueGap = pue - input.targetPue;
                var copGap = systemCop - input.targetCop;

                return {
                    input: input,
                    rackTypeLabel: rackProfile.label,
                    itKw: itKw,
                    liquidKw: liquidKw,
                    airKw: airKw,
                    effectiveCapture: effectiveCapture,
                    designDensity: designDensity,
                    rackDensityGap: rackDensityGap,
                    controlIndex: controlIndex,
                    futureFactor: futureFactor,
                    yearDelta: yearDelta,
                    deltaT: deltaT,
                    flowLpm: flowLpm,
                    pumpPowerKw: pumpPowerKw,
                    cduCount: cduCount,
                    pue: pue,
                    systemCop: systemCop,
                    wue: wue,
                    annualGwh: annualGwh,
                    annualEnergyCost: annualEnergyCost,
                    elecPriceEff: elecPriceEff,
                    carbonIntensityEff: carbonIntensityEff,
                    annualWaterCost: annualWaterCost,
                    annualOpex: grossOpex,
                    heatReuseCredit: heatReuseCredit,
                    netOpex: netOpex,
                    annualCarbonTons: annualCarbonTons,
                    avoidedCarbonTons: avoidedCarbonTons,
                    netCarbonTons: netCarbonTons,
                    rackDensity: rackDensity,
                    confidence: confidence,
                    riskIndex: riskIndex,
                    failureMode: failureMode,
                    failureNote: failureNote,
                    scores: { ashrae: scoreA, ansi: scoreB, iso: scoreC, nfpa: scoreD, uptime: scoreE, total: totalScore },
                    pueGap: pueGap,
                    copGap: copGap,
                    totalFacilityKw: totalFacilityKw,
                    internals: {
                        yearDelta: yearDelta,
                        densityStress: densityStress,
                        redundancyFactor: redundancyFactor,
                        pipeFactor: pipeFactor,
                        pumpHeadEff: pumpHeadEff,
                        liquidCop: liquidCop,
                        airCopEff: airCopEff,
                        totalCoolingKw: totalCoolingKw,
                        economizerFraction: economizerFraction,
                        annualKwh: annualKwh,
                        annualWaterM3: annualWaterM3,
                        heatReuseKwh: heatReuseKwh
                    },
                    breakdown: {
                        it: itKw,
                        liquidCooling: liquidCoolingKw,
                        airCooling: airCoolingKw,
                        pump: pumpPowerKw,
                        elecLoss: upsLossKw + distLossKw,
                        aux: auxKw + fanKw
                    }
                };
            }

            function renderTargetActions(base, opt) {
                var list = document.getElementById('targetActions');
                if (!list) return;
                var items = [];

                if (!base) {
                    items.push('Run model to generate optimization actions.');
                } else if (!opt) {
                    items.push('Edit any algorithm/control coefficient and run Optimize To Target for multi-factor convergence.');
                    items.push('Model tracks 100% parameter mapping from input profile to outputs, scores, and risk logic.');
                    if (base.failureMode && base.failureMode !== 'normal') items.push('Active degraded mode: ' + base.failureMode + ' (' + base.failureNote + ').');
                } else {
                    var dCapture = opt.input.liquidCapture - base.input.liquidCapture;
                    var dSupply = opt.input.supplyTemp - base.input.supplyTemp;
                    var dAirCop = opt.input.airCop - base.input.airCop;
                    var dPumpEff = opt.input.pumpEff - base.input.pumpEff;
                    var dControl = opt.input.controlQuality - base.input.controlQuality;
                    var dFuture = opt.input.coefFutureTech - base.input.coefFutureTech;
                    var dPue = base.pue - opt.pue;
                    var dCop = opt.systemCop - base.systemCop;
                    var dRisk = base.riskIndex - opt.riskIndex;

                    if (Math.abs(dCapture) > 0.4) items.push('Liquid capture tuned to ' + fmtNum(opt.input.liquidCapture, 0) + '% (' + signed(dCapture, 0, ' pts') + ').');
                    if (Math.abs(dSupply) > 0.2) items.push('Supply setpoint moved to ' + fmtNum(opt.input.supplyTemp, 1) + 'C (' + signed(dSupply, 1, 'C') + ').');
                    if (Math.abs(dAirCop) > 0.05) items.push('Air-path COP updated to ' + fmtNum(opt.input.airCop, 2) + ' (' + signed(dAirCop, 2, '') + ').');
                    if (Math.abs(dPumpEff) > 0.5) items.push('Pump efficiency adjusted to ' + fmtNum(opt.input.pumpEff, 0) + '% (' + signed(dPumpEff, 0, ' pts') + ').');
                    if (Math.abs(dControl) > 0.5) items.push('Control quality shifted to ' + fmtNum(opt.input.controlQuality, 0) + '% (' + signed(dControl, 0, ' pts') + ').');
                    if (Math.abs(dFuture) > 0.5) items.push('Future-tech multiplier set to ' + fmtNum(opt.input.coefFutureTech, 0) + '% (' + signed(dFuture, 0, ' pts') + ').');
                    items.push('Projected impact: PUE ' + signed(dPue, 3, '') + ' better, COP ' + signed(dCop, 2, '') + ', net OPEX ' + signed(base.netOpex - opt.netOpex, 0, ' USD/yr') + ', risk index ' + signed(dRisk, 1, '') + ' better.');
                    if (opt.failureMode && opt.failureMode !== 'normal') items.push('Optimization computed under degraded mode: ' + opt.failureMode + ' (' + opt.failureNote + ').');
                }

                list.innerHTML = items.map(function(text) { return '<li>' + text + '</li>'; }).join('');
            }

            function renderScenarioTable(base, opt) {
                if (!base) return;
                setText('basePue', fmtNum(base.pue, 3));
                setText('baseCop', fmtNum(base.systemCop, 2));
                setText('baseNetOpex', fmtUsd(base.netOpex));
                setText('baseCarbon', fmtNum(base.netCarbonTons, 0) + ' tCO2e');
                setText('baseWue', fmtNum(base.wue, 3));

                if (!opt) {
                    setText('optPue', '-');
                    setText('optCop', '-');
                    setText('optNetOpex', '-');
                    setText('optCarbon', '-');
                    setText('optWue', '-');
                    setText('deltaPue', '-');
                    setText('deltaCop', '-');
                    setText('deltaNetOpex', '-');
                    setText('deltaCarbon', '-');
                    setText('deltaWue', '-');
                    return;
                }

                setText('optPue', fmtNum(opt.pue, 3));
                setText('optCop', fmtNum(opt.systemCop, 2));
                setText('optNetOpex', fmtUsd(opt.netOpex));
                setText('optCarbon', fmtNum(opt.netCarbonTons, 0) + ' tCO2e');
                setText('optWue', fmtNum(opt.wue, 3));

                setText('deltaPue', signed(opt.pue - base.pue, 3, ''));
                setText('deltaCop', signed(opt.systemCop - base.systemCop, 2, ''));
                setText('deltaNetOpex', signed(opt.netOpex - base.netOpex, 0, ' USD'));
                setText('deltaCarbon', signed(opt.netCarbonTons - base.netCarbonTons, 0, ' tCO2e'));
                setText('deltaWue', signed(opt.wue - base.wue, 3, ''));
            }

            function renderBreakdown(model) {
                if (!model) return;
                var total = Math.max(model.totalFacilityKw, 1);
                var keys = [
                    [model.breakdown.it, 'barFlowIt', 'flowIt'],
                    [model.breakdown.liquidCooling, 'barFlowLiquid', 'flowLiquid'],
                    [model.breakdown.airCooling, 'barFlowAir', 'flowAir'],
                    [model.breakdown.pump, 'barFlowPump', 'flowPump'],
                    [model.breakdown.elecLoss, 'barFlowElecLoss', 'flowElecLoss'],
                    [model.breakdown.aux, 'barFlowAux', 'flowAux']
                ];

                keys.forEach(function(item) {
                    var value = item[0];
                    var width = clamp((value / total) * 100, 0, 100);
                    setBar(item[1], width);
                    setText(item[2], fmtNum(value, 0) + ' kW (' + fmtNum(width, 1) + '%)');
                });
            }

            function renderEquationInspector(model) {
                var el = document.getElementById('equationList');
                if (!el || !model) return;

                var cp = (COOLANTS[model.input.coolantKey] || COOLANTS.water).cp;
                var rho = (COOLANTS[model.input.coolantKey] || COOLANTS.water).rho;
                var lines = [
                    'Q_liquid = IT_kW * capture = ' + fmtNum(model.itKw, 1) + ' * ' + fmtNum(model.effectiveCapture / 100, 3) + ' = ' + fmtNum(model.liquidKw, 1) + ' kW',
                    'm_dot = Q/(Cp*dT) = ' + fmtNum(model.liquidKw, 1) + '/(' + fmtNum(cp, 3) + '*' + fmtNum(model.deltaT, 2) + ') = ' + fmtNum((model.liquidKw / (cp * model.deltaT)), 2) + ' kg/s',
                    'flow_lpm = (m_dot/rho)*60000 = ' + fmtNum(model.flowLpm, 1) + ' LPM',
                    'P_hyd = rho*g*H*Q = ' + fmtNum(rho, 0) + '*9.81*' + fmtNum(model.internals.pumpHeadEff, 2) + '*Q',
                    'P_pump = P_hyd/eta = ' + fmtNum(model.pumpPowerKw, 2) + ' kW',
                    'COP_system = IT_kW / Cooling_kW = ' + fmtNum(model.itKw, 1) + '/' + fmtNum(model.internals.totalCoolingKw, 2) + ' = ' + fmtNum(model.systemCop, 3),
                    'PUE = Facility_kW / IT_kW = ' + fmtNum(model.totalFacilityKw, 2) + '/' + fmtNum(model.itKw, 1) + ' = ' + fmtNum(model.pue, 3),
                    'AnnualEnergy = Facility_kW * 8760 = ' + fmtNum(model.annualGwh, 3) + ' GWh',
                    'NetOPEX = (Energy + Water) - ReuseCredit = ' + fmtUsd(model.netOpex),
                    'NetCarbon = AnnualCarbon - AvoidedCarbon = ' + fmtNum(model.netCarbonTons, 1) + ' tCO2e/yr'
                ];

                el.innerHTML = lines.map(function(line, idx) {
                    return '<div class="equation-line"><strong>Eq ' + (idx + 1) + ':</strong> ' + escapeHtml(line) + '</div>';
                }).join('');
            }

            function renderConstraintStatus(model) {
                var el = document.getElementById('constraintStatus');
                if (!el || !model) return;
                var constraints = gatherConstraintState();
                var check = evaluateHardConstraints(model, constraints);
                var mode = model.failureMode === 'normal' ? 'normal' : model.failureMode;
                if (constraints.enforce && !check.feasible) {
                    el.className = 'status-pill err';
                    el.textContent = 'HARD VIOLATION | ' + check.issues.join(', ') + ' | mode ' + mode;
                } else if (!check.feasible) {
                    el.className = 'status-pill warn';
                    el.textContent = 'SOFT VIOLATION | ' + check.issues.join(', ') + ' | mode ' + mode;
                } else {
                    el.className = 'status-pill ok';
                    el.textContent = 'Constraint OK | pump ' + fmtNum(check.pumpPctIt, 2) + '% IT | mode ' + mode;
                }
            }

            function loadScenarios() {
                try {
                    var raw = localStorage.getItem(SCENARIO_STORE_KEY);
                    scenarioSnapshots = raw ? JSON.parse(raw) : [];
                    if (!Array.isArray(scenarioSnapshots)) scenarioSnapshots = [];
                } catch (e) {
                    scenarioSnapshots = [];
                }
            }

            function persistScenarios() {
                localStorage.setItem(SCENARIO_STORE_KEY, JSON.stringify(scenarioSnapshots));
            }

            function renderScenarioList() {
                var sel = document.getElementById('scenarioSelect');
                if (!sel) return;
                sel.innerHTML = '';
                if (!scenarioSnapshots.length) {
                    var opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No saved scenarios';
                    sel.appendChild(opt);
                    selectedScenarioIdx = -1;
                    renderPdfSourceSelectors();
                    return;
                }
                scenarioSnapshots.forEach(function(s, idx) {
                    var opt = document.createElement('option');
                    opt.value = String(idx);
                    opt.textContent = s.name + ' | v' + s.version + ' | ' + s.ts;
                    sel.appendChild(opt);
                });
                renderPdfSourceSelectors();
            }

            function getPdfSourceOptions() {
                var out = [
                    { value: 'live_baseline', label: 'Current Baseline Model' },
                    { value: 'live_optimized', label: 'Current Optimized Model' }
                ];
                scenarioSnapshots.forEach(function(s, idx) {
                    out.push({
                        value: 'scenario:' + idx,
                        label: 'Scenario | ' + s.name + ' | v' + s.version
                    });
                });
                return out;
            }

            function renderPdfSourceSelectors() {
                var ids = ['pdfSingleSource', 'pdfCompareLeft', 'pdfCompareRight'];
                var options = getPdfSourceOptions();
                ids.forEach(function(id) {
                    var el = document.getElementById(id);
                    if (!el) return;
                    var prev = el.value;
                    el.innerHTML = options.map(function(opt) {
                        return '<option value="' + escapeAttr(opt.value) + '">' + escapeHtml(opt.label) + '</option>';
                    }).join('');
                    if (prev && options.some(function(opt) { return opt.value === prev; })) {
                        el.value = prev;
                    }
                });

                var right = document.getElementById('pdfCompareRight');
                if (right && !right.value) right.value = 'live_optimized';
            }

            function resolveModelSource(sourceValue) {
                var val = String(sourceValue || 'live_baseline');
                if (val === 'live_optimized') {
                    var optModel = optimizedModel || baselineModel || computeModel(gatherInputs());
                    return {
                        ok: !!optModel,
                        key: val,
                        label: 'Current Optimized Model',
                        model: optModel,
                        constraints: gatherConstraintState(),
                        rules: Object.assign({}, gateRules),
                        ts: nowIso()
                    };
                }
                if (val === 'live_baseline') {
                    var baseModel = baselineModel || computeModel(gatherInputs());
                    return {
                        ok: !!baseModel,
                        key: val,
                        label: 'Current Baseline Model',
                        model: baseModel,
                        constraints: gatherConstraintState(),
                        rules: Object.assign({}, gateRules),
                        ts: nowIso()
                    };
                }
                if (val.indexOf('scenario:') === 0) {
                    var idx = parseInt(val.split(':')[1], 10);
                    var snap = scenarioSnapshots[idx];
                    if (!snap || !snap.input) return { ok: false, key: val, label: 'Unknown Scenario', model: null };
                    return {
                        ok: true,
                        key: val,
                        label: 'Scenario | ' + snap.name + ' | v' + snap.version,
                        model: computeModel(snap.input),
                        constraints: snap.constraints || gatherConstraintState(),
                        rules: snap.gateRules || Object.assign({}, gateRules),
                        ts: snap.ts || nowIso(),
                        scenario: snap
                    };
                }
                return { ok: false, key: val, label: 'Unknown Source', model: null };
            }

            function extractSankeyFlows(model) {
                if (!model) return null;
                var it = Math.max(model.itKw, 0);
                var elecLoss = Math.max(model.breakdown.elecLoss, 0);
                var auxBase = Math.max(model.itKw * 0.03, 0);
                var fan = Math.max(model.breakdown.aux - auxBase, 0);
                var pump = Math.max(model.breakdown.pump, 0);
                var liquidCore = Math.max(model.breakdown.liquidCooling - pump, 0);
                var air = Math.max(model.breakdown.airCooling, 0);
                var thermal = liquidCore + pump + air + fan;
                var facilityAux = auxBase;
                var total = it + thermal + elecLoss + facilityAux;
                return {
                    it: it,
                    thermal: thermal,
                    elecLoss: elecLoss,
                    facilityAux: facilityAux,
                    liquidCore: liquidCore,
                    pump: pump,
                    air: air,
                    fan: fan,
                    total: total
                };
            }

            function sankeyPct(value, total) {
                if (!isFinite(total) || total <= 0) return '0.0%';
                return fmtNum((value / total) * 100, 1) + '%';
            }

            function scaleDetailParts(parts, total) {
                var safeTotal = Math.max(total || 0, 0);
                var clean = (parts || []).map(function(p) {
                    return {
                        label: p.label,
                        color: p.color || '#64748b',
                        note: p.note || '',
                        value: Math.max(p.value || 0, 0)
                    };
                });
                var sum = clean.reduce(function(acc, p) { return acc + p.value; }, 0);
                if (!clean.length) return clean;
                if (safeTotal <= 0 || sum <= 0) {
                    clean.forEach(function(p) { p.value = 0; });
                    return clean;
                }
                var scaledSum = 0;
                clean.forEach(function(p) {
                    p.value = (p.value / sum) * safeTotal;
                    scaledSum += p.value;
                });
                var delta = safeTotal - scaledSum;
                var maxIdx = 0;
                for (var i = 1; i < clean.length; i++) {
                    if (clean[i].value > clean[maxIdx].value) maxIdx = i;
                }
                clean[maxIdx].value = Math.max(0, clean[maxIdx].value + delta);
                return clean;
            }

            function resolveSankeyContext(model) {
                var modeEl = document.getElementById('sankeyMode');
                var viewMode = modeEl ? modeEl.value : 'auto';
                var activeModel = model || optimizedModel || baselineModel;
                var baseModel = baselineModel || activeModel || computeModel(gatherInputs());
                var optModel = optimizedModel || null;
                if (viewMode === 'baseline') activeModel = baseModel;
                else if (viewMode === 'optimized') activeModel = optModel || baseModel;
                else if (viewMode === 'auto') activeModel = optModel || baseModel;
                return {
                    viewMode: viewMode,
                    activeModel: activeModel,
                    baseModel: baseModel,
                    optModel: optModel,
                    compare: viewMode === 'compare' && !!baseModel && !!optModel
                };
            }

            function sankeyModeLabel(ctx) {
                if (!ctx) return 'active';
                if (ctx.viewMode === 'auto') return ctx.optModel ? 'optimized' : 'baseline';
                return ctx.viewMode;
            }

            function buildSankeyDrillSpec(rawNodeId, model) {
                if (!model) return null;
                var nodeId = String(rawNodeId || '').toLowerCase().trim();
                var flows = extractSankeyFlows(model);
                if (!flows) return null;
                var input = model.input || {};
                var internals = model.internals || {};
                var climateData = CLIMATE_FACTORS[input.climate] || CLIMATE_FACTORS.tropical;
                var captureRatio = clamp(model.effectiveCapture / 100, 0, 1);
                var redundancyFactor = Math.max(internals.redundancyFactor || 1, 1);
                var focus = 0;
                var spec = {
                    nodeId: nodeId,
                    title: 'Sankey Drill-Down',
                    subtitle: 'Detailed sub-distribution from selected model block.',
                    columnTitles: ['Driver Layer', 'Solver Layer', 'Selected Output'],
                    focusValue: 0,
                    focusTotal: flows.total,
                    nodes: [],
                    links: [],
                    rows: [],
                    formulas: [],
                    notes: []
                };

                function rowsFromParts(parts, total) {
                    return parts.map(function(p) {
                        return {
                            label: p.label,
                            value: p.value,
                            pct: sankeyPct(p.value, total),
                            note: p.note || ''
                        };
                    });
                }

                var SENSITIVITY_BOUNDS = {
                    itLoadMw: { min: 0.5, max: 250 },
                    highDensityShare: { min: 0, max: 100 },
                    rackDensityTarget: { min: 5, max: 180 },
                    modelYear: { min: 2026, max: 2045, integer: true },
                    liquidCapture: { min: 0, max: 100 },
                    supplyTemp: { min: 16, max: 42 },
                    returnTemp: { min: 22, max: 60 },
                    pumpHead: { min: 5, max: 90 },
                    pumpEff: { min: 35, max: 95 },
                    hydraulicMargin: { min: 0, max: 45 },
                    controlQuality: { min: 0, max: 100 },
                    predictiveGain: { min: 0, max: 60 },
                    coefHeatTransfer: { min: 60, max: 99 },
                    coefCduLoss: { min: 0.5, max: 4.5 },
                    coefPipeLoss: { min: 0.75, max: 1.8 },
                    coefFutureTech: { min: -10, max: 45 },
                    airCop: { min: 1.5, max: 16 },
                    economizerHours: { min: 0, max: 95 },
                    fanPower: { min: 0.5, max: 12 },
                    upsEff: { min: 90, max: 99.5 },
                    distLoss: { min: 0.5, max: 8 },
                    heatReuse: { min: 0, max: 80 },
                    monitoring: { min: 0, max: 100 }
                };

                var SENSITIVITY_STEP_HINT = {
                    itLoadMw: 0.4,
                    highDensityShare: 2.5,
                    rackDensityTarget: 2.5,
                    modelYear: 1,
                    liquidCapture: 2.5,
                    supplyTemp: 0.4,
                    returnTemp: 0.5,
                    pumpHead: 1.4,
                    pumpEff: 1.2,
                    hydraulicMargin: 1.5,
                    controlQuality: 2.5,
                    predictiveGain: 2,
                    coefHeatTransfer: 0.8,
                    coefCduLoss: 0.08,
                    coefPipeLoss: 0.04,
                    coefFutureTech: 1.5,
                    airCop: 0.14,
                    economizerHours: 2,
                    fanPower: 0.15,
                    upsEff: 0.16,
                    distLoss: 0.09,
                    heatReuse: 2,
                    monitoring: 2.5
                };

                function corrDriver(cfg) {
                    return {
                        key: cfg.key,
                        label: cfg.label,
                        color: cfg.color || '#60a5fa',
                        note: cfg.note || '',
                        weight: Math.max(cfg.weight || 1, 0.1),
                        step: cfg.step,
                        min: cfg.min,
                        max: cfg.max,
                        integer: !!cfg.integer
                    };
                }

                function focusFromFlows(flowSet) {
                    if (!flowSet) return 0;
                    if (nodeId === 'source') return Math.max(flowSet.total || 0, 0);
                    if (nodeId === 'compute') return Math.max(flowSet.it || 0, 0);
                    if (nodeId === 'thermal') return Math.max(flowSet.thermal || 0, 0);
                    if (nodeId === 'elec') return Math.max(flowSet.elecLoss || 0, 0);
                    if (nodeId === 'aux') return Math.max(flowSet.facilityAux || 0, 0);
                    if (nodeId === 'liq') return Math.max(flowSet.liquidCore || 0, 0);
                    if (nodeId === 'pump') return Math.max(flowSet.pump || 0, 0);
                    if (nodeId === 'air') return Math.max(flowSet.air || 0, 0);
                    if (nodeId === 'fan') return Math.max(flowSet.fan || 0, 0);
                    return 0;
                }

                function sensitivityCandidate(key, label, color, note, weight) {
                    var b = SENSITIVITY_BOUNDS[key] || {};
                    return corrDriver({
                        key: key,
                        label: label,
                        color: color,
                        note: note,
                        weight: weight,
                        step: SENSITIVITY_STEP_HINT[key],
                        min: b.min,
                        max: b.max,
                        integer: !!b.integer
                    });
                }

                function buildSensitivityCandidates() {
                    if (nodeId === 'source') {
                        return [
                            sensitivityCandidate('itLoadMw', 'IT Load (MW)', '#2563eb', 'Primary scale driver for total facility power.', 1.5),
                            sensitivityCandidate('liquidCapture', 'Liquid Capture (%)', '#14b8a6', 'Shifts burden between liquid and air branches.', 1.2),
                            sensitivityCandidate('upsEff', 'UPS Efficiency (%)', '#f59e0b', 'Electrical conversion loss sensitivity.', 1.15),
                            sensitivityCandidate('distLoss', 'Distribution Loss (%)', '#d97706', 'Distribution chain loss overhead.', 1.1),
                            sensitivityCandidate('controlQuality', 'Control Quality (%)', '#8b5cf6', 'Control quality impact on cooling efficiency realization.', 0.95),
                            sensitivityCandidate('airCop', 'Air Path COP', '#0284c7', 'Residual air branch efficiency response.', 0.9),
                            sensitivityCandidate('fanPower', 'Fan Power Budget (%IT)', '#16a34a', 'Configured airflow demand envelope.', 0.9)
                        ];
                    }
                    if (nodeId === 'compute') {
                        return [
                            sensitivityCandidate('itLoadMw', 'IT Load (MW)', '#2563eb', 'Direct compute load scaling.', 1.7),
                            sensitivityCandidate('highDensityShare', 'High-Density Share (%)', '#1d4ed8', 'Density concentration on compute envelope.', 1.2),
                            sensitivityCandidate('rackDensityTarget', 'Target Rack Density', '#2563eb', 'Design density target that affects effective compute profile.', 1.0),
                            sensitivityCandidate('modelYear', 'Model Horizon Year', '#0ea5e9', 'Future projection factor on compute envelope.', 0.9)
                        ];
                    }
                    if (nodeId === 'thermal') {
                        return [
                            sensitivityCandidate('liquidCapture', 'Liquid Capture (%)', '#0d9488', 'Primary thermal split between liquid and air.', 1.4),
                            sensitivityCandidate('airCop', 'Air Path COP', '#0284c7', 'Residual air-cooling efficiency burden.', 1.2),
                            sensitivityCandidate('pumpEff', 'Pump Efficiency (%)', '#7c3aed', 'Hydraulic conversion efficiency.', 1.05),
                            sensitivityCandidate('fanPower', 'Fan Power Budget (%IT)', '#16a34a', 'Airflow fan branch demand.', 1.0),
                            sensitivityCandidate('economizerHours', 'Economizer Availability (%)', '#0ea5e9', 'Free-cooling effect on thermal branch.', 0.95),
                            sensitivityCandidate('controlQuality', 'Control Quality (%)', '#8b5cf6', 'Control-led thermal optimization response.', 0.9)
                        ];
                    }
                    if (nodeId === 'elec') {
                        return [
                            sensitivityCandidate('itLoadMw', 'IT Load (MW)', '#2563eb', 'Higher IT load increases conversion losses.', 1.3),
                            sensitivityCandidate('upsEff', 'UPS Efficiency (%)', '#f59e0b', 'Dominant loss driver in UPS chain.', 1.6),
                            sensitivityCandidate('distLoss', 'Distribution Loss (%)', '#d97706', 'PDU and busway loss sensitivity.', 1.35),
                            sensitivityCandidate('modelYear', 'Model Horizon Year', '#0ea5e9', 'Future operation factor influence.', 0.8)
                        ];
                    }
                    if (nodeId === 'aux') {
                        return [
                            sensitivityCandidate('itLoadMw', 'IT Load (MW)', '#64748b', 'Aux baseline scales with facility size.', 1.2),
                            sensitivityCandidate('monitoring', 'Monitoring Coverage (%)', '#475569', 'Monitoring quality affects auxiliary overhead.', 1.1),
                            sensitivityCandidate('controlQuality', 'Control Quality (%)', '#8b5cf6', 'Control maturity impact on support burden.', 0.95),
                            sensitivityCandidate('coefFutureTech', 'Future Tech Multiplier (%)', '#0ea5e9', 'Future efficiency drift on support load.', 0.8)
                        ];
                    }
                    if (nodeId === 'liq') {
                        return [
                            sensitivityCandidate('liquidCapture', 'Liquid Capture (%)', '#0d9488', 'Captured heat fraction feeding liquid loop.', 1.5),
                            sensitivityCandidate('coefCduLoss', 'CDU Loss Coefficient (%)', '#14b8a6', 'CDU parasitic term contribution.', 1.25),
                            sensitivityCandidate('coefHeatTransfer', 'Heat Transfer Effectiveness (%)', '#06b6d4', 'Heat-transfer efficiency in liquid domain.', 1.05),
                            sensitivityCandidate('controlQuality', 'Control Quality (%)', '#8b5cf6', 'Control effect on liquid COP realization.', 0.95),
                            sensitivityCandidate('supplyTemp', 'Liquid Supply Temp (C)', '#0284c7', 'Supply setpoint shift affecting liquid COP.', 0.9),
                            sensitivityCandidate('returnTemp', 'Liquid Return Temp (C)', '#0369a1', 'Return setpoint shift affecting deltaT and flow.', 0.9)
                        ];
                    }
                    if (nodeId === 'pump') {
                        return [
                            sensitivityCandidate('pumpHead', 'Pump Head (m)', '#7c3aed', 'Direct hydraulic work requirement.', 1.5),
                            sensitivityCandidate('pumpEff', 'Pump Efficiency (%)', '#8b5cf6', 'Efficiency loss amplification on pump kW.', 1.45),
                            sensitivityCandidate('hydraulicMargin', 'Hydraulic Margin (%)', '#a855f7', 'Design safety margin overhead.', 1.2),
                            sensitivityCandidate('coefPipeLoss', 'Pipe Loss Multiplier', '#9333ea', 'Pressure-drop multiplier impact.', 1.15),
                            sensitivityCandidate('highDensityShare', 'High-Density Share (%)', '#6d28d9', 'Density-driven hydraulic stress influence.', 0.95)
                        ];
                    }
                    if (nodeId === 'air') {
                        return [
                            sensitivityCandidate('liquidCapture', 'Liquid Capture (%)', '#0284c7', 'Residual uncaptured heat moved to air path.', 1.45),
                            sensitivityCandidate('airCop', 'Air Path COP', '#0ea5e9', 'Air-side COP impact on electrical demand.', 1.35),
                            sensitivityCandidate('economizerHours', 'Economizer Availability (%)', '#1d4ed8', 'Outdoor-air/economizer relief factor.', 1.1),
                            sensitivityCandidate('controlQuality', 'Control Quality (%)', '#8b5cf6', 'Control-induced air branch efficiency shift.', 0.95),
                            sensitivityCandidate('supplyTemp', 'Liquid Supply Temp (C)', '#0369a1', 'Setpoint coupling to residual thermal burden.', 0.8)
                        ];
                    }
                    if (nodeId === 'fan') {
                        return [
                            sensitivityCandidate('fanPower', 'Fan Power Budget (%IT)', '#16a34a', 'Configured facility airflow baseline.', 1.6),
                            sensitivityCandidate('liquidCapture', 'Liquid Capture (%)', '#22c55e', 'Residual-air demand from capture efficiency.', 1.25),
                            sensitivityCandidate('controlQuality', 'Control Quality (%)', '#15803d', 'Control modulation on fan dispatch.', 1.05),
                            sensitivityCandidate('airCop', 'Air Path COP', '#0284c7', 'Air-path efficiency coupling to fan duty.', 0.9),
                            sensitivityCandidate('monitoring', 'Monitoring Coverage (%)', '#65a30d', 'Observability impact on fan optimization.', 0.8)
                        ];
                    }
                    return [
                        sensitivityCandidate('itLoadMw', 'IT Load (MW)', '#2563eb', 'Primary load scaling term.', 1.1),
                        sensitivityCandidate('controlQuality', 'Control Quality (%)', '#8b5cf6', 'Control quality effect.', 1.0),
                        sensitivityCandidate('airCop', 'Air Path COP', '#0284c7', 'Cooling efficiency influence.', 0.9)
                    ];
                }

                function sanitizePerturbedInput(candidate, value, baseInput) {
                    var next = Object.assign({}, baseInput);
                    next[candidate.key] = value;
                    if (candidate.integer) next[candidate.key] = Math.round(next[candidate.key]);
                    if (candidate.key === 'supplyTemp' && next.returnTemp < (next.supplyTemp + 1)) {
                        next.returnTemp = next.supplyTemp + 3;
                    }
                    if (candidate.key === 'returnTemp' && next.returnTemp < (next.supplyTemp + 1)) {
                        next.supplyTemp = Math.max(next.returnTemp - 3, 16);
                    }
                    return next;
                }

                function evaluateSensitivityDriver(candidate, baseInput, baseFocus) {
                    if (!candidate || !candidate.key) return null;
                    var x0 = Number(baseInput[candidate.key]);
                    if (!isFinite(x0)) return null;

                    var minBound = isFinite(candidate.min) ? candidate.min : -Infinity;
                    var maxBound = isFinite(candidate.max) ? candidate.max : Infinity;
                    var step = Math.max(candidate.step || Math.abs(x0) * 0.03 || 0.1, 0.0001);
                    var xPlus = clamp(x0 + step, minBound, maxBound);
                    var xMinus = clamp(x0 - step, minBound, maxBound);
                    if (candidate.integer) {
                        xPlus = Math.round(xPlus);
                        xMinus = Math.round(xMinus);
                    }
                    if (Math.abs(xPlus - xMinus) < 0.000001) return null;

                    var plusInput = sanitizePerturbedInput(candidate, xPlus, baseInput);
                    var minusInput = sanitizePerturbedInput(candidate, xMinus, baseInput);
                    var plusModel = computeModel(plusInput);
                    var minusModel = computeModel(minusInput);
                    var plusFocus = focusFromFlows(extractSankeyFlows(plusModel));
                    var minusFocus = focusFromFlows(extractSankeyFlows(minusModel));
                    if (!isFinite(plusFocus) || !isFinite(minusFocus)) return null;

                    var plusDelta = plusFocus - baseFocus;
                    var minusDelta = minusFocus - baseFocus;
                    var localImpactKw = (Math.abs(plusDelta) + Math.abs(minusDelta)) / 2;
                    var slope = (plusFocus - minusFocus) / Math.max((xPlus - xMinus), 0.000001);
                    var weightedImpact = localImpactKw * Math.max(candidate.weight || 1, 0.1);
                    if (!isFinite(weightedImpact) || weightedImpact <= 0) return null;

                    var stepLabel = candidate.integer
                        ? ('+-' + fmtNum(Math.max(1, Math.round(Math.abs(xPlus - xMinus) / 2)), 0))
                        : ('+-' + fmtNum(Math.abs(xPlus - xMinus) / 2, 3));
                    var dirHint = slope >= 0 ? 'Increasing this input tends to increase selected-node kW.' : 'Increasing this input tends to reduce selected-node kW.';
                    var impactText = candidate.note + ' Local response: +step ' + signed(plusDelta, 1, ' kW') + ', -step ' + signed(minusDelta, 1, ' kW') + '. ' + dirHint;

                    return {
                        label: candidate.label,
                        color: candidate.color,
                        note: impactText,
                        key: candidate.key,
                        stepLabel: stepLabel,
                        plusDelta: plusDelta,
                        minusDelta: minusDelta,
                        slope: slope,
                        localImpactKw: localImpactKw,
                        weightedImpact: weightedImpact
                    };
                }

                function buildCorrelationDrivers() {
                    var baseInput = Object.assign({}, input);
                    var baseFocus = focusFromFlows(flows);
                    var candidates = buildSensitivityCandidates();
                    var drivers = [];

                    candidates.forEach(function(candidate) {
                        var d = evaluateSensitivityDriver(candidate, baseInput, baseFocus);
                        if (d) drivers.push(d);
                    });

                    drivers.sort(function(a, b) { return b.weightedImpact - a.weightedImpact; });
                    if (drivers.length > 8) drivers = drivers.slice(0, 8);
                    return drivers;
                }

                function expandSpecWithCorrelation() {
                    if (!(focus > 0)) return;
                    var entryNodes = spec.nodes.filter(function(n) { return n.col === 0; });
                    if (!entryNodes.length) return;
                    var drivers = buildCorrelationDrivers();
                    if (!drivers.length) return;

                    var entryValue = {};
                    entryNodes.forEach(function(n) { entryValue[n.id] = 0; });
                    spec.links.forEach(function(l) {
                        if (entryValue.hasOwnProperty(l.from)) {
                            entryValue[l.from] += Math.max(l.value || 0, 0);
                        }
                    });
                    var entryTotal = entryNodes.reduce(function(acc, n) { return acc + entryValue[n.id]; }, 0);
                    if (entryTotal <= 0.0001) {
                        entryNodes.forEach(function(n) { entryValue[n.id] = 1; });
                        entryTotal = entryNodes.length;
                    }

                    var weightedTotal = drivers.reduce(function(acc, d) {
                        return acc + Math.max(d.weightedImpact || 0, 0);
                    }, 0);
                    weightedTotal = Math.max(weightedTotal, 0.0001);
                    var maxWeighted = drivers.reduce(function(acc, d) {
                        return Math.max(acc, d.weightedImpact || 0);
                    }, 0);
                    maxWeighted = Math.max(maxWeighted, 0.0001);

                    drivers.forEach(function(d, idx) {
                        d.contributionKw = focus * ((d.weightedImpact || 0) / weightedTotal);
                        d.corrIndex = clamp(((d.weightedImpact || 0) / maxWeighted) * 100, 0.1, 100);
                        d.id = 'pc_' + idx;
                    });

                    spec.nodes.forEach(function(n) { n.col += 1; });
                    spec.columnTitles = ['Parameter Sensitivity', 'Driver Layer', 'Solver Layer', 'Selected Output'];

                    drivers.forEach(function(d) {
                        spec.nodes.push({
                            id: d.id,
                            label: d.label,
                            col: 0,
                            color: d.color
                        });
                        entryNodes.forEach(function(en) {
                            var share = entryValue[en.id] / entryTotal;
                            spec.links.push({
                                from: d.id,
                                to: en.id,
                                value: d.contributionKw * share,
                                color: d.color,
                                label: d.label + ' sensitivity'
                            });
                        });
                    });

                    spec.corrRows = drivers.map(function(d) {
                        return {
                            param: d.label,
                            corr: fmtNum(d.corrIndex, 1) + '/100',
                            kw: fmtNum(d.contributionKw, 1) + ' kW',
                            impact: d.note + ' Step ' + d.stepLabel + ' [' + d.key + ']'
                        };
                    });
                    spec.formulas.push('Sensitivity: S_i ~= (kW(x_i + dx_i) - kW(x_i - dx_i)) / (2 * dx_i), evaluated around current operating point.');
                    spec.formulas.push('kW allocation: kW_i = selectedNode_kW * normalized(|localDelta_i| * roleWeight_i).');
                    spec.notes.unshift('Expanded mode uses local finite-difference sensitivity per parameter, then normalizes influence into selected-node kW envelope.');
                }

                if (nodeId === 'source') {
                    focus = flows.total;
                    var sourceParts = [
                        { label: 'IT Compute', value: flows.it, color: '#2563eb', note: 'Direct productive compute load.' },
                        { label: 'Thermal Management', value: flows.thermal, color: '#0891b2', note: 'Cooling + hydraulic + fan envelope.' },
                        { label: 'Electrical Loss', value: flows.elecLoss, color: '#d97706', note: 'UPS and distribution conversion losses.' },
                        { label: 'Facility Aux', value: flows.facilityAux, color: '#64748b', note: 'Lighting/control/safety base auxiliary.' }
                    ];
                    spec.title = 'Total Facility Input | Detailed Distribution';
                    spec.subtitle = 'Top-level plant power split across primary functional domains.';
                    spec.nodes = [
                        { id: 'f_total', label: 'Total Facility Input', col: 0, color: '#1d4ed8' },
                        { id: 'f_it', label: 'IT Compute', col: 1, color: '#2563eb' },
                        { id: 'f_thermal', label: 'Thermal Mgmt', col: 1, color: '#0891b2' },
                        { id: 'f_elec', label: 'Electrical Loss', col: 1, color: '#d97706' },
                        { id: 'f_aux', label: 'Facility Aux', col: 1, color: '#64748b' }
                    ];
                    spec.links = sourceParts.map(function(p, idx) {
                        return { from: 'f_total', to: ['f_it', 'f_thermal', 'f_elec', 'f_aux'][idx], value: p.value, color: p.color, label: p.label + ' ' + fmtNum(p.value, 0) + ' kW' };
                    });
                    spec.rows = rowsFromParts(sourceParts, focus);
                    spec.formulas = [
                        'FacilityTotal = IT + Thermal + ElectricalLoss + FacilityAux',
                        'FacilityTotal = ' + fmtNum(flows.it, 0) + ' + ' + fmtNum(flows.thermal, 0) + ' + ' + fmtNum(flows.elecLoss, 0) + ' + ' + fmtNum(flows.facilityAux, 0),
                        'FacilityTotal = ' + fmtNum(flows.total, 0) + ' kW'
                    ];
                    spec.notes = [
                        'This is the canonical top-level allocation used by KPI and cost layers.',
                        'Use this node to validate whether non-IT overhead stays inside governance envelope.',
                        'Primary efficiency leverage usually comes from reducing thermal and electrical-loss fractions.'
                    ];
                } else if (nodeId === 'compute') {
                    focus = flows.it;
                    var highDensityIt = model.itKw * clamp((input.highDensityShare || 0) / 100, 0, 1);
                    var standardIt = Math.max(model.itKw - highDensityIt, 0);
                    var computeParts = scaleDetailParts([
                        { label: 'High-Density Racks', value: highDensityIt, color: '#1d4ed8', note: 'AI/HPC high-density rack segment.' },
                        { label: 'Standard Density Racks', value: standardIt, color: '#3b82f6', note: 'Conventional density rack segment.' }
                    ], focus);
                    var hdToLiquid = computeParts[0].value * captureRatio;
                    var hdToAir = computeParts[0].value - hdToLiquid;
                    var stdToLiquid = computeParts[1].value * captureRatio;
                    var stdToAir = computeParts[1].value - stdToLiquid;
                    spec.title = 'IT Compute | Rack + Heat Routing Detail';
                    spec.subtitle = 'Compute load split by rack density and routed to liquid vs air path.';
                    spec.nodes = [
                        { id: 'c_it', label: 'IT Compute', col: 0, color: '#2563eb' },
                        { id: 'c_hd', label: 'High-Density Racks', col: 1, color: '#1d4ed8' },
                        { id: 'c_std', label: 'Standard Racks', col: 1, color: '#3b82f6' },
                        { id: 'c_liq', label: 'Heat to Liquid Path', col: 2, color: '#0d9488' },
                        { id: 'c_air', label: 'Heat to Air Path', col: 2, color: '#0284c7' }
                    ];
                    spec.links = [
                        { from: 'c_it', to: 'c_hd', value: computeParts[0].value, color: '#1d4ed8', label: 'High-density IT' },
                        { from: 'c_it', to: 'c_std', value: computeParts[1].value, color: '#3b82f6', label: 'Standard IT' },
                        { from: 'c_hd', to: 'c_liq', value: hdToLiquid, color: '#0d9488', label: 'HD -> liquid path' },
                        { from: 'c_hd', to: 'c_air', value: hdToAir, color: '#0284c7', label: 'HD -> air path' },
                        { from: 'c_std', to: 'c_liq', value: stdToLiquid, color: '#0d9488', label: 'STD -> liquid path' },
                        { from: 'c_std', to: 'c_air', value: stdToAir, color: '#0284c7', label: 'STD -> air path' }
                    ];
                    spec.rows = rowsFromParts([
                        computeParts[0],
                        computeParts[1],
                        { label: 'Routed to Liquid Path', value: model.liquidKw, color: '#0d9488', note: 'Effective capture-routed IT heat load.' },
                        { label: 'Routed to Air Path', value: model.airKw, color: '#0284c7', note: 'Residual IT heat for air path.' }
                    ], focus);
                    spec.formulas = [
                        'highDensityIT = IT * highDensityShare',
                        'liquidRouted = IT * effectiveCapture',
                        'airRouted = IT - liquidRouted',
                        'highDensityIT = ' + fmtNum(computeParts[0].value, 0) + ' kW | standardIT = ' + fmtNum(computeParts[1].value, 0) + ' kW',
                        'liquidRouted = ' + fmtNum(model.liquidKw, 0) + ' kW | airRouted = ' + fmtNum(model.airKw, 0) + ' kW'
                    ];
                    spec.notes = [
                        'High-density share drives concentration, hydraulic stress, and control sensitivity.',
                        'Effective capture directly governs how much thermal load exits to liquid vs air engines.',
                        'This split is upstream of COP, pump power, and total overhead behavior.'
                    ];
                } else if (nodeId === 'thermal') {
                    focus = flows.thermal;
                    var thermalParts = [
                        { label: 'Liquid Loop', value: flows.liquidCore, color: '#0d9488', note: 'Liquid cooling power excluding pump drive.' },
                        { label: 'Pump Drive', value: flows.pump, color: '#7c3aed', note: 'Hydraulic pumping electrical demand.' },
                        { label: 'Air Path', value: flows.air, color: '#0284c7', note: 'Residual heat air-cooling burden.' },
                        { label: 'Fan Power', value: flows.fan, color: '#16a34a', note: 'CRAH/CRAC and airflow power share.' }
                    ];
                    spec.title = 'Thermal Management | Branch Breakdown';
                    spec.subtitle = 'Thermal domain decomposition into liquid, pump, air, and fan branches.';
                    spec.nodes = [
                        { id: 't_total', label: 'Thermal Management', col: 0, color: '#0891b2' },
                        { id: 't_liq', label: 'Liquid Loop', col: 1, color: '#0d9488' },
                        { id: 't_pump', label: 'Pump Drive', col: 1, color: '#7c3aed' },
                        { id: 't_air', label: 'Air Path', col: 1, color: '#0284c7' },
                        { id: 't_fan', label: 'Fan Power', col: 1, color: '#16a34a' }
                    ];
                    spec.links = thermalParts.map(function(p, idx) {
                        return { from: 't_total', to: ['t_liq', 't_pump', 't_air', 't_fan'][idx], value: p.value, color: p.color, label: p.label };
                    });
                    spec.rows = rowsFromParts(thermalParts, focus);
                    spec.formulas = [
                        'Thermal = LiquidCore + Pump + Air + Fan',
                        fmtNum(focus, 0) + ' = ' + fmtNum(flows.liquidCore, 0) + ' + ' + fmtNum(flows.pump, 0) + ' + ' + fmtNum(flows.air, 0) + ' + ' + fmtNum(flows.fan, 0) + ' kW'
                    ];
                    spec.notes = [
                        'Liquid loop is usually the dominant branch in high-capture architectures.',
                        'Pump and fan branches are secondary overhead but often primary optimization levers.',
                        'This block directly influences COP, PUE gap, and net OPEX.'
                    ];
                } else if (nodeId === 'elec') {
                    focus = flows.elecLoss;
                    var upsInput = model.itKw / Math.max((input.upsEff || 96.5) / 100, 0.9);
                    var upsLoss = Math.max(upsInput - model.itKw, 0);
                    var distLoss = Math.max(upsInput * ((input.distLoss || 0) / 100), 0);
                    var elecParts = scaleDetailParts([
                        { label: 'UPS Conversion Loss', value: upsLoss, color: '#f59e0b', note: 'Rectifier/inverter conversion overhead.' },
                        { label: 'Distribution Loss', value: distLoss, color: '#d97706', note: 'PDU/busway/distribution line losses.' }
                    ], focus);
                    spec.title = 'Electrical Loss | Conversion Detail';
                    spec.subtitle = 'Power chain losses from UPS conversion and downstream distribution.';
                    spec.nodes = [
                        { id: 'e_total', label: 'Electrical Loss', col: 0, color: '#d97706' },
                        { id: 'e_ups', label: 'UPS Loss', col: 1, color: '#f59e0b' },
                        { id: 'e_dist', label: 'Distribution Loss', col: 1, color: '#d97706' }
                    ];
                    spec.links = [
                        { from: 'e_total', to: 'e_ups', value: elecParts[0].value, color: '#f59e0b', label: 'UPS conversion loss' },
                        { from: 'e_total', to: 'e_dist', value: elecParts[1].value, color: '#d97706', label: 'Distribution loss' }
                    ];
                    spec.rows = rowsFromParts(elecParts, focus);
                    spec.formulas = [
                        'upsInput = IT / UPS_eff',
                        'upsLoss = upsInput - IT',
                        'distLoss = upsInput * distLossPct',
                        'ElectricalLoss = upsLoss + distLoss = ' + fmtNum(focus, 0) + ' kW'
                    ];
                    spec.notes = [
                        'Electrical loss typically scales with IT load and efficiency profile of UPS + distribution chain.',
                        'Raising UPS efficiency and lowering distribution loss directly improves PUE.',
                        'Loss bucket does not contribute to productive compute work.'
                    ];
                } else if (nodeId === 'aux') {
                    focus = flows.facilityAux;
                    var monitorRatio = clamp((input.monitoring || 80) / 100, 0.1, 1);
                    var auxParts = scaleDetailParts([
                        { label: 'BMS + Controls', value: 0.34 + (monitorRatio * 0.16), color: '#64748b', note: 'Building management systems and control backbone.' },
                        { label: 'Lighting + Safety', value: 0.28 - (monitorRatio * 0.08), color: '#94a3b8', note: 'Lighting, safety, and static support loads.' },
                        { label: 'Misc Facility Support', value: 0.38 - (monitorRatio * 0.08), color: '#475569', note: 'Security, services, and miscellaneous auxiliaries.' }
                    ], focus);
                    spec.title = 'Facility Aux | Support Load Breakdown';
                    spec.subtitle = 'Base non-process facility support consumption allocation.';
                    spec.nodes = [
                        { id: 'a_total', label: 'Facility Aux', col: 0, color: '#64748b' },
                        { id: 'a_bms', label: 'BMS + Controls', col: 1, color: '#64748b' },
                        { id: 'a_light', label: 'Lighting + Safety', col: 1, color: '#94a3b8' },
                        { id: 'a_misc', label: 'Misc Support', col: 1, color: '#475569' }
                    ];
                    spec.links = [
                        { from: 'a_total', to: 'a_bms', value: auxParts[0].value, color: '#64748b', label: 'BMS + control backbone' },
                        { from: 'a_total', to: 'a_light', value: auxParts[1].value, color: '#94a3b8', label: 'Lighting and safety loads' },
                        { from: 'a_total', to: 'a_misc', value: auxParts[2].value, color: '#475569', label: 'Misc facility services' }
                    ];
                    spec.rows = rowsFromParts(auxParts, focus);
                    spec.formulas = [
                        'FacilityAux baseline ~= IT * 3%',
                        'FacilityAux = ' + fmtNum(model.itKw, 0) + ' * 0.03 = ' + fmtNum(focus, 0) + ' kW',
                        'Allocation profile responds to monitoring maturity (control-heavy vs static support).'
                    ];
                    spec.notes = [
                        'Facility aux is smaller than thermal load but material for best-in-class efficiency tuning.',
                        'Operational practices and digital controls can shift this profile meaningfully.',
                        'This bucket excludes fan power, which is represented under thermal management.'
                    ];
                } else if (nodeId === 'liq') {
                    focus = flows.liquidCore;
                    var liquidCop = Math.max(internals.liquidCop || 1, 1);
                    var cduLossKw = Math.max(model.liquidKw * ((input.coefCduLoss || 0) / 100), 0);
                    var liquidParts = scaleDetailParts([
                        { label: 'Captured IT Heat Conversion', value: model.liquidKw / liquidCop, color: '#0d9488', note: 'Liquid-captured IT load converted by liquid COP.' },
                        { label: 'CDU Parasitic Recovery', value: cduLossKw / liquidCop, color: '#14b8a6', note: 'CDU loss burden propagated into liquid power demand.' }
                    ], focus);
                    spec.title = 'Liquid Loop | Detailed Solver Decomposition';
                    spec.subtitle = 'Contribution of captured IT heat and CDU parasitic burden to liquid-loop energy.';
                    spec.nodes = [
                        { id: 'l_capture', label: 'Captured Heat Duty', col: 0, color: '#0d9488' },
                        { id: 'l_cdu', label: 'CDU Loss Duty', col: 0, color: '#14b8a6' },
                        { id: 'l_solver', label: 'Liquid Thermal Solver', col: 1, color: '#0891b2' },
                        { id: 'l_out', label: 'Liquid Loop', col: 2, color: '#0d9488' }
                    ];
                    spec.links = [
                        { from: 'l_capture', to: 'l_solver', value: liquidParts[0].value, color: '#0d9488', label: 'Captured duty / liquid COP' },
                        { from: 'l_cdu', to: 'l_solver', value: liquidParts[1].value, color: '#14b8a6', label: 'CDU duty / liquid COP' },
                        { from: 'l_solver', to: 'l_out', value: focus, color: '#0d9488', label: 'Liquid loop net power' }
                    ];
                    spec.rows = rowsFromParts(liquidParts, focus);
                    spec.formulas = [
                        'liquidCore = (liquidCaptured + cduLoss) / liquidCOP',
                        'liquidCaptured = ' + fmtNum(model.liquidKw, 0) + ' kWth | cduLoss = ' + fmtNum(cduLossKw, 0) + ' kWth',
                        'liquidCOP = ' + fmtNum(liquidCop, 2),
                        'liquidCore = ' + fmtNum(focus, 0) + ' kW'
                    ];
                    spec.notes = [
                        'Higher liquid COP directly lowers this branch while keeping thermal transport capacity.',
                        'CDU loss coefficient controls parasitic burden entering liquid domain.',
                        'This branch excludes pump drive, which is tracked separately for hydraulic diagnostics.'
                    ];
                } else if (nodeId === 'pump') {
                    focus = flows.pump;
                    var pumpFactors = scaleDetailParts([
                        { label: 'Static Head Requirement', value: Math.max(input.pumpHead || 1, 1), color: '#7c3aed', note: 'Nominal vertical/lift and base hydraulic head.' },
                        { label: 'Pipe Friction Multiplier', value: Math.max((input.coefPipeLoss || 1) - 0.85, 0.15), color: '#8b5cf6', note: 'Pipe complexity and pressure-drop multiplier.' },
                        { label: 'Hydraulic Margin', value: Math.max((input.hydraulicMargin || 0) / 100, 0.05), color: '#a855f7', note: 'Design safety margin for uncertain operating envelope.' },
                        { label: 'Redundancy Overhead', value: Math.max(redundancyFactor - 1, 0.05), color: '#9333ea', note: 'N+1 / 2N redundancy circulation overhead.' },
                        { label: 'Density Stress Effect', value: Math.max((internals.densityStress || 1) - 1, 0.05), color: '#6d28d9', note: 'Rack density impact on effective pumping requirement.' }
                    ], focus);
                    spec.title = 'Pump Drive | Hydraulic Driver Detail';
                    spec.subtitle = 'Pump branch decomposition by hydraulic design and reliability drivers.';
                    spec.nodes = [
                        { id: 'p_h1', label: 'Static Head', col: 0, color: '#7c3aed' },
                        { id: 'p_h2', label: 'Pipe Friction', col: 0, color: '#8b5cf6' },
                        { id: 'p_h3', label: 'Hydraulic Margin', col: 0, color: '#a855f7' },
                        { id: 'p_h4', label: 'Redundancy', col: 0, color: '#9333ea' },
                        { id: 'p_h5', label: 'Density Stress', col: 0, color: '#6d28d9' },
                        { id: 'p_solver', label: 'Hydraulic Solver', col: 1, color: '#7c3aed' },
                        { id: 'p_out', label: 'Pump Drive', col: 2, color: '#7c3aed' }
                    ];
                    spec.links = [
                        { from: 'p_h1', to: 'p_solver', value: pumpFactors[0].value, color: pumpFactors[0].color, label: pumpFactors[0].label },
                        { from: 'p_h2', to: 'p_solver', value: pumpFactors[1].value, color: pumpFactors[1].color, label: pumpFactors[1].label },
                        { from: 'p_h3', to: 'p_solver', value: pumpFactors[2].value, color: pumpFactors[2].color, label: pumpFactors[2].label },
                        { from: 'p_h4', to: 'p_solver', value: pumpFactors[3].value, color: pumpFactors[3].color, label: pumpFactors[3].label },
                        { from: 'p_h5', to: 'p_solver', value: pumpFactors[4].value, color: pumpFactors[4].color, label: pumpFactors[4].label },
                        { from: 'p_solver', to: 'p_out', value: focus, color: '#7c3aed', label: 'Pump drive net power' }
                    ];
                    spec.rows = rowsFromParts(pumpFactors, focus);
                    spec.formulas = [
                        'pumpPower = rho * g * headEff * flow / pumpEff',
                        'headEff=' + fmtNum(internals.pumpHeadEff || 0, 2) + ' m | flow=' + fmtNum(model.flowLpm, 0) + ' LPM | pumpEff=' + fmtNum(input.pumpEff || 0, 1) + '%',
                        'pumpPower=' + fmtNum(focus, 1) + ' kW'
                    ];
                    spec.notes = [
                        'Pump branch strongly responds to flow, head, and efficiency terms.',
                        'Pipe multiplier + hydraulic margin can inflate energy significantly if over-conservative.',
                        'Keep pump % IT under hard threshold for robust efficiency envelope.'
                    ];
                } else if (nodeId === 'air') {
                    focus = flows.air;
                    var climatePenalty = Math.max((0.6 - (climateData.climateCopBias || 0)) * 0.75, 0.1);
                    var econPenalty = Math.max(1 - clamp(internals.economizerFraction || 0, 0, 1), 0.08);
                    var controlPenalty = Math.max(1 - clamp(model.controlIndex / 100, 0, 1), 0.08);
                    var residualRatio = clamp(model.airKw / Math.max(model.itKw, 1), 0.02, 1);
                    var airParts = scaleDetailParts([
                        { label: 'Residual Heat Duty', value: residualRatio * 1.4, color: '#0284c7', note: 'Uncaptured IT heat routed to air path.' },
                        { label: 'Climate + Wet-Bulb Effect', value: climatePenalty, color: '#0ea5e9', note: 'Ambient climate impact on air-path efficiency.' },
                        { label: 'Control/Economizer Penalty', value: econPenalty + controlPenalty, color: '#0369a1', note: 'Operational and control limitations reducing air-path COP.' }
                    ], focus);
                    spec.title = 'Air Path | Contribution Breakdown';
                    spec.subtitle = 'Residual thermal duty and operating-condition contributions to air-path power.';
                    spec.nodes = [
                        { id: 'ar_h1', label: 'Residual Heat Duty', col: 0, color: '#0284c7' },
                        { id: 'ar_h2', label: 'Climate Effect', col: 0, color: '#0ea5e9' },
                        { id: 'ar_h3', label: 'Control + Economizer', col: 0, color: '#0369a1' },
                        { id: 'ar_solver', label: 'Air Thermal Solver', col: 1, color: '#0284c7' },
                        { id: 'ar_out', label: 'Air Path', col: 2, color: '#0284c7' }
                    ];
                    spec.links = [
                        { from: 'ar_h1', to: 'ar_solver', value: airParts[0].value, color: airParts[0].color, label: airParts[0].label },
                        { from: 'ar_h2', to: 'ar_solver', value: airParts[1].value, color: airParts[1].color, label: airParts[1].label },
                        { from: 'ar_h3', to: 'ar_solver', value: airParts[2].value, color: airParts[2].color, label: airParts[2].label },
                        { from: 'ar_solver', to: 'ar_out', value: focus, color: '#0284c7', label: 'Air path net power' }
                    ];
                    spec.rows = rowsFromParts(airParts, focus);
                    spec.formulas = [
                        'airPath = residualAirHeat / airCOPEffective',
                        'residualAirHeat=' + fmtNum(model.airKw, 0) + ' kWth | airCOPEffective=' + fmtNum(internals.airCopEff || 0, 2),
                        'airPath=' + fmtNum(focus, 1) + ' kW'
                    ];
                    spec.notes = [
                        'Air branch falls as liquid capture rises and air COP improves.',
                        'Climate profile and economizer availability move this branch materially.',
                        'Control quality affects the effective air-path efficiency through operating strategy.'
                    ];
                } else if (nodeId === 'fan') {
                    focus = flows.fan;
                    var controlBonus = (model.controlIndex - 60) / 180;
                    var captureFactor = clamp(1 - (model.effectiveCapture / 100) * 0.55, 0.3, 1);
                    var controlFactor = clamp(1 - (controlBonus * 0.18), 0.6, 1.15);
                    var fanParts = scaleDetailParts([
                        { label: 'Base Airflow Budget', value: Math.max(input.fanPower || 1, 0.2), color: '#16a34a', note: 'Configured airflow budget relative to IT load.' },
                        { label: 'Residual-Air Requirement', value: Math.max(captureFactor, 0.15), color: '#22c55e', note: 'Effective liquid-capture reduction effect on airflow demand.' },
                        { label: 'Control Modulation', value: Math.max(controlFactor, 0.15), color: '#15803d', note: 'Control quality modulation impact on fan dispatch.' }
                    ], focus);
                    spec.title = 'Fan Power | Airflow Driver Breakdown';
                    spec.subtitle = 'Fan branch decomposition across budget, capture condition, and control modulation.';
                    spec.nodes = [
                        { id: 'fn_h1', label: 'Airflow Budget', col: 0, color: '#16a34a' },
                        { id: 'fn_h2', label: 'Residual-Air Need', col: 0, color: '#22c55e' },
                        { id: 'fn_h3', label: 'Control Modulation', col: 0, color: '#15803d' },
                        { id: 'fn_solver', label: 'Airflow Solver', col: 1, color: '#16a34a' },
                        { id: 'fn_out', label: 'Fan Power', col: 2, color: '#16a34a' }
                    ];
                    spec.links = [
                        { from: 'fn_h1', to: 'fn_solver', value: fanParts[0].value, color: fanParts[0].color, label: fanParts[0].label },
                        { from: 'fn_h2', to: 'fn_solver', value: fanParts[1].value, color: fanParts[1].color, label: fanParts[1].label },
                        { from: 'fn_h3', to: 'fn_solver', value: fanParts[2].value, color: fanParts[2].color, label: fanParts[2].label },
                        { from: 'fn_solver', to: 'fn_out', value: focus, color: '#16a34a', label: 'Fan power net demand' }
                    ];
                    spec.rows = rowsFromParts(fanParts, focus);
                    spec.formulas = [
                        'fanPower = IT * fanPowerPct * captureFactor * controlFactor',
                        'fanPowerPct=' + fmtNum(input.fanPower || 0, 2) + '% | captureFactor=' + fmtNum(captureFactor, 3) + ' | controlFactor=' + fmtNum(controlFactor, 3),
                        'fanPower=' + fmtNum(focus, 1) + ' kW'
                    ];
                    spec.notes = [
                        'Fan branch is tied to residual air-cooling requirement, not total IT directly.',
                        'Higher liquid capture and stronger control generally reduce required fan dispatch.',
                        'Use this block to validate CRAH/CRAC airflow burden assumptions.'
                    ];
                } else {
                    return buildSankeyDrillSpec('source', model);
                }

                spec.focusValue = Math.max(focus, 0);
                expandSpecWithCorrelation();
                return spec;
            }

            function buildSankeyDrillSvg(spec) {
                if (!spec || !spec.nodes || !spec.links) return { svg: '', w: 960, h: 360, minWidth: 920 };
                var h = 360;
                var nodeW = 24;
                var maxCol = 0;
                spec.nodes.forEach(function(n) {
                    maxCol = Math.max(maxCol, Math.round(n.col || 0));
                });
                var colCount = Math.max(3, maxCol + 1);
                var w = Math.max(980, 280 + (colCount * 230));
                var pad = { t: 34, r: 120, b: 30, l: 28 };
                var usableW = w - pad.l - pad.r - nodeW;
                var colStep = colCount > 1 ? (usableW / (colCount - 1)) : 0;
                var colXs = [];
                for (var ci = 0; ci < colCount; ci++) colXs.push(pad.l + (ci * colStep));
                var nodeMap = {};
                var colNodes = [];
                for (var cidx = 0; cidx < colCount; cidx++) colNodes.push([]);

                spec.nodes.forEach(function(n) {
                    var c = clamp(n.col || 0, 0, colCount - 1);
                    nodeMap[n.id] = {
                        id: n.id,
                        label: n.label,
                        col: c,
                        color: n.color || '#64748b',
                        value: 0,
                        inValue: 0,
                        outValue: 0,
                        inW: 0,
                        outW: 0,
                        h: 18,
                        x: colXs[c],
                        y: 0
                    };
                    colNodes[c].push(nodeMap[n.id]);
                });

                var focus = Math.max(spec.focusValue || 0, 1);
                var linkScale = 128 / focus;
                var links = spec.links.map(function(l) {
                    var val = Math.max(l.value || 0, 0);
                    var fromNode = nodeMap[l.from];
                    var toNode = nodeMap[l.to];
                    if (!fromNode || !toNode) return null;
                    var width = clamp(val * linkScale, 2.4, 62);
                    fromNode.outW += width + 0.6;
                    toNode.inW += width + 0.6;
                    fromNode.outValue += val;
                    toNode.inValue += val;
                    fromNode.value = Math.max(fromNode.value, fromNode.outValue, fromNode.inValue);
                    toNode.value = Math.max(toNode.value, toNode.inValue, toNode.outValue);
                    return {
                        from: fromNode,
                        to: toNode,
                        value: val,
                        width: width,
                        color: l.color || fromNode.color,
                        label: l.label || ''
                    };
                }).filter(Boolean);

                Object.keys(nodeMap).forEach(function(id) {
                    var n = nodeMap[id];
                    var demand = Math.max(n.inW, n.outW, 8);
                    n.h = clamp(demand + 12, 16, 126);
                    if (n.value <= 0 && n.inW <= 0 && n.outW <= 0) n.h = 18;
                });

                var availableH = h - pad.t - pad.b - 24;
                colNodes.forEach(function(nodes) {
                    if (!nodes.length) return;
                    var gap = 14;
                    var totalH = nodes.reduce(function(acc, n) { return acc + n.h; }, 0) + (gap * (nodes.length - 1));
                    if (totalH > availableH) {
                        var ratio = availableH / Math.max(totalH, 1);
                        gap = Math.max(6, gap * ratio);
                        nodes.forEach(function(n) { n.h = Math.max(12, n.h * ratio); });
                    }
                    var cursor = pad.t + 26;
                    nodes.forEach(function(n) {
                        n.y = cursor;
                        cursor += n.h + gap;
                    });
                });

                Object.keys(nodeMap).forEach(function(id) {
                    nodeMap[id].inOffset = 0;
                    nodeMap[id].outOffset = 0;
                });

                var linksSvg = links.map(function(lk) {
                    var from = lk.from;
                    var to = lk.to;
                    var y0 = from.y + 4 + lk.width / 2 + from.outOffset;
                    var y1 = to.y + 4 + lk.width / 2 + to.inOffset;
                    from.outOffset += lk.width + 0.6;
                    to.inOffset += lk.width + 0.6;
                    var path = sankeyBandPath(from.x + nodeW, y0, to.x, y1, lk.width);
                    var title = (lk.label ? lk.label + ' | ' : '') + fmtNum(lk.value, 0) + ' kW';
                    return '<path d="' + path + '" fill="' + lk.color + '" fill-opacity="0.46" stroke="' + lk.color + '" stroke-opacity="0.72" stroke-width="0.7"><title>' + escapeHtml(title) + '</title></path>';
                }).join('');

                var nodeOrder = Object.keys(nodeMap).map(function(k) { return nodeMap[k]; }).sort(function(a, b) {
                    if (a.col !== b.col) return a.col - b.col;
                    return a.y - b.y;
                });

                var nodesSvg = nodeOrder.map(function(n) {
                    var pct = spec.focusValue > 0 ? (' | ' + sankeyPct(n.value, spec.focusValue)) : '';
                    var isLastCol = n.col >= (colCount - 1);
                    var labelX = isLastCol ? (n.x - 8) : (n.x + nodeW + 8);
                    var anchor = isLastCol ? 'end' : 'start';
                    return '<g>' +
                        '<rect x="' + n.x + '" y="' + fmtNum(n.y, 2) + '" width="' + nodeW + '" height="' + fmtNum(n.h, 2) + '" rx="5" fill="' + n.color + '" fill-opacity="0.92" stroke="rgba(15,23,42,0.45)"></rect>' +
                        '<text x="' + fmtNum(labelX, 2) + '" y="' + fmtNum(n.y + 12, 2) + '" fill="currentColor" font-size="11" text-anchor="' + anchor + '">' + escapeHtml(n.label) + '</text>' +
                        '<text x="' + fmtNum(labelX, 2) + '" y="' + fmtNum(n.y + 24, 2) + '" fill="currentColor" opacity="0.78" font-size="10" text-anchor="' + anchor + '">' + fmtNum(n.value, 0) + ' kW' + pct + '</text>' +
                    '</g>';
                }).join('');

                var titles = spec.columnTitles || ['Driver Layer', 'Solver Layer', 'Selected Output'];
                var headerSvg = [];
                for (var ti = 0; ti < colCount; ti++) {
                    headerSvg.push('<text x="' + colXs[ti] + '" y="24" fill="currentColor" opacity="0.86" font-size="11">' + escapeHtml(titles[ti] || ('Layer ' + (ti + 1))) + '</text>');
                }
                var splitSvg = [];
                for (var si = 1; si < colCount; si++) {
                    var sx = (colXs[si - 1] + colXs[si]) / 2;
                    splitSvg.push('<line x1="' + fmtNum(sx, 2) + '" y1="34" x2="' + fmtNum(sx, 2) + '" y2="' + (h - 24) + '" stroke="rgba(148,163,184,0.18)" stroke-dasharray="2 4"></line>');
                }
                return {
                    w: w,
                    h: h,
                    minWidth: Math.max(940, w),
                    svg: [
                    '<rect x="0" y="0" width="' + w + '" height="' + h + '" fill="transparent"></rect>',
                    headerSvg.join(''),
                    splitSvg.join(''),
                    linksSvg,
                    nodesSvg,
                    '<text x="18" y="' + (h - 10) + '" fill="currentColor" opacity="0.7" font-size="10">Expanded drill values are normalized to selected node envelope: ' + fmtNum(spec.focusValue || 0, 0) + ' kW.</text>'
                    ].join('')
                };
            }

            function renderSankeyDrillRows(spec) {
                if (!spec || !spec.rows || !spec.rows.length) return '<div class="muted">No contribution rows available for this node.</div>';
                return '<table class="sankey-drill-table"><thead><tr><th>Component</th><th>Value</th><th>Share</th><th>Notes</th></tr></thead><tbody>' +
                    spec.rows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.label) + '</td><td>' + fmtNum(r.value, 1) + ' kW</td><td>' + escapeHtml(r.pct || '-') + '</td><td>' + escapeHtml(r.note || '-') + '</td></tr>';
                    }).join('') +
                    '</tbody></table>';
            }

            function renderSankeyCorrelationRows(spec) {
                if (!spec || !spec.corrRows || !spec.corrRows.length) return '<div class="muted">No sensitivity rows available.</div>';
                return '<table class="sankey-drill-table"><thead><tr><th>Parameter</th><th>Sens</th><th>kW Eq.</th><th>Impact</th></tr></thead><tbody>' +
                    spec.corrRows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.param) + '</td><td>' + escapeHtml(r.corr) + '</td><td>' + escapeHtml(r.kw) + '</td><td>' + escapeHtml(r.impact || '-') + '</td></tr>';
                    }).join('') +
                    '</tbody></table>';
            }

            function closeSankeyDrillModal() {
                var modal = document.getElementById('sankeyDrillModal');
                if (!modal || !modal.classList.contains('open')) return;
                modal.classList.remove('open');
                modal.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('sankey-popup-open');
                var trigger = sankeyDrillState.trigger;
                sankeyDrillState = { open: false, nodeId: '', trigger: null };
                if (trigger && trigger.focus) trigger.focus();
            }

            function openSankeyDrill(nodeId, triggerEl) {
                var ctx = resolveSankeyContext(optimizedModel || baselineModel || computeModel(gatherInputs()));
                if (!ctx.activeModel || ctx.compare) return;
                var spec = buildSankeyDrillSpec(nodeId, ctx.activeModel);
                if (!spec) return;

                var modal = document.getElementById('sankeyDrillModal');
                var titleEl = document.getElementById('sankeyDrillTitle');
                var metaEl = document.getElementById('sankeyDrillMeta');
                var badgeEl = document.getElementById('sankeyDrillBadge');
                var svgEl = document.getElementById('sankeyDrillSvg');
                var corrEl = document.getElementById('sankeyDrillCorrelation');
                var rowsEl = document.getElementById('sankeyDrillRows');
                var formulaEl = document.getElementById('sankeyDrillFormula');
                var notesEl = document.getElementById('sankeyDrillNotes');
                if (!modal || !titleEl || !metaEl || !badgeEl || !svgEl || !corrEl || !rowsEl || !formulaEl || !notesEl) return;

                titleEl.textContent = spec.title;
                metaEl.textContent = spec.subtitle + ' | Source model: ' + sankeyModeLabel(ctx) + ' | Node share of facility: ' + sankeyPct(spec.focusValue, spec.focusTotal);
                badgeEl.className = 'status-pill ' + (spec.focusValue > 0 ? 'ok' : 'warn');
                badgeEl.textContent = spec.focusValue > 0 ? ('Drill Active | ' + fmtNum(spec.focusValue, 0) + ' kW') : 'No Power Flow';
                var drillRender = buildSankeyDrillSvg(spec);
                svgEl.setAttribute('viewBox', '0 0 ' + drillRender.w + ' ' + drillRender.h);
                svgEl.style.minWidth = String(Math.round(drillRender.minWidth || 920)) + 'px';
                svgEl.innerHTML = drillRender.svg || '';
                var canvasEl = document.getElementById('sankeyDrillCanvas');
                if (canvasEl) {
                    canvasEl.scrollLeft = 0;
                    canvasEl.scrollTop = 0;
                }
                corrEl.innerHTML = renderSankeyCorrelationRows(spec);
                rowsEl.innerHTML = renderSankeyDrillRows(spec);
                formulaEl.textContent = (spec.formulas || []).join('\n');
                notesEl.innerHTML = (spec.notes || []).map(function(t) { return '<li>' + escapeHtml(t) + '</li>'; }).join('');

                sankeyDrillState = { open: true, nodeId: nodeId, trigger: triggerEl || document.activeElement };
                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
                document.body.classList.add('sankey-popup-open');
                var closeBtn = document.getElementById('sankeyDrillClose');
                if (closeBtn && closeBtn.focus) closeBtn.focus();
            }

            function bindSankeyNodeDrill(svg) {
                if (!svg) return;
                svg.querySelectorAll('.sankey-node[data-sankey-node]').forEach(function(el) {
                    if (el.dataset.sankeyBound === '1') return;
                    var nodeId = String(el.getAttribute('data-sankey-node') || '').trim();
                    if (!nodeId) return;
                    el.dataset.sankeyBound = '1';
                    el.addEventListener('click', function(ev) {
                        openSankeyDrill(nodeId, ev.currentTarget);
                    });
                    el.addEventListener('keydown', function(ev) {
                        if (ev.key !== 'Enter' && ev.key !== ' ') return;
                        ev.preventDefault();
                        openSankeyDrill(nodeId, ev.currentTarget);
                    });
                });
            }

            function initSankeyDrillModal() {
                var modal = document.getElementById('sankeyDrillModal');
                if (!modal || modal.dataset.bound === '1') return;
                modal.dataset.bound = '1';
                modal.addEventListener('click', function(ev) {
                    var closeNode = ev.target && ev.target.closest ? ev.target.closest('[data-sankey-modal-close]') : null;
                    if (closeNode) closeSankeyDrillModal();
                });
                document.addEventListener('keydown', function(ev) {
                    if (ev.key !== 'Escape') return;
                    if (!sankeyDrillState.open) return;
                    closeSankeyDrillModal();
                });
            }

            function modeHelpDoc(key) {
                var k = String(key || '').trim();
                if (MODE_HELP_DOCS[k]) return MODE_HELP_DOCS[k];
                var meta = resolveTooltipMeta(k, 'input', prettifyKey(k || 'mode'));
                return {
                    title: meta.title || prettifyKey(k || 'mode'),
                    overview: meta.desc || 'Mode guide for this control is not fully specified yet.',
                    options: [
                        { mode: 'Current Setting', use: 'Adjust and re-run/refresh outputs.', impact: meta.impact || 'Impacts downstream model behavior.' }
                    ],
                    tips: [
                        meta.formula || ('Ref: ' + (k || 'model variable')),
                        'Validate output deltas after changing this setting.'
                    ]
                };
            }

            function renderModeHelpOptions(doc) {
                var opts = doc && Array.isArray(doc.options) ? doc.options : [];
                if (!opts.length) return '<div class="muted">No option breakdown available.</div>';
                return '<table class="mode-help-table"><thead><tr><th>Option</th><th>When To Use</th><th>Impact</th></tr></thead><tbody>' +
                    opts.map(function(o) {
                        return '<tr><td>' + escapeHtml(o.mode || '-') + '</td><td>' + escapeHtml(o.use || '-') + '</td><td>' + escapeHtml(o.impact || '-') + '</td></tr>';
                    }).join('') +
                    '</tbody></table>';
            }

            function closeModeHelpModal() {
                var modal = document.getElementById('modeHelpModal');
                if (!modal || !modal.classList.contains('open')) return;
                modal.classList.remove('open');
                modal.setAttribute('aria-hidden', 'true');
                var trigger = modeHelpState.trigger;
                modeHelpState = { open: false, key: '', trigger: null };
                if (trigger && trigger.focus) trigger.focus();
            }

            function openModeHelp(key, triggerEl) {
                var doc = modeHelpDoc(key);
                var modal = document.getElementById('modeHelpModal');
                var titleEl = document.getElementById('modeHelpTitle');
                var metaEl = document.getElementById('modeHelpMeta');
                var overviewEl = document.getElementById('modeHelpOverview');
                var optionsEl = document.getElementById('modeHelpOptions');
                var tipsEl = document.getElementById('modeHelpTips');
                if (!modal || !titleEl || !metaEl || !overviewEl || !optionsEl || !tipsEl) return;

                titleEl.textContent = doc.title || 'Mode Guide';
                metaEl.textContent = 'Detailed explanation, setting context, and expected KPI/solver impact.';
                overviewEl.textContent = doc.overview || '-';
                optionsEl.innerHTML = renderModeHelpOptions(doc);
                tipsEl.innerHTML = (doc.tips || []).map(function(t) { return '<li>' + escapeHtml(t) + '</li>'; }).join('');

                modeHelpState = { open: true, key: key, trigger: triggerEl || document.activeElement };
                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
                var closeBtn = document.getElementById('modeHelpClose');
                if (closeBtn && closeBtn.focus) closeBtn.focus();
            }

            function appendModeHelpButton(host, key) {
                if (!host || !key) return;
                if (host.getAttribute && host.getAttribute('data-mode-help-installed') === key) return;
                var btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'mode-help-btn';
                btn.textContent = 'Guide';
                btn.setAttribute('data-mode-help', key);
                btn.setAttribute('aria-label', 'Open mode guide for ' + (MODE_HELP_DOCS[key] ? MODE_HELP_DOCS[key].title : key));
                btn.addEventListener('click', function(ev) {
                    ev.preventDefault();
                    ev.stopPropagation();
                    openModeHelp(key, btn);
                });
                var tag = String(host.tagName || '').toUpperCase();
                if (tag === 'BUTTON' || tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') {
                    if (!host.parentNode) return;
                    if (host.nextSibling) host.parentNode.insertBefore(btn, host.nextSibling);
                    else host.parentNode.appendChild(btn);
                } else {
                    host.appendChild(btn);
                }
                if (host.setAttribute) host.setAttribute('data-mode-help-installed', key);
            }

            function installModeHelpButtons() {
                [
                    { id: 'inFailureMode', key: 'inFailureMode' },
                    { id: 'conEnforce', key: 'conEnforce' },
                    { id: 'sankeyMode', key: 'sankeyMode' },
                    { id: 'telemetryAggMode', key: 'telemetryAggMode' },
                    { id: 'inCoolingArchitecture', key: 'inCoolingArchitecture' },
                    { id: 'inCountryProfile', key: 'inCountryProfile' },
                    { id: 'inClimate', key: 'inClimate' },
                    { id: 'inRackType', key: 'inRackType' },
                    { id: 'inCoolant', key: 'inCoolant' },
                    { id: 'inRedundancy', key: 'inRedundancy' },
                    { id: 'inFireType', key: 'inFireType' },
                    { id: 'paretoSamples', key: 'paretoSamples' },
                    { id: 'mcUncertainty', key: 'mcUncertainty' },
                    { id: 'pdfSingleSource', key: 'pdfSingleSource' },
                    { id: 'pdfCompareLeft', key: 'pdfCompareLeft' },
                    { id: 'pdfCompareRight', key: 'pdfCompareRight' },
                    { id: 'ruleG1', key: 'ruleG1' }
                ].forEach(function(t) {
                    var labelEl = document.querySelector('label[for="' + t.id + '"]');
                    appendModeHelpButton(labelEl, t.key);
                });

                [
                    { id: 'autoRunToggle', key: 'autoRunToggle' },
                    { id: 'advancedInputToggle', key: 'advancedInputToggle' },
                    { id: 'telemetryApplyInputs', key: 'telemetryApplyInputs' }
                ].forEach(function(t) {
                    var wrap = document.querySelector('.check-wrap[for="' + t.id + '"]');
                    appendModeHelpButton(wrap, t.key);
                });

                [
                    { id: 'runCalc', key: 'runCalc' },
                    { id: 'optimizeTarget', key: 'optimizeTarget' },
                    { id: 'resetCalc', key: 'resetCalc' },
                    { id: 'detectTelemetryCols', key: 'detectTelemetryCols' },
                    { id: 'applyTelemetryCsv', key: 'applyTelemetryCsv' },
                    { id: 'loadTelemetryTemplate', key: 'loadTelemetryTemplate' },
                    { id: 'runCalibration', key: 'runCalibration' },
                    { id: 'clearCalibration', key: 'clearCalibration' },
                    { id: 'applyConstraintBtn', key: 'applyConstraintBtn' },
                    { id: 'applyRulesBtn', key: 'applyRulesBtn' },
                    { id: 'resetRulesBtn', key: 'resetRulesBtn' },
                    { id: 'runPareto', key: 'runPareto' },
                    { id: 'applyParetoBest', key: 'applyParetoBest' },
                    { id: 'runMonteCarlo', key: 'runMonteCarlo' },
                    { id: 'runSelfTest', key: 'runSelfTest' },
                    { id: 'saveScenarioBtn', key: 'saveScenarioBtn' },
                    { id: 'loadScenarioBtn', key: 'loadScenarioBtn' },
                    { id: 'deleteScenarioBtn', key: 'deleteScenarioBtn' },
                    { id: 'refreshLedger', key: 'refreshLedger' },
                    { id: 'exportExecutive', key: 'exportExecutive' },
                    { id: 'exportEngineering', key: 'exportEngineering' },
                    { id: 'exportPdfSingle', key: 'exportPdfSingle' },
                    { id: 'exportPdfCompare', key: 'exportPdfCompare' },
                    { id: 'explorerExpandAll', key: 'explorerExpandAll' },
                    { id: 'explorerCollapseAll', key: 'explorerExpandAll' },
                    { id: 'explorerFocusToggle', key: 'explorerExpandAll' },
                    { id: 'explorerCopyLink', key: 'explorerExpandAll' },
                    { id: 'explorerExportJson', key: 'explorerExpandAll' },
                    { id: 'explorerExportReport', key: 'explorerExpandAll' },
                    { id: 'explorerRunDiag', key: 'explorerExpandAll' }
                ].forEach(function(t) {
                    var btn = document.getElementById(t.id);
                    appendModeHelpButton(btn, t.key);
                });

                [
                    { contains: 'constraint + degraded mode engine', key: 'inFailureMode' },
                    { contains: 'control logic dsl / rule editor', key: 'ruleG1' },
                    { contains: 'multi-objective pareto frontier', key: 'paretoSamples' },
                    { contains: 'monte carlo uncertainty mode', key: 'mcUncertainty' },
                    { contains: 'telemetry import + auto mapping', key: 'telemetryAggMode' },
                    { contains: 'scenario manager', key: 'scenarioSelect' },
                    { contains: 'data provenance + assumption ledger', key: 'refreshLedger' },
                    { contains: 'executive + engineering export packs', key: 'pdfSingleSource' },
                    { contains: 'expandable block explorer', key: 'explorerToggleMode' }
                ].forEach(function(map) {
                    var heading = Array.prototype.slice.call(document.querySelectorAll('.feature-head h4')).find(function(h4) {
                        return String(h4.textContent || '').toLowerCase().indexOf(map.contains) >= 0;
                    });
                    appendModeHelpButton(heading, map.key);
                });
            }

            function initModeHelpModal() {
                var modal = document.getElementById('modeHelpModal');
                if (!modal || modal.dataset.bound === '1') return;
                modal.dataset.bound = '1';
                modal.addEventListener('click', function(ev) {
                    var closeNode = ev.target && ev.target.closest ? ev.target.closest('[data-mode-help-close]') : null;
                    if (closeNode) closeModeHelpModal();
                });
                document.addEventListener('keydown', function(ev) {
                    if (ev.key !== 'Escape') return;
                    if (!modeHelpState.open) return;
                    closeModeHelpModal();
                });
                installModeHelpButtons();
            }

            function buildPdfKpiChartSvg(model) {
                if (!model) return '';
                var w = 680;
                var h = 160;
                var left = 170;
                var top = 24;
                var rowGap = 42;
                var bw = 460;
                var rows = [
                    { label: 'PUE (lower better)', value: model.pue, target: model.input.targetPue, min: 1.0, max: Math.max(model.pue, model.input.targetPue, 1.6), better: 'low' },
                    { label: 'COP (higher better)', value: model.systemCop, target: model.input.targetCop, min: 2.0, max: Math.max(model.systemCop, model.input.targetCop, 8.5), better: 'high' },
                    { label: 'Risk (lower better)', value: model.riskIndex, target: 35, min: 0, max: 100, better: 'low' }
                ];

                var svg = [
                    '<svg class="r-chart" viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="' + w + '" height="' + h + '" fill="white"/>'
                ];

                rows.forEach(function(r, i) {
                    var y = top + (i * rowGap);
                    var range = Math.max(r.max - r.min, 0.001);
                    var vNorm = clamp((r.value - r.min) / range, 0, 1);
                    var tNorm = clamp((r.target - r.min) / range, 0, 1);
                    var vx = left + (vNorm * bw);
                    var tx = left + (tNorm * bw);
                    var improved = (r.better === 'low') ? (r.value <= r.target) : (r.value >= r.target);
                    var color = improved ? '#047857' : '#b91c1c';
                    svg.push('<text x="10" y="' + (y + 4) + '" font-size="11" fill="#334155">' + escapeHtml(r.label) + '</text>');
                    svg.push('<line x1="' + left + '" y1="' + y + '" x2="' + (left + bw) + '" y2="' + y + '" stroke="#cbd5e1" stroke-width="7" stroke-linecap="round"/>');
                    svg.push('<line x1="' + left + '" y1="' + y + '" x2="' + vx + '" y2="' + y + '" stroke="' + color + '" stroke-width="7" stroke-linecap="round"/>');
                    svg.push('<line x1="' + tx + '" y1="' + (y - 10) + '" x2="' + tx + '" y2="' + (y + 10) + '" stroke="#0f172a" stroke-width="1.5"/>');
                    svg.push('<text x="' + (left + bw + 8) + '" y="' + (y + 4) + '" font-size="10" fill="#0f172a">val ' + fmtNum(r.value, r.label.indexOf('Risk') >= 0 ? 1 : 3) + ' | target ' + fmtNum(r.target, r.label.indexOf('Risk') >= 0 ? 1 : 3) + '</text>');
                });

                svg.push('</svg>');
                return svg.join('');
            }

            function buildPdfEnergyDistributionSvg(model) {
                if (!model) return '';
                var flows = extractSankeyFlows(model);
                if (!flows || flows.total <= 0.1) return '';

                var w = 680;
                var h = 140;
                var left = 24;
                var top = 28;
                var bw = 610;
                var parts = [
                    { label: 'IT Compute', value: flows.it, color: '#2563eb' },
                    { label: 'Thermal', value: flows.thermal, color: '#0891b2' },
                    { label: 'Electrical Loss', value: flows.elecLoss, color: '#d97706' },
                    { label: 'Facility Aux', value: flows.facilityAux, color: '#64748b' }
                ];

                var svg = [
                    '<svg class="r-chart" viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="' + w + '" height="' + h + '" fill="white"/>'
                ];

                var x = left;
                parts.forEach(function(p) {
                    var seg = Math.max(2, (p.value / flows.total) * bw);
                    svg.push('<rect x="' + fmtNum(x, 2) + '" y="' + top + '" width="' + fmtNum(seg, 2) + '" height="22" fill="' + p.color + '"/>');
                    svg.push('<text x="' + fmtNum(x + 2, 2) + '" y="' + (top + 16) + '" font-size="9" fill="#ffffff">' + fmtNum((p.value / flows.total) * 100, 1) + '%</text>');
                    x += seg;
                });

                var ly = 72;
                parts.forEach(function(p, idx) {
                    var y = ly + (idx * 15);
                    svg.push('<rect x="24" y="' + (y - 8) + '" width="10" height="10" fill="' + p.color + '"/>');
                    svg.push('<text x="40" y="' + y + '" font-size="10" fill="#334155">' + escapeHtml(p.label) + ': ' + fmtNum(p.value, 0) + ' kW (' + sankeyPct(p.value, flows.total) + ')</text>');
                });

                svg.push('</svg>');
                return svg.join('');
            }

            function buildPdfMonteCarloBandSvg() {
                if (!latestMonteCarlo || !latestMonteCarlo.dist) return '';
                var dist = latestMonteCarlo.dist;
                var specs = [
                    { key: 'pue', label: 'PUE', digits: 3, color: '#2563eb' },
                    { key: 'cop', label: 'COP', digits: 2, color: '#0891b2' },
                    { key: 'opex', label: 'Net OPEX', digits: 0, color: '#7c3aed' },
                    { key: 'carbon', label: 'Carbon', digits: 0, color: '#d97706' },
                    { key: 'risk', label: 'Risk', digits: 1, color: '#dc2626' }
                ];
                var w = 680;
                var h = 190;
                var left = 150;
                var trackW = 500;
                var top = 24;
                var rowGap = 30;

                var svg = [
                    '<svg class="r-chart" viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="' + w + '" height="' + h + '" fill="white"/>'
                ];

                specs.forEach(function(spec, idx) {
                    var arr = (dist[spec.key] || []).slice().sort(function(a, b) { return a - b; });
                    if (!arr.length) return;
                    var p10 = percentile(arr, 0.10);
                    var p50 = percentile(arr, 0.50);
                    var p90 = percentile(arr, 0.90);
                    var min = arr[0];
                    var max = arr[arr.length - 1];
                    if (max === min) max = min + 1e-9;
                    var y = top + (idx * rowGap);
                    var x10 = left + ((p10 - min) / (max - min)) * trackW;
                    var x50 = left + ((p50 - min) / (max - min)) * trackW;
                    var x90 = left + ((p90 - min) / (max - min)) * trackW;
                    svg.push('<text x="10" y="' + (y + 4) + '" font-size="10" fill="#334155">' + escapeHtml(spec.label) + '</text>');
                    svg.push('<line x1="' + left + '" y1="' + y + '" x2="' + (left + trackW) + '" y2="' + y + '" stroke="#cbd5e1" stroke-width="4" stroke-linecap="round"/>');
                    svg.push('<line x1="' + fmtNum(x10, 2) + '" y1="' + y + '" x2="' + fmtNum(x90, 2) + '" y2="' + y + '" stroke="' + spec.color + '" stroke-width="8" stroke-linecap="round"/>');
                    svg.push('<line x1="' + fmtNum(x50, 2) + '" y1="' + (y - 7) + '" x2="' + fmtNum(x50, 2) + '" y2="' + (y + 7) + '" stroke="#0f172a" stroke-width="1.2"/>');
                    svg.push('<text x="' + (left + trackW + 8) + '" y="' + (y + 4) + '" font-size="9" fill="#0f172a">P10 ' + fmtNum(p10, spec.digits) + ' | P50 ' + fmtNum(p50, spec.digits) + ' | P90 ' + fmtNum(p90, spec.digits) + '</text>');
                });

                svg.push('</svg>');
                return svg.join('');
            }

            function buildPdfCompareDeltaSvg(leftModel, rightModel) {
                if (!leftModel || !rightModel) return '';
                var rows = [
                    { label: 'PUE (right-left)', delta: rightModel.pue - leftModel.pue, better: 'low' },
                    { label: 'COP (right-left)', delta: rightModel.systemCop - leftModel.systemCop, better: 'high' },
                    { label: 'Net OPEX (right-left)', delta: rightModel.netOpex - leftModel.netOpex, better: 'low' },
                    { label: 'Carbon (right-left)', delta: rightModel.netCarbonTons - leftModel.netCarbonTons, better: 'low' },
                    { label: 'Risk (right-left)', delta: rightModel.riskIndex - leftModel.riskIndex, better: 'low' }
                ];
                var maxAbs = rows.reduce(function(m, r) { return Math.max(m, Math.abs(r.delta)); }, 0);
                maxAbs = Math.max(maxAbs, 0.001);

                var w = 680;
                var h = 170;
                var center = 390;
                var left = 150;
                var right = 640;
                var span = 230;
                var top = 24;
                var rowGap = 28;
                var svg = [
                    '<svg class="r-chart" viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="' + w + '" height="' + h + '" fill="white"/>',
                    '<line x1="' + center + '" y1="14" x2="' + center + '" y2="' + (h - 10) + '" stroke="#334155" stroke-width="1"/>'
                ];

                rows.forEach(function(r, idx) {
                    var y = top + (idx * rowGap);
                    var wBar = (Math.abs(r.delta) / maxAbs) * span;
                    var improved = (r.better === 'low') ? (r.delta <= 0) : (r.delta >= 0);
                    var color = improved ? '#047857' : '#b91c1c';
                    var x = r.delta >= 0 ? center : (center - wBar);
                    svg.push('<text x="8" y="' + (y + 4) + '" font-size="10" fill="#334155">' + escapeHtml(r.label) + '</text>');
                    svg.push('<rect x="' + fmtNum(left, 2) + '" y="' + (y - 6) + '" width="' + (right - left) + '" height="12" fill="#f1f5f9"/>');
                    svg.push('<rect x="' + fmtNum(x, 2) + '" y="' + (y - 6) + '" width="' + fmtNum(wBar, 2) + '" height="12" fill="' + color + '" />');
                    svg.push('<text x="' + (right + 6) + '" y="' + (y + 4) + '" font-size="9" fill="#0f172a">' + signed(r.delta, 3, '') + '</text>');
                });

                svg.push('</svg>');
                return svg.join('');
            }

            function buildPdfCompareEnergySvg(leftModel, rightModel) {
                var l = extractSankeyFlows(leftModel);
                var r = extractSankeyFlows(rightModel);
                if (!l || !r || l.total <= 0 || r.total <= 0) return '';
                var parts = [
                    { key: 'it', label: 'IT', color: '#2563eb' },
                    { key: 'thermal', label: 'Thermal', color: '#0891b2' },
                    { key: 'elecLoss', label: 'Elec Loss', color: '#d97706' },
                    { key: 'facilityAux', label: 'Aux', color: '#64748b' }
                ];

                function bar(y, set, total) {
                    var x = 170;
                    var bw = 470;
                    var out = [];
                    parts.forEach(function(p) {
                        var seg = Math.max(2, (set[p.key] / total) * bw);
                        out.push('<rect x="' + fmtNum(x, 2) + '" y="' + y + '" width="' + fmtNum(seg, 2) + '" height="18" fill="' + p.color + '"/>');
                        x += seg;
                    });
                    return out.join('');
                }

                var svg = [
                    '<svg class="r-chart" viewBox="0 0 680 130" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="680" height="130" fill="white"/>',
                    '<text x="10" y="34" font-size="11" fill="#334155">Baseline Mix</text>',
                    '<text x="10" y="84" font-size="11" fill="#334155">Optimized Mix</text>',
                    bar(20, l, l.total),
                    bar(70, r, r.total)
                ];
                parts.forEach(function(p, idx) {
                    var lx = 170 + (idx * 120);
                    svg.push('<rect x="' + lx + '" y="108" width="10" height="10" fill="' + p.color + '"/>');
                    svg.push('<text x="' + (lx + 14) + '" y="117" font-size="9" fill="#334155">' + p.label + '</text>');
                });
                svg.push('</svg>');
                return svg.join('');
            }

            function evaluateGateStatesWithRules(model, rules) {
                var ctx = buildRuleContext(model);
                var activeRules = rules || gateRules;
                var r1 = evaluateRuleExpression(activeRules.g1, ctx);
                var r2 = evaluateRuleExpression(activeRules.g2, ctx);
                var r3 = evaluateRuleExpression(activeRules.g3, ctx);
                return {
                    g1: !!r1.value,
                    g2: !!r2.value,
                    g3: !!r3.value
                };
            }

            function deltaCell(base, next, digits, better) {
                var delta = next - base;
                var pct = (Math.abs(base) > 0.0001) ? ((delta / base) * 100) : 0;
                var state = 'Neutral';
                if (better === 'low') {
                    if (delta < 0) state = 'Improved';
                    if (delta > 0) state = 'Worse';
                } else if (better === 'high') {
                    if (delta > 0) state = 'Improved';
                    if (delta < 0) state = 'Worse';
                }
                return signed(delta, digits, '') + ' (' + signed(pct, 1, '%') + ') | ' + state;
            }

            function metricStatus(model, constraints) {
                var c = evaluateHardConstraints(model, constraints || gatherConstraintState());
                var t = [];
                if (model.pue <= model.input.targetPue) t.push('PUE on target');
                if (model.systemCop >= model.input.targetCop) t.push('COP on target');
                if (c.feasible) t.push('Hard constraints pass');
                return t.length ? t.join(' | ') : 'Needs optimization';
            }

            function renderReportHead(title, subtitle) {
                return '<header class="r-head">' +
                    '<div>' +
                    '<h1>' + escapeHtml(title) + '</h1>' +
                    '<p>' + escapeHtml(subtitle) + '</p>' +
                    '</div>' +
                    '<div class="r-head-meta">' +
                    '<div><strong>Generated:</strong> ' + escapeHtml(nowIso()) + '</div>' +
                    '<div><strong>Tool:</strong> LTC System Modelling Lab</div>' +
                    '<div><strong>Mode:</strong> Print-ready PDF</div>' +
                    '</div>' +
                '</header>';
            }

            function reportShell(innerHtml) {
                return '<!doctype html><html lang="en"><head><meta charset="utf-8">' +
                    '<meta name="viewport" content="width=device-width, initial-scale=1">' +
                    '<title>LTC Report</title>' +
                    '<style>' +
                    '@page{size:A4;margin:12mm;}*{box-sizing:border-box;}body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;color:#0f172a;background:#ffffff;line-height:1.42;}' +
                    '.r-wrap{padding:10px 14px 20px;} .r-head{display:flex;justify-content:space-between;gap:16px;border-bottom:2px solid #dbe5ef;padding-bottom:10px;margin-bottom:12px;}' +
                    '.r-head h1{font-size:20px;margin:0 0 4px;} .r-head p{margin:0;font-size:12px;color:#475569;} .r-head-meta{font-size:11px;line-height:1.55;text-align:right;color:#334155;}' +
                    '.r-sec{margin-top:12px;border:1px solid #dbe5ef;border-radius:10px;overflow:visible;break-inside:auto;page-break-inside:auto;} .r-sec h2{margin:0;padding:8px 10px;font-size:13px;background:#f1f5f9;border-bottom:1px solid #dbe5ef;}' +
                    '.r-sec .r-body{padding:9px 10px;} .r-kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;}' +
                    '.r-card{border:1px solid #dbe5ef;border-radius:8px;padding:8px;background:#f8fafc;} .r-card .k{font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:.06em;}' +
                    '.r-card .v{margin-top:3px;font-size:17px;font-weight:700;color:#0f172a;} .r-card .s{margin-top:3px;font-size:11px;color:#334155;line-height:1.4;}' +
                    '.r-grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;} .r-grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;}' +
                    '.r-chart-wrap{border:1px solid #dbe5ef;border-radius:8px;padding:6px;background:#ffffff;overflow:visible;} .r-chart{width:100%;height:auto;display:block;}' +
                    '.r-list{margin:0;padding-left:18px;} .r-list li{margin:0 0 4px;font-size:11px;color:#334155;} .r-note{font-size:11px;color:#475569;margin-top:6px;}' +
                    '.r-conclusion{margin-top:8px;padding:8px 10px;border:1px solid #cbd5e1;border-left:4px solid #2563eb;border-radius:8px;background:#f8fbff;font-size:11px;color:#1e293b;line-height:1.5;}' +
                    '.r-conclusion.ok{border-left-color:#059669;background:#f0fdf4;} .r-conclusion.warn{border-left-color:#d97706;background:#fffaf0;} .r-conclusion.bad{border-left-color:#dc2626;background:#fff5f5;}' +
                    'table{width:100%;border-collapse:collapse;font-size:11px;table-layout:fixed;} th,td{padding:6px 7px;border-bottom:1px solid #e2e8f0;vertical-align:top;word-break:break-word;overflow-wrap:anywhere;} th{background:#f8fafc;text-align:left;text-transform:uppercase;letter-spacing:.05em;font-size:10px;color:#475569;} tr{break-inside:avoid-page;page-break-inside:avoid;}' +
                    'tr:last-child td{border-bottom:none;} .ok{color:#047857;font-weight:700;} .warn{color:#b45309;font-weight:700;} .bad{color:#b91c1c;font-weight:700;}' +
                    '.tag{display:inline-block;padding:2px 7px;border:1px solid #dbe5ef;border-radius:999px;font-size:10px;background:#fff;margin-right:4px;margin-bottom:4px;} .muted{color:#64748b;font-size:11px;}' +
                    '.mono{font-family:JetBrains Mono,Consolas,monospace;} .split{display:grid;grid-template-columns:1fr 1fr;gap:10px;} .page-break{page-break-before:always;}' +
                    '.r-json{font-size:9px;line-height:1.32;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere;tab-size:2;}' +
                    '.r-json-chunk-label{font-size:10px;color:#475569;margin:0 0 4px;text-transform:uppercase;letter-spacing:.05em;}' +
                    '.r-chart-wrap.allow-break{break-inside:auto;page-break-inside:auto;}' +
                    '@media print{.page-break{break-before:page;} table{table-layout:fixed;} thead{display:table-header-group;} tfoot{display:table-footer-group;} tr{break-inside:avoid;page-break-inside:avoid;} pre{white-space:pre-wrap !important;word-break:break-word !important;overflow-wrap:anywhere !important;} .r-sec,.r-card,.r-chart-wrap{break-inside:auto !important;page-break-inside:auto !important;} .r-chart-wrap{overflow:visible !important;} .r-chart-wrap.allow-break{break-inside:auto !important;page-break-inside:auto !important;} .r-kpi,.r-grid2,.r-grid3,.split{display:block !important;} .r-kpi>*,.r-grid2>*,.r-grid3>*,.split>*{margin-bottom:8px;} .r-json{font-size:8.2px;line-height:1.24;}}' +
                    '</style></head><body><div class="r-wrap">' + innerHtml + '</div>' +
                    '<script>window.addEventListener(\"load\",function(){setTimeout(function(){window.print();},220);});<\/script>' +
                    '</body></html>';
            }

            function openPdfReport(htmlContent) {
                var w = window.open('', '_blank', 'width=1200,height=860');
                if (!w) return false;
                w.document.open();
                w.document.write(reportShell(htmlContent));
                w.document.close();
                return true;
            }

            function architectureLabelByKey(key) {
                return (COOLING_ARCH_PROFILES[key] && COOLING_ARCH_PROFILES[key].label) ? COOLING_ARCH_PROFILES[key].label : 'Manual';
            }

            function redundancyLabelByKey(key) {
                if (key === '2N') return '2N';
                if (key === 'N1') return 'N+1';
                if (key === 'N') return 'N';
                return String(key || 'N');
            }

            function climateLabelByKey(key) {
                var map = {
                    tropical: 'Tropical',
                    temperate: 'Temperate',
                    dry: 'Dry',
                    continental: 'Continental'
                };
                return map[key] || String(key || 'Unknown');
            }

            function fireTypeLabelByKey(key) {
                var map = {
                    clean_agent: 'Clean Agent',
                    water_mist: 'Water Mist',
                    double_interlock: 'Double-Interlock Pre-Action',
                    dry_pipe: 'Dry Pipe'
                };
                return map[key] || String(key || 'Unknown');
            }

            function pdfInputMatrixRows(model) {
                var i = model.input || {};
                return [
                    { k: 'IT Load', v: fmtNum(i.itLoadMw, 2) + ' MW', n: 'Primary compute design load.' },
                    { k: 'Rack Count', v: fmtNum(i.rackCount, 0), n: 'Total active rack envelope.' },
                    { k: 'Rack Type', v: rackLabelByKey(i.rackType), n: 'Cooling profile basis.' },
                    { k: 'Target Rack Density', v: fmtNum(i.rackDensityTarget, 1) + ' kW/rack', n: 'Design density objective.' },
                    { k: 'High-Density Share', v: fmtNum(i.highDensityShare, 1) + '%', n: 'AI/HPC concentration fraction.' },
                    { k: 'Model Horizon Year', v: fmtNum(i.modelYear, 0), n: 'Future factor horizon.' },
                    { k: 'Cooling Architecture', v: architectureLabelByKey(i.architectureMode), n: 'Plant architecture profile.' },
                    { k: 'Liquid Capture', v: fmtNum(i.liquidCapture, 1) + '%', n: 'Heat captured to liquid path.' },
                    { k: 'Coolant', v: (COOLANTS[i.coolantKey] || COOLANTS.water).label, n: 'Thermal-fluid property set.' },
                    { k: 'Supply / Return Temp', v: fmtNum(i.supplyTemp, 1) + 'C / ' + fmtNum(i.returnTemp, 1) + 'C', n: 'Thermal delta-T boundary.' },
                    { k: 'Pump Head', v: fmtNum(i.pumpHead, 1) + ' m', n: 'Hydraulic pressure head baseline.' },
                    { k: 'Pump Efficiency', v: fmtNum(i.pumpEff, 1) + '%', n: 'Hydraulic conversion efficiency.' },
                    { k: 'Hydraulic Margin', v: fmtNum(i.hydraulicMargin, 1) + '%', n: 'Safety design margin.' },
                    { k: 'Control Quality', v: fmtNum(i.controlQuality, 0) + '%', n: 'Closed-loop control maturity.' },
                    { k: 'Predictive Gain', v: fmtNum(i.predictiveGain, 0) + '%', n: 'Predictive control uplift term.' },
                    { k: 'Heat Transfer Coef', v: fmtNum(i.coefHeatTransfer, 1) + '%', n: 'Thermal-transfer effectiveness.' },
                    { k: 'CDU Loss Coef', v: fmtNum(i.coefCduLoss, 2) + '%', n: 'Parasitic CDU loss term.' },
                    { k: 'Pipe Loss Multiplier', v: fmtNum(i.coefPipeLoss, 2) + 'x', n: 'Pipe pressure-drop multiplier.' },
                    { k: 'Future Tech Multiplier', v: fmtNum(i.coefFutureTech, 1) + '%', n: 'Forward efficiency bias.' },
                    { k: 'CDU Unit Capacity', v: fmtNum(i.cduUnit, 0) + ' kW', n: 'Single CDU design unit.' },
                    { k: 'Redundancy', v: redundancyLabelByKey(i.redundancy), n: 'Availability topology.' },
                    { k: 'Climate', v: climateLabelByKey(i.climate), n: 'Ambient thermal context.' },
                    { k: 'Country Profile', v: countryLabelByKey(i.countryKey), n: 'Regional profile envelope.' },
                    { k: 'Air Path COP', v: fmtNum(i.airCop, 2), n: 'Residual air-cooling efficiency.' },
                    { k: 'Economizer Availability', v: fmtNum(i.economizerHours, 1) + '%', n: 'Economizer operating window.' },
                    { k: 'Fan Power Share', v: fmtNum(i.fanPower, 2) + '% IT', n: 'CRAH/CRAC airflow budget.' },
                    { k: 'UPS Efficiency', v: fmtNum(i.upsEff, 2) + '%', n: 'Electrical conversion efficiency.' },
                    { k: 'Power Distribution Loss', v: fmtNum(i.distLoss, 2) + '% input', n: 'Distribution overhead term.' },
                    { k: 'Heat Reuse Rate', v: fmtNum(i.heatReuse, 1) + '%', n: 'Recovered heat utilization fraction.' },
                    { k: 'Electricity Price', v: '$' + fmtNum(i.elecPrice, 3) + '/kWh', n: 'Energy tariff assumption.' },
                    { k: 'Water Tariff', v: '$' + fmtNum(i.waterTariff, 2) + '/m3', n: 'Water OPEX assumption.' },
                    { k: 'Grid Carbon Intensity', v: fmtNum(i.carbonIntensity, 3) + ' kgCO2e/kWh', n: 'Carbon factor basis.' },
                    { k: 'Monitoring Coverage', v: fmtNum(i.monitoring, 0) + '%', n: 'Sensor/telemetry confidence driver.' },
                    { k: 'Fire Suppression', v: fireTypeLabelByKey(i.fireType), n: 'Resilience strategy factor.' },
                    { k: 'Concurrent Maintainability', v: i.concurrent ? 'Yes' : 'No', n: 'Maintainability posture.' },
                    { k: 'Target PUE / COP', v: fmtNum(i.targetPue, 3) + ' / ' + fmtNum(i.targetCop, 2), n: 'Design KPI target envelope.' },
                    { k: 'Failure Mode Scenario', v: i.failureMode || 'normal', n: 'Stress/degraded scenario mode.' }
                ];
            }

            function pdfOutputVectorRows(model) {
                return [
                    { k: 'IT Load (kW)', v: fmtNum(model.itKw, 0), n: 'Converted from IT load MW.' },
                    { k: 'Design Density', v: fmtNum(model.designDensity, 1) + ' kW/rack', n: 'Future + density stress adjusted.' },
                    { k: 'Effective Capture', v: fmtNum(model.effectiveCapture, 1) + '%', n: 'Control-adjusted capture result.' },
                    { k: 'Delta T', v: fmtNum(model.deltaT, 2) + 'C', n: 'Effective liquid loop delta-T.' },
                    { k: 'Flow', v: fmtNum(model.flowLpm, 0) + ' LPM', n: 'Hydraulic design flow.' },
                    { k: 'Pump Power', v: fmtNum(model.pumpPowerKw, 1) + ' kW', n: 'Hydraulic energy overhead.' },
                    { k: 'PUE', v: fmtNum(model.pue, 3), n: 'Facility efficiency index.' },
                    { k: 'System COP', v: fmtNum(model.systemCop, 2), n: 'Thermal conversion efficiency.' },
                    { k: 'WUE', v: fmtNum(model.wue, 3) + ' L/kWh', n: 'Water usage effectiveness.' },
                    { k: 'Annual Energy', v: fmtNum(model.annualGwh, 2) + ' GWh/yr', n: 'Annualized facility consumption.' },
                    { k: 'Annual OPEX', v: fmtUsd(model.annualOpex), n: 'Gross operating cost.' },
                    { k: 'Heat Reuse Credit', v: fmtUsd(model.heatReuseCredit), n: 'Recovered energy credit.' },
                    { k: 'Net OPEX', v: fmtUsd(model.netOpex), n: 'Post-reuse annual OPEX.' },
                    { k: 'Net Carbon', v: fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr', n: 'Post-avoidance annual emissions.' },
                    { k: 'Risk Index', v: fmtNum(model.riskIndex, 1) + '/100', n: 'Resilience and risk posture.' },
                    { k: 'Control Index', v: fmtNum(model.controlIndex, 1) + '/100', n: 'Control loop quality synthesis.' },
                    { k: 'Data Confidence', v: fmtNum(model.confidence, 0) + '%', n: 'Telemetry confidence projection.' },
                    { k: 'Composite Score', v: fmtNum(model.scores.total, 1) + '/100', n: 'Aggregated standards alignment score.' }
                ];
            }

            function pdfSolverRows(model) {
                var s = model.internals || {};
                return [
                    { k: 'Year Delta', v: fmtNum(s.yearDelta || 0, 0), n: 'ModelYear - 2026' },
                    { k: 'Density Stress', v: fmtNum(s.densityStress || 0, 3), n: 'Rack density stress factor.' },
                    { k: 'Redundancy Factor', v: fmtNum(s.redundancyFactor || 0, 2), n: 'Hydraulic redundancy multiplier.' },
                    { k: 'Pipe Factor', v: fmtNum(s.pipeFactor || 0, 2), n: 'Pressure-drop multiplier.' },
                    { k: 'Pump Head Effective', v: fmtNum(s.pumpHeadEff || 0, 2) + ' m', n: 'Density- and pipe-adjusted head.' },
                    { k: 'Liquid COP', v: fmtNum(s.liquidCop || 0, 2), n: 'Liquid loop COP effective.' },
                    { k: 'Air COP Effective', v: fmtNum(s.airCopEff || 0, 2), n: 'Residual air-path COP effective.' },
                    { k: 'Total Cooling', v: fmtNum(s.totalCoolingKw || 0, 1) + ' kW', n: 'Liquid + air + fan aggregate.' },
                    { k: 'Economizer Fraction', v: fmtNum((s.economizerFraction || 0) * 100, 1) + '%', n: 'Economizer contribution fraction.' },
                    { k: 'Annual Energy (kWh)', v: fmtNum(s.annualKwh || 0, 0), n: 'Raw annual energy quantity.' },
                    { k: 'Annual Water', v: fmtNum(s.annualWaterM3 || 0, 0) + ' m3', n: 'Annual water consumption.' },
                    { k: 'Heat Reuse Energy', v: fmtNum(s.heatReuseKwh || 0, 0) + ' kWh/yr', n: 'Annual recovered heat energy.' }
                ];
            }

            function pdfEnergyRows(model) {
                var f = extractSankeyFlows(model) || { it: 0, thermal: 0, elecLoss: 0, facilityAux: 0, liquidCore: 0, pump: 0, air: 0, fan: 0, total: 0 };
                return [
                    { k: 'Total Facility Input', v: fmtNum(f.total, 0) + ' kW', n: '100% facility envelope.' },
                    { k: 'IT Compute', v: fmtNum(f.it, 0) + ' kW (' + sankeyPct(f.it, f.total) + ')', n: 'Productive compute power.' },
                    { k: 'Thermal Management', v: fmtNum(f.thermal, 0) + ' kW (' + sankeyPct(f.thermal, f.total) + ')', n: 'Cooling/hydraulic/fan burden.' },
                    { k: 'Electrical Loss', v: fmtNum(f.elecLoss, 0) + ' kW (' + sankeyPct(f.elecLoss, f.total) + ')', n: 'UPS + distribution losses.' },
                    { k: 'Facility Aux', v: fmtNum(f.facilityAux, 0) + ' kW (' + sankeyPct(f.facilityAux, f.total) + ')', n: 'Base support auxiliary loads.' },
                    { k: 'Liquid Loop', v: fmtNum(f.liquidCore, 0) + ' kW (' + sankeyPct(f.liquidCore, f.total) + ')', n: 'Liquid branch non-pump power.' },
                    { k: 'Pump Drive', v: fmtNum(f.pump, 0) + ' kW (' + sankeyPct(f.pump, f.total) + ')', n: 'Hydraulic branch.' },
                    { k: 'Air Path', v: fmtNum(f.air, 0) + ' kW (' + sankeyPct(f.air, f.total) + ')', n: 'Residual air-cooling branch.' },
                    { k: 'Fan Power', v: fmtNum(f.fan, 0) + ' kW (' + sankeyPct(f.fan, f.total) + ')', n: 'CRAH/CRAC airflow branch.' }
                ];
            }

            function pdfStandardsRows(model) {
                return [
                    { k: 'ASHRAE', s: model.scores.ashrae },
                    { k: 'ANSI/TIA-942', s: model.scores.ansi },
                    { k: 'ISO 50001', s: model.scores.iso },
                    { k: 'NFPA', s: model.scores.nfpa },
                    { k: 'Uptime Institute', s: model.scores.uptime },
                    { k: 'Composite', s: model.scores.total }
                ];
            }

            function pdfSingleRecommendations(model, hard, gates, constraints) {
                var out = [];
                if (model.pue > model.input.targetPue) out.push('PUE above target: tighten thermal and electrical overhead, especially pump and UPS-loss branches.');
                if (model.systemCop < model.input.targetCop) out.push('COP below target: improve liquid COP pathway via delta-T, capture, and control quality.');
                if (!hard.feasible) out.push('Hard constraints violated: ' + hard.issues.join(', ') + '. Rebalance setpoints before deployment.');
                if (hard.pumpPctIt > constraints.pumpPctMax) out.push('Pump as %IT too high (' + fmtNum(hard.pumpPctIt, 2) + '%). Focus on pump efficiency, head, and pipe multiplier.');
                if (!gates.g1 || !gates.g2 || !gates.g3) out.push('One or more control gates blocked: review rule set and control confidence assumptions.');
                if (model.riskIndex > 40) out.push('Risk index elevated (' + fmtNum(model.riskIndex, 1) + '). Strengthen redundancy, monitoring, and control reliability.');
                if (model.netCarbonTons > 55000) out.push('Carbon burden remains high; increase heat reuse and lower non-IT overhead share.');
                if (!out.length) out.push('Current scenario is balanced across KPI, constraints, and risk envelope. Keep monitoring and validate with telemetry.');
                return out;
            }

            function pdfCompareInputDeltaRows(leftModel, rightModel) {
                var li = leftModel.input || {};
                var ri = rightModel.input || {};
                function row(label, key, digits, suffix) {
                    var lv = li[key];
                    var rv = ri[key];
                    var delta = (typeof lv === 'number' && typeof rv === 'number') ? (rv - lv) : null;
                    return {
                        label: label,
                        lv: typeof lv === 'number' ? fmtNum(lv, digits) + (suffix || '') : escapeHtml(String(lv)),
                        rv: typeof rv === 'number' ? fmtNum(rv, digits) + (suffix || '') : escapeHtml(String(rv)),
                        delta: delta === null ? '-' : signed(delta, digits, suffix || '')
                    };
                }
                return [
                    row('IT Load', 'itLoadMw', 2, ' MW'),
                    row('Liquid Capture', 'liquidCapture', 1, '%'),
                    row('Supply Temp', 'supplyTemp', 1, 'C'),
                    row('Return Temp', 'returnTemp', 1, 'C'),
                    row('Pump Efficiency', 'pumpEff', 1, '%'),
                    row('Hydraulic Margin', 'hydraulicMargin', 1, '%'),
                    row('Control Quality', 'controlQuality', 0, '%'),
                    row('Predictive Gain', 'predictiveGain', 0, '%'),
                    row('Air Path COP', 'airCop', 2, ''),
                    row('Fan Power Share', 'fanPower', 2, '% IT'),
                    row('Economizer Availability', 'economizerHours', 1, '%'),
                    row('Electricity Price', 'elecPrice', 3, ' $/kWh'),
                    row('Grid Carbon Intensity', 'carbonIntensity', 3, ' kgCO2e/kWh')
                ];
            }

            function pdfCompareAllInputDeltaRows(leftModel, rightModel) {
                var lFlat = {};
                var rFlat = {};
                flattenObject('', leftModel.input || {}, lFlat);
                flattenObject('', rightModel.input || {}, rFlat);
                var keyMap = {};
                Object.keys(lFlat).forEach(function(k) { keyMap[k] = true; });
                Object.keys(rFlat).forEach(function(k) { keyMap[k] = true; });
                var keys = Object.keys(keyMap).sort();
                return keys.map(function(key) {
                    var lv = lFlat.hasOwnProperty(key) ? lFlat[key] : '-';
                    var rv = rFlat.hasOwnProperty(key) ? rFlat[key] : '-';
                    var delta = '-';
                    if (typeof lv === 'number' && typeof rv === 'number') {
                        var digits = (Math.abs(rv - lv) >= 1 || Math.abs(rv) >= 10 || Math.abs(lv) >= 10) ? 2 : 4;
                        delta = signed(rv - lv, digits, '');
                    } else if (lv !== rv) {
                        delta = 'changed';
                    }
                    return {
                        key: key,
                        left: formatTraceValue(lv),
                        right: formatTraceValue(rv),
                        delta: delta
                    };
                });
            }

            function pdfSensitivityRows(model, nodeKey, limit) {
                var spec = buildSankeyDrillSpec(nodeKey, model);
                if (!spec || !spec.corrRows || !spec.corrRows.length) return [];
                return spec.corrRows.slice(0, Math.max(limit || 6, 1)).map(function(r) {
                    return {
                        param: r.param || '-',
                        sens: r.corr || '-',
                        kw: r.kw || '-',
                        impact: shortText(String(r.impact || '-').replace(/\s+/g, ' ').trim(), 170)
                    };
                });
            }

            function pdfSensitivityTableHtml(title, rows) {
                if (!rows || !rows.length) {
                    return '<div class="r-chart-wrap"><div class="muted">' + escapeHtml(title) + ': no sensitivity rows available.</div></div>';
                }
                return [
                    '<div class="r-chart-wrap">',
                    '<div class="muted" style="margin-bottom:6px;"><strong>' + escapeHtml(title) + '</strong></div>',
                    '<table><thead><tr><th>Parameter</th><th>Sens</th><th>kW Eq.</th><th>Impact</th></tr></thead><tbody>',
                    rows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.param) + '</td><td>' + escapeHtml(r.sens) + '</td><td>' + escapeHtml(r.kw) + '</td><td>' + escapeHtml(r.impact) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    '</div>'
                ].join('');
            }

            function narrativePack(level, text) {
                return {
                    level: level || 'warn',
                    text: String(text || 'No narrative generated.')
                };
            }

            function narrativeHtml(pack) {
                if (!pack || !pack.text) return '';
                var lv = (pack.level === 'ok' || pack.level === 'warn' || pack.level === 'bad') ? pack.level : 'warn';
                return '<div class="r-conclusion ' + lv + '"><strong>Narrative Conclusion:</strong> ' + escapeHtml(pack.text) + '</div>';
            }

            function topThermalBranches(model, limit) {
                var f = extractSankeyFlows(model);
                if (!f) return [];
                var arr = [
                    { k: 'Liquid Loop', v: Math.max(f.liquidCore || 0, 0) },
                    { k: 'Pump Drive', v: Math.max(f.pump || 0, 0) },
                    { k: 'Air Path', v: Math.max(f.air || 0, 0) },
                    { k: 'Fan Power', v: Math.max(f.fan || 0, 0) }
                ].sort(function(a, b) { return b.v - a.v; });
                return arr.slice(0, Math.max(limit || 2, 1));
            }

            function singleExecutiveNarrative(model, hard, gates, calScore) {
                var blockers = [];
                var gateOpen = (gates.g1 ? 1 : 0) + (gates.g2 ? 1 : 0) + (gates.g3 ? 1 : 0);
                if (!hard.feasible) blockers.push('hard constraints violated (' + hard.issues.join(', ') + ')');
                if (model.pue > model.input.targetPue) blockers.push('PUE above target by ' + fmtNum(model.pue - model.input.targetPue, 3));
                if (model.systemCop < model.input.targetCop) blockers.push('COP below target by ' + fmtNum(model.input.targetCop - model.systemCop, 2));
                if (model.riskIndex > 40) blockers.push('risk index elevated at ' + fmtNum(model.riskIndex, 1));
                if (gateOpen < 3) blockers.push('only ' + gateOpen + '/3 control gates open');
                if (calScore < 70) blockers.push('calibration confidence moderate (' + fmtNum(calScore, 1) + '/100)');

                var level = 'ok';
                if (!hard.feasible || model.riskIndex > 48 || gateOpen < 2) level = 'bad';
                else if (blockers.length) level = 'warn';

                var text;
                if (blockers.length) {
                    text = 'Overall operating posture is ' + (level === 'bad' ? 'at risk' : 'watchlist') + ': ' + blockers.slice(0, 3).join('; ') + '.';
                } else {
                    text = 'Overall operating posture is stable: targets, constraints, control gates, and calibration quality are aligned for this scenario.';
                }
                return narrativePack(level, text);
            }

            function singleKpiEnergyNarrative(model) {
                var f = extractSankeyFlows(model);
                if (!f || f.total <= 0) return narrativePack('warn', 'Energy distribution could not be resolved.');
                var nonIt = Math.max(f.total - f.it, 1);
                var thermalShare = (f.thermal / nonIt) * 100;
                var elecShare = (f.elecLoss / nonIt) * 100;
                var topThermal = topThermalBranches(model, 2);
                var branchText = topThermal.map(function(t) { return t.k + ' ' + fmtNum(t.v, 0) + ' kW'; }).join(', ');
                var level = thermalShare > 76 ? 'warn' : 'ok';
                var text = 'Non-IT envelope is ' + fmtNum(nonIt, 0) + ' kW, dominated by thermal load at ' + fmtNum(thermalShare, 1) + '%; electrical loss share is ' + fmtNum(elecShare, 1) + '%. Main thermal drivers: ' + branchText + '.';
                return narrativePack(level, text);
            }

            function singleConstraintNarrative(model, hard, gates, calScore, standards) {
                var gateOpen = (gates.g1 ? 1 : 0) + (gates.g2 ? 1 : 0) + (gates.g3 ? 1 : 0);
                var stdCore = (standards || []).filter(function(s) { return s.k !== 'Composite'; });
                stdCore.sort(function(a, b) { return a.s - b.s; });
                var weakStd = stdCore[0] || { k: 'N/A', s: 0 };
                var level = 'ok';
                if (!hard.feasible || gateOpen < 2 || weakStd.s < 70) level = 'bad';
                else if (gateOpen < 3 || calScore < 75 || weakStd.s < 80) level = 'warn';
                var text = 'Constraint state: ' + (hard.feasible ? 'pass' : 'violation') + '; gates open ' + gateOpen + '/3; weakest standards domain is ' + weakStd.k + ' at ' + fmtNum(weakStd.s, 1) + '/100; calibration score ' + fmtNum(calScore, 1) + '/100.';
                return narrativePack(level, text);
            }

            function singleEnergyMatrixNarrative(model) {
                var f = extractSankeyFlows(model);
                if (!f || f.total <= 0) return narrativePack('warn', 'Energy matrix unavailable.');
                var thermalPct = (f.thermal / f.total) * 100;
                var level = thermalPct > 28 ? 'warn' : 'ok';
                var text = 'Facility split indicates IT at ' + fmtNum((f.it / f.total) * 100, 1) + '% and non-IT at ' + fmtNum(100 - ((f.it / f.total) * 100), 1) + '%. Thermal management contributes ' + fmtNum(thermalPct, 1) + '% of total facility power.';
                return narrativePack(level, text);
            }

            function singleSensitivityNarrative(sourceRows, thermalRows) {
                var sTop = (sourceRows && sourceRows[0]) ? sourceRows[0] : null;
                var tTop = (thermalRows && thermalRows[0]) ? thermalRows[0] : null;
                if (!sTop && !tTop) return narrativePack('warn', 'Sensitivity matrix is empty; no local derivative information was generated.');
                var seg = [];
                if (sTop) seg.push('facility-level leverage is highest at ' + sTop.param + ' (' + sTop.kw + ')');
                if (tTop) seg.push('thermal-level leverage is highest at ' + tTop.param + ' (' + tTop.kw + ')');
                return narrativePack('ok', 'Local finite-difference analysis shows that ' + seg.join('; ') + '. Prioritize these levers for first-pass optimization.');
            }

            function singleInputNarrative(model, inputRows) {
                var i = model.input || {};
                var flags = [];
                if (i.liquidCapture < 75) flags.push('liquid capture below 75%');
                if (i.pumpEff < 70) flags.push('pump efficiency below 70%');
                if (i.monitoring < 85) flags.push('monitoring below 85%');
                if (i.controlQuality < 80) flags.push('control quality below 80%');
                if (i.distLoss > 2.5) flags.push('distribution loss above 2.5%');
                var level = flags.length >= 3 ? 'bad' : (flags.length ? 'warn' : 'ok');
                var text = 'Input traceability covers ' + (inputRows ? inputRows.length : 0) + ' parameters. ' +
                    (flags.length ? ('Watchlist assumptions: ' + flags.slice(0, 3).join(', ') + '.') : 'Core assumptions are within typical operational ranges.');
                return narrativePack(level, text);
            }

            function singleSolverNarrative(model, constraints) {
                var pumpPct = (model.pumpPowerKw / Math.max(model.itKw, 1)) * 100;
                var dtState = (model.deltaT >= 6 && model.deltaT <= 14) ? 'in preferred band' : 'outside preferred band';
                var level = (pumpPct > constraints.pumpPctMax) ? 'bad' : ((model.deltaT < 6 || model.deltaT > 14) ? 'warn' : 'ok');
                var text = 'Solver state indicates deltaT ' + fmtNum(model.deltaT, 2) + 'C (' + dtState + '), flow ' + fmtNum(model.flowLpm, 0) + ' LPM, and pump burden ' + fmtNum(pumpPct, 2) + '% IT (limit ' + fmtNum(constraints.pumpPctMax, 2) + '%).';
                return narrativePack(level, text);
            }

            function singleLedgerNarrative(ledger) {
                var rows = Array.isArray(ledger) ? ledger : [];
                if (!rows.length) return narrativePack('warn', 'No assumption ledger rows available.');
                var avgConf = rows.reduce(function(a, r) { return a + (Number(r.confidence) || 0); }, 0) / rows.length;
                var lowConf = rows.filter(function(r) { return (Number(r.confidence) || 0) < 70; }).length;
                var stale = rows.filter(function(r) {
                    var ts = Date.parse(r.ts || '');
                    if (!isFinite(ts)) return true;
                    return (Date.now() - ts) > (180 * 24 * 3600 * 1000);
                }).length;
                var level = (lowConf > 2 || stale > 2) ? 'warn' : 'ok';
                var text = 'Ledger quality: ' + rows.length + ' rows, average confidence ' + fmtNum(avgConf, 1) + '%, low-confidence rows ' + lowConf + ', stale rows (>180 days or invalid timestamp) ' + stale + '.';
                return narrativePack(level, text);
            }

            function singleRecommendationNarrative(recs) {
                var arr = Array.isArray(recs) ? recs : [];
                if (!arr.length) return narrativePack('warn', 'No recommendation items generated.');
                var level = arr.length >= 5 ? 'warn' : 'ok';
                var text = 'Action queue contains ' + arr.length + ' prioritized items. First action: ' + shortText(arr[0], 160);
                return narrativePack(level, text);
            }

            function singleMonteCarloNarrative(mcRows, mcMeta) {
                if (!mcRows || !mcRows.length || !mcMeta) {
                    return narrativePack('warn', 'Uncertainty distribution not available in current session; robustness cannot be quantified.');
                }
                var pue = mcRows.find(function(r) { return r.k === 'PUE'; });
                var cop = mcRows.find(function(r) { return r.k === 'COP'; });
                var pueSpan = pue ? Math.max((pue.p90 || 0) - (pue.p10 || 0), 0) : 0;
                var copSpan = cop ? Math.max((cop.p90 || 0) - (cop.p10 || 0), 0) : 0;
                var level = (pueSpan > 0.055 || copSpan > 1.2) ? 'warn' : 'ok';
                var text = 'Monte Carlo robustness based on ' + fmtNum(mcMeta.samples || 0, 0) + ' runs at +/-' + fmtNum((mcMeta.unc || 0) * 100, 1) + '% input uncertainty: PUE span(P90-P10)=' + fmtNum(pueSpan, 3) + ', COP span=' + fmtNum(copSpan, 2) + '.';
                return narrativePack(level, text);
            }

            function compareExecutiveNarrative(left, right, lHard, rHard, lg, rg, verdict) {
                var lgOpen = (lg.g1 ? 1 : 0) + (lg.g2 ? 1 : 0) + (lg.g3 ? 1 : 0);
                var rgOpen = (rg.g1 ? 1 : 0) + (rg.g2 ? 1 : 0) + (rg.g3 ? 1 : 0);
                var level = (!rHard.feasible && lHard.feasible) ? 'bad' : 'ok';
                var text = verdict + ' Left constraints/gates: ' + (lHard.feasible ? 'pass' : 'fail') + ', ' + lgOpen + '/3 open; Right constraints/gates: ' + (rHard.feasible ? 'pass' : 'fail') + ', ' + rgOpen + '/3 open.';
                return narrativePack(level, text);
            }

            function compareKpiNarrative(metrics) {
                var improved = 0;
                var worsened = 0;
                var lead = null;
                (metrics || []).forEach(function(m) {
                    var delta = m.rv - m.lv;
                    var imp = false;
                    if (m.better === 'low') imp = delta < 0;
                    else if (m.better === 'high') imp = delta > 0;
                    if (imp) improved += 1;
                    else if (delta !== 0) worsened += 1;
                    var mag = Math.abs(delta);
                    if (!lead || mag > lead.mag) lead = { key: m.key, delta: delta, mag: mag };
                });
                var level = worsened > improved ? 'warn' : 'ok';
                var leadText = lead ? (lead.key + ' delta ' + signed(lead.delta, lead.key.indexOf('PUE') >= 0 ? 3 : 2, '')) : 'no dominant delta';
                return narrativePack(level, 'KPI delta profile: improved ' + improved + ', worsened ' + worsened + '. Largest movement: ' + leadText + '.');
            }

            function compareVisualNarrative(lm, rm, lf, rf) {
                var lNonIt = (lf ? (lf.total - lf.it) : Math.max(lm.totalFacilityKw - lm.itKw, 0));
                var rNonIt = (rf ? (rf.total - rf.it) : Math.max(rm.totalFacilityKw - rm.itKw, 0));
                var thermalDelta = ((rf ? rf.thermal : 0) - (lf ? lf.thermal : 0));
                var level = (rNonIt > lNonIt) ? 'warn' : 'ok';
                var text = 'Chart comparison indicates non-IT envelope shift of ' + signed(rNonIt - lNonIt, 0, ' kW') + ', with thermal branch delta ' + signed(thermalDelta, 0, ' kW') + '.';
                return narrativePack(level, text);
            }

            function compareStandardsNarrative(lm, rm) {
                var deltas = [
                    { k: 'ASHRAE', d: rm.scores.ashrae - lm.scores.ashrae },
                    { k: 'ANSI/TIA-942', d: rm.scores.ansi - lm.scores.ansi },
                    { k: 'ISO 50001', d: rm.scores.iso - lm.scores.iso },
                    { k: 'NFPA', d: rm.scores.nfpa - lm.scores.nfpa },
                    { k: 'Uptime', d: rm.scores.uptime - lm.scores.uptime }
                ];
                deltas.sort(function(a, b) { return a.d - b.d; });
                var weakest = deltas[0];
                var compDelta = rm.scores.total - lm.scores.total;
                var level = compDelta < 0 ? 'warn' : 'ok';
                var text = 'Composite standards delta is ' + signed(compDelta, 1, '') + '. Largest negative movement is ' + weakest.k + ' at ' + signed(weakest.d, 1, '') + '.';
                return narrativePack(level, text);
            }

            function compareInputNarrative(lm, rm) {
                var keys = [
                    { k: 'liquidCapture', d: 1, s: '%' },
                    { k: 'pumpEff', d: 1, s: '%' },
                    { k: 'airCop', d: 2, s: '' },
                    { k: 'fanPower', d: 2, s: '%IT' },
                    { k: 'economizerHours', d: 1, s: '%' },
                    { k: 'controlQuality', d: 0, s: '%' },
                    { k: 'itLoadMw', d: 2, s: 'MW' }
                ];
                var diffs = keys.map(function(x) {
                    var lv = Number((lm.input || {})[x.k]);
                    var rv = Number((rm.input || {})[x.k]);
                    return { k: x.k, d: x.d, s: x.s, delta: (isFinite(lv) && isFinite(rv)) ? (rv - lv) : 0 };
                }).sort(function(a, b) { return Math.abs(b.delta) - Math.abs(a.delta); }).slice(0, 3);
                var msg = diffs.map(function(x) { return x.k + ' ' + signed(x.delta, x.d, x.s ? (' ' + x.s) : ''); }).join(', ');
                return narrativePack('ok', 'Largest assumption shifts (right-left): ' + msg + '.');
            }

            function compareConstraintFlowNarrative(lm, rm, lHard, rHard, lf, rf) {
                var lNonIt = (lf ? lf.total - lf.it : 0);
                var rNonIt = (rf ? rf.total - rf.it : 0);
                var level = (!rHard.feasible && lHard.feasible) ? 'bad' : ((rNonIt > lNonIt) ? 'warn' : 'ok');
                var text = 'Constraint state left/right: ' + (lHard.feasible ? 'pass' : 'fail') + ' -> ' + (rHard.feasible ? 'pass' : 'fail') + '. Non-IT power delta is ' + signed(rNonIt - lNonIt, 0, ' kW') + '.';
                return narrativePack(level, text);
            }

            function compareRecommendationNarrative(recommendation, verdict) {
                var recs = Array.isArray(recommendation) ? recommendation : [];
                var level = recs.length >= 5 ? 'warn' : 'ok';
                var text = verdict + ' Priority next move: ' + (recs.length ? shortText(recs[0], 180) : 'no recommendation generated');
                return narrativePack(level, text);
            }

            function stdArray(values) {
                if (!values || values.length < 2) return 0;
                var mean = meanArray(values);
                var v = values.reduce(function(acc, x) {
                    var d = x - mean;
                    return acc + (d * d);
                }, 0) / (values.length - 1);
                return Math.sqrt(Math.max(v, 0));
            }

            function pdfImpactRows(model) {
                if (!model || !model.input) return [];
                var baseInput = model.input;
                return IMPACT_PARAMS.map(function(cfg) {
                    var candidate = mutateInputForParam(baseInput, cfg);
                    var alt = computeModel(candidate);
                    return {
                        param: cfg.label,
                        key: cfg.key,
                        step: '+' + cfg.step + (cfg.unit ? (' ' + cfg.unit) : ''),
                        dpue: signed(alt.pue - model.pue, 3, ''),
                        dcop: signed(alt.systemCop - model.systemCop, 2, ''),
                        dopex: signed(alt.netOpex - model.netOpex, 0, ' USD'),
                        dcarbon: signed(alt.netCarbonTons - model.netCarbonTons, 0, ' tCO2e'),
                        drisk: signed(alt.riskIndex - model.riskIndex, 2, '')
                    };
                });
            }

            function pdfAllNodeSensitivityRows(model, perNodeLimit) {
                if (!model) return [];
                var nodes = [
                    { k: 'source', l: 'Source' },
                    { k: 'compute', l: 'Compute' },
                    { k: 'thermal', l: 'Thermal' },
                    { k: 'elec', l: 'Electrical Loss' },
                    { k: 'aux', l: 'Facility Aux' },
                    { k: 'liq', l: 'Liquid Loop' },
                    { k: 'pump', l: 'Pump Drive' },
                    { k: 'air', l: 'Air Path' },
                    { k: 'fan', l: 'Fan Power' }
                ];
                var out = [];
                nodes.forEach(function(n) {
                    var rows = pdfSensitivityRows(model, n.k, perNodeLimit || 4);
                    rows.forEach(function(r) {
                        out.push({
                            node: n.l,
                            param: r.param,
                            sens: r.sens,
                            kw: r.kw,
                            impact: r.impact
                        });
                    });
                });
                return out;
            }

            function pdfParetoLedgerRows() {
                if (!latestPareto || !latestPareto.length) return [];
                return latestPareto.map(function(m, idx) {
                    return {
                        point: 'P' + (idx + 1),
                        feasible: m._feasible ? 'yes' : 'soft',
                        pue: fmtNum(m.pue, 3),
                        cop: fmtNum(m.systemCop, 2),
                        opex: fmtUsd(m.netOpex),
                        carbon: fmtNum(m.netCarbonTons, 0),
                        risk: fmtNum(m.riskIndex, 1),
                        itLoad: fmtNum(m.input.itLoadMw, 2) + ' MW',
                        capture: fmtNum(m.input.liquidCapture, 1) + '%',
                        supply: fmtNum(m.input.supplyTemp, 1) + 'C',
                        pumpEff: fmtNum(m.input.pumpEff, 1) + '%',
                        control: fmtNum(m.input.controlQuality, 0) + '%'
                    };
                });
            }

            function pdfMonteCarloDetailRows() {
                if (!latestMonteCarlo || !latestMonteCarlo.dist) return [];
                var specs = [
                    { key: 'pue', label: 'PUE', digits: 3 },
                    { key: 'cop', label: 'COP', digits: 2 },
                    { key: 'opex', label: 'Net OPEX (USD/yr)', digits: 0 },
                    { key: 'carbon', label: 'Carbon (tCO2e/yr)', digits: 0 },
                    { key: 'risk', label: 'Risk Index', digits: 1 }
                ];
                return specs.map(function(spec) {
                    var arr = (latestMonteCarlo.dist[spec.key] || []).slice();
                    if (!arr.length) {
                        return {
                            metric: spec.label, p10: '-', p50: '-', p90: '-', mean: '-', std: '-', min: '-', max: '-'
                        };
                    }
                    var sorted = arr.slice().sort(function(a, b) { return a - b; });
                    return {
                        metric: spec.label,
                        p10: fmtNum(percentile(sorted, 0.10), spec.digits),
                        p50: fmtNum(percentile(sorted, 0.50), spec.digits),
                        p90: fmtNum(percentile(sorted, 0.90), spec.digits),
                        mean: fmtNum(meanArray(sorted), spec.digits),
                        std: fmtNum(stdArray(sorted), spec.digits),
                        min: fmtNum(sorted[0], spec.digits),
                        max: fmtNum(sorted[sorted.length - 1], spec.digits)
                    };
                });
            }

            function pdfSelfTestRowsFromDom() {
                var tbody = document.getElementById('selfTestRows');
                if (!tbody) return [];
                var rows = [];
                tbody.querySelectorAll('tr').forEach(function(tr) {
                    var tds = tr.querySelectorAll('td');
                    if (!tds || tds.length < 4) return;
                    var name = String(tds[0].textContent || '').trim();
                    if (!name || name.indexOf('No self-test') === 0) return;
                    rows.push({
                        name: name,
                        status: String(tds[1].textContent || '').trim(),
                        check: String(tds[2].textContent || '').trim(),
                        detail: String(tds[3].textContent || '').trim()
                    });
                });
                return rows;
            }

            function pdfTelemetryRows() {
                var mapped = latestTelemetryParsed && latestTelemetryParsed.mapped ? latestTelemetryParsed.mapped : null;
                var rows = Object.keys(TELEMETRY_MANUAL_SELECT_ID).map(function(metricKey) {
                    var col = manualTelemetryColumn(metricKey, mapped);
                    return {
                        metric: metricKey,
                        column: col || '-'
                    };
                });
                return rows;
            }

            function pdfTelemetrySummary() {
                var status = document.getElementById('telemetryImportStatus');
                var meta = document.getElementById('telemetryImportMeta');
                var headers = latestTelemetryParsed && latestTelemetryParsed.headers ? latestTelemetryParsed.headers.length : 0;
                var rows = latestTelemetryParsed && latestTelemetryParsed.rows ? latestTelemetryParsed.rows.length : 0;
                return {
                    aggregation: telemetryAggregationMode(),
                    windowRows: telemetryWindowRows(),
                    applyOperational: !!(document.getElementById('telemetryApplyInputs') && document.getElementById('telemetryApplyInputs').checked),
                    headers: headers,
                    rows: rows,
                    meta: meta ? String(meta.textContent || '').trim() : '-',
                    status: status ? String(status.textContent || '').trim() : '-'
                };
            }

            function pdfExplorerAuditRows(model) {
                if (!model) return [];
                var constraints = gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var gateEval = evaluateGateStates(model);
                return EXPLORER_BLOCKS.map(function(b) {
                    var qa = explorerChecklistState(b.key);
                    var done = (qa.qa_inputs ? 1 : 0) + (qa.qa_dependencies ? 1 : 0) + (qa.qa_actions ? 1 : 0);
                    return {
                        block: b.label,
                        summary: explorerSummaryForBlock(b.key, model, hard, gateEval),
                        delta: explorerPrevDeltaLine(b.key, model),
                        qa: done + '/3',
                        note: explorerNoteValue(b.key) || '-',
                        doc: explorerDocText(b.key)
                    };
                });
            }

            function pdfScenarioRows() {
                if (!scenarioSnapshots || !scenarioSnapshots.length) return [];
                return scenarioSnapshots.map(function(s) {
                    var m = s.model || {};
                    return {
                        name: s.name || '-',
                        version: s.version == null ? '-' : String(s.version),
                        ts: s.ts || '-',
                        pue: m.pue == null ? '-' : fmtNum(m.pue, 3),
                        cop: m.systemCop == null ? '-' : fmtNum(m.systemCop, 2),
                        opex: m.netOpex == null ? '-' : fmtUsd(m.netOpex),
                        carbon: m.netCarbonTons == null ? '-' : (fmtNum(m.netCarbonTons, 0) + ' tCO2e'),
                        risk: m.riskIndex == null ? '-' : fmtNum(m.riskIndex, 1)
                    };
                });
            }

            function pdfEquationLines(model) {
                if (!model || !model.input) return [];
                var cp = (COOLANTS[model.input.coolantKey] || COOLANTS.water).cp;
                var rho = (COOLANTS[model.input.coolantKey] || COOLANTS.water).rho;
                return [
                    'Q_liquid = IT_kW * capture = ' + fmtNum(model.itKw, 1) + ' * ' + fmtNum(model.effectiveCapture / 100, 3) + ' = ' + fmtNum(model.liquidKw, 1) + ' kW',
                    'm_dot = Q/(Cp*dT) = ' + fmtNum(model.liquidKw, 1) + '/(' + fmtNum(cp, 3) + '*' + fmtNum(model.deltaT, 2) + ') = ' + fmtNum((model.liquidKw / (cp * model.deltaT)), 2) + ' kg/s',
                    'flow_lpm = (m_dot/rho)*60000 = ' + fmtNum(model.flowLpm, 1) + ' LPM',
                    'P_hyd = rho*g*H*Q = ' + fmtNum(rho, 0) + '*9.81*' + fmtNum(model.internals.pumpHeadEff, 2) + '*Q',
                    'P_pump = P_hyd/eta = ' + fmtNum(model.pumpPowerKw, 2) + ' kW',
                    'COP_system = IT_kW / Cooling_kW = ' + fmtNum(model.itKw, 1) + '/' + fmtNum(model.internals.totalCoolingKw, 2) + ' = ' + fmtNum(model.systemCop, 3),
                    'PUE = Facility_kW / IT_kW = ' + fmtNum(model.totalFacilityKw, 2) + '/' + fmtNum(model.itKw, 1) + ' = ' + fmtNum(model.pue, 3),
                    'AnnualEnergy = Facility_kW * 8760 = ' + fmtNum(model.annualGwh, 3) + ' GWh',
                    'NetOPEX = (Energy + Water) - ReuseCredit = ' + fmtUsd(model.netOpex),
                    'NetCarbon = AnnualCarbon - AvoidedCarbon = ' + fmtNum(model.netCarbonTons, 1) + ' tCO2e/yr'
                ];
            }

            function buildPdfRuntimeSnapshot(source, model, constraints, hard, guard, gates, rules) {
                var mc = pdfMonteCarloDetailRows();
                var pareto = pdfParetoLedgerRows();
                var telemetry = pdfTelemetrySummary();
                return {
                    generatedAt: nowIso(),
                    source: source ? source.label : 'unknown',
                    constraints: constraints,
                    hardConstraintCheck: hard,
                    inputGuard: guard,
                    gates: gates,
                    gateRules: rules,
                    calibration: calibrationState ? {
                        bestError: calibrationState.bestError,
                        baseError: calibrationState.baseError,
                        metricCount: calibrationState.metricCount,
                        quality: calibrationState.quality || null,
                        tuned: calibrationState.tuned || null
                    } : null,
                    telemetry: telemetry,
                    pareto: {
                        points: pareto.length,
                        selectedIdx: selectedParetoIdx,
                        rows: pareto
                    },
                    monteCarlo: latestMonteCarlo ? {
                        samples: latestMonteCarlo.samples,
                        uncertainty: latestMonteCarlo.unc,
                        detail: mc
                    } : null,
                    scenarios: pdfScenarioRows(),
                    explorer: {
                        state: explorerState,
                        historyTail: explorerRunHistory.slice(-40),
                        blocks: model ? pdfExplorerAuditRows(model) : []
                    },
                    model: model
                };
            }

            function snapshotFingerprint(value) {
                var text = JSON.stringify(value || {});
                var hash = 2166136261;
                for (var i = 0; i < text.length; i += 1) {
                    hash ^= text.charCodeAt(i);
                    hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
                }
                hash >>>= 0;
                return 'sig-' + hash.toString(16) + ' | len-' + text.length;
            }

            function runtimeSnapshotDigest(snapshot) {
                var s = snapshot || {};
                var m = s.model || {};
                var hard = s.hardConstraintCheck || {};
                var guard = s.inputGuard || {};
                var gates = s.gates || {};
                var rules = s.gateRules || {};
                var cal = s.calibration || null;
                var telemetry = s.telemetry || {};
                var pareto = s.pareto || {};
                var mc = s.monteCarlo || null;
                var scenarios = Array.isArray(s.scenarios) ? s.scenarios : [];
                var explorer = s.explorer || {};
                var explorerBlocks = Array.isArray(explorer.blocks) ? explorer.blocks : [];
                var historyTail = Array.isArray(explorer.historyTail) ? explorer.historyTail : [];
                return {
                    signature: snapshotFingerprint(s),
                    source: s.source || '-',
                    generatedAt: s.generatedAt || '-',
                    pue: m.pue == null ? '-' : fmtNum(m.pue, 3),
                    cop: m.systemCop == null ? '-' : fmtNum(m.systemCop, 2),
                    netOpex: m.netOpex == null ? '-' : fmtUsd(m.netOpex),
                    netCarbon: m.netCarbonTons == null ? '-' : (fmtNum(m.netCarbonTons, 0) + ' tCO2e/yr'),
                    risk: m.riskIndex == null ? '-' : fmtNum(m.riskIndex, 1),
                    hardFeasible: hard.feasible ? 'PASS' : 'FAIL',
                    hardIssues: (hard.issues && hard.issues.length) ? hard.issues.join(', ') : 'none',
                    guardBlocked: guard.blocked ? 'Yes' : 'No',
                    guardStops: (guard.hardStops || []).length,
                    guardWarnings: (guard.warnings || []).length,
                    gateState: 'G1 ' + (gates.g1 ? 'OPEN' : 'BLOCKED') + ' | G2 ' + (gates.g2 ? 'OPEN' : 'BLOCKED') + ' | G3 ' + (gates.g3 ? 'OPEN' : 'BLOCKED'),
                    ruleG1: rules.g1 || '-',
                    ruleG2: rules.g2 || '-',
                    ruleG3: rules.g3 || '-',
                    calibration: cal ? ('bestErr ' + fmtNum(cal.bestError || 0, 2) + '% | baseErr ' + fmtNum(cal.baseError || 0, 2) + '% | metrics ' + fmtNum(cal.metricCount || 0, 0)) : 'not available',
                    telemetry: 'agg ' + (telemetry.aggregation || '-') + ' | window ' + (telemetry.windowRows || 'all') + ' | rows ' + fmtNum(telemetry.rows || 0, 0) + ' | headers ' + fmtNum(telemetry.headers || 0, 0),
                    pareto: 'points ' + fmtNum(pareto.points || 0, 0) + ' | selected idx ' + fmtNum((pareto.selectedIdx == null ? -1 : pareto.selectedIdx), 0),
                    monteCarlo: mc ? ('samples ' + fmtNum(mc.samples || 0, 0) + ' | uncertainty ' + fmtNum((mc.uncertainty || 0) * 100, 1) + '%') : 'not available',
                    scenarios: fmtNum(scenarios.length, 0),
                    explorer: 'blocks ' + fmtNum(explorerBlocks.length, 0) + ' | history tail ' + fmtNum(historyTail.length, 0)
                };
            }

            function auditFieldValueText(value) {
                if (value === null || value === undefined) return '-';
                if (typeof value === 'number') return formatTraceValue(value);
                if (typeof value === 'boolean') return value ? 'true' : 'false';
                return String(value);
            }

            function collectSnapshotFieldRows(snapshot) {
                var rows = [];
                function walk(path, value, depth) {
                    var p = path || '(root)';
                    if (depth > 18) {
                        rows.push({ path: p, type: 'max-depth', value: '[truncated]' });
                        return;
                    }
                    if (value === null || value === undefined) {
                        rows.push({ path: p, type: 'null', value: '-' });
                        return;
                    }
                    if (Array.isArray(value)) {
                        rows.push({ path: p, type: 'array', value: 'len ' + value.length });
                        if (!value.length) return;
                        value.forEach(function(item, idx) {
                            walk(p + '[' + idx + ']', item, depth + 1);
                        });
                        return;
                    }
                    if (typeof value === 'object') {
                        var keys = Object.keys(value);
                        rows.push({ path: p, type: 'object', value: 'keys ' + keys.length });
                        if (!keys.length) return;
                        keys.forEach(function(key) {
                            walk(path ? (path + '.' + key) : key, value[key], depth + 1);
                        });
                        return;
                    }
                    rows.push({ path: p, type: typeof value, value: auditFieldValueText(value) });
                }
                walk('', snapshot, 0);
                return rows;
            }

            function snapshotRowsToMap(rows) {
                var map = {};
                (rows || []).forEach(function(r) {
                    if (!r || !r.path) return;
                    map[r.path] = {
                        type: r.type || '-',
                        value: r.value == null ? '-' : String(r.value)
                    };
                });
                return map;
            }

            function renderFieldMapBlocks(title, rows, chunkSize) {
                var allRows = Array.isArray(rows) ? rows : [];
                if (!allRows.length) {
                    return '<div class="muted" style="margin-top:8px;">No field map rows available.</div>';
                }
                var size = Math.max(100, parseInt(chunkSize, 10) || 220);
                var chunks = [];
                for (var i = 0; i < allRows.length; i += size) {
                    chunks.push(allRows.slice(i, i + size));
                }
                return chunks.map(function(chunk, idx) {
                    return [
                        '<div class="r-chart-wrap allow-break" style="margin-top:8px;">',
                        '<div class="muted" style="margin-bottom:6px;"><strong>' + escapeHtml(title) + ' Part ' + (idx + 1) + '/' + chunks.length + ' (' + chunk.length + ' rows)</strong></div>',
                        '<table><thead><tr><th>Field Path</th><th>Type</th><th>Value</th></tr></thead><tbody>',
                        chunk.map(function(r) {
                            return '<tr><td class="mono">' + escapeHtml(String(r.path || '-')) + '</td><td>' + escapeHtml(String(r.type || '-')) + '</td><td>' + escapeHtml(String(r.value == null ? '-' : r.value)) + '</td></tr>';
                        }).join(''),
                        '</tbody></table>',
                        '</div>'
                    ].join('');
                }).join('');
            }

            function renderCompareFieldMapBlocks(title, leftRows, rightRows, chunkSize) {
                var lMap = snapshotRowsToMap(leftRows || []);
                var rMap = snapshotRowsToMap(rightRows || []);
                var keyMap = {};
                Object.keys(lMap).forEach(function(k) { keyMap[k] = true; });
                Object.keys(rMap).forEach(function(k) { keyMap[k] = true; });
                var keys = Object.keys(keyMap).sort();
                if (!keys.length) {
                    return '<div class="muted" style="margin-top:8px;">No compare field-map rows available.</div>';
                }
                var rows = keys.map(function(k) {
                    var l = lMap[k] || { type: '-', value: '-' };
                    var r = rMap[k] || { type: '-', value: '-' };
                    var status = (l.type === r.type && l.value === r.value) ? 'same' : 'changed';
                    return {
                        path: k,
                        lType: l.type,
                        rType: r.type,
                        lValue: l.value,
                        rValue: r.value,
                        status: status
                    };
                });
                var size = Math.max(80, parseInt(chunkSize, 10) || 160);
                var chunks = [];
                for (var i = 0; i < rows.length; i += size) {
                    chunks.push(rows.slice(i, i + size));
                }
                return chunks.map(function(chunk, idx) {
                    return [
                        '<div class="r-chart-wrap allow-break" style="margin-top:8px;">',
                        '<div class="muted" style="margin-bottom:6px;"><strong>' + escapeHtml(title) + ' Part ' + (idx + 1) + '/' + chunks.length + ' (' + chunk.length + ' rows)</strong></div>',
                        '<table><thead><tr><th>Field Path</th><th>Left Type</th><th>Left Value</th><th>Right Type</th><th>Right Value</th><th>Status</th></tr></thead><tbody>',
                        chunk.map(function(r) {
                            var cls = r.status === 'same' ? 'ok' : 'warn';
                            return '<tr><td class="mono">' + escapeHtml(r.path) + '</td><td>' + escapeHtml(r.lType) + '</td><td>' + escapeHtml(r.lValue) + '</td><td>' + escapeHtml(r.rType) + '</td><td>' + escapeHtml(r.rValue) + '</td><td><span class="' + cls + '">' + escapeHtml(r.status) + '</span></td></tr>';
                        }).join(''),
                        '</tbody></table>',
                        '</div>'
                    ].join('');
                }).join('');
            }

            function renderRuntimeStructuredSection(title, snapshot) {
                var s = snapshot || {};
                var d = runtimeSnapshotDigest(s);
                var fieldRows = collectSnapshotFieldRows(s);
                var guard = s.inputGuard || {};
                var hardStops = guard.hardStops || [];
                var warnings = guard.warnings || [];
                var mcRows = (s.monteCarlo && Array.isArray(s.monteCarlo.detail)) ? s.monteCarlo.detail : [];
                var scenarios = Array.isArray(s.scenarios) ? s.scenarios : [];
                var explorerBlocks = (s.explorer && Array.isArray(s.explorer.blocks)) ? s.explorer.blocks : [];
                var digestRows = [
                    { k: 'Snapshot Signature', v: d.signature, n: 'Audit fingerprint to verify report state consistency.' },
                    { k: 'Source', v: d.source, n: 'Model source used when PDF was generated.' },
                    { k: 'Generated At', v: d.generatedAt, n: 'Snapshot timestamp in report context.' },
                    { k: 'Hard Constraint', v: d.hardFeasible + ' | ' + d.hardIssues, n: 'Constraint feasibility and issue list.' },
                    { k: 'Input Guardrail', v: 'blocked=' + d.guardBlocked + ' | hardStops=' + d.guardStops + ' | warnings=' + d.guardWarnings, n: 'Input quality and boundary validation.' },
                    { k: 'Gate State', v: d.gateState, n: 'Control gate state at report capture.' },
                    { k: 'Calibration', v: d.calibration, n: 'Calibration convergence and confidence metadata.' },
                    { k: 'Telemetry', v: d.telemetry, n: 'Telemetry parser mode and coverage summary.' },
                    { k: 'Pareto', v: d.pareto, n: 'Frontier count and active selected point.' },
                    { k: 'Monte Carlo', v: d.monteCarlo, n: 'Uncertainty run envelope summary.' },
                    { k: 'Scenario Vault', v: d.scenarios + ' snapshots', n: 'Stored scenario count at export time.' },
                    { k: 'Explorer', v: d.explorer, n: 'Explorer block and history trace footprint.' },
                    { k: 'Model KPI', v: 'PUE ' + d.pue + ' | COP ' + d.cop + ' | Net OPEX ' + d.netOpex + ' | Carbon ' + d.netCarbon + ' | Risk ' + d.risk, n: 'Primary output vector summary.' }
                ];
                return [
                    '<section class="r-sec page-break"><h2>' + escapeHtml(title) + '</h2><div class="r-body">',
                    '<div class="r-note">Structured runtime audit snapshot. Raw JSON dump is hidden to avoid print leakage, but full field-level map is included below.</div>',
                    '<table><thead><tr><th>Audit Domain</th><th>Value</th><th>Interpretation</th></tr></thead><tbody>',
                    digestRows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.k) + '</td><td>' + escapeHtml(String(r.v)) + '</td><td>' + escapeHtml(r.n) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    '<table style="margin-top:8px;"><thead><tr><th>Gate Rule</th><th>Expression</th></tr></thead><tbody>',
                    '<tr><td>G1</td><td class="mono">' + escapeHtml(d.ruleG1) + '</td></tr>',
                    '<tr><td>G2</td><td class="mono">' + escapeHtml(d.ruleG2) + '</td></tr>',
                    '<tr><td>G3</td><td class="mono">' + escapeHtml(d.ruleG3) + '</td></tr>',
                    '</tbody></table>',
                    '<table style="margin-top:8px;"><thead><tr><th>Guardrail Type</th><th>Status</th><th>Detail</th></tr></thead><tbody>',
                    hardStops.map(function(t) { return '<tr><td>Hard Stop</td><td><span class="bad">BLOCK</span></td><td>' + escapeHtml(t) + '</td></tr>'; }).join(''),
                    warnings.map(function(t) { return '<tr><td>Warning</td><td><span class="warn">REVIEW</span></td><td>' + escapeHtml(t) + '</td></tr>'; }).join(''),
                    (!hardStops.length && !warnings.length ? '<tr><td>Guardrail</td><td><span class="ok">CLEAR</span></td><td>No hard stop or warning in this runtime snapshot.</td></tr>' : ''),
                    '</tbody></table>',
                    (mcRows.length
                        ? ('<table style="margin-top:8px;"><thead><tr><th>Monte Carlo Metric</th><th>P10</th><th>P50</th><th>P90</th><th>Mean</th><th>Std</th><th>Min</th><th>Max</th></tr></thead><tbody>' +
                            mcRows.map(function(r) {
                                return '<tr><td>' + escapeHtml(String(r.metric || '-')) + '</td><td>' + escapeHtml(String(r.p10 || '-')) + '</td><td>' + escapeHtml(String(r.p50 || '-')) + '</td><td>' + escapeHtml(String(r.p90 || '-')) + '</td><td>' + escapeHtml(String(r.mean || '-')) + '</td><td>' + escapeHtml(String(r.std || '-')) + '</td><td>' + escapeHtml(String(r.min || '-')) + '</td><td>' + escapeHtml(String(r.max || '-')) + '</td></tr>';
                            }).join('') +
                            '</tbody></table>')
                        : '<div class="muted" style="margin-top:8px;">Monte Carlo detail not available in current session snapshot.</div>'),
                    (scenarios.length
                        ? ('<table style="margin-top:8px;"><thead><tr><th>Scenario</th><th>Version</th><th>Timestamp</th><th>PUE</th><th>COP</th><th>Net OPEX</th><th>Carbon</th><th>Risk</th></tr></thead><tbody>' +
                            scenarios.map(function(r) {
                                return '<tr><td>' + escapeHtml(String(r.name || '-')) + '</td><td>' + escapeHtml(String(r.version || '-')) + '</td><td>' + escapeHtml(String(r.ts || '-')) + '</td><td>' + escapeHtml(String(r.pue || '-')) + '</td><td>' + escapeHtml(String(r.cop || '-')) + '</td><td>' + escapeHtml(String(r.opex || '-')) + '</td><td>' + escapeHtml(String(r.carbon || '-')) + '</td><td>' + escapeHtml(String(r.risk || '-')) + '</td></tr>';
                            }).join('') +
                            '</tbody></table>')
                        : '<div class="muted" style="margin-top:8px;">No scenario records in runtime snapshot.</div>'),
                    (explorerBlocks.length
                        ? ('<table style="margin-top:8px;"><thead><tr><th>Explorer Block</th><th>Summary</th><th>QA</th><th>Note</th></tr></thead><tbody>' +
                            explorerBlocks.map(function(r) {
                                return '<tr><td>' + escapeHtml(String(r.block || '-')) + '</td><td>' + escapeHtml(String(r.summary || '-')) + '</td><td>' + escapeHtml(String(r.qa || '-')) + '</td><td>' + escapeHtml(String(r.note || '-')) + '</td></tr>';
                            }).join('') +
                            '</tbody></table>')
                        : '<div class="muted" style="margin-top:8px;">Explorer block audit unavailable in runtime snapshot.</div>'),
                    '<div class="r-note" style="margin-top:8px;">Complete flattened field-map rows: ' + fmtNum(fieldRows.length, 0) + '.</div>',
                    renderFieldMapBlocks('Runtime Full Field Map', fieldRows, 220),
                    '</div></section>'
                ].join('');
            }

            function renderRuntimeStructuredCompareSection(leftSnapshot, rightSnapshot) {
                var ld = runtimeSnapshotDigest(leftSnapshot || {});
                var rd = runtimeSnapshotDigest(rightSnapshot || {});
                var leftRows = collectSnapshotFieldRows(leftSnapshot || {});
                var rightRows = collectSnapshotFieldRows(rightSnapshot || {});
                var rows = [
                    { k: 'Snapshot Signature', l: ld.signature, r: rd.signature },
                    { k: 'Source', l: ld.source, r: rd.source },
                    { k: 'Generated At', l: ld.generatedAt, r: rd.generatedAt },
                    { k: 'Hard Constraint', l: ld.hardFeasible + ' | ' + ld.hardIssues, r: rd.hardFeasible + ' | ' + rd.hardIssues },
                    { k: 'Input Guardrail', l: 'blocked=' + ld.guardBlocked + ', stop=' + ld.guardStops + ', warn=' + ld.guardWarnings, r: 'blocked=' + rd.guardBlocked + ', stop=' + rd.guardStops + ', warn=' + rd.guardWarnings },
                    { k: 'Gate State', l: ld.gateState, r: rd.gateState },
                    { k: 'Rule G1', l: ld.ruleG1, r: rd.ruleG1 },
                    { k: 'Rule G2', l: ld.ruleG2, r: rd.ruleG2 },
                    { k: 'Rule G3', l: ld.ruleG3, r: rd.ruleG3 },
                    { k: 'Calibration', l: ld.calibration, r: rd.calibration },
                    { k: 'Telemetry', l: ld.telemetry, r: rd.telemetry },
                    { k: 'Pareto', l: ld.pareto, r: rd.pareto },
                    { k: 'Monte Carlo', l: ld.monteCarlo, r: rd.monteCarlo },
                    { k: 'Scenario Vault', l: ld.scenarios + ' snapshots', r: rd.scenarios + ' snapshots' },
                    { k: 'Explorer', l: ld.explorer, r: rd.explorer },
                    { k: 'Model KPI', l: 'PUE ' + ld.pue + ' | COP ' + ld.cop + ' | OPEX ' + ld.netOpex + ' | Carbon ' + ld.netCarbon + ' | Risk ' + ld.risk, r: 'PUE ' + rd.pue + ' | COP ' + rd.cop + ' | OPEX ' + rd.netOpex + ' | Carbon ' + rd.netCarbon + ' | Risk ' + rd.risk }
                ];
                return [
                    '<section class="r-sec page-break"><h2>Compare Runtime Snapshots (Structured Audit)</h2><div class="r-body">',
                    '<div class="r-note">Structured side-by-side runtime audit. Raw JSON is excluded from print output to prevent code-style leakage and rendering issues. Full field-level compare map is included below.</div>',
                    '<table><thead><tr><th>Audit Domain</th><th>Left Snapshot</th><th>Right Snapshot</th></tr></thead><tbody>',
                    rows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.k) + '</td><td>' + escapeHtml(String(r.l)) + '</td><td>' + escapeHtml(String(r.r)) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    '<div class="r-note" style="margin-top:8px;">Flattened field rows: left ' + fmtNum(leftRows.length, 0) + ', right ' + fmtNum(rightRows.length, 0) + '.</div>',
                    renderCompareFieldMapBlocks('Runtime Full Field Compare Map', leftRows, rightRows, 140),
                    '</div></section>'
                ].join('');
            }

            function singleImpactNarrative(rows) {
                if (!rows || !rows.length) return narrativePack('warn', 'Impact matrix unavailable.');
                var sorted = rows.slice().sort(function(a, b) {
                    return Math.abs(parseFloat(String(b.dopex).replace(/[^\d+.-]/g, '')) || 0) - Math.abs(parseFloat(String(a.dopex).replace(/[^\d+.-]/g, '')) || 0);
                });
                var top = sorted[0];
                return narrativePack('ok', 'Impact matrix computed for ' + rows.length + ' tunable parameters. Largest near-point economic movement appears at ' + top.param + ' (Net OPEX delta ' + top.dopex + ').');
            }

            function singleParetoNarrative(rows) {
                if (!rows || !rows.length) return narrativePack('warn', 'Pareto frontier has not been generated in this session.');
                var feasible = rows.filter(function(r) { return r.feasible === 'yes'; }).length;
                return narrativePack(feasible ? 'ok' : 'warn', 'Pareto ledger includes ' + rows.length + ' points with ' + feasible + ' feasible points under active hard constraints.');
            }

            function singleExplorerNarrative(rows) {
                if (!rows || !rows.length) return narrativePack('warn', 'Explorer audit unavailable.');
                var qaGood = rows.filter(function(r) { return r.qa === '3/3'; }).length;
                return narrativePack(qaGood === rows.length ? 'ok' : 'warn', 'Explorer audit covers ' + rows.length + ' blocks; QA checklist complete on ' + qaGood + '/' + rows.length + ' blocks.');
            }

            function singleTelemetryNarrative(summary, rows) {
                if (!summary || !rows || !rows.length) return narrativePack('warn', 'Telemetry mapping snapshot unavailable.');
                var mapped = rows.filter(function(r) { return r.column && r.column !== '-'; }).length;
                var level = mapped >= 6 ? 'ok' : 'warn';
                return narrativePack(level, 'Telemetry mapping covers ' + mapped + '/' + rows.length + ' fields. Aggregation=' + summary.aggregation + ', window=' + (summary.windowRows || 'all') + ', rows=' + summary.rows + '.');
            }

            function singleScenarioNarrative(rows) {
                if (!rows || !rows.length) return narrativePack('warn', 'No scenario snapshots stored.');
                return narrativePack('ok', 'Scenario vault contains ' + rows.length + ' saved snapshots for replay and compare workflows.');
            }

            function singleSelfTestNarrative(rows) {
                if (!rows || !rows.length) return narrativePack('warn', 'Self-test has not been executed or table is empty.');
                var pass = rows.filter(function(r) { return String(r.status).toUpperCase().indexOf('PASS') >= 0; }).length;
                var level = pass === rows.length ? 'ok' : 'warn';
                return narrativePack(level, 'Self-test results: ' + pass + '/' + rows.length + ' checks passed in latest run snapshot.');
            }

            function buildSinglePdfReport(source) {
                var model = source.model;
                var rules = source.rules || gateRules;
                var constraints = source.constraints || gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var gates = evaluateGateStatesWithRules(model, rules);
                var quality = computeCalibrationQuality(model, gatherCalibrationTargets());
                var calScore = clamp(100 - (quality.valErr * 2.1) - (quality.ci95 * 1.3), 0, 100);
                var ledger = loadLedger();
                var summaryText = hard.feasible ? 'Constraint envelope satisfied' : ('Constraint issues: ' + hard.issues.join(', '));
                var standards = pdfStandardsRows(model);
                var inputRows = pdfInputMatrixRows(model);
                var outputRows = pdfOutputVectorRows(model);
                var solverRows = pdfSolverRows(model);
                var energyRows = pdfEnergyRows(model);
                var recs = pdfSingleRecommendations(model, hard, gates, constraints);
                var kpiChart = buildPdfKpiChartSvg(model);
                var energyChart = buildPdfEnergyDistributionSvg(model);
                var sourceSensitivityRows = pdfSensitivityRows(model, 'source', 6);
                var thermalSensitivityRows = pdfSensitivityRows(model, 'thermal', 6);
                var allNodeSensitivityRowsPdf = pdfAllNodeSensitivityRows(model, 4);
                var inputGuard = evaluateInputHardRules(model.input, model, constraints);
                var impactRowsPdf = pdfImpactRows(model);
                var paretoLedgerRowsPdf = pdfParetoLedgerRows();
                var mcDetailRowsPdf = pdfMonteCarloDetailRows();
                var selfTestRowsPdf = pdfSelfTestRowsFromDom();
                var telemetrySummaryPdf = pdfTelemetrySummary();
                var telemetryRowsPdf = pdfTelemetryRows();
                var explorerAuditRowsPdf = pdfExplorerAuditRows(model);
                var scenarioRowsPdf = pdfScenarioRows();
                var equationLinesPdf = pdfEquationLines(model);
                var runtimeSnapshotPdf = buildPdfRuntimeSnapshot(source, model, constraints, hard, inputGuard, gates, rules);
                var nExecutive = singleExecutiveNarrative(model, hard, gates, calScore);
                var nKpiEnergy = singleKpiEnergyNarrative(model);
                var nConstraint = singleConstraintNarrative(model, hard, gates, calScore, standards);
                var nEnergy = singleEnergyMatrixNarrative(model);
                var nSensitivity = singleSensitivityNarrative(sourceSensitivityRows, thermalSensitivityRows);
                var nInput = singleInputNarrative(model, inputRows);
                var nSolver = singleSolverNarrative(model, constraints);
                var nLedger = singleLedgerNarrative(ledger);
                var nRecommendation = singleRecommendationNarrative(recs);
                var nImpact = singleImpactNarrative(impactRowsPdf);
                var nPareto = singleParetoNarrative(paretoLedgerRowsPdf);
                var nExplorer = singleExplorerNarrative(explorerAuditRowsPdf);
                var nTelemetry = singleTelemetryNarrative(telemetrySummaryPdf, telemetryRowsPdf);
                var nScenario = singleScenarioNarrative(scenarioRowsPdf);
                var nSelfTest = singleSelfTestNarrative(selfTestRowsPdf);
                var mcChart = buildPdfMonteCarloBandSvg();
                var mcSection = '';
                var mcRowsForNarrative = null;
                var mcMetaForNarrative = null;

                if (latestMonteCarlo && latestMonteCarlo.dist) {
                    var dist = latestMonteCarlo.dist;
                    var mcRows = [
                        { k: 'PUE', p10: percentile(dist.pue, 0.10), p50: percentile(dist.pue, 0.50), p90: percentile(dist.pue, 0.90), d: 3 },
                        { k: 'COP', p10: percentile(dist.cop, 0.10), p50: percentile(dist.cop, 0.50), p90: percentile(dist.cop, 0.90), d: 2 },
                        { k: 'Net OPEX (USD/yr)', p10: percentile(dist.opex, 0.10), p50: percentile(dist.opex, 0.50), p90: percentile(dist.opex, 0.90), d: 0 },
                        { k: 'Carbon (tCO2e/yr)', p10: percentile(dist.carbon, 0.10), p50: percentile(dist.carbon, 0.50), p90: percentile(dist.carbon, 0.90), d: 0 },
                        { k: 'Risk Index', p10: percentile(dist.risk, 0.10), p50: percentile(dist.risk, 0.50), p90: percentile(dist.risk, 0.90), d: 1 }
                    ];
                    mcRowsForNarrative = mcRows;
                    mcMetaForNarrative = { samples: latestMonteCarlo.samples || 0, unc: latestMonteCarlo.unc || 0 };
                    mcSection = [
                        '<section class="r-sec"><h2>Uncertainty Envelope (Monte Carlo)</h2><div class="r-body">',
                        '<div class="r-grid2">',
                        '<div class="r-card"><div class="k">Simulation</div><div class="v">' + fmtNum(latestMonteCarlo.samples || 0, 0) + ' runs</div><div class="s">Input uncertainty ' + fmtNum((latestMonteCarlo.unc || 0) * 100, 1) + '%</div></div>',
                        '<div class="r-card"><div class="k">Interpretation</div><div class="s">Use P10/P50/P90 spread to validate robustness before deployment gates and capex commitment.</div></div>',
                        '</div>',
                        mcChart ? ('<div class="r-chart-wrap" style="margin-top:8px;">' + mcChart + '</div>') : '<div class="muted">Monte Carlo chart unavailable.</div>',
                        '<table style="margin-top:8px;"><thead><tr><th>Metric</th><th>P10</th><th>P50</th><th>P90</th></tr></thead><tbody>',
                        mcRows.map(function(r) {
                            return '<tr><td>' + escapeHtml(r.k) + '</td><td>' + fmtNum(r.p10, r.d) + '</td><td>' + fmtNum(r.p50, r.d) + '</td><td>' + fmtNum(r.p90, r.d) + '</td></tr>';
                        }).join(''),
                        '</tbody></table>',
                        narrativeHtml(singleMonteCarloNarrative(mcRowsForNarrative, mcMetaForNarrative)),
                        '</div></section>'
                    ].join('');
                } else {
                    mcSection = '<section class="r-sec"><h2>Uncertainty Envelope (Monte Carlo)</h2><div class="r-body"><div class="muted">No Monte Carlo distribution captured in current session.</div>' +
                        narrativeHtml(singleMonteCarloNarrative(null, null)) +
                        '</div></section>';
                }

                return [
                    renderReportHead('LTC Engineering PDF Report (Single)', source.label),

                    '<section class="r-sec"><h2>Executive Snapshot</h2><div class="r-body">',
                    '<div class="r-kpi">',
                    '<div class="r-card"><div class="k">PUE</div><div class="v">' + fmtNum(model.pue, 3) + '</div><div class="s">Target ' + fmtNum(model.input.targetPue, 3) + ' | Gap ' + signed(model.pueGap, 3, '') + '</div></div>',
                    '<div class="r-card"><div class="k">System COP</div><div class="v">' + fmtNum(model.systemCop, 2) + '</div><div class="s">Target ' + fmtNum(model.input.targetCop, 2) + ' | Gap ' + signed(model.copGap, 2, '') + '</div></div>',
                    '<div class="r-card"><div class="k">Net OPEX</div><div class="v">' + fmtUsd(model.netOpex) + '</div><div class="s">Annual carbon ' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr</div></div>',
                    '<div class="r-card"><div class="k">Risk Index</div><div class="v">' + fmtNum(model.riskIndex, 1) + '/100</div><div class="s">' + escapeHtml(metricStatus(model, constraints)) + '</div></div>',
                    '<div class="r-card"><div class="k">Composite Score</div><div class="v">' + fmtNum(model.scores.total, 1) + '/100</div><div class="s">Grade ' + grade(model.scores.total) + '</div></div>',
                    '<div class="r-card"><div class="k">Failure Mode</div><div class="v">' + escapeHtml(model.failureMode) + '</div><div class="s">' + escapeHtml(model.failureNote) + '</div></div>',
                    '</div>',
                    '<div class="r-note">This report follows engineering audit format: KPI summary, control/constraint evidence, full IO matrix, solver internals, uncertainty envelope, and governance ledger.</div>',
                    narrativeHtml(nExecutive),
                    '</div></section>',

                    '<section class="r-sec"><h2>KPI + Energy Visualization</h2><div class="r-body"><div class="r-grid2">',
                    '<div class="r-chart-wrap">' + (kpiChart || '<div class="muted">KPI chart unavailable.</div>') + '</div>',
                    '<div class="r-chart-wrap">' + (energyChart || '<div class="muted">Energy distribution chart unavailable.</div>') + '</div>',
                    '</div>',
                    narrativeHtml(nKpiEnergy),
                    '</div></section>',

                    '<section class="r-sec"><h2>Constraint, Control, Calibration, Standards</h2><div class="r-body">',
                    '<div class="r-grid3">',
                    '<div class="r-card"><div class="k">Constraint Engine</div><div class="s ' + (hard.feasible ? 'ok' : 'warn') + '">' + escapeHtml(summaryText) + '</div><div class="s">Pump as % IT: ' + fmtNum(hard.pumpPctIt, 2) + '% (max ' + fmtNum(constraints.pumpPctMax, 2) + '%)</div></div>',
                    '<div class="r-card"><div class="k">Control Gates</div><div class="s">G1 ' + (gates.g1 ? '<span class="ok">OPEN</span>' : '<span class="bad">BLOCKED</span>') + ' | G2 ' + (gates.g2 ? '<span class="ok">OPEN</span>' : '<span class="bad">BLOCKED</span>') + ' | G3 ' + (gates.g3 ? '<span class="ok">OPEN</span>' : '<span class="bad">BLOCKED</span>') + '</div><div class="s mono">G1 ' + escapeHtml(rules.g1) + '</div><div class="s mono">G2 ' + escapeHtml(rules.g2) + '</div><div class="s mono">G3 ' + escapeHtml(rules.g3) + '</div></div>',
                    '<div class="r-card"><div class="k">Calibration Quality</div><div class="v">' + fmtNum(calScore, 1) + '/100</div><div class="s">Validation error ' + fmtNum(quality.valErr, 2) + '% | 95% CI ' + fmtNum(quality.ci95, 2) + '%</div></div>',
                    '</div>',
                    '<table style="margin-top:8px;"><thead><tr><th>Standard</th><th>Score</th><th>Status</th></tr></thead><tbody>',
                    standards.map(function(r) {
                        var cls = r.s >= 85 ? 'ok' : (r.s >= 75 ? 'warn' : 'bad');
                        var txt = r.s >= 85 ? 'Strong' : (r.s >= 75 ? 'Needs hardening' : 'Critical improvement');
                        return '<tr><td>' + escapeHtml(r.k) + '</td><td>' + fmtNum(r.s, 1) + '/100</td><td><span class="' + cls + '">' + txt + '</span></td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    narrativeHtml(nConstraint),
                    '</div></section>',

                    '<section class="r-sec"><h2>Energy Distribution Matrix</h2><div class="r-body"><table><thead><tr><th>Domain</th><th>Value</th><th>Interpretation</th></tr></thead><tbody>',
                    energyRows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.k) + '</td><td>' + escapeHtml(r.v) + '</td><td>' + escapeHtml(r.n) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    narrativeHtml(nEnergy),
                    '</div></section>',

                    '<section class="r-sec"><h2>Sensitivity Matrix (Finite-Difference)</h2><div class="r-body">',
                    '<div class="r-grid2">',
                    pdfSensitivityTableHtml('Facility Source Node', sourceSensitivityRows),
                    pdfSensitivityTableHtml('Thermal Node', thermalSensitivityRows),
                    '</div>',
                    '<div class="r-note">Sensitivity values are computed around the active operating point using local +/- parameter perturbation and normalized into node-level kW equivalence.</div>',
                    narrativeHtml(nSensitivity),
                    '</div></section>',

                    '<section class="r-sec page-break"><h2>Engineering Input Matrix (Full Traceability)</h2><div class="r-body"><table><thead><tr><th>Input Parameter</th><th>Value</th><th>Role</th></tr></thead><tbody>',
                    inputRows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.k) + '</td><td>' + escapeHtml(r.v) + '</td><td>' + escapeHtml(r.n) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    narrativeHtml(nInput),
                    '</div></section>',

                    '<section class="r-sec"><h2>Output Vector + Solver Internals</h2><div class="r-body"><div class="split">',
                    '<table><thead><tr><th>Output Metric</th><th>Value</th><th>Interpretation</th></tr></thead><tbody>',
                    outputRows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.k) + '</td><td>' + escapeHtml(r.v) + '</td><td>' + escapeHtml(r.n) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    '<table><thead><tr><th>Solver Internal</th><th>Value</th><th>Interpretation</th></tr></thead><tbody>',
                    solverRows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.k) + '</td><td>' + escapeHtml(r.v) + '</td><td>' + escapeHtml(r.n) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    '</div>',
                    narrativeHtml(nSolver),
                    '</div></section>',

                    mcSection,

                    '<section class="r-sec"><h2>Assumption Ledger (Audit Trail)</h2><div class="r-body">',
                    '<table><thead><tr><th>Parameter</th><th>Source</th><th>Owner</th><th>Confidence</th><th>Timestamp</th></tr></thead><tbody>',
                    ledger.map(function(row) {
                        return '<tr><td>' + escapeHtml(row.label) + '</td><td>' + escapeHtml(row.source) + '</td><td>' + escapeHtml(row.owner) + '</td><td>' + escapeHtml(String(row.confidence)) + '%</td><td>' + escapeHtml(row.ts) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    narrativeHtml(nLedger),
                    '</div></section>',

                    '<section class="r-sec"><h2>Recommended Actions</h2><div class="r-body"><ul class="r-list">',
                    recs.map(function(t) { return '<li>' + escapeHtml(t) + '</li>'; }).join(''),
                    '</ul><div class="r-note">Use this action set as pre-read for design review, gate review, and deployment sign-off meeting.</div>',
                    narrativeHtml(nRecommendation),
                    '</div></section>',

                    '<section class="r-sec page-break"><h2>Control, Guardrail, and Rule Configuration</h2><div class="r-body"><div class="r-grid2">',
                    '<div class="r-card"><div class="k">Constraint Set</div><div class="s">PUE max ' + fmtNum(constraints.pueMax, 3) + ' | COP min ' + fmtNum(constraints.copMin, 2) + ' | Risk max ' + fmtNum(constraints.riskMax, 1) + ' | Pump%IT max ' + fmtNum(constraints.pumpPctMax, 2) + ' | enforce=' + (constraints.enforce ? 'yes' : 'no') + '</div></div>',
                    '<div class="r-card"><div class="k">Gate Rules</div><div class="s mono">G1 ' + escapeHtml(rules.g1) + '</div><div class="s mono">G2 ' + escapeHtml(rules.g2) + '</div><div class="s mono">G3 ' + escapeHtml(rules.g3) + '</div><div class="s">Gate state: G1 ' + (gates.g1 ? 'OPEN' : 'BLOCKED') + ' | G2 ' + (gates.g2 ? 'OPEN' : 'BLOCKED') + ' | G3 ' + (gates.g3 ? 'OPEN' : 'BLOCKED') + '</div></div>',
                    '</div>',
                    '<table style="margin-top:8px;"><thead><tr><th>Input Guardrail</th><th>Status</th><th>Detail</th></tr></thead><tbody>',
                    (inputGuard.hardStops || []).map(function(t) { return '<tr><td>Hard Stop</td><td><span class="bad">BLOCK</span></td><td>' + escapeHtml(t) + '</td></tr>'; }).join('') +
                    (inputGuard.warnings || []).map(function(t) { return '<tr><td>Warning</td><td><span class="warn">REVIEW</span></td><td>' + escapeHtml(t) + '</td></tr>'; }).join('') +
                    (!(inputGuard.hardStops || []).length && !(inputGuard.warnings || []).length ? '<tr><td>Guardrail</td><td><span class="ok">CLEAR</span></td><td>No hard stop or warning from current input set.</td></tr>' : ''),
                    '</tbody></table>',
                    '</div></section>',

                    '<section class="r-sec"><h2>Equation Trace (Complete)</h2><div class="r-body"><div class="r-chart-wrap allow-break"><pre class="mono r-json" style="margin:0;">' + escapeHtml(equationLinesPdf.join('\n')) + '</pre></div></div></section>',

                    '<section class="r-sec"><h2>Impact Matrix (All Tunable Parameters)</h2><div class="r-body"><table><thead><tr><th>Parameter</th><th>Step</th><th>dPUE</th><th>dCOP</th><th>dNet OPEX</th><th>dCarbon</th><th>dRisk</th></tr></thead><tbody>',
                    impactRowsPdf.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.param) + '</td><td>' + escapeHtml(r.step) + '</td><td>' + escapeHtml(r.dpue) + '</td><td>' + escapeHtml(r.dcop) + '</td><td>' + escapeHtml(r.dopex) + '</td><td>' + escapeHtml(r.dcarbon) + '</td><td>' + escapeHtml(r.drisk) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    narrativeHtml(nImpact),
                    '</div></section>',

                    '<section class="r-sec"><h2>Sensitivity Matrix (All Sankey Nodes)</h2><div class="r-body"><table><thead><tr><th>Node</th><th>Parameter</th><th>Sens</th><th>kW Eq.</th><th>Impact</th></tr></thead><tbody>',
                    allNodeSensitivityRowsPdf.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.node) + '</td><td>' + escapeHtml(r.param) + '</td><td>' + escapeHtml(r.sens) + '</td><td>' + escapeHtml(r.kw) + '</td><td>' + escapeHtml(r.impact) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    '</div></section>',

                    '<section class="r-sec"><h2>Pareto Frontier Ledger (Full Session)</h2><div class="r-body">',
                    (paretoLedgerRowsPdf.length
                        ? ('<table><thead><tr><th>Point</th><th>Feasible</th><th>PUE</th><th>COP</th><th>Net OPEX</th><th>Carbon</th><th>Risk</th><th>IT Load</th><th>Capture</th><th>Supply</th><th>Pump Eff</th><th>Control</th></tr></thead><tbody>' +
                            paretoLedgerRowsPdf.map(function(r, idx) {
                                var sel = (idx === selectedParetoIdx) ? ' style="background:rgba(37,99,235,0.08);"' : '';
                                return '<tr' + sel + '><td>' + escapeHtml(r.point) + '</td><td>' + escapeHtml(r.feasible) + '</td><td>' + escapeHtml(r.pue) + '</td><td>' + escapeHtml(r.cop) + '</td><td>' + escapeHtml(r.opex) + '</td><td>' + escapeHtml(r.carbon) + '</td><td>' + escapeHtml(r.risk) + '</td><td>' + escapeHtml(r.itLoad) + '</td><td>' + escapeHtml(r.capture) + '</td><td>' + escapeHtml(r.supply) + '</td><td>' + escapeHtml(r.pumpEff) + '</td><td>' + escapeHtml(r.control) + '</td></tr>';
                            }).join('') +
                            '</tbody></table>')
                        : '<div class="muted">No Pareto frontier points in current session.</div>'),
                    narrativeHtml(nPareto),
                    '</div></section>',

                    '<section class="r-sec"><h2>Monte Carlo Detail Statistics</h2><div class="r-body">',
                    (mcDetailRowsPdf.length
                        ? ('<table><thead><tr><th>Metric</th><th>P10</th><th>P50</th><th>P90</th><th>Mean</th><th>Std</th><th>Min</th><th>Max</th></tr></thead><tbody>' +
                            mcDetailRowsPdf.map(function(r) {
                                return '<tr><td>' + escapeHtml(r.metric) + '</td><td>' + escapeHtml(r.p10) + '</td><td>' + escapeHtml(r.p50) + '</td><td>' + escapeHtml(r.p90) + '</td><td>' + escapeHtml(r.mean) + '</td><td>' + escapeHtml(r.std) + '</td><td>' + escapeHtml(r.min) + '</td><td>' + escapeHtml(r.max) + '</td></tr>';
                            }).join('') +
                            '</tbody></table>')
                        : '<div class="muted">No Monte Carlo distribution available.</div>'),
                    '</div></section>',

                    '<section class="r-sec"><h2>Explorer Block Audit (All Blocks)</h2><div class="r-body">',
                    '<table><thead><tr><th>Block</th><th>Summary</th><th>Delta</th><th>QA</th><th>Engineer Note</th><th>Documentation</th></tr></thead><tbody>',
                    explorerAuditRowsPdf.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.block) + '</td><td>' + escapeHtml(r.summary) + '</td><td>' + escapeHtml(r.delta) + '</td><td>' + escapeHtml(r.qa) + '</td><td>' + escapeHtml(r.note) + '</td><td>' + escapeHtml(r.doc) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    narrativeHtml(nExplorer),
                    '</div></section>',

                    '<section class="r-sec"><h2>Telemetry Mapping Snapshot</h2><div class="r-body"><div class="r-grid3">',
                    '<div class="r-card"><div class="k">Aggregation</div><div class="v">' + escapeHtml(String(telemetrySummaryPdf.aggregation || '-')) + '</div><div class="s">Window rows: ' + escapeHtml(String(telemetrySummaryPdf.windowRows || 'all')) + '</div></div>',
                    '<div class="r-card"><div class="k">CSV Stats</div><div class="v">' + fmtNum(telemetrySummaryPdf.rows || 0, 0) + '</div><div class="s">rows | headers ' + fmtNum(telemetrySummaryPdf.headers || 0, 0) + '</div></div>',
                    '<div class="r-card"><div class="k">Operational Apply</div><div class="v">' + (telemetrySummaryPdf.applyOperational ? 'ON' : 'OFF') + '</div><div class="s">' + escapeHtml(telemetrySummaryPdf.status || '-') + '</div></div>',
                    '</div>',
                    '<div class="r-note">' + escapeHtml(telemetrySummaryPdf.meta || '-') + '</div>',
                    '<table style="margin-top:8px;"><thead><tr><th>Metric</th><th>Mapped Column</th></tr></thead><tbody>',
                    telemetryRowsPdf.map(function(r) { return '<tr><td>' + escapeHtml(r.metric) + '</td><td>' + escapeHtml(r.column) + '</td></tr>'; }).join(''),
                    '</tbody></table>',
                    narrativeHtml(nTelemetry),
                    '</div></section>',

                    '<section class="r-sec"><h2>Scenario Vault Snapshot</h2><div class="r-body">',
                    (scenarioRowsPdf.length
                        ? ('<table><thead><tr><th>Name</th><th>Version</th><th>Timestamp</th><th>PUE</th><th>COP</th><th>Net OPEX</th><th>Carbon</th><th>Risk</th></tr></thead><tbody>' +
                            scenarioRowsPdf.map(function(r) {
                                return '<tr><td>' + escapeHtml(r.name) + '</td><td>' + escapeHtml(r.version) + '</td><td>' + escapeHtml(r.ts) + '</td><td>' + escapeHtml(r.pue) + '</td><td>' + escapeHtml(r.cop) + '</td><td>' + escapeHtml(r.opex) + '</td><td>' + escapeHtml(r.carbon) + '</td><td>' + escapeHtml(r.risk) + '</td></tr>';
                            }).join('') +
                            '</tbody></table>')
                        : '<div class="muted">No saved scenarios.</div>'),
                    narrativeHtml(nScenario),
                    '</div></section>',

                    '<section class="r-sec"><h2>Self-Test Snapshot (Latest UI Table)</h2><div class="r-body">',
                    (selfTestRowsPdf.length
                        ? ('<table><thead><tr><th>Test Case</th><th>Status</th><th>Check</th><th>Detail</th></tr></thead><tbody>' +
                            selfTestRowsPdf.map(function(r) {
                                return '<tr><td>' + escapeHtml(r.name) + '</td><td>' + escapeHtml(r.status) + '</td><td>' + escapeHtml(r.check) + '</td><td>' + escapeHtml(r.detail) + '</td></tr>';
                            }).join('') +
                            '</tbody></table>')
                        : '<div class="muted">No self-test rows captured in current UI state.</div>'),
                    narrativeHtml(nSelfTest),
                    '</div></section>',

                    renderRuntimeStructuredSection('Complete Runtime Snapshot (Structured Audit)', runtimeSnapshotPdf)
                ].join('');
            }

            function buildComparePdfReport(left, right) {
                var lm = left.model;
                var rm = right.model;
                var lHard = evaluateHardConstraints(lm, left.constraints || gatherConstraintState());
                var rHard = evaluateHardConstraints(rm, right.constraints || gatherConstraintState());
                var lg = evaluateGateStatesWithRules(lm, left.rules || gateRules);
                var rg = evaluateGateStatesWithRules(rm, right.rules || gateRules);
                var metrics = [
                    { key: 'PUE', lv: lm.pue, rv: rm.pue, digits: 3, better: 'low' },
                    { key: 'COP', lv: lm.systemCop, rv: rm.systemCop, digits: 2, better: 'high' },
                    { key: 'Net OPEX (USD/yr)', lv: lm.netOpex, rv: rm.netOpex, digits: 0, better: 'low' },
                    { key: 'Net Carbon (tCO2e/yr)', lv: lm.netCarbonTons, rv: rm.netCarbonTons, digits: 0, better: 'low' },
                    { key: 'Risk Index', lv: lm.riskIndex, rv: rm.riskIndex, digits: 1, better: 'low' },
                    { key: 'Flow (LPM)', lv: lm.flowLpm, rv: rm.flowLpm, digits: 0, better: 'neutral' },
                    { key: 'Pump Power (kW)', lv: lm.pumpPowerKw, rv: rm.pumpPowerKw, digits: 1, better: 'low' },
                    { key: 'Composite Score', lv: lm.scores.total, rv: rm.scores.total, digits: 1, better: 'high' }
                ];
                var deltaChart = buildPdfCompareDeltaSvg(lm, rm);
                var mixChart = buildPdfCompareEnergySvg(lm, rm);
                var inputDeltaRows = pdfCompareInputDeltaRows(lm, rm);
                var inputDeltaRowsAll = pdfCompareAllInputDeltaRows(lm, rm);
                var lf = extractSankeyFlows(lm);
                var rf = extractSankeyFlows(rm);
                var lGuard = evaluateInputHardRules(lm.input, lm, left.constraints || gatherConstraintState());
                var rGuard = evaluateInputHardRules(rm.input, rm, right.constraints || gatherConstraintState());
                var leftRuntimeSnapshot = buildPdfRuntimeSnapshot(left, lm, left.constraints || gatherConstraintState(), lHard, lGuard, lg, left.rules || gateRules);
                var rightRuntimeSnapshot = buildPdfRuntimeSnapshot(right, rm, right.constraints || gatherConstraintState(), rHard, rGuard, rg, right.rules || gateRules);

                var leftWin = (lHard.feasible ? 1 : 0) + (lm.pue <= lm.input.targetPue ? 1 : 0) + (lm.systemCop >= lm.input.targetCop ? 1 : 0) + (lm.riskIndex <= rm.riskIndex ? 1 : 0);
                var rightWin = (rHard.feasible ? 1 : 0) + (rm.pue <= rm.input.targetPue ? 1 : 0) + (rm.systemCop >= rm.input.targetCop ? 1 : 0) + (rm.riskIndex <= lm.riskIndex ? 1 : 0);
                var verdict = rightWin > leftWin ? ('Preferred configuration: ' + right.label) : (leftWin > rightWin ? ('Preferred configuration: ' + left.label) : 'Both configurations are balanced; choose based on deployment constraints.');
                var recommendation = [];
                if (rm.pue < lm.pue) recommendation.push('Right scenario reduces PUE by ' + fmtNum(lm.pue - rm.pue, 3) + '.');
                if (rm.systemCop > lm.systemCop) recommendation.push('Right scenario improves COP by ' + fmtNum(rm.systemCop - lm.systemCop, 2) + '.');
                if (rm.netOpex < lm.netOpex) recommendation.push('Right scenario lowers net OPEX by ' + fmtUsd(lm.netOpex - rm.netOpex) + ' per year.');
                if (rm.netCarbonTons < lm.netCarbonTons) recommendation.push('Right scenario reduces annual carbon by ' + fmtNum(lm.netCarbonTons - rm.netCarbonTons, 0) + ' tCO2e.');
                if (rHard.feasible && !lHard.feasible) recommendation.push('Right scenario clears hard constraints while left does not.');
                if (!recommendation.length) recommendation.push('Trade-offs are balanced; decision should prioritize deployment risk tolerance and implementation feasibility.');
                var nCmpExecutive = compareExecutiveNarrative(left, right, lHard, rHard, lg, rg, verdict);
                var nCmpVisual = compareVisualNarrative(lm, rm, lf, rf);
                var nCmpKpi = compareKpiNarrative(metrics);
                var nCmpStandards = compareStandardsNarrative(lm, rm);
                var nCmpInput = compareInputNarrative(lm, rm);
                var nCmpConstraintFlow = compareConstraintFlowNarrative(lm, rm, lHard, rHard, lf, rf);
                var nCmpRecommendation = compareRecommendationNarrative(recommendation, verdict);

                return [
                    renderReportHead('LTC Engineering PDF Report (Compare)', left.label + ' vs ' + right.label),
                    '<section class="r-sec"><h2>Compare Executive Summary</h2><div class="r-body">',
                    '<div class="r-grid2">',
                    '<div class="r-card"><div class="k">Left Source</div><div class="v" style="font-size:14px;">' + escapeHtml(left.label) + '</div><div class="s">Timestamp ' + escapeHtml(left.ts || nowIso()) + '</div><div class="s">Constraints ' + (lHard.feasible ? '<span class="ok">PASS</span>' : '<span class="bad">FAIL</span>') + ' | Gates G1:' + (lg.g1 ? 'open' : 'block') + ' G2:' + (lg.g2 ? 'open' : 'block') + ' G3:' + (lg.g3 ? 'open' : 'block') + '</div></div>',
                    '<div class="r-card"><div class="k">Right Source</div><div class="v" style="font-size:14px;">' + escapeHtml(right.label) + '</div><div class="s">Timestamp ' + escapeHtml(right.ts || nowIso()) + '</div><div class="s">Constraints ' + (rHard.feasible ? '<span class="ok">PASS</span>' : '<span class="bad">FAIL</span>') + ' | Gates G1:' + (rg.g1 ? 'open' : 'block') + ' G2:' + (rg.g2 ? 'open' : 'block') + ' G3:' + (rg.g3 ? 'open' : 'block') + '</div></div>',
                    '</div>',
                    '<div class="r-card" style="margin-top:8px;"><div class="k">Verdict</div><div class="s">' + escapeHtml(verdict) + '</div></div>',
                    narrativeHtml(nCmpExecutive),
                    '</div></section>',

                    '<section class="r-sec"><h2>Delta Visualizations</h2><div class="r-body"><div class="r-grid2">',
                    '<div class="r-chart-wrap">' + (deltaChart || '<div class="muted">Delta chart unavailable.</div>') + '</div>',
                    '<div class="r-chart-wrap">' + (mixChart || '<div class="muted">Energy mix compare chart unavailable.</div>') + '</div>',
                    '</div>',
                    narrativeHtml(nCmpVisual),
                    '</div></section>',

                    '<section class="r-sec"><h2>KPI Delta Matrix (Right - Left)</h2><div class="r-body"><table><thead><tr><th>Metric</th><th>Left</th><th>Right</th><th>Delta</th></tr></thead><tbody>',
                    metrics.map(function(m) {
                        return '<tr>' +
                            '<td>' + escapeHtml(m.key) + '</td>' +
                            '<td>' + fmtNum(m.lv, m.digits) + '</td>' +
                            '<td>' + fmtNum(m.rv, m.digits) + '</td>' +
                            '<td>' + escapeHtml(deltaCell(m.lv, m.rv, m.digits, m.better)) + '</td>' +
                        '</tr>';
                    }).join(''),
                    '</tbody></table>',
                    narrativeHtml(nCmpKpi),
                    '</div></section>',

                    '<section class="r-sec"><h2>Standards Score Delta (Right - Left)</h2><div class="r-body"><table><thead><tr><th>Standard</th><th>Left</th><th>Right</th><th>Delta</th></tr></thead><tbody>',
                    '<tr><td>ASHRAE</td><td>' + fmtNum(lm.scores.ashrae, 1) + '</td><td>' + fmtNum(rm.scores.ashrae, 1) + '</td><td>' + signed(rm.scores.ashrae - lm.scores.ashrae, 1, '') + '</td></tr>',
                    '<tr><td>ANSI/TIA-942</td><td>' + fmtNum(lm.scores.ansi, 1) + '</td><td>' + fmtNum(rm.scores.ansi, 1) + '</td><td>' + signed(rm.scores.ansi - lm.scores.ansi, 1, '') + '</td></tr>',
                    '<tr><td>ISO 50001</td><td>' + fmtNum(lm.scores.iso, 1) + '</td><td>' + fmtNum(rm.scores.iso, 1) + '</td><td>' + signed(rm.scores.iso - lm.scores.iso, 1, '') + '</td></tr>',
                    '<tr><td>NFPA</td><td>' + fmtNum(lm.scores.nfpa, 1) + '</td><td>' + fmtNum(rm.scores.nfpa, 1) + '</td><td>' + signed(rm.scores.nfpa - lm.scores.nfpa, 1, '') + '</td></tr>',
                    '<tr><td>Uptime</td><td>' + fmtNum(lm.scores.uptime, 1) + '</td><td>' + fmtNum(rm.scores.uptime, 1) + '</td><td>' + signed(rm.scores.uptime - lm.scores.uptime, 1, '') + '</td></tr>',
                    '<tr><td>Composite</td><td>' + fmtNum(lm.scores.total, 1) + '</td><td>' + fmtNum(rm.scores.total, 1) + '</td><td>' + signed(rm.scores.total - lm.scores.total, 1, '') + '</td></tr>',
                    '</tbody></table>',
                    narrativeHtml(nCmpStandards),
                    '</div></section>',

                    '<section class="r-sec"><h2>Input Assumption Delta (Right - Left)</h2><div class="r-body"><table><thead><tr><th>Input</th><th>Left</th><th>Right</th><th>Delta</th></tr></thead><tbody>',
                    inputDeltaRows.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.label) + '</td><td>' + r.lv + '</td><td>' + r.rv + '</td><td>' + escapeHtml(r.delta) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    narrativeHtml(nCmpInput),
                    '</div></section>',

                    '<section class="r-sec"><h2>Input Assumption Delta (Complete Field Map)</h2><div class="r-body">',
                    '<table><thead><tr><th>Input Key</th><th>Left</th><th>Right</th><th>Delta</th></tr></thead><tbody>',
                    inputDeltaRowsAll.map(function(r) {
                        return '<tr><td>' + escapeHtml(r.key) + '</td><td>' + escapeHtml(r.left) + '</td><td>' + escapeHtml(r.right) + '</td><td>' + escapeHtml(r.delta) + '</td></tr>';
                    }).join(''),
                    '</tbody></table>',
                    '</div></section>',

                    '<section class="r-sec"><h2>Constraint + Flow Envelope Delta</h2><div class="r-body">',
                    '<div class="r-grid2">',
                    '<div class="r-card"><div class="k">Hard Constraint State</div><div class="s">Left: ' + (lHard.feasible ? '<span class="ok">PASS</span>' : '<span class="bad">' + escapeHtml(lHard.issues.join(', ')) + '</span>') + '</div><div class="s">Right: ' + (rHard.feasible ? '<span class="ok">PASS</span>' : '<span class="bad">' + escapeHtml(rHard.issues.join(', ')) + '</span>') + '</div></div>',
                    '<div class="r-card"><div class="k">Power Envelope</div><div class="s">Left total ' + fmtNum(lf ? lf.total : 0, 0) + ' kW | Right total ' + fmtNum(rf ? rf.total : 0, 0) + ' kW</div><div class="s">Non-IT delta ' + signed((rf ? (rf.total - rf.it) : 0) - (lf ? (lf.total - lf.it) : 0), 0, " kW") + '</div></div>',
                    '</div>',
                    '<div style="margin-top:8px;">',
                    '<div class="tag">PUE Delta ' + signed(rm.pue - lm.pue, 3, '') + '</div>',
                    '<div class="tag">COP Delta ' + signed(rm.systemCop - lm.systemCop, 2, '') + '</div>',
                    '<div class="tag">Risk Delta ' + signed(rm.riskIndex - lm.riskIndex, 1, '') + '</div>',
                    '<div class="tag">Pump Delta ' + signed(rm.pumpPowerKw - lm.pumpPowerKw, 1, ' kW') + '</div>',
                    '<div class="tag">OPEX Delta ' + signed(rm.netOpex - lm.netOpex, 0, ' USD/yr') + '</div>',
                    '<div class="tag">Carbon Delta ' + signed(rm.netCarbonTons - lm.netCarbonTons, 0, ' tCO2e/yr') + '</div>',
                    '</div>',
                    narrativeHtml(nCmpConstraintFlow),
                    '</div></section>',

                    '<section class="r-sec"><h2>Recommendation Summary</h2><div class="r-body"><ul class="r-list">',
                    recommendation.map(function(t) { return '<li>' + escapeHtml(t) + '</li>'; }).join(''),
                    '</ul><div class="r-note">Use this compare report for design-option decision forum: architecture board, reliability gate, and finance/operations alignment.</div>',
                    narrativeHtml(nCmpRecommendation),
                    '</div></section>',

                    renderRuntimeStructuredCompareSection(leftRuntimeSnapshot, rightRuntimeSnapshot)
                ].join('');
            }

            function exportPdfSingle() {
                var srcSel = document.getElementById('pdfSingleSource');
                var source = resolveModelSource(srcSel ? srcSel.value : 'live_baseline');
                if (!source.ok || !source.model) {
                    alert('PDF single export failed: invalid source model.');
                    return;
                }
                if (!openPdfReport(buildSinglePdfReport(source))) {
                    alert('Popup blocked. Please allow popups and retry PDF export.');
                    return;
                }
                var s = document.getElementById('exportStatus');
                if (s) {
                    s.className = 'status-pill ok';
                    s.textContent = 'PDF Single Report Opened';
                }
            }

            function exportPdfCompare() {
                var leftSel = document.getElementById('pdfCompareLeft');
                var rightSel = document.getElementById('pdfCompareRight');
                var left = resolveModelSource(leftSel ? leftSel.value : 'live_baseline');
                var right = resolveModelSource(rightSel ? rightSel.value : 'live_optimized');
                if (!left.ok || !right.ok || !left.model || !right.model) {
                    alert('PDF compare export failed: invalid compare source.');
                    return;
                }
                if (left.key === right.key) {
                    alert('Choose two different sources for compare PDF.');
                    return;
                }
                if (!openPdfReport(buildComparePdfReport(left, right))) {
                    alert('Popup blocked. Please allow popups and retry PDF compare export.');
                    return;
                }
                var s = document.getElementById('exportStatus');
                if (s) {
                    s.className = 'status-pill ok';
                    s.textContent = 'PDF Compare Report Opened';
                }
            }

            function applyInputObjectToForm(obj) {
                if (!obj) return;
                Object.keys(obj).forEach(function(k) {
                    var id = Object.keys(INPUT_KEY_BY_ID).find(function(idKey) { return INPUT_KEY_BY_ID[idKey] === k; });
                    var el = id ? document.getElementById(id) : null;
                    if (!el) return;
                    if (el.type === 'checkbox') el.checked = !!obj[k];
                    else el.value = obj[k];
                });
            }

            function snapshotSummary(model) {
                return 'PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2) + ' | OPEX ' + fmtUsd(model.netOpex) + ' | Carbon ' + fmtNum(model.netCarbonTons, 0);
            }

            function renderScenarioDiff(cur, prev) {
                var box = document.getElementById('scenarioDiff');
                if (!box) return;
                if (!cur || !prev) {
                    box.textContent = 'Select two scenarios sequentially to compare deltas.';
                    return;
                }
                var lines = [];
                lines.push('Compare: ' + prev.name + ' -> ' + cur.name);
                lines.push('PUE delta: ' + signed(cur.model.pue - prev.model.pue, 3, ''));
                lines.push('COP delta: ' + signed(cur.model.systemCop - prev.model.systemCop, 2, ''));
                lines.push('Net OPEX delta: ' + signed(cur.model.netOpex - prev.model.netOpex, 0, ' USD'));
                lines.push('Carbon delta: ' + signed(cur.model.netCarbonTons - prev.model.netCarbonTons, 0, ' tCO2e'));
                lines.push('Risk delta: ' + signed(cur.model.riskIndex - prev.model.riskIndex, 1, ''));
                box.textContent = lines.join('\n');
            }

            function loadLedger() {
                try {
                    var raw = localStorage.getItem(LEDGER_STORE_KEY);
                    if (raw) return JSON.parse(raw);
                } catch (e) {}
                return PROVENANCE_TEMPLATE.map(function(item) {
                    return Object.assign({}, item, { ts: nowIso() });
                });
            }

            function saveLedger(rows) {
                localStorage.setItem(LEDGER_STORE_KEY, JSON.stringify(rows));
            }

            function renderLedgerTable(rows) {
                var tbody = document.getElementById('ledgerRows');
                if (!tbody) return;
                if (!rows.length) {
                    tbody.innerHTML = '<tr><td colspan="5">No ledger rows.</td></tr>';
                    return;
                }
                tbody.innerHTML = rows.map(function(r) {
                    return '<tr>' +
                        '<td>' + escapeHtml(r.label) + '</td>' +
                        '<td>' + escapeHtml(r.source) + '</td>' +
                        '<td>' + escapeHtml(r.owner) + '</td>' +
                        '<td>' + escapeHtml(String(r.confidence)) + '%</td>' +
                        '<td>' + escapeHtml(r.ts) + '</td>' +
                    '</tr>';
                }).join('');
            }

            function flattenObject(prefix, obj, out) {
                Object.keys(obj || {}).forEach(function(key) {
                    var value = obj[key];
                    var nextKey = prefix ? (prefix + '.' + key) : key;
                    if (value === null || value === undefined) {
                        out[nextKey] = '-';
                    } else if (typeof value === 'number' || typeof value === 'string' || typeof value === 'boolean') {
                        out[nextKey] = value;
                    } else if (typeof value === 'object' && !Array.isArray(value)) {
                        flattenObject(nextKey, value, out);
                    }
                });
            }

            function formatTraceValue(value) {
                if (typeof value === 'number') {
                    if (Math.abs(value) >= 1000) return fmtNum(value, 0);
                    if (Math.abs(value) >= 100) return fmtNum(value, 1);
                    if (Math.abs(value) >= 10) return fmtNum(value, 2);
                    return fmtNum(value, 3);
                }
                if (typeof value === 'boolean') return value ? 'true' : 'false';
                return String(value);
            }

            function renderTraceability(model) {
                var inFlat = {};
                flattenObject('', model.input, inFlat);

                var outObj = {};
                Object.keys(model).forEach(function(key) {
                    if (key !== 'input') outObj[key] = model[key];
                });
                var outFlat = {};
                flattenObject('', outObj, outFlat);

                var inKeys = Object.keys(inFlat).sort();
                var outKeys = Object.keys(outFlat).sort();

                setText('inParamCount', inKeys.length);
                setText('outParamCount', outKeys.length);
                setText('traceSummary', 'Inputs ' + inKeys.length + ' | Outputs ' + outKeys.length);

                var inList = document.getElementById('inputTraceList');
                var outList = document.getElementById('outputTraceList');
                if (inList) {
                    inList.innerHTML = inKeys.map(function(key) {
                        return '<div class="trace-item">' + termTooltipSpan(key, key, 'input') + ' = ' + escapeHtml(formatTraceValue(inFlat[key])) + '</div>';
                    }).join('');
                }
                if (outList) {
                    outList.innerHTML = outKeys.map(function(key) {
                        return '<div class="trace-item">' + termTooltipSpan(key, key, 'output') + ' = ' + escapeHtml(formatTraceValue(outFlat[key])) + '</div>';
                    }).join('');
                }
            }

            function renderStageLines(id, lines) {
                var el = document.getElementById(id);
                if (!el) return;
                if (!lines || !lines.length) {
                    el.innerHTML = '<div class="stage-line">-</div>';
                    return;
                }
                el.innerHTML = lines.map(function(line) {
                    return '<div class="stage-line">' + renderStageLineContent(line) + '</div>';
                }).join('');
            }

            function renderPipelineFlow(model) {
                var inFlat = {};
                flattenObject('', model.input, inFlat);
                var inKeys = Object.keys(inFlat).sort();
                setText('stageInputCount', String(inKeys.length));
                renderStageLines('stageInputLines', inKeys.map(function(key) {
                    return {
                        label: key,
                        key: key,
                        value: formatTraceValue(inFlat[key]),
                        layer: 'input'
                    };
                }));

                var derivedLines = [
                    { key: 'effectiveCapture', label: 'effectiveCapture', value: fmtNum(model.effectiveCapture, 2) + '%', layer: 'processing' },
                    { key: 'designDensity', label: 'designDensity', value: fmtNum(model.designDensity, 2) + ' kW/rack', layer: 'processing' },
                    { key: 'rackDensityGap', label: 'rackDensityGap', value: fmtNum(model.rackDensityGap, 2) + ' kW/rack', layer: 'processing' },
                    { key: 'futureFactor', label: 'futureFactor', value: fmtNum(model.futureFactor, 3) + 'x', layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', value: fmtNum(model.controlIndex, 2) + '/100', layer: 'processing' },
                    { key: 'internals.densityStress', label: 'densityStress', value: fmtNum(model.internals.densityStress, 3), layer: 'processing' },
                    { key: 'internals.yearDelta', label: 'yearDelta', value: fmtNum(model.internals.yearDelta, 0) + ' yr', layer: 'processing' },
                    { key: 'deltaT', label: 'effectiveDeltaT', value: fmtNum(model.deltaT, 2) + ' C', layer: 'processing' }
                ];
                renderStageLines('stageDerivedLines', derivedLines);

                var controlLines = [
                    { key: 'controlQuality', label: 'controlQuality', value: fmtNum(model.input.controlQuality, 0) + '%', layer: 'processing' },
                    { key: 'predictiveGain', label: 'predictiveGain', value: fmtNum(model.input.predictiveGain, 0) + '%', layer: 'processing' },
                    { key: 'monitoring', label: 'monitoring', value: fmtNum(model.input.monitoring, 0) + '%', layer: 'processing' },
                    { key: 'concurrent', label: 'concurrent', value: (model.input.concurrent ? 'true' : 'false'), layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', relation: '->', value: 'liquidCop bias', layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', relation: '->', value: 'airCopEff bias', layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', relation: '->', value: 'fan reduction', layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', relation: '->', value: 'risk reduction', layer: 'processing' }
                ];
                renderStageLines('stageControlLines', controlLines);

                var solverLines = [
                    { key: 'massFlow', label: 'massFlow', value: 'Q/(Cp*dT)', layer: 'processing' },
                    { key: 'internals.redundancyFactor', label: 'redundancyFactor', value: fmtNum(model.internals.redundancyFactor, 2), layer: 'processing' },
                    { key: 'internals.pipeFactor', label: 'pipeFactor', value: fmtNum(model.internals.pipeFactor, 2), layer: 'processing' },
                    { key: 'internals.pumpHeadEff', label: 'pumpHeadEff', value: fmtNum(model.internals.pumpHeadEff, 2) + ' m', layer: 'processing' },
                    { key: 'flowLpm', label: 'flowLpm', value: fmtNum(model.flowLpm, 1), layer: 'processing' },
                    { key: 'internals.liquidCop', label: 'liquidCop', value: fmtNum(model.internals.liquidCop, 3), layer: 'processing' },
                    { key: 'internals.airCopEff', label: 'airCopEff', value: fmtNum(model.internals.airCopEff, 3), layer: 'processing' },
                    { key: 'internals.totalCoolingKw', label: 'totalCoolingKw', value: fmtNum(model.internals.totalCoolingKw, 2), layer: 'processing' },
                    { key: 'pumpPowerKw', label: 'pumpPowerKw', value: fmtNum(model.pumpPowerKw, 2), layer: 'processing' },
                    { key: 'cduCount', label: 'cduCount', value: fmtNum(model.cduCount, 0), layer: 'processing' }
                ];
                renderStageLines('stageSolverLines', solverLines);

                var ecoLines = [
                    { key: 'internals.annualKwh', label: 'annualKwh', value: fmtNum(model.internals.annualKwh, 0), layer: 'processing' },
                    { key: 'annualGwh', label: 'annualGwh', value: fmtNum(model.annualGwh, 3), layer: 'processing' },
                    { key: 'annualEnergyCost', label: 'annualEnergyCost', value: fmtUsd(model.annualEnergyCost), layer: 'processing' },
                    { key: 'internals.annualWaterM3', label: 'annualWaterM3', value: fmtNum(model.internals.annualWaterM3, 0), layer: 'processing' },
                    { key: 'annualWaterCost', label: 'annualWaterCost', value: fmtUsd(model.annualWaterCost), layer: 'processing' },
                    { key: 'internals.heatReuseKwh', label: 'heatReuseKwh', value: fmtNum(model.internals.heatReuseKwh, 0), layer: 'processing' },
                    { key: 'heatReuseCredit', label: 'heatReuseCredit', value: fmtUsd(model.heatReuseCredit), layer: 'processing' },
                    { key: 'annualOpex', label: 'grossOpex', value: fmtUsd(model.annualOpex), layer: 'processing' },
                    { key: 'netOpex', label: 'netOpex', value: fmtUsd(model.netOpex), layer: 'processing' },
                    { key: 'netCarbonTons', label: 'netCarbonTons', value: fmtNum(model.netCarbonTons, 0), layer: 'processing' }
                ];
                renderStageLines('stageEconomicLines', ecoLines);

                var outObj = {};
                Object.keys(model).forEach(function(key) {
                    if (key !== 'input') outObj[key] = model[key];
                });
                var outFlat = {};
                flattenObject('', outObj, outFlat);
                var outKeys = Object.keys(outFlat).sort();
                setText('stageOutputCount', String(outKeys.length));
                renderStageLines('stageOutputLines', outKeys.map(function(key) {
                    return {
                        label: key,
                        key: key,
                        value: formatTraceValue(outFlat[key]),
                        layer: 'output'
                    };
                }));
            }

            function renderNodeColumn(containerId, countId, entries, layer) {
                var container = document.getElementById(containerId);
                if (!container) return;
                setText(countId, String(entries.length));
                if (!entries.length) {
                    container.innerHTML = '<div class="fullmap-node"><div class="fullmap-key">-</div></div>';
                    return;
                }
                container.innerHTML = entries.map(function(entry, idx) {
                    var key = entry.key || entry.label || '-';
                    var label = entry.label || key;
                    var value = entry.value == null ? '-' : String(entry.value);
                    var delay = Math.min(idx * 0.012, 0.36);
                    return '' +
                        '<div class="fullmap-node" style="animation-delay:' + delay.toFixed(3) + 's">' +
                            '<div class="fullmap-key">' + termTooltipSpan(label, key, layer) + '</div>' +
                            '<div class="fullmap-val">' + escapeHtml(value) + '</div>' +
                        '</div>';
                }).join('');
            }

            function renderFullParameterMap(model) {
                if (!model) return;

                var inFlat = {};
                flattenObject('', model.input, inFlat);
                var inputEntries = Object.keys(inFlat).sort().map(function(key) {
                    return { key: key, label: key, value: formatTraceValue(inFlat[key]) };
                });

                var processingEntries = [
                    { key: 'effectiveCapture', label: 'effectiveCapture', value: fmtNum(model.effectiveCapture, 2) + '%' },
                    { key: 'designDensity', label: 'designDensity', value: fmtNum(model.designDensity, 2) + ' kW/rack' },
                    { key: 'rackDensityGap', label: 'rackDensityGap', value: fmtNum(model.rackDensityGap, 2) + ' kW/rack' },
                    { key: 'futureFactor', label: 'futureFactor', value: fmtNum(model.futureFactor, 3) + 'x' },
                    { key: 'controlIndex', label: 'controlIndex', value: fmtNum(model.controlIndex, 2) + '/100' },
                    { key: 'deltaT', label: 'effectiveDeltaT', value: fmtNum(model.deltaT, 2) + ' C' },
                    { key: 'flowLpm', label: 'flowLpm', value: fmtNum(model.flowLpm, 1) + ' LPM' },
                    { key: 'pumpPowerKw', label: 'pumpPowerKw', value: fmtNum(model.pumpPowerKw, 2) + ' kW' },
                    { key: 'internals.densityStress', label: 'densityStress', value: fmtNum(model.internals.densityStress, 3) },
                    { key: 'internals.redundancyFactor', label: 'redundancyFactor', value: fmtNum(model.internals.redundancyFactor, 2) },
                    { key: 'internals.pipeFactor', label: 'pipeFactor', value: fmtNum(model.internals.pipeFactor, 2) },
                    { key: 'internals.pumpHeadEff', label: 'pumpHeadEff', value: fmtNum(model.internals.pumpHeadEff, 2) + ' m' },
                    { key: 'internals.liquidCop', label: 'liquidCop', value: fmtNum(model.internals.liquidCop, 3) },
                    { key: 'internals.airCopEff', label: 'airCopEff', value: fmtNum(model.internals.airCopEff, 3) },
                    { key: 'internals.totalCoolingKw', label: 'totalCoolingKw', value: fmtNum(model.internals.totalCoolingKw, 2) + ' kW' },
                    { key: 'internals.annualKwh', label: 'annualKwh', value: fmtNum(model.internals.annualKwh, 0) },
                    { key: 'annualEnergyCost', label: 'annualEnergyCost', value: fmtUsd(model.annualEnergyCost) },
                    { key: 'annualWaterCost', label: 'annualWaterCost', value: fmtUsd(model.annualWaterCost) },
                    { key: 'internals.heatReuseKwh', label: 'heatReuseKwh', value: fmtNum(model.internals.heatReuseKwh, 0) },
                    { key: 'scores.total', label: 'scores.total', value: fmtNum(model.scores.total, 1) + '/100' }
                ];

                var outObj = {};
                Object.keys(model).forEach(function(key) {
                    if (key !== 'input') outObj[key] = model[key];
                });
                var outFlat = {};
                flattenObject('', outObj, outFlat);
                var outputEntries = Object.keys(outFlat).sort().map(function(key) {
                    return { key: key, label: key, value: formatTraceValue(outFlat[key]) };
                });

                renderNodeColumn('mapInputNodes', 'mapInputCount', inputEntries, 'input');
                renderNodeColumn('mapProcessNodes', 'mapProcessCount', processingEntries, 'processing');
                renderNodeColumn('mapOutputNodes', 'mapOutputCount', outputEntries, 'output');
            }

            function renderLogicSequence(model) {
                if (!model) return;
                var gateEval = evaluateGateStates(model);
                var g1Open = gateEval.g1;
                var g2Open = gateEval.g2;
                var g3Open = gateEval.g3;

                setText('seqInput', shortText('IT ' + fmtNum(model.input.itLoadMw, 1) + 'MW | racks ' + fmtNum(model.input.rackCount, 0) + ' | capture target ' + fmtNum(model.input.liquidCapture, 0) + '% | climate ' + model.input.climate, 120));
                setText('seqProcessing', shortText('Thermal/hydraulic solver: dT ' + fmtNum(model.deltaT, 2) + 'C -> flow ' + fmtNum(model.flowLpm, 0) + ' LPM -> pump ' + fmtNum(model.pumpPowerKw, 1) + ' kW', 120));
                setText('seqControl', shortText('G1 sensor quality ' + (g1Open ? 'OPEN' : 'TUNE') + ' | G2 actuator limit ' + (g2Open ? 'OPEN' : 'LIMIT') + ' | G3 risk guard ' + (g3Open ? 'PASS' : 'ACTION'), 120));
                setText('seqOutput', shortText('PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2) + ' | net OPEX ' + fmtUsd(model.netOpex) + ' | carbon ' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr', 120));
                setText('seqFeedback', shortText('Gap engine evaluates target deltas and re-optimizes control/capture coefficients until constraint envelope is met.', 120));
            }

            function mutateInputForParam(input, cfg) {
                var candidate = Object.assign({}, input);
                candidate[cfg.key] = clamp(candidate[cfg.key] + cfg.step, cfg.min, cfg.max);
                if (cfg.key === 'modelYear') candidate[cfg.key] = Math.round(candidate[cfg.key]);
                if (cfg.key === 'supplyTemp') {
                    var baseDeltaT = Math.max(input.returnTemp - input.supplyTemp, 6);
                    candidate.returnTemp = candidate.supplyTemp + baseDeltaT;
                }
                return candidate;
            }

            function renderImpactMatrix(model) {
                var tbody = document.getElementById('impactRows');
                if (!tbody) return;

                var baseInput = model.input;
                var rows = IMPACT_PARAMS.map(function(cfg) {
                    var candidate = mutateInputForParam(baseInput, cfg);
                    var alt = computeModel(candidate);
                    return {
                        key: cfg.key,
                        label: cfg.label,
                        step: '+' + cfg.step + (cfg.unit ? (' ' + cfg.unit) : ''),
                        dpue: alt.pue - model.pue,
                        dcop: alt.systemCop - model.systemCop,
                        dopex: alt.netOpex - model.netOpex,
                        dcarbon: alt.netCarbonTons - model.netCarbonTons,
                        drisk: alt.riskIndex - model.riskIndex
                    };
                });

                tbody.innerHTML = rows.map(function(row) {
                    return '<tr>' +
                        '<td>' + termTooltipSpan(row.label, row.key, 'input') + '</td>' +
                        '<td>' + escapeHtml(row.step) + '</td>' +
                        '<td>' + escapeHtml(signed(row.dpue, 3, '')) + '</td>' +
                        '<td>' + escapeHtml(signed(row.dcop, 2, '')) + '</td>' +
                        '<td>' + escapeHtml(signed(row.dopex, 0, ' USD')) + '</td>' +
                        '<td>' + escapeHtml(signed(row.dcarbon, 0, ' tCO2e')) + '</td>' +
                        '<td>' + escapeHtml(signed(row.drisk, 2, '')) + '</td>' +
                    '</tr>';
                }).join('');
            }

            function percentile(sortedValues, p) {
                if (!sortedValues.length) return 0;
                var idx = (sortedValues.length - 1) * p;
                var lo = Math.floor(idx);
                var hi = Math.ceil(idx);
                if (lo === hi) return sortedValues[lo];
                var w = idx - lo;
                return sortedValues[lo] * (1 - w) + sortedValues[hi] * w;
            }

            function meanArray(values) {
                if (!values || !values.length) return 0;
                var sum = 0;
                for (var i = 0; i < values.length; i++) sum += values[i];
                return sum / values.length;
            }

            function buildHistogram(values, bins) {
                if (!values || !values.length) {
                    return { min: 0, max: 0, counts: [], maxCount: 0 };
                }
                var min = values[0];
                var max = values[values.length - 1];
                var safeMax = max === min ? (max + 1e-9) : max;
                var counts = Array.from({ length: bins }, function() { return 0; });

                values.forEach(function(v) {
                    var idx = Math.floor(((v - min) / (safeMax - min)) * bins);
                    idx = clamp(idx, 0, bins - 1);
                    counts[idx] += 1;
                });

                var maxCount = counts.reduce(function(a, b) { return Math.max(a, b); }, 0);
                return { min: min, max: max, counts: counts, maxCount: Math.max(maxCount, 1) };
            }

            function metricClassForHistogram(key) {
                if (key === 'risk') return 'err';
                if (key === 'carbon') return 'warn';
                return '';
            }

            function renderMonteCarloDistributions() {
                var wrap = document.getElementById('mcDistributionCharts');
                var meta = document.getElementById('mcDistributionMeta');
                if (!wrap || !meta) return;

                if (!latestMonteCarlo || !latestMonteCarlo.dist) {
                    meta.className = 'status-pill';
                    meta.textContent = 'No Distribution Yet';
                    wrap.innerHTML = '<div class="hist-placeholder">Run Monte Carlo to render distribution histograms.</div>';
                    return;
                }

                var dist = latestMonteCarlo.dist;
                var specs = [
                    { key: 'pue', label: 'PUE', digits: 3, suffix: '' },
                    { key: 'cop', label: 'COP', digits: 2, suffix: '' },
                    { key: 'opex', label: 'Net OPEX', digits: 0, suffix: ' USD/yr' },
                    { key: 'carbon', label: 'Carbon', digits: 0, suffix: ' tCO2e/yr' },
                    { key: 'risk', label: 'Risk Index', digits: 1, suffix: '' }
                ];

                wrap.innerHTML = specs.map(function(spec) {
                    var arr = dist[spec.key] || [];
                    if (!arr.length) {
                        return '<div class="hist-card"><div class="hist-placeholder">No values for ' + escapeHtml(spec.label) + '.</div></div>';
                    }
                    var hist = buildHistogram(arr, 14);
                    var p10 = percentile(arr, 0.10);
                    var p50 = percentile(arr, 0.50);
                    var p90 = percentile(arr, 0.90);
                    var avg = meanArray(arr);
                    var barClass = metricClassForHistogram(spec.key);
                    var bars = hist.counts.map(function(c, idx) {
                        var h = Math.max(2, (c / hist.maxCount) * 100);
                        var from = hist.min + ((hist.max - hist.min) * (idx / hist.counts.length));
                        var to = hist.min + ((hist.max - hist.min) * ((idx + 1) / hist.counts.length));
                        var title = spec.label + ' bin ' + fmtNum(from, spec.digits) + ' to ' + fmtNum(to, spec.digits) + ' | n=' + c;
                        return '<div class="hist-bar ' + barClass + '" style="height:' + fmtNum(h, 1) + '%" title="' + escapeAttr(title) + '"></div>';
                    }).join('');

                    return '<div class="hist-card">' +
                        '<div class="hist-head">' +
                            '<span class="hist-title">' + escapeHtml(spec.label) + '</span>' +
                            '<span class="hist-range">' + fmtNum(hist.min, spec.digits) + ' - ' + fmtNum(hist.max, spec.digits) + '</span>' +
                        '</div>' +
                        '<div class="hist-bars">' + bars + '</div>' +
                        '<div class="hist-footer">' +
                            'P10 ' + fmtNum(p10, spec.digits) + ' | P50 ' + fmtNum(p50, spec.digits) + ' | P90 ' + fmtNum(p90, spec.digits) + '<br>' +
                            'mean ' + fmtNum(avg, spec.digits) + spec.suffix +
                        '</div>' +
                    '</div>';
                }).join('');

                meta.className = 'status-pill ok';
                meta.textContent = 'n=' + latestMonteCarlo.samples + ' | \u00b1' + fmtNum(latestMonteCarlo.unc * 100, 0) + '% input band';
            }

            function riskColor(risk) {
                if (risk <= 25) return '#047857';
                if (risk <= 40) return '#b45309';
                return '#b91c1c';
            }

            function syncParetoRowSelection() {
                var rows = document.querySelectorAll('#paretoRows tr[data-pareto-idx]');
                rows.forEach(function(row) {
                    var idx = parseInt(row.getAttribute('data-pareto-idx'), 10);
                    row.classList.toggle('selected', idx === selectedParetoIdx);
                });
            }

            function renderParetoScatter() {
                var svg = document.getElementById('paretoScatterSvg');
                var meta = document.getElementById('paretoScatterMeta');
                if (!svg || !meta) return;

                if (!latestPareto.length) {
                    svg.innerHTML = '<text x="18" y="26" fill="currentColor" opacity="0.7" font-size="12">Generate Pareto frontier to render scatter chart.</text>';
                    meta.className = 'status-pill';
                    meta.textContent = 'No Pareto Points';
                    syncParetoRowSelection();
                    renderParetoInsight();
                    return;
                }

                var vb = (svg.viewBox && svg.viewBox.baseVal) ? svg.viewBox.baseVal : null;
                var w = (vb && vb.width) ? vb.width : 560;
                var h = (vb && vb.height) ? vb.height : 260;
                var pad = { l: 84, r: 16, t: 34, b: 42 };
                var pw = w - pad.l - pad.r;
                var ph = h - pad.t - pad.b;
                var isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
                var chartText = isDarkTheme ? '#e2e8f0' : '#334155';
                var chartTextSoft = isDarkTheme ? '#cbd5e1' : '#475569';
                var chartTextFaint = isDarkTheme ? '#94a3b8' : '#64748b';
                var legendFill = isDarkTheme ? 'rgba(15,23,42,0.9)' : 'rgba(255,255,255,0.9)';
                var legendStroke = isDarkTheme ? 'rgba(148,163,184,0.45)' : 'rgba(148,163,184,0.4)';

                var pueVals = latestPareto.map(function(m) { return m.pue; });
                var opexVals = latestPareto.map(function(m) { return m.netOpex; });
                var carbonVals = latestPareto.map(function(m) { return m.netCarbonTons; });
                var sortedByPue = latestPareto.map(function(m, idx) { return { m: m, idx: idx }; }).sort(function(a, b) { return a.m.pue - b.m.pue; });

                var minPue = Math.min.apply(null, pueVals);
                var maxPue = Math.max.apply(null, pueVals);
                var minOpex = Math.min.apply(null, opexVals);
                var maxOpex = Math.max.apply(null, opexVals);
                if (maxPue === minPue) maxPue = minPue + 0.001;
                if (maxOpex === minOpex) maxOpex = minOpex + 1;
                var puePad = (maxPue - minPue) * 0.08;
                var opexPad = (maxOpex - minOpex) * 0.08;
                minPue -= puePad;
                maxPue += puePad;
                minOpex = Math.max(0, minOpex - opexPad);
                maxOpex += opexPad;

                function sx(v) { return pad.l + ((v - minPue) / (maxPue - minPue)) * pw; }
                function sy(v) { return pad.t + ((v - minOpex) / (maxOpex - minOpex)) * ph; }

                var minCarbon = Math.min.apply(null, carbonVals);
                var maxCarbon = Math.max.apply(null, carbonVals);
                if (maxCarbon === minCarbon) maxCarbon = minCarbon + 1;

                var grid = [];
                for (var i = 0; i <= 5; i++) {
                    var gx = pad.l + (pw * i / 5);
                    var gy = pad.t + (ph * i / 5);
                    var pueTick = minPue + (maxPue - minPue) * (i / 5);
                    var opexTick = minOpex + (maxOpex - minOpex) * (i / 5);
                    grid.push('<line x1="' + fmtNum(gx, 2) + '" y1="' + pad.t + '" x2="' + fmtNum(gx, 2) + '" y2="' + (pad.t + ph) + '" stroke="rgba(148,163,184,0.18)" stroke-width="1"/>');
                    grid.push('<line x1="' + pad.l + '" y1="' + fmtNum(gy, 2) + '" x2="' + (pad.l + pw) + '" y2="' + fmtNum(gy, 2) + '" stroke="rgba(148,163,184,0.18)" stroke-width="1"/>');
                    grid.push('<text x="' + fmtNum(gx, 2) + '" y="' + fmtNum(pad.t + ph + 16, 2) + '" fill="' + chartTextSoft + '" font-size="10" text-anchor="middle">' + fmtNum(pueTick, 3) + '</text>');
                    grid.push('<text x="8" y="' + fmtNum(gy + 3, 2) + '" fill="' + chartTextSoft + '" font-size="10">' + fmtUsdCompact(opexTick) + '</text>');
                }

                var frontierPath = '';
                sortedByPue.forEach(function(item, idx) {
                    var x = sx(item.m.pue);
                    var y = sy(item.m.netOpex);
                    frontierPath += (idx === 0 ? 'M ' : ' L ') + fmtNum(x, 2) + ' ' + fmtNum(y, 2);
                });

                var points = latestPareto.map(function(m, idx) {
                    var x = sx(m.pue);
                    var y = sy(m.netOpex);
                    var r = 4 + (((m.netCarbonTons - minCarbon) / (maxCarbon - minCarbon)) * 3.5);
                    var stroke = m._feasible ? '#065f46' : '#9a3412';
                    var strokeDash = m._feasible ? '' : ' stroke-dasharray="3 2"';
                    var selected = idx === selectedParetoIdx;
                    var outer = selected ? '<circle cx="' + fmtNum(x, 2) + '" cy="' + fmtNum(y, 2) + '" r="' + fmtNum(r + 4, 2) + '" fill="none" stroke="#2563eb" stroke-width="1.6" stroke-dasharray="2 2"></circle>' : '';
                    var title = 'P' + (idx + 1) + ' | PUE ' + fmtNum(m.pue, 3) + ' | COP ' + fmtNum(m.systemCop, 2) + ' | OPEX ' + fmtUsd(m.netOpex) + ' | Carbon ' + fmtNum(m.netCarbonTons, 0) + ' | Risk ' + fmtNum(m.riskIndex, 1);
                    return '' +
                        outer +
                        '<circle cx="' + fmtNum(x, 2) + '" cy="' + fmtNum(y, 2) + '" r="' + fmtNum(r, 2) + '" fill="' + riskColor(m.riskIndex) + '" fill-opacity="0.88" stroke="' + stroke + '" stroke-width="1.35"' + strokeDash + ' data-pidx="' + idx + '">' +
                            '<title>' + escapeHtml(title) + '</title>' +
                        '</circle>' +
                        '<text x="' + fmtNum(x + r + 2, 2) + '" y="' + fmtNum(y - 2, 2) + '" font-size="9" fill="' + chartText + '" opacity="0.9">P' + (idx + 1) + '</text>';
                }).join('');

                var selectedGuides = '';
                if (selectedParetoIdx >= 0 && latestPareto[selectedParetoIdx]) {
                    var sm = latestPareto[selectedParetoIdx];
                    var gxSel = sx(sm.pue);
                    var gySel = sy(sm.netOpex);
                    selectedGuides = '' +
                        '<line x1="' + fmtNum(gxSel, 2) + '" y1="' + pad.t + '" x2="' + fmtNum(gxSel, 2) + '" y2="' + (pad.t + ph) + '" stroke="rgba(37,99,235,0.42)" stroke-width="1" stroke-dasharray="2 3"></line>' +
                        '<line x1="' + pad.l + '" y1="' + fmtNum(gySel, 2) + '" x2="' + (pad.l + pw) + '" y2="' + fmtNum(gySel, 2) + '" stroke="rgba(37,99,235,0.42)" stroke-width="1" stroke-dasharray="2 3"></line>';
                }

                svg.innerHTML = [
                    '<defs><linearGradient id="paretoBg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="rgba(59,130,246,0.06)"/><stop offset="100%" stop-color="rgba(16,185,129,0.04)"/></linearGradient></defs>',
                    '<rect x="' + pad.l + '" y="' + pad.t + '" width="' + pw + '" height="' + ph + '" fill="url(#paretoBg)" stroke="rgba(148,163,184,0.34)" rx="8" />',
                    grid.join(''),
                    frontierPath ? '<path d="' + frontierPath + '" fill="none" stroke="rgba(30,64,175,0.5)" stroke-width="1.6" stroke-dasharray="4 3"></path>' : '',
                    selectedGuides,
                    points,
                    '<text x="' + (pad.l + (pw / 2)) + '" y="' + (h - 8) + '" fill="' + chartText + '" font-size="11" text-anchor="middle">X-Axis: PUE (lower is better)</text>',
                    '<text x="14" y="' + (pad.t - 14) + '" fill="' + chartTextSoft + '" font-size="11">Net OPEX (lower is better)</text>',
                    '<rect x="' + (w - 214) + '" y="12" width="196" height="70" rx="8" fill="' + legendFill + '" stroke="' + legendStroke + '"></rect>',
                    '<text x="' + (w - 204) + '" y="28" fill="' + chartText + '" font-size="10">Legend</text>',
                    '<circle cx="' + (w - 198) + '" cy="42" r="4.5" fill="#047857"></circle><text x="' + (w - 188) + '" y="45" fill="' + chartText + '" font-size="10">Risk low</text>',
                    '<circle cx="' + (w - 132) + '" cy="42" r="4.5" fill="#b45309"></circle><text x="' + (w - 122) + '" y="45" fill="' + chartText + '" font-size="10">Risk medium</text>',
                    '<circle cx="' + (w - 52) + '" cy="42" r="4.5" fill="#b91c1c"></circle><text x="' + (w - 42) + '" y="45" fill="' + chartText + '" font-size="10">Risk high</text>',
                    '<circle cx="' + (w - 198) + '" cy="60" r="4.5" fill="#64748b" stroke="#9a3412" stroke-width="1.2" stroke-dasharray="3 2"></circle>',
                    '<text x="' + (w - 188) + '" y="63" fill="' + chartText + '" font-size="10">Soft constraint point</text>',
                    '<text x="' + (w - 198) + '" y="76" fill="' + chartTextFaint + '" font-size="9">Circle size = carbon burden</text>'
                ].join('');

                var feasibleCount = latestPareto.filter(function(m) { return m._feasible; }).length;
                meta.className = 'status-pill ok';
                meta.textContent = 'points=' + latestPareto.length + ' | feasible=' + feasibleCount + ' | click point/row to select';
                syncParetoRowSelection();
                renderParetoInsight();
            }

            function sankeyBandPath(x0, y0, x1, y1, width) {
                var w = Math.max(width, 1);
                var c = (x1 - x0) * 0.46;
                var y0t = y0 - (w / 2);
                var y0b = y0 + (w / 2);
                var y1t = y1 - (w / 2);
                var y1b = y1 + (w / 2);
                return [
                    'M', fmtNum(x0, 2), fmtNum(y0t, 2),
                    'C', fmtNum(x0 + c, 2), fmtNum(y0t, 2), fmtNum(x1 - c, 2), fmtNum(y1t, 2), fmtNum(x1, 2), fmtNum(y1t, 2),
                    'L', fmtNum(x1, 2), fmtNum(y1b, 2),
                    'C', fmtNum(x1 - c, 2), fmtNum(y1b, 2), fmtNum(x0 + c, 2), fmtNum(y0b, 2), fmtNum(x0, 2), fmtNum(y0b, 2),
                    'Z'
                ].join(' ');
            }

            function renderEnergySankey(model) {
                var svg = document.getElementById('energySankeySvg');
                var status = document.getElementById('sankeyStatus');
                var summary = document.getElementById('sankeySummary');
                if (!svg || !status || !summary) return;

                var ctx = resolveSankeyContext(model);
                var viewMode = ctx.viewMode;
                var activeModel = ctx.activeModel;
                var baseModel = ctx.baseModel;
                var optModel = ctx.optModel;

                if (!activeModel && !ctx.compare) {
                    svg.innerHTML = '<text x="18" y="28" fill="currentColor" opacity="0.7" font-size="12">Run model to render Sankey distribution.</text>';
                    status.className = 'status-pill';
                    status.textContent = 'Waiting Model State';
                    summary.textContent = 'Sankey summary will appear after model execution.';
                    return;
                }

                if (ctx.compare) {
                    var b = extractSankeyFlows(baseModel);
                    var o = extractSankeyFlows(optModel);
                    var maxTotal = Math.max(b.total, o.total, 1);
                    function laneSvg(label, y, flows, colorA) {
                        var barX = 138;
                        var barW = 250;
                        var subX = 500;
                        var subW = 250;
                        var partA = [
                            { key: 'it', color: '#2563eb', label: 'IT' },
                            { key: 'thermal', color: '#0891b2', label: 'Thermal' },
                            { key: 'elecLoss', color: '#d97706', label: 'Elec Loss' },
                            { key: 'facilityAux', color: '#64748b', label: 'Aux' }
                        ];
                        var partB = [
                            { key: 'liquidCore', color: '#0d9488', label: 'Liquid' },
                            { key: 'pump', color: '#7c3aed', label: 'Pump' },
                            { key: 'air', color: '#0284c7', label: 'Air' },
                            { key: 'fan', color: '#16a34a', label: 'Fan' }
                        ];
                        var html = [];
                        html.push('<text x="26" y="' + (y + 5) + '" fill="currentColor" font-size="11">' + escapeHtml(label) + '</text>');
                        html.push('<text x="26" y="' + (y + 20) + '" fill="currentColor" opacity="0.72" font-size="10">' + fmtNum(flows.total / 1000, 2) + ' MW total</text>');
                        html.push('<rect x="' + barX + '" y="' + (y - 10) + '" width="' + barW + '" height="16" rx="5" fill="rgba(148,163,184,0.12)" stroke="rgba(148,163,184,0.32)"/>');
                        html.push('<rect x="' + subX + '" y="' + (y - 10) + '" width="' + subW + '" height="16" rx="5" fill="rgba(148,163,184,0.12)" stroke="rgba(148,163,184,0.32)"/>');
                        var x = barX;
                        partA.forEach(function(p) {
                            var sw = Math.max(2, (flows[p.key] / maxTotal) * barW);
                            html.push('<rect x="' + fmtNum(x, 2) + '" y="' + (y - 10) + '" width="' + fmtNum(sw, 2) + '" height="16" fill="' + p.color + '"/>');
                            x += sw;
                        });
                        var sx = subX;
                        partB.forEach(function(p) {
                            var sw = Math.max(2, (flows[p.key] / maxTotal) * subW);
                            html.push('<rect x="' + fmtNum(sx, 2) + '" y="' + (y - 10) + '" width="' + fmtNum(sw, 2) + '" height="16" fill="' + p.color + '"/>');
                            sx += sw;
                        });
                        html.push('<text x="' + barX + '" y="' + (y + 22) + '" fill="currentColor" opacity="0.74" font-size="9">Primary mix: IT ' + sankeyPct(flows.it, flows.total) + ', Thermal ' + sankeyPct(flows.thermal, flows.total) + ', Loss ' + sankeyPct(flows.elecLoss, flows.total) + ', Aux ' + sankeyPct(flows.facilityAux, flows.total) + '</text>');
                        html.push('<text x="' + subX + '" y="' + (y + 22) + '" fill="currentColor" opacity="0.74" font-size="9">Thermal split: LQ ' + sankeyPct(flows.liquidCore, flows.total) + ', Pump ' + sankeyPct(flows.pump, flows.total) + ', Air ' + sankeyPct(flows.air, flows.total) + ', Fan ' + sankeyPct(flows.fan, flows.total) + '</text>');
                        return html.join('');
                    }

                    var nonItDelta = (o.total - o.it) - (b.total - b.it);
                    svg.innerHTML = [
                        '<rect x="0" y="0" width="860" height="360" fill="transparent"/>',
                        '<text x="24" y="30" fill="currentColor" opacity="0.86" font-size="12">COMPARE DELTA VIEW (Baseline vs Optimized)</text>',
                        laneSvg('Baseline', 96, b, '#1d4ed8'),
                        laneSvg('Optimized', 206, o, '#0f766e'),
                        '<line x1="24" y1="150" x2="836" y2="150" stroke="rgba(148,163,184,0.28)" stroke-dasharray="3 3"/>',
                        '<text x="24" y="326" fill="currentColor" opacity="0.78" font-size="10">Delta non-IT overhead: ' + signed(nonItDelta, 0, ' kW') + ' | Delta PUE ' + signed(optModel.pue - baseModel.pue, 3, '') + ' | Delta COP ' + signed(optModel.systemCop - baseModel.systemCop, 2, '') + '</text>'
                    ].join('');

                    status.className = 'status-pill ok';
                    status.textContent = 'Sankey Compare | baseline vs optimized';
                    summary.textContent = [
                        'Baseline total: ' + fmtNum(b.total, 0) + ' kW | Optimized total: ' + fmtNum(o.total, 0) + ' kW',
                        'Non-IT overhead baseline: ' + fmtNum(b.total - b.it, 0) + ' kW | optimized: ' + fmtNum(o.total - o.it, 0) + ' kW | delta ' + signed(nonItDelta, 0, ' kW'),
                        'This compare view prioritizes distribution readability and delta visibility for non-IT components.',
                        'Detailed drill-down modal is available in baseline/optimized/auto mode.'
                    ].join('\n');
                    return;
                }

                var flows = extractSankeyFlows(activeModel);
                var total = flows ? flows.total : 0;

                if (total <= 0.1) {
                    svg.innerHTML = '<text x="18" y="28" fill="currentColor" opacity="0.7" font-size="12">Invalid model output for Sankey rendering.</text>';
                    status.className = 'status-pill warn';
                    status.textContent = 'Sankey Render Failed';
                    summary.textContent = 'Total facility load is too small for Sankey flow normalization.';
                    return;
                }

                var scale = 176 / total;
                var nodeW = 20;
                var srcX = 52;
                var midX = 332;
                var rightX = 610;
                var topY = 62;
                var source = { id: 'source', label: 'Total Facility Input', value: total, x: srcX, y: topY, h: 232, color: '#1d4ed8' };
                var midNodes = [
                    { id: 'compute', label: 'IT Compute', value: flows.it, x: midX, y: 84, h: 42, color: '#2563eb' },
                    { id: 'thermal', label: 'Thermal Management', value: flows.thermal, x: midX, y: 156, h: 44, color: '#0891b2' },
                    { id: 'elec', label: 'Electrical Loss', value: flows.elecLoss, x: midX, y: 232, h: 30, color: '#d97706' },
                    { id: 'aux', label: 'Facility Aux', value: flows.facilityAux, x: midX, y: 278, h: 24, color: '#64748b' }
                ];
                var thermalNode = midNodes[1];
                var rightNodes = [
                    { id: 'liq', label: 'Liquid Loop', value: flows.liquidCore, x: rightX, y: 150, h: 30, color: '#0d9488' },
                    { id: 'pump', label: 'Pump Drive', value: flows.pump, x: rightX, y: 198, h: 20, color: '#7c3aed' },
                    { id: 'air', label: 'Air Path', value: flows.air, x: rightX, y: 234, h: 20, color: '#0284c7' },
                    { id: 'fan', label: 'Fan Power', value: flows.fan, x: rightX, y: 270, h: 20, color: '#16a34a' }
                ];

                var links = [];
                function linkWidth(v) {
                    return clamp(v * scale, 3, 146);
                }
                var srcOffset = 0;
                midNodes.forEach(function(t) {
                    var h = linkWidth(t.value);
                    links.push({
                        x0: source.x + nodeW,
                        y0: source.y + 10 + srcOffset + (h / 2),
                        x1: t.x,
                        y1: t.y + (h / 2),
                        w: h,
                        color: t.color,
                        value: t.value
                    });
                    srcOffset += h + 1.5;
                });

                var thermOffset = 0;
                rightNodes.forEach(function(t) {
                    var h = linkWidth(t.value);
                    links.push({
                        x0: thermalNode.x + nodeW,
                        y0: thermalNode.y + 6 + thermOffset + (h / 2),
                        x1: t.x,
                        y1: t.y + (h / 2),
                        w: h,
                        color: t.color,
                        value: t.value
                    });
                    thermOffset += h + 1.2;
                });

                function nodeSvg(n) {
                    return '<g class="sankey-node" data-sankey-node="' + escapeAttr(n.id) + '" tabindex="0" role="button" aria-label="Open detailed Sankey for ' + escapeAttr(n.label) + '">' +
                        '<rect x="' + n.x + '" y="' + fmtNum(n.y, 2) + '" width="' + nodeW + '" height="' + fmtNum(n.h, 2) + '" rx="5" fill="' + n.color + '" fill-opacity="0.9" stroke="rgba(15,23,42,0.35)" />' +
                        '<text x="' + (n.x + nodeW + 8) + '" y="' + fmtNum(n.y + 12, 2) + '" fill="currentColor" font-size="11">' + escapeHtml(n.label) + '</text>' +
                        '<text x="' + (n.x + nodeW + 8) + '" y="' + fmtNum(n.y + 24, 2) + '" fill="currentColor" opacity="0.78" font-size="10">' + fmtNum(n.value, 0) + ' kW | ' + sankeyPct(n.value, total) + '</text>' +
                    '</g>';
                }

                var linksSvg = links.map(function(l) {
                    var title = fmtNum(l.value, 0) + ' kW';
                    return '<path d="' + sankeyBandPath(l.x0, l.y0, l.x1, l.y1, l.w) + '" fill="' + l.color + '" fill-opacity="0.46" stroke="' + l.color + '" stroke-opacity="0.62" stroke-width="0.7"><title>' + escapeHtml(title) + '</title></path>';
                }).join('');

                svg.innerHTML = [
                    '<rect x="0" y="0" width="860" height="360" fill="transparent"/>',
                    '<text x="52" y="30" fill="currentColor" opacity="0.84" font-size="12">SOURCE</text>',
                    '<text x="332" y="30" fill="currentColor" opacity="0.84" font-size="12">PRIMARY DISTRIBUTION</text>',
                    '<text x="610" y="30" fill="currentColor" opacity="0.84" font-size="12">THERMAL BREAKDOWN</text>',
                    linksSvg,
                    nodeSvg(source),
                    midNodes.map(nodeSvg).join(''),
                    rightNodes.map(nodeSvg).join(''),
                    '<rect x="606" y="86" width="230" height="218" fill="none" stroke="rgba(148,163,184,0.16)" stroke-dasharray="2 3" rx="8"/>',
                    '<text x="52" y="346" fill="currentColor" opacity="0.74" font-size="10">Flow width is proportional to power contribution. Labels are fixed-position to keep small branches readable.</text>'
                ].join('');
                bindSankeyNodeDrill(svg);

                var nonIt = flows.total - flows.it;
                var modeLabel = sankeyModeLabel(ctx);
                status.className = 'status-pill ok';
                status.textContent = 'Sankey Live | ' + modeLabel + ' | total ' + fmtNum(total / 1000, 2) + ' MW';
                summary.textContent = [
                    'Total facility power: ' + fmtNum(total, 0) + ' kW (' + fmtNum(total / 1000, 2) + ' MW)',
                    'Non-IT overhead total: ' + fmtNum(nonIt, 0) + ' kW (' + sankeyPct(nonIt, total) + ') | IT compute: ' + fmtNum(flows.it, 0) + ' kW (' + sankeyPct(flows.it, total) + ')',
                    'Thermal split: liquid loop ' + sankeyPct(flows.liquidCore, total) + ', pump drive ' + sankeyPct(flows.pump, total) + ', air path ' + sankeyPct(flows.air, total) + ', fan power ' + sankeyPct(flows.fan, total) + '.',
                    'Click any Sankey node to open detailed drill-down distribution modal.'
                ].join('\n');
            }

            function runMonteCarlo() {
                if (!enforceActionGuard('Monte Carlo')) return;
                var samples = Math.max(200, Math.round(n('mcSamples')));
                var unc = clamp(n('mcUncertainty'), 1, 30) / 100;
                var base = gatherInputs();
                var keys = ['itLoadMw', 'liquidCapture', 'supplyTemp', 'airCop', 'pumpEff', 'economizerHours', 'controlQuality', 'predictiveGain', 'coefHeatTransfer', 'coefPipeLoss', 'elecPrice', 'carbonIntensity'];
                var dist = { pue: [], cop: [], opex: [], carbon: [], risk: [] };

                for (var i = 0; i < samples; i++) {
                    var c = Object.assign({}, base);
                    keys.forEach(function(k) {
                        var v = c[k];
                        if (typeof v !== 'number') return;
                        var delta = (Math.random() * 2 - 1) * unc;
                        c[k] = v * (1 + delta);
                    });
                    c.returnTemp = clamp(c.supplyTemp + Math.max(base.returnTemp - base.supplyTemp, 6), c.supplyTemp + 5, c.supplyTemp + 18);
                    var m = computeModel(c);
                    dist.pue.push(m.pue);
                    dist.cop.push(m.systemCop);
                    dist.opex.push(m.netOpex);
                    dist.carbon.push(m.netCarbonTons);
                    dist.risk.push(m.riskIndex);
                }

                Object.keys(dist).forEach(function(k) { dist[k].sort(function(a, b) { return a - b; }); });

                var rows = [
                    ['PUE', percentile(dist.pue, 0.10), percentile(dist.pue, 0.50), percentile(dist.pue, 0.90), 3, ''],
                    ['COP', percentile(dist.cop, 0.10), percentile(dist.cop, 0.50), percentile(dist.cop, 0.90), 2, ''],
                    ['Net OPEX (USD/yr)', percentile(dist.opex, 0.10), percentile(dist.opex, 0.50), percentile(dist.opex, 0.90), 0, ' USD'],
                    ['Carbon (tCO2e/yr)', percentile(dist.carbon, 0.10), percentile(dist.carbon, 0.50), percentile(dist.carbon, 0.90), 0, ''],
                    ['Risk Index', percentile(dist.risk, 0.10), percentile(dist.risk, 0.50), percentile(dist.risk, 0.90), 1, '']
                ];

                var tbody = document.getElementById('mcRows');
                if (tbody) {
                    tbody.innerHTML = rows.map(function(r) {
                        return '<tr><td>' + r[0] + '</td><td>' + fmtNum(r[1], r[4]) + r[5] + '</td><td>' + fmtNum(r[2], r[4]) + r[5] + '</td><td>' + fmtNum(r[3], r[4]) + r[5] + '</td></tr>';
                    }).join('');
                }
                var stat = document.getElementById('mcStatus');
                if (stat) {
                    stat.className = 'status-pill ok';
                    stat.textContent = 'MC Complete | n=' + samples + ' | uncertainty ' + fmtNum(unc * 100, 0) + '%';
                }
                latestMonteCarlo = { samples: samples, unc: unc, dist: dist };
                renderMonteCarloDistributions();
            }

            function buildFixtureInput(overrides) {
                var base = {
                    itLoadMw: DEFAULTS.inItLoad,
                    rackCount: DEFAULTS.inRackCount,
                    rackType: DEFAULTS.inRackType,
                    rackDensityTarget: DEFAULTS.inRackDensityTarget,
                    highDensityShare: DEFAULTS.inHighDensityShare,
                    modelYear: DEFAULTS.inModelYear,
                    architectureMode: DEFAULTS.inCoolingArchitecture,
                    liquidCapture: DEFAULTS.inLiquidCapture,
                    coolantKey: DEFAULTS.inCoolant,
                    supplyTemp: DEFAULTS.inSupplyTemp,
                    returnTemp: DEFAULTS.inReturnTemp,
                    pumpHead: DEFAULTS.inPumpHead,
                    pumpEff: DEFAULTS.inPumpEff,
                    hydraulicMargin: DEFAULTS.inHydraulicMargin,
                    controlQuality: DEFAULTS.inControlQuality,
                    predictiveGain: DEFAULTS.inPredictiveGain,
                    coefHeatTransfer: DEFAULTS.inCoefHeatTransfer,
                    coefCduLoss: DEFAULTS.inCoefCduLoss,
                    coefPipeLoss: DEFAULTS.inCoefPipeLoss,
                    coefFutureTech: DEFAULTS.inCoefFutureTech,
                    cduUnit: DEFAULTS.inCduUnit,
                    redundancy: DEFAULTS.inRedundancy,
                    climate: DEFAULTS.inClimate,
                    countryKey: DEFAULTS.inCountryProfile,
                    airCop: DEFAULTS.inAirCop,
                    economizerHours: DEFAULTS.inEconomizerHours,
                    fanPower: DEFAULTS.inFanPower,
                    upsEff: DEFAULTS.inUpsEff,
                    distLoss: DEFAULTS.inDistLoss,
                    heatReuse: DEFAULTS.inHeatReuse,
                    elecPrice: DEFAULTS.inElecPrice,
                    waterTariff: DEFAULTS.inWaterTariff,
                    carbonIntensity: DEFAULTS.inCarbonIntensity,
                    monitoring: DEFAULTS.inMonitoring,
                    fireType: DEFAULTS.inFireType,
                    targetPue: DEFAULTS.inTargetPue,
                    targetCop: DEFAULTS.inTargetCop,
                    failureMode: DEFAULTS.inFailureMode,
                    concurrent: DEFAULTS.inConcurrent
                };
                return Object.assign(base, overrides || {});
            }

            function runModelSelfTest() {
                var statusEl = document.getElementById('selfTestStatus');
                var summaryEl = document.getElementById('selfTestSummary');
                var rowsEl = document.getElementById('selfTestRows');
                if (!statusEl || !summaryEl || !rowsEl) return;

                var rows = [];
                function pushResult(name, pass, check, detail) {
                    rows.push({
                        name: name,
                        pass: !!pass,
                        check: check,
                        detail: detail
                    });
                }

                var fixtureConstraints = {
                    pueMax: DEFAULTS.conPueMax,
                    copMin: DEFAULTS.conCopMin,
                    riskMax: DEFAULTS.conRiskMax,
                    pumpPctMax: DEFAULTS.conPumpPctMax,
                    enforce: DEFAULTS.conEnforce === 'yes'
                };

                var baseInput = buildFixtureInput();
                var base = computeModel(baseInput);
                pushResult(
                    'Baseline KPI Envelope',
                    isFinite(base.pue) && isFinite(base.systemCop) && base.pue >= 1.05 && base.pue <= 1.6 && base.systemCop >= 3 && base.systemCop <= 19,
                    'PUE + COP finite and within expected baseline range',
                    'PUE ' + fmtNum(base.pue, 3) + ' | COP ' + fmtNum(base.systemCop, 2)
                );

                var pumpDegraded = computeModel(buildFixtureInput({ failureMode: 'pump_degraded' }));
                pushResult(
                    'Pump Degraded Response',
                    pumpDegraded.pumpPowerKw > (base.pumpPowerKw * 1.12) && pumpDegraded.riskIndex > base.riskIndex,
                    'Pump degraded mode increases pump power and risk',
                    'pump ' + fmtNum(base.pumpPowerKw, 1) + ' -> ' + fmtNum(pumpDegraded.pumpPowerKw, 1) + ' kW | risk ' + fmtNum(base.riskIndex, 1) + ' -> ' + fmtNum(pumpDegraded.riskIndex, 1)
                );

                var heatReuseBoost = computeModel(buildFixtureInput({ heatReuse: Math.min(baseInput.heatReuse + 22, 80) }));
                pushResult(
                    'Heat Reuse Economics',
                    heatReuseBoost.netOpex < base.netOpex,
                    'Higher heat reuse lowers net OPEX',
                    'net OPEX ' + fmtUsd(base.netOpex) + ' -> ' + fmtUsd(heatReuseBoost.netOpex)
                );

                var carbonHigh = computeModel(buildFixtureInput({ carbonIntensity: baseInput.carbonIntensity + 0.2 }));
                pushResult(
                    'Carbon Intensity Propagation',
                    carbonHigh.netCarbonTons > base.netCarbonTons,
                    'Higher grid carbon increases annual carbon KPI',
                    'carbon ' + fmtNum(base.netCarbonTons, 0) + ' -> ' + fmtNum(carbonHigh.netCarbonTons, 0) + ' tCO2e/yr'
                );

                var captureBoost = computeModel(buildFixtureInput({ liquidCapture: Math.min(baseInput.liquidCapture + 8, 98) }));
                pushResult(
                    'Capture Shift Consistency',
                    captureBoost.airKw < base.airKw && captureBoost.pue <= base.pue + 0.04,
                    'Higher liquid capture reduces air thermal load without large PUE penalty',
                    'air ' + fmtNum(base.airKw, 0) + ' -> ' + fmtNum(captureBoost.airKw, 0) + ' kW | PUE delta ' + signed(captureBoost.pue - base.pue, 3, '')
                );

                var blockedInput = buildFixtureInput({
                    returnTemp: baseInput.supplyTemp + 1.2,
                    predictiveGain: 48,
                    monitoring: 25
                });
                var blockedModel = computeModel(blockedInput);
                var blockedEval = evaluateInputHardRules(blockedInput, blockedModel, fixtureConstraints);
                pushResult(
                    'Hard-Rule Blocking',
                    blockedEval.blocked && blockedEval.hardStops.length >= 2,
                    'Known bad fixture is blocked by hard-rule engine',
                    blockedEval.hardStops.join(' | ')
                );

                var hardEval = evaluateHardConstraints(base, fixtureConstraints);
                pushResult(
                    'Default Constraint Feasibility',
                    hardEval.feasible,
                    'Default baseline should pass default hard constraints',
                    hardEval.feasible ? ('pump%IT=' + fmtNum(hardEval.pumpPctIt, 2) + '%') : hardEval.issues.join(', ')
                );

                var criticalTextIds = [
                    'diagInputMain', 'diagInputSub', 'diagThermalMain', 'diagThermalSub',
                    'diagHydraulicMain', 'diagHydraulicSub', 'diagImpactMain', 'diagImpactSub',
                    'diagCostMain', 'diagCostSub', 'diagControlMain', 'diagControlSub',
                    'diagComplianceMain', 'diagComplianceSub', 'ctrlGateASub', 'ctrlGateBSub', 'ctrlGateCSub'
                ];
                var trunc = [];
                criticalTextIds.forEach(function(id) {
                    var el = document.getElementById(id);
                    if (!el) return;
                    var txt = String(el.textContent || '').trim();
                    if (!txt) return;
                    if (txt.indexOf('') >= 0 || txt.indexOf('...') >= 0) trunc.push(id);
                });
                pushResult(
                    'Diagram Text Truncation Guard',
                    trunc.length === 0,
                    'Critical diagram labels should not end in ellipsis',
                    trunc.length ? ('truncated ids: ' + trunc.join(', ')) : 'no ellipsis truncation detected'
                );

                var passCount = rows.filter(function(r) { return r.pass; }).length;
                var allPass = passCount === rows.length;
                statusEl.className = allPass ? 'status-pill ok' : 'status-pill warn';
                statusEl.textContent = allPass ? ('PASS ' + passCount + '/' + rows.length) : ('CHECK ' + passCount + '/' + rows.length);

                summaryEl.textContent = [
                    'Self-test executed at ' + nowIso(),
                    'Pass rate: ' + passCount + '/' + rows.length + '.',
                    allPass
                        ? 'All regression checks passed for deterministic fixture envelope.'
                        : 'At least one check failed; review rows below before relying on optimization outputs.'
                ].join('\n');

                rowsEl.innerHTML = rows.map(function(r) {
                    return '<tr>' +
                        '<td>' + escapeHtml(r.name) + '</td>' +
                        '<td><span class="' + (r.pass ? 'selftest-pass' : 'selftest-fail') + '">' + (r.pass ? 'PASS' : 'FAIL') + '</span></td>' +
                        '<td>' + escapeHtml(r.check) + '</td>' +
                        '<td>' + escapeHtml(r.detail) + '</td>' +
                    '</tr>';
                }).join('');
            }

            function buildRandomCandidate(base, scale) {
                var c = Object.assign({}, base);
                c.liquidCapture = randomInRange(Math.max(30, base.liquidCapture - 28 * scale), Math.min(99, base.liquidCapture + 22 * scale), 1);
                c.rackDensityTarget = randomInRange(Math.max(8, base.rackDensityTarget - 18 * scale), Math.min(180, base.rackDensityTarget + 22 * scale), 1);
                c.highDensityShare = randomInRange(Math.max(0, base.highDensityShare - 35 * scale), Math.min(100, base.highDensityShare + 30 * scale), 1);
                c.supplyTemp = randomInRange(Math.max(19, base.supplyTemp - 5 * scale), Math.min(40, base.supplyTemp + 7 * scale), 0.5);
                c.airCop = randomInRange(Math.max(1.8, base.airCop - 2.4 * scale), Math.min(12, base.airCop + 2.8 * scale), 0.1);
                c.pumpEff = randomInRange(Math.max(50, base.pumpEff - 12 * scale), Math.min(95, base.pumpEff + 10 * scale), 1);
                c.controlQuality = randomInRange(Math.max(20, base.controlQuality - 26 * scale), Math.min(100, base.controlQuality + 18 * scale), 1);
                c.predictiveGain = randomInRange(Math.max(0, base.predictiveGain - 22 * scale), Math.min(60, base.predictiveGain + 20 * scale), 1);
                c.coefHeatTransfer = randomInRange(Math.max(68, base.coefHeatTransfer - 12 * scale), Math.min(99, base.coefHeatTransfer + 8 * scale), 0.5);
                c.coefPipeLoss = randomInRange(Math.max(0.75, base.coefPipeLoss - 0.22 * scale), Math.min(1.8, base.coefPipeLoss + 0.3 * scale), 0.01);
                c.coefCduLoss = randomInRange(Math.max(0.5, base.coefCduLoss - 0.95 * scale), Math.min(4.5, base.coefCduLoss + 1.05 * scale), 0.05);
                c.returnTemp = clamp(c.supplyTemp + randomInRange(6, 14, 0.5), c.supplyTemp + 5.5, c.supplyTemp + 16);
                return c;
            }

            function isDominated(a, b) {
                var noWorse = (b.pue <= a.pue) && (b.netOpex <= a.netOpex) && (b.netCarbonTons <= a.netCarbonTons) && (b.riskIndex <= a.riskIndex);
                var strictlyBetter = (b.pue < a.pue) || (b.netOpex < a.netOpex) || (b.netCarbonTons < a.netCarbonTons) || (b.riskIndex < a.riskIndex);
                return noWorse && strictlyBetter;
            }

            function runParetoFrontier() {
                if (!enforceActionGuard('Pareto Frontier')) return;
                var samples = Math.max(200, Math.round(n('paretoSamples')));
                var base = gatherInputs();
                var constraints = gatherConstraintState();
                var pool = [];

                for (var i = 0; i < samples; i++) {
                    var c = buildRandomCandidate(base, 1 + (i % 5) * 0.18);
                    var m = computeModel(c);
                    var hard = evaluateHardConstraints(m, constraints);
                    m._feasible = hard.feasible;
                    pool.push(m);
                }

                var nondominated = [];
                for (var j = 0; j < pool.length; j++) {
                    var dominated = false;
                    for (var k = 0; k < pool.length; k++) {
                        if (j === k) continue;
                        if (isDominated(pool[j], pool[k])) { dominated = true; break; }
                    }
                    if (!dominated) nondominated.push(pool[j]);
                }

                nondominated.sort(function(a, b) {
                    return optimizeObjective(a, base, constraints) - optimizeObjective(b, base, constraints);
                });

                latestPareto = nondominated.slice(0, 24);
                selectedParetoIdx = -1;
                for (var si = 0; si < latestPareto.length; si++) {
                    if (latestPareto[si]._feasible) {
                        selectedParetoIdx = si;
                        break;
                    }
                }
                if (selectedParetoIdx < 0 && latestPareto.length) selectedParetoIdx = 0;
                var tbody = document.getElementById('paretoRows');
                if (tbody) {
                    if (!latestPareto.length) {
                        tbody.innerHTML = '<tr><td colspan="6">No frontier points generated.</td></tr>';
                    } else {
                        tbody.innerHTML = latestPareto.map(function(m, idx) {
                            return '<tr class="clickable" data-pareto-idx="' + idx + '">' +
                                '<td>P' + (idx + 1) + (m._feasible ? ' | feasible' : ' | soft') + '</td>' +
                                '<td>' + fmtNum(m.pue, 3) + '</td>' +
                                '<td>' + fmtNum(m.systemCop, 2) + '</td>' +
                                '<td>' + fmtUsd(m.netOpex) + '</td>' +
                                '<td>' + fmtNum(m.netCarbonTons, 0) + '</td>' +
                                '<td>' + fmtNum(m.riskIndex, 1) + '</td>' +
                            '</tr>';
                        }).join('');
                    }
                }

                var stat = document.getElementById('paretoStatus');
                if (stat) {
                    stat.className = latestPareto.length ? 'status-pill ok' : 'status-pill warn';
                    stat.textContent = latestPareto.length ? ('Frontier Ready | points=' + latestPareto.length) : 'Frontier Empty';
                }
                renderParetoScatter();
            }

            function applyParetoPoint(idx) {
                var m = latestPareto[idx];
                if (!m) return;
                selectedParetoIdx = idx;
                applyInputObjectToForm(m.input);
                optimizedModel = m;
                baselineModel = computeModel(gatherInputs());
                applyModelToUI(m);
                renderScenarioTable(baselineModel, m);
                renderTargetActions(baselineModel, m);
            }

            function renderCalibrationQuality() {
                var status = document.getElementById('calQualityStatus');
                var summary = document.getElementById('calQualitySummary');
                var rows = document.getElementById('calQualityRows');
                if (!status || !summary || !rows) return;

                if (!calibrationState || !calibrationState.quality) {
                    status.className = 'status-pill';
                    status.textContent = 'No Calibration Quality Data';
                    summary.textContent = 'Calibration quality pending. Run calibration to evaluate fit quality.';
                    rows.innerHTML = '<tr><td colspan="4">No residual diagnostics yet.</td></tr>';
                    return;
                }

                var q = calibrationState.quality;
                status.className = q.valErr <= 8 ? 'status-pill ok' : 'status-pill warn';
                status.textContent = 'Train ' + fmtNum(q.trainErr, 2) + '% | Val ' + fmtNum(q.valErr, 2) + '% | 95%CI ' + fmtNum(q.ci95, 2) + '%';
                summary.textContent = 'Residual mean ' + fmtNum(q.meanResidual, 2) + '% | std ' + fmtNum(q.stdResidual, 2) + '% | metrics ' + q.residuals.length + '.';
                rows.innerHTML = q.residuals.map(function(r) {
                    return '<tr><td>' + escapeHtml(r.metric) + '</td><td>' + escapeHtml(r.target) + '</td><td>' + escapeHtml(r.pred) + '</td><td>' + escapeHtml(r.residualPct) + '%</td></tr>';
                }).join('');
            }

            function computeCalibrationQuality(model, targets) {
                var metrics = [
                    { k: 'pue', label: 'PUE', pred: model.pue, target: targets.pue },
                    { k: 'cop', label: 'System COP', pred: model.systemCop, target: targets.cop },
                    { k: 'energy', label: 'Annual Energy (GWh)', pred: model.annualGwh, target: targets.energyGwh },
                    { k: 'opex', label: 'Net OPEX (USD/yr)', pred: model.netOpex, target: targets.netOpex },
                    { k: 'carbon', label: 'Net Carbon (tCO2e)', pred: model.netCarbonTons, target: targets.carbon },
                    { k: 'pump', label: 'Pump Power (kW)', pred: model.pumpPowerKw, target: targets.pumpKw }
                ].filter(function(m) { return m.target !== null && m.target !== undefined; });

                var residuals = metrics.map(function(m) {
                    var rel = ((m.pred - m.target) / Math.max(Math.abs(m.target), 1)) * 100;
                    return {
                        metric: m.label,
                        target: fmtNum(m.target, Math.abs(m.target) > 1000 ? 0 : 3),
                        pred: fmtNum(m.pred, Math.abs(m.pred) > 1000 ? 0 : 3),
                        residualPct: fmtNum(rel, 2),
                        absResidual: Math.abs(rel)
                    };
                });

                var train = [];
                var val = [];
                residuals.forEach(function(r, idx) {
                    if (idx % 2 === 0) train.push(r.absResidual);
                    else val.push(r.absResidual);
                });
                if (!val.length) val = train.slice();

                function mean(arr) {
                    if (!arr.length) return 0;
                    return arr.reduce(function(a, b) { return a + b; }, 0) / arr.length;
                }

                function std(arr) {
                    if (arr.length < 2) return 0;
                    var m = mean(arr);
                    var v = arr.reduce(function(a, b) { return a + Math.pow(b - m, 2); }, 0) / (arr.length - 1);
                    return Math.sqrt(v);
                }

                var all = residuals.map(function(r) { return r.absResidual; });
                var meanResidual = mean(all);
                var stdResidual = std(all);
                var ci95 = all.length ? (1.96 * stdResidual / Math.sqrt(all.length)) : 0;

                return {
                    trainErr: mean(train),
                    valErr: mean(val),
                    meanResidual: meanResidual,
                    stdResidual: stdResidual,
                    ci95: ci95,
                    residuals: residuals
                };
            }

            function setRuleStatus(text, cls) {
                var el = document.getElementById('ruleStatus');
                if (!el) return;
                el.className = 'status-pill' + (cls ? (' ' + cls) : '');
                el.textContent = text;
            }

            function applyRuleSetFromEditor() {
                var g1 = document.getElementById('ruleG1').value;
                var g2 = document.getElementById('ruleG2').value;
                var g3 = document.getElementById('ruleG3').value;
                var trial = { g1: g1, g2: g2, g3: g3 };
                var ctx = baselineModel ? buildRuleContext(baselineModel) : buildRuleContext(computeModel(gatherInputs()));
                var checks = [evaluateRuleExpression(trial.g1, ctx), evaluateRuleExpression(trial.g2, ctx), evaluateRuleExpression(trial.g3, ctx)];
                var bad = checks.filter(function(c) { return !c.ok; });
                if (bad.length) {
                    setRuleStatus('Rule error: ' + bad[0].error, 'err');
                    return;
                }
                gateRules = trial;
                setRuleStatus('Rule Set: Custom Applied', 'ok');
                runModel(false);
            }

            function resetRuleSetToDefault() {
                gateRules = Object.assign({}, DEFAULT_GATE_RULES);
                document.getElementById('ruleG1').value = gateRules.g1;
                document.getElementById('ruleG2').value = gateRules.g2;
                document.getElementById('ruleG3').value = gateRules.g3;
                setRuleStatus('Rule Set: Default', '');
                runModel(false);
            }

            function saveScenarioSnapshot() {
                var name = String(document.getElementById('scenarioName').value || '').trim();
                if (!name) {
                    alert('Please enter a scenario name.');
                    return;
                }
                var model = baselineModel || computeModel(gatherInputs());
                var version = scenarioSnapshots.length ? (Math.max.apply(null, scenarioSnapshots.map(function(s) { return s.version; })) + 1) : 1;
                scenarioSnapshots.push({
                    name: name,
                    version: version,
                    ts: nowIso(),
                    input: Object.assign({}, model.input),
                    model: {
                        pue: model.pue,
                        systemCop: model.systemCop,
                        netOpex: model.netOpex,
                        netCarbonTons: model.netCarbonTons,
                        riskIndex: model.riskIndex
                    }
                });
                persistScenarios();
                renderScenarioList();
                document.getElementById('scenarioName').value = '';
            }

            function loadSelectedScenario() {
                var sel = document.getElementById('scenarioSelect');
                if (!sel) return;
                var idx = parseInt(sel.value, 10);
                if (!isFinite(idx) || !scenarioSnapshots[idx]) return;
                var prev = selectedScenarioIdx >= 0 ? scenarioSnapshots[selectedScenarioIdx] : null;
                selectedScenarioIdx = idx;
                var current = scenarioSnapshots[idx];
                applyInputObjectToForm(current.input);
                runModel(true);
                renderScenarioDiff(current, prev);
            }

            function deleteSelectedScenario() {
                var sel = document.getElementById('scenarioSelect');
                if (!sel) return;
                var idx = parseInt(sel.value, 10);
                if (!isFinite(idx) || !scenarioSnapshots[idx]) return;
                scenarioSnapshots.splice(idx, 1);
                persistScenarios();
                renderScenarioList();
                selectedScenarioIdx = -1;
                renderScenarioDiff(null, null);
            }

            function downloadTextFile(name, text) {
                var blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(function() { URL.revokeObjectURL(url); }, 600);
            }

            function buildExecutivePack(model) {
                return [
                    '# Executive Pack - LTC System Modelling Lab',
                    'Generated: ' + nowIso(),
                    '',
                    '## KPI Snapshot',
                    '- PUE: ' + fmtNum(model.pue, 3),
                    '- System COP: ' + fmtNum(model.systemCop, 2),
                    '- Net OPEX: ' + fmtUsd(model.netOpex),
                    '- Net Carbon: ' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr',
                    '- Risk Index: ' + fmtNum(model.riskIndex, 1) + '/100',
                    '- Composite Score: ' + fmtNum(model.scores.total, 1) + '/100',
                    '',
                    '## Constraint Status',
                    document.getElementById('constraintStatus') ? document.getElementById('constraintStatus').textContent : '-',
                    '',
                    '## Active Failure Mode',
                    '- ' + model.failureMode + ' | ' + model.failureNote
                ].join('\n');
            }

            function buildEngineeringPack(model) {
                var inFlat = {};
                flattenObject('', model.input, inFlat);
                var outObj = {};
                Object.keys(model).forEach(function(key) { if (key !== 'input') outObj[key] = model[key]; });
                var outFlat = {};
                flattenObject('', outObj, outFlat);
                var lines = [
                    '# Engineering Pack - LTC System Modelling Lab',
                    'Generated: ' + nowIso(),
                    '',
                    '## Active Gate Rules',
                    '- G1: ' + gateRules.g1,
                    '- G2: ' + gateRules.g2,
                    '- G3: ' + gateRules.g3,
                    '',
                    '## Inputs'
                ];
                Object.keys(inFlat).sort().forEach(function(k) { lines.push('- ' + k + ' = ' + formatTraceValue(inFlat[k])); });
                lines.push('', '## Outputs');
                Object.keys(outFlat).sort().forEach(function(k) { lines.push('- ' + k + ' = ' + formatTraceValue(outFlat[k])); });
                return lines.join('\n');
            }

            function applyModelToUI(model) {
                var countryLabel = selectedCountryLabel();
                var rackLabel = selectedRackLabel();

                setText('outCountry', countryLabel);
                setText('outLiquidLoad', fmtNum(model.liquidKw, 0) + ' kW');
                setText('outAirLoad', fmtNum(model.airKw, 0) + ' kW');
                setText('outFlow', fmtNum(model.flowLpm, 0) + ' LPM');
                setText('outPump', fmtNum(model.pumpPowerKw, 1) + ' kW');
                setText('outCdu', model.cduCount + ' units');
                setText('outPue', fmtNum(model.pue, 3));
                setText('outCop', fmtNum(model.systemCop, 2));
                setText('outWue', fmtNum(model.wue, 3) + ' L/kWh');
                setText('outEnergy', fmtNum(model.annualGwh, 2) + ' GWh/yr');
                setText('outOpex', fmtUsd(model.annualOpex));
                setText('outHeatCredit', fmtUsd(model.heatReuseCredit));
                setText('outNetOpex', fmtUsd(model.netOpex));
                setText('outCarbon', fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr');
                setText('outCarbonAvoided', fmtNum(model.avoidedCarbonTons, 0) + ' tCO2e/yr');
                setText('outRackType', rackLabel);
                setText('outDesignDensity', fmtNum(model.designDensity, 1) + ' kW/rack');
                setText('outControlIndex', fmtNum(model.controlIndex, 1) + '/100');
                setText('outFutureFactor', fmtNum(model.futureFactor, 3) + 'x (' + model.input.modelYear + ')');
                setText('outRackDensity', fmtNum(model.rackDensity, 1) + ' kW/rack');
                setText('outRisk', fmtNum(model.riskIndex, 1) + '/100');
                setText('outConfidence', fmtNum(model.confidence, 0) + '%');
                renderQuickKpiStrip(model);
                renderInputQuality(model);

                setText('modelInputNode', fmtNum(model.input.itLoadMw, 1) + 'MW | ' + fmtNum(model.effectiveCapture, 0) + '% effective capture');
                setText('modelEngineNode', 'dT ' + fmtNum(model.deltaT, 1) + 'C | ' + fmtNum(model.flowLpm, 0) + ' LPM | control ' + fmtNum(model.controlIndex, 0));
                setText('modelControlNode', 'Targets PUE ' + fmtNum(model.input.targetPue, 3) + ' / COP ' + fmtNum(model.input.targetCop, 2) + ' | gap check active');
                setText('modelImpactNode', 'PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2) + ' | risk ' + fmtNum(model.riskIndex, 1));

                setText('diagInputMain', shortText(fmtNum(model.input.itLoadMw, 1) + 'MW | ' + rackLabel, 34));
                setText('diagInputSub', shortText(countryLabel + ' | dens ' + fmtNum(model.input.rackDensityTarget, 1), 34));
                setText('diagThermalMain', shortText('Ts ' + fmtNum(model.input.supplyTemp, 1) + 'C -> Tr ' + fmtNum(model.input.returnTemp, 1) + 'C', 34));
                setText('diagThermalSub', shortText('capture ' + fmtNum(model.effectiveCapture, 1) + '% | L ' + fmtNum(model.liquidKw, 0) + 'kW', 34));
                setText('diagHydraulicMain', shortText('flow ' + fmtNum(model.flowLpm, 0) + ' LPM | pump ' + fmtNum(model.pumpPowerKw, 1) + 'kW', 34));
                setText('diagHydraulicSub', shortText('pipe ' + fmtNum(model.input.coefPipeLoss, 2) + 'x | margin ' + fmtNum(model.input.hydraulicMargin, 0) + '%', 34));
                setText('diagImpactMain', shortText('PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2), 42));
                setText('diagImpactSub', shortText('WUE ' + fmtNum(model.wue, 3) + ' | future ' + fmtNum(model.futureFactor, 3) + 'x', 42));
                setText('diagCostMain', shortText('Net OPEX ' + fmtUsd(model.netOpex), 34));
                setText('diagCostSub', shortText('Carbon ' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr', 34));
                setText('diagControlMain', shortText('ControlIdx ' + fmtNum(model.controlIndex, 1) + ' | fit ' + (calibrationState ? fmtNum(fitScoreFromError(calibrationState.bestError), 1) + '%' : 'n/a'), 34));
                setText('diagControlSub', shortText('Gap PUE ' + signed(model.pueGap, 3, '') + ' | COP ' + signed(model.copGap, 2, ''), 34));
                setText('diagComplianceMain', shortText('Score ' + fmtNum(model.scores.total, 1) + '/100', 40));
                setText('diagComplianceSub', shortText('ASH ' + fmtNum(model.scores.ashrae, 0) + ' | ANSI ' + fmtNum(model.scores.ansi, 0) + ' | ISO ' + fmtNum(model.scores.iso, 0), 40));

                setText('ctrlSensorMain', shortText('Monitoring ' + fmtNum(model.input.monitoring, 0) + '% | conf ' + fmtNum(model.confidence, 0) + '%', 34));
                setText('ctrlSensorSub', shortText('Year ' + model.input.modelYear, 30));
                setText('ctrlControllerMain', shortText('Control ' + fmtNum(model.input.controlQuality, 0) + '% | pred ' + fmtNum(model.input.predictiveGain, 0) + '%', 34));
                setText('ctrlControllerSub', shortText('Ctrl idx ' + fmtNum(model.controlIndex, 1) + '/100', 30));
                setText('ctrlActuatorMain', shortText('Ts ' + fmtNum(model.input.supplyTemp, 1) + 'C | pump ' + fmtNum(model.input.pumpEff, 0) + '%', 34));
                setText('ctrlActuatorSub', shortText('capture ' + fmtNum(model.effectiveCapture, 1) + '% | flow ' + fmtNum(model.flowLpm, 0), 34));
                setText('ctrlPlantMain', shortText('PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2) + ' | risk ' + fmtNum(model.riskIndex, 1), 34));
                setText('ctrlPlantSub', shortText('Net OPEX ' + fmtUsd(model.netOpex), 34));

                var gateEval = evaluateGateStates(model);
                var gateAOk = gateEval.g1;
                var gateBOk = gateEval.g2;
                var gateCOk = gateEval.g3;
                setGateState('ctrlGateAPoly', gateAOk);
                setGateState('ctrlGateBPoly', gateBOk);
                setGateState('ctrlGateCPoly', gateCOk);
                setText('ctrlGateAMain', gateAOk ? 'G1 OK' : 'G1 ADJ');
                setText('ctrlGateBMain', gateBOk ? 'G2 OK' : 'G2 LIM');
                setText('ctrlGateCMain', gateCOk ? 'G3 OK' : 'G3 ACT');
                setText('ctrlGateASub', compactRuleText(gateRules.g1, 38));
                setText('ctrlGateBSub', compactRuleText(gateRules.g2, 38));
                setText('ctrlGateCSub', compactRuleText(gateRules.g3, 38));

                setText('impactPueGap', signed(model.pueGap, 3, ''));
                setText('impactCopGap', signed(model.copGap, 2, ''));
                if (baselineModel && optimizedModel) setText('impactOpexDelta', signed(optimizedModel.netOpex - baselineModel.netOpex, 0, ' USD/yr'));
                else setText('impactOpexDelta', 'N/A');
                setText('targetGapBadge', 'Gap PUE ' + signed(model.pueGap, 3, '') + ' | COP ' + signed(model.copGap, 2, ''));

                setText('outScore', fmtNum(model.scores.total, 1) + '/100');
                setText('outGrade', grade(model.scores.total));
                setText('scoreAshrae', fmtNum(model.scores.ashrae, 0) + '/100');
                setText('scoreAnsi', fmtNum(model.scores.ansi, 0) + '/100');
                setText('scoreIso', fmtNum(model.scores.iso, 0) + '/100');
                setText('scoreNfpa', fmtNum(model.scores.nfpa, 0) + '/100');
                setText('scoreUptime', fmtNum(model.scores.uptime, 0) + '/100');
                setBar('barAshrae', model.scores.ashrae);
                setBar('barAnsi', model.scores.ansi);
                setBar('barIso', model.scores.iso);
                setBar('barNfpa', model.scores.nfpa);
                setBar('barUptime', model.scores.uptime);

                renderBreakdown(model);
                renderTraceability(model);
                renderPipelineFlow(model);
                renderLogicSequence(model);
                renderFullParameterMap(model);
                renderEquationInspector(model);
                renderImpactMatrix(model);
                renderConstraintStatus(model);
                renderCalibrationPanel();
                renderCalibrationQuality();
                renderParetoScatter();
                renderMonteCarloDistributions();
                renderEnergySankey(model);
                renderExplorerWithModel(model);
                refreshLiteralTermHotspots();
                applyUniversalTermTooltips(document.getElementById('calculator'));
            }

            function runModel(resetOptimization) {
                if (resetOptimization === void 0) resetOptimization = true;
                setCoolingArchitectureNote(document.getElementById('inCoolingArchitecture').value);
                var input = gatherInputs();
                baselineModel = computeModel(input);
                if (resetOptimization) {
                    optimizedModel = null;
                    latestPareto = [];
                    selectedParetoIdx = -1;
                    latestMonteCarlo = null;
                    if (calibrationState) calibrationDirty = true;
                }
                applyModelToUI(baselineModel);
                renderScenarioTable(baselineModel, optimizedModel);
                renderTargetActions(baselineModel, optimizedModel);
            }

            function clearAutoRunTimer() {
                if (autoRunTimer !== null) {
                    clearTimeout(autoRunTimer);
                    autoRunTimer = null;
                }
            }

            function updateAutoRunStateUI() {
                var toggle = document.getElementById('autoRunToggle');
                if (toggle) autoRunEnabled = !!toggle.checked;
                var state = document.getElementById('autoRunState');
                if (!state) return;
                if (autoRunEnabled) {
                    state.classList.remove('off');
                    state.textContent = 'Auto-Run ON (' + autoRunDebounceMs + 'ms)';
                } else {
                    clearAutoRunTimer();
                    state.classList.add('off');
                    state.textContent = 'Auto-Run OFF';
                }
            }

            function updateInputModeUI() {
                var toggle = document.getElementById('advancedInputToggle');
                if (toggle) showAdvancedInputs = !!toggle.checked;
                document.querySelectorAll('.input-grid .input-group.advanced-param').forEach(function(group) {
                    group.classList.toggle('hidden-by-mode', !showAdvancedInputs);
                });
                var state = document.getElementById('inputModeState');
                if (state) {
                    if (showAdvancedInputs) {
                        state.classList.remove('off');
                        state.textContent = 'Advanced Lab Mode';
                    } else {
                        state.classList.add('off');
                        state.textContent = 'Operational Mode';
                    }
                }
                var note = document.getElementById('inputModeNote');
                if (note) {
                    note.textContent = showAdvancedInputs
                        ? 'Advanced Lab mode shows coefficient-level tuning for calibration, optimizer exploration, and sensitivity studies.'
                        : 'Operational mode hides lab-only coefficient tuning and keeps field-operational parameters visible.';
                }
                saveUiPrefs();
            }

            function updateLayoutSplitUI(percent) {
                var pct = clamp(percent, 34, 58);
                layoutSplitPercent = pct;
                var wrap = document.querySelector('#calculator .calculator-layout');
                if (wrap) wrap.style.setProperty('--calc-left-width', pct + '%');
                var slider = document.getElementById('layoutSplit');
                if (slider && String(slider.value) !== String(Math.round(pct))) slider.value = String(Math.round(pct));
                var label = document.getElementById('layoutSplitLabel');
                if (label) label.textContent = Math.round(pct) + '% / ' + Math.round(100 - pct) + '%';
                saveUiPrefs();
            }

            function focusDiagramBlock() {
                var panel = document.querySelector('#calculator .calc-output-panel');
                if (!panel) return;
                var block = panel.querySelector('.model-block');
                if (!block) return;
                var top = Math.max(0, block.offsetTop - 12);
                if (panel.scrollTo) panel.scrollTo({ top: top, behavior: 'smooth' });
                else panel.scrollTop = top;
                block.classList.remove('focus-flash');
                void block.offsetWidth;
                block.classList.add('focus-flash');
            }

            function renderQuickKpiStrip(model) {
                setText('quickPue', fmtNum(model.pue, 3));
                setText('quickCop', fmtNum(model.systemCop, 2));
                setText('quickOpex', fmtUsdCompact(model.netOpex));
                setText('quickRisk', fmtNum(model.riskIndex, 1));
                var s = document.getElementById('quickConstraintState');
                if (!s) return;
                var hard = evaluateHardConstraints(model, gatherConstraintState());
                if (hard.feasible) {
                    s.className = 'status-pill ok';
                    s.textContent = 'Hard Constraints: Pass';
                } else {
                    s.className = 'status-pill warn';
                    s.textContent = 'Hard Constraints: ' + hard.issues.join(', ');
                }
            }

            function renderInputQuality(model) {
                var status = document.getElementById('inputQualityStatus');
                var list = document.getElementById('inputQualityList');
                if (!status || !list || !model || !model.input) return;

                var warn = [];
                var err = [];
                var input = model.input;
                var constraints = gatherConstraintState();
                var inputGuard = evaluateInputHardRules(input, model, constraints);
                warn = warn.concat(inputGuard.warnings);
                err = err.concat(inputGuard.hardStops.map(function(msg) { return 'Hard-stop: ' + msg; }));

                var hard = evaluateHardConstraints(model, constraints);
                if (!hard.feasible) err.push('Hard constraint violation: ' + hard.issues.join(', ') + '.');

                function uniqueLines(rows) {
                    var seen = {};
                    return rows.filter(function(line) {
                        var key = String(line || '').trim();
                        if (!key || seen[key]) return false;
                        seen[key] = true;
                        return true;
                    });
                }
                warn = uniqueLines(warn);
                err = uniqueLines(err);

                var rows = [];
                if (!warn.length && !err.length) {
                    status.className = 'status-pill ok';
                    status.textContent = 'Quality Envelope: Good';
                    rows.push('<li>No major realism flags detected for current input envelope.</li>');
                } else if (err.length) {
                    status.className = 'status-pill err';
                    status.textContent = inputGuard.blocked ? 'Hard-Stop Active' : 'Quality Envelope: Review Required';
                    rows = err.map(function(t) { return '<li class="err">' + escapeHtml(t) + '</li>'; })
                        .concat(warn.map(function(t) { return '<li class="warn">' + escapeHtml(t) + '</li>'; }));
                } else {
                    status.className = 'status-pill warn';
                    status.textContent = 'Quality Envelope: Minor Warnings';
                    rows = warn.map(function(t) { return '<li class="warn">' + escapeHtml(t) + '</li>'; });
                }
                list.innerHTML = rows.join('');
            }

            function renderParetoInsight() {
                var titleEl = document.getElementById('paretoInsightTitle');
                var feasEl = document.getElementById('paretoInsightFeasibility');
                var metricsEl = document.getElementById('paretoInsightMetrics');
                var deltaEl = document.getElementById('paretoInsightDelta');
                if (!titleEl || !feasEl || !metricsEl || !deltaEl) return;

                if (!latestPareto.length) {
                    titleEl.textContent = 'No Pareto point selected yet.';
                    feasEl.className = 'status-pill';
                    feasEl.textContent = 'N/A';
                    metricsEl.textContent = 'Generate frontier and click point/row to inspect detailed trade-off metrics.';
                    deltaEl.textContent = 'Delta summary vs baseline will appear here.';
                    return;
                }

                var idx = selectedParetoIdx >= 0 && latestPareto[selectedParetoIdx] ? selectedParetoIdx : 0;
                var m = latestPareto[idx];
                titleEl.textContent = 'Point P' + (idx + 1) + ' selected';
                feasEl.className = 'status-pill ' + (m._feasible ? 'ok' : 'warn');
                feasEl.textContent = m._feasible ? 'Feasible' : 'Soft Constraint';
                metricsEl.textContent = 'PUE ' + fmtNum(m.pue, 3) + ' | COP ' + fmtNum(m.systemCop, 2) + ' | Net OPEX ' + fmtUsd(m.netOpex) + ' | Carbon ' + fmtNum(m.netCarbonTons, 0) + ' tCO2e/yr | Risk ' + fmtNum(m.riskIndex, 1);

                if (baselineModel) {
                    deltaEl.textContent =
                        'Delta vs baseline: PUE ' + signed(m.pue - baselineModel.pue, 3, '') +
                        ' | COP ' + signed(m.systemCop - baselineModel.systemCop, 2, '') +
                        ' | OPEX ' + signed(m.netOpex - baselineModel.netOpex, 0, ' USD/yr') +
                        ' | Carbon ' + signed(m.netCarbonTons - baselineModel.netCarbonTons, 0, ' tCO2e/yr') +
                        ' | Risk ' + signed(m.riskIndex - baselineModel.riskIndex, 1, '');
                } else {
                    deltaEl.textContent = 'Baseline not available for delta comparison yet.';
                }
            }

            function getExplorerBlockLabel(key) {
                for (var i = 0; i < EXPLORER_BLOCKS.length; i++) {
                    if (EXPLORER_BLOCKS[i].key === key) return EXPLORER_BLOCKS[i].label;
                }
                return key;
            }

            function getBlockPopupConfig(rawKey) {
                var key = String(rawKey || '').toLowerCase().trim();
                return BLOCK_POPUP_CONFIG[key] || BLOCK_POPUP_CONFIG.input;
            }

            function blockPopupExplorerKey(rawKey) {
                return getBlockPopupConfig(rawKey).explorerKey || 'input';
            }

            function blockPopupModel() {
                return optimizedModel || baselineModel || computeModel(gatherInputs());
            }

            function blockPopupFormulaRows(rawKey, model, hard, gateEval) {
                var key = String(rawKey || '').toLowerCase().trim();
                if (key === 'impact') {
                    return [
                        'PUE=' + fmtNum(model.pue, 3) + ' | COP=' + fmtNum(model.systemCop, 2) + ' | WUE=' + fmtNum(model.wue, 3),
                        'targetGap: PUE ' + signed(model.pueGap, 3, '') + ' | COP ' + signed(model.copGap, 2, ''),
                        'annualEnergy=' + fmtNum(model.annualGwh, 2) + ' GWh | risk=' + fmtNum(model.riskIndex, 1) + '/100'
                    ];
                }
                if (key === 'gate1') {
                    return [
                        'rule G1=' + gateRules.g1,
                        'state=' + (gateEval.g1 ? 'OPEN' : 'ADJ') + ' | monitoring=' + fmtNum(model.input.monitoring, 0) + '%',
                        'controlIndex=' + fmtNum(model.controlIndex, 1) + '/100'
                    ];
                }
                if (key === 'gate2') {
                    return [
                        'rule G2=' + gateRules.g2,
                        'state=' + (gateEval.g2 ? 'OPEN' : 'LIM') + ' | deltaT=' + fmtNum(model.deltaT, 2) + 'C',
                        'pump%IT=' + fmtNum(hard.pumpPctIt, 2) + '%'
                    ];
                }
                if (key === 'gate3') {
                    return [
                        'rule G3=' + gateRules.g3,
                        'state=' + (gateEval.g3 ? 'OPEN' : 'ACT') + ' | risk=' + fmtNum(model.riskIndex, 1) + '/100',
                        'PUE vs target=' + fmtNum(model.pue, 3) + ' vs ' + fmtNum(model.input.targetPue, 3)
                    ];
                }
                return explorerFormulaLines(blockPopupExplorerKey(key), model, hard, gateEval);
            }

            function blockPopupStepRows(rawKey, model, hard, gateEval) {
                var key = String(rawKey || '').toLowerCase().trim();
                if (key === 'impact') {
                    return [
                        { t: 'Aggregate thermal/hydraulic/control outputs into KPI vector.', s: 'ok' },
                        { t: 'Compute target gaps (PUE/COP) and prioritize optimization pressure.', s: (model.pueGap > 0.04 || model.copGap < -0.8) ? 'warn' : 'ok' },
                        { t: 'Propagate risk and compliance status to decision layer.', s: model.riskIndex > 40 ? 'warn' : 'ok' }
                    ];
                }
                if (key === 'gate1') {
                    return [
                        { t: 'Evaluate sensor quality and monitoring coverage.', s: model.input.monitoring >= 85 ? 'ok' : 'warn' },
                        { t: 'Check control readiness index threshold.', s: model.controlIndex >= 78 ? 'ok' : 'warn' },
                        { t: 'Set G1 state for downstream controller behavior.', s: gateEval.g1 ? 'ok' : 'warn' }
                    ];
                }
                if (key === 'gate2') {
                    return [
                        { t: 'Check delta-T adequacy under active load.', s: model.deltaT >= 7.5 ? 'ok' : 'warn' },
                        { t: 'Check pump overhead against IT power budget.', s: hard.pumpPctIt <= 3 ? 'ok' : 'warn' },
                        { t: 'Set G2 state to OPEN/LIMIT actuator envelope.', s: gateEval.g2 ? 'ok' : 'warn' }
                    ];
                }
                if (key === 'gate3') {
                    return [
                        { t: 'Validate risk index against guard threshold.', s: model.riskIndex <= 35 ? 'ok' : 'warn' },
                        { t: 'Validate PUE target envelope for release state.', s: model.pue <= model.input.targetPue + 0.02 ? 'ok' : 'warn' },
                        { t: 'Set G3 decision to PASS/ACTION.', s: gateEval.g3 ? 'ok' : 'warn' }
                    ];
                }
                return explorerStepRows(blockPopupExplorerKey(key), model, hard, gateEval);
            }

            function blockPopupDependencies(rawKey) {
                var key = String(rawKey || '').toLowerCase().trim();
                if (key === 'impact') {
                    return {
                        up: ['Thermal solver', 'Hydraulic solver', 'Control gates'],
                        down: ['Cost + carbon', 'Compliance + risk', 'Optimization objective']
                    };
                }
                if (key === 'gate1' || key === 'gate2' || key === 'gate3') {
                    return {
                        up: ['Monitoring', 'Control index', 'Rule DSL expression'],
                        down: ['Actuator behavior', 'Plant KPI state', 'Risk action mode']
                    };
                }
                return explorerUpstreamDownstream(blockPopupExplorerKey(key));
            }

            function blockPopupDiagnostics(rawKey, model, hard, inputGuard, gateEval) {
                var key = String(rawKey || '').toLowerCase().trim();
                var base = explorerBlockDiagnostics(blockPopupExplorerKey(key), model, hard, inputGuard, gateEval);
                var warn = base.warn.slice();
                var err = base.err.slice();

                if (key === 'impact') {
                    if (model.pueGap > 0.04) warn.push('Impact layer shows PUE gap above +0.04.');
                    if (model.copGap < -0.8) warn.push('Impact layer shows COP gap worse than -0.80.');
                    if (model.riskIndex > 40) err.push('Impact layer risk exceeds 40.');
                } else if (key === 'gate1' && !gateEval.g1) {
                    warn.push('Gate G1 not open; raise monitoring/control quality envelope.');
                } else if (key === 'gate2' && !gateEval.g2) {
                    warn.push('Gate G2 limiting actuation; optimize delta-T or pump overhead.');
                } else if (key === 'gate3' && !gateEval.g3) {
                    err.push('Gate G3 action state active; risk/KPI guard not satisfied.');
                }

                return { warn: warn, err: err };
            }

            function blockPopupSnapshotLines(rawKey, model, hard, gateEval) {
                var key = String(rawKey || '').toLowerCase().trim();
                if (key === 'input') {
                    return [
                        'IT ' + fmtNum(model.input.itLoadMw, 1) + 'MW | rack density target ' + fmtNum(model.input.rackDensityTarget, 1) + ' kW/rack',
                        'capture target ' + fmtNum(model.input.liquidCapture, 1) + '% | monitoring ' + fmtNum(model.input.monitoring, 0) + '%',
                        'country=' + selectedCountryLabel() + ' | climate=' + model.input.climate
                    ];
                }
                if (key === 'thermal' || key === 'actuator') {
                    return [
                        'deltaT=' + fmtNum(model.deltaT, 2) + 'C | Ts=' + fmtNum(model.input.supplyTemp, 1) + 'C | Tr=' + fmtNum(model.input.returnTemp, 1) + 'C',
                        'liquid=' + fmtNum(model.liquidKw, 0) + 'kW | air=' + fmtNum(model.airKw, 0) + 'kW',
                        'effective capture=' + fmtNum(model.effectiveCapture, 1) + '%'
                    ];
                }
                if (key === 'hydraulic') {
                    return [
                        'flow=' + fmtNum(model.flowLpm, 0) + ' LPM | pump=' + fmtNum(model.pumpPowerKw, 1) + ' kW',
                        'pump%IT=' + fmtNum(hard.pumpPctIt, 2) + '% | margin=' + fmtNum(model.input.hydraulicMargin, 0) + '%',
                        'redundancy=' + model.input.redundancy + ' | CDU=' + model.cduCount + ' units'
                    ];
                }
                if (key === 'impact' || key === 'plant') {
                    return [
                        'PUE=' + fmtNum(model.pue, 3) + ' | COP=' + fmtNum(model.systemCop, 2) + ' | WUE=' + fmtNum(model.wue, 3),
                        'target gap: PUE ' + signed(model.pueGap, 3, '') + ' | COP ' + signed(model.copGap, 2, ''),
                        'risk=' + fmtNum(model.riskIndex, 1) + '/100 | confidence=' + fmtNum(model.confidence, 0) + '%'
                    ];
                }
                if (key === 'cost') {
                    return [
                        'net OPEX=' + fmtUsd(model.netOpex) + ' | annual GWh=' + fmtNum(model.annualGwh, 2),
                        'energyCost=' + fmtUsd(model.annualEnergyCost) + ' | waterCost=' + fmtUsd(model.annualWaterCost),
                        'carbon=' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr | avoided=' + fmtNum(model.avoidedCarbonTons, 0) + ' tCO2e/yr'
                    ];
                }
                if (key === 'compliance') {
                    return [
                        'score=' + fmtNum(model.scores.total, 1) + '/100 | risk=' + fmtNum(model.riskIndex, 1) + '/100',
                        'ASH ' + fmtNum(model.scores.ashrae, 0) + ' | ANSI ' + fmtNum(model.scores.ansi, 0) + ' | ISO ' + fmtNum(model.scores.iso, 0),
                        'hard constraints=' + (hard.feasible ? 'PASS' : 'FAIL (' + hard.issues.join(', ') + ')')
                    ];
                }
                if (key === 'sensor') {
                    return [
                        'monitoring=' + fmtNum(model.input.monitoring, 0) + '% | confidence=' + fmtNum(model.confidence, 0) + '%',
                        'model year=' + model.input.modelYear + ' | future factor=' + fmtNum(model.futureFactor, 3) + 'x',
                        'telemetry quality drives control stability and gate outcomes'
                    ];
                }
                if (key === 'controller') {
                    return [
                        'control quality=' + fmtNum(model.input.controlQuality, 0) + '% | predictive=' + fmtNum(model.input.predictiveGain, 0) + '%',
                        'control index=' + fmtNum(model.controlIndex, 1) + '/100',
                        'gates=' + (gateEval.g1 ? 'G1' : '!G1') + '/' + (gateEval.g2 ? 'G2' : '!G2') + '/' + (gateEval.g3 ? 'G3' : '!G3')
                    ];
                }
                if (key === 'gate1' || key === 'gate2' || key === 'gate3') {
                    return [explorerSummaryForBlock('control', model, hard, gateEval), explorerPrevDeltaLine('control', model), 'Rule-driven decision node in closed-loop execution.'];
                }
                return [explorerSummaryForBlock(blockPopupExplorerKey(key), model, hard, gateEval), explorerPrevDeltaLine(blockPopupExplorerKey(key), model), 'Run history points=' + explorerRunHistory.length];
            }

            function blockPopupStatus(diag) {
                if (diag.err && diag.err.length) return { cls: 'err', text: 'Critical Review' };
                if (diag.warn && diag.warn.length) return { cls: 'warn', text: 'Needs Review' };
                return { cls: 'ok', text: 'Stable' };
            }

            function closeBlockDetailPopup() {
                var modal = document.getElementById('blockDetailModal');
                if (!modal || !modal.classList.contains('open')) return;
                modal.classList.remove('open');
                modal.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('block-popup-open');
                var trigger = blockPopupState.trigger;
                blockPopupState = { open: false, key: '', explorerKey: 'input', trigger: null };
                if (trigger && trigger.focus) trigger.focus();
            }

            function focusExplorerBlock(key) {
                var d = document.getElementById('expBlock-' + key);
                if (!d) return;
                explorerState.lastActive = key;
                explorerCloseOtherBlocks(key);
                if ((explorerState.openBlocks || []).indexOf(key) < 0) explorerState.openBlocks.push(key);
                d.open = true;
                saveExplorerState();
                updateExplorerHashState();
                var model = explorerCurrentModel || baselineModel || computeModel(gatherInputs());
                if (model) renderExplorerWithModel(model);
                var explorer = document.getElementById('modellingExplorer');
                if (explorer && explorer.scrollIntoView) explorer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            function openBlockDetailPopup(rawKey, triggerEl) {
                var key = String(rawKey || '').toLowerCase().trim();
                var cfg = getBlockPopupConfig(key);
                var explorerKey = blockPopupExplorerKey(key);
                var model = blockPopupModel();
                if (!model) return;

                var constraints = gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var gateEval = evaluateGateStates(model);
                var inputGuard = evaluateInputHardRules(model.input, model, constraints);
                var stepRows = blockPopupStepRows(key, model, hard, gateEval);
                var formulaRows = blockPopupFormulaRows(key, model, hard, gateEval);
                var io = blockPopupDependencies(key);
                var diag = blockPopupDiagnostics(key, model, hard, inputGuard, gateEval);
                var status = blockPopupStatus(diag);
                var summary = blockPopupSnapshotLines(key, model, hard, gateEval);
                var suggestion = explorerSuggestedAction(explorerKey, model);
                var docText = cfg.doc || explorerDocText(explorerKey);

                var modal = document.getElementById('blockDetailModal');
                var titleEl = document.getElementById('blockDetailTitle');
                var metaEl = document.getElementById('blockDetailMeta');
                var badgeEl = document.getElementById('blockDetailBadge');
                var bodyEl = document.getElementById('blockDetailBody');
                var openExplorerBtn = document.getElementById('blockDetailOpenExplorer');
                var applyBtn = document.getElementById('blockDetailApplySuggestion');
                if (!modal || !titleEl || !metaEl || !badgeEl || !bodyEl || !openExplorerBtn || !applyBtn) return;

                titleEl.textContent = cfg.label + ' | Detailed Process View';
                metaEl.textContent = 'Mapped Engine Block: ' + getExplorerBlockLabel(explorerKey) + ' | ' + explorerSummaryForBlock(explorerKey, model, hard, gateEval);
                badgeEl.className = 'status-pill ' + status.cls;
                badgeEl.textContent = status.text;

                bodyEl.innerHTML = [
                    '<article class="block-detail-section"><h5>Snapshot</h5><pre class="block-detail-pre">' + escapeHtml(summary.join('\n')) + '</pre></article>',
                    '<article class="block-detail-section"><h5>Process Steps</h5><ul class="block-detail-list">' + stepRows.map(function(r) { return '<li class="' + escapeAttr(r.s || 'ok') + '">' + escapeHtml(r.t) + '</li>'; }).join('') + '</ul></article>',
                    '<article class="block-detail-section"><h5>Formula + Live Values</h5><pre class="block-detail-pre">' + escapeHtml(formulaRows.join('\n')) + '</pre></article>',
                    '<article class="block-detail-section"><h5>Dependencies</h5><pre class="block-detail-pre">Upstream: ' + escapeHtml(io.up.join(' -> ')) + '\nDownstream: ' + escapeHtml(io.down.join(' -> ')) + '\nGraph: input -> thermal -> hydraulic -> control -> impact -> compliance</pre></article>',
                    '<article class="block-detail-section"><h5>Warnings + Root Cause</h5><ul class="block-detail-list">' + (diag.err.concat(diag.warn).length ? diag.err.map(function(t) { return '<li class="err">' + escapeHtml(t) + '</li>'; }).concat(diag.warn.map(function(t) { return '<li class="warn">' + escapeHtml(t) + '</li>'; })).join('') : '<li class="ok">No critical warning on current run.</li>') + '</ul></article>',
                    '<article class="block-detail-section"><h5>Recommended Action</h5><pre class="block-detail-pre">' + escapeHtml(suggestion) + '\n\nDoc: ' + escapeHtml(docText) + '</pre></article>'
                ].join('');

                openExplorerBtn.textContent = 'Open In Explorer (' + getExplorerBlockLabel(explorerKey) + ')';
                applyBtn.textContent = 'Apply Suggested Fix (' + getExplorerBlockLabel(explorerKey) + ')';
                blockPopupState = { open: true, key: key, explorerKey: explorerKey, trigger: triggerEl || document.activeElement };

                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
                document.body.classList.add('block-popup-open');
                applyUniversalTermTooltips(bodyEl);
                var closeBtn = document.getElementById('blockDetailClose');
                if (closeBtn && closeBtn.focus) closeBtn.focus();
            }

            function bindDiagramBlockPopups() {
                document.querySelectorAll('.diagram-svg [data-block-popup]').forEach(function(el) {
                    if (el.dataset.blockPopupBound === '1') return;
                    var key = String(el.getAttribute('data-block-popup') || '').trim();
                    if (!key) return;
                    var cfg = getBlockPopupConfig(key);
                    if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex', '0');
                    if (!el.hasAttribute('role')) el.setAttribute('role', 'button');
                    if (!el.hasAttribute('aria-label')) el.setAttribute('aria-label', 'Open ' + cfg.label + ' detailed popup');
                    el.dataset.blockPopupBound = '1';
                    el.addEventListener('click', function(ev) {
                        openBlockDetailPopup(key, ev.currentTarget);
                    });
                    el.addEventListener('keydown', function(ev) {
                        if (ev.key !== 'Enter' && ev.key !== ' ') return;
                        ev.preventDefault();
                        openBlockDetailPopup(key, ev.currentTarget);
                    });
                });
            }

            function initBlockDetailModal() {
                var modal = document.getElementById('blockDetailModal');
                if (!modal || modal.dataset.bound === '1') return;
                modal.dataset.bound = '1';

                modal.addEventListener('click', function(ev) {
                    var closeNode = ev.target && ev.target.closest ? ev.target.closest('[data-block-modal-close]') : null;
                    if (closeNode) closeBlockDetailPopup();
                });

                var openExplorerBtn = document.getElementById('blockDetailOpenExplorer');
                if (openExplorerBtn) {
                    openExplorerBtn.addEventListener('click', function() {
                        if (!blockPopupState.open) return;
                        focusExplorerBlock(blockPopupState.explorerKey || 'input');
                        closeBlockDetailPopup();
                    });
                }

                var applyBtn = document.getElementById('blockDetailApplySuggestion');
                if (applyBtn) {
                    applyBtn.addEventListener('click', function() {
                        if (!blockPopupState.open) return;
                        applyExplorerSuggestion(blockPopupState.explorerKey || 'input');
                        closeBlockDetailPopup();
                    });
                }

                document.addEventListener('keydown', function(ev) {
                    if (ev.key !== 'Escape') return;
                    if (!blockPopupState.open) return;
                    closeBlockDetailPopup();
                });

                bindDiagramBlockPopups();
            }

            function explorerMetricSnapshot(model) {
                return {
                    ts: Date.now(),
                    pue: model.pue,
                    cop: model.systemCop,
                    opex: model.netOpex,
                    carbon: model.netCarbonTons,
                    risk: model.riskIndex,
                    deltaT: model.deltaT,
                    pump: model.pumpPowerKw,
                    flow: model.flowLpm,
                    control: model.controlIndex,
                    capture: model.effectiveCapture,
                    itLoad: model.input.itLoadMw,
                    monitoring: model.input.monitoring,
                    score: model.scores.total
                };
            }

            function registerExplorerRun(model) {
                if (!model) return;
                var snap = explorerMetricSnapshot(model);
                var last = explorerRunHistory.length ? explorerRunHistory[explorerRunHistory.length - 1] : null;
                if (last && Math.abs(last.pue - snap.pue) < 0.00001 && Math.abs(last.cop - snap.cop) < 0.00001 && Math.abs(last.opex - snap.opex) < 0.01 && Math.abs(last.risk - snap.risk) < 0.001) {
                    return;
                }
                explorerRunHistory.push(snap);
                if (explorerRunHistory.length > 150) explorerRunHistory.shift();
            }

            function explorerTrendForBlock(key) {
                var rows = explorerRunHistory;
                if (!rows.length) return [];
                var vals = [];
                for (var i = 0; i < rows.length; i++) {
                    var r = rows[i];
                    if (key === 'input') vals.push(r.capture);
                    else if (key === 'thermal') vals.push(r.pue);
                    else if (key === 'hydraulic') vals.push(r.pump);
                    else if (key === 'control') vals.push(r.control);
                    else if (key === 'cost') vals.push(r.opex);
                    else vals.push(r.risk);
                }
                if (vals.length > 40) vals = vals.slice(vals.length - 40);
                return vals;
            }

            function explorerSparklineSvg(values, color) {
                if (!values || !values.length) return '<svg class="exp-spark" viewBox="0 0 220 56" aria-hidden="true"></svg>';
                var min = Math.min.apply(null, values);
                var max = Math.max.apply(null, values);
                if (max === min) max = min + 1;
                var w = 220;
                var h = 56;
                var path = '';
                for (var i = 0; i < values.length; i++) {
                    var x = (i / Math.max(values.length - 1, 1)) * (w - 8) + 4;
                    var y = h - 6 - (((values[i] - min) / (max - min)) * (h - 14));
                    path += (i === 0 ? 'M ' : ' L ') + fmtNum(x, 2) + ' ' + fmtNum(y, 2);
                }
                return '<svg class="exp-spark" viewBox="0 0 220 56" role="img" aria-label="Trend sparkline">' +
                    '<rect x="1" y="1" width="218" height="54" rx="8" fill="rgba(148,163,184,0.08)" stroke="rgba(148,163,184,0.25)"></rect>' +
                    '<path d="' + path + '" fill="none" stroke="' + color + '" stroke-width="2"></path>' +
                    '</svg>';
            }

            function explorerDuration(ms) {
                var sec = Math.max(0, Math.round(ms / 1000));
                var min = Math.floor(sec / 60);
                var rem = sec % 60;
                return min + 'm ' + rem + 's';
            }

            function explorerTelemetryScore(blockKey, mapped) {
                if (!mapped) return null;
                var req = {
                    input: ['itLoadMw', 'liquidCapture', 'pumpEff', 'fanPower', 'monitoring'],
                    thermal: ['pue', 'cop', 'supplyTemp', 'returnTemp', 'liquidCapture'],
                    hydraulic: ['pumpKw', 'pumpEff', 'supplyTemp', 'returnTemp'],
                    control: ['monitoring', 'controlQuality', 'predictiveGain'],
                    cost: ['energyGwh', 'netOpex', 'carbon'],
                    compliance: ['pue', 'cop', 'carbon', 'pumpKw']
                };
                var keys = req[blockKey] || [];
                if (!keys.length) return null;
                var hit = 0;
                keys.forEach(function(k) {
                    var col = manualTelemetryColumn(k, mapped);
                    if (col) hit += 1;
                });
                return Math.round((hit / keys.length) * 100);
            }

            function explorerBlockDiagnostics(key, model, hard, inputGuard, gateEval) {
                var warn = [];
                var err = [];
                if (key === 'input') {
                    err = err.concat(inputGuard.hardStops);
                    warn = warn.concat(inputGuard.warnings);
                } else if (key === 'thermal') {
                    if (model.deltaT < 6) warn.push('delta-T below 6C.');
                    if (model.systemCop < model.input.targetCop - 1) warn.push('COP significantly below target.');
                    if (model.pue > model.input.targetPue + 0.04) warn.push('PUE gap above +0.04.');
                } else if (key === 'hydraulic') {
                    if (hard.pumpPctIt > gatherConstraintState().pumpPctMax) err.push('Pump%IT exceeds hard limit.');
                    if (model.pumpPowerKw > (model.itKw * 0.05)) warn.push('Pump power above 5% IT.');
                    if (model.flowLpm < 2000) warn.push('Low design flow for current thermal load.');
                } else if (key === 'control') {
                    if (!gateEval.g1 || !gateEval.g2 || !gateEval.g3) warn.push('One or more control gates not open.');
                    if (model.controlIndex < 75) warn.push('Control index below 75.');
                    if (model.confidence < 80) warn.push('Data confidence below 80%.');
                } else if (key === 'cost') {
                    if (baselineModel && model.netOpex > baselineModel.netOpex) warn.push('Net OPEX worse than baseline.');
                    if (model.netCarbonTons > 60000) warn.push('High annual carbon burden.');
                } else if (key === 'compliance') {
                    if (!hard.feasible) err.push('Hard constraint envelope not satisfied.');
                    if (model.scores.total < 80) warn.push('Composite compliance score below 80.');
                    if (model.riskIndex > 40) warn.push('Risk above 40.');
                }
                return { warn: warn, err: err };
            }

            function explorerUpstreamDownstream(key) {
                var maps = {
                    input: { up: ['Scenario profile', 'Telemetry import', 'Manual overrides'], down: ['Thermal solver', 'Hydraulic solver', 'Control synthesis'] },
                    thermal: { up: ['Input temps', 'Liquid capture', 'Control index'], down: ['Hydraulic flow demand', 'COP/PUE', 'Cost and carbon'] },
                    hydraulic: { up: ['Thermal load split', 'Pump curve terms', 'Pipe multiplier'], down: ['Pump overhead', 'PUE', 'Constraint pass/fail'] },
                    control: { up: ['Monitoring coverage', 'Predictive gain', 'Rule DSL'], down: ['Gate states', 'Risk modulation', 'Solver coefficients'] },
                    cost: { up: ['Energy model', 'Tariff and water', 'Heat reuse'], down: ['Net OPEX', 'Carbon economics', 'Optimization objective'] },
                    compliance: { up: ['Risk and constraints', 'Standards score terms', 'Failure mode'], down: ['Decision status', 'Audit exports', 'Action plan'] }
                };
                return maps[key] || { up: [], down: [] };
            }

            function explorerDocText(key) {
                var docs = {
                    input: 'Defines envelope and data fidelity. Validate source quality first, then adjust scenario assumptions.',
                    thermal: 'Transforms IT load into liquid/air cooling burden. Focus on delta-T, capture, and COP gap behavior.',
                    hydraulic: 'Converts thermal requirement into flow/head/pump power. Keep pump overhead below governance limit.',
                    control: 'Evaluates sensing, controller quality, and gate logic. Poor control quality increases risk and KPI volatility.',
                    cost: 'Combines energy, water, reuse, and carbon into annualized economics. Compare against baseline and tariff assumptions.',
                    compliance: 'Aggregates resilience and standard alignment. Final decision layer for feasibility and risk acceptance.'
                };
                return docs[key] || '-';
            }

            function explorerFormulaLines(key, model, hard, gateEval) {
                if (key === 'input') {
                    return [
                        'itLoadMw=' + fmtNum(model.input.itLoadMw, 2) + ' | rackCount=' + fmtNum(model.input.rackCount, 0),
                        'capture=' + fmtNum(model.input.liquidCapture, 1) + '% | monitoring=' + fmtNum(model.input.monitoring, 0) + '%',
                        'target PUE=' + fmtNum(model.input.targetPue, 3) + ' | target COP=' + fmtNum(model.input.targetCop, 2)
                    ];
                }
                if (key === 'thermal') {
                    return [
                        'deltaT=' + fmtNum(model.input.returnTemp - model.input.supplyTemp, 2) + 'C -> effective ' + fmtNum(model.deltaT, 2) + 'C',
                        'liquidKw=' + fmtNum(model.liquidKw, 0) + ' | airKw=' + fmtNum(model.airKw, 0),
                        'COP=' + fmtNum(model.systemCop, 2) + ' | PUE=' + fmtNum(model.pue, 3)
                    ];
                }
                if (key === 'hydraulic') {
                    return [
                        'flowLpm=' + fmtNum(model.flowLpm, 0) + ' | pump=' + fmtNum(model.pumpPowerKw, 1) + 'kW',
                        'pump%IT=' + fmtNum(hard.pumpPctIt, 2) + '%',
                        'head=' + fmtNum(model.internals.pumpHeadEff, 2) + 'm | pipe=' + fmtNum(model.input.coefPipeLoss, 2) + 'x'
                    ];
                }
                if (key === 'control') {
                    return [
                        'controlIndex=' + fmtNum(model.controlIndex, 1) + '/100 | confidence=' + fmtNum(model.confidence, 0) + '%',
                        'G1=' + (gateEval.g1 ? 'OPEN' : 'ADJ') + ' | G2=' + (gateEval.g2 ? 'OPEN' : 'LIM') + ' | G3=' + (gateEval.g3 ? 'OPEN' : 'ACT'),
                        'rule G1=' + compactRuleText(gateRules.g1, 58)
                    ];
                }
                if (key === 'cost') {
                    return [
                        'annualGwh=' + fmtNum(model.annualGwh, 2) + ' | netOpex=' + fmtUsd(model.netOpex),
                        'energyCost=' + fmtUsd(model.annualEnergyCost) + ' | waterCost=' + fmtUsd(model.annualWaterCost),
                        'heatReuseCredit=' + fmtUsd(model.heatReuseCredit) + ' | carbon=' + fmtNum(model.netCarbonTons, 0) + ' tCO2e'
                    ];
                }
                return [
                    'composite=' + fmtNum(model.scores.total, 1) + '/100 | risk=' + fmtNum(model.riskIndex, 1) + '/100',
                    'ASH=' + fmtNum(model.scores.ashrae, 0) + ' | ANSI=' + fmtNum(model.scores.ansi, 0) + ' | ISO=' + fmtNum(model.scores.iso, 0),
                    'hardConstraints=' + (hard.feasible ? 'PASS' : 'FAIL (' + hard.issues.join(', ') + ')')
                ];
            }

            function explorerStepRows(key, model, hard, gateEval) {
                var rows = [];
                if (key === 'input') {
                    rows = [
                        { t: 'Validate mandatory numeric inputs and bounds', s: 'ok' },
                        { t: 'Resolve source tags (manual/preset/telemetry)', s: latestTelemetryParsed ? 'ok' : 'warn' },
                        { t: 'Check realism guardrails before solver run', s: evaluateInputHardRules(model.input, model, gatherConstraintState()).blocked ? 'err' : 'ok' }
                    ];
                } else if (key === 'thermal') {
                    rows = [
                        { t: 'Compute effective capture and load split', s: 'ok' },
                        { t: 'Solve delta-T and cooling power terms', s: model.deltaT < 6 ? 'warn' : 'ok' },
                        { t: 'Propagate COP/PUE gaps to impact layer', s: (model.pueGap > 0.04 || model.copGap < -0.8) ? 'warn' : 'ok' }
                    ];
                } else if (key === 'hydraulic') {
                    rows = [
                        { t: 'Compute design flow and redundancy multiplier', s: 'ok' },
                        { t: 'Compute hydraulic and pump electrical power', s: hard.pumpPctIt > gatherConstraintState().pumpPctMax ? 'err' : 'ok' },
                        { t: 'Feed pump overhead to energy and constraints', s: 'ok' }
                    ];
                } else if (key === 'control') {
                    rows = [
                        { t: 'Build control index from monitoring/tuning', s: model.controlIndex >= 75 ? 'ok' : 'warn' },
                        { t: 'Evaluate G1/G2/G3 DSL gate rules', s: (gateEval.g1 && gateEval.g2 && gateEval.g3) ? 'ok' : 'warn' },
                        { t: 'Inject gate effects to risk and actions', s: 'ok' }
                    ];
                } else if (key === 'cost') {
                    rows = [
                        { t: 'Convert facility load to annual energy and cost', s: 'ok' },
                        { t: 'Apply heat-reuse credit and net OPEX', s: model.netOpex < model.annualOpex ? 'ok' : 'warn' },
                        { t: 'Quantify annual carbon and avoided carbon', s: 'ok' }
                    ];
                } else {
                    rows = [
                        { t: 'Aggregate standards and resilience scores', s: model.scores.total >= 80 ? 'ok' : 'warn' },
                        { t: 'Evaluate hard constraints and risk envelope', s: hard.feasible ? 'ok' : 'err' },
                        { t: 'Generate decision status and audit signals', s: 'ok' }
                    ];
                }
                return rows;
            }

            function explorerSummaryForBlock(key, model, hard, gateEval) {
                if (key === 'input') return 'IT ' + fmtNum(model.input.itLoadMw, 1) + 'MW | capture ' + fmtNum(model.input.liquidCapture, 1) + '% | monitoring ' + fmtNum(model.input.monitoring, 0) + '%';
                if (key === 'thermal') return 'deltaT ' + fmtNum(model.deltaT, 2) + 'C | COP ' + fmtNum(model.systemCop, 2) + ' | PUE ' + fmtNum(model.pue, 3);
                if (key === 'hydraulic') return 'flow ' + fmtNum(model.flowLpm, 0) + ' LPM | pump ' + fmtNum(model.pumpPowerKw, 1) + 'kW | pump%IT ' + fmtNum(hard.pumpPctIt, 2) + '%';
                if (key === 'control') return 'ctrlIdx ' + fmtNum(model.controlIndex, 1) + ' | gates ' + (gateEval.g1 ? 'G1' : '!G1') + '/' + (gateEval.g2 ? 'G2' : '!G2') + '/' + (gateEval.g3 ? 'G3' : '!G3');
                if (key === 'cost') return 'net OPEX ' + fmtUsd(model.netOpex) + ' | carbon ' + fmtNum(model.netCarbonTons, 0) + ' tCO2e';
                return 'score ' + fmtNum(model.scores.total, 1) + '/100 | risk ' + fmtNum(model.riskIndex, 1) + '/100';
            }

            function explorerPrevDeltaLine(key, model) {
                if (explorerRunHistory.length < 2) return 'Delta vs previous run: n/a';
                var prev = explorerRunHistory[explorerRunHistory.length - 2];
                if (key === 'input') return 'Delta vs previous run: IT ' + signed(model.input.itLoadMw - prev.itLoad, 2, ' MW') + ' | capture ' + signed(model.effectiveCapture - prev.capture, 1, ' pts');
                if (key === 'thermal') return 'Delta vs previous run: PUE ' + signed(model.pue - prev.pue, 3, '') + ' | COP ' + signed(model.systemCop - prev.cop, 2, '');
                if (key === 'hydraulic') return 'Delta vs previous run: flow ' + signed(model.flowLpm - prev.flow, 0, ' LPM') + ' | pump ' + signed(model.pumpPowerKw - prev.pump, 1, ' kW');
                if (key === 'control') return 'Delta vs previous run: controlIdx ' + signed(model.controlIndex - prev.control, 1, '') + ' | risk ' + signed(model.riskIndex - prev.risk, 1, '');
                if (key === 'cost') return 'Delta vs previous run: OPEX ' + signed(model.netOpex - prev.opex, 0, ' USD/yr') + ' | carbon ' + signed(model.netCarbonTons - prev.carbon, 0, ' tCO2e');
                return 'Delta vs previous run: score ' + signed(model.scores.total - prev.score, 1, '') + ' | risk ' + signed(model.riskIndex - prev.risk, 1, '');
            }

            function explorerSuggestedAction(key, model) {
                if (key === 'input') return 'Raise monitoring coverage and validate telemetry source tags.';
                if (key === 'thermal') return 'Increase liquid capture and target higher delta-T envelope.';
                if (key === 'hydraulic') return 'Improve pump efficiency and reduce hydraulic margin where safe.';
                if (key === 'control') return 'Increase control quality/predictive tuning and re-check gate thresholds.';
                if (key === 'cost') return 'Increase economizer and heat-reuse share to reduce net OPEX.';
                return 'Reduce risk contributors: redundancy, fire strategy, and maintainability posture.';
            }

            function applyExplorerSuggestion(key) {
                if (key === 'input') {
                    document.getElementById('inMonitoring').value = fmtNum(clamp(n('inMonitoring') + 4, 0, 100), 0);
                    document.getElementById('inControlQuality').value = fmtNum(clamp(n('inControlQuality') + 2, 0, 100), 0);
                } else if (key === 'thermal') {
                    document.getElementById('inLiquidCapture').value = fmtNum(clamp(n('inLiquidCapture') + 3, 0, 100), 0);
                    document.getElementById('inReturnTemp').value = fmtNum(clamp(n('inReturnTemp') + 0.8, n('inSupplyTemp') + 5, 55), 1);
                } else if (key === 'hydraulic') {
                    document.getElementById('inPumpEff').value = fmtNum(clamp(n('inPumpEff') + 3, 35, 95), 0);
                    document.getElementById('inHydraulicMargin').value = fmtNum(clamp(n('inHydraulicMargin') - 2, 0, 45), 0);
                } else if (key === 'control') {
                    document.getElementById('inControlQuality').value = fmtNum(clamp(n('inControlQuality') + 4, 0, 100), 0);
                    document.getElementById('inPredictiveGain').value = fmtNum(clamp(n('inPredictiveGain') + 2, 0, 60), 0);
                    document.getElementById('inMonitoring').value = fmtNum(clamp(n('inMonitoring') + 4, 0, 100), 0);
                } else if (key === 'cost') {
                    document.getElementById('inEconomizerHours').value = fmtNum(clamp(n('inEconomizerHours') + 4, 0, 95), 0);
                    document.getElementById('inHeatReuse').value = fmtNum(clamp(n('inHeatReuse') + 5, 0, 80), 0);
                } else if (key === 'compliance') {
                    document.getElementById('inConcurrent').checked = true;
                    document.getElementById('inFireType').value = 'clean_agent';
                    if (document.getElementById('inRedundancy').value === 'N') document.getElementById('inRedundancy').value = 'N1';
                }
                requestModelRun(true, true);
            }

            function explorerChecklistState(key) {
                if (!explorerState.checks[key]) {
                    explorerState.checks[key] = { qa_inputs: false, qa_dependencies: false, qa_actions: false };
                }
                return explorerState.checks[key];
            }

            function explorerNoteValue(key) {
                return explorerState.notes[key] || '';
            }

            function renderExplorerBlockDetail(key, model) {
                var host = document.getElementById('expBody-' + key);
                if (!host || !model) return;
                var constraints = gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var gateEval = evaluateGateStates(model);
                var inputGuard = evaluateInputHardRules(model.input, model, constraints);
                var diag = explorerBlockDiagnostics(key, model, hard, inputGuard, gateEval);
                var stepRows = explorerStepRows(key, model, hard, gateEval);
                var formulaRows = explorerFormulaLines(key, model, hard, gateEval);
                var io = explorerUpstreamDownstream(key);
                var telemetryScore = explorerTelemetryScore(key, latestTelemetryParsed ? latestTelemetryParsed.mapped : null);
                var checkState = explorerChecklistState(key);
                var checkDone = (checkState.qa_inputs ? 1 : 0) + (checkState.qa_dependencies ? 1 : 0) + (checkState.qa_actions ? 1 : 0);
                var trendVals = explorerTrendForBlock(key);
                var trendColor = key === 'cost' ? '#b45309' : (key === 'compliance' ? '#dc2626' : '#2563eb');
                var spark = explorerSparklineSvg(trendVals, trendColor);
                var provenance = loadLedger().filter(function(row) {
                    var lk = String(row.key || '').toLowerCase();
                    if (key === 'input') return true;
                    if (key === 'thermal') return lk.indexOf('liquid') >= 0 || lk.indexOf('aircop') >= 0;
                    if (key === 'hydraulic') return lk.indexOf('pump') >= 0 || lk.indexOf('liquid') >= 0;
                    if (key === 'control') return lk.indexOf('monitor') >= 0 || lk.indexOf('target') >= 0;
                    if (key === 'cost') return lk.indexOf('elec') >= 0 || lk.indexOf('carbon') >= 0;
                    return lk.indexOf('target') >= 0 || lk.indexOf('monitor') >= 0;
                }).slice(0, 5);
                var provenanceText = provenance.length ? provenance.map(function(p) {
                    return p.label + ' [' + p.confidence + '%]';
                }).join(' | ') : 'No provenance subset available.';
                var mcText = 'MC uncertainty not generated.';
                if (latestMonteCarlo && latestMonteCarlo.dist) {
                    var metricKey = key === 'cost' ? 'opex' : key === 'compliance' ? 'risk' : key === 'thermal' ? 'pue' : key === 'hydraulic' ? 'cop' : 'pue';
                    var arr = latestMonteCarlo.dist[metricKey] || [];
                    if (arr.length) {
                        var p10 = percentile(arr, 0.10);
                        var p50 = percentile(arr, 0.50);
                        var p90 = percentile(arr, 0.90);
                        mcText = 'MC ' + metricKey.toUpperCase() + ' P10/P50/P90: ' + fmtNum(p10, 2) + '/' + fmtNum(p50, 2) + '/' + fmtNum(p90, 2);
                    }
                }

                host.innerHTML = [
                    '<div class="exp-grid">',
                        '<article class="exp-panel"><h5>Process Steps</h5><ul class="exp-list">' + stepRows.map(function(r) { return '<li class="' + r.s + '">' + escapeHtml(r.t) + '</li>'; }).join('') + '</ul></article>',
                        '<article class="exp-panel"><h5>Formula + Values</h5><div class="exp-pre">' + escapeHtml(formulaRows.join('\n')) + '</div></article>',
                        '<article class="exp-panel"><h5>Dependencies</h5><div class="exp-pre">Upstream: ' + escapeHtml(io.up.join(' -> ')) + '\nDownstream: ' + escapeHtml(io.down.join(' -> ')) + '\nGraph: input -> thermal -> hydraulic -> control -> impact -> compliance</div></article>',
                        '<article class="exp-panel"><h5>Warnings + Root Cause</h5><ul class="exp-list">' + (diag.err.concat(diag.warn).length ? diag.err.map(function(t) { return '<li class="err">' + escapeHtml(t) + '</li>'; }).concat(diag.warn.map(function(t) { return '<li class="warn">' + escapeHtml(t) + '</li>'; })).join('') : '<li class="ok">No critical warning on current run.</li>') + '</ul><div class="exp-pre">Suggested: ' + escapeHtml(explorerSuggestedAction(key, model)) + '</div></article>',
                        '<article class="exp-panel"><h5>Trend + Uncertainty</h5>' + spark + '<div class="exp-pre">' + escapeHtml(explorerPrevDeltaLine(key, model)) + '\n' + escapeHtml(mcText) + '</div></article>',
                        '<article class="exp-panel"><h5>Governance + Docs</h5><div class="exp-pre">Telemetry coverage score: ' + (telemetryScore === null ? 'n/a' : (telemetryScore + '/100')) + '\nQA checklist completion: ' + checkDone + '/3\nProvenance: ' + escapeHtml(provenanceText) + '\nDoc: ' + escapeHtml(explorerDocText(key)) + '</div></article>',
                    '</div>',
                    '<div class="exp-actions">',
                        '<button class="btn-secondary btn-chip" type="button" data-exp-action="apply" data-block="' + key + '">Apply Suggested Fix</button>',
                        '<button class="btn-secondary btn-chip" type="button" data-exp-action="pin" data-block="' + key + '">' + (explorerState.pinned === key ? 'Unpin Block' : 'Pin Block') + '</button>',
                        '<button class="btn-secondary btn-chip" type="button" data-exp-action="selftest" data-block="' + key + '">Run Block Check</button>',
                    '</div>',
                    '<div class="exp-note">',
                        '<label for="expNote-' + key + '" class="toolbar-label">Engineering Note</label>',
                        '<textarea id="expNote-' + key + '" data-exp-note="' + key + '">' + escapeHtml(explorerNoteValue(key)) + '</textarea>',
                    '</div>',
                    '<div class="exp-checks">',
                        '<label><input type="checkbox" data-exp-check="' + key + ':qa_inputs"' + (checkState.qa_inputs ? ' checked' : '') + '> Inputs validated</label>',
                        '<label><input type="checkbox" data-exp-check="' + key + ':qa_dependencies"' + (checkState.qa_dependencies ? ' checked' : '') + '> Dependencies reviewed</label>',
                        '<label><input type="checkbox" data-exp-check="' + key + ':qa_actions"' + (checkState.qa_actions ? ' checked' : '') + '> Actions logged</label>',
                    '</div>',
                    '<div class="exp-diag" id="expDiag-' + key + '">Block diagnostics ready. Use "Run Block Check" for quick pass/fail.</div>'
                ].join('');
            }

            function explorerDetailStatusClass(key, model, hard, inputGuard, gateEval) {
                if (key === 'input') return inputGuard.blocked ? 'err' : (inputGuard.warnings.length ? 'warn' : 'ok');
                if (key === 'thermal') return model.deltaT < 6 || model.pueGap > 0.04 ? 'warn' : 'ok';
                if (key === 'hydraulic') return hard.pumpPctIt > gatherConstraintState().pumpPctMax ? 'err' : 'ok';
                if (key === 'control') return (!gateEval.g1 || !gateEval.g2 || !gateEval.g3) ? 'warn' : 'ok';
                if (key === 'cost') return baselineModel && model.netOpex > baselineModel.netOpex ? 'warn' : 'ok';
                return !hard.feasible || model.riskIndex > 40 ? 'warn' : 'ok';
            }

            function renderExplorerSummaryRows(model) {
                var constraints = gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var inputGuard = evaluateInputHardRules(model.input, model, constraints);
                var gateEval = evaluateGateStates(model);
                EXPLORER_BLOCKS.forEach(function(block) {
                    var key = block.key;
                    var sub = document.getElementById('expSub-' + key);
                    var badge = document.getElementById('expBadge-' + key);
                    var qa = explorerChecklistState(key);
                    var qaDone = (qa.qa_inputs ? 1 : 0) + (qa.qa_dependencies ? 1 : 0) + (qa.qa_actions ? 1 : 0);
                    if (sub) sub.textContent = explorerSummaryForBlock(key, model, hard, gateEval) + ' | QA ' + qaDone + '/3';
                    if (badge) {
                        var cls = explorerDetailStatusClass(key, model, hard, inputGuard, gateEval);
                        badge.className = 'status-pill ' + cls;
                        badge.textContent = cls === 'ok' ? 'OK' : (cls === 'warn' ? 'Review' : 'Block');
                    }
                });
            }

            function renderExplorerCompare(model) {
                var leftSel = document.getElementById('explorerCompareLeft');
                var rightSel = document.getElementById('explorerCompareRight');
                var titleA = document.getElementById('explorerCompareTitleA');
                var titleB = document.getElementById('explorerCompareTitleB');
                var bodyA = document.getElementById('explorerCompareBodyA');
                var bodyB = document.getElementById('explorerCompareBodyB');
                if (!leftSel || !rightSel || !titleA || !titleB || !bodyA || !bodyB || !model) return;
                var left = leftSel.value || 'input';
                var right = rightSel.value || 'thermal';
                var constraints = gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var gateEval = evaluateGateStates(model);
                titleA.textContent = getExplorerBlockLabel(left);
                titleB.textContent = getExplorerBlockLabel(right);
                bodyA.textContent = explorerSummaryForBlock(left, model, hard, gateEval) + '\n' + explorerPrevDeltaLine(left, model) + '\nDoc: ' + explorerDocText(left);
                bodyB.textContent = explorerSummaryForBlock(right, model, hard, gateEval) + '\n' + explorerPrevDeltaLine(right, model) + '\nDoc: ' + explorerDocText(right);
            }

            function explorerMostUsed() {
                var usage = explorerState.usage || {};
                var rows = Object.keys(usage).map(function(k) {
                    var u = usage[k] || {};
                    return { key: k, opens: u.opens || 0, ms: u.ms || 0 };
                }).sort(function(a, b) { return b.opens - a.opens; });
                return rows[0] || null;
            }

            function renderExplorerMeta(model) {
                var meta = document.getElementById('explorerMeta');
                var stat = document.getElementById('explorerStatus');
                if (!meta || !stat || !model) return;
                var open = (explorerState.openBlocks || []).join(', ') || '-';
                var most = explorerMostUsed();
                var usage = explorerState.usage || {};
                var totalMs = 0;
                Object.keys(usage).forEach(function(k) { totalMs += (usage[k] && usage[k].ms) ? usage[k].ms : 0; });
                meta.textContent = [
                    'Mode=' + explorerState.mode + ' | Focus=' + (explorerState.focus ? 'ON' : 'OFF') + ' | Open=' + open,
                    'Most opened block=' + (most ? (getExplorerBlockLabel(most.key) + ' (' + most.opens + 'x)') : 'n/a'),
                    'Accumulated open time=' + explorerDuration(totalMs) + ' | runHistory=' + explorerRunHistory.length
                ].join('\n');
                stat.className = 'status-pill ok';
                stat.textContent = 'Explorer Live | active=' + getExplorerBlockLabel(explorerState.lastActive || 'input');
            }

            function explorerCloseOtherBlocks(activeKey) {
                if (explorerState.mode !== 'single') return;
                EXPLORER_BLOCKS.forEach(function(block) {
                    if (block.key === activeKey) return;
                    var d = document.getElementById('expBlock-' + block.key);
                    if (d && d.open) d.open = false;
                });
                explorerState.openBlocks = [activeKey];
            }

            function explorerTogglePin(key) {
                var prev = explorerState.pinned || '';
                if (prev === key) explorerState.pinned = '';
                else explorerState.pinned = key;
                EXPLORER_BLOCKS.forEach(function(block) {
                    var d = document.getElementById('expBlock-' + block.key);
                    if (!d) return;
                    d.classList.toggle('pinned', explorerState.pinned === block.key);
                });
                saveExplorerState();
                renderExplorerWithModel(explorerCurrentModel);
            }

            function explorerRunBlockCheck(key) {
                var model = explorerCurrentModel;
                if (!model) return;
                var constraints = gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var gateEval = evaluateGateStates(model);
                var inputGuard = evaluateInputHardRules(model.input, model, constraints);
                var diag = explorerBlockDiagnostics(key, model, hard, inputGuard, gateEval);
                var fail = diag.err.length > 0;
                var warn = !fail && diag.warn.length > 0;
                var box = document.getElementById('expDiag-' + key);
                if (!box) return;
                box.textContent = fail
                    ? ('Block check FAIL: ' + diag.err.join(' | '))
                    : (warn ? ('Block check WARN: ' + diag.warn.join(' | ')) : 'Block check PASS: no material issue detected.');
            }

            function parseExplorerHashState() {
                var h = String(location.hash || '');
                if (h.indexOf('#bx=') !== 0) return;
                var body = h.slice(4);
                var parts = body.split(';');
                var nextOpen = [];
                parts.forEach(function(p) {
                    var s = p.split('=');
                    var k = s[0];
                    var v = s.slice(1).join('=');
                    if (k === 'open') {
                        nextOpen = v ? v.split(',').filter(function(x) { return EXPLORER_BLOCKS.some(function(b) { return b.key === x; }); }) : [];
                    } else if (k === 'mode') {
                        explorerState.mode = v === 'multi' ? 'multi' : 'single';
                    } else if (k === 'focus') {
                        explorerState.focus = v === '1';
                    } else if (k === 'active') {
                        explorerState.lastActive = v || explorerState.lastActive;
                    }
                });
                if (nextOpen.length) explorerState.openBlocks = nextOpen;
                saveExplorerState();
            }

            function updateExplorerHashState() {
                var hash = '#bx=' +
                    'open=' + (explorerState.openBlocks || []).join(',') +
                    ';mode=' + explorerState.mode +
                    ';focus=' + (explorerState.focus ? '1' : '0') +
                    ';active=' + (explorerState.lastActive || 'input');
                if (location.hash !== hash) {
                    history.replaceState(null, '', location.pathname + location.search + hash);
                }
            }

            function explorerCopyDeepLink() {
                updateExplorerHashState();
                var link = location.href;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(link).then(function() {
                        var diag = document.getElementById('explorerDiag');
                        if (diag) diag.textContent = 'Deep link copied to clipboard.';
                    }).catch(function() {
                        alert('Copy failed. Link:\n' + link);
                    });
                } else {
                    alert('Deep link:\n' + link);
                }
            }

            function explorerExportJson() {
                var model = explorerCurrentModel || baselineModel;
                if (!model) {
                    alert('Run model first before export.');
                    return;
                }
                var constraints = gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var gateEval = evaluateGateStates(model);
                var data = {
                    generatedAt: nowIso(),
                    explorerState: explorerState,
                    currentModel: {
                        pue: model.pue,
                        cop: model.systemCop,
                        netOpex: model.netOpex,
                        risk: model.riskIndex,
                        score: model.scores.total
                    },
                    hardConstraints: hard,
                    gates: gateEval,
                    history: explorerRunHistory.slice(-80),
                    telemetryHeaders: latestTelemetryParsed ? latestTelemetryParsed.headers : [],
                    blocks: EXPLORER_BLOCKS.map(function(b) {
                        return {
                            key: b.key,
                            label: b.label,
                            note: explorerNoteValue(b.key),
                            checks: explorerChecklistState(b.key),
                            summary: explorerSummaryForBlock(b.key, model, hard, gateEval),
                            doc: explorerDocText(b.key)
                        };
                    })
                };
                downloadTextFile('ltc-block-explorer.json', JSON.stringify(data, null, 2));
            }

            function explorerExportReport() {
                var model = explorerCurrentModel || baselineModel;
                if (!model) {
                    alert('Run model first before export.');
                    return;
                }
                var constraints = gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var gateEval = evaluateGateStates(model);
                var lines = [];
                lines.push('# Block Explorer Report');
                lines.push('Generated: ' + nowIso());
                lines.push('Mode: ' + explorerState.mode + ' | Focus: ' + (explorerState.focus ? 'ON' : 'OFF'));
                lines.push('Current KPI: PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2) + ' | Net OPEX ' + fmtUsd(model.netOpex) + ' | Risk ' + fmtNum(model.riskIndex, 1));
                lines.push('Hard constraints: ' + (hard.feasible ? 'PASS' : hard.issues.join(', ')));
                lines.push('');
                EXPLORER_BLOCKS.forEach(function(b) {
                    var key = b.key;
                    lines.push('## ' + b.label);
                    lines.push('- Summary: ' + explorerSummaryForBlock(key, model, hard, gateEval));
                    lines.push('- Delta: ' + explorerPrevDeltaLine(key, model));
                    lines.push('- Note: ' + explorerNoteValue(key));
                    var c = explorerChecklistState(key);
                    lines.push('- QA: inputs=' + (c.qa_inputs ? 'yes' : 'no') + ', deps=' + (c.qa_dependencies ? 'yes' : 'no') + ', actions=' + (c.qa_actions ? 'yes' : 'no'));
                    lines.push('- Doc: ' + explorerDocText(key));
                    lines.push('');
                });
                downloadTextFile('ltc-block-explorer-report.txt', lines.join('\n'));
            }

            function parseCssRgb(str) {
                var m = String(str || '').match(/rgba?\(([^)]+)\)/);
                if (!m) return null;
                var p = m[1].split(',').map(function(x) { return parseFloat(String(x).trim()); });
                if (!p.length) return null;
                return { r: p[0] || 0, g: p[1] || 0, b: p[2] || 0 };
            }

            function relativeLum(rgb) {
                function cv(v) {
                    var c = v / 255;
                    return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
                }
                var r = cv(rgb.r);
                var g = cv(rgb.g);
                var b = cv(rgb.b);
                return (0.2126 * r) + (0.7152 * g) + (0.0722 * b);
            }

            function contrastRatio(fg, bg) {
                var l1 = relativeLum(fg);
                var l2 = relativeLum(bg);
                var hi = Math.max(l1, l2);
                var lo = Math.min(l1, l2);
                return (hi + 0.05) / (lo + 0.05);
            }

            function runExplorerDiagnostics() {
                var diag = document.getElementById('explorerDiag');
                if (!diag) return;
                var truncIds = [
                    'diagInputMain', 'diagInputSub', 'diagThermalMain', 'diagThermalSub',
                    'diagHydraulicMain', 'diagHydraulicSub', 'diagImpactMain', 'diagImpactSub',
                    'diagCostMain', 'diagCostSub', 'diagControlMain', 'diagControlSub',
                    'diagComplianceMain', 'diagComplianceSub', 'ctrlGateASub', 'ctrlGateBSub', 'ctrlGateCSub'
                ];
                var trunc = [];
                truncIds.forEach(function(id) {
                    var el = document.getElementById(id);
                    if (!el) return;
                    var txt = String(el.textContent || '');
                    if (txt.indexOf('') >= 0 || txt.indexOf('...') >= 0) trunc.push(id);
                });

                var sample = document.getElementById('diagImpactMain');
                var ratio = null;
                if (sample) {
                    var fg = parseCssRgb(getComputedStyle(sample).color);
                    var bgEl = sample.closest('.model-block') || sample.parentElement;
                    var bg = bgEl ? parseCssRgb(getComputedStyle(bgEl).backgroundColor) : null;
                    if (fg && bg) ratio = contrastRatio(fg, bg);
                }

                var lines = [];
                lines.push('Diagnostics @ ' + nowIso());
                lines.push('Truncation check: ' + (trunc.length ? ('FAIL -> ' + trunc.join(', ')) : 'PASS'));
                lines.push('Contrast sample (diagImpactMain): ' + (ratio ? fmtNum(ratio, 2) + ':1' : 'n/a'));
                lines.push('Dark mode: ' + (document.documentElement.getAttribute('data-theme') === 'dark' ? 'ON' : 'OFF'));
                diag.textContent = lines.join('\n');
            }

            function ensureExplorerCompareSelectors() {
                var left = document.getElementById('explorerCompareLeft');
                var right = document.getElementById('explorerCompareRight');
                if (!left || !right) return;
                if (!left.options.length) {
                    left.innerHTML = EXPLORER_BLOCKS.map(function(b) { return '<option value="' + b.key + '">' + b.label + '</option>'; }).join('');
                }
                if (!right.options.length) {
                    right.innerHTML = EXPLORER_BLOCKS.map(function(b) { return '<option value="' + b.key + '">' + b.label + '</option>'; }).join('');
                }
                if (!left.value) left.value = explorerState.lastActive || 'input';
                if (!right.value || right.value === left.value) right.value = left.value === 'thermal' ? 'cost' : 'thermal';
            }

            function buildExplorerAccordionSkeleton() {
                var wrap = document.getElementById('explorerAccordion');
                if (!wrap) return;
                wrap.innerHTML = EXPLORER_BLOCKS.map(function(b) {
                    return '' +
                        '<details class="exp-block" id="expBlock-' + b.key + '" data-block="' + b.key + '">' +
                            '<summary>' +
                                '<div class="exp-head">' +
                                    '<span class="exp-title">[' + (EXPLORER_BLOCKS.findIndex(function(x) { return x.key === b.key; }) + 1) + '] ' + b.label + '</span>' +
                                    '<span class="exp-tags"><span class="status-pill" id="expBadge-' + b.key + '">Pending</span></span>' +
                                '</div>' +
                                '<div class="exp-sub" id="expSub-' + b.key + '">Run model to generate summary.</div>' +
                            '</summary>' +
                            '<div class="exp-body" id="expBody-' + b.key + '"><div class="exp-skeleton"></div></div>' +
                        '</details>';
                }).join('');

                EXPLORER_BLOCKS.forEach(function(b) {
                    var d = document.getElementById('expBlock-' + b.key);
                    if (!d) return;
                    if ((explorerState.openBlocks || []).indexOf(b.key) >= 0) d.open = true;
                    d.classList.toggle('pinned', explorerState.pinned === b.key);
                    d.addEventListener('toggle', function() {
                        var key = d.getAttribute('data-block');
                        explorerState.lastActive = key;
                        if (d.open) {
                            explorerCloseOtherBlocks(key);
                            if ((explorerState.openBlocks || []).indexOf(key) < 0) explorerState.openBlocks.push(key);
                            if (!explorerState.usage[key]) explorerState.usage[key] = { opens: 0, ms: 0, lastOpened: '' };
                            explorerState.usage[key].opens += 1;
                            explorerState.usage[key].lastOpened = nowIso();
                            explorerOpenTimer[key] = Date.now();
                            var body = document.getElementById('expBody-' + key);
                            if (body) body.innerHTML = '<div class="exp-skeleton"></div>';
                            setTimeout(function() { renderExplorerBlockDetail(key, explorerCurrentModel || baselineModel); }, 40);
                            if (explorerCurrentModel) renderExplorerWithModel(explorerCurrentModel);
                        } else {
                            explorerState.openBlocks = (explorerState.openBlocks || []).filter(function(k) { return k !== key; });
                            if (explorerOpenTimer[key] && explorerState.usage[key]) {
                                explorerState.usage[key].ms += Math.max(0, Date.now() - explorerOpenTimer[key]);
                                delete explorerOpenTimer[key];
                            }
                        }
                        saveExplorerState();
                        updateExplorerHashState();
                    });
                });
            }

            function renderExplorerControls() {
                var modeBtn = document.getElementById('explorerToggleMode');
                var focusBtn = document.getElementById('explorerFocusToggle');
                if (modeBtn) modeBtn.textContent = explorerState.mode === 'single' ? 'Mode: Single Open' : 'Mode: Multi Open';
                if (focusBtn) focusBtn.textContent = explorerState.focus ? 'Exit Focus' : 'Focus Explorer';
                document.body.classList.toggle('explorer-focus', !!explorerState.focus);
            }

            function renderExplorerWithModel(model) {
                if (!model) return;
                explorerCurrentModel = model;
                registerExplorerRun(model);
                ensureExplorerCompareSelectors();
                renderExplorerControls();
                renderExplorerSummaryRows(model);
                renderExplorerMeta(model);
                renderExplorerCompare(model);
                EXPLORER_BLOCKS.forEach(function(b) {
                    var d = document.getElementById('expBlock-' + b.key);
                    if (d && d.open) renderExplorerBlockDetail(b.key, model);
                });
            }

            function initExplorerUI() {
                parseExplorerHashState();
                buildExplorerAccordionSkeleton();
                ensureExplorerCompareSelectors();
                renderExplorerControls();

                var wrap = document.getElementById('explorerAccordion');
                if (wrap) {
                    wrap.addEventListener('input', function(ev) {
                        var t = ev.target;
                        if (!t) return;
                        if (t.hasAttribute('data-exp-note')) {
                            var key = t.getAttribute('data-exp-note');
                            explorerState.notes[key] = String(t.value || '');
                            saveExplorerState();
                            return;
                        }
                        if (t.hasAttribute('data-exp-check')) {
                            var raw = t.getAttribute('data-exp-check');
                            var parts = raw.split(':');
                            if (parts.length === 2) {
                                var key2 = parts[0];
                                var flag = parts[1];
                                var c = explorerChecklistState(key2);
                                c[flag] = !!t.checked;
                                saveExplorerState();
                                if (explorerCurrentModel) renderExplorerWithModel(explorerCurrentModel);
                            }
                        }
                    });
                    wrap.addEventListener('click', function(ev) {
                        var btn = ev.target && ev.target.closest ? ev.target.closest('button[data-exp-action]') : null;
                        if (!btn) return;
                        var action = btn.getAttribute('data-exp-action');
                        var key = btn.getAttribute('data-block');
                        if (!action || !key) return;
                        if (action === 'apply') applyExplorerSuggestion(key);
                        else if (action === 'pin') explorerTogglePin(key);
                        else if (action === 'selftest') explorerRunBlockCheck(key);
                    });
                }

                document.getElementById('explorerExpandAll').addEventListener('click', function() {
                    explorerState.mode = 'multi';
                    explorerState.openBlocks = EXPLORER_BLOCKS.map(function(b) { return b.key; });
                    EXPLORER_BLOCKS.forEach(function(b) {
                        var d = document.getElementById('expBlock-' + b.key);
                        if (d) d.open = true;
                    });
                    saveExplorerState();
                    renderExplorerControls();
                    updateExplorerHashState();
                    if (explorerCurrentModel) renderExplorerWithModel(explorerCurrentModel);
                });
                document.getElementById('explorerCollapseAll').addEventListener('click', function() {
                    explorerState.openBlocks = [];
                    EXPLORER_BLOCKS.forEach(function(b) {
                        var d = document.getElementById('expBlock-' + b.key);
                        if (d) d.open = false;
                    });
                    saveExplorerState();
                    updateExplorerHashState();
                });
                document.getElementById('explorerToggleMode').addEventListener('click', function() {
                    explorerState.mode = explorerState.mode === 'single' ? 'multi' : 'single';
                    if (explorerState.mode === 'single' && explorerState.openBlocks.length > 1) {
                        explorerState.openBlocks = [explorerState.openBlocks[0]];
                        EXPLORER_BLOCKS.forEach(function(b) {
                            var d = document.getElementById('expBlock-' + b.key);
                            if (d) d.open = explorerState.openBlocks[0] === b.key;
                        });
                    }
                    saveExplorerState();
                    renderExplorerControls();
                    updateExplorerHashState();
                });
                document.getElementById('explorerFocusToggle').addEventListener('click', function() {
                    explorerState.focus = !explorerState.focus;
                    saveExplorerState();
                    renderExplorerControls();
                    updateExplorerHashState();
                    var block = document.getElementById('modellingExplorer');
                    if (block && block.scrollIntoView) block.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
                document.getElementById('explorerCopyLink').addEventListener('click', explorerCopyDeepLink);
                document.getElementById('explorerExportJson').addEventListener('click', explorerExportJson);
                document.getElementById('explorerExportReport').addEventListener('click', explorerExportReport);
                document.getElementById('explorerRunDiag').addEventListener('click', runExplorerDiagnostics);
                document.getElementById('explorerSwapCompare').addEventListener('click', function() {
                    var l = document.getElementById('explorerCompareLeft');
                    var r = document.getElementById('explorerCompareRight');
                    if (!l || !r) return;
                    var tmp = l.value;
                    l.value = r.value;
                    r.value = tmp;
                    if (explorerCurrentModel) renderExplorerCompare(explorerCurrentModel);
                });
                document.getElementById('explorerCompareLeft').addEventListener('change', function() {
                    if (explorerCurrentModel) renderExplorerCompare(explorerCurrentModel);
                });
                document.getElementById('explorerCompareRight').addEventListener('change', function() {
                    if (explorerCurrentModel) renderExplorerCompare(explorerCurrentModel);
                });

                document.addEventListener('keydown', function(ev) {
                    var tag = ev.target && ev.target.tagName ? ev.target.tagName.toLowerCase() : '';
                    if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
                    var nkey = parseInt(ev.key, 10);
                    if (!isFinite(nkey) || nkey < 1 || nkey > EXPLORER_BLOCKS.length) return;
                    var block = EXPLORER_BLOCKS[nkey - 1];
                    var d = document.getElementById('expBlock-' + block.key);
                    if (!d) return;
                    d.open = true;
                    explorerState.lastActive = block.key;
                    explorerCloseOtherBlocks(block.key);
                    saveExplorerState();
                    updateExplorerHashState();
                    if (d.scrollIntoView) d.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });

                window.addEventListener('hashchange', function() {
                    parseExplorerHashState();
                    renderExplorerControls();
                    EXPLORER_BLOCKS.forEach(function(b) {
                        var d = document.getElementById('expBlock-' + b.key);
                        if (d) d.open = (explorerState.openBlocks || []).indexOf(b.key) >= 0;
                    });
                    if (explorerCurrentModel) renderExplorerWithModel(explorerCurrentModel);
                });
            }

            function scheduleAutoRun(resetOptimization) {
                if (!autoRunEnabled) return;
                clearAutoRunTimer();
                autoRunTimer = setTimeout(function() {
                    autoRunTimer = null;
                    runModel(resetOptimization);
                }, autoRunDebounceMs);
            }

            function requestModelRun(resetOptimization, forceNow) {
                if (forceNow === void 0) forceNow = false;
                if (forceNow) {
                    clearAutoRunTimer();
                    runModel(resetOptimization);
                    return;
                }
                scheduleAutoRun(resetOptimization);
            }

            function applyCountryProfile() {
                var key = document.getElementById('inCountryProfile').value;
                var profile = COUNTRY_PROFILES[key];
                if (!profile || key === 'custom') {
                    requestModelRun(true, false);
                    return;
                }
                document.getElementById('inClimate').value = profile.climate;
                document.getElementById('inElecPrice').value = profile.elecPrice;
                document.getElementById('inWaterTariff').value = profile.waterTariff;
                document.getElementById('inAirCop').value = profile.airCop;
                document.getElementById('inTargetPue').value = profile.targetPue;
                document.getElementById('inTargetCop').value = profile.targetCop;
                document.getElementById('inEconomizerHours').value = profile.economizerHours;
                document.getElementById('inCarbonIntensity').value = profile.carbonIntensity;
                document.getElementById('inUpsEff').value = profile.upsEff;
                document.getElementById('inDistLoss').value = profile.distLoss;
                requestModelRun(true, false);
            }

            function setCoolingArchitectureNote(key) {
                var noteEl = document.getElementById('coolingArchNote');
                if (!noteEl) return;
                noteEl.textContent = COOLING_ARCH_NOTES[key] || COOLING_ARCH_NOTES.manual;
            }

            function applyCoolingArchitecturePreset() {
                var key = document.getElementById('inCoolingArchitecture').value;
                setCoolingArchitectureNote(key);
                var preset = COOLING_ARCH_PROFILES[key];
                if (!preset || key === 'manual') {
                    requestModelRun(true, false);
                    return;
                }
                if (preset.rackType) document.getElementById('inRackType').value = preset.rackType;
                if (preset.liquidCapture !== undefined) document.getElementById('inLiquidCapture').value = preset.liquidCapture;
                if (preset.supplyTemp !== undefined) document.getElementById('inSupplyTemp').value = preset.supplyTemp;
                if (preset.returnTemp !== undefined) document.getElementById('inReturnTemp').value = preset.returnTemp;
                if (preset.airCop !== undefined) document.getElementById('inAirCop').value = preset.airCop;
                if (preset.fanPower !== undefined) document.getElementById('inFanPower').value = preset.fanPower;
                if (preset.economizerHours !== undefined) document.getElementById('inEconomizerHours').value = preset.economizerHours;
                if (preset.coefHeatTransfer !== undefined) document.getElementById('inCoefHeatTransfer').value = preset.coefHeatTransfer;
                if (preset.coefPipeLoss !== undefined) document.getElementById('inCoefPipeLoss').value = preset.coefPipeLoss;
                requestModelRun(true, false);
            }

            function optimizeObjective(model, input, constraints) {
                var pueErr = model.pue - input.targetPue;
                var copErr = input.targetCop - model.systemCop;
                var pueRel = Math.abs(pueErr) / Math.max(input.targetPue, 1);
                var copRel = Math.abs(copErr) / Math.max(input.targetCop, 1);
                var score = 0;
                score += pueRel * 1350;
                score += copRel * 920;
                score += Math.max(0, pueErr) * 260;
                score += Math.max(0, copErr) * 220;
                score += model.riskIndex * 1.05;
                score += (model.netOpex / 1000000) * 0.12;
                score += (model.netCarbonTons / 1000) * 0.14;
                score += Math.abs(model.designDensity - input.rackDensityTarget) * 0.09;
                score += Math.max(0, model.pumpPowerKw - (input.itLoadMw * 1000 * 0.03)) * 0.32;
                if (model.pue > input.targetPue + 0.015) score += 18;
                if (model.systemCop < input.targetCop - 0.12) score += 14;
                if (model.riskIndex > 40) score += (model.riskIndex - 40) * 1.6;
                if (constraints) {
                    var hard = evaluateHardConstraints(model, constraints);
                    if (constraints.enforce && !hard.feasible) score += 100000 + hard.issues.length * 5000;
                    else if (!hard.feasible) score += hard.issues.length * 2500;
                }
                return score;
            }

            function randomInRange(min, max, step) {
                var raw = min + (Math.random() * (max - min));
                if (step > 0) raw = Math.round(raw / step) * step;
                return clamp(raw, min, max);
            }

            function optimizeToTarget() {
                if (!enforceActionGuard('Optimize To Target')) return;
                var input = gatherInputs();
                var constraints = gatherConstraintState();
                var base = computeModel(input);
                baselineModel = base;
                latestPareto = [];
                selectedParetoIdx = -1;
                latestMonteCarlo = null;
                if (calibrationState) calibrationDirty = true;

                var best = base;
                var bestInput = Object.assign({}, input);
                var bestScore = optimizeObjective(base, input, constraints);
                var baseDeltaT = Math.max(input.returnTemp - input.supplyTemp, 6);
                var tunables = [
                    { key: 'liquidCapture', min: 40, max: 99, step: 1, span: 22 },
                    { key: 'rackDensityTarget', min: 8, max: 180, step: 1, span: 18 },
                    { key: 'highDensityShare', min: 0, max: 100, step: 1, span: 30 },
                    { key: 'supplyTemp', min: 20, max: 40, step: 0.5, span: 4.5 },
                    { key: 'airCop', min: 2.1, max: 12, step: 0.1, span: 1.9 },
                    { key: 'pumpEff', min: 56, max: 95, step: 1, span: 10 },
                    { key: 'economizerHours', min: 0, max: 95, step: 1, span: 18 },
                    { key: 'heatReuse', min: 0, max: 80, step: 1, span: 18 },
                    { key: 'hydraulicMargin', min: 0, max: 35, step: 1, span: 8 },
                    { key: 'controlQuality', min: 30, max: 100, step: 1, span: 12 },
                    { key: 'predictiveGain', min: 0, max: 60, step: 1, span: 12 },
                    { key: 'coefHeatTransfer', min: 72, max: 99, step: 0.5, span: 5.5 },
                    { key: 'coefCduLoss', min: 0.5, max: 4.5, step: 0.05, span: 0.7 },
                    { key: 'coefPipeLoss', min: 0.78, max: 1.65, step: 0.01, span: 0.14 },
                    { key: 'coefFutureTech', min: -6, max: 45, step: 1, span: 8 }
                ];

                function candidateFrom(anchor, scale, exploreGlobal) {
                    var candidate = Object.assign({}, anchor);
                    tunables.forEach(function(cfg) {
                        var center = exploreGlobal ? input[cfg.key] : anchor[cfg.key];
                        var low = Math.max(cfg.min, center - (cfg.span * scale));
                        var high = Math.min(cfg.max, center + (cfg.span * scale));
                        candidate[cfg.key] = randomInRange(low, high, cfg.step);
                    });
                    var deltaTarget = randomInRange(Math.max(6, baseDeltaT - (1.4 * scale)), Math.min(16, baseDeltaT + (1.8 * scale)), 0.5);
                    candidate.returnTemp = clamp(candidate.supplyTemp + deltaTarget, candidate.supplyTemp + 6, candidate.supplyTemp + 16);
                    return candidate;
                }

                var stages = [
                    { iterations: 3200, scale: 1.0, exploreEvery: 12 },
                    { iterations: 2400, scale: 0.55, exploreEvery: 0 },
                    { iterations: 1800, scale: 0.28, exploreEvery: 0 }
                ];

                stages.forEach(function(stage) {
                    for (var i = 0; i < stage.iterations; i++) {
                        var exploreGlobal = stage.exploreEvery > 0 && (i % stage.exploreEvery === 0);
                        var anchor = exploreGlobal ? input : bestInput;
                        var candidate = candidateFrom(anchor, stage.scale, exploreGlobal);
                        var model = computeModel(candidate);
                        var score = optimizeObjective(model, input, constraints);
                        if (score < bestScore) {
                            bestScore = score;
                            best = model;
                            bestInput = candidate;
                        }
                    }
                });

                [6, 3, 1].forEach(function(stepMul) {
                    var improved = true;
                    var guard = 0;
                    while (improved && guard < 8) {
                        improved = false;
                        guard += 1;
                        tunables.forEach(function(cfg) {
                            [-1, 1].forEach(function(dir) {
                                var candidate = Object.assign({}, bestInput);
                                candidate[cfg.key] = clamp(candidate[cfg.key] + (dir * cfg.step * stepMul), cfg.min, cfg.max);
                                if (cfg.key === 'supplyTemp') {
                                    candidate.returnTemp = clamp(bestInput.returnTemp + (dir * cfg.step * stepMul), candidate.supplyTemp + 6, candidate.supplyTemp + 16);
                                } else {
                                    candidate.returnTemp = clamp(candidate.returnTemp, candidate.supplyTemp + 6, candidate.supplyTemp + 16);
                                }
                                var model = computeModel(candidate);
                                var score = optimizeObjective(model, input, constraints);
                                if (score < bestScore) {
                                    bestScore = score;
                                    best = model;
                                    bestInput = candidate;
                                    improved = true;
                                }
                            });
                        });
                    }
                });

                document.getElementById('inLiquidCapture').value = fmtNum(bestInput.liquidCapture, 0);
                document.getElementById('inRackDensityTarget').value = fmtNum(bestInput.rackDensityTarget, 0);
                document.getElementById('inHighDensityShare').value = fmtNum(bestInput.highDensityShare, 0);
                document.getElementById('inSupplyTemp').value = fmtNum(bestInput.supplyTemp, 1);
                document.getElementById('inReturnTemp').value = fmtNum(bestInput.returnTemp, 1);
                document.getElementById('inAirCop').value = fmtNum(bestInput.airCop, 1);
                document.getElementById('inPumpEff').value = fmtNum(bestInput.pumpEff, 0);
                document.getElementById('inEconomizerHours').value = fmtNum(bestInput.economizerHours, 0);
                document.getElementById('inHeatReuse').value = fmtNum(bestInput.heatReuse, 0);
                document.getElementById('inHydraulicMargin').value = fmtNum(bestInput.hydraulicMargin, 0);
                document.getElementById('inControlQuality').value = fmtNum(bestInput.controlQuality, 0);
                document.getElementById('inPredictiveGain').value = fmtNum(bestInput.predictiveGain, 0);
                document.getElementById('inCoefHeatTransfer').value = fmtNum(bestInput.coefHeatTransfer, 1);
                document.getElementById('inCoefPipeLoss').value = fmtNum(bestInput.coefPipeLoss, 2);
                document.getElementById('inCoefFutureTech').value = fmtNum(bestInput.coefFutureTech, 0);

                optimizedModel = best;
                applyModelToUI(optimizedModel);
                renderScenarioTable(baselineModel, optimizedModel);
                renderTargetActions(baselineModel, optimizedModel);
            }

            function runCalibration() {
                var input = gatherInputs();
                var targets = gatherCalibrationTargets();
                if (targets.metricCount < 2) {
                    alert('Calibration needs at least 2 measured KPI targets (e.g. PUE and COP).');
                    return;
                }

                var base = computeModel(input);
                var baseEval = calibrationError(base, targets);
                latestPareto = [];
                selectedParetoIdx = -1;
                latestMonteCarlo = null;

                var best = base;
                var bestInput = Object.assign({}, input);
                var bestEval = baseEval;

                for (var i = 0; i < 4200; i++) {
                    var candidate = Object.assign({}, input, {
                        liquidCapture: randomInRange(Math.max(35, input.liquidCapture - 25), Math.min(99, input.liquidCapture + 20), 1),
                        controlQuality: randomInRange(Math.max(25, input.controlQuality - 30), Math.min(100, input.controlQuality + 22), 1),
                        predictiveGain: randomInRange(Math.max(0, input.predictiveGain - 18), Math.min(60, input.predictiveGain + 26), 1),
                        coefHeatTransfer: randomInRange(Math.max(70, input.coefHeatTransfer - 12), Math.min(99, input.coefHeatTransfer + 7), 0.5),
                        coefCduLoss: randomInRange(Math.max(0.5, input.coefCduLoss - 1.1), Math.min(4.5, input.coefCduLoss + 0.9), 0.05),
                        coefPipeLoss: randomInRange(Math.max(0.75, input.coefPipeLoss - 0.22), Math.min(1.8, input.coefPipeLoss + 0.28), 0.01),
                        coefFutureTech: randomInRange(Math.max(-10, input.coefFutureTech - 10), Math.min(45, input.coefFutureTech + 18), 1),
                        airCop: randomInRange(Math.max(1.8, input.airCop - 2.2), Math.min(13, input.airCop + 3.4), 0.1),
                        pumpEff: randomInRange(Math.max(50, input.pumpEff - 14), Math.min(95, input.pumpEff + 10), 1),
                        hydraulicMargin: randomInRange(Math.max(0, input.hydraulicMargin - 12), Math.min(45, input.hydraulicMargin + 10), 1),
                        economizerHours: randomInRange(Math.max(0, input.economizerHours - 30), Math.min(95, input.economizerHours + 35), 1),
                        fanPower: randomInRange(Math.max(0.5, input.fanPower - 2), Math.min(12, input.fanPower + 2), 0.1)
                    });
                    candidate.returnTemp = candidate.supplyTemp + Math.max(input.returnTemp - input.supplyTemp, 6);

                    var model = computeModel(candidate);
                    var evalResult = calibrationError(model, targets);
                    if (evalResult.error < bestEval.error) {
                        best = model;
                        bestInput = candidate;
                        bestEval = evalResult;
                    }
                }

                var applyChecked = document.getElementById('calLockApply').checked;
                if (applyChecked) {
                    document.getElementById('inLiquidCapture').value = fmtNum(bestInput.liquidCapture, 0);
                    document.getElementById('inControlQuality').value = fmtNum(bestInput.controlQuality, 0);
                    document.getElementById('inPredictiveGain').value = fmtNum(bestInput.predictiveGain, 0);
                    document.getElementById('inCoefHeatTransfer').value = fmtNum(bestInput.coefHeatTransfer, 1);
                    document.getElementById('inCoefCduLoss').value = fmtNum(bestInput.coefCduLoss, 2);
                    document.getElementById('inCoefPipeLoss').value = fmtNum(bestInput.coefPipeLoss, 2);
                    document.getElementById('inCoefFutureTech').value = fmtNum(bestInput.coefFutureTech, 0);
                    document.getElementById('inAirCop').value = fmtNum(bestInput.airCop, 1);
                    document.getElementById('inPumpEff').value = fmtNum(bestInput.pumpEff, 0);
                    document.getElementById('inHydraulicMargin').value = fmtNum(bestInput.hydraulicMargin, 0);
                    document.getElementById('inEconomizerHours').value = fmtNum(bestInput.economizerHours, 0);
                    document.getElementById('inFanPower').value = fmtNum(bestInput.fanPower, 1);
                }

                baselineModel = base;
                optimizedModel = best;
                calibrationState = {
                    metricCount: targets.metricCount,
                    baseError: baseEval.error,
                    bestError: bestEval.error,
                    quality: computeCalibrationQuality(best, targets),
                    tuned: {
                        liquidCapture: bestInput.liquidCapture,
                        controlQuality: bestInput.controlQuality,
                        predictiveGain: bestInput.predictiveGain,
                        coefHeatTransfer: bestInput.coefHeatTransfer,
                        coefCduLoss: bestInput.coefCduLoss,
                        coefPipeLoss: bestInput.coefPipeLoss,
                        coefFutureTech: bestInput.coefFutureTech
                    }
                };
                calibrationDirty = false;

                applyModelToUI(optimizedModel);
                renderScenarioTable(baselineModel, optimizedModel);
                renderTargetActions(baselineModel, optimizedModel);
            }

            function clearCalibration() {
                ['calTargetPue', 'calTargetCop', 'calTargetEnergy', 'calTargetNetOpex', 'calTargetCarbon', 'calTargetPump'].forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) el.value = '';
                });
                calibrationState = null;
                calibrationDirty = false;
                latestTelemetryParsed = null;
                setTelemetryImportMeta('Calibration targets cleared. Column mapping cache reset. Click "Detect Columns" to rebuild mapping.');
                setTelemetryImportStatus('idle', 'Calibration targets cleared. Telemetry import is ready for new CSV input.');
                runModel(true);
            }

            function resetForm() {
                Object.keys(DEFAULTS).forEach(function(id) {
                    var el = document.getElementById(id);
                    if (!el) return;
                    if (el.type === 'checkbox') el.checked = DEFAULTS[id];
                    else el.value = DEFAULTS[id];
                });
                gateRules = Object.assign({}, DEFAULT_GATE_RULES);
                setRuleStatus('Rule Set: Default', '');
                baselineModel = null;
                optimizedModel = null;
                calibrationState = null;
                calibrationDirty = false;
                latestPareto = [];
                selectedParetoIdx = -1;
                latestMonteCarlo = null;
                latestTelemetryParsed = null;
                explorerCurrentModel = null;
                explorerRunHistory = [];
                closeSankeyDrillModal();
                closeModeHelpModal();
                setTelemetryImportMeta('Column mapping not detected yet. Click "Detect Columns" to preview and override mapping.');
                setTelemetryImportStatus('idle', 'Telemetry import reset. Paste CSV or choose file, then parse.');
                var telemetryFile = document.getElementById('telemetryFile');
                if (telemetryFile) telemetryFile.value = '';
                var exDiag = document.getElementById('explorerDiag');
                if (exDiag) exDiag.textContent = 'Diagnostics pending. Click "Run UI Diagnostics" after a model run.';
                var selfStatus = document.getElementById('selfTestStatus');
                var selfSummary = document.getElementById('selfTestSummary');
                var selfRows = document.getElementById('selfTestRows');
                if (selfStatus) {
                    selfStatus.className = 'status-pill';
                    selfStatus.textContent = 'Not Run';
                }
                if (selfSummary) selfSummary.textContent = 'Self-test pending. Run self-test to generate pass/fail regression report.';
                if (selfRows) selfRows.innerHTML = '<tr><td colspan="4">No self-test execution yet.</td></tr>';
                renderScenarioDiff(null, null);
                renderPdfSourceSelectors();
                var single = document.getElementById('pdfSingleSource');
                var left = document.getElementById('pdfCompareLeft');
                var right = document.getElementById('pdfCompareRight');
                if (single) single.value = 'live_baseline';
                if (left) left.value = 'live_baseline';
                if (right) right.value = 'live_optimized';
                runModel(true);
            }

            function prioritizeDiagramBlock() {
                var panel = document.querySelector('#calculator .calc-output-panel');
                if (!panel) return;
                var modelBlock = panel.querySelector('.model-block');
                var resultGrid = panel.querySelector('.result-grid');
                if (!modelBlock || !resultGrid) return;
                if (resultGrid.nextElementSibling !== modelBlock) {
                    panel.insertBefore(modelBlock, resultGrid);
                }
            }

            document.getElementById('runCalc').addEventListener('click', function() { requestModelRun(true, true); });
            document.getElementById('optimizeTarget').addEventListener('click', optimizeToTarget);
            document.getElementById('runCalibration').addEventListener('click', runCalibration);
            document.getElementById('clearCalibration').addEventListener('click', clearCalibration);
            document.getElementById('detectTelemetryCols').addEventListener('click', detectTelemetryColumns);
            document.getElementById('applyTelemetryCsv').addEventListener('click', applyTelemetryCsvImport);
            document.getElementById('loadTelemetryTemplate').addEventListener('click', loadTelemetryTemplate);
            document.getElementById('runSelfTest').addEventListener('click', runModelSelfTest);
            document.getElementById('resetCalc').addEventListener('click', resetForm);
            document.getElementById('inCountryProfile').addEventListener('change', applyCountryProfile);
            document.getElementById('inCoolingArchitecture').addEventListener('change', applyCoolingArchitecturePreset);
            document.getElementById('applyConstraintBtn').addEventListener('click', function() { requestModelRun(false, true); });
            document.getElementById('applyRulesBtn').addEventListener('click', applyRuleSetFromEditor);
            document.getElementById('resetRulesBtn').addEventListener('click', resetRuleSetToDefault);
            document.getElementById('runPareto').addEventListener('click', runParetoFrontier);
            document.getElementById('applyParetoBest').addEventListener('click', function() {
                if (!latestPareto.length) {
                    alert('Generate Pareto frontier first.');
                    return;
                }
                var feasibleIdx = -1;
                for (var i = 0; i < latestPareto.length; i++) {
                    if (latestPareto[i]._feasible) {
                        feasibleIdx = i;
                        break;
                    }
                }
                applyParetoPoint(feasibleIdx >= 0 ? feasibleIdx : 0);
            });
            document.getElementById('runMonteCarlo').addEventListener('click', runMonteCarlo);
            document.getElementById('saveScenarioBtn').addEventListener('click', saveScenarioSnapshot);
            document.getElementById('loadScenarioBtn').addEventListener('click', loadSelectedScenario);
            document.getElementById('deleteScenarioBtn').addEventListener('click', deleteSelectedScenario);
            document.getElementById('refreshLedger').addEventListener('click', function() {
                var ledger = loadLedger().map(function(row) { return Object.assign({}, row, { ts: nowIso() }); });
                saveLedger(ledger);
                renderLedgerTable(ledger);
            });
            document.getElementById('exportExecutive').addEventListener('click', function() {
                var model = baselineModel || computeModel(gatherInputs());
                downloadTextFile('ltc-executive-pack.txt', buildExecutivePack(model));
                var s = document.getElementById('exportStatus');
                if (s) {
                    s.className = 'status-pill ok';
                    s.textContent = 'Executive Pack Exported';
                }
            });
            document.getElementById('exportEngineering').addEventListener('click', function() {
                var model = baselineModel || computeModel(gatherInputs());
                downloadTextFile('ltc-engineering-pack.txt', buildEngineeringPack(model));
                var s = document.getElementById('exportStatus');
                if (s) {
                    s.className = 'status-pill ok';
                    s.textContent = 'Engineering Pack Exported';
                }
            });
            document.getElementById('exportPdfSingle').addEventListener('click', exportPdfSingle);
            document.getElementById('exportPdfCompare').addEventListener('click', exportPdfCompare);

            document.getElementById('paretoRows').addEventListener('click', function(ev) {
                var tr = ev.target && ev.target.closest ? ev.target.closest('tr[data-pareto-idx]') : null;
                if (!tr) return;
                var idx = parseInt(tr.getAttribute('data-pareto-idx'), 10);
                if (!isFinite(idx)) return;
                applyParetoPoint(idx);
            });
            document.getElementById('paretoScatterSvg').addEventListener('click', function(ev) {
                var node = ev.target && ev.target.closest ? ev.target.closest('circle[data-pidx]') : null;
                if (!node) return;
                var idx = parseInt(node.getAttribute('data-pidx'), 10);
                if (!isFinite(idx)) return;
                applyParetoPoint(idx);
            });
            document.getElementById('sankeyMode').addEventListener('change', function() {
                closeSankeyDrillModal();
                renderEnergySankey(optimizedModel || baselineModel || computeModel(gatherInputs()));
            });
            var telemetryFileInput = document.getElementById('telemetryFile');
            var telemetryPasteInput = document.getElementById('telemetryPaste');
            var telemetryAggInput = document.getElementById('telemetryAggMode');
            var telemetryWindowInput = document.getElementById('telemetryWindowRows');
            if (telemetryFileInput) {
                telemetryFileInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        latestTelemetryParsed = null;
                        setTelemetryImportMeta('File selected. Click "Detect Columns" to generate mapping options from this CSV.');
                        setTelemetryImportStatus('warn', 'File selected: ' + this.files[0].name + '. Click "Parse + Apply Telemetry" to process.');
                    } else {
                        latestTelemetryParsed = null;
                        setTelemetryImportMeta('Column mapping not detected yet. Click "Detect Columns" to preview and override mapping.');
                        setTelemetryImportStatus('warn', 'Telemetry file selection cleared. Paste CSV or choose a file.');
                    }
                });
            }
            if (telemetryAggInput) {
                telemetryAggInput.addEventListener('change', function() {
                    setTelemetryImportStatus('warn', 'Aggregation mode changed to ' + this.value + '. Re-apply telemetry to update targets.');
                });
            }
            if (telemetryWindowInput) {
                telemetryWindowInput.addEventListener('input', function() {
                    setTelemetryImportStatus('warn', 'Window rows set to ' + (this.value || '0') + '. Re-apply telemetry to update targets.');
                });
            }
            if (telemetryPasteInput) {
                telemetryPasteInput.addEventListener('input', function() {
                    latestTelemetryParsed = null;
                    if (String(this.value || '').trim().length) {
                        setTelemetryImportMeta('Paste content updated. Click "Detect Columns" to refresh mapping options.');
                    } else {
                        setTelemetryImportMeta('Column mapping not detected yet. Click "Detect Columns" to preview and override mapping.');
                    }
                });
            }
            Object.keys(TELEMETRY_MANUAL_SELECT_ID).forEach(function(metricKey) {
                var selId = TELEMETRY_MANUAL_SELECT_ID[metricKey];
                var sel = document.getElementById(selId);
                if (!sel) return;
                sel.addEventListener('change', function() {
                    setTelemetryImportStatus('warn', 'Manual mapping updated for ' + metricKey + '. Re-apply telemetry to propagate changes.');
                });
            });

            var autoRunToggle = document.getElementById('autoRunToggle');
            if (autoRunToggle) {
                autoRunToggle.addEventListener('change', function() {
                    updateAutoRunStateUI();
                    if (autoRunEnabled) requestModelRun(true, true);
                });
            }

            var advancedInputToggle = document.getElementById('advancedInputToggle');
            if (advancedInputToggle && typeof uiPrefs.showAdvancedInputs === 'boolean') {
                advancedInputToggle.checked = !!uiPrefs.showAdvancedInputs;
            }
            if (advancedInputToggle) {
                advancedInputToggle.addEventListener('change', function() {
                    updateInputModeUI();
                    requestModelRun(true, true);
                });
            }

            var splitSlider = document.getElementById('layoutSplit');
            var splitResetBtn = document.getElementById('layoutResetSplit');
            var focusDiagramBtn = document.getElementById('focusDiagramBtn');
            if (typeof uiPrefs.layoutSplitPercent === 'number' && isFinite(uiPrefs.layoutSplitPercent)) {
                layoutSplitPercent = clamp(uiPrefs.layoutSplitPercent, 34, 58);
            }
            if (splitSlider) {
                splitSlider.value = String(Math.round(layoutSplitPercent));
                splitSlider.addEventListener('input', function() {
                    updateLayoutSplitUI(parseFloat(this.value || '42'));
                });
            }
            if (splitResetBtn) {
                splitResetBtn.addEventListener('click', function() {
                    updateLayoutSplitUI(42);
                });
            }
            if (focusDiagramBtn) {
                focusDiagramBtn.addEventListener('click', focusDiagramBlock);
            }

            initInputTooltips();
            initOutputTooltips();
            initTooltipPositioning();
            initTermTooltipPositioning();
            initBlockDetailModal();
            initSankeyDrillModal();
            initModeHelpModal();
            initExplorerUI();
            prioritizeDiagramBlock();
            setRuleStatus('Rule Set: Default', '');
            loadScenarios();
            renderScenarioList();
            renderLedgerTable(loadLedger());

            updateAutoRunStateUI();
            updateInputModeUI();
            updateLayoutSplitUI(layoutSplitPercent);
            setTelemetryImportMeta('Column mapping not detected yet. Click "Detect Columns" to preview and override mapping.');
            setTelemetryImportStatus('idle', 'Telemetry import idle. Provide CSV via file or paste area, then run parse.');

            document.querySelectorAll('.input-grid input').forEach(function(el) {
                el.addEventListener('input', function() {
                    requestModelRun(true, false);
                });
            });
            document.querySelectorAll('.input-grid select').forEach(function(el) {
                if (el.id === 'inCountryProfile' || el.id === 'inCoolingArchitecture') return;
                el.addEventListener('change', function() {
                    if (!autoRunEnabled) return;
                    requestModelRun(true, true);
                });
            });
            document.getElementById('inConcurrent').addEventListener('change', function() { requestModelRun(true, false); });
            document.getElementById('inFailureMode').addEventListener('change', function() { requestModelRun(true, false); });
            ['conPueMax', 'conCopMin', 'conRiskMax', 'conPumpPctMax', 'conEnforce'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('change', function() { requestModelRun(false, false); });
            });
            document.getElementById('scenarioSelect').addEventListener('change', function() {
                var idx = parseInt(this.value, 10);
                if (isFinite(idx)) selectedScenarioIdx = idx;
            });

            runModel(true);
        })();
    </script>

    <script src="auth.js?v=20260228"></script>
    <script src="rz-tracker.js"></script>

    <script>
        (function rootAccessGate() {
            var ROOT_EMAILS = ['admin@resistancezero.com', 'bagus@resistancezero.com'];

            function detectRole(email) {
                var e = String(email || '').toLowerCase().trim();
                return ROOT_EMAILS.indexOf(e) !== -1 ? 'root' : 'pro';
            }

            function getSession() {
                try {
                    var raw = localStorage.getItem('rz_premium_session');
                    if (!raw) return null;
                    var data = JSON.parse(raw);
                    if (data.expires && new Date(data.expires) < new Date()) {
                        localStorage.removeItem('rz_premium_session');
                        return null;
                    }
                    if (!data.role) data.role = detectRole(data.email);
                    return data;
                } catch (e) {
                    return null;
                }
            }

            function isRoot(session) {
                return !!(session && String(session.role || '').toLowerCase() === 'root');
            }

            function applyGate() {
                var session = getSession();
                document.body.classList.toggle('locked', !isRoot(session));
            }

            var loginBtn = document.getElementById('rootLoginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', function() {
                    if (window._rzAuth && typeof window._rzAuth.showModal === 'function') {
                        window._rzAuth.showModal();
                    } else {
                        alert('Login module is not ready yet.');
                    }
                });
            }

            window.addEventListener('rz-auth-change', function() {
                applyGate();
            });

            setTimeout(applyGate, 60);
            setTimeout(applyGate, 550);
        })();

        (function cookieBanner() {
            var banner = document.getElementById('cookieBanner');
            var accepted = localStorage.getItem('rz_cookie_consent');
            if (!accepted && banner) banner.classList.remove('hidden');

            var accept = document.getElementById('cookieAccept');
            var decline = document.getElementById('cookieDecline');

            if (accept) {
                accept.addEventListener('click', function() {
                    localStorage.setItem('rz_cookie_consent', 'accepted');
                    banner.classList.add('hidden');
                });
            }

            if (decline) {
                decline.addEventListener('click', function() {
                    localStorage.setItem('rz_cookie_consent', 'declined');
                    banner.classList.add('hidden');
                    window['ga-disable-G-GED7FX8RTV'] = true;
                });
            }
        })();
    </script>
</body>
</html>
