<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Root Engineering Lab | Liquid-to-Chip System Modelling Laboratory | ResistanceZero</title>
    <meta name="description" content="Root-only liquid-to-chip system modelling laboratory with comprehensive input-processing-output flow, calibration mode, and advanced control logic visualization.">
    <meta name="author" content="Bagus Dwi Permana">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#0f172a">

    <link rel="icon" type="image/png" href="assets/Favicon.png">
    <link rel="apple-touch-icon" href="assets/Favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3a7ca5 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: rgba(255, 255, 255, 0.88);
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --text-muted: #64748b;
            --border: rgba(30, 58, 95, 0.16);
            --shadow: 0 10px 28px rgba(15, 23, 42, 0.12);
            --accent-gold: #f59e0b;
            --accent-cyan: #06b6d4;
            --accent-emerald: #10b981;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
        }

        [data-theme="dark"] {
            --bg-primary: #0a0f1d;
            --bg-secondary: #0f172a;
            --bg-card: rgba(15, 23, 42, 0.82);
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: rgba(148, 163, 184, 0.2);
            --shadow: 0 12px 30px rgba(2, 6, 23, 0.45);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .page-background {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background:
                radial-gradient(ellipse at top right, rgba(74, 144, 184, 0.14), transparent 48%),
                radial-gradient(ellipse at bottom left, rgba(245, 158, 11, 0.1), transparent 55%);
        }

        .navbar {
            position: sticky;
            top: 0;
            z-index: 40;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] .navbar {
            background: rgba(10, 15, 29, 0.84);
        }

        .nav-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0.95rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .nav-brand {
            display: inline-flex;
            align-items: center;
            gap: 0.7rem;
            text-decoration: none;
            color: inherit;
        }

        .brand-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            background: var(--primary-gradient);
            box-shadow: 0 8px 18px rgba(30, 58, 95, 0.35);
        }

        .brand-title {
            font-size: 0.96rem;
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .brand-subtitle {
            display: block;
            font-size: 0.73rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-top: 0.1rem;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 0.65rem;
        }

        .nav-back {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.52rem 0.9rem;
            border-radius: 9px;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 600;
            color: #fff;
            background: var(--primary-gradient);
            box-shadow: 0 6px 16px rgba(30, 58, 95, 0.28);
        }

        .theme-toggle {
            width: 38px;
            height: 38px;
            border: 1px solid var(--border);
            border-radius: 9px;
            cursor: pointer;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.55);
            transition: transform 0.18s ease;
        }

        .theme-toggle:hover {
            transform: translateY(-1px);
        }

        [data-theme="dark"] .theme-toggle {
            background: rgba(15, 23, 42, 0.7);
            color: #f8fafc;
        }

        .main-content {
            position: relative;
            z-index: 2;
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1.5rem 3rem;
        }

        .hero {
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.06), rgba(6, 182, 212, 0.06));
            box-shadow: var(--shadow);
        }

        [data-theme="dark"] .hero {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.35), rgba(15, 23, 42, 0.75));
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.38rem 0.85rem;
            border-radius: 999px;
            font-size: 0.73rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #fff;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            margin-bottom: 1rem;
        }

        .hero h1 {
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            line-height: 1.2;
            margin-bottom: 0.85rem;
            color: var(--text-primary);
        }

        .hero p {
            max-width: 860px;
            color: var(--text-secondary);
            line-height: 1.75;
            font-size: 1rem;
        }

        .hero-kpis {
            margin-top: 1.45rem;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.75rem;
        }

        .hero-kpi {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.8rem 0.9rem;
            background: var(--bg-card);
        }

        .hero-kpi .kpi-label {
            font-size: 0.67rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            font-weight: 700;
        }

        .hero-kpi .kpi-value {
            font-size: 1.2rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
        }

        .legal-disclaimer-wrap {
            margin-top: 1rem;
        }

        .legal-disclaimer {
            border-radius: 14px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-left: 4px solid var(--accent-gold);
            background: var(--bg-card);
            padding: 1rem 1.15rem;
            box-shadow: var(--shadow);
        }

        .legal-disclaimer-title {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            margin: 0 0 0.45rem;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-primary);
        }

        .legal-disclaimer p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.8rem;
            line-height: 1.6;
        }

        .legal-disclaimer p + p {
            margin-top: 0.35rem;
        }

        .legal-disclaimer a {
            color: #2563eb;
            text-decoration: underline;
            font-weight: 600;
        }

        .section {
            margin-top: 1.35rem;
        }

        .section-header {
            margin-bottom: 0.85rem;
        }

        .section-header h2 {
            font-size: 1.35rem;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .section-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .standards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 0.75rem;
        }

        .standard-card {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 0.95rem;
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }

        .standard-card-link {
            display: block;
            text-decoration: none;
            color: inherit;
            transition: transform 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease;
            border-color: rgba(245, 158, 11, 0.35);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(30, 58, 95, 0.08));
        }

        .standard-card-link:hover {
            transform: translateY(-3px);
            border-color: rgba(245, 158, 11, 0.55);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.16);
        }

        [data-theme="dark"] .standard-card-link {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(30, 58, 95, 0.25));
        }

        .standard-card-link .open-link {
            margin-top: 0.55rem;
            font-size: 0.74rem;
            font-weight: 700;
            color: #b45309;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        [data-theme="dark"] .standard-card-link .open-link {
            color: #fbbf24;
        }

        .standard-card h3 {
            font-size: 0.95rem;
            margin-bottom: 0.55rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .standard-card h3 i {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.76rem;
        }

        .standard-card ul {
            list-style: none;
            display: grid;
            gap: 0.38rem;
        }

        .standard-card li {
            font-size: 0.76rem;
            color: var(--text-secondary);
            line-height: 1.45;
            padding-left: 0.95rem;
            position: relative;
        }

        .standard-card li::before {
            content: '';
            width: 5px;
            height: 5px;
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 0.45rem;
            background: #60a5fa;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.75rem;
        }

        .detail-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.85rem 0.9rem;
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }

        .detail-card .route-id {
            display: inline-block;
            margin-bottom: 0.45rem;
            font-size: 0.66rem;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.02em;
            color: var(--text-muted);
            background: rgba(148, 163, 184, 0.14);
            border: 1px solid rgba(148, 163, 184, 0.22);
            border-radius: 999px;
            padding: 0.16rem 0.46rem;
        }

        .detail-card h4 {
            font-size: 0.88rem;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .detail-card p {
            margin: 0;
            font-size: 0.78rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .architecture-layout {
            display: grid;
            grid-template-columns: 1.35fr 1fr;
            gap: 0.75rem;
        }

        .panel {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1rem;
            background: var(--bg-card);
            box-shadow: var(--shadow);
        }

        .panel h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .panel p {
            font-size: 0.84rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 0.6rem;
        }

        .pipeline {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 0.5rem;
            margin-top: 0.4rem;
        }

        .step {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.65rem 0.55rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.42);
        }

        [data-theme="dark"] .step {
            background: rgba(30, 41, 59, 0.6);
        }

        .step .num {
            display: inline-flex;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            align-items: center;
            justify-content: center;
            background: #1e3a5f;
            color: #fff;
            font-size: 0.72rem;
            font-weight: 700;
            margin-bottom: 0.35rem;
        }

        .step h4 {
            font-size: 0.73rem;
            margin-bottom: 0.15rem;
        }

        .step p {
            font-size: 0.69rem;
            line-height: 1.35;
            margin: 0;
            color: var(--text-muted);
        }

        .calculator-layout {
            display: grid;
            grid-template-columns: 1.05fr 1fr;
            gap: 0.75rem;
        }

        .calc-card {
            border: 1px solid var(--border);
            border-radius: 14px;
            background: var(--bg-card);
            box-shadow: var(--shadow);
            padding: 1rem;
        }

        .calc-card h3 {
            font-size: 1rem;
            margin-bottom: 0.7rem;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.58rem;
        }

        .input-group {
            display: grid;
            gap: 0.25rem;
        }

        .input-group label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--text-muted);
            font-weight: 700;
        }

        .calc-label {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .calc-label .tooltip-trigger {
            margin-left: 0;
        }

        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(37, 99, 235, 0.16);
            color: #2563eb;
            font-size: 0.65rem;
            font-weight: 700;
            cursor: help;
            position: relative;
            flex-shrink: 0;
            margin-left: 6px;
            vertical-align: middle;
        }

        [data-theme="dark"] .tooltip-trigger {
            background: rgba(96, 165, 250, 0.22);
            color: #93c5fd;
        }

        .tooltip-content {
            display: none;
            position: fixed;
            width: 320px;
            background: #1e293b;
            border: 1px solid rgba(37, 99, 235, 0.35);
            border-radius: 10px;
            padding: 14px;
            z-index: 10020;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            pointer-events: none;
        }

        .tooltip-title {
            font-size: 0.82rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 6px;
        }

        .tooltip-desc {
            font-size: 0.78rem;
            color: #cbd5e1;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .tooltip-formula {
            font-size: 0.72rem;
            color: #94a3b8;
            padding-top: 6px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-style: italic;
        }

        .tooltip-impact {
            font-size: 0.72rem;
            color: #cbd5e1;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed rgba(148, 163, 184, 0.35);
            line-height: 1.4;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 9px;
            padding: 0.56rem 0.62rem;
            font-size: 0.84rem;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.7);
            font-family: 'Inter', sans-serif;
        }

        [data-theme="dark"] .input-group input,
        [data-theme="dark"] .input-group select {
            background: rgba(30, 41, 59, 0.7);
        }

        .check-wrap {
            margin-top: 0.2rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .form-actions {
            margin-top: 0.8rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .btn-primary,
        .btn-secondary,
        .btn-accent {
            border: none;
            border-radius: 10px;
            padding: 0.62rem 0.9rem;
            font-size: 0.83rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .btn-primary {
            color: #fff;
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            flex: 1;
        }

        .btn-secondary {
            color: var(--text-primary);
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.6);
        }

        .btn-accent {
            color: #fff;
            background: linear-gradient(135deg, #0ea5e9, #0369a1);
        }

        [data-theme="dark"] .btn-secondary {
            background: rgba(30, 41, 59, 0.8);
            color: #e2e8f0;
        }

        .btn-primary:hover,
        .btn-secondary:hover,
        .btn-accent:hover {
            transform: translateY(-1px);
        }

        .calc-footnote {
            margin-top: 0.65rem;
            font-size: 0.73rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .calibration-block {
            margin-top: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.66rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(16, 185, 129, 0.08));
        }

        [data-theme="dark"] .calibration-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.42), rgba(15, 23, 42, 0.76));
        }

        .calibration-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.45rem;
            margin-bottom: 0.24rem;
        }

        .calibration-head h4 {
            margin: 0;
            font-size: 0.82rem;
            color: var(--text-primary);
        }

        .calibration-status {
            font-size: 0.67rem;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.14rem 0.42rem;
            background: rgba(255, 255, 255, 0.65);
            color: var(--text-primary);
            white-space: nowrap;
        }

        [data-theme="dark"] .calibration-status {
            background: rgba(15, 23, 42, 0.72);
        }

        .calibration-status.ok {
            border-color: rgba(16, 185, 129, 0.6);
            color: #047857;
        }

        [data-theme="dark"] .calibration-status.ok {
            color: #34d399;
        }

        .calibration-status.stale {
            border-color: rgba(245, 158, 11, 0.65);
            color: #b45309;
        }

        [data-theme="dark"] .calibration-status.stale {
            color: #fbbf24;
        }

        .calibration-note {
            margin: 0 0 0.45rem;
            font-size: 0.72rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.55rem;
        }

        .calibration-actions {
            margin-top: 0.55rem;
        }

        .calibration-summary {
            margin-top: 0.45rem;
            font-size: 0.72rem;
            color: var(--text-secondary);
            line-height: 1.45;
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-line;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.7rem;
        }

        .result-card {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.58rem 0.65rem;
            background: rgba(255, 255, 255, 0.44);
        }

        [data-theme="dark"] .result-card {
            background: rgba(30, 41, 59, 0.58);
        }

        .result-card .label {
            display: block;
            font-size: 0.68rem;
            color: var(--text-muted);
            margin-bottom: 0.18rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 700;
        }

        .result-card .value {
            font-size: 0.95rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--text-primary);
            overflow-wrap: anywhere;
            word-break: break-word;
            line-height: 1.35;
        }

        .scoreboard {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.75rem 0.8rem;
            margin-bottom: 0.65rem;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(37, 99, 235, 0.1));
        }

        .score-row {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 0.6rem;
        }

        .score-title {
            font-size: 0.76rem;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
        }

        .score-value {
            font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
            color: var(--text-primary);
        }

        .score-grade {
            margin-top: 0.2rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .compliance-grid {
            display: grid;
            gap: 0.4rem;
            margin-bottom: 0.7rem;
        }

        .compliance-item {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem 0.58rem;
            background: rgba(255, 255, 255, 0.4);
        }

        [data-theme="dark"] .compliance-item {
            background: rgba(30, 41, 59, 0.58);
        }

        .compliance-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.55rem;
            margin-bottom: 0.3rem;
        }

        .compliance-name {
            font-size: 0.77rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .compliance-score {
            font-size: 0.74rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            font-weight: 700;
        }

        .progress {
            height: 7px;
            border-radius: 99px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.3);
        }

        .progress > i {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            transition: width 0.4s ease;
        }

        .method-block {
            border: 1px dashed rgba(148, 163, 184, 0.5);
            border-radius: 10px;
            padding: 0.65rem;
        }

        .method-block h4 {
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
            color: var(--text-primary);
        }

        .method-block ul {
            list-style: none;
            display: grid;
            gap: 0.3rem;
        }

        .method-block li {
            font-size: 0.74rem;
            color: var(--text-secondary);
            line-height: 1.45;
            padding-left: 0.95rem;
            position: relative;
        }

        .method-block li::before {
            content: '';
            width: 5px;
            height: 5px;
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 0.45rem;
            background: var(--accent-cyan);
        }

        .model-block {
            margin-bottom: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.72rem 0.76rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(16, 185, 129, 0.08));
        }

        [data-theme="dark"] .model-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.45), rgba(15, 23, 42, 0.75));
        }

        .model-head {
            margin-bottom: 0.45rem;
        }

        .model-head h4 {
            font-size: 0.82rem;
            margin-bottom: 0.2rem;
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .model-head p {
            margin: 0;
            font-size: 0.74rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        .diagram-canvas {
            margin-bottom: 0.56rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.5);
            overflow-x: auto;
        }

        [data-theme="dark"] .diagram-canvas {
            background: rgba(15, 23, 42, 0.64);
        }

        .diagram-svg {
            width: 100%;
            min-width: 760px;
            height: auto;
            display: block;
            font-family: 'Inter', sans-serif;
            text-rendering: geometricPrecision;
        }

        .diagram-svg .diag-box {
            stroke: rgba(30, 58, 95, 0.42);
            stroke-width: 1.4;
            fill: rgba(255, 255, 255, 0.78);
        }

        [data-theme="dark"] .diagram-svg .diag-box {
            stroke: rgba(148, 163, 184, 0.34);
            fill: rgba(30, 41, 59, 0.86);
        }

        .diagram-svg .diag-box-input { fill: rgba(59, 130, 246, 0.12); }
        .diagram-svg .diag-box-thermal { fill: rgba(6, 182, 212, 0.12); }
        .diagram-svg .diag-box-hydraulic { fill: rgba(139, 92, 246, 0.12); }
        .diagram-svg .diag-box-impact { fill: rgba(16, 185, 129, 0.12); }
        .diagram-svg .diag-box-cost { fill: rgba(245, 158, 11, 0.12); }
        .diagram-svg .diag-box-compliance { fill: rgba(239, 68, 68, 0.12); }
        .diagram-svg .diag-box-control { fill: rgba(14, 165, 233, 0.12); }

        [data-theme="dark"] .diagram-svg .diag-box-input { fill: rgba(59, 130, 246, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-thermal { fill: rgba(6, 182, 212, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-hydraulic { fill: rgba(139, 92, 246, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-impact { fill: rgba(16, 185, 129, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-cost { fill: rgba(245, 158, 11, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-compliance { fill: rgba(239, 68, 68, 0.2); }
        [data-theme="dark"] .diagram-svg .diag-box-control { fill: rgba(14, 165, 233, 0.22); }

        .diagram-svg .diag-title {
            fill: var(--text-primary);
            font-size: 12px;
            font-weight: 700;
        }

        .diagram-svg .diag-value {
            fill: var(--text-secondary);
            font-size: 10.2px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }

        .diagram-svg .diag-caption {
            fill: var(--text-muted);
            font-size: 11.2px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
        }

        .diagram-svg .diag-line {
            stroke: rgba(100, 116, 139, 0.8);
            stroke-width: 2.2;
            fill: none;
            marker-end: url(#diagArrow);
        }

        .diagram-svg .diag-gate-shape {
            stroke: rgba(30, 58, 95, 0.42);
            stroke-width: 1.3;
            fill: rgba(148, 163, 184, 0.16);
        }

        .diagram-svg .diag-gate-shape.ok {
            fill: rgba(16, 185, 129, 0.2);
            stroke: rgba(5, 150, 105, 0.58);
        }

        .diagram-svg .diag-gate-shape.warn {
            fill: rgba(245, 158, 11, 0.2);
            stroke: rgba(217, 119, 6, 0.58);
        }

        .diagram-svg .diag-gate-link {
            stroke: rgba(100, 116, 139, 0.72);
            stroke-width: 1.8;
            stroke-dasharray: 5 4;
            fill: none;
            marker-end: url(#diagArrowCtrl);
        }

        .diagram-svg .diag-gate-note-bg {
            fill: rgba(255, 255, 255, 0.72);
            stroke: rgba(148, 163, 184, 0.34);
            stroke-width: 0.9;
        }

        .diagram-svg .diag-gate-note {
            fill: var(--text-primary);
            font-size: 11.2px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
        }

        [data-theme="dark"] .diagram-svg .diag-gate-shape {
            fill: rgba(71, 85, 105, 0.3);
            stroke: rgba(148, 163, 184, 0.42);
        }

        [data-theme="dark"] .diagram-svg .diag-gate-shape.ok {
            fill: rgba(16, 185, 129, 0.26);
            stroke: rgba(52, 211, 153, 0.62);
        }

        [data-theme="dark"] .diagram-svg .diag-gate-shape.warn {
            fill: rgba(245, 158, 11, 0.26);
            stroke: rgba(251, 191, 36, 0.68);
        }

        [data-theme="dark"] .diagram-svg .diag-gate-note-bg {
            fill: rgba(15, 23, 42, 0.78);
            stroke: rgba(148, 163, 184, 0.42);
        }

        .model-track {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr auto 1fr;
            align-items: center;
            gap: 0.45rem;
        }

        .model-arrow {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 700;
            text-align: center;
        }

        .model-node {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.46rem 0.5rem;
            background: rgba(255, 255, 255, 0.5);
        }

        [data-theme="dark"] .model-node {
            background: rgba(30, 41, 59, 0.7);
        }

        .model-node .tag {
            display: block;
            font-size: 0.64rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            margin-bottom: 0.18rem;
            font-weight: 700;
        }

        .model-node .val {
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
            white-space: normal;
            overflow-wrap: anywhere;
            line-height: 1.35;
        }

        .model-impact-grid {
            margin-top: 0.52rem;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.45rem;
        }

        .model-impact {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.4rem 0.46rem;
            background: rgba(255, 255, 255, 0.52);
        }

        [data-theme="dark"] .model-impact {
            background: rgba(30, 41, 59, 0.7);
        }

        .model-impact .k {
            display: block;
            font-size: 0.61rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.1rem;
            font-weight: 700;
        }

        .model-impact .v {
            font-size: 0.78rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            font-weight: 700;
        }

        .flow-block {
            margin-top: 0.68rem;
            margin-bottom: 0.68rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.68rem 0.72rem;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.08), rgba(245, 158, 11, 0.08));
        }

        [data-theme="dark"] .flow-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.4), rgba(15, 23, 42, 0.78));
        }

        .flow-head {
            margin-bottom: 0.42rem;
        }

        .flow-head h4 {
            font-size: 0.81rem;
            color: var(--text-primary);
            margin-bottom: 0.16rem;
            display: inline-flex;
            align-items: center;
            gap: 0.34rem;
        }

        .flow-head p {
            margin: 0;
            font-size: 0.73rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .flow-row {
            display: grid;
            grid-template-columns: 130px 1fr auto;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.32rem;
        }

        .flow-row span:first-child {
            font-size: 0.69rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .flow-row span:last-child {
            font-size: 0.68rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            text-align: right;
            min-width: 58px;
        }

        .flow-bar {
            height: 8px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.24);
        }

        .flow-bar > i {
            display: block;
            width: 0%;
            height: 100%;
            transition: width 0.35s ease;
            background: linear-gradient(90deg, #0ea5e9, #22c55e);
        }

        #barFlowIt { background: linear-gradient(90deg, #38bdf8, #3b82f6); }
        #barFlowLiquid { background: linear-gradient(90deg, #06b6d4, #10b981); }
        #barFlowAir { background: linear-gradient(90deg, #f59e0b, #f97316); }
        #barFlowPump { background: linear-gradient(90deg, #8b5cf6, #6366f1); }
        #barFlowElecLoss { background: linear-gradient(90deg, #ef4444, #f97316); }
        #barFlowAux { background: linear-gradient(90deg, #64748b, #475569); }

        .control-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.66rem 0.72rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(37, 99, 235, 0.08));
        }

        [data-theme="dark"] .control-block {
            background: linear-gradient(135deg, rgba(76, 29, 149, 0.35), rgba(15, 23, 42, 0.72));
        }

        .control-loop {
            stroke: rgba(100, 116, 139, 0.78);
            stroke-width: 2.2;
            fill: none;
        }

        .logic-seq-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.62rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(16, 185, 129, 0.08));
        }

        [data-theme="dark"] .logic-seq-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.44), rgba(15, 23, 42, 0.74));
        }

        .logic-seq {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 0.4rem;
            align-items: stretch;
        }

        .logic-step {
            border: 1px solid var(--border);
            border-radius: 9px;
            background: rgba(255, 255, 255, 0.6);
            padding: 0.35rem 0.4rem;
            position: relative;
        }

        [data-theme="dark"] .logic-step {
            background: rgba(15, 23, 42, 0.68);
        }

        .logic-step:not(:last-child)::after {
            content: '\f061';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: -0.31rem;
            top: 0.46rem;
            font-size: 0.62rem;
            color: rgba(59, 130, 246, 0.74);
            z-index: 2;
        }

        .logic-step .n {
            display: inline-flex;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            background: rgba(37, 99, 235, 0.16);
            color: #2563eb;
            margin-right: 0.26rem;
        }

        [data-theme="dark"] .logic-step .n {
            background: rgba(96, 165, 250, 0.22);
            color: #93c5fd;
        }

        .logic-step h5 {
            margin: 0 0 0.18rem;
            font-size: 0.66rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .logic-step p {
            margin: 0;
            font-size: 0.66rem;
            color: var(--text-secondary);
            line-height: 1.36;
            font-family: 'Inter', sans-serif;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .trace-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px dashed rgba(148, 163, 184, 0.55);
            border-radius: 11px;
            padding: 0.58rem;
            background: rgba(255, 255, 255, 0.42);
        }

        [data-theme="dark"] .trace-block {
            background: rgba(30, 41, 59, 0.54);
        }

        .trace-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.38rem;
        }

        .trace-head h4 {
            font-size: 0.8rem;
            color: var(--text-primary);
            margin: 0;
        }

        .trace-badge {
            font-size: 0.66rem;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.14rem 0.4rem;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.66);
        }

        [data-theme="dark"] .trace-badge {
            background: rgba(15, 23, 42, 0.72);
        }

        .trace-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .trace-col {
            border: 1px solid var(--border);
            border-radius: 9px;
            padding: 0.45rem 0.5rem;
            background: rgba(255, 255, 255, 0.48);
            min-height: 170px;
        }

        [data-theme="dark"] .trace-col {
            background: rgba(15, 23, 42, 0.66);
        }

        .trace-col h5 {
            margin: 0 0 0.3rem;
            font-size: 0.71rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
        }

        .trace-list {
            display: grid;
            gap: 0.18rem;
            max-height: 200px;
            overflow: auto;
            padding-right: 0.2rem;
        }

        .trace-item {
            font-size: 0.69rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.38;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.22);
            padding-bottom: 0.12rem;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .sensitivity-block {
            margin-top: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.45);
        }

        [data-theme="dark"] .sensitivity-block {
            background: rgba(15, 23, 42, 0.68);
        }

        .sensitivity-block h4 {
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            color: var(--text-primary);
        }

        .sensitivity-block p {
            font-size: 0.72rem;
            color: var(--text-secondary);
            margin-bottom: 0.38rem;
            line-height: 1.45;
        }

        .pipeline-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.66rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(20, 184, 166, 0.08));
        }

        [data-theme="dark"] .pipeline-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.42), rgba(15, 23, 42, 0.76));
        }

        .pipeline-head {
            margin-bottom: 0.42rem;
        }

        .pipeline-head h4 {
            margin: 0 0 0.18rem;
            font-size: 0.82rem;
            color: var(--text-primary);
        }

        .pipeline-head p {
            margin: 0;
            font-size: 0.73rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        .pipeline-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.45rem;
        }

        .pipeline-stage {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.52);
            padding: 0.45rem 0.5rem;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        [data-theme="dark"] .pipeline-stage {
            background: rgba(15, 23, 42, 0.66);
        }

        .pipeline-stage h5 {
            margin: 0 0 0.25rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            font-weight: 700;
        }

        .stage-lines {
            display: grid;
            gap: 0.16rem;
            max-height: 180px;
            overflow: auto;
            padding-right: 0.1rem;
        }

        .stage-line {
            font-size: 0.68rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            line-height: 1.34;
            overflow-wrap: anywhere;
            word-break: break-word;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.2);
            padding-bottom: 0.08rem;
        }

        .fullmap-block {
            margin-top: 0.66rem;
            margin-bottom: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.66rem;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(99, 102, 241, 0.08));
        }

        [data-theme="dark"] .fullmap-block {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.42), rgba(30, 27, 75, 0.52));
        }

        .fullmap-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.5rem;
            position: relative;
        }

        .fullmap-col {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.52);
            padding: 0.45rem 0.48rem;
            min-height: 210px;
            position: relative;
        }

        [data-theme="dark"] .fullmap-col {
            background: rgba(15, 23, 42, 0.68);
        }

        .fullmap-col:not(:last-child)::after {
            content: '\f061';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: -0.42rem;
            top: 0.72rem;
            color: rgba(59, 130, 246, 0.72);
            font-size: 0.68rem;
            z-index: 2;
        }

        .fullmap-col h5 {
            margin: 0 0 0.25rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            font-weight: 700;
        }

        .fullmap-nodes {
            display: grid;
            gap: 0.22rem;
            max-height: 260px;
            overflow: auto;
            padding-right: 0.1rem;
        }

        .fullmap-node {
            border: 1px solid rgba(148, 163, 184, 0.28);
            border-radius: 8px;
            padding: 0.24rem 0.32rem;
            background: rgba(255, 255, 255, 0.6);
            animation: nodePulse 0.8s ease;
            transform-origin: center;
        }

        [data-theme="dark"] .fullmap-node {
            background: rgba(30, 41, 59, 0.6);
        }

        .fullmap-key {
            font-size: 0.66rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.34;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .fullmap-val {
            margin-top: 0.08rem;
            font-size: 0.68rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .fullmap-note {
            margin-top: 0.36rem;
            margin-bottom: 0;
            font-size: 0.71rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        @keyframes nodePulse {
            0% { opacity: 0; transform: translateY(3px) scale(0.995); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .term-tooltip {
            position: relative;
            border-bottom: 1px dotted rgba(37, 99, 235, 0.75);
            cursor: help;
            color: inherit;
            text-decoration: none;
        }

        [data-theme="dark"] .term-tooltip {
            border-bottom-color: rgba(96, 165, 250, 0.8);
        }

        .term-tooltip::after {
            content: none;
        }

        .term-tooltip-panel {
            position: fixed;
            display: none;
            width: 320px;
            background: #1e293b;
            border: 1px solid rgba(37, 99, 235, 0.35);
            border-radius: 10px;
            padding: 12px;
            z-index: 10030;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            pointer-events: none;
        }

        [data-theme="dark"] .term-tooltip-panel {
            border-color: rgba(96, 165, 250, 0.35);
        }

        .term-tooltip-panel .term-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 6px;
        }

        .term-tooltip-panel .term-desc {
            font-size: 0.76rem;
            color: #cbd5e1;
            line-height: 1.45;
        }

        .term-tooltip-panel .term-impact {
            margin-top: 7px;
            padding-top: 7px;
            border-top: 1px dashed rgba(148, 163, 184, 0.35);
            font-size: 0.72rem;
            color: #cbd5e1;
            line-height: 1.42;
        }

        .target-block {
            margin-top: 0.65rem;
            border: 1px dashed rgba(148, 163, 184, 0.55);
            border-radius: 10px;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.42);
        }

        [data-theme="dark"] .target-block {
            background: rgba(30, 41, 59, 0.55);
        }

        .target-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
            margin-bottom: 0.35rem;
        }

        .target-head h4 {
            font-size: 0.8rem;
            margin: 0;
            color: var(--text-primary);
        }

        .target-badge {
            font-size: 0.68rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.16rem 0.42rem;
            background: rgba(255, 255, 255, 0.65);
        }

        [data-theme="dark"] .target-badge {
            background: rgba(15, 23, 42, 0.72);
        }

        .target-list {
            list-style: none;
            display: grid;
            gap: 0.3rem;
            margin: 0 0 0.45rem;
            padding: 0;
        }

        .target-list li {
            font-size: 0.76rem;
            color: var(--text-secondary);
            line-height: 1.45;
            padding-left: 1rem;
            position: relative;
        }

        .target-list li::before {
            content: '';
            width: 5px;
            height: 5px;
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 0.43rem;
            background: var(--accent-emerald);
        }

        .scenario-table-wrap {
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.42);
        }

        [data-theme="dark"] .scenario-table-wrap {
            background: rgba(15, 23, 42, 0.65);
        }

        .scenario-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.72rem;
            table-layout: fixed;
        }

        .scenario-table th {
            text-align: left;
            padding: 0.45rem 0.5rem;
            background: rgba(30, 58, 95, 0.12);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.62rem;
        }

        .scenario-table td {
            padding: 0.42rem 0.5rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
            color: var(--text-primary);
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .scenario-table tbody tr:last-child td {
            border-bottom: none;
        }

        .feature-block {
            margin-top: 0.66rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.46);
        }

        [data-theme="dark"] .feature-block {
            background: rgba(15, 23, 42, 0.66);
        }

        .feature-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.36rem;
            flex-wrap: wrap;
        }

        .feature-head h4 {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .feature-head p {
            margin: 0;
            font-size: 0.71rem;
            color: var(--text-secondary);
            line-height: 1.42;
            width: 100%;
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.42rem;
        }

        .field {
            display: grid;
            gap: 0.2rem;
        }

        .field label {
            font-size: 0.66rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        .field input,
        .field select,
        .field textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.46rem 0.52rem;
            font-size: 0.75rem;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.68);
            font-family: 'Inter', sans-serif;
        }

        [data-theme="dark"] .field input,
        [data-theme="dark"] .field select,
        [data-theme="dark"] .field textarea {
            background: rgba(30, 41, 59, 0.74);
        }

        .field textarea {
            min-height: 58px;
            resize: vertical;
            line-height: 1.38;
        }

        .inline-actions {
            margin-top: 0.45rem;
            display: flex;
            align-items: center;
            gap: 0.45rem;
            flex-wrap: wrap;
        }

        .status-pill {
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.2rem 0.5rem;
            font-size: 0.67rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.66);
        }

        [data-theme="dark"] .status-pill {
            background: rgba(15, 23, 42, 0.72);
        }

        .status-pill.ok {
            color: #047857;
            border-color: rgba(16, 185, 129, 0.55);
        }

        .status-pill.warn {
            color: #b45309;
            border-color: rgba(245, 158, 11, 0.6);
        }

        .status-pill.err {
            color: #b91c1c;
            border-color: rgba(239, 68, 68, 0.58);
        }

        [data-theme="dark"] .status-pill.ok {
            color: #34d399;
        }

        [data-theme="dark"] .status-pill.warn {
            color: #fbbf24;
        }

        [data-theme="dark"] .status-pill.err {
            color: #f87171;
        }

        .equation-list {
            display: grid;
            gap: 0.25rem;
            max-height: 220px;
            overflow: auto;
            padding-right: 0.2rem;
        }

        .equation-line {
            font-size: 0.71rem;
            line-height: 1.4;
            color: var(--text-secondary);
            border-bottom: 1px dashed rgba(148, 163, 184, 0.24);
            padding-bottom: 0.14rem;
            font-family: 'JetBrains Mono', monospace;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .equation-line strong {
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }

        .scenario-list {
            width: 100%;
            min-height: 88px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.68);
            color: var(--text-primary);
            padding: 0.34rem;
            font-size: 0.74rem;
        }

        [data-theme="dark"] .scenario-list {
            background: rgba(30, 41, 59, 0.74);
        }

        .note-box {
            margin-top: 0.35rem;
            border: 1px dashed rgba(148, 163, 184, 0.46);
            border-radius: 8px;
            padding: 0.42rem;
            font-size: 0.71rem;
            line-height: 1.44;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.42);
            white-space: pre-line;
        }

        [data-theme="dark"] .note-box {
            background: rgba(30, 41, 59, 0.5);
        }

        .chart-panel {
            margin-top: 0.42rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.46rem;
            background: rgba(255, 255, 255, 0.56);
        }

        [data-theme="dark"] .chart-panel {
            background: rgba(15, 23, 42, 0.72);
        }

        .chart-panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.42rem;
            flex-wrap: wrap;
            margin-bottom: 0.32rem;
        }

        .chart-panel-head h5 {
            margin: 0;
            font-size: 0.74rem;
            color: var(--text-primary);
            letter-spacing: 0.01em;
        }

        .chart-canvas {
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.68);
            overflow: auto;
        }

        [data-theme="dark"] .chart-canvas {
            background: rgba(15, 23, 42, 0.74);
        }

        .chart-svg {
            width: 100%;
            min-width: 500px;
            height: auto;
            display: block;
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
        }

        .histogram-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.42rem;
        }

        .hist-placeholder {
            grid-column: 1 / -1;
            border: 1px dashed rgba(148, 163, 184, 0.5);
            border-radius: 8px;
            padding: 0.66rem;
            font-size: 0.72rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.58);
        }

        [data-theme="dark"] .hist-placeholder {
            background: rgba(30, 41, 59, 0.58);
        }

        .hist-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.4rem 0.44rem;
            background: rgba(255, 255, 255, 0.62);
        }

        [data-theme="dark"] .hist-card {
            background: rgba(30, 41, 59, 0.66);
        }

        .hist-head {
            display: flex;
            justify-content: space-between;
            gap: 0.35rem;
            align-items: baseline;
            margin-bottom: 0.24rem;
        }

        .hist-title {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .hist-range {
            font-size: 0.64rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .hist-bars {
            height: 96px;
            display: grid;
            grid-template-columns: repeat(14, minmax(0, 1fr));
            align-items: end;
            gap: 2px;
            padding: 0 1px;
        }

        .hist-bar {
            border-radius: 4px 4px 1px 1px;
            min-height: 2px;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.94), rgba(6, 182, 212, 0.85));
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .hist-bar.warn {
            background: linear-gradient(180deg, rgba(245, 158, 11, 0.92), rgba(251, 191, 36, 0.86));
            border-color: rgba(245, 158, 11, 0.48);
        }

        .hist-bar.err {
            background: linear-gradient(180deg, rgba(239, 68, 68, 0.92), rgba(248, 113, 113, 0.86));
            border-color: rgba(239, 68, 68, 0.48);
        }

        .hist-footer {
            margin-top: 0.26rem;
            font-size: 0.65rem;
            color: var(--text-muted);
            line-height: 1.45;
            font-family: 'JetBrains Mono', monospace;
        }

        .sankey-canvas {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.62);
            overflow: auto;
        }

        [data-theme="dark"] .sankey-canvas {
            background: rgba(15, 23, 42, 0.74);
        }

        .sankey-svg {
            width: 100%;
            min-width: 740px;
            height: auto;
            display: block;
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
        }

        .scenario-table tbody tr.clickable {
            cursor: pointer;
        }

        .scenario-table tbody tr.clickable:hover {
            background: rgba(59, 130, 246, 0.08);
        }

        .scenario-table tbody tr.clickable.selected {
            background: rgba(16, 185, 129, 0.14);
            outline: 1px solid rgba(16, 185, 129, 0.4);
        }

        .footer {
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            display: flex;
            justify-content: space-between;
            gap: 0.8rem;
            flex-wrap: wrap;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .footer a {
            color: inherit;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .root-gate {
            position: fixed;
            inset: 0;
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.2rem;
            background: rgba(2, 6, 23, 0.72);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }

        body.locked .root-gate {
            display: flex;
        }

        body.locked .navbar,
        body.locked .main-content,
        body.locked .page-background {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
        }

        .root-gate-card {
            width: 100%;
            max-width: 460px;
            border-radius: 16px;
            background: #0f172a;
            border: 1px solid rgba(245, 158, 11, 0.32);
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 20px 45px rgba(2, 6, 23, 0.5);
        }

        .root-gate-card .lock {
            width: 58px;
            height: 58px;
            border-radius: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            margin-bottom: 0.65rem;
        }

        .root-gate-card h2 {
            font-size: 1.2rem;
            color: #f8fafc;
            margin-bottom: 0.45rem;
        }

        .root-gate-card p {
            font-size: 0.84rem;
            color: #cbd5e1;
            line-height: 1.6;
        }

        .root-gate-actions {
            margin-top: 0.8rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .root-gate-actions button,
        .root-gate-actions a {
            border: none;
            border-radius: 10px;
            padding: 0.56rem 0.8rem;
            font-size: 0.8rem;
            font-weight: 700;
            text-decoration: none;
            cursor: pointer;
        }

        .root-gate-actions .login {
            color: #fff;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .root-gate-actions .back {
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: transparent;
            color: #e2e8f0;
        }

        .root-gate-note {
            margin-top: 0.55rem;
            font-size: 0.72rem;
            color: #94a3b8;
        }

        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 0.9rem 1.2rem;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 -2px 18px rgba(0, 0, 0, 0.08);
            font-size: 0.83rem;
            color: #334155;
            transition: transform 0.35s ease;
        }

        [data-theme="dark"] .cookie-banner {
            background: rgba(10, 15, 29, 0.95);
            color: #cbd5e1;
            border-top-color: rgba(148, 163, 184, 0.2);
        }

        .cookie-banner.hidden {
            transform: translateY(120%);
            pointer-events: none;
        }

        .cookie-banner a {
            color: #2563eb;
            text-decoration: underline;
        }

        .cookie-actions {
            display: flex;
            gap: 0.6rem;
            flex-shrink: 0;
        }

        .cookie-accept,
        .cookie-decline {
            border: 1px solid #cbd5e1;
            border-radius: 7px;
            padding: 0.42rem 0.8rem;
            font-size: 0.75rem;
            cursor: pointer;
            background: #fff;
        }

        .cookie-accept {
            border-color: #2563eb;
            background: #2563eb;
            color: #fff;
            font-weight: 700;
        }

        @media (max-width: 1180px) {
            .standards-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .calculator-layout {
                grid-template-columns: 1fr;
            }

            .architecture-layout {
                grid-template-columns: 1fr;
            }

            .pipeline-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .fullmap-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .logic-seq {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .mini-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 860px) {
            .hero-kpis {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .standards-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .pipeline {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .model-track {
                grid-template-columns: 1fr;
            }

            .model-arrow {
                display: none;
            }

            .pipeline-grid {
                grid-template-columns: 1fr;
            }

            .fullmap-grid {
                grid-template-columns: 1fr;
            }

            .fullmap-col:not(:last-child)::after {
                content: none;
            }

            .logic-seq {
                grid-template-columns: 1fr;
            }

            .logic-step:not(:last-child)::after {
                content: none;
            }

            .fullmap-col {
                min-height: 0;
            }

            .fullmap-nodes {
                max-height: 220px;
            }

            .mini-grid {
                grid-template-columns: 1fr;
            }

            .histogram-grid {
                grid-template-columns: 1fr;
            }

            .chart-svg {
                min-width: 420px;
            }

            .sankey-svg {
                min-width: 640px;
            }
        }

        @media (max-width: 640px) {
            .nav-container {
                padding: 0.75rem 0.9rem;
            }

            .brand-subtitle {
                display: none;
            }

            .main-content {
                padding: 1rem 0.9rem 2.5rem;
            }

            .hero {
                padding: 1.2rem;
            }

            .hero-kpis,
            .standards-grid,
            .input-grid,
            .cal-grid,
            .result-grid {
                grid-template-columns: 1fr;
            }

            .pipeline {
                grid-template-columns: 1fr;
            }

            .flow-row {
                grid-template-columns: 1fr;
                gap: 0.2rem;
            }

            .flow-row span:last-child {
                text-align: left;
            }

            .trace-grid {
                grid-template-columns: 1fr;
            }

            .fullmap-block {
                padding: 0.52rem;
            }

            .fullmap-col {
                padding: 0.36rem 0.38rem;
            }

            .fullmap-col h5 {
                font-size: 0.64rem;
                margin-bottom: 0.2rem;
            }

            .fullmap-nodes {
                max-height: 180px;
                gap: 0.16rem;
            }

            .fullmap-node {
                padding: 0.18rem 0.24rem;
                border-radius: 7px;
            }

            .fullmap-key,
            .fullmap-val {
                font-size: 0.62rem;
                line-height: 1.3;
            }

            .fullmap-note {
                font-size: 0.66rem;
                margin-top: 0.3rem;
            }

            .logic-seq-block {
                padding: 0.5rem;
            }

            .logic-step {
                padding: 0.3rem 0.34rem;
            }

            .logic-step h5,
            .logic-step p {
                font-size: 0.62rem;
            }

            .diagram-svg {
                min-width: 700px;
            }

            .tooltip-content,
            .term-tooltip-panel {
                width: min(280px, calc(100vw - 16px));
            }

            .chart-svg {
                min-width: 360px;
            }

            .sankey-svg {
                min-width: 560px;
            }

            .cookie-banner {
                flex-direction: column;
                text-align: center;
                gap: 0.55rem;
            }
        }
    </style>
</head>
<body class="locked">
    <div class="page-background" aria-hidden="true"></div>

    <nav class="navbar">
        <div class="nav-container">
            <a href="datacenter-solutions.html" class="nav-brand">
                <span class="brand-icon"><i class="fas fa-microchip"></i></span>
                <span>
                    <span class="brand-title">LTC System Modelling Lab</span>
                    <span class="brand-subtitle">Comprehensive Input-Process-Output Simulation</span>
                </span>
            </a>

            <div class="nav-links">
                <a href="datacenter-solutions.html" class="nav-back"><i class="fas fa-arrow-left"></i> DC Solutions</a>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme" title="Toggle dark/light mode">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="main-content" id="main-content">
        <section class="hero">
            <span class="hero-badge"><i class="fas fa-lock"></i> Root Only Module</span>
            <h1>Liquid-to-Chip System Modelling Laboratory</h1>
            <p>
                This page is dedicated to ultra-comprehensive modelling simulation: complete parameter traceability from all inputs,
                processing logic blocks, solver internals, control loops, calibration fitting, and final engineering outputs.
            </p>

            <div class="hero-kpis">
                <div class="hero-kpi">
                    <div class="kpi-label">Model Coverage</div>
                    <div class="kpi-value">Input-Process-Output</div>
                </div>
                <div class="hero-kpi">
                    <div class="kpi-label">Solver Scope</div>
                    <div class="kpi-value">Thermal + Hydraulic + Control</div>
                </div>
                <div class="hero-kpi">
                    <div class="kpi-label">Calibration</div>
                    <div class="kpi-value">Telemetry Fit Enabled</div>
                </div>
                <div class="hero-kpi">
                    <div class="kpi-label">Access Level</div>
                    <div class="kpi-value">Root</div>
                </div>
            </div>
        </section>

        <section class="legal-disclaimer-wrap" aria-label="Legal Disclaimer">
            <div class="legal-disclaimer">
                <p class="legal-disclaimer-title"><span aria-hidden="true">&#9888;</span> Legal Notice</p>
                <p>All dashboards, calculators, and technical materials are independent personal research based on public standards and references. They do not represent any current or former employer.</p>
                <p>Outputs are for educational and planning context only, not legal, financial, investment, procurement, safety, or engineering advice. Always validate final decisions with licensed professionals and applicable regulations.</p>
                <p>Use of this website is subject to our <a href="terms.html">Terms</a> and <a href="privacy.html">Privacy Policy</a>.</p>
            </div>
        </section>

        <section class="section" id="architecture">
            <div class="section-header">
                <h2>Integrated Engineering Architecture Focus</h2>
                <p>The model treats liquid cooling as one subsystem in a broader standards-driven engineering chain.</p>
            </div>
            <div class="architecture-layout">
                <div class="panel">
                    <h3>Thermal-Hydraulic Engineering Chain</h3>
                    <p>
                        The sizing model follows end-to-end heat transport: chip load capture, coolant transport, pumping duty,
                        CDU losses, and rejection path energy. This prevents underestimating total cooling parasitics.
                    </p>
                    <div class="pipeline">
                        <div class="step">
                            <div class="num">1</div>
                            <h4>Chip Heat</h4>
                            <p>GPU/CPU thermal load</p>
                        </div>
                        <div class="step">
                            <div class="num">2</div>
                            <h4>Cold Plate</h4>
                            <p>Capture ratio tuning</p>
                        </div>
                        <div class="step">
                            <div class="num">3</div>
                            <h4>CDU Loop</h4>
                            <p>Flow, head, pump duty</p>
                        </div>
                        <div class="step">
                            <div class="num">4</div>
                            <h4>Heat Rejection</h4>
                            <p>COP and climate effects</p>
                        </div>
                        <div class="step">
                            <div class="num">5</div>
                            <h4>Compliance</h4>
                            <p>Standards score fusion</p>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>Advanced Modeling Dimensions</h3>
                    <p>Calculator outputs include:</p>
                    <ul class="method-list" style="list-style:none;display:grid;gap:0.35rem;">
                        <li style="font-size:0.8rem;color:var(--text-secondary);">Thermal capture, coolant flow, and pumping power.</li>
                        <li style="font-size:0.8rem;color:var(--text-secondary);">CDU sizing under N, N+1, and 2N configurations.</li>
                        <li style="font-size:0.8rem;color:var(--text-secondary);">Composite PUE, WUE, annual energy, and OPEX.</li>
                        <li style="font-size:0.8rem;color:var(--text-secondary);">Cross-standard alignment score with weighted grading.</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="section" id="calculator">
            <div class="section-header">
                <h2>High-Fidelity Engineering Calculator</h2>
                <p>Use this model for detailed scenario comparison before final validation with licensed engineering teams.</p>
            </div>

            <div class="calculator-layout">
                <div class="calc-card">
                    <h3>Design Inputs</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="inItLoad">IT Load (MW)</label>
                            <input id="inItLoad" type="number" min="0.5" step="0.1" value="12">
                        </div>
                        <div class="input-group">
                            <label for="inRackCount">Rack Count</label>
                            <input id="inRackCount" type="number" min="20" step="1" value="360">
                        </div>
                        <div class="input-group">
                            <label for="inRackType">Rack Type Profile</label>
                            <select id="inRackType">
                                <option value="ai_hpc_direct_liquid">AI/HPC Direct Liquid</option>
                                <option value="enterprise_mixed">Enterprise Mixed</option>
                                <option value="immersion_single_phase">Immersion Single-Phase</option>
                                <option value="immersion_two_phase">Immersion Two-Phase</option>
                                <option value="legacy_air_plus_rdhx">Legacy Air + RDHx</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inRackDensityTarget">Target Rack Density (kW/rack)</label>
                            <input id="inRackDensityTarget" type="number" min="5" max="180" step="1" value="35">
                        </div>
                        <div class="input-group">
                            <label for="inHighDensityShare">High-Density Rack Share (%)</label>
                            <input id="inHighDensityShare" type="number" min="0" max="100" step="1" value="45">
                        </div>
                        <div class="input-group">
                            <label for="inModelYear">Model Horizon Year</label>
                            <input id="inModelYear" type="number" min="2026" max="2045" step="1" value="2026">
                        </div>
                        <div class="input-group">
                            <label for="inCountryProfile">Country Profile</label>
                            <select id="inCountryProfile">
                                <option value="custom">Custom Manual</option>
                                <option value="sg">Singapore</option>
                                <option value="us_va">USA - Virginia</option>
                                <option value="nl">Netherlands</option>
                                <option value="id_jkt">Indonesia - Jakarta</option>
                                <option value="in_mum">India - Mumbai</option>
                                <option value="ie">Ireland</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inClimate">Climate Profile</label>
                            <select id="inClimate">
                                <option value="tropical">Tropical</option>
                                <option value="temperate">Temperate</option>
                                <option value="dry">Dry</option>
                                <option value="continental">Continental</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inCoolingArchitecture">Cooling Architecture Preset</label>
                            <select id="inCoolingArchitecture">
                                <option value="direct_liquid">Direct Liquid (Warm-Water LTC)</option>
                                <option value="hybrid">Hybrid Liquid + Air</option>
                                <option value="air_inrow_dahu">Air-Cooling In-Row / DAHU</option>
                                <option value="manual">Manual (No Auto-Adjust)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inLiquidCapture">Liquid Capture (%)</label>
                            <input id="inLiquidCapture" type="number" min="0" max="100" step="1" value="85">
                        </div>
                        <div class="input-group">
                            <label for="inCoolant">Coolant Type</label>
                            <select id="inCoolant">
                                <option value="water">Water</option>
                                <option value="pg20">20% Propylene Glycol</option>
                                <option value="pg30">30% Propylene Glycol</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inSupplyTemp">Liquid Supply Temp (C)</label>
                            <input id="inSupplyTemp" type="number" step="0.1" value="30">
                        </div>
                        <div class="input-group">
                            <label for="inReturnTemp">Liquid Return Temp (C)</label>
                            <input id="inReturnTemp" type="number" step="0.1" value="38.5">
                        </div>
                        <div class="input-group">
                            <label for="inPumpHead">Pump Head (m)</label>
                            <input id="inPumpHead" type="number" min="5" step="0.5" value="28">
                        </div>
                        <div class="input-group">
                            <label for="inPumpEff">Pump Efficiency (%)</label>
                            <input id="inPumpEff" type="number" min="35" max="95" step="1" value="78">
                        </div>
                        <div class="input-group">
                            <label for="inHydraulicMargin">Hydraulic Margin (%)</label>
                            <input id="inHydraulicMargin" type="number" min="0" max="45" step="1" value="12">
                        </div>
                        <div class="input-group">
                            <label for="inControlQuality">Control Logic Quality (%)</label>
                            <input id="inControlQuality" type="number" min="0" max="100" step="1" value="86">
                        </div>
                        <div class="input-group">
                            <label for="inPredictiveGain">Predictive Control Gain (%)</label>
                            <input id="inPredictiveGain" type="number" min="0" max="60" step="1" value="12">
                        </div>
                        <div class="input-group">
                            <label for="inCoefHeatTransfer">Thermal Transfer Effectiveness (%)</label>
                            <input id="inCoefHeatTransfer" type="number" min="60" max="99" step="0.5" value="93">
                        </div>
                        <div class="input-group">
                            <label for="inCoefCduLoss">CDU Loss Coefficient (% Heat)</label>
                            <input id="inCoefCduLoss" type="number" min="0.5" max="4.5" step="0.1" value="1.8">
                        </div>
                        <div class="input-group">
                            <label for="inCoefPipeLoss">Pipe Loss Multiplier</label>
                            <input id="inCoefPipeLoss" type="number" min="0.75" max="1.8" step="0.01" value="1.00">
                        </div>
                        <div class="input-group">
                            <label for="inCoefFutureTech">Future Tech Multiplier (%)</label>
                            <input id="inCoefFutureTech" type="number" min="-10" max="45" step="1" value="0">
                        </div>
                        <div class="input-group">
                            <label for="inCduUnit">CDU Unit Capacity (kW)</label>
                            <input id="inCduUnit" type="number" min="300" step="50" value="1200">
                        </div>
                        <div class="input-group">
                            <label for="inRedundancy">Redundancy Topology</label>
                            <select id="inRedundancy">
                                <option value="N">N</option>
                                <option value="N1">N+1</option>
                                <option value="2N">2N</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inAirCop">Air Path COP</label>
                            <input id="inAirCop" type="number" min="1.5" step="0.1" value="4.2">
                        </div>
                        <div class="input-group">
                            <label for="inEconomizerHours">Economizer Availability (%)</label>
                            <input id="inEconomizerHours" type="number" min="0" max="95" step="1" value="28">
                        </div>
                        <div class="input-group">
                            <label for="inFanPower">Fan Power (% IT)</label>
                            <input id="inFanPower" type="number" min="0.5" max="12" step="0.1" value="3.2">
                        </div>
                        <div class="input-group">
                            <label for="inUpsEff">UPS Efficiency (%)</label>
                            <input id="inUpsEff" type="number" min="90" max="99.5" step="0.1" value="96.5">
                        </div>
                        <div class="input-group">
                            <label for="inDistLoss">Power Distribution Loss (% Input)</label>
                            <input id="inDistLoss" type="number" min="0.5" max="8" step="0.1" value="2.1">
                        </div>
                        <div class="input-group">
                            <label for="inHeatReuse">Heat Reuse Rate (% Liquid Path)</label>
                            <input id="inHeatReuse" type="number" min="0" max="80" step="1" value="18">
                        </div>
                        <div class="input-group">
                            <label for="inElecPrice">Electricity Price (USD/kWh)</label>
                            <input id="inElecPrice" type="number" min="0.02" step="0.005" value="0.11">
                        </div>
                        <div class="input-group">
                            <label for="inWaterTariff">Water Tariff (USD/m3)</label>
                            <input id="inWaterTariff" type="number" min="0.1" step="0.1" value="1.6">
                        </div>
                        <div class="input-group">
                            <label for="inCarbonIntensity">Grid Carbon Intensity (kgCO2e/kWh)</label>
                            <input id="inCarbonIntensity" type="number" min="0.05" max="1.1" step="0.01" value="0.42">
                        </div>
                        <div class="input-group">
                            <label for="inMonitoring">Monitoring Coverage (%)</label>
                            <input id="inMonitoring" type="number" min="0" max="100" step="1" value="92">
                        </div>
                        <div class="input-group">
                            <label for="inFireType">Fire Suppression Strategy</label>
                            <select id="inFireType">
                                <option value="clean_agent">Clean Agent</option>
                                <option value="water_mist">Water Mist</option>
                                <option value="double_interlock">Double-Interlock Pre-Action</option>
                                <option value="dry_pipe">Dry Pipe</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inTargetPue">Target PUE</label>
                            <input id="inTargetPue" type="number" min="1.05" step="0.01" value="1.20">
                        </div>
                        <div class="input-group">
                            <label for="inTargetCop">Target System COP</label>
                            <input id="inTargetCop" type="number" min="3" step="0.1" value="8.2">
                        </div>
                    </div>

                    <label class="check-wrap" for="inConcurrent">
                        <input id="inConcurrent" type="checkbox" checked>
                        Concurrent maintainability verified.
                    </label>

                    <div class="form-actions">
                        <button class="btn-primary" id="runCalc" type="button">Run High-Fidelity Model</button>
                        <button class="btn-accent" id="optimizeTarget" type="button">Optimize To Target</button>
                        <button class="btn-secondary" id="resetCalc" type="button">Reset</button>
                    </div>

                    <div class="calibration-block">
                        <div class="calibration-head">
                            <h4>Calibration Mode (Telemetry Fit)</h4>
                            <span class="calibration-status" id="calStatus">Not Calibrated</span>
                        </div>
                        <p class="calibration-note">Input measured telemetry to calibrate model coefficients. Minimum 2 measured KPI targets required.</p>
                        <div class="cal-grid">
                            <div class="input-group">
                                <label for="calTargetPue">Measured PUE</label>
                                <input id="calTargetPue" type="number" min="1.01" step="0.001" placeholder="e.g. 1.28">
                            </div>
                            <div class="input-group">
                                <label for="calTargetCop">Measured System COP</label>
                                <input id="calTargetCop" type="number" min="1.2" step="0.01" placeholder="e.g. 7.6">
                            </div>
                            <div class="input-group">
                                <label for="calTargetEnergy">Measured Annual Energy (GWh)</label>
                                <input id="calTargetEnergy" type="number" min="0.1" step="0.01" placeholder="e.g. 142.4">
                            </div>
                            <div class="input-group">
                                <label for="calTargetNetOpex">Measured Net OPEX (USD/year)</label>
                                <input id="calTargetNetOpex" type="number" min="1000" step="1000" placeholder="e.g. 14500000">
                            </div>
                            <div class="input-group">
                                <label for="calTargetCarbon">Measured Carbon (tCO2e/year)</label>
                                <input id="calTargetCarbon" type="number" min="1" step="1" placeholder="e.g. 42000">
                            </div>
                            <div class="input-group">
                                <label for="calTargetPump">Measured Pump Power (kW)</label>
                                <input id="calTargetPump" type="number" min="1" step="0.1" placeholder="e.g. 188">
                            </div>
                        </div>
                        <label class="check-wrap" for="calLockApply">
                            <input id="calLockApply" type="checkbox" checked>
                            Apply calibrated coefficients to active model inputs.
                        </label>
                        <div class="form-actions calibration-actions">
                            <button class="btn-accent" id="runCalibration" type="button">Run Calibration Fit</button>
                            <button class="btn-secondary" id="clearCalibration" type="button">Clear Calibration</button>
                        </div>
                        <p class="calibration-summary" id="calSummary">Calibration idle. Provide telemetry targets and run calibration.</p>
                    </div>

                    <p class="calc-footnote">
                        The model estimates thermodynamic and economic behavior using engineering assumptions for early-stage design screening. Note: "Liquid Supply/Return Temp" are coolant loop values, different from supply-air setpoint in DAHU/in-row systems.
                    </p>
                </div>

                <div class="calc-card">
                    <h3>Engineering Output</h3>
                    <div class="result-grid">
                        <div class="result-card"><span class="label">Country Profile</span><span class="value" id="outCountry">-</span></div>
                        <div class="result-card"><span class="label">Liquid Heat Captured</span><span class="value" id="outLiquidLoad">-</span></div>
                        <div class="result-card"><span class="label">Residual Air Heat</span><span class="value" id="outAirLoad">-</span></div>
                        <div class="result-card"><span class="label">Coolant Flow (Design)</span><span class="value" id="outFlow">-</span></div>
                        <div class="result-card"><span class="label">Pump Power</span><span class="value" id="outPump">-</span></div>
                        <div class="result-card"><span class="label">CDU Count</span><span class="value" id="outCdu">-</span></div>
                        <div class="result-card"><span class="label">Projected PUE</span><span class="value" id="outPue">-</span></div>
                        <div class="result-card"><span class="label">Projected System COP</span><span class="value" id="outCop">-</span></div>
                        <div class="result-card"><span class="label">Projected WUE</span><span class="value" id="outWue">-</span></div>
                        <div class="result-card"><span class="label">Annual Energy</span><span class="value" id="outEnergy">-</span></div>
                        <div class="result-card"><span class="label">Gross Annual OPEX</span><span class="value" id="outOpex">-</span></div>
                        <div class="result-card"><span class="label">Heat-Reuse Credit</span><span class="value" id="outHeatCredit">-</span></div>
                        <div class="result-card"><span class="label">Net Annual OPEX</span><span class="value" id="outNetOpex">-</span></div>
                        <div class="result-card"><span class="label">Annual Carbon</span><span class="value" id="outCarbon">-</span></div>
                        <div class="result-card"><span class="label">Carbon Avoided</span><span class="value" id="outCarbonAvoided">-</span></div>
                        <div class="result-card"><span class="label">Rack Type Profile</span><span class="value" id="outRackType">-</span></div>
                        <div class="result-card"><span class="label">Design Density</span><span class="value" id="outDesignDensity">-</span></div>
                        <div class="result-card"><span class="label">Control Logic Index</span><span class="value" id="outControlIndex">-</span></div>
                        <div class="result-card"><span class="label">Future Factor</span><span class="value" id="outFutureFactor">-</span></div>
                        <div class="result-card"><span class="label">Rack Density</span><span class="value" id="outRackDensity">-</span></div>
                        <div class="result-card"><span class="label">Risk Index</span><span class="value" id="outRisk">-</span></div>
                        <div class="result-card"><span class="label">Data Confidence</span><span class="value" id="outConfidence">-</span></div>
                        <div class="result-card"><span class="label">Calibration Fit</span><span class="value" id="outCalFit">-</span></div>
                    </div>

                    <div class="model-block">
                        <div class="model-head">
                            <h4><i class="fas fa-diagram-project"></i> Advanced Modelling Block Diagram</h4>
                            <p>Input profiles flow through thermal-hydraulic engine and produce quantified impact to efficiency, cost, and compliance.</p>
                        </div>
                        <div class="diagram-canvas" role="img" aria-label="End-to-end modelling block diagram showing input validation, thermal and hydraulic solver, control gates, cost, and compliance layers">
                            <svg class="diagram-svg" viewBox="0 0 1120 350" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <defs>
                                    <marker id="diagArrow" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
                                        <path d="M0,0 L10,4 L0,8 Z" fill="#64748b"></path>
                                    </marker>
                                </defs>

                                <path class="diag-line" d="M220 85 L300 85"></path>
                                <path class="diag-line" d="M500 85 L580 85"></path>
                                <path class="diag-line" d="M780 85 L860 85"></path>
                                <path class="diag-line" d="M690 145 L690 220"></path>
                                <path class="diag-line" d="M970 145 L970 220"></path>
                                <path class="diag-line" d="M780 265 L860 265"></path>
                                <path class="diag-line" d="M400 145 L400 220"></path>
                                <path class="diag-line" d="M500 275 L580 275"></path>
                                <path class="diag-line" d="M860 305 L500 305"></path>
                                <rect class="diag-gate-note-bg" x="220" y="14" rx="6" ry="6" width="152" height="20"></rect>
                                <text class="diag-caption" x="232" y="28">Validation + Bounds</text>
                                <rect class="diag-gate-note-bg" x="488" y="14" rx="6" ry="6" width="124" height="20"></rect>
                                <text class="diag-caption" x="500" y="28">Thermal Solver</text>
                                <rect class="diag-gate-note-bg" x="760" y="14" rx="6" ry="6" width="150" height="20"></rect>
                                <text class="diag-caption" x="772" y="28">Hydraulic + Energy</text>
                                <rect class="diag-gate-note-bg" x="492" y="186" rx="6" ry="6" width="204" height="20"></rect>
                                <text class="diag-caption" x="504" y="200">Calibration + Optimization Loop</text>

                                <rect class="diag-box diag-box-input" x="20" y="35" rx="12" ry="12" width="200" height="110"></rect>
                                <text class="diag-title" x="35" y="60">Input Profile</text>
                                <text class="diag-value" x="35" y="84" id="diagInputMain">-</text>
                                <text class="diag-value" x="35" y="104" id="diagInputSub">-</text>

                                <rect class="diag-box diag-box-thermal" x="300" y="35" rx="12" ry="12" width="200" height="110"></rect>
                                <text class="diag-title" x="315" y="60">Thermal Layer</text>
                                <text class="diag-value" x="315" y="84" id="diagThermalMain">-</text>
                                <text class="diag-value" x="315" y="104" id="diagThermalSub">-</text>

                                <rect class="diag-box diag-box-hydraulic" x="580" y="35" rx="12" ry="12" width="200" height="110"></rect>
                                <text class="diag-title" x="595" y="60">Hydraulic Layer</text>
                                <text class="diag-value" x="595" y="84" id="diagHydraulicMain">-</text>
                                <text class="diag-value" x="595" y="104" id="diagHydraulicSub">-</text>

                                <rect class="diag-box diag-box-impact" x="860" y="35" rx="12" ry="12" width="240" height="110"></rect>
                                <text class="diag-title" x="875" y="60">Impact Layer</text>
                                <text class="diag-value" x="875" y="84" id="diagImpactMain">-</text>
                                <text class="diag-value" x="875" y="104" id="diagImpactSub">-</text>

                                <rect class="diag-box diag-box-cost" x="580" y="220" rx="12" ry="12" width="200" height="110"></rect>
                                <text class="diag-title" x="595" y="245">Cost + Carbon</text>
                                <text class="diag-value" x="595" y="269" id="diagCostMain">-</text>
                                <text class="diag-value" x="595" y="289" id="diagCostSub">-</text>

                                <rect class="diag-box diag-box-control" x="300" y="220" rx="12" ry="12" width="200" height="110"></rect>
                                <text class="diag-title" x="315" y="245">Constraint + Control</text>
                                <text class="diag-value" x="315" y="269" id="diagControlMain">-</text>
                                <text class="diag-value" x="315" y="289" id="diagControlSub">-</text>

                                <rect class="diag-box diag-box-compliance" x="860" y="220" rx="12" ry="12" width="240" height="110"></rect>
                                <text class="diag-title" x="875" y="245">Compliance + Risk</text>
                                <text class="diag-value" x="875" y="269" id="diagComplianceMain">-</text>
                                <text class="diag-value" x="875" y="289" id="diagComplianceSub">-</text>
                            </svg>
                        </div>
                        <div class="model-track">
                            <div class="model-node">
                                <span class="tag">Input Profile</span>
                                <span class="val" id="modelInputNode">-</span>
                            </div>
                            <div class="model-arrow">&#8594;</div>
                            <div class="model-node">
                                <span class="tag">Thermal Engine</span>
                                <span class="val" id="modelEngineNode">-</span>
                            </div>
                            <div class="model-arrow">&#8594;</div>
                            <div class="model-node">
                                <span class="tag">Constraint + Control</span>
                                <span class="val" id="modelControlNode">-</span>
                            </div>
                            <div class="model-arrow">&#8594;</div>
                            <div class="model-node">
                                <span class="tag">Impact Layer</span>
                                <span class="val" id="modelImpactNode">-</span>
                            </div>
                        </div>
                        <div class="model-impact-grid">
                            <div class="model-impact">
                                <span class="k">PUE Gap to Target</span>
                                <span class="v" id="impactPueGap">-</span>
                            </div>
                            <div class="model-impact">
                                <span class="k">COP Gap to Target</span>
                                <span class="v" id="impactCopGap">-</span>
                            </div>
                            <div class="model-impact">
                                <span class="k">OPEX Delta vs Target Mode</span>
                                <span class="v" id="impactOpexDelta">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="control-block">
                        <div class="model-head">
                            <h4><i class="fas fa-arrows-spin"></i> Control/Logic Feedback Diagram</h4>
                            <p>Shows how sensor confidence, controller tuning, and predictive logic affect plant behavior and KPI outcomes in closed loop.</p>
                        </div>
                        <div class="diagram-canvas" role="img" aria-label="Control loop diagram for sensor-controller-actuator-feedback architecture with explicit decision gates">
                            <svg class="diagram-svg" viewBox="0 0 1120 340" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <defs>
                                    <marker id="diagArrowCtrl" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
                                        <path d="M0,0 L10,4 L0,8 Z" fill="#64748b"></path>
                                    </marker>
                                </defs>
                                <path class="control-loop" marker-end="url(#diagArrowCtrl)" d="M220 85 L320 85"></path>
                                <path class="control-loop" marker-end="url(#diagArrowCtrl)" d="M520 85 L620 85"></path>
                                <path class="control-loop" marker-end="url(#diagArrowCtrl)" d="M820 85 L920 85"></path>
                                <path class="control-loop" marker-end="url(#diagArrowCtrl)" d="M1040 140 L1040 245 L120 245 L120 140"></path>
                                <path class="diag-gate-link" d="M420 145 L420 170"></path>
                                <path class="diag-gate-link" d="M720 145 L720 170"></path>
                                <path class="diag-gate-link" d="M1010 145 L1010 170"></path>

                                <rect class="diag-box diag-box-input" x="20" y="35" rx="12" ry="12" width="200" height="110"></rect>
                                <text class="diag-title" x="35" y="60">Sensor Layer</text>
                                <text class="diag-value" x="35" y="84" id="ctrlSensorMain">-</text>
                                <text class="diag-value" x="35" y="104" id="ctrlSensorSub">-</text>

                                <rect class="diag-box diag-box-hydraulic" x="320" y="35" rx="12" ry="12" width="200" height="110"></rect>
                                <text class="diag-title" x="335" y="60">Controller</text>
                                <text class="diag-value" x="335" y="84" id="ctrlControllerMain">-</text>
                                <text class="diag-value" x="335" y="104" id="ctrlControllerSub">-</text>

                                <rect class="diag-box diag-box-thermal" x="620" y="35" rx="12" ry="12" width="200" height="110"></rect>
                                <text class="diag-title" x="635" y="60">Actuator Setpoint</text>
                                <text class="diag-value" x="635" y="84" id="ctrlActuatorMain">-</text>
                                <text class="diag-value" x="635" y="104" id="ctrlActuatorSub">-</text>

                                <rect class="diag-box diag-box-impact" x="920" y="35" rx="12" ry="12" width="180" height="110"></rect>
                                <text class="diag-title" x="935" y="60">Plant + KPI</text>
                                <text class="diag-value" x="935" y="84" id="ctrlPlantMain">-</text>
                                <text class="diag-value" x="935" y="104" id="ctrlPlantSub">-</text>

                                <polygon id="ctrlGateAPoly" class="diag-gate-shape" points="420,170 445,190 420,210 395,190"></polygon>
                                <text class="diag-title" x="404" y="193" style="font-size:11px;" id="ctrlGateAMain">G1</text>
                                <rect class="diag-gate-note-bg" x="350" y="257" rx="6" ry="6" width="142" height="20"></rect>
                                <text class="diag-gate-note" x="360" y="271" id="ctrlGateASub">-</text>

                                <polygon id="ctrlGateBPoly" class="diag-gate-shape" points="720,170 745,190 720,210 695,190"></polygon>
                                <text class="diag-title" x="704" y="193" style="font-size:11px;" id="ctrlGateBMain">G2</text>
                                <rect class="diag-gate-note-bg" x="650" y="257" rx="6" ry="6" width="142" height="20"></rect>
                                <text class="diag-gate-note" x="660" y="271" id="ctrlGateBSub">-</text>

                                <polygon id="ctrlGateCPoly" class="diag-gate-shape" points="1010,170 1035,190 1010,210 985,190"></polygon>
                                <text class="diag-title" x="994" y="193" style="font-size:11px;" id="ctrlGateCMain">G3</text>
                                <rect class="diag-gate-note-bg" x="940" y="257" rx="6" ry="6" width="142" height="20"></rect>
                                <text class="diag-gate-note" x="950" y="271" id="ctrlGateCSub">-</text>
                            </svg>
                        </div>
                    </div>

                    <div class="logic-seq-block">
                        <div class="model-head">
                            <h4><i class="fas fa-shuffle"></i> Execution Flow: Input -> Processing -> Control -> Output -> Re-Processing</h4>
                            <p>This chain is the canonical execution order used by the model engine on every run.</p>
                        </div>
                        <div class="logic-seq">
                            <article class="logic-step">
                                <h5><span class="n">1</span>Input Vector</h5>
                                <p id="seqInput">-</p>
                            </article>
                            <article class="logic-step">
                                <h5><span class="n">2</span>Processing Algorithm</h5>
                                <p id="seqProcessing">-</p>
                            </article>
                            <article class="logic-step">
                                <h5><span class="n">3</span>Control Logic Gates</h5>
                                <p id="seqControl">-</p>
                            </article>
                            <article class="logic-step">
                                <h5><span class="n">4</span>Output Vector</h5>
                                <p id="seqOutput">-</p>
                            </article>
                            <article class="logic-step">
                                <h5><span class="n">5</span>Feedback Processing</h5>
                                <p id="seqFeedback">-</p>
                            </article>
                        </div>
                    </div>

                    <div class="pipeline-block">
                        <div class="pipeline-head">
                            <h4><i class="fas fa-network-wired"></i> Complete Variable Processing Flow</h4>
                            <p>Full chain from all input variables, derived/control processing, solver internals, and final outputs.</p>
                        </div>
                        <div class="pipeline-grid">
                            <article class="pipeline-stage">
                                <h5>Stage 1 - Input Vector (<span id="stageInputCount">0</span>)</h5>
                                <div class="stage-lines" id="stageInputLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 2 - Derived Core</h5>
                                <div class="stage-lines" id="stageDerivedLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 3 - Control Logic</h5>
                                <div class="stage-lines" id="stageControlLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 4 - Thermal/Hydraulic Solver</h5>
                                <div class="stage-lines" id="stageSolverLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 5 - Energy/Economic</h5>
                                <div class="stage-lines" id="stageEconomicLines"></div>
                            </article>
                            <article class="pipeline-stage">
                                <h5>Stage 6 - Output Vector (<span id="stageOutputCount">0</span>)</h5>
                                <div class="stage-lines" id="stageOutputLines"></div>
                            </article>
                        </div>
                    </div>

                    <div class="fullmap-block">
                        <div class="pipeline-head">
                            <h4><i class="fas fa-diagram-project"></i> Complete Input-Processing-Output Block Map</h4>
                            <p>Every active variable is rendered as a live node. Hover each parameter for technical meaning, benchmark, and formula context.</p>
                        </div>
                        <div class="fullmap-grid">
                            <article class="fullmap-col">
                                <h5>Input Nodes (<span id="mapInputCount">0</span>)</h5>
                                <div class="fullmap-nodes" id="mapInputNodes"></div>
                            </article>
                            <article class="fullmap-col">
                                <h5>Processing Nodes (<span id="mapProcessCount">0</span>)</h5>
                                <div class="fullmap-nodes" id="mapProcessNodes"></div>
                            </article>
                            <article class="fullmap-col">
                                <h5>Output Nodes (<span id="mapOutputCount">0</span>)</h5>
                                <div class="fullmap-nodes" id="mapOutputNodes"></div>
                            </article>
                        </div>
                        <p class="fullmap-note">Block map updates on every model run, optimization run, and calibration run. Text wrapping is forced to avoid overflow for long variables.</p>
                    </div>

                    <div class="flow-block">
                        <div class="flow-head">
                            <h4><i class="fas fa-sitemap"></i> Dynamic Energy + Loss Breakdown</h4>
                            <p>Live share of major loads from IT input to final facility demand.</p>
                        </div>
                        <div class="flow-row">
                            <span>IT Core Load</span>
                            <div class="flow-bar"><i id="barFlowIt"></i></div>
                            <span id="flowIt">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Liquid Cooling</span>
                            <div class="flow-bar"><i id="barFlowLiquid"></i></div>
                            <span id="flowLiquid">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Air Path Cooling</span>
                            <div class="flow-bar"><i id="barFlowAir"></i></div>
                            <span id="flowAir">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Pump + Hydraulics</span>
                            <div class="flow-bar"><i id="barFlowPump"></i></div>
                            <span id="flowPump">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Electrical Losses</span>
                            <div class="flow-bar"><i id="barFlowElecLoss"></i></div>
                            <span id="flowElecLoss">-</span>
                        </div>
                        <div class="flow-row">
                            <span>Other Aux + Fan</span>
                            <div class="flow-bar"><i id="barFlowAux"></i></div>
                            <span id="flowAux">-</span>
                        </div>
                    </div>

                    <div class="target-block">
                        <div class="target-head">
                            <h4>Target Guidance Engine</h4>
                            <span class="target-badge" id="targetGapBadge">Gap: -</span>
                        </div>
                        <ul class="target-list" id="targetActions">
                            <li>Run model to generate optimization actions.</li>
                        </ul>
                        <div class="scenario-table-wrap">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Scenario</th>
                                        <th>PUE</th>
                                        <th>System COP</th>
                                        <th>Annual OPEX</th>
                                        <th>Annual Carbon</th>
                                        <th>WUE</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Baseline</td>
                                        <td id="basePue">-</td>
                                        <td id="baseCop">-</td>
                                        <td id="baseNetOpex">-</td>
                                        <td id="baseCarbon">-</td>
                                        <td id="baseWue">-</td>
                                    </tr>
                                    <tr>
                                        <td>Optimized</td>
                                        <td id="optPue">-</td>
                                        <td id="optCop">-</td>
                                        <td id="optNetOpex">-</td>
                                        <td id="optCarbon">-</td>
                                        <td id="optWue">-</td>
                                    </tr>
                                    <tr>
                                        <td>Delta</td>
                                        <td id="deltaPue">-</td>
                                        <td id="deltaCop">-</td>
                                        <td id="deltaNetOpex">-</td>
                                        <td id="deltaCarbon">-</td>
                                        <td id="deltaWue">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Constraint + Degraded Mode Engine</h4>
                            <span class="status-pill" id="constraintStatus">Constraints Pending</span>
                            <p>Define hard engineering limits and test degraded operating modes. Optimizer can enforce these constraints.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="inFailureMode">Failure / Degraded Mode</label>
                                <select id="inFailureMode">
                                    <option value="normal">Normal Operation</option>
                                    <option value="pump_degraded">Pump Degraded</option>
                                    <option value="sensor_degraded">Sensor Degraded</option>
                                    <option value="heatwave">Heatwave Stress</option>
                                    <option value="grid_stress">Grid Stress</option>
                                    <option value="redundancy_degraded">Redundancy Degraded</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="conPueMax">Hard PUE Max</label>
                                <input id="conPueMax" type="number" step="0.001" min="1.01" value="1.250">
                            </div>
                            <div class="field">
                                <label for="conCopMin">Hard COP Min</label>
                                <input id="conCopMin" type="number" step="0.01" min="1.0" value="7.00">
                            </div>
                            <div class="field">
                                <label for="conRiskMax">Hard Risk Max</label>
                                <input id="conRiskMax" type="number" step="0.1" min="1" max="100" value="40">
                            </div>
                            <div class="field">
                                <label for="conPumpPctMax">Hard Pump % of IT Max</label>
                                <input id="conPumpPctMax" type="number" step="0.1" min="0.5" max="20" value="3.0">
                            </div>
                            <div class="field">
                                <label for="conEnforce">Enforce Hard Constraints</label>
                                <select id="conEnforce">
                                    <option value="yes">Yes (Hard)</option>
                                    <option value="no">No (Soft Ranking)</option>
                                </select>
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-secondary" id="applyConstraintBtn" type="button">Apply Constraint Set</button>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Control Logic DSL / Rule Editor</h4>
                            <span class="status-pill" id="ruleStatus">Rule Set: Default</span>
                            <p>Editable gate rules for G1/G2/G3. Variables available: monitoring, controlIndex, deltaT, pumpPowerPctIt, riskIndex, pue, targetPue, cop, targetCop.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="ruleG1">Rule G1 (Sensor Quality Gate)</label>
                                <textarea id="ruleG1">monitoring >= 85 && controlIndex >= 78</textarea>
                            </div>
                            <div class="field">
                                <label for="ruleG2">Rule G2 (Actuator Limit Gate)</label>
                                <textarea id="ruleG2">deltaT >= 7.5 && pumpPowerPctIt <= 3</textarea>
                            </div>
                            <div class="field">
                                <label for="ruleG3">Rule G3 (Risk Guard Gate)</label>
                                <textarea id="ruleG3">riskIndex <= 35 && pue <= targetPue + 0.02</textarea>
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-secondary" id="applyRulesBtn" type="button">Apply Rule Set</button>
                            <button class="btn-secondary" id="resetRulesBtn" type="button">Reset Default Rules</button>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Equation Inspector Panel</h4>
                            <p>Live substituted equations with units and active values from the current simulation state.</p>
                        </div>
                        <div class="equation-list" id="equationList">
                            <div class="equation-line">Run model to populate equations.</div>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Pareto Frontier Explorer (Multi-Objective)</h4>
                            <span class="status-pill" id="paretoStatus">Frontier Not Generated</span>
                            <p>Generate non-dominated trade-offs across PUE, Net OPEX, Carbon, and Risk. Click a row to apply that scenario.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="paretoSamples">Pareto Samples</label>
                                <input id="paretoSamples" type="number" min="200" step="100" value="1400">
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-accent" id="runPareto" type="button">Generate Pareto Frontier</button>
                            <button class="btn-secondary" id="applyParetoBest" type="button">Apply Best Feasible Point</button>
                        </div>
                        <div class="scenario-table-wrap" style="margin-top:0.38rem;">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Point</th>
                                        <th>PUE</th>
                                        <th>COP</th>
                                        <th>Net OPEX</th>
                                        <th>Carbon</th>
                                        <th>Risk</th>
                                    </tr>
                                </thead>
                                <tbody id="paretoRows">
                                    <tr><td colspan="6">Generate Pareto frontier to view non-dominated points.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="chart-panel">
                            <div class="chart-panel-head">
                                <h5>Pareto Scatter (PUE vs Net OPEX)</h5>
                                <span class="status-pill" id="paretoScatterMeta">No Pareto Points</span>
                            </div>
                            <div class="chart-canvas">
                                <svg id="paretoScatterSvg" class="chart-svg" viewBox="0 0 560 260" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Pareto scatter plot for PUE and Net OPEX">
                                    <text x="18" y="26" fill="currentColor" opacity="0.7" font-size="12">Generate Pareto frontier to render scatter chart.</text>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Monte Carlo Uncertainty Mode</h4>
                            <span class="status-pill" id="mcStatus">Distribution Not Generated</span>
                            <p>Uncertainty propagation around current assumptions (P10/P50/P90) for KPI robustness checks.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="mcSamples">Simulation Samples</label>
                                <input id="mcSamples" type="number" min="200" step="100" value="1200">
                            </div>
                            <div class="field">
                                <label for="mcUncertainty">Input Uncertainty (%)</label>
                                <input id="mcUncertainty" type="number" min="1" max="30" step="1" value="7">
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-accent" id="runMonteCarlo" type="button">Run Monte Carlo</button>
                        </div>
                        <div class="scenario-table-wrap" style="margin-top:0.38rem;">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>P10</th>
                                        <th>P50</th>
                                        <th>P90</th>
                                    </tr>
                                </thead>
                                <tbody id="mcRows">
                                    <tr><td colspan="4">Run Monte Carlo to generate uncertainty bands.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="chart-panel">
                            <div class="chart-panel-head">
                                <h5>Monte Carlo Distribution Charts</h5>
                                <span class="status-pill" id="mcDistributionMeta">No Distribution Yet</span>
                            </div>
                            <div class="histogram-grid" id="mcDistributionCharts">
                                <div class="hist-placeholder">Run Monte Carlo to render distribution histograms.</div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Facility Distribution Sankey Chart</h4>
                            <span class="status-pill" id="sankeyStatus">Waiting Model State</span>
                            <p>Live flow map of facility power distribution from total input toward compute, thermal branches, electrical loss, and auxiliary load.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="sankeyMode">Sankey View Mode</label>
                                <select id="sankeyMode">
                                    <option value="auto">Auto (Active Model)</option>
                                    <option value="baseline">Baseline Only</option>
                                    <option value="optimized">Optimized Only</option>
                                    <option value="compare">Compare Baseline vs Optimized</option>
                                </select>
                            </div>
                        </div>
                        <div class="sankey-canvas">
                            <svg id="energySankeySvg" class="sankey-svg" viewBox="0 0 860 360" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Sankey chart of facility load distribution">
                                <text x="18" y="28" fill="currentColor" opacity="0.7" font-size="12">Run model to render Sankey distribution.</text>
                            </svg>
                        </div>
                        <div class="note-box" id="sankeySummary">Sankey summary will appear after model execution.</div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Calibration Quality Layer</h4>
                            <span class="status-pill" id="calQualityStatus">No Calibration Quality Data</span>
                            <p>Residual diagnostics with train/validation split and 95% confidence interval of relative residual error.</p>
                        </div>
                        <div class="note-box" id="calQualitySummary">Calibration quality pending. Run calibration to evaluate fit quality.</div>
                        <div class="scenario-table-wrap" style="margin-top:0.36rem;">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Target</th>
                                        <th>Predicted</th>
                                        <th>Residual %</th>
                                    </tr>
                                </thead>
                                <tbody id="calQualityRows">
                                    <tr><td colspan="4">No residual diagnostics yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Scenario Manager (Versioned)</h4>
                            <p>Save, load, delete, and compare named scenario snapshots with assumption version metadata.</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="scenarioName">Scenario Name</label>
                                <input id="scenarioName" type="text" placeholder="e.g. SG-AI-Heatwave-v2">
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-secondary" id="saveScenarioBtn" type="button">Save Scenario</button>
                            <button class="btn-secondary" id="loadScenarioBtn" type="button">Load Selected</button>
                            <button class="btn-secondary" id="deleteScenarioBtn" type="button">Delete Selected</button>
                        </div>
                        <select class="scenario-list" id="scenarioSelect" size="5"></select>
                        <div class="note-box" id="scenarioDiff">Select two scenarios sequentially to compare deltas.</div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Data Provenance + Assumption Ledger</h4>
                            <p>Parameter source tracking with owner, confidence score, and timestamp for governance/audit context.</p>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-secondary" id="refreshLedger" type="button">Refresh Timestamps</button>
                        </div>
                        <div class="scenario-table-wrap" style="margin-top:0.36rem;">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Parameter</th>
                                        <th>Source</th>
                                        <th>Owner</th>
                                        <th>Confidence</th>
                                        <th>Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody id="ledgerRows">
                                    <tr><td colspan="5">Ledger not loaded.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="feature-block">
                        <div class="feature-head">
                            <h4>Executive + Engineering Export Packs</h4>
                            <p>Generate downloadable report packs for board-level communication, engineering deep-dive review, and printable PDF reports (single or compare mode).</p>
                        </div>
                        <div class="mini-grid">
                            <div class="field">
                                <label for="pdfSingleSource">PDF Single Source</label>
                                <select id="pdfSingleSource">
                                    <option value="live_baseline">Current Baseline Model</option>
                                    <option value="live_optimized">Current Optimized Model</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="pdfCompareLeft">PDF Compare Left</label>
                                <select id="pdfCompareLeft">
                                    <option value="live_baseline">Current Baseline Model</option>
                                    <option value="live_optimized">Current Optimized Model</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="pdfCompareRight">PDF Compare Right</label>
                                <select id="pdfCompareRight">
                                    <option value="live_optimized">Current Optimized Model</option>
                                    <option value="live_baseline">Current Baseline Model</option>
                                </select>
                            </div>
                        </div>
                        <div class="inline-actions">
                            <button class="btn-accent" id="exportExecutive" type="button">Export Executive Pack</button>
                            <button class="btn-secondary" id="exportEngineering" type="button">Export Engineering Pack</button>
                            <button class="btn-secondary" id="exportPdfSingle" type="button">Export PDF (Single)</button>
                            <button class="btn-secondary" id="exportPdfCompare" type="button">Export PDF (Compare)</button>
                            <span class="status-pill" id="exportStatus">No Export Yet</span>
                        </div>
                        <div class="note-box">PDF export opens a print-ready report in a new tab. Use browser option "Save as PDF" for final file output.</div>
                    </div>

                    <div class="trace-block">
                        <div class="trace-head">
                            <h4>100% Parameter Coverage Matrix</h4>
                            <span class="trace-badge" id="traceSummary">Inputs - | Outputs -</span>
                        </div>
                        <div class="trace-grid">
                            <div class="trace-col">
                                <h5>Input Parameters (<span id="inParamCount">0</span>)</h5>
                                <div class="trace-list" id="inputTraceList"></div>
                            </div>
                            <div class="trace-col">
                                <h5>Output Parameters (<span id="outParamCount">0</span>)</h5>
                                <div class="trace-list" id="outputTraceList"></div>
                            </div>
                        </div>
                    </div>

                    <div class="sensitivity-block">
                        <h4>Logic Impact Matrix (Editable Algorithm Effects)</h4>
                        <p>Each row estimates local sensitivity: if one parameter shifts by one step, how key outputs are affected.</p>
                        <div class="scenario-table-wrap">
                            <table class="scenario-table">
                                <thead>
                                    <tr>
                                        <th>Input Parameter</th>
                                        <th>Step</th>
                                        <th>Delta PUE</th>
                                        <th>Delta COP</th>
                                        <th>Delta Net OPEX</th>
                                        <th>Delta Carbon</th>
                                        <th>Delta Risk</th>
                                    </tr>
                                </thead>
                                <tbody id="impactRows">
                                    <tr><td colspan="7">Run model to generate impact matrix.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="scoreboard">
                        <div class="score-row">
                            <span class="score-title">Composite Standards Alignment</span>
                            <span class="score-value" id="outScore">-</span>
                        </div>
                        <p class="score-grade" id="outGrade">Grade: -</p>
                    </div>

                    <div class="compliance-grid">
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">ASHRAE Thermal Envelope</span><span class="compliance-score" id="scoreAshrae">-</span></div>
                            <div class="progress"><i id="barAshrae"></i></div>
                        </div>
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">ANSI/TIA Infrastructure Readiness</span><span class="compliance-score" id="scoreAnsi">-</span></div>
                            <div class="progress"><i id="barAnsi"></i></div>
                        </div>
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">ISO Energy Governance</span><span class="compliance-score" id="scoreIso">-</span></div>
                            <div class="progress"><i id="barIso"></i></div>
                        </div>
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">NFPA Safety Posture</span><span class="compliance-score" id="scoreNfpa">-</span></div>
                            <div class="progress"><i id="barNfpa"></i></div>
                        </div>
                        <div class="compliance-item">
                            <div class="compliance-head"><span class="compliance-name">Uptime Tier Alignment</span><span class="compliance-score" id="scoreUptime">-</span></div>
                            <div class="progress"><i id="barUptime"></i></div>
                        </div>
                    </div>

                    <div class="method-block">
                        <h4>Methodology Snapshot</h4>
                        <ul>
                            <li>Mass flow uses Q = m * Cp * deltaT with coolant-specific properties.</li>
                            <li>Pump duty includes redundancy factor, hydraulic margin, and efficiency correction.</li>
                            <li>Cooling energy blends liquid + air path with economizer and part-load corrections.</li>
                            <li>PUE includes UPS and distribution losses, fan load, and auxiliary systems.</li>
                            <li>Net OPEX and carbon include heat reuse credit and displacement benefit.</li>
                            <li>Composite score uses weighted standard-specific criteria plus risk modifiers.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <p>LTC System Modelling Lab - ResistanceZero - 2026</p>
            <p><a href="terms.html">Terms</a> - <a href="privacy.html">Privacy</a> - <a href="datacenter-solutions.html">Back to DC Solutions</a></p>
        </footer>
    </main>

    <div class="root-gate" id="rootGate" aria-live="polite">
        <div class="root-gate-card">
            <div class="lock"><i class="fas fa-lock"></i></div>
            <h2>Root Access Required</h2>
            <p>This page is restricted. Sign in with a root account to open the standards and liquid-to-chip lab.</p>
            <div class="root-gate-actions">
                <button class="login" id="rootLoginBtn" type="button">Sign In as Root</button>
                <a class="back" href="datacenter-solutions.html">Back</a>
            </div>
            <p class="root-gate-note">Allowed root emails: admin@resistancezero.com, bagus@resistancezero.com</p>
        </div>
    </div>

    <div class="cookie-banner hidden" id="cookieBanner">
        <p>We use cookies for analytics to improve your experience. <a href="privacy.html">Learn more</a></p>
        <div class="cookie-actions">
            <button class="cookie-accept" id="cookieAccept">Accept</button>
            <button class="cookie-decline" id="cookieDecline">Decline</button>
        </div>
    </div>

    <script>
        (function initTheme() {
            var themeToggle = document.getElementById('themeToggle');
            var prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

            function preferredTheme() {
                var saved = localStorage.getItem('theme');
                if (saved) return saved;
                return prefersDark.matches ? 'dark' : 'light';
            }

            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                var icon = themeToggle.querySelector('i');
                if (icon) {
                    icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                }
                var metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) metaTheme.setAttribute('content', theme === 'dark' ? '#0a0f1d' : '#ffffff');
            }

            applyTheme(preferredTheme());

            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    var current = document.documentElement.getAttribute('data-theme');
                    applyTheme(current === 'dark' ? 'light' : 'dark');
                });
            }
        })();

        (function initCalculator() {
            var COUNTRY_PROFILES = {
                custom: { label: 'Custom Manual' },
                sg: { label: 'Singapore', climate: 'tropical', elecPrice: 0.22, waterTariff: 2.7, airCop: 4.0, targetPue: 1.23, targetCop: 7.8, economizerHours: 22, carbonIntensity: 0.41, upsEff: 96.8, distLoss: 2.2 },
                us_va: { label: 'USA - Virginia', climate: 'temperate', elecPrice: 0.11, waterTariff: 1.3, airCop: 4.9, targetPue: 1.18, targetCop: 8.8, economizerHours: 48, carbonIntensity: 0.31, upsEff: 97.2, distLoss: 1.9 },
                nl: { label: 'Netherlands', climate: 'temperate', elecPrice: 0.17, waterTariff: 1.9, airCop: 5.1, targetPue: 1.16, targetCop: 9.1, economizerHours: 52, carbonIntensity: 0.27, upsEff: 97.4, distLoss: 1.8 },
                id_jkt: { label: 'Indonesia - Jakarta', climate: 'tropical', elecPrice: 0.1, waterTariff: 1.6, airCop: 4.1, targetPue: 1.26, targetCop: 7.5, economizerHours: 18, carbonIntensity: 0.73, upsEff: 96.1, distLoss: 2.4 },
                in_mum: { label: 'India - Mumbai', climate: 'tropical', elecPrice: 0.12, waterTariff: 1.4, airCop: 4.2, targetPue: 1.24, targetCop: 7.7, economizerHours: 20, carbonIntensity: 0.69, upsEff: 96.0, distLoss: 2.5 },
                ie: { label: 'Ireland', climate: 'temperate', elecPrice: 0.18, waterTariff: 2.2, airCop: 5.0, targetPue: 1.15, targetCop: 9.3, economizerHours: 58, carbonIntensity: 0.29, upsEff: 97.5, distLoss: 1.7 }
            };

            var CLIMATE_FACTORS = {
                tropical: { wetBulb: 26, baseWue: 0.62, climateCopBias: -0.45 },
                temperate: { wetBulb: 17, baseWue: 0.22, climateCopBias: 0.38 },
                dry: { wetBulb: 16, baseWue: 0.30, climateCopBias: 0.55 },
                continental: { wetBulb: 19, baseWue: 0.38, climateCopBias: 0.22 }
            };

            var RACK_PROFILES = {
                ai_hpc_direct_liquid: { label: 'AI/HPC Direct Liquid', baseDensity: 70, liquidBias: 1.18, airResidual: 0.24, riskBias: 7, futureBias: 1.18 },
                enterprise_mixed: { label: 'Enterprise Mixed', baseDensity: 28, liquidBias: 0.86, airResidual: 0.56, riskBias: 3, futureBias: 0.72 },
                immersion_single_phase: { label: 'Immersion Single-Phase', baseDensity: 85, liquidBias: 1.28, airResidual: 0.14, riskBias: 6, futureBias: 1.28 },
                immersion_two_phase: { label: 'Immersion Two-Phase', baseDensity: 100, liquidBias: 1.36, airResidual: 0.08, riskBias: 7, futureBias: 1.4 },
                legacy_air_plus_rdhx: { label: 'Legacy Air + RDHx', baseDensity: 22, liquidBias: 0.62, airResidual: 0.72, riskBias: 11, futureBias: 0.42 }
            };

            var COOLANTS = {
                water: { cp: 4.186, rho: 997 },
                pg20: { cp: 3.92, rho: 1025 },
                pg30: { cp: 3.75, rho: 1038 }
            };

            var COOLING_ARCH_PROFILES = {
                direct_liquid: {
                    label: 'Direct Liquid (Warm-Water LTC)',
                    rackType: 'ai_hpc_direct_liquid',
                    liquidCapture: 85,
                    supplyTemp: 30,
                    returnTemp: 38.5,
                    airCop: 4.2,
                    fanPower: 3.2,
                    economizerHours: 28,
                    coefHeatTransfer: 93,
                    coefPipeLoss: 1.0
                },
                hybrid: {
                    label: 'Hybrid Liquid + Air',
                    rackType: 'enterprise_mixed',
                    liquidCapture: 58,
                    supplyTemp: 24,
                    returnTemp: 32,
                    airCop: 4.8,
                    fanPower: 3.8,
                    economizerHours: 34,
                    coefHeatTransfer: 88,
                    coefPipeLoss: 1.02
                },
                air_inrow_dahu: {
                    label: 'Air-Cooling In-Row / DAHU',
                    rackType: 'legacy_air_plus_rdhx',
                    liquidCapture: 18,
                    supplyTemp: 18,
                    returnTemp: 24,
                    airCop: 3.9,
                    fanPower: 4.8,
                    economizerHours: 24,
                    coefHeatTransfer: 78,
                    coefPipeLoss: 1.05
                }
            };

            var DEFAULTS = {
                inItLoad: 12,
                inRackCount: 360,
                inRackType: 'ai_hpc_direct_liquid',
                inRackDensityTarget: 35,
                inHighDensityShare: 45,
                inModelYear: 2026,
                inCoolingArchitecture: 'direct_liquid',
                inLiquidCapture: 85,
                inCoolant: 'water',
                inSupplyTemp: 30,
                inReturnTemp: 38.5,
                inPumpHead: 28,
                inPumpEff: 78,
                inHydraulicMargin: 12,
                inControlQuality: 86,
                inPredictiveGain: 12,
                inCoefHeatTransfer: 93,
                inCoefCduLoss: 1.8,
                inCoefPipeLoss: 1.0,
                inCoefFutureTech: 0,
                inCduUnit: 1200,
                inRedundancy: 'N1',
                inClimate: 'tropical',
                inCountryProfile: 'custom',
                inAirCop: 4.2,
                inEconomizerHours: 28,
                inFanPower: 3.2,
                inUpsEff: 96.5,
                inDistLoss: 2.1,
                inHeatReuse: 18,
                inElecPrice: 0.11,
                inWaterTariff: 1.6,
                inCarbonIntensity: 0.42,
                inMonitoring: 92,
                inFireType: 'clean_agent',
                inTargetPue: 1.2,
                inTargetCop: 8.2,
                inFailureMode: 'normal',
                inConcurrent: true,
                conPueMax: 1.25,
                conCopMin: 7.0,
                conRiskMax: 40,
                conPumpPctMax: 3.0,
                conEnforce: 'yes',
                ruleG1: 'monitoring >= 85 && controlIndex >= 78',
                ruleG2: 'deltaT >= 7.5 && pumpPowerPctIt <= 3',
                ruleG3: 'riskIndex <= 35 && pue <= targetPue + 0.02',
                paretoSamples: 1400,
                mcSamples: 1200,
                mcUncertainty: 7,
                scenarioName: '',
                calTargetPue: '',
                calTargetCop: '',
                calTargetEnergy: '',
                calTargetNetOpex: '',
                calTargetCarbon: '',
                calTargetPump: '',
                calLockApply: true
            };

            var IMPACT_PARAMS = [
                { key: 'itLoadMw', label: 'IT Load', step: 0.2, min: 0.5, max: 80, unit: 'MW' },
                { key: 'liquidCapture', label: 'Liquid Capture', step: 2, min: 0, max: 100, unit: '%' },
                { key: 'rackDensityTarget', label: 'Target Density', step: 2, min: 5, max: 180, unit: 'kW/rack' },
                { key: 'supplyTemp', label: 'Supply Temp', step: 0.5, min: 16, max: 42, unit: 'C' },
                { key: 'pumpEff', label: 'Pump Efficiency', step: 1, min: 35, max: 95, unit: '%' },
                { key: 'airCop', label: 'Air COP', step: 0.2, min: 1.5, max: 12, unit: '' },
                { key: 'economizerHours', label: 'Economizer', step: 3, min: 0, max: 95, unit: '%' },
                { key: 'controlQuality', label: 'Control Quality', step: 3, min: 0, max: 100, unit: '%' },
                { key: 'predictiveGain', label: 'Predictive Gain', step: 3, min: 0, max: 60, unit: '%' },
                { key: 'coefHeatTransfer', label: 'Heat Transfer Coef', step: 0.5, min: 60, max: 99, unit: '%' },
                { key: 'coefPipeLoss', label: 'Pipe Loss Multiplier', step: 0.02, min: 0.75, max: 1.8, unit: '' },
                { key: 'coefFutureTech', label: 'Future Tech Multiplier', step: 2, min: -10, max: 45, unit: '%' }
            ];

            var INPUT_KEY_BY_ID = {
                inItLoad: 'itLoadMw',
                inRackCount: 'rackCount',
                inRackType: 'rackType',
                inRackDensityTarget: 'rackDensityTarget',
                inHighDensityShare: 'highDensityShare',
                inModelYear: 'modelYear',
                inCountryProfile: 'countryKey',
                inClimate: 'climate',
                inCoolingArchitecture: 'architectureMode',
                inLiquidCapture: 'liquidCapture',
                inCoolant: 'coolantKey',
                inSupplyTemp: 'supplyTemp',
                inReturnTemp: 'returnTemp',
                inPumpHead: 'pumpHead',
                inPumpEff: 'pumpEff',
                inHydraulicMargin: 'hydraulicMargin',
                inControlQuality: 'controlQuality',
                inPredictiveGain: 'predictiveGain',
                inCoefHeatTransfer: 'coefHeatTransfer',
                inCoefCduLoss: 'coefCduLoss',
                inCoefPipeLoss: 'coefPipeLoss',
                inCoefFutureTech: 'coefFutureTech',
                inCduUnit: 'cduUnit',
                inRedundancy: 'redundancy',
                inAirCop: 'airCop',
                inEconomizerHours: 'economizerHours',
                inFanPower: 'fanPower',
                inUpsEff: 'upsEff',
                inDistLoss: 'distLoss',
                inHeatReuse: 'heatReuse',
                inElecPrice: 'elecPrice',
                inWaterTariff: 'waterTariff',
                inCarbonIntensity: 'carbonIntensity',
                inMonitoring: 'monitoring',
                inFireType: 'fireType',
                inTargetPue: 'targetPue',
                inTargetCop: 'targetCop',
                inFailureMode: 'failureMode',
                inConcurrent: 'concurrent',
                conPueMax: 'conPueMax',
                conCopMin: 'conCopMin',
                conRiskMax: 'conRiskMax',
                conPumpPctMax: 'conPumpPctMax',
                conEnforce: 'conEnforce',
                ruleG1: 'ruleG1',
                ruleG2: 'ruleG2',
                ruleG3: 'ruleG3',
                paretoSamples: 'paretoSamples',
                mcSamples: 'mcSamples',
                mcUncertainty: 'mcUncertainty',
                calTargetPue: 'calTargetPue',
                calTargetCop: 'calTargetCop',
                calTargetEnergy: 'calTargetEnergy',
                calTargetNetOpex: 'calTargetNetOpex',
                calTargetCarbon: 'calTargetCarbon',
                calTargetPump: 'calTargetPump',
                calLockApply: 'calLockApply'
            };

            var OUTPUT_KEY_BY_ID = {
                outCountry: 'countryKey',
                outLiquidLoad: 'liquidKw',
                outAirLoad: 'airKw',
                outFlow: 'flowLpm',
                outPump: 'pumpPowerKw',
                outCdu: 'cduCount',
                outPue: 'pue',
                outCop: 'systemCop',
                outWue: 'wue',
                outEnergy: 'annualGwh',
                outOpex: 'annualOpex',
                outHeatCredit: 'heatReuseCredit',
                outNetOpex: 'netOpex',
                outCarbon: 'netCarbonTons',
                outCarbonAvoided: 'avoidedCarbonTons',
                outRackType: 'rackType',
                outDesignDensity: 'designDensity',
                outControlIndex: 'controlIndex',
                outFutureFactor: 'futureFactor',
                outRackDensity: 'rackDensity',
                outRisk: 'riskIndex',
                outConfidence: 'confidence',
                outCalFit: 'calibrationFit'
            };

            var PARAM_TOOLTIPS = {
                itLoadMw: { title: 'IT Load', desc: 'Total critical IT heat load entering the facility thermal system. This is the main driver for cooling, electrical losses, and infrastructure sizing.', formula: 'Formula: Q_it = MW * 1000 kW.' },
                rackCount: { title: 'Rack Count', desc: 'Total number of active racks used to compute average rack density and stress multipliers. Higher count at constant load lowers average density.', formula: 'Formula: rackDensity = IT_kW / rackCount.' },
                rackType: { title: 'Rack Type Profile', desc: 'Technology profile that sets baseline thermal behavior, future bias, and residual air-cooling dependency. Different profiles shift capture and risk assumptions.', formula: 'Ref: profile factors apply to liquidBias, airResidual, and futureBias.' },
                rackDensityTarget: { title: 'Target Rack Density', desc: 'Design density objective used to evaluate design stress and optimization trade-offs. Higher target density demands stronger liquid capture and hydraulic performance.', formula: 'Ref: compared against model designDensity and rackDensityGap.' },
                highDensityShare: { title: 'High-Density Rack Share', desc: 'Share of racks expected to run in high-density mode. This pushes effective design density and cooling intensity.', formula: 'Ref: increases designDensity scaling term.' },
                modelYear: { title: 'Model Horizon Year', desc: 'Future projection horizon for technology and operating assumptions. Later years increase future factor influence in this model.', formula: 'Formula: yearDelta = modelYear - 2026.' },
                countryKey: { title: 'Country Profile', desc: 'Geographic profile that can preload energy, carbon, and infrastructure assumptions. It aligns baseline scenario to regional context.', formula: 'Ref: profile can set climate, tariff, target PUE/COP, and carbon intensity.' },
                climate: { title: 'Climate Profile', desc: 'Macro-climate class used to bias wet-bulb behavior, WUE baseline, and achievable cooling performance. Climate affects both energy and water behavior.', formula: 'Ref: climate factors include wetBulb, baseWue, and climateCopBias.' },
                architectureMode: { title: 'Cooling Architecture Preset', desc: 'Preset helper to align model assumptions with cooling style (direct liquid, hybrid, or air-cooling in-row/DAHU). This is a guidance preset and can still be overridden manually.', formula: 'Ref: preset updates rack profile, capture, liquid temperature pair, and air/fan assumptions.' },
                liquidCapture: { title: 'Liquid Capture', desc: 'Fraction of IT heat captured by liquid path before residual air cooling. Higher capture lowers fan/air burden and can improve facility efficiency.', formula: 'Ref: effectiveCapture uses capture, rack profile, heat transfer, and control index.' },
                coolantKey: { title: 'Coolant Type', desc: 'Coolant selection determines fluid properties used in mass-flow and pump calculations. Cp and density directly change required flow and hydraulic power.', formula: 'Formula: m = Q / (Cp * deltaT); hydraulic uses density.' },
                supplyTemp: { title: 'Liquid Supply Temperature', desc: 'Entering liquid coolant temperature to CDU/cold-plate loop (not supply air temperature). For warm-water direct liquid designs this is often high-20s to low-30s C; for air/in-row-chilled loops it can be lower.', formula: 'Ref: deltaT = returnTemp - supplyTemp with control and future adjustments.' },
                returnTemp: { title: 'Liquid Return Temperature', desc: 'Leaving liquid coolant temperature from IT loop. Together with liquid supply temperature it determines thermal delta-T and required flow.', formula: 'Formula: deltaT = returnTemp - supplyTemp.' },
                pumpHead: { title: 'Pump Head', desc: 'Hydraulic head requirement for the loop including elevation and friction assumptions. Higher head increases pump power demand.', formula: 'Formula: P_hyd = rho * g * flow * head.' },
                pumpEff: { title: 'Pump Efficiency', desc: 'Net pump efficiency assumption used to convert hydraulic to electrical pump power. Higher efficiency reduces electrical overhead.', formula: 'Formula: P_elec = P_hyd / pumpEff.' },
                hydraulicMargin: { title: 'Hydraulic Margin', desc: 'Design margin added to base flow to maintain operational resilience. Higher margin raises design flow and pump duty.', formula: 'Ref: designFlow *= (1 + margin/100).' },
                controlQuality: { title: 'Control Logic Quality', desc: 'Quality score for control architecture and tuning. Better control improves capture effectiveness, COP, and risk posture.', formula: 'Ref: contributes to controlIndex.' },
                predictiveGain: { title: 'Predictive Gain', desc: 'Strength of predictive control behavior in the loop. Higher gain can improve part-load efficiency if telemetry quality is adequate.', formula: 'Ref: contributes to controlIndex and controlBonus.' },
                coefHeatTransfer: { title: 'Thermal Transfer Effectiveness', desc: 'Heat exchanger effectiveness coefficient for IT-to-liquid transfer. Lower values reduce effective liquid capture and raise residual air load.', formula: 'Ref: effectiveCapture scales with coefHeatTransfer.' },
                coefCduLoss: { title: 'CDU Loss Coefficient', desc: 'Thermal/electrical overhead factor for CDU processing losses. Higher coefficient increases non-IT cooling load.', formula: 'Formula: cduLossKw = liquidKw * (coefCduLoss/100).' },
                coefPipeLoss: { title: 'Pipe Loss Multiplier', desc: 'Network loss multiplier for piping and distribution complexity. Higher multiplier increases effective head and design flow penalty.', formula: 'Ref: affects designFlow and pumpHeadEff.' },
                coefFutureTech: { title: 'Future Tech Multiplier', desc: 'Scenario lever for expected technology uplift relative to baseline year. Positive values model future capability gains.', formula: 'Ref: futureFactor = f(coefFutureTech, yearDelta, profile futureBias).' },
                cduUnit: { title: 'CDU Unit Capacity', desc: 'Nominal heat handling per CDU module. Used to estimate module count under selected redundancy topology.', formula: 'Formula: cduBase = ceil(liquidKw / cduUnit).' },
                redundancy: { title: 'Redundancy Topology', desc: 'Design redundancy level (N, N+1, 2N) applied to hydraulic and module sizing. Stronger redundancy improves resilience but increases overhead.', formula: 'Ref: redundancyFactor affects flow and cduCount.' },
                airCop: { title: 'Air Path COP', desc: 'Baseline coefficient of performance for residual air-cooling path. This impacts the non-liquid cooling energy burden.', formula: 'Formula: airCoolingKw = residualAirKw / airCopEff.' },
                economizerHours: { title: 'Economizer Availability', desc: 'Share of annual operation that can leverage economizer conditions. More economizer time improves effective air path efficiency.', formula: 'Ref: airCopEff scales with economizer fraction.' },
                fanPower: { title: 'Fan Power', desc: 'Fan overhead as a share of IT load before control and capture reductions. Higher fan share increases facility auxiliary demand.', formula: 'Formula: fanKw = IT_kW * fanPower% * modifiers.' },
                upsEff: { title: 'UPS Efficiency', desc: 'UPS conversion efficiency in the electrical chain. Lower efficiency increases power losses and worsens PUE.', formula: 'Formula: upsInputKw = IT_kW / upsEff.' },
                distLoss: { title: 'Power Distribution Loss', desc: 'Electrical distribution loss after UPS conversion. It captures cable, transformer, and distribution inefficiencies.', formula: 'Formula: distLossKw = upsInputKw * distLoss%.' },
                heatReuse: { title: 'Heat Reuse Rate', desc: 'Fraction of liquid path heat considered recoverable for beneficial reuse. Reuse reduces net OPEX and net carbon in this model.', formula: 'Ref: heatReuseCredit and avoidedCarbon scale with reuse share.' },
                elecPrice: { title: 'Electricity Price', desc: 'Energy tariff used for annual electricity cost projection. It is the main economic sensitivity driver.', formula: 'Formula: annualEnergyCost = annualKwh * elecPrice.' },
                waterTariff: { title: 'Water Tariff', desc: 'Water cost assumption applied to modelled water use. It affects total annual OPEX.', formula: 'Formula: annualWaterCost = annualWaterM3 * waterTariff.' },
                carbonIntensity: { title: 'Grid Carbon Intensity', desc: 'Grid emissions factor used to convert energy into carbon footprint. Lower intensity materially reduces annual carbon.', formula: 'Formula: annualCarbon = annualKwh * carbonIntensity / 1000.' },
                monitoring: { title: 'Monitoring Coverage', desc: 'Coverage level for sensing and telemetry points in the control system. Higher coverage improves confidence and control outcomes.', formula: 'Ref: contributes to controlIndex and confidence score.' },
                fireType: { title: 'Fire Suppression Strategy', desc: 'Fire suppression architecture used in safety/risk scoring. Strategy influences NFPA posture and risk modifiers.', formula: 'Ref: nfpaScore and riskIndex include fireType impact.' },
                targetPue: { title: 'Target PUE', desc: 'Efficiency target used by optimization and gap analysis. Model computes deviation to this value for action guidance.', formula: 'Formula: pueGap = modelPue - targetPue.' },
                targetCop: { title: 'Target System COP', desc: 'Cooling performance target used by optimization objective. Model computes COP gap and improvement recommendations.', formula: 'Formula: copGap = modelCop - targetCop.' },
                concurrent: { title: 'Concurrent Maintainability', desc: 'Flag indicating maintainability architecture support under maintenance events. It contributes to resilience and risk scoring.', formula: 'Ref: contributes to controlIndex, uptime score, and risk index.' },
                calTargetPue: { title: 'Measured PUE', desc: 'Measured telemetry value used as calibration target for model fit. Improves coefficient tuning when provided with other KPIs.', formula: 'Ref: calibration minimizes weighted relative error.' },
                calTargetCop: { title: 'Measured System COP', desc: 'Measured COP target for calibration fit loop. Helps align cooling model assumptions to real operation.', formula: 'Ref: included in weighted calibration objective.' },
                calTargetEnergy: { title: 'Measured Annual Energy', desc: 'Measured annual facility energy for calibration. Anchors energy and cost trajectory to telemetry.', formula: 'Ref: target annualGwh used in objective function.' },
                calTargetNetOpex: { title: 'Measured Net OPEX', desc: 'Measured net annual operating cost for economic calibration. Helps reconcile tariff, efficiency, and reuse assumptions.', formula: 'Ref: target netOpex used in objective function.' },
                calTargetCarbon: { title: 'Measured Carbon', desc: 'Measured annual carbon footprint for calibration. Aligns emissions projection to observed performance.', formula: 'Ref: target netCarbonTons used in objective function.' },
                calTargetPump: { title: 'Measured Pump Power', desc: 'Measured pump power telemetry for hydraulic calibration fit. Tunes flow/head/efficiency-related coefficients.', formula: 'Ref: target pumpPowerKw used in objective function.' },
                calLockApply: { title: 'Apply Calibrated Coefficients', desc: 'When enabled, tuned coefficients are written back to active design inputs. This allows immediate what-if testing from calibrated baseline.', formula: 'Ref: writes tuned values to control and coefficient inputs.' },
                failureMode: { title: 'Failure / Degraded Mode', desc: 'Selects degraded operating condition overlays for resilience simulation. This mode perturbs control, thermal, hydraulic, or economic terms.', formula: 'Ref: mode-specific modifiers are applied inside computeModel().' },
                conPueMax: { title: 'Hard PUE Max', desc: 'Upper hard limit for efficiency acceptance. When enforced, optimizer rejects solutions above this threshold.', formula: 'Constraint: model.pue <= conPueMax.' },
                conCopMin: { title: 'Hard COP Min', desc: 'Lower hard limit for cooling efficiency acceptance. Enforced during optimization and feasibility checks.', formula: 'Constraint: model.systemCop >= conCopMin.' },
                conRiskMax: { title: 'Hard Risk Max', desc: 'Upper bound for acceptable risk index. Tight values prioritize resilient solutions.', formula: 'Constraint: model.riskIndex <= conRiskMax.' },
                conPumpPctMax: { title: 'Hard Pump % of IT Max', desc: 'Maximum allowed pump overhead relative to IT load. Useful for hydraulic efficiency governance.', formula: 'Constraint: (pumpPowerKw / itKw)*100 <= conPumpPctMax.' },
                conEnforce: { title: 'Enforce Hard Constraints', desc: 'When enabled, infeasible solutions are heavily penalized and excluded from optimized recommendations.', formula: 'Ref: hard infeasibility penalty added in optimizeObjective().' },
                ruleG1: { title: 'Rule G1', desc: 'DSL expression for sensor-quality gate decision. Evaluates to OPEN/ADJ state in control diagram.', formula: 'Variables: monitoring, controlIndex, deltaT, pumpPowerPctIt, riskIndex, pue, targetPue, cop, targetCop.' },
                ruleG2: { title: 'Rule G2', desc: 'DSL expression for actuator-limit gate decision. Used to decide whether hydraulic/thermal actuation is within tolerance.', formula: 'Expression must resolve to boolean true/false.' },
                ruleG3: { title: 'Rule G3', desc: 'DSL expression for risk-guard gate decision. Governs final pass/action state in control loop.', formula: 'Expression must resolve to boolean true/false.' },
                paretoSamples: { title: 'Pareto Samples', desc: 'Number of candidate points sampled for multi-objective frontier generation. Higher values improve frontier resolution but require more compute.', formula: 'Ref: non-dominated filtering over sampled candidate pool.' },
                mcSamples: { title: 'Simulation Samples', desc: 'Number of Monte Carlo iterations. More samples reduce percentile estimation noise.', formula: 'Ref: uncertainty propagation using random perturbation of key inputs.' },
                mcUncertainty: { title: 'Input Uncertainty', desc: 'Relative perturbation band applied to selected numeric inputs during Monte Carlo.', formula: 'Formula: candidate = base * (1 +/- uncertainty).' },
                effectiveCapture: { title: 'Effective Capture', desc: 'Model-adjusted liquid heat capture after profile and control modifiers. Used as core split between liquid and air thermal paths.', formula: 'Formula: effectiveCapture = f(liquidCapture, profile, transfer, control).' },
                designDensity: { title: 'Design Density', desc: 'Projected design density considering target, high-density share, and horizon year adjustments. Used for stress and risk calculations.', formula: 'Ref: designDensity drives densityStress and risk terms.' },
                rackDensityGap: { title: 'Rack Density Gap', desc: 'Difference between achieved and target rack density. Used for diagnostics and optimization pressure.', formula: 'Formula: rackDensityGap = designDensity - rackDensityTarget.' },
                futureFactor: { title: 'Future Factor', desc: 'Technology-adjusted multiplier for horizon modelling. It influences thermal effectiveness and confidence projections.', formula: 'Ref: depends on model year and future-tech coefficient.' },
                controlIndex: { title: 'Control Index', desc: 'Composite control quality metric from telemetry coverage, predictive gain, and maintainability context. Used across thermal, efficiency, and risk logic.', formula: 'Ref: weighted sum with clamp to 0-100.' },
                flowLpm: { title: 'Coolant Flow', desc: 'Design coolant flow rate derived from thermal load and hydraulic assumptions. Central output for loop and pump sizing.', formula: 'Formula: flow from Q/(Cp*dT) with density conversion.' },
                pumpPowerKw: { title: 'Pump Power', desc: 'Total electrical pump demand after hydraulic and efficiency effects. Contributes directly to auxiliary load and OPEX.', formula: 'Formula: pumpPower = hydraulicPower / pumpEff.' },
                pue: { title: 'PUE', desc: 'Power Usage Effectiveness estimate from modeled facility and IT loads. Key KPI for overall data center efficiency.', formula: 'Formula: PUE = totalFacilityKw / itKw.' },
                systemCop: { title: 'System COP', desc: 'Composite cooling COP including liquid and air paths with controls and economizer influence. Higher values indicate better cooling efficiency.', formula: 'Formula: systemCOP = coolingDelivered / coolingPower.' },
                wue: { title: 'WUE', desc: 'Water Usage Effectiveness estimate based on climate and load-adjusted water model. Used for water sustainability assessment.', formula: 'Formula: WUE = annualWaterM3 / annualKwh.' },
                annualGwh: { title: 'Annual Energy', desc: 'Projected annual site energy use in GWh. Drives energy cost and carbon outcomes.', formula: 'Formula: annualGwh = annualKwh / 1,000,000.' },
                annualOpex: { title: 'Gross Annual OPEX', desc: 'Total modeled annual operating cost before reuse credit. Includes energy and water costs.', formula: 'Formula: annualOpex = annualEnergyCost + annualWaterCost.' },
                heatReuseCredit: { title: 'Heat-Reuse Credit', desc: 'Economic credit from useful recovered heat under reuse assumptions. Deducted from gross OPEX to estimate net OPEX.', formula: 'Ref: heatReuseCredit scales with recoverable thermal energy.' },
                netOpex: { title: 'Net Annual OPEX', desc: 'Gross annual OPEX reduced by heat reuse credit. Primary economic KPI for scenario comparison.', formula: 'Formula: netOpex = annualOpex - heatReuseCredit.' },
                netCarbonTons: { title: 'Annual Carbon', desc: 'Projected net carbon emissions after avoided-carbon credit from heat reuse. Used for sustainability and compliance decisions.', formula: 'Formula: netCarbon = annualCarbon - avoidedCarbon.' },
                avoidedCarbonTons: { title: 'Carbon Avoided', desc: 'Estimated emissions displaced by recovered heat use. Reported separately to show decarbonization impact.', formula: 'Ref: avoidedCarbon scales with recovered heat and grid intensity.' },
                rackDensity: { title: 'Rack Density', desc: 'Computed average rack density from IT load and rack count. Compared against design targets for planning.', formula: 'Formula: rackDensity = IT_kW / rackCount.' },
                riskIndex: { title: 'Risk Index', desc: 'Composite operational risk indicator based on redundancy, safety strategy, density stress, and controls. Lower is better.', formula: 'Ref: weighted modifier logic with bounds 0-100.' },
                confidence: { title: 'Data Confidence', desc: 'Confidence indicator for model trust based on telemetry richness and assumption quality. Higher confidence suggests stronger decision support.', formula: 'Ref: weighted by monitoring, controls, and parameter stability.' },
                calibrationFit: { title: 'Calibration Fit', desc: 'Fit score indicating how closely calibrated model output matches telemetry targets. Higher fit means lower weighted error.', formula: 'Formula: fit = 100 * exp(-error * factor).' }
            };

            var BENCHMARK_HINTS = {
                pue: 'Benchmark: modern hyperscale target range is commonly 1.10 to 1.25.',
                systemCop: 'Benchmark: liquid-assisted systems often target COP above 7 in favorable conditions.',
                wue: 'Benchmark: lower is better; dry/temperate designs target significantly below tropical baselines.',
                supplyTemp: 'Benchmark: warm-water designs are often evaluated in ~28C to 35C envelope.',
                returnTemp: 'Benchmark: maintain enough delta-T to reduce flow and pump overhead.',
                deltaT: 'Benchmark: practical liquid loop delta-T often targets at least 6C to 10C.',
                pumpPowerKw: 'Benchmark: pump power is often kept below ~3% of IT load for efficient designs.',
                controlIndex: 'Benchmark: sustained >75 usually indicates strong automation readiness.',
                riskIndex: 'Benchmark: lower is better; many screening models treat <=35 as low operational risk.',
                confidence: 'Benchmark: >85% indicates high telemetry-backed confidence for planning decisions.',
                netCarbonTons: 'Ref: carbon KPI should be interpreted with local grid intensity and reuse credit assumptions.',
                annualGwh: 'Ref: verify against metered baseline before investment decisions.',
                annualOpex: 'Ref: compare against measured tariff and utilization scenarios.',
                netOpex: 'Ref: net OPEX should include validated heat reuse monetization assumptions.',
                ashrae: 'Benchmark: thermal compliance score above 85 indicates strong envelope control.',
                ansi: 'Benchmark: infrastructure readiness above 85 indicates robust topology posture.',
                iso: 'Benchmark: governance score above 85 indicates mature energy management practices.',
                nfpa: 'Benchmark: safety posture above 85 indicates strong suppression and response readiness.',
                uptime: 'Benchmark: alignment above 85 indicates strong maintainability/tier posture.'
            };

            var SCENARIO_STORE_KEY = 'ltc_lab_scenarios_v1';
            var LEDGER_STORE_KEY = 'ltc_lab_provenance_v1';
            var DEFAULT_GATE_RULES = {
                g1: 'monitoring >= 85 && controlIndex >= 78',
                g2: 'deltaT >= 7.5 && pumpPowerPctIt <= 3',
                g3: 'riskIndex <= 35 && pue <= targetPue + 0.02'
            };
            var PROVENANCE_TEMPLATE = [
                { key: 'itLoadMw', label: 'IT Load', source: 'Facility telemetry + planning assumptions', owner: 'Engineering', confidence: 92 },
                { key: 'liquidCapture', label: 'Liquid Capture', source: 'Thermal lab benchmark / OEM data', owner: 'Thermal Team', confidence: 86 },
                { key: 'airCop', label: 'Air Path COP', source: 'Climate-adjusted baseline model', owner: 'Cooling Team', confidence: 83 },
                { key: 'pumpEff', label: 'Pump Efficiency', source: 'Pump curve datasheet + commissioning', owner: 'Mechanical Team', confidence: 87 },
                { key: 'elecPrice', label: 'Electricity Price', source: 'Utility tariff contract', owner: 'Finance + Ops', confidence: 95 },
                { key: 'carbonIntensity', label: 'Grid Carbon Intensity', source: 'Regional carbon inventory', owner: 'Sustainability', confidence: 88 },
                { key: 'monitoring', label: 'Monitoring Coverage', source: 'BMS/DCIM point inventory', owner: 'Controls Team', confidence: 90 },
                { key: 'targetPue', label: 'Target PUE', source: 'Program target / design brief', owner: 'Program Management', confidence: 82 },
                { key: 'targetCop', label: 'Target COP', source: 'Cooling program KPI', owner: 'Program Management', confidence: 80 }
            ];

            var baselineModel = null;
            var optimizedModel = null;
            var calibrationState = null;
            var calibrationDirty = false;
            var latestPareto = [];
            var selectedParetoIdx = -1;
            var latestMonteCarlo = null;
            var scenarioSnapshots = [];
            var gateRules = Object.assign({}, DEFAULT_GATE_RULES);
            var selectedScenarioIdx = -1;

            function n(id) {
                var el = document.getElementById(id);
                if (!el) return 0;
                return parseFloat(el.value || '0');
            }

            function maybeNum(id, minValue) {
                var el = document.getElementById(id);
                if (!el) return null;
                var raw = String(el.value || '').trim();
                if (!raw) return null;
                var value = parseFloat(raw);
                if (!isFinite(value)) return null;
                if (minValue !== undefined && value < minValue) return null;
                return value;
            }

            function clamp(v, min, max) {
                return Math.max(min, Math.min(max, v));
            }

            function setText(id, value) {
                var el = document.getElementById(id);
                if (el) el.textContent = value;
            }

            function setBar(id, value) {
                var el = document.getElementById(id);
                if (!el) return;
                el.style.width = clamp(value, 0, 100) + '%';
            }

            function setGateState(polyId, isOk) {
                var poly = document.getElementById(polyId);
                if (!poly) return;
                poly.classList.remove('ok', 'warn');
                poly.classList.add(isOk ? 'ok' : 'warn');
            }

            function nowIso() {
                return new Date().toISOString().replace('T', ' ').slice(0, 19) + ' UTC';
            }

            function gatherConstraintState() {
                return {
                    pueMax: Math.max(n('conPueMax'), 1.01),
                    copMin: Math.max(n('conCopMin'), 0.5),
                    riskMax: clamp(n('conRiskMax'), 1, 100),
                    pumpPctMax: Math.max(n('conPumpPctMax'), 0.5),
                    enforce: (document.getElementById('conEnforce').value === 'yes')
                };
            }

            function evaluateHardConstraints(model, constraints) {
                var pumpPctIt = (model.pumpPowerKw / Math.max(model.itKw, 1)) * 100;
                var issues = [];
                if (model.pue > constraints.pueMax) issues.push('PUE > max');
                if (model.systemCop < constraints.copMin) issues.push('COP < min');
                if (model.riskIndex > constraints.riskMax) issues.push('Risk > max');
                if (pumpPctIt > constraints.pumpPctMax) issues.push('Pump%IT > max');
                return { feasible: issues.length === 0, issues: issues, pumpPctIt: pumpPctIt };
            }

            function buildRuleContext(model) {
                return {
                    monitoring: model.input.monitoring,
                    controlIndex: model.controlIndex,
                    deltaT: model.deltaT,
                    pumpPowerPctIt: (model.pumpPowerKw / Math.max(model.itKw, 1)) * 100,
                    riskIndex: model.riskIndex,
                    pue: model.pue,
                    targetPue: model.input.targetPue,
                    cop: model.systemCop,
                    targetCop: model.input.targetCop
                };
            }

            function evaluateRuleExpression(expr, ctx) {
                var raw = String(expr || '').trim();
                if (!raw) return { ok: false, error: 'empty rule' };
                if (!/^[a-zA-Z0-9_().<>=!&|+\-*/%\s]+$/.test(raw)) {
                    return { ok: false, error: 'invalid character in rule' };
                }
                var blocked = ['window', 'document', 'localStorage', 'sessionStorage', 'fetch', 'constructor', 'Function', 'eval', 'this'];
                for (var i = 0; i < blocked.length; i++) {
                    if (raw.indexOf(blocked[i]) !== -1) return { ok: false, error: 'blocked token: ' + blocked[i] };
                }
                try {
                    var fn = new Function('v', 'with(v){ return !!(' + raw + '); }');
                    return { ok: true, value: !!fn(ctx) };
                } catch (e) {
                    return { ok: false, error: 'parse error' };
                }
            }

            function evaluateGateStates(model) {
                var ctx = buildRuleContext(model);
                var r1 = evaluateRuleExpression(gateRules.g1, ctx);
                var r2 = evaluateRuleExpression(gateRules.g2, ctx);
                var r3 = evaluateRuleExpression(gateRules.g3, ctx);
                return {
                    g1: !!r1.value,
                    g2: !!r2.value,
                    g3: !!r3.value,
                    errors: [r1, r2, r3].filter(function(r) { return !r.ok; }).map(function(r) { return r.error; }),
                    ctx: ctx
                };
            }

            function fmtNum(value, digits) {
                return Number(value).toLocaleString('en-US', { maximumFractionDigits: digits, minimumFractionDigits: digits });
            }

            function fmtUsd(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    maximumFractionDigits: 0
                }).format(value);
            }

            function fmtUsdCompact(value) {
                var abs = Math.abs(value);
                if (abs >= 1000000000) return '$' + fmtNum(value / 1000000000, 2) + 'B';
                if (abs >= 1000000) return '$' + fmtNum(value / 1000000, 2) + 'M';
                if (abs >= 1000) return '$' + fmtNum(value / 1000, 1) + 'K';
                return fmtUsd(value);
            }

            function signed(value, digits, suffix) {
                var sign = value > 0 ? '+' : '';
                return sign + fmtNum(value, digits) + (suffix || '');
            }

            function escapeHtml(value) {
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function escapeAttr(value) {
                return escapeHtml(value).replace(/`/g, '&#96;');
            }

            function prettifyKey(key) {
                return String(key || '')
                    .replace(/\./g, ' ')
                    .replace(/([a-z0-9])([A-Z])/g, '$1 $2')
                    .replace(/_/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .replace(/^./, function(m) { return m.toUpperCase(); });
            }

            function resolveTooltipMeta(key, layer, fallbackTitle) {
                var normKey = String(key || '').trim();
                var leafKey = normKey.indexOf('.') >= 0 ? normKey.split('.').pop() : normKey;
                var base = PARAM_TOOLTIPS[normKey] || PARAM_TOOLTIPS[leafKey];
                var hint = BENCHMARK_HINTS[normKey] || BENCHMARK_HINTS[leafKey] || '';

                function impactHint(k, l) {
                    var nk = String(k || '').toLowerCase();
                    if (nk.indexOf('pue') >= 0 || nk.indexOf('cop') >= 0) return 'Impact: directly shifts efficiency target gap and optimization priority.';
                    if (nk.indexOf('risk') >= 0 || nk.indexOf('fire') >= 0) return 'Impact: contributes to risk and compliance posture scoring.';
                    if (nk.indexOf('carbon') >= 0 || nk.indexOf('opex') >= 0 || nk.indexOf('energy') >= 0) return 'Impact: changes economic and sustainability output envelope.';
                    if (nk.indexOf('control') >= 0 || nk.indexOf('predictive') >= 0 || nk.indexOf('monitor') >= 0) return 'Impact: changes control stability, confidence, and dynamic response.';
                    if (nk.indexOf('pump') >= 0 || nk.indexOf('flow') >= 0 || nk.indexOf('hydraulic') >= 0) return 'Impact: alters hydraulic power, auxiliary load, and overall PUE.';
                    if (l === 'input') return 'Impact: input perturbation propagates through thermal, hydraulic, cost, and compliance layers.';
                    if (l === 'processing') return 'Impact: intermediate solver state affecting downstream KPI sensitivity.';
                    return 'Impact: output KPI used for target guidance and feedback actions.';
                }

                function normalize(meta) {
                    var out = {
                        title: meta.title || prettifyKey(normKey),
                        desc: meta.desc || 'Engineering parameter for modelling chain.',
                        formula: meta.formula || ('Ref: ' + (normKey || 'model variable')),
                        impact: meta.impact || impactHint(normKey || leafKey, layer)
                    };
                    if (!/^(Benchmark:|Formula:|Ref:)/.test(out.formula)) out.formula = 'Ref: ' + out.formula;
                    if (hint) out.formula = out.formula + ' ' + hint;
                    return out;
                }

                if (base) {
                    return normalize({
                        title: fallbackTitle || base.title || prettifyKey(normKey),
                        desc: base.desc,
                        formula: base.formula
                    });
                }

                var title = fallbackTitle || prettifyKey(normKey);
                var desc = 'Parameter used in this ' + layer + ' layer of the modelling engine. Hover values to trace interactions across thermal, hydraulic, economic, and risk logic.';
                var formula = 'Ref: Internal model variable (' + (normKey || 'n/a') + ') used in live solver and traceability matrix.';
                var impact = impactHint(normKey || leafKey, layer);

                if (normKey.indexOf('scores.') === 0) {
                    desc = 'Weighted compliance score generated from standard-specific criteria and risk modifiers. Higher score indicates stronger alignment readiness.';
                    formula = 'Formula: weighted score aggregate (0-100) with risk penalties.';
                } else if (normKey.indexOf('breakdown.') === 0) {
                    desc = 'Power component contribution used to decompose total facility load and visualize energy burden distribution.';
                    formula = 'Formula: component share = component_kW / totalFacilityKw.';
                } else if (normKey.indexOf('internals.') === 0) {
                    desc = 'Internal solver state variable used by thermal-hydraulic-energy calculations before final KPI projection.';
                    formula = 'Ref: intermediate state in computeModel() dependency chain.';
                }

                if (layer === 'input') {
                    desc = 'Primary input parameter for scenario definition. This value feeds the solver directly and influences multiple downstream outputs.';
                    formula = 'Ref: input vector term consumed by computeModel() with bounds, clamps, and unit normalization.';
                } else if (layer === 'output') {
                    desc = 'Computed output KPI from the model run. This value updates whenever input, optimization, or calibration changes.';
                    formula = 'Ref: output vector value generated by computeModel() and post-processing logic.';
                } else if (layer === 'processing') {
                    desc = 'Intermediate processing variable inside thermal-hydraulic and control calculations. It links raw inputs to final KPIs.';
                    formula = 'Ref: derived in staged solver pipeline and used by downstream blocks.';
                }
                return normalize({ title: title, desc: desc, formula: formula, impact: impact });
            }

            function tooltipText(meta) {
                return meta.title + ': ' + meta.desc + ' ' + meta.formula + ' ' + (meta.impact || '');
            }

            function createTooltipTrigger(meta) {
                var trigger = document.createElement('span');
                trigger.className = 'tooltip-trigger';
                trigger.textContent = '?';
                trigger.setAttribute('aria-label', 'Tooltip for ' + meta.title);
                trigger.setAttribute('tabindex', '0');

                var content = document.createElement('span');
                content.className = 'tooltip-content';
                content.innerHTML =
                    '<div class="tooltip-title">' + escapeHtml(meta.title) + '</div>' +
                    '<div class="tooltip-desc">' + escapeHtml(meta.desc) + '</div>' +
                    '<div class="tooltip-formula">' + escapeHtml(meta.formula) + '</div>' +
                    '<div class="tooltip-impact">' + escapeHtml(meta.impact || '') + '</div>';
                trigger.appendChild(content);
                return trigger;
            }

            function appendTooltip(el, meta, addCalcLabelClass) {
                if (!el || el.querySelector('.tooltip-trigger')) return;
                if (addCalcLabelClass) el.classList.add('calc-label');
                el.appendChild(createTooltipTrigger(meta));
            }

            function initInputTooltips() {
                document.querySelectorAll('#calculator .input-group label[for], #calculator .feature-block .field label[for]').forEach(function(labelEl) {
                    var id = labelEl.getAttribute('for');
                    var key = INPUT_KEY_BY_ID[id] || id;
                    var title = labelEl.childNodes[0] ? labelEl.childNodes[0].nodeValue : labelEl.textContent;
                    title = String(title || labelEl.textContent || '').trim().replace(/\s+/g, ' ');
                    appendTooltip(labelEl, resolveTooltipMeta(key, 'input', title), true);
                });

                ['inConcurrent', 'calLockApply'].forEach(function(id) {
                    var labelEl = document.querySelector('.check-wrap[for="' + id + '"]');
                    if (!labelEl) return;
                    var title = String(labelEl.textContent || '').trim().replace(/\s+/g, ' ');
                    if (!title) title = prettifyKey(id);
                    appendTooltip(labelEl, resolveTooltipMeta(INPUT_KEY_BY_ID[id] || id, 'input', title), false);
                });
            }

            function initOutputTooltips() {
                document.querySelectorAll('#calculator .result-card').forEach(function(card) {
                    var labelEl = card.querySelector('.label');
                    var valueEl = card.querySelector('.value[id]');
                    if (!labelEl || !valueEl) return;
                    var key = OUTPUT_KEY_BY_ID[valueEl.id] || valueEl.id;
                    var title = String(labelEl.textContent || '').trim().replace(/\s+/g, ' ');
                    appendTooltip(labelEl, resolveTooltipMeta(key, 'output', title), false);
                });
            }

            function initTooltipPositioning() {
                document.querySelectorAll('.tooltip-trigger').forEach(function(trigger) {
                    if (trigger.dataset.tooltipBound === '1') return;
                    trigger.dataset.tooltipBound = '1';
                    trigger.addEventListener('mouseenter', function() {
                        var content = this.querySelector('.tooltip-content');
                        if (!content) return;
                        content.style.display = 'block';
                        var rect = this.getBoundingClientRect();
                        var cRect = content.getBoundingClientRect();
                        var top = rect.bottom + 8;
                        var left = rect.left - (cRect.width / 2) + (rect.width / 2);
                        if (left < 8) left = 8;
                        if (left + cRect.width > window.innerWidth - 8) left = window.innerWidth - cRect.width - 8;
                        if (top + cRect.height > window.innerHeight - 8) top = rect.top - cRect.height - 8;
                        content.style.top = top + 'px';
                        content.style.left = left + 'px';
                    });
                    trigger.addEventListener('mouseleave', function() {
                        var content = this.querySelector('.tooltip-content');
                        if (content) content.style.display = 'none';
                    });
                    trigger.addEventListener('focus', function() {
                        var content = this.querySelector('.tooltip-content');
                        if (!content) return;
                        content.style.display = 'block';
                        var rect = this.getBoundingClientRect();
                        var cRect = content.getBoundingClientRect();
                        var top = rect.bottom + 8;
                        var left = rect.left - (cRect.width / 2) + (rect.width / 2);
                        if (left < 8) left = 8;
                        if (left + cRect.width > window.innerWidth - 8) left = window.innerWidth - cRect.width - 8;
                        if (top + cRect.height > window.innerHeight - 8) top = rect.top - cRect.height - 8;
                        content.style.top = top + 'px';
                        content.style.left = left + 'px';
                    });
                    trigger.addEventListener('blur', function() {
                        var content = this.querySelector('.tooltip-content');
                        if (content) content.style.display = 'none';
                    });
                });
            }

            function initTermTooltipPositioning() {
                if (document.body.dataset.termTooltipBound === '1') return;
                document.body.dataset.termTooltipBound = '1';

                var panel = document.getElementById('termTooltipPanel');
                if (!panel) {
                    panel = document.createElement('div');
                    panel.id = 'termTooltipPanel';
                    panel.className = 'term-tooltip-panel';
                    document.body.appendChild(panel);
                }

                var activeTerm = null;

                function setPanelContent(termEl) {
                    var title = termEl.getAttribute('data-term-title') || termEl.textContent || 'Term';
                    var desc = termEl.getAttribute('data-tooltip') || '';
                    var impact = termEl.getAttribute('data-term-impact') || '';
                    panel.innerHTML =
                        '<div class="term-title">' + escapeHtml(String(title).trim()) + '</div>' +
                        '<div class="term-desc">' + escapeHtml(String(desc).trim()) + '</div>' +
                        '<div class="term-impact">' + escapeHtml(String(impact).trim()) + '</div>';
                }

                function positionPanel(x, y) {
                    panel.style.display = 'block';
                    panel.style.visibility = 'hidden';

                    var w = panel.offsetWidth || 280;
                    var h = panel.offsetHeight || 120;
                    var left = x + 14;
                    var top = y + 16;

                    if (left + w > window.innerWidth - 8) left = window.innerWidth - w - 8;
                    if (left < 8) left = 8;
                    if (top + h > window.innerHeight - 8) top = y - h - 14;
                    if (top < 8) top = 8;

                    panel.style.left = left + 'px';
                    panel.style.top = top + 'px';
                    panel.style.visibility = 'visible';
                }

                function showPanel(termEl, x, y) {
                    activeTerm = termEl;
                    setPanelContent(termEl);
                    positionPanel(x, y);
                }

                function hidePanel() {
                    panel.style.display = 'none';
                    panel.style.visibility = 'hidden';
                }

                document.addEventListener('mouseover', function(ev) {
                    var term = ev.target && ev.target.closest ? ev.target.closest('.term-tooltip') : null;
                    if (!term) return;
                    showPanel(term, ev.clientX, ev.clientY);
                });

                document.addEventListener('mousemove', function(ev) {
                    if (!activeTerm || panel.style.display !== 'block') return;
                    positionPanel(ev.clientX, ev.clientY);
                });

                document.addEventListener('mouseout', function(ev) {
                    if (!activeTerm) return;
                    var fromTerm = ev.target && ev.target.closest ? ev.target.closest('.term-tooltip') : null;
                    var toTerm = ev.relatedTarget && ev.relatedTarget.closest ? ev.relatedTarget.closest('.term-tooltip') : null;
                    if (fromTerm && fromTerm === activeTerm && toTerm !== activeTerm) {
                        activeTerm = null;
                        hidePanel();
                    }
                });

                document.addEventListener('focusin', function(ev) {
                    var term = ev.target && ev.target.closest ? ev.target.closest('.term-tooltip') : null;
                    if (!term) return;
                    var rect = term.getBoundingClientRect();
                    showPanel(term, rect.left + (rect.width / 2), rect.top);
                });

                document.addEventListener('focusout', function(ev) {
                    var term = ev.target && ev.target.closest ? ev.target.closest('.term-tooltip') : null;
                    if (!term) return;
                    activeTerm = null;
                    hidePanel();
                });

                window.addEventListener('scroll', function() {
                    if (!activeTerm || panel.style.display !== 'block') return;
                    var rect = activeTerm.getBoundingClientRect();
                    positionPanel(rect.left + (rect.width / 2), rect.top);
                }, true);
            }

            function termTooltipSpan(label, key, layer) {
                var meta = resolveTooltipMeta(key || label, layer || 'processing', label);
                var detail = meta.desc + ' ' + meta.formula;
                return '<span class="term-tooltip" tabindex="0" data-term-title="' + escapeAttr(meta.title) + '" data-tooltip="' + escapeAttr(detail) + '" data-term-impact="' + escapeAttr(meta.impact || '') + '">' + escapeHtml(label) + '</span>';
            }

            function renderStageLineContent(line) {
                if (line && typeof line === 'object') {
                    var relation = line.relation || '=';
                    var left = termTooltipSpan(line.label || line.key || '-', line.key || line.label, line.layer || 'processing');
                    var right = line.value == null ? '' : (' ' + relation + ' ' + escapeHtml(line.value));
                    return left + right;
                }

                var raw = String(line || '').trim();
                var eqPos = raw.indexOf('=');
                if (eqPos > 0) {
                    var leftEq = raw.slice(0, eqPos).trim();
                    var rightEq = raw.slice(eqPos + 1).trim();
                    return termTooltipSpan(leftEq, leftEq, 'processing') + ' = ' + escapeHtml(rightEq);
                }

                var arrowPos = raw.indexOf('->');
                if (arrowPos > 0) {
                    var leftArrow = raw.slice(0, arrowPos).trim();
                    var rightArrow = raw.slice(arrowPos + 2).trim();
                    return termTooltipSpan(leftArrow, leftArrow, 'processing') + ' -> ' + escapeHtml(rightArrow);
                }

                return escapeHtml(raw);
            }

            function shortText(value, maxLen) {
                var str = String(value == null ? '' : value);
                if (str.length <= maxLen) return str;
                return str.slice(0, Math.max(0, maxLen - 1)) + '';
            }

            function selectedCountryLabel() {
                var sel = document.getElementById('inCountryProfile');
                if (!sel) return 'Custom Manual';
                var key = sel.value;
                return (COUNTRY_PROFILES[key] && COUNTRY_PROFILES[key].label) ? COUNTRY_PROFILES[key].label : 'Custom Manual';
            }

            function selectedRackLabel() {
                var sel = document.getElementById('inRackType');
                if (!sel) return 'Unknown';
                var key = sel.value;
                return (RACK_PROFILES[key] && RACK_PROFILES[key].label) ? RACK_PROFILES[key].label : key;
            }

            function countryLabelByKey(key) {
                return (COUNTRY_PROFILES[key] && COUNTRY_PROFILES[key].label) ? COUNTRY_PROFILES[key].label : 'Custom Manual';
            }

            function rackLabelByKey(key) {
                return (RACK_PROFILES[key] && RACK_PROFILES[key].label) ? RACK_PROFILES[key].label : String(key || 'Unknown');
            }

            function gatherInputs() {
                return {
                    itLoadMw: Math.max(n('inItLoad'), 0.5),
                    rackCount: Math.max(n('inRackCount'), 10),
                    rackType: document.getElementById('inRackType').value,
                    rackDensityTarget: clamp(n('inRackDensityTarget'), 5, 180),
                    highDensityShare: clamp(n('inHighDensityShare'), 0, 100),
                    modelYear: clamp(Math.round(n('inModelYear')), 2026, 2045),
                    architectureMode: document.getElementById('inCoolingArchitecture').value,
                    liquidCapture: clamp(n('inLiquidCapture'), 0, 100),
                    coolantKey: document.getElementById('inCoolant').value,
                    supplyTemp: n('inSupplyTemp'),
                    returnTemp: n('inReturnTemp'),
                    pumpHead: Math.max(n('inPumpHead'), 5),
                    pumpEff: clamp(n('inPumpEff'), 35, 95),
                    hydraulicMargin: clamp(n('inHydraulicMargin'), 0, 45),
                    controlQuality: clamp(n('inControlQuality'), 0, 100),
                    predictiveGain: clamp(n('inPredictiveGain'), 0, 60),
                    coefHeatTransfer: clamp(n('inCoefHeatTransfer'), 60, 99),
                    coefCduLoss: clamp(n('inCoefCduLoss'), 0.5, 4.5),
                    coefPipeLoss: clamp(n('inCoefPipeLoss'), 0.75, 1.8),
                    coefFutureTech: clamp(n('inCoefFutureTech'), -10, 45),
                    cduUnit: Math.max(n('inCduUnit'), 300),
                    redundancy: document.getElementById('inRedundancy').value,
                    climate: document.getElementById('inClimate').value,
                    countryKey: document.getElementById('inCountryProfile').value,
                    airCop: Math.max(n('inAirCop'), 1.5),
                    economizerHours: clamp(n('inEconomizerHours'), 0, 95),
                    fanPower: clamp(n('inFanPower'), 0.5, 12),
                    upsEff: clamp(n('inUpsEff'), 90, 99.5),
                    distLoss: clamp(n('inDistLoss'), 0.5, 8),
                    heatReuse: clamp(n('inHeatReuse'), 0, 80),
                    elecPrice: Math.max(n('inElecPrice'), 0.01),
                    waterTariff: Math.max(n('inWaterTariff'), 0.1),
                    carbonIntensity: clamp(n('inCarbonIntensity'), 0.05, 1.1),
                    monitoring: clamp(n('inMonitoring'), 0, 100),
                    fireType: document.getElementById('inFireType').value,
                    targetPue: Math.max(n('inTargetPue'), 1.05),
                    targetCop: Math.max(n('inTargetCop'), 3),
                    failureMode: document.getElementById('inFailureMode').value,
                    concurrent: document.getElementById('inConcurrent').checked
                };
            }

            function gatherCalibrationTargets() {
                var targets = {
                    pue: maybeNum('calTargetPue', 1.01),
                    cop: maybeNum('calTargetCop', 1.2),
                    energyGwh: maybeNum('calTargetEnergy', 0.1),
                    netOpex: maybeNum('calTargetNetOpex', 1000),
                    carbon: maybeNum('calTargetCarbon', 1),
                    pumpKw: maybeNum('calTargetPump', 0.1)
                };
                var count = 0;
                Object.keys(targets).forEach(function(key) {
                    if (targets[key] !== null) count += 1;
                });
                targets.metricCount = count;
                return targets;
            }

            function calibrationError(model, targets) {
                var total = 0;
                var nMetrics = 0;

                function add(pred, tgt, weight, floorScale) {
                    if (tgt === null || tgt === undefined) return;
                    var scale = Math.max(Math.abs(tgt), floorScale);
                    var rel = (pred - tgt) / scale;
                    total += weight * rel * rel;
                    nMetrics += 1;
                }

                add(model.pue, targets.pue, 3.2, 1);
                add(model.systemCop, targets.cop, 2.6, 1);
                add(model.annualGwh, targets.energyGwh, 1.8, 1);
                add(model.netOpex, targets.netOpex, 2.2, 1000);
                add(model.netCarbonTons, targets.carbon, 1.6, 1);
                add(model.pumpPowerKw, targets.pumpKw, 1.2, 1);

                if (nMetrics === 0) return { error: Infinity, metrics: 0 };
                return { error: total / nMetrics, metrics: nMetrics };
            }

            function fitScoreFromError(err) {
                if (!isFinite(err)) return 0;
                return clamp(100 * Math.exp(-err * 1.35), 0, 99.9);
            }

            function renderCalibrationPanel() {
                var statusEl = document.getElementById('calStatus');
                var summaryEl = document.getElementById('calSummary');
                if (!statusEl || !summaryEl) return;

                if (!calibrationState) {
                    statusEl.textContent = 'Not Calibrated';
                    statusEl.className = 'calibration-status';
                    setText('outCalFit', '-');
                    summaryEl.textContent = 'Calibration idle. Provide telemetry targets and run calibration.';
                    return;
                }

                var fit = fitScoreFromError(calibrationState.bestError);
                var stale = calibrationDirty;
                statusEl.textContent = (stale ? 'Calibrated (Stale) ' : 'Calibrated ') + fmtNum(fit, 1) + '%';
                statusEl.className = 'calibration-status ' + (stale ? 'stale' : 'ok');
                setText('outCalFit', fmtNum(fit, 1) + '%');

                var lines = [];
                lines.push('Metrics: ' + calibrationState.metricCount + ' | baseline err ' + fmtNum(calibrationState.baseError, 4) + ' -> calibrated err ' + fmtNum(calibrationState.bestError, 4));
                lines.push('Tuned: control ' + fmtNum(calibrationState.tuned.controlQuality, 0) + '%, predictive ' + fmtNum(calibrationState.tuned.predictiveGain, 0) + '%, heatTransfer ' + fmtNum(calibrationState.tuned.coefHeatTransfer, 1) + '%, cduLoss ' + fmtNum(calibrationState.tuned.coefCduLoss, 2) + '%.');
                lines.push('pipeLoss ' + fmtNum(calibrationState.tuned.coefPipeLoss, 2) + 'x, future ' + fmtNum(calibrationState.tuned.coefFutureTech, 0) + '%, liquidCapture ' + fmtNum(calibrationState.tuned.liquidCapture, 0) + '%.');
                if (stale) lines.push('Status: inputs changed after calibration; run calibration again to refresh fit.');
                summaryEl.textContent = lines.join('\n');
            }

            function ashraeScore(supplyTemp, returnTemp, deltaT, effectiveCapture, designDensity, controlIndex) {
                var score = 100;
                if (supplyTemp < 18 || supplyTemp > 40) score -= 30;
                if (returnTemp > 50) score -= 18;
                if (deltaT < 6) score -= 14;
                if (deltaT > 14) score -= 8;
                if (effectiveCapture < 65) score -= 12;
                if (designDensity > 100) score -= 7;
                if (controlIndex < 60) score -= 9;
                return clamp(score, 0, 100);
            }

            function ansiScore(redundancy, monitoring, rackDensity, hydraulicMargin, rackProfileKey) {
                var base = redundancy === '2N' ? 88 : (redundancy === 'N1' ? 78 : 62);
                base += monitoring * 0.11;
                if (rackDensity > 80) base -= 6;
                if (hydraulicMargin > 25) base -= 4;
                if (rackProfileKey === 'legacy_air_plus_rdhx') base -= 6;
                return clamp(base, 0, 100);
            }

            function isoScore(monitoring, pue, netCarbonTons, annualGwh, futureFactor) {
                var score = 35 + monitoring * 0.42;
                if (pue <= 1.2) score += 21;
                else if (pue <= 1.3) score += 15;
                else if (pue <= 1.4) score += 9;
                else if (pue <= 1.5) score += 4;
                var intensity = annualGwh > 0 ? netCarbonTons / annualGwh : 0;
                if (intensity <= 250) score += 8;
                else if (intensity <= 350) score += 4;
                if (futureFactor > 1.15) score += 4;
                return clamp(score, 0, 100);
            }

            function nfpaScore(fireType, concurrent, designDensity) {
                var map = {
                    clean_agent: 94,
                    water_mist: 88,
                    double_interlock: 81,
                    dry_pipe: 72
                };
                var score = map[fireType] || 70;
                if (concurrent) score += 4;
                if (designDensity > 90) score -= 4;
                return clamp(score, 0, 100);
            }

            function uptimeScore(redundancy, monitoring, concurrent, upsEff, controlIndex) {
                var score = redundancy === '2N' ? 92 : (redundancy === 'N1' ? 80 : 58);
                score += monitoring * 0.1;
                score += (upsEff - 95) * 3.2;
                score += (controlIndex - 70) * 0.14;
                if (concurrent) score += 6;
                return clamp(score, 0, 100);
            }

            function grade(score) {
                if (score >= 90) return 'Grade A';
                if (score >= 80) return 'Grade B';
                if (score >= 70) return 'Grade C';
                if (score >= 60) return 'Grade D';
                return 'Grade E';
            }

            function computeModel(input) {
                var climateData = CLIMATE_FACTORS[input.climate] || CLIMATE_FACTORS.tropical;
                var coolant = COOLANTS[input.coolantKey] || COOLANTS.water;
                var rackProfile = RACK_PROFILES[input.rackType] || RACK_PROFILES.ai_hpc_direct_liquid;
                var failureMode = input.failureMode || 'normal';
                var failureNote = 'Normal operation profile';
                var elecPriceEff = input.elecPrice;
                var carbonIntensityEff = input.carbonIntensity;
                var failureRiskAdd = 0;

                var yearDelta = Math.max(input.modelYear - 2026, 0);
                var futureFactor = clamp(1 + ((input.coefFutureTech + (yearDelta * 0.9)) / 100) * rackProfile.futureBias, 0.8, 1.65);
                var controlIndex = clamp(
                    (input.controlQuality * 0.55) +
                    (input.predictiveGain * 0.95) +
                    (input.monitoring * 0.22) +
                    (input.concurrent ? 8 : 0),
                    0,
                    100
                );

                if (failureMode === 'sensor_degraded') {
                    controlIndex = clamp(controlIndex - 18, 0, 100);
                    failureRiskAdd += 13;
                    failureNote = 'Sensor degraded: reduced control observability';
                } else if (failureMode === 'redundancy_degraded') {
                    failureRiskAdd += 16;
                    failureNote = 'Redundancy degraded: resilience margin reduced';
                } else if (failureMode === 'grid_stress') {
                    elecPriceEff *= 1.18;
                    carbonIntensityEff *= 1.12;
                    failureRiskAdd += 6;
                    failureNote = 'Grid stress: tariff and carbon intensity elevated';
                }

                var designDensity = Math.max(5, input.rackDensityTarget * (1 + input.highDensityShare / 250) * (1 + yearDelta * 0.0045));
                var densityStress = clamp(designDensity / 70, 0.5, 2.8);
                var effectiveCapture = clamp(
                    input.liquidCapture * (0.74 + rackProfile.liquidBias * 0.26) * (input.coefHeatTransfer / 100) * (1 + controlIndex / 500),
                    20,
                    99
                );

                var itKw = Math.max(input.itLoadMw * 1000, 100);
                var liquidKw = itKw * (effectiveCapture / 100);
                var airKw = itKw - liquidKw;
                var baseDeltaT = Math.max(input.returnTemp - input.supplyTemp, 3);
                var deltaT = clamp(baseDeltaT * (0.9 + densityStress * 0.08), 3, 20);

                var massFlowKgS = liquidKw / (coolant.cp * deltaT);
                var baseFlowM3s = massFlowKgS / coolant.rho;
                var redundancyFactor = input.redundancy === '2N' ? 2 : (input.redundancy === 'N1' ? 1.15 : 1);
                var pipeFactor = input.coefPipeLoss;
                var designFlowM3s = baseFlowM3s * redundancyFactor * (1 + (input.hydraulicMargin / 100)) * pipeFactor;
                var flowLpm = designFlowM3s * 60000;

                var pumpHeadEff = input.pumpHead * pipeFactor * (1 + (densityStress - 1) * 0.22);
                var hydraulicPowerKw = (coolant.rho * 9.81 * pumpHeadEff * designFlowM3s) / 1000;
                var pumpPowerKw = hydraulicPowerKw / Math.max(input.pumpEff / 100, 0.35);

                var cduLossKw = liquidKw * (input.coefCduLoss / 100);
                var economizerFraction = input.economizerHours / 100;
                var supplyBonus = clamp((input.supplyTemp - 28) * 0.11, -0.45, 1.5);
                var controlBonus = (controlIndex - 60) / 180;

                var liquidCop = clamp(
                    (6.1 + climateData.climateCopBias + supplyBonus + economizerFraction * 1.05 + controlBonus) * futureFactor,
                    3.0,
                    19
                );

                var airCopEff = clamp(
                    input.airCop * (1 + economizerFraction * 0.58 + controlBonus * 0.32) * (0.92 + (1 - rackProfile.airResidual) * 0.12),
                    1.7,
                    16
                );

                if (failureMode === 'heatwave') {
                    airCopEff = clamp(airCopEff * 0.82, 1.4, 16);
                    failureRiskAdd += 9;
                    failureNote = 'Heatwave stress: reduced air-path cooling effectiveness';
                }

                var liquidCoolingKw = ((liquidKw + cduLossKw) / liquidCop) + pumpPowerKw;
                if (failureMode === 'pump_degraded') {
                    pumpPowerKw *= 1.28;
                    liquidCoolingKw *= 1.14;
                    flowLpm *= 0.9;
                    failureRiskAdd += 11;
                    failureNote = 'Pump degraded: lower flow and higher hydraulic overhead';
                }
                var airCoolingKw = airKw / airCopEff;
                var fanKw = itKw * (input.fanPower / 100) * (1 - effectiveCapture / 100 * 0.55) * (1 - controlBonus * 0.18);
                var totalCoolingKw = liquidCoolingKw + airCoolingKw + fanKw;
                var systemCop = itKw / Math.max(totalCoolingKw, 1);

                var upsInputKw = itKw / Math.max(input.upsEff / 100, 0.9);
                var upsLossKw = upsInputKw - itKw;
                var distLossKw = upsInputKw * (input.distLoss / 100);

                var auxKw = itKw * 0.03;
                var totalFacilityKw = itKw + totalCoolingKw + upsLossKw + distLossKw + auxKw;
                var pue = totalFacilityKw / itKw;

                var annualKwh = totalFacilityKw * 8760;
                var annualGwh = annualKwh / 1000000;
                var annualEnergyCost = annualKwh * elecPriceEff;

                var wue = climateData.baseWue * (1 - economizerFraction * 0.43) * (1 - effectiveCapture / 100 * 0.32) * (1 - (futureFactor - 1) * 0.18);
                wue = Math.max(wue, 0.04);
                var annualWaterM3 = (annualKwh * wue) / 1000;
                var annualWaterCost = annualWaterM3 * input.waterTariff;
                var grossOpex = annualEnergyCost + annualWaterCost;

                var heatReuseKwAvg = liquidKw * (input.heatReuse / 100) * (0.42 + rackProfile.futureBias * 0.1) * (1 + yearDelta * 0.012);
                var heatReuseKwh = heatReuseKwAvg * 8760;
                var heatReuseCredit = heatReuseKwh * elecPriceEff * 0.62;
                var netOpex = Math.max(grossOpex - heatReuseCredit, 0);

                var annualCarbonTons = (annualKwh * carbonIntensityEff) / 1000;
                var avoidedCarbonTons = (heatReuseKwh * carbonIntensityEff * 0.65) / 1000;
                var netCarbonTons = Math.max(annualCarbonTons - avoidedCarbonTons, 0);

                var cduBase = Math.max(1, Math.ceil(liquidKw / input.cduUnit));
                var cduCount = input.redundancy === '2N' ? cduBase * 2 : (input.redundancy === 'N1' ? cduBase + 1 : cduBase);
                var rackDensity = itKw / Math.max(input.rackCount, 1);
                var rackDensityGap = designDensity - rackDensity;

                var scoreA = ashraeScore(input.supplyTemp, input.returnTemp, deltaT, effectiveCapture, designDensity, controlIndex);
                var scoreB = ansiScore(input.redundancy, input.monitoring, rackDensity, input.hydraulicMargin, input.rackType);
                var scoreC = isoScore(input.monitoring, pue, netCarbonTons, annualGwh, futureFactor);
                var scoreD = nfpaScore(input.fireType, input.concurrent, designDensity);
                var scoreE = uptimeScore(input.redundancy, input.monitoring, input.concurrent, input.upsEff, controlIndex);
                var totalScore = (scoreA * 0.24) + (scoreB * 0.16) + (scoreC * 0.16) + (scoreD * 0.2) + (scoreE * 0.24);

                var riskIndex = 18;
                riskIndex += rackProfile.riskBias;
                if (input.redundancy === 'N') riskIndex += 12;
                if (!input.concurrent) riskIndex += 8;
                if (designDensity > 90) riskIndex += 8;
                if (rackDensity > 80) riskIndex += 8;
                if (input.fireType === 'dry_pipe') riskIndex += 6;
                riskIndex += Math.max(0, (80 - input.monitoring) * 0.2);
                riskIndex += Math.max(0, (input.upsEff < 96 ? (96 - input.upsEff) * 3 : 0));
                riskIndex -= Math.max(0, (controlIndex - 70) * 0.18);
                riskIndex -= yearDelta * 0.12;
                riskIndex += failureRiskAdd;
                riskIndex = clamp(riskIndex, 5, 95);

                var confidence = clamp(
                    45 +
                    (input.monitoring * 0.32) +
                    (input.concurrent ? 6 : 0) +
                    (input.countryKey !== 'custom' ? 8 : 0) +
                    ((deltaT >= 6 && deltaT <= 14) ? 6 : 0) +
                    ((input.hydraulicMargin <= 20) ? 3 : 0) +
                    ((input.coefPipeLoss >= 0.9 && input.coefPipeLoss <= 1.2) ? 2 : 0),
                    0,
                    99
                );

                var pueGap = pue - input.targetPue;
                var copGap = systemCop - input.targetCop;

                return {
                    input: input,
                    rackTypeLabel: rackProfile.label,
                    itKw: itKw,
                    liquidKw: liquidKw,
                    airKw: airKw,
                    effectiveCapture: effectiveCapture,
                    designDensity: designDensity,
                    rackDensityGap: rackDensityGap,
                    controlIndex: controlIndex,
                    futureFactor: futureFactor,
                    yearDelta: yearDelta,
                    deltaT: deltaT,
                    flowLpm: flowLpm,
                    pumpPowerKw: pumpPowerKw,
                    cduCount: cduCount,
                    pue: pue,
                    systemCop: systemCop,
                    wue: wue,
                    annualGwh: annualGwh,
                    annualEnergyCost: annualEnergyCost,
                    elecPriceEff: elecPriceEff,
                    carbonIntensityEff: carbonIntensityEff,
                    annualWaterCost: annualWaterCost,
                    annualOpex: grossOpex,
                    heatReuseCredit: heatReuseCredit,
                    netOpex: netOpex,
                    annualCarbonTons: annualCarbonTons,
                    avoidedCarbonTons: avoidedCarbonTons,
                    netCarbonTons: netCarbonTons,
                    rackDensity: rackDensity,
                    confidence: confidence,
                    riskIndex: riskIndex,
                    failureMode: failureMode,
                    failureNote: failureNote,
                    scores: { ashrae: scoreA, ansi: scoreB, iso: scoreC, nfpa: scoreD, uptime: scoreE, total: totalScore },
                    pueGap: pueGap,
                    copGap: copGap,
                    totalFacilityKw: totalFacilityKw,
                    internals: {
                        yearDelta: yearDelta,
                        densityStress: densityStress,
                        redundancyFactor: redundancyFactor,
                        pipeFactor: pipeFactor,
                        pumpHeadEff: pumpHeadEff,
                        liquidCop: liquidCop,
                        airCopEff: airCopEff,
                        totalCoolingKw: totalCoolingKw,
                        economizerFraction: economizerFraction,
                        annualKwh: annualKwh,
                        annualWaterM3: annualWaterM3,
                        heatReuseKwh: heatReuseKwh
                    },
                    breakdown: {
                        it: itKw,
                        liquidCooling: liquidCoolingKw,
                        airCooling: airCoolingKw,
                        pump: pumpPowerKw,
                        elecLoss: upsLossKw + distLossKw,
                        aux: auxKw + fanKw
                    }
                };
            }

            function renderTargetActions(base, opt) {
                var list = document.getElementById('targetActions');
                if (!list) return;
                var items = [];

                if (!base) {
                    items.push('Run model to generate optimization actions.');
                } else if (!opt) {
                    items.push('Edit any algorithm/control coefficient and run Optimize To Target for multi-factor convergence.');
                    items.push('Model tracks 100% parameter mapping from input profile to outputs, scores, and risk logic.');
                    if (base.failureMode && base.failureMode !== 'normal') items.push('Active degraded mode: ' + base.failureMode + ' (' + base.failureNote + ').');
                } else {
                    var dCapture = opt.input.liquidCapture - base.input.liquidCapture;
                    var dSupply = opt.input.supplyTemp - base.input.supplyTemp;
                    var dAirCop = opt.input.airCop - base.input.airCop;
                    var dPumpEff = opt.input.pumpEff - base.input.pumpEff;
                    var dControl = opt.input.controlQuality - base.input.controlQuality;
                    var dFuture = opt.input.coefFutureTech - base.input.coefFutureTech;
                    var dPue = base.pue - opt.pue;
                    var dCop = opt.systemCop - base.systemCop;
                    var dRisk = base.riskIndex - opt.riskIndex;

                    if (Math.abs(dCapture) > 0.4) items.push('Liquid capture tuned to ' + fmtNum(opt.input.liquidCapture, 0) + '% (' + signed(dCapture, 0, ' pts') + ').');
                    if (Math.abs(dSupply) > 0.2) items.push('Supply setpoint moved to ' + fmtNum(opt.input.supplyTemp, 1) + 'C (' + signed(dSupply, 1, 'C') + ').');
                    if (Math.abs(dAirCop) > 0.05) items.push('Air-path COP updated to ' + fmtNum(opt.input.airCop, 2) + ' (' + signed(dAirCop, 2, '') + ').');
                    if (Math.abs(dPumpEff) > 0.5) items.push('Pump efficiency adjusted to ' + fmtNum(opt.input.pumpEff, 0) + '% (' + signed(dPumpEff, 0, ' pts') + ').');
                    if (Math.abs(dControl) > 0.5) items.push('Control quality shifted to ' + fmtNum(opt.input.controlQuality, 0) + '% (' + signed(dControl, 0, ' pts') + ').');
                    if (Math.abs(dFuture) > 0.5) items.push('Future-tech multiplier set to ' + fmtNum(opt.input.coefFutureTech, 0) + '% (' + signed(dFuture, 0, ' pts') + ').');
                    items.push('Projected impact: PUE ' + signed(dPue, 3, '') + ' better, COP ' + signed(dCop, 2, '') + ', net OPEX ' + signed(base.netOpex - opt.netOpex, 0, ' USD/yr') + ', risk index ' + signed(dRisk, 1, '') + ' better.');
                    if (opt.failureMode && opt.failureMode !== 'normal') items.push('Optimization computed under degraded mode: ' + opt.failureMode + ' (' + opt.failureNote + ').');
                }

                list.innerHTML = items.map(function(text) { return '<li>' + text + '</li>'; }).join('');
            }

            function renderScenarioTable(base, opt) {
                if (!base) return;
                setText('basePue', fmtNum(base.pue, 3));
                setText('baseCop', fmtNum(base.systemCop, 2));
                setText('baseNetOpex', fmtUsd(base.netOpex));
                setText('baseCarbon', fmtNum(base.netCarbonTons, 0) + ' tCO2e');
                setText('baseWue', fmtNum(base.wue, 3));

                if (!opt) {
                    setText('optPue', '-');
                    setText('optCop', '-');
                    setText('optNetOpex', '-');
                    setText('optCarbon', '-');
                    setText('optWue', '-');
                    setText('deltaPue', '-');
                    setText('deltaCop', '-');
                    setText('deltaNetOpex', '-');
                    setText('deltaCarbon', '-');
                    setText('deltaWue', '-');
                    return;
                }

                setText('optPue', fmtNum(opt.pue, 3));
                setText('optCop', fmtNum(opt.systemCop, 2));
                setText('optNetOpex', fmtUsd(opt.netOpex));
                setText('optCarbon', fmtNum(opt.netCarbonTons, 0) + ' tCO2e');
                setText('optWue', fmtNum(opt.wue, 3));

                setText('deltaPue', signed(opt.pue - base.pue, 3, ''));
                setText('deltaCop', signed(opt.systemCop - base.systemCop, 2, ''));
                setText('deltaNetOpex', signed(opt.netOpex - base.netOpex, 0, ' USD'));
                setText('deltaCarbon', signed(opt.netCarbonTons - base.netCarbonTons, 0, ' tCO2e'));
                setText('deltaWue', signed(opt.wue - base.wue, 3, ''));
            }

            function renderBreakdown(model) {
                if (!model) return;
                var total = Math.max(model.totalFacilityKw, 1);
                var keys = [
                    [model.breakdown.it, 'barFlowIt', 'flowIt'],
                    [model.breakdown.liquidCooling, 'barFlowLiquid', 'flowLiquid'],
                    [model.breakdown.airCooling, 'barFlowAir', 'flowAir'],
                    [model.breakdown.pump, 'barFlowPump', 'flowPump'],
                    [model.breakdown.elecLoss, 'barFlowElecLoss', 'flowElecLoss'],
                    [model.breakdown.aux, 'barFlowAux', 'flowAux']
                ];

                keys.forEach(function(item) {
                    var value = item[0];
                    var width = clamp((value / total) * 100, 0, 100);
                    setBar(item[1], width);
                    setText(item[2], fmtNum(value, 0) + ' kW (' + fmtNum(width, 1) + '%)');
                });
            }

            function renderEquationInspector(model) {
                var el = document.getElementById('equationList');
                if (!el || !model) return;

                var cp = (COOLANTS[model.input.coolantKey] || COOLANTS.water).cp;
                var rho = (COOLANTS[model.input.coolantKey] || COOLANTS.water).rho;
                var lines = [
                    'Q_liquid = IT_kW * capture = ' + fmtNum(model.itKw, 1) + ' * ' + fmtNum(model.effectiveCapture / 100, 3) + ' = ' + fmtNum(model.liquidKw, 1) + ' kW',
                    'm_dot = Q/(Cp*dT) = ' + fmtNum(model.liquidKw, 1) + '/(' + fmtNum(cp, 3) + '*' + fmtNum(model.deltaT, 2) + ') = ' + fmtNum((model.liquidKw / (cp * model.deltaT)), 2) + ' kg/s',
                    'flow_lpm = (m_dot/rho)*60000 = ' + fmtNum(model.flowLpm, 1) + ' LPM',
                    'P_hyd = rho*g*H*Q = ' + fmtNum(rho, 0) + '*9.81*' + fmtNum(model.internals.pumpHeadEff, 2) + '*Q',
                    'P_pump = P_hyd/eta = ' + fmtNum(model.pumpPowerKw, 2) + ' kW',
                    'COP_system = IT_kW / Cooling_kW = ' + fmtNum(model.itKw, 1) + '/' + fmtNum(model.internals.totalCoolingKw, 2) + ' = ' + fmtNum(model.systemCop, 3),
                    'PUE = Facility_kW / IT_kW = ' + fmtNum(model.totalFacilityKw, 2) + '/' + fmtNum(model.itKw, 1) + ' = ' + fmtNum(model.pue, 3),
                    'AnnualEnergy = Facility_kW * 8760 = ' + fmtNum(model.annualGwh, 3) + ' GWh',
                    'NetOPEX = (Energy + Water) - ReuseCredit = ' + fmtUsd(model.netOpex),
                    'NetCarbon = AnnualCarbon - AvoidedCarbon = ' + fmtNum(model.netCarbonTons, 1) + ' tCO2e/yr'
                ];

                el.innerHTML = lines.map(function(line, idx) {
                    return '<div class="equation-line"><strong>Eq ' + (idx + 1) + ':</strong> ' + escapeHtml(line) + '</div>';
                }).join('');
            }

            function renderConstraintStatus(model) {
                var el = document.getElementById('constraintStatus');
                if (!el || !model) return;
                var constraints = gatherConstraintState();
                var check = evaluateHardConstraints(model, constraints);
                var mode = model.failureMode === 'normal' ? 'normal' : model.failureMode;
                if (constraints.enforce && !check.feasible) {
                    el.className = 'status-pill err';
                    el.textContent = 'HARD VIOLATION | ' + check.issues.join(', ') + ' | mode ' + mode;
                } else if (!check.feasible) {
                    el.className = 'status-pill warn';
                    el.textContent = 'SOFT VIOLATION | ' + check.issues.join(', ') + ' | mode ' + mode;
                } else {
                    el.className = 'status-pill ok';
                    el.textContent = 'Constraint OK | pump ' + fmtNum(check.pumpPctIt, 2) + '% IT | mode ' + mode;
                }
            }

            function loadScenarios() {
                try {
                    var raw = localStorage.getItem(SCENARIO_STORE_KEY);
                    scenarioSnapshots = raw ? JSON.parse(raw) : [];
                    if (!Array.isArray(scenarioSnapshots)) scenarioSnapshots = [];
                } catch (e) {
                    scenarioSnapshots = [];
                }
            }

            function persistScenarios() {
                localStorage.setItem(SCENARIO_STORE_KEY, JSON.stringify(scenarioSnapshots));
            }

            function renderScenarioList() {
                var sel = document.getElementById('scenarioSelect');
                if (!sel) return;
                sel.innerHTML = '';
                if (!scenarioSnapshots.length) {
                    var opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No saved scenarios';
                    sel.appendChild(opt);
                    selectedScenarioIdx = -1;
                    renderPdfSourceSelectors();
                    return;
                }
                scenarioSnapshots.forEach(function(s, idx) {
                    var opt = document.createElement('option');
                    opt.value = String(idx);
                    opt.textContent = s.name + ' | v' + s.version + ' | ' + s.ts;
                    sel.appendChild(opt);
                });
                renderPdfSourceSelectors();
            }

            function getPdfSourceOptions() {
                var out = [
                    { value: 'live_baseline', label: 'Current Baseline Model' },
                    { value: 'live_optimized', label: 'Current Optimized Model' }
                ];
                scenarioSnapshots.forEach(function(s, idx) {
                    out.push({
                        value: 'scenario:' + idx,
                        label: 'Scenario | ' + s.name + ' | v' + s.version
                    });
                });
                return out;
            }

            function renderPdfSourceSelectors() {
                var ids = ['pdfSingleSource', 'pdfCompareLeft', 'pdfCompareRight'];
                var options = getPdfSourceOptions();
                ids.forEach(function(id) {
                    var el = document.getElementById(id);
                    if (!el) return;
                    var prev = el.value;
                    el.innerHTML = options.map(function(opt) {
                        return '<option value="' + escapeAttr(opt.value) + '">' + escapeHtml(opt.label) + '</option>';
                    }).join('');
                    if (prev && options.some(function(opt) { return opt.value === prev; })) {
                        el.value = prev;
                    }
                });

                var right = document.getElementById('pdfCompareRight');
                if (right && !right.value) right.value = 'live_optimized';
            }

            function resolveModelSource(sourceValue) {
                var val = String(sourceValue || 'live_baseline');
                if (val === 'live_optimized') {
                    var optModel = optimizedModel || baselineModel || computeModel(gatherInputs());
                    return {
                        ok: !!optModel,
                        key: val,
                        label: 'Current Optimized Model',
                        model: optModel,
                        constraints: gatherConstraintState(),
                        rules: Object.assign({}, gateRules),
                        ts: nowIso()
                    };
                }
                if (val === 'live_baseline') {
                    var baseModel = baselineModel || computeModel(gatherInputs());
                    return {
                        ok: !!baseModel,
                        key: val,
                        label: 'Current Baseline Model',
                        model: baseModel,
                        constraints: gatherConstraintState(),
                        rules: Object.assign({}, gateRules),
                        ts: nowIso()
                    };
                }
                if (val.indexOf('scenario:') === 0) {
                    var idx = parseInt(val.split(':')[1], 10);
                    var snap = scenarioSnapshots[idx];
                    if (!snap || !snap.input) return { ok: false, key: val, label: 'Unknown Scenario', model: null };
                    return {
                        ok: true,
                        key: val,
                        label: 'Scenario | ' + snap.name + ' | v' + snap.version,
                        model: computeModel(snap.input),
                        constraints: snap.constraints || gatherConstraintState(),
                        rules: snap.gateRules || Object.assign({}, gateRules),
                        ts: snap.ts || nowIso(),
                        scenario: snap
                    };
                }
                return { ok: false, key: val, label: 'Unknown Source', model: null };
            }

            function extractSankeyFlows(model) {
                if (!model) return null;
                var it = Math.max(model.itKw, 0);
                var elecLoss = Math.max(model.breakdown.elecLoss, 0);
                var auxBase = Math.max(model.itKw * 0.03, 0);
                var fan = Math.max(model.breakdown.aux - auxBase, 0);
                var pump = Math.max(model.breakdown.pump, 0);
                var liquidCore = Math.max(model.breakdown.liquidCooling - pump, 0);
                var air = Math.max(model.breakdown.airCooling, 0);
                var thermal = liquidCore + pump + air + fan;
                var facilityAux = auxBase;
                var total = it + thermal + elecLoss + facilityAux;
                return {
                    it: it,
                    thermal: thermal,
                    elecLoss: elecLoss,
                    facilityAux: facilityAux,
                    liquidCore: liquidCore,
                    pump: pump,
                    air: air,
                    fan: fan,
                    total: total
                };
            }

            function sankeyPct(value, total) {
                if (!isFinite(total) || total <= 0) return '0.0%';
                return fmtNum((value / total) * 100, 1) + '%';
            }

            function buildPdfKpiChartSvg(model) {
                if (!model) return '';
                var w = 680;
                var h = 160;
                var left = 170;
                var top = 24;
                var rowGap = 42;
                var bw = 460;
                var rows = [
                    { label: 'PUE (lower better)', value: model.pue, target: model.input.targetPue, min: 1.0, max: Math.max(model.pue, model.input.targetPue, 1.6), better: 'low' },
                    { label: 'COP (higher better)', value: model.systemCop, target: model.input.targetCop, min: 2.0, max: Math.max(model.systemCop, model.input.targetCop, 8.5), better: 'high' },
                    { label: 'Risk (lower better)', value: model.riskIndex, target: 35, min: 0, max: 100, better: 'low' }
                ];

                var svg = [
                    '<svg class="r-chart" viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="' + w + '" height="' + h + '" fill="white"/>'
                ];

                rows.forEach(function(r, i) {
                    var y = top + (i * rowGap);
                    var range = Math.max(r.max - r.min, 0.001);
                    var vNorm = clamp((r.value - r.min) / range, 0, 1);
                    var tNorm = clamp((r.target - r.min) / range, 0, 1);
                    var vx = left + (vNorm * bw);
                    var tx = left + (tNorm * bw);
                    var improved = (r.better === 'low') ? (r.value <= r.target) : (r.value >= r.target);
                    var color = improved ? '#047857' : '#b91c1c';
                    svg.push('<text x="10" y="' + (y + 4) + '" font-size="11" fill="#334155">' + escapeHtml(r.label) + '</text>');
                    svg.push('<line x1="' + left + '" y1="' + y + '" x2="' + (left + bw) + '" y2="' + y + '" stroke="#cbd5e1" stroke-width="7" stroke-linecap="round"/>');
                    svg.push('<line x1="' + left + '" y1="' + y + '" x2="' + vx + '" y2="' + y + '" stroke="' + color + '" stroke-width="7" stroke-linecap="round"/>');
                    svg.push('<line x1="' + tx + '" y1="' + (y - 10) + '" x2="' + tx + '" y2="' + (y + 10) + '" stroke="#0f172a" stroke-width="1.5"/>');
                    svg.push('<text x="' + (left + bw + 8) + '" y="' + (y + 4) + '" font-size="10" fill="#0f172a">val ' + fmtNum(r.value, r.label.indexOf('Risk') >= 0 ? 1 : 3) + ' | target ' + fmtNum(r.target, r.label.indexOf('Risk') >= 0 ? 1 : 3) + '</text>');
                });

                svg.push('</svg>');
                return svg.join('');
            }

            function buildPdfEnergyDistributionSvg(model) {
                if (!model) return '';
                var flows = extractSankeyFlows(model);
                if (!flows || flows.total <= 0.1) return '';

                var w = 680;
                var h = 140;
                var left = 24;
                var top = 28;
                var bw = 610;
                var parts = [
                    { label: 'IT Compute', value: flows.it, color: '#2563eb' },
                    { label: 'Thermal', value: flows.thermal, color: '#0891b2' },
                    { label: 'Electrical Loss', value: flows.elecLoss, color: '#d97706' },
                    { label: 'Facility Aux', value: flows.facilityAux, color: '#64748b' }
                ];

                var svg = [
                    '<svg class="r-chart" viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="' + w + '" height="' + h + '" fill="white"/>'
                ];

                var x = left;
                parts.forEach(function(p) {
                    var seg = Math.max(2, (p.value / flows.total) * bw);
                    svg.push('<rect x="' + fmtNum(x, 2) + '" y="' + top + '" width="' + fmtNum(seg, 2) + '" height="22" fill="' + p.color + '"/>');
                    svg.push('<text x="' + fmtNum(x + 2, 2) + '" y="' + (top + 16) + '" font-size="9" fill="#ffffff">' + fmtNum((p.value / flows.total) * 100, 1) + '%</text>');
                    x += seg;
                });

                var ly = 72;
                parts.forEach(function(p, idx) {
                    var y = ly + (idx * 15);
                    svg.push('<rect x="24" y="' + (y - 8) + '" width="10" height="10" fill="' + p.color + '"/>');
                    svg.push('<text x="40" y="' + y + '" font-size="10" fill="#334155">' + escapeHtml(p.label) + ': ' + fmtNum(p.value, 0) + ' kW (' + sankeyPct(p.value, flows.total) + ')</text>');
                });

                svg.push('</svg>');
                return svg.join('');
            }

            function buildPdfMonteCarloBandSvg() {
                if (!latestMonteCarlo || !latestMonteCarlo.dist) return '';
                var dist = latestMonteCarlo.dist;
                var specs = [
                    { key: 'pue', label: 'PUE', digits: 3, color: '#2563eb' },
                    { key: 'cop', label: 'COP', digits: 2, color: '#0891b2' },
                    { key: 'opex', label: 'Net OPEX', digits: 0, color: '#7c3aed' },
                    { key: 'carbon', label: 'Carbon', digits: 0, color: '#d97706' },
                    { key: 'risk', label: 'Risk', digits: 1, color: '#dc2626' }
                ];
                var w = 680;
                var h = 190;
                var left = 150;
                var trackW = 500;
                var top = 24;
                var rowGap = 30;

                var svg = [
                    '<svg class="r-chart" viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="' + w + '" height="' + h + '" fill="white"/>'
                ];

                specs.forEach(function(spec, idx) {
                    var arr = (dist[spec.key] || []).slice().sort(function(a, b) { return a - b; });
                    if (!arr.length) return;
                    var p10 = percentile(arr, 0.10);
                    var p50 = percentile(arr, 0.50);
                    var p90 = percentile(arr, 0.90);
                    var min = arr[0];
                    var max = arr[arr.length - 1];
                    if (max === min) max = min + 1e-9;
                    var y = top + (idx * rowGap);
                    var x10 = left + ((p10 - min) / (max - min)) * trackW;
                    var x50 = left + ((p50 - min) / (max - min)) * trackW;
                    var x90 = left + ((p90 - min) / (max - min)) * trackW;
                    svg.push('<text x="10" y="' + (y + 4) + '" font-size="10" fill="#334155">' + escapeHtml(spec.label) + '</text>');
                    svg.push('<line x1="' + left + '" y1="' + y + '" x2="' + (left + trackW) + '" y2="' + y + '" stroke="#cbd5e1" stroke-width="4" stroke-linecap="round"/>');
                    svg.push('<line x1="' + fmtNum(x10, 2) + '" y1="' + y + '" x2="' + fmtNum(x90, 2) + '" y2="' + y + '" stroke="' + spec.color + '" stroke-width="8" stroke-linecap="round"/>');
                    svg.push('<line x1="' + fmtNum(x50, 2) + '" y1="' + (y - 7) + '" x2="' + fmtNum(x50, 2) + '" y2="' + (y + 7) + '" stroke="#0f172a" stroke-width="1.2"/>');
                    svg.push('<text x="' + (left + trackW + 8) + '" y="' + (y + 4) + '" font-size="9" fill="#0f172a">P10 ' + fmtNum(p10, spec.digits) + ' | P50 ' + fmtNum(p50, spec.digits) + ' | P90 ' + fmtNum(p90, spec.digits) + '</text>');
                });

                svg.push('</svg>');
                return svg.join('');
            }

            function buildPdfCompareDeltaSvg(leftModel, rightModel) {
                if (!leftModel || !rightModel) return '';
                var rows = [
                    { label: 'PUE (right-left)', delta: rightModel.pue - leftModel.pue, better: 'low' },
                    { label: 'COP (right-left)', delta: rightModel.systemCop - leftModel.systemCop, better: 'high' },
                    { label: 'Net OPEX (right-left)', delta: rightModel.netOpex - leftModel.netOpex, better: 'low' },
                    { label: 'Carbon (right-left)', delta: rightModel.netCarbonTons - leftModel.netCarbonTons, better: 'low' },
                    { label: 'Risk (right-left)', delta: rightModel.riskIndex - leftModel.riskIndex, better: 'low' }
                ];
                var maxAbs = rows.reduce(function(m, r) { return Math.max(m, Math.abs(r.delta)); }, 0);
                maxAbs = Math.max(maxAbs, 0.001);

                var w = 680;
                var h = 170;
                var center = 390;
                var left = 150;
                var right = 640;
                var span = 230;
                var top = 24;
                var rowGap = 28;
                var svg = [
                    '<svg class="r-chart" viewBox="0 0 ' + w + ' ' + h + '" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="' + w + '" height="' + h + '" fill="white"/>',
                    '<line x1="' + center + '" y1="14" x2="' + center + '" y2="' + (h - 10) + '" stroke="#334155" stroke-width="1"/>'
                ];

                rows.forEach(function(r, idx) {
                    var y = top + (idx * rowGap);
                    var wBar = (Math.abs(r.delta) / maxAbs) * span;
                    var improved = (r.better === 'low') ? (r.delta <= 0) : (r.delta >= 0);
                    var color = improved ? '#047857' : '#b91c1c';
                    var x = r.delta >= 0 ? center : (center - wBar);
                    svg.push('<text x="8" y="' + (y + 4) + '" font-size="10" fill="#334155">' + escapeHtml(r.label) + '</text>');
                    svg.push('<rect x="' + fmtNum(left, 2) + '" y="' + (y - 6) + '" width="' + (right - left) + '" height="12" fill="#f1f5f9"/>');
                    svg.push('<rect x="' + fmtNum(x, 2) + '" y="' + (y - 6) + '" width="' + fmtNum(wBar, 2) + '" height="12" fill="' + color + '" />');
                    svg.push('<text x="' + (right + 6) + '" y="' + (y + 4) + '" font-size="9" fill="#0f172a">' + signed(r.delta, 3, '') + '</text>');
                });

                svg.push('</svg>');
                return svg.join('');
            }

            function buildPdfCompareEnergySvg(leftModel, rightModel) {
                var l = extractSankeyFlows(leftModel);
                var r = extractSankeyFlows(rightModel);
                if (!l || !r || l.total <= 0 || r.total <= 0) return '';
                var parts = [
                    { key: 'it', label: 'IT', color: '#2563eb' },
                    { key: 'thermal', label: 'Thermal', color: '#0891b2' },
                    { key: 'elecLoss', label: 'Elec Loss', color: '#d97706' },
                    { key: 'facilityAux', label: 'Aux', color: '#64748b' }
                ];

                function bar(y, set, total) {
                    var x = 170;
                    var bw = 470;
                    var out = [];
                    parts.forEach(function(p) {
                        var seg = Math.max(2, (set[p.key] / total) * bw);
                        out.push('<rect x="' + fmtNum(x, 2) + '" y="' + y + '" width="' + fmtNum(seg, 2) + '" height="18" fill="' + p.color + '"/>');
                        x += seg;
                    });
                    return out.join('');
                }

                var svg = [
                    '<svg class="r-chart" viewBox="0 0 680 130" xmlns="http://www.w3.org/2000/svg">',
                    '<rect x="0" y="0" width="680" height="130" fill="white"/>',
                    '<text x="10" y="34" font-size="11" fill="#334155">Baseline Mix</text>',
                    '<text x="10" y="84" font-size="11" fill="#334155">Optimized Mix</text>',
                    bar(20, l, l.total),
                    bar(70, r, r.total)
                ];
                parts.forEach(function(p, idx) {
                    var lx = 170 + (idx * 120);
                    svg.push('<rect x="' + lx + '" y="108" width="10" height="10" fill="' + p.color + '"/>');
                    svg.push('<text x="' + (lx + 14) + '" y="117" font-size="9" fill="#334155">' + p.label + '</text>');
                });
                svg.push('</svg>');
                return svg.join('');
            }

            function evaluateGateStatesWithRules(model, rules) {
                var ctx = buildRuleContext(model);
                var activeRules = rules || gateRules;
                var r1 = evaluateRuleExpression(activeRules.g1, ctx);
                var r2 = evaluateRuleExpression(activeRules.g2, ctx);
                var r3 = evaluateRuleExpression(activeRules.g3, ctx);
                return {
                    g1: !!r1.value,
                    g2: !!r2.value,
                    g3: !!r3.value
                };
            }

            function deltaCell(base, next, digits, better) {
                var delta = next - base;
                var pct = (Math.abs(base) > 0.0001) ? ((delta / base) * 100) : 0;
                var state = 'Neutral';
                if (better === 'low') {
                    if (delta < 0) state = 'Improved';
                    if (delta > 0) state = 'Worse';
                } else if (better === 'high') {
                    if (delta > 0) state = 'Improved';
                    if (delta < 0) state = 'Worse';
                }
                return signed(delta, digits, '') + ' (' + signed(pct, 1, '%') + ') | ' + state;
            }

            function metricStatus(model, constraints) {
                var c = evaluateHardConstraints(model, constraints || gatherConstraintState());
                var t = [];
                if (model.pue <= model.input.targetPue) t.push('PUE on target');
                if (model.systemCop >= model.input.targetCop) t.push('COP on target');
                if (c.feasible) t.push('Hard constraints pass');
                return t.length ? t.join(' | ') : 'Needs optimization';
            }

            function renderReportHead(title, subtitle) {
                return '<header class="r-head">' +
                    '<div>' +
                    '<h1>' + escapeHtml(title) + '</h1>' +
                    '<p>' + escapeHtml(subtitle) + '</p>' +
                    '</div>' +
                    '<div class="r-head-meta">' +
                    '<div><strong>Generated:</strong> ' + escapeHtml(nowIso()) + '</div>' +
                    '<div><strong>Tool:</strong> LTC System Modelling Lab</div>' +
                    '<div><strong>Mode:</strong> Print-ready PDF</div>' +
                    '</div>' +
                '</header>';
            }

            function reportShell(innerHtml) {
                return '<!doctype html><html lang="en"><head><meta charset="utf-8">' +
                    '<meta name="viewport" content="width=device-width, initial-scale=1">' +
                    '<title>LTC Report</title>' +
                    '<style>' +
                    '@page{size:A4;margin:12mm;}*{box-sizing:border-box;}body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;color:#0f172a;background:#ffffff;}' +
                    '.r-wrap{padding:10px 14px 20px;} .r-head{display:flex;justify-content:space-between;gap:16px;border-bottom:2px solid #dbe5ef;padding-bottom:10px;margin-bottom:12px;}' +
                    '.r-head h1{font-size:20px;margin:0 0 4px;} .r-head p{margin:0;font-size:12px;color:#475569;} .r-head-meta{font-size:11px;line-height:1.55;text-align:right;color:#334155;}' +
                    '.r-sec{margin-top:12px;border:1px solid #dbe5ef;border-radius:10px;overflow:hidden;} .r-sec h2{margin:0;padding:8px 10px;font-size:13px;background:#f1f5f9;border-bottom:1px solid #dbe5ef;}' +
                    '.r-sec .r-body{padding:9px 10px;} .r-kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;}' +
                    '.r-card{border:1px solid #dbe5ef;border-radius:8px;padding:8px;background:#f8fafc;} .r-card .k{font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:.06em;}' +
                    '.r-card .v{margin-top:3px;font-size:17px;font-weight:700;color:#0f172a;} .r-card .s{margin-top:3px;font-size:11px;color:#334155;line-height:1.4;}' +
                    '.r-grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;} .r-grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;}' +
                    'table{width:100%;border-collapse:collapse;font-size:11px;} th,td{padding:6px 7px;border-bottom:1px solid #e2e8f0;vertical-align:top;} th{background:#f8fafc;text-align:left;text-transform:uppercase;letter-spacing:.05em;font-size:10px;color:#475569;}' +
                    'tr:last-child td{border-bottom:none;} .ok{color:#047857;font-weight:700;} .warn{color:#b45309;font-weight:700;} .bad{color:#b91c1c;font-weight:700;}' +
                    '.tag{display:inline-block;padding:2px 7px;border:1px solid #dbe5ef;border-radius:999px;font-size:10px;background:#fff;margin-right:4px;} .muted{color:#64748b;font-size:11px;}' +
                    '.mono{font-family:JetBrains Mono,Consolas,monospace;} .split{display:grid;grid-template-columns:1fr 1fr;gap:10px;} .page-break{page-break-before:always;}' +
                    '@media print{.page-break{break-before:page;} .r-sec{break-inside:avoid;}}' +
                    '</style></head><body><div class="r-wrap">' + innerHtml + '</div>' +
                    '<script>window.addEventListener(\"load\",function(){setTimeout(function(){window.print();},220);});<\/script>' +
                    '</body></html>';
            }

            function openPdfReport(htmlContent) {
                var w = window.open('', '_blank', 'width=1200,height=860');
                if (!w) return false;
                w.document.open();
                w.document.write(reportShell(htmlContent));
                w.document.close();
                return true;
            }

            function buildSinglePdfReport(source) {
                var model = source.model;
                var rules = source.rules || gateRules;
                var constraints = source.constraints || gatherConstraintState();
                var hard = evaluateHardConstraints(model, constraints);
                var gates = evaluateGateStatesWithRules(model, rules);
                var quality = computeCalibrationQuality(model, gatherCalibrationTargets());
                var calScore = clamp(100 - (quality.valErr * 2.1) - (quality.ci95 * 1.3), 0, 100);
                var ledger = loadLedger();
                var summaryState = hard.feasible ? 'ok' : 'warn';
                var summaryText = hard.feasible ? 'Constraint envelope satisfied' : ('Constraint issues: ' + hard.issues.join(', '));

                return [
                    renderReportHead('LTC Engineering PDF Report (Single)', source.label),
                    '<section class="r-sec"><h2>Performance Snapshot</h2><div class="r-body">',
                    '<div class="r-kpi">',
                    '<div class="r-card"><div class="k">PUE</div><div class="v">' + fmtNum(model.pue, 3) + '</div><div class="s">Target ' + fmtNum(model.input.targetPue, 3) + ' | Gap ' + signed(model.pueGap, 3, '') + '</div></div>',
                    '<div class="r-card"><div class="k">System COP</div><div class="v">' + fmtNum(model.systemCop, 2) + '</div><div class="s">Target ' + fmtNum(model.input.targetCop, 2) + ' | Gap ' + signed(model.copGap, 2, '') + '</div></div>',
                    '<div class="r-card"><div class="k">Net OPEX</div><div class="v">' + fmtUsd(model.netOpex) + '</div><div class="s">Annual carbon ' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr</div></div>',
                    '<div class="r-card"><div class="k">Risk Index</div><div class="v">' + fmtNum(model.riskIndex, 1) + '/100</div><div class="s">' + escapeHtml(metricStatus(model, constraints)) + '</div></div>',
                    '<div class="r-card"><div class="k">Composite Score</div><div class="v">' + fmtNum(model.scores.total, 1) + '/100</div><div class="s">Grade ' + grade(model.scores.total) + '</div></div>',
                    '<div class="r-card"><div class="k">Degraded Mode</div><div class="v">' + escapeHtml(model.failureMode) + '</div><div class="s">' + escapeHtml(model.failureNote) + '</div></div>',
                    '</div></div></section>',

                    '<section class="r-sec"><h2>Constraint, Control, and Calibration</h2><div class="r-body">',
                    '<div class="r-grid3">',
                    '<div class="r-card"><div class="k">Constraint Engine</div><div class="s ' + summaryState + '">' + escapeHtml(summaryText) + '</div><div class="s">Pump as % IT: ' + fmtNum(hard.pumpPctIt, 2) + '%</div></div>',
                    '<div class="r-card"><div class="k">Control Gates</div><div class="s">G1 ' + (gates.g1 ? '<span class="ok">OPEN</span>' : '<span class="bad">BLOCKED</span>') + ' | G2 ' + (gates.g2 ? '<span class="ok">OPEN</span>' : '<span class="bad">BLOCKED</span>') + ' | G3 ' + (gates.g3 ? '<span class="ok">OPEN</span>' : '<span class="bad">BLOCKED</span>') + '</div><div class="s mono">G1 ' + escapeHtml(rules.g1) + '</div><div class="s mono">G2 ' + escapeHtml(rules.g2) + '</div><div class="s mono">G3 ' + escapeHtml(rules.g3) + '</div></div>',
                    '<div class="r-card"><div class="k">Calibration Quality</div><div class="v">' + fmtNum(calScore, 1) + '/100</div><div class="s">Validation error ' + fmtNum(quality.valErr, 2) + '% | 95% CI ' + fmtNum(quality.ci95, 2) + '%</div></div>',
                    '</div></div></section>',

                    '<section class="r-sec"><h2>Standards Alignment Scorecard</h2><div class="r-body"><table><thead><tr><th>Standard</th><th>Score</th><th>Status</th></tr></thead><tbody>',
                    '<tr><td>ASHRAE</td><td>' + fmtNum(model.scores.ashrae, 0) + '/100</td><td>' + (model.scores.ashrae >= 85 ? '<span class="ok">Strong</span>' : '<span class="warn">Needs hardening</span>') + '</td></tr>',
                    '<tr><td>ANSI/TIA-942</td><td>' + fmtNum(model.scores.ansi, 0) + '/100</td><td>' + (model.scores.ansi >= 85 ? '<span class="ok">Strong</span>' : '<span class="warn">Needs hardening</span>') + '</td></tr>',
                    '<tr><td>ISO 50001</td><td>' + fmtNum(model.scores.iso, 0) + '/100</td><td>' + (model.scores.iso >= 85 ? '<span class="ok">Strong</span>' : '<span class="warn">Needs hardening</span>') + '</td></tr>',
                    '<tr><td>NFPA</td><td>' + fmtNum(model.scores.nfpa, 0) + '/100</td><td>' + (model.scores.nfpa >= 85 ? '<span class="ok">Strong</span>' : '<span class="warn">Needs hardening</span>') + '</td></tr>',
                    '<tr><td>Uptime Institute</td><td>' + fmtNum(model.scores.uptime, 0) + '/100</td><td>' + (model.scores.uptime >= 85 ? '<span class="ok">Strong</span>' : '<span class="warn">Needs hardening</span>') + '</td></tr>',
                    '</tbody></table></div></section>',

                    '<section class="r-sec"><h2>Input / Output Vector (Engineering)</h2><div class="r-body"><div class="split">',
                    '<table><thead><tr><th>Input</th><th>Value</th></tr></thead><tbody>',
                    '<tr><td>IT Load</td><td>' + fmtNum(model.input.itLoadMw, 2) + ' MW</td></tr>',
                    '<tr><td>Rack Count</td><td>' + fmtNum(model.input.rackCount, 0) + '</td></tr>',
                    '<tr><td>Country Profile</td><td>' + escapeHtml(countryLabelByKey(model.input.countryProfile)) + '</td></tr>',
                    '<tr><td>Rack Type</td><td>' + escapeHtml(rackLabelByKey(model.input.rackType)) + '</td></tr>',
                    '<tr><td>Liquid Capture</td><td>' + fmtNum(model.input.liquidCapture, 1) + '%</td></tr>',
                    '<tr><td>Supply/Return Temp</td><td>' + fmtNum(model.input.supplyTemp, 1) + 'C / ' + fmtNum(model.input.returnTemp, 1) + 'C</td></tr>',
                    '<tr><td>Electricity Price</td><td>$' + fmtNum(model.input.elecPrice, 3) + '/kWh</td></tr>',
                    '<tr><td>Grid Carbon</td><td>' + fmtNum(model.input.carbonIntensity, 3) + ' kgCO2e/kWh</td></tr>',
                    '<tr><td>Control Quality</td><td>' + fmtNum(model.input.controlQuality, 0) + '%</td></tr>',
                    '</tbody></table>',
                    '<table><thead><tr><th>Output</th><th>Value</th></tr></thead><tbody>',
                    '<tr><td>Flow</td><td>' + fmtNum(model.flowLpm, 0) + ' LPM</td></tr>',
                    '<tr><td>Pump Power</td><td>' + fmtNum(model.pumpPowerKw, 1) + ' kW</td></tr>',
                    '<tr><td>WUE</td><td>' + fmtNum(model.wue, 3) + ' L/kWh</td></tr>',
                    '<tr><td>Annual Energy</td><td>' + fmtNum(model.annualGwh, 2) + ' GWh/yr</td></tr>',
                    '<tr><td>Annual OPEX</td><td>' + fmtUsd(model.annualOpex) + '</td></tr>',
                    '<tr><td>Heat Reuse Credit</td><td>' + fmtUsd(model.heatReuseCredit) + '</td></tr>',
                    '<tr><td>Net OPEX</td><td>' + fmtUsd(model.netOpex) + '</td></tr>',
                    '<tr><td>Net Carbon</td><td>' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr</td></tr>',
                    '</tbody></table>',
                    '</div></div></section>',

                    '<section class="r-sec page-break"><h2>Assumption Ledger (Audit Trail)</h2><div class="r-body">',
                    '<table><thead><tr><th>Parameter</th><th>Source</th><th>Owner</th><th>Confidence</th><th>Timestamp</th></tr></thead><tbody>',
                    ledger.map(function(row) {
                        return '<tr><td>' + escapeHtml(row.label) + '</td><td>' + escapeHtml(row.source) + '</td><td>' + escapeHtml(row.owner) + '</td><td>' + escapeHtml(String(row.confidence)) + '%</td><td>' + escapeHtml(row.ts) + '</td></tr>';
                    }).join(''),
                    '</tbody></table></div></section>'
                ].join('');
            }

            function buildComparePdfReport(left, right) {
                var lm = left.model;
                var rm = right.model;
                var lHard = evaluateHardConstraints(lm, left.constraints || gatherConstraintState());
                var rHard = evaluateHardConstraints(rm, right.constraints || gatherConstraintState());
                var lg = evaluateGateStatesWithRules(lm, left.rules || gateRules);
                var rg = evaluateGateStatesWithRules(rm, right.rules || gateRules);
                var metrics = [
                    { key: 'PUE', lv: lm.pue, rv: rm.pue, digits: 3, better: 'low' },
                    { key: 'COP', lv: lm.systemCop, rv: rm.systemCop, digits: 2, better: 'high' },
                    { key: 'Net OPEX (USD/yr)', lv: lm.netOpex, rv: rm.netOpex, digits: 0, better: 'low' },
                    { key: 'Net Carbon (tCO2e/yr)', lv: lm.netCarbonTons, rv: rm.netCarbonTons, digits: 0, better: 'low' },
                    { key: 'Risk Index', lv: lm.riskIndex, rv: rm.riskIndex, digits: 1, better: 'low' },
                    { key: 'Flow (LPM)', lv: lm.flowLpm, rv: rm.flowLpm, digits: 0, better: 'neutral' },
                    { key: 'Pump Power (kW)', lv: lm.pumpPowerKw, rv: rm.pumpPowerKw, digits: 1, better: 'low' },
                    { key: 'Composite Score', lv: lm.scores.total, rv: rm.scores.total, digits: 1, better: 'high' }
                ];

                var leftWin = (lHard.feasible ? 1 : 0) + (lm.pue <= lm.input.targetPue ? 1 : 0) + (lm.systemCop >= lm.input.targetCop ? 1 : 0) + (lm.riskIndex <= rm.riskIndex ? 1 : 0);
                var rightWin = (rHard.feasible ? 1 : 0) + (rm.pue <= rm.input.targetPue ? 1 : 0) + (rm.systemCop >= rm.input.targetCop ? 1 : 0) + (rm.riskIndex <= lm.riskIndex ? 1 : 0);
                var verdict = rightWin > leftWin ? ('Preferred configuration: ' + right.label) : (leftWin > rightWin ? ('Preferred configuration: ' + left.label) : 'Both configurations are balanced; choose based on deployment constraints.');

                return [
                    renderReportHead('LTC Engineering PDF Report (Compare)', left.label + ' vs ' + right.label),
                    '<section class="r-sec"><h2>Compare Summary</h2><div class="r-body">',
                    '<div class="r-grid2">',
                    '<div class="r-card"><div class="k">Left Source</div><div class="v" style="font-size:14px;">' + escapeHtml(left.label) + '</div><div class="s">Timestamp ' + escapeHtml(left.ts || nowIso()) + '</div><div class="s">Constraints ' + (lHard.feasible ? '<span class="ok">PASS</span>' : '<span class="bad">FAIL</span>') + ' | Gates G1:' + (lg.g1 ? 'open' : 'block') + ' G2:' + (lg.g2 ? 'open' : 'block') + ' G3:' + (lg.g3 ? 'open' : 'block') + '</div></div>',
                    '<div class="r-card"><div class="k">Right Source</div><div class="v" style="font-size:14px;">' + escapeHtml(right.label) + '</div><div class="s">Timestamp ' + escapeHtml(right.ts || nowIso()) + '</div><div class="s">Constraints ' + (rHard.feasible ? '<span class="ok">PASS</span>' : '<span class="bad">FAIL</span>') + ' | Gates G1:' + (rg.g1 ? 'open' : 'block') + ' G2:' + (rg.g2 ? 'open' : 'block') + ' G3:' + (rg.g3 ? 'open' : 'block') + '</div></div>',
                    '</div>',
                    '<div class="r-card" style="margin-top:8px;"><div class="k">Verdict</div><div class="s">' + escapeHtml(verdict) + '</div></div>',
                    '</div></section>',

                    '<section class="r-sec"><h2>Delta Matrix (Right - Left)</h2><div class="r-body"><table><thead><tr><th>Metric</th><th>Left</th><th>Right</th><th>Delta</th></tr></thead><tbody>',
                    metrics.map(function(m) {
                        return '<tr>' +
                            '<td>' + escapeHtml(m.key) + '</td>' +
                            '<td>' + fmtNum(m.lv, m.digits) + '</td>' +
                            '<td>' + fmtNum(m.rv, m.digits) + '</td>' +
                            '<td>' + escapeHtml(deltaCell(m.lv, m.rv, m.digits, m.better)) + '</td>' +
                        '</tr>';
                    }).join(''),
                    '</tbody></table></div></section>',

                    '<section class="r-sec"><h2>Standards Score Delta (Right - Left)</h2><div class="r-body"><table><thead><tr><th>Standard</th><th>Left</th><th>Right</th><th>Delta</th></tr></thead><tbody>',
                    '<tr><td>ASHRAE</td><td>' + fmtNum(lm.scores.ashrae, 0) + '</td><td>' + fmtNum(rm.scores.ashrae, 0) + '</td><td>' + signed(rm.scores.ashrae - lm.scores.ashrae, 0, '') + '</td></tr>',
                    '<tr><td>ANSI/TIA-942</td><td>' + fmtNum(lm.scores.ansi, 0) + '</td><td>' + fmtNum(rm.scores.ansi, 0) + '</td><td>' + signed(rm.scores.ansi - lm.scores.ansi, 0, '') + '</td></tr>',
                    '<tr><td>ISO 50001</td><td>' + fmtNum(lm.scores.iso, 0) + '</td><td>' + fmtNum(rm.scores.iso, 0) + '</td><td>' + signed(rm.scores.iso - lm.scores.iso, 0, '') + '</td></tr>',
                    '<tr><td>NFPA</td><td>' + fmtNum(lm.scores.nfpa, 0) + '</td><td>' + fmtNum(rm.scores.nfpa, 0) + '</td><td>' + signed(rm.scores.nfpa - lm.scores.nfpa, 0, '') + '</td></tr>',
                    '<tr><td>Uptime</td><td>' + fmtNum(lm.scores.uptime, 0) + '</td><td>' + fmtNum(rm.scores.uptime, 0) + '</td><td>' + signed(rm.scores.uptime - lm.scores.uptime, 0, '') + '</td></tr>',
                    '</tbody></table></div></section>',

                    '<section class="r-sec"><h2>Actionable Change Signals</h2><div class="r-body">',
                    '<div class="tag">PUE Delta ' + signed(rm.pue - lm.pue, 3, '') + '</div>',
                    '<div class="tag">COP Delta ' + signed(rm.systemCop - lm.systemCop, 2, '') + '</div>',
                    '<div class="tag">Risk Delta ' + signed(rm.riskIndex - lm.riskIndex, 1, '') + '</div>',
                    '<div class="tag">Pump Delta ' + signed(rm.pumpPowerKw - lm.pumpPowerKw, 1, ' kW') + '</div>',
                    '<p class="muted" style="margin-top:8px;">Use this compare pack for design-option reviews, gate reviews, and program-level tradeoff decisions.</p>',
                    '</div></section>'
                ].join('');
            }

            function exportPdfSingle() {
                var srcSel = document.getElementById('pdfSingleSource');
                var source = resolveModelSource(srcSel ? srcSel.value : 'live_baseline');
                if (!source.ok || !source.model) {
                    alert('PDF single export failed: invalid source model.');
                    return;
                }
                if (!openPdfReport(buildSinglePdfReport(source))) {
                    alert('Popup blocked. Please allow popups and retry PDF export.');
                    return;
                }
                var s = document.getElementById('exportStatus');
                if (s) {
                    s.className = 'status-pill ok';
                    s.textContent = 'PDF Single Report Opened';
                }
            }

            function exportPdfCompare() {
                var leftSel = document.getElementById('pdfCompareLeft');
                var rightSel = document.getElementById('pdfCompareRight');
                var left = resolveModelSource(leftSel ? leftSel.value : 'live_baseline');
                var right = resolveModelSource(rightSel ? rightSel.value : 'live_optimized');
                if (!left.ok || !right.ok || !left.model || !right.model) {
                    alert('PDF compare export failed: invalid compare source.');
                    return;
                }
                if (left.key === right.key) {
                    alert('Choose two different sources for compare PDF.');
                    return;
                }
                if (!openPdfReport(buildComparePdfReport(left, right))) {
                    alert('Popup blocked. Please allow popups and retry PDF compare export.');
                    return;
                }
                var s = document.getElementById('exportStatus');
                if (s) {
                    s.className = 'status-pill ok';
                    s.textContent = 'PDF Compare Report Opened';
                }
            }

            function applyInputObjectToForm(obj) {
                if (!obj) return;
                Object.keys(obj).forEach(function(k) {
                    var id = Object.keys(INPUT_KEY_BY_ID).find(function(idKey) { return INPUT_KEY_BY_ID[idKey] === k; });
                    var el = id ? document.getElementById(id) : null;
                    if (!el) return;
                    if (el.type === 'checkbox') el.checked = !!obj[k];
                    else el.value = obj[k];
                });
            }

            function snapshotSummary(model) {
                return 'PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2) + ' | OPEX ' + fmtUsd(model.netOpex) + ' | Carbon ' + fmtNum(model.netCarbonTons, 0);
            }

            function renderScenarioDiff(cur, prev) {
                var box = document.getElementById('scenarioDiff');
                if (!box) return;
                if (!cur || !prev) {
                    box.textContent = 'Select two scenarios sequentially to compare deltas.';
                    return;
                }
                var lines = [];
                lines.push('Compare: ' + prev.name + ' -> ' + cur.name);
                lines.push('PUE delta: ' + signed(cur.model.pue - prev.model.pue, 3, ''));
                lines.push('COP delta: ' + signed(cur.model.systemCop - prev.model.systemCop, 2, ''));
                lines.push('Net OPEX delta: ' + signed(cur.model.netOpex - prev.model.netOpex, 0, ' USD'));
                lines.push('Carbon delta: ' + signed(cur.model.netCarbonTons - prev.model.netCarbonTons, 0, ' tCO2e'));
                lines.push('Risk delta: ' + signed(cur.model.riskIndex - prev.model.riskIndex, 1, ''));
                box.textContent = lines.join('\n');
            }

            function loadLedger() {
                try {
                    var raw = localStorage.getItem(LEDGER_STORE_KEY);
                    if (raw) return JSON.parse(raw);
                } catch (e) {}
                return PROVENANCE_TEMPLATE.map(function(item) {
                    return Object.assign({}, item, { ts: nowIso() });
                });
            }

            function saveLedger(rows) {
                localStorage.setItem(LEDGER_STORE_KEY, JSON.stringify(rows));
            }

            function renderLedgerTable(rows) {
                var tbody = document.getElementById('ledgerRows');
                if (!tbody) return;
                if (!rows.length) {
                    tbody.innerHTML = '<tr><td colspan="5">No ledger rows.</td></tr>';
                    return;
                }
                tbody.innerHTML = rows.map(function(r) {
                    return '<tr>' +
                        '<td>' + escapeHtml(r.label) + '</td>' +
                        '<td>' + escapeHtml(r.source) + '</td>' +
                        '<td>' + escapeHtml(r.owner) + '</td>' +
                        '<td>' + escapeHtml(String(r.confidence)) + '%</td>' +
                        '<td>' + escapeHtml(r.ts) + '</td>' +
                    '</tr>';
                }).join('');
            }

            function flattenObject(prefix, obj, out) {
                Object.keys(obj || {}).forEach(function(key) {
                    var value = obj[key];
                    var nextKey = prefix ? (prefix + '.' + key) : key;
                    if (value === null || value === undefined) {
                        out[nextKey] = '-';
                    } else if (typeof value === 'number' || typeof value === 'string' || typeof value === 'boolean') {
                        out[nextKey] = value;
                    } else if (typeof value === 'object' && !Array.isArray(value)) {
                        flattenObject(nextKey, value, out);
                    }
                });
            }

            function formatTraceValue(value) {
                if (typeof value === 'number') {
                    if (Math.abs(value) >= 1000) return fmtNum(value, 0);
                    if (Math.abs(value) >= 100) return fmtNum(value, 1);
                    if (Math.abs(value) >= 10) return fmtNum(value, 2);
                    return fmtNum(value, 3);
                }
                if (typeof value === 'boolean') return value ? 'true' : 'false';
                return String(value);
            }

            function renderTraceability(model) {
                var inFlat = {};
                flattenObject('', model.input, inFlat);

                var outObj = {};
                Object.keys(model).forEach(function(key) {
                    if (key !== 'input') outObj[key] = model[key];
                });
                var outFlat = {};
                flattenObject('', outObj, outFlat);

                var inKeys = Object.keys(inFlat).sort();
                var outKeys = Object.keys(outFlat).sort();

                setText('inParamCount', inKeys.length);
                setText('outParamCount', outKeys.length);
                setText('traceSummary', 'Inputs ' + inKeys.length + ' | Outputs ' + outKeys.length);

                var inList = document.getElementById('inputTraceList');
                var outList = document.getElementById('outputTraceList');
                if (inList) {
                    inList.innerHTML = inKeys.map(function(key) {
                        return '<div class="trace-item">' + termTooltipSpan(key, key, 'input') + ' = ' + escapeHtml(formatTraceValue(inFlat[key])) + '</div>';
                    }).join('');
                }
                if (outList) {
                    outList.innerHTML = outKeys.map(function(key) {
                        return '<div class="trace-item">' + termTooltipSpan(key, key, 'output') + ' = ' + escapeHtml(formatTraceValue(outFlat[key])) + '</div>';
                    }).join('');
                }
            }

            function renderStageLines(id, lines) {
                var el = document.getElementById(id);
                if (!el) return;
                if (!lines || !lines.length) {
                    el.innerHTML = '<div class="stage-line">-</div>';
                    return;
                }
                el.innerHTML = lines.map(function(line) {
                    return '<div class="stage-line">' + renderStageLineContent(line) + '</div>';
                }).join('');
            }

            function renderPipelineFlow(model) {
                var inFlat = {};
                flattenObject('', model.input, inFlat);
                var inKeys = Object.keys(inFlat).sort();
                setText('stageInputCount', String(inKeys.length));
                renderStageLines('stageInputLines', inKeys.map(function(key) {
                    return {
                        label: key,
                        key: key,
                        value: formatTraceValue(inFlat[key]),
                        layer: 'input'
                    };
                }));

                var derivedLines = [
                    { key: 'effectiveCapture', label: 'effectiveCapture', value: fmtNum(model.effectiveCapture, 2) + '%', layer: 'processing' },
                    { key: 'designDensity', label: 'designDensity', value: fmtNum(model.designDensity, 2) + ' kW/rack', layer: 'processing' },
                    { key: 'rackDensityGap', label: 'rackDensityGap', value: fmtNum(model.rackDensityGap, 2) + ' kW/rack', layer: 'processing' },
                    { key: 'futureFactor', label: 'futureFactor', value: fmtNum(model.futureFactor, 3) + 'x', layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', value: fmtNum(model.controlIndex, 2) + '/100', layer: 'processing' },
                    { key: 'internals.densityStress', label: 'densityStress', value: fmtNum(model.internals.densityStress, 3), layer: 'processing' },
                    { key: 'internals.yearDelta', label: 'yearDelta', value: fmtNum(model.internals.yearDelta, 0) + ' yr', layer: 'processing' },
                    { key: 'deltaT', label: 'effectiveDeltaT', value: fmtNum(model.deltaT, 2) + ' C', layer: 'processing' }
                ];
                renderStageLines('stageDerivedLines', derivedLines);

                var controlLines = [
                    { key: 'controlQuality', label: 'controlQuality', value: fmtNum(model.input.controlQuality, 0) + '%', layer: 'processing' },
                    { key: 'predictiveGain', label: 'predictiveGain', value: fmtNum(model.input.predictiveGain, 0) + '%', layer: 'processing' },
                    { key: 'monitoring', label: 'monitoring', value: fmtNum(model.input.monitoring, 0) + '%', layer: 'processing' },
                    { key: 'concurrent', label: 'concurrent', value: (model.input.concurrent ? 'true' : 'false'), layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', relation: '->', value: 'liquidCop bias', layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', relation: '->', value: 'airCopEff bias', layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', relation: '->', value: 'fan reduction', layer: 'processing' },
                    { key: 'controlIndex', label: 'controlIndex', relation: '->', value: 'risk reduction', layer: 'processing' }
                ];
                renderStageLines('stageControlLines', controlLines);

                var solverLines = [
                    { key: 'massFlow', label: 'massFlow', value: 'Q/(Cp*dT)', layer: 'processing' },
                    { key: 'internals.redundancyFactor', label: 'redundancyFactor', value: fmtNum(model.internals.redundancyFactor, 2), layer: 'processing' },
                    { key: 'internals.pipeFactor', label: 'pipeFactor', value: fmtNum(model.internals.pipeFactor, 2), layer: 'processing' },
                    { key: 'internals.pumpHeadEff', label: 'pumpHeadEff', value: fmtNum(model.internals.pumpHeadEff, 2) + ' m', layer: 'processing' },
                    { key: 'flowLpm', label: 'flowLpm', value: fmtNum(model.flowLpm, 1), layer: 'processing' },
                    { key: 'internals.liquidCop', label: 'liquidCop', value: fmtNum(model.internals.liquidCop, 3), layer: 'processing' },
                    { key: 'internals.airCopEff', label: 'airCopEff', value: fmtNum(model.internals.airCopEff, 3), layer: 'processing' },
                    { key: 'internals.totalCoolingKw', label: 'totalCoolingKw', value: fmtNum(model.internals.totalCoolingKw, 2), layer: 'processing' },
                    { key: 'pumpPowerKw', label: 'pumpPowerKw', value: fmtNum(model.pumpPowerKw, 2), layer: 'processing' },
                    { key: 'cduCount', label: 'cduCount', value: fmtNum(model.cduCount, 0), layer: 'processing' }
                ];
                renderStageLines('stageSolverLines', solverLines);

                var ecoLines = [
                    { key: 'internals.annualKwh', label: 'annualKwh', value: fmtNum(model.internals.annualKwh, 0), layer: 'processing' },
                    { key: 'annualGwh', label: 'annualGwh', value: fmtNum(model.annualGwh, 3), layer: 'processing' },
                    { key: 'annualEnergyCost', label: 'annualEnergyCost', value: fmtUsd(model.annualEnergyCost), layer: 'processing' },
                    { key: 'internals.annualWaterM3', label: 'annualWaterM3', value: fmtNum(model.internals.annualWaterM3, 0), layer: 'processing' },
                    { key: 'annualWaterCost', label: 'annualWaterCost', value: fmtUsd(model.annualWaterCost), layer: 'processing' },
                    { key: 'internals.heatReuseKwh', label: 'heatReuseKwh', value: fmtNum(model.internals.heatReuseKwh, 0), layer: 'processing' },
                    { key: 'heatReuseCredit', label: 'heatReuseCredit', value: fmtUsd(model.heatReuseCredit), layer: 'processing' },
                    { key: 'annualOpex', label: 'grossOpex', value: fmtUsd(model.annualOpex), layer: 'processing' },
                    { key: 'netOpex', label: 'netOpex', value: fmtUsd(model.netOpex), layer: 'processing' },
                    { key: 'netCarbonTons', label: 'netCarbonTons', value: fmtNum(model.netCarbonTons, 0), layer: 'processing' }
                ];
                renderStageLines('stageEconomicLines', ecoLines);

                var outObj = {};
                Object.keys(model).forEach(function(key) {
                    if (key !== 'input') outObj[key] = model[key];
                });
                var outFlat = {};
                flattenObject('', outObj, outFlat);
                var outKeys = Object.keys(outFlat).sort();
                setText('stageOutputCount', String(outKeys.length));
                renderStageLines('stageOutputLines', outKeys.map(function(key) {
                    return {
                        label: key,
                        key: key,
                        value: formatTraceValue(outFlat[key]),
                        layer: 'output'
                    };
                }));
            }

            function renderNodeColumn(containerId, countId, entries, layer) {
                var container = document.getElementById(containerId);
                if (!container) return;
                setText(countId, String(entries.length));
                if (!entries.length) {
                    container.innerHTML = '<div class="fullmap-node"><div class="fullmap-key">-</div></div>';
                    return;
                }
                container.innerHTML = entries.map(function(entry, idx) {
                    var key = entry.key || entry.label || '-';
                    var label = entry.label || key;
                    var value = entry.value == null ? '-' : String(entry.value);
                    var delay = Math.min(idx * 0.012, 0.36);
                    return '' +
                        '<div class="fullmap-node" style="animation-delay:' + delay.toFixed(3) + 's">' +
                            '<div class="fullmap-key">' + termTooltipSpan(label, key, layer) + '</div>' +
                            '<div class="fullmap-val">' + escapeHtml(value) + '</div>' +
                        '</div>';
                }).join('');
            }

            function renderFullParameterMap(model) {
                if (!model) return;

                var inFlat = {};
                flattenObject('', model.input, inFlat);
                var inputEntries = Object.keys(inFlat).sort().map(function(key) {
                    return { key: key, label: key, value: formatTraceValue(inFlat[key]) };
                });

                var processingEntries = [
                    { key: 'effectiveCapture', label: 'effectiveCapture', value: fmtNum(model.effectiveCapture, 2) + '%' },
                    { key: 'designDensity', label: 'designDensity', value: fmtNum(model.designDensity, 2) + ' kW/rack' },
                    { key: 'rackDensityGap', label: 'rackDensityGap', value: fmtNum(model.rackDensityGap, 2) + ' kW/rack' },
                    { key: 'futureFactor', label: 'futureFactor', value: fmtNum(model.futureFactor, 3) + 'x' },
                    { key: 'controlIndex', label: 'controlIndex', value: fmtNum(model.controlIndex, 2) + '/100' },
                    { key: 'deltaT', label: 'effectiveDeltaT', value: fmtNum(model.deltaT, 2) + ' C' },
                    { key: 'flowLpm', label: 'flowLpm', value: fmtNum(model.flowLpm, 1) + ' LPM' },
                    { key: 'pumpPowerKw', label: 'pumpPowerKw', value: fmtNum(model.pumpPowerKw, 2) + ' kW' },
                    { key: 'internals.densityStress', label: 'densityStress', value: fmtNum(model.internals.densityStress, 3) },
                    { key: 'internals.redundancyFactor', label: 'redundancyFactor', value: fmtNum(model.internals.redundancyFactor, 2) },
                    { key: 'internals.pipeFactor', label: 'pipeFactor', value: fmtNum(model.internals.pipeFactor, 2) },
                    { key: 'internals.pumpHeadEff', label: 'pumpHeadEff', value: fmtNum(model.internals.pumpHeadEff, 2) + ' m' },
                    { key: 'internals.liquidCop', label: 'liquidCop', value: fmtNum(model.internals.liquidCop, 3) },
                    { key: 'internals.airCopEff', label: 'airCopEff', value: fmtNum(model.internals.airCopEff, 3) },
                    { key: 'internals.totalCoolingKw', label: 'totalCoolingKw', value: fmtNum(model.internals.totalCoolingKw, 2) + ' kW' },
                    { key: 'internals.annualKwh', label: 'annualKwh', value: fmtNum(model.internals.annualKwh, 0) },
                    { key: 'annualEnergyCost', label: 'annualEnergyCost', value: fmtUsd(model.annualEnergyCost) },
                    { key: 'annualWaterCost', label: 'annualWaterCost', value: fmtUsd(model.annualWaterCost) },
                    { key: 'internals.heatReuseKwh', label: 'heatReuseKwh', value: fmtNum(model.internals.heatReuseKwh, 0) },
                    { key: 'scores.total', label: 'scores.total', value: fmtNum(model.scores.total, 1) + '/100' }
                ];

                var outObj = {};
                Object.keys(model).forEach(function(key) {
                    if (key !== 'input') outObj[key] = model[key];
                });
                var outFlat = {};
                flattenObject('', outObj, outFlat);
                var outputEntries = Object.keys(outFlat).sort().map(function(key) {
                    return { key: key, label: key, value: formatTraceValue(outFlat[key]) };
                });

                renderNodeColumn('mapInputNodes', 'mapInputCount', inputEntries, 'input');
                renderNodeColumn('mapProcessNodes', 'mapProcessCount', processingEntries, 'processing');
                renderNodeColumn('mapOutputNodes', 'mapOutputCount', outputEntries, 'output');
            }

            function renderLogicSequence(model) {
                if (!model) return;
                var gateEval = evaluateGateStates(model);
                var g1Open = gateEval.g1;
                var g2Open = gateEval.g2;
                var g3Open = gateEval.g3;

                setText('seqInput', shortText('IT ' + fmtNum(model.input.itLoadMw, 1) + 'MW | racks ' + fmtNum(model.input.rackCount, 0) + ' | capture target ' + fmtNum(model.input.liquidCapture, 0) + '% | climate ' + model.input.climate, 120));
                setText('seqProcessing', shortText('Thermal/hydraulic solver: dT ' + fmtNum(model.deltaT, 2) + 'C -> flow ' + fmtNum(model.flowLpm, 0) + ' LPM -> pump ' + fmtNum(model.pumpPowerKw, 1) + ' kW', 120));
                setText('seqControl', shortText('G1 sensor quality ' + (g1Open ? 'OPEN' : 'TUNE') + ' | G2 actuator limit ' + (g2Open ? 'OPEN' : 'LIMIT') + ' | G3 risk guard ' + (g3Open ? 'PASS' : 'ACTION'), 120));
                setText('seqOutput', shortText('PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2) + ' | net OPEX ' + fmtUsd(model.netOpex) + ' | carbon ' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr', 120));
                setText('seqFeedback', shortText('Gap engine evaluates target deltas and re-optimizes control/capture coefficients until constraint envelope is met.', 120));
            }

            function mutateInputForParam(input, cfg) {
                var candidate = Object.assign({}, input);
                candidate[cfg.key] = clamp(candidate[cfg.key] + cfg.step, cfg.min, cfg.max);
                if (cfg.key === 'modelYear') candidate[cfg.key] = Math.round(candidate[cfg.key]);
                if (cfg.key === 'supplyTemp') {
                    var baseDeltaT = Math.max(input.returnTemp - input.supplyTemp, 6);
                    candidate.returnTemp = candidate.supplyTemp + baseDeltaT;
                }
                return candidate;
            }

            function renderImpactMatrix(model) {
                var tbody = document.getElementById('impactRows');
                if (!tbody) return;

                var baseInput = model.input;
                var rows = IMPACT_PARAMS.map(function(cfg) {
                    var candidate = mutateInputForParam(baseInput, cfg);
                    var alt = computeModel(candidate);
                    return {
                        key: cfg.key,
                        label: cfg.label,
                        step: '+' + cfg.step + (cfg.unit ? (' ' + cfg.unit) : ''),
                        dpue: alt.pue - model.pue,
                        dcop: alt.systemCop - model.systemCop,
                        dopex: alt.netOpex - model.netOpex,
                        dcarbon: alt.netCarbonTons - model.netCarbonTons,
                        drisk: alt.riskIndex - model.riskIndex
                    };
                });

                tbody.innerHTML = rows.map(function(row) {
                    return '<tr>' +
                        '<td>' + termTooltipSpan(row.label, row.key, 'input') + '</td>' +
                        '<td>' + escapeHtml(row.step) + '</td>' +
                        '<td>' + escapeHtml(signed(row.dpue, 3, '')) + '</td>' +
                        '<td>' + escapeHtml(signed(row.dcop, 2, '')) + '</td>' +
                        '<td>' + escapeHtml(signed(row.dopex, 0, ' USD')) + '</td>' +
                        '<td>' + escapeHtml(signed(row.dcarbon, 0, ' tCO2e')) + '</td>' +
                        '<td>' + escapeHtml(signed(row.drisk, 2, '')) + '</td>' +
                    '</tr>';
                }).join('');
            }

            function percentile(sortedValues, p) {
                if (!sortedValues.length) return 0;
                var idx = (sortedValues.length - 1) * p;
                var lo = Math.floor(idx);
                var hi = Math.ceil(idx);
                if (lo === hi) return sortedValues[lo];
                var w = idx - lo;
                return sortedValues[lo] * (1 - w) + sortedValues[hi] * w;
            }

            function meanArray(values) {
                if (!values || !values.length) return 0;
                var sum = 0;
                for (var i = 0; i < values.length; i++) sum += values[i];
                return sum / values.length;
            }

            function buildHistogram(values, bins) {
                if (!values || !values.length) {
                    return { min: 0, max: 0, counts: [], maxCount: 0 };
                }
                var min = values[0];
                var max = values[values.length - 1];
                var safeMax = max === min ? (max + 1e-9) : max;
                var counts = Array.from({ length: bins }, function() { return 0; });

                values.forEach(function(v) {
                    var idx = Math.floor(((v - min) / (safeMax - min)) * bins);
                    idx = clamp(idx, 0, bins - 1);
                    counts[idx] += 1;
                });

                var maxCount = counts.reduce(function(a, b) { return Math.max(a, b); }, 0);
                return { min: min, max: max, counts: counts, maxCount: Math.max(maxCount, 1) };
            }

            function metricClassForHistogram(key) {
                if (key === 'risk') return 'err';
                if (key === 'carbon') return 'warn';
                return '';
            }

            function renderMonteCarloDistributions() {
                var wrap = document.getElementById('mcDistributionCharts');
                var meta = document.getElementById('mcDistributionMeta');
                if (!wrap || !meta) return;

                if (!latestMonteCarlo || !latestMonteCarlo.dist) {
                    meta.className = 'status-pill';
                    meta.textContent = 'No Distribution Yet';
                    wrap.innerHTML = '<div class="hist-placeholder">Run Monte Carlo to render distribution histograms.</div>';
                    return;
                }

                var dist = latestMonteCarlo.dist;
                var specs = [
                    { key: 'pue', label: 'PUE', digits: 3, suffix: '' },
                    { key: 'cop', label: 'COP', digits: 2, suffix: '' },
                    { key: 'opex', label: 'Net OPEX', digits: 0, suffix: ' USD/yr' },
                    { key: 'carbon', label: 'Carbon', digits: 0, suffix: ' tCO2e/yr' },
                    { key: 'risk', label: 'Risk Index', digits: 1, suffix: '' }
                ];

                wrap.innerHTML = specs.map(function(spec) {
                    var arr = dist[spec.key] || [];
                    if (!arr.length) {
                        return '<div class="hist-card"><div class="hist-placeholder">No values for ' + escapeHtml(spec.label) + '.</div></div>';
                    }
                    var hist = buildHistogram(arr, 14);
                    var p10 = percentile(arr, 0.10);
                    var p50 = percentile(arr, 0.50);
                    var p90 = percentile(arr, 0.90);
                    var avg = meanArray(arr);
                    var barClass = metricClassForHistogram(spec.key);
                    var bars = hist.counts.map(function(c, idx) {
                        var h = Math.max(2, (c / hist.maxCount) * 100);
                        var from = hist.min + ((hist.max - hist.min) * (idx / hist.counts.length));
                        var to = hist.min + ((hist.max - hist.min) * ((idx + 1) / hist.counts.length));
                        var title = spec.label + ' bin ' + fmtNum(from, spec.digits) + ' to ' + fmtNum(to, spec.digits) + ' | n=' + c;
                        return '<div class="hist-bar ' + barClass + '" style="height:' + fmtNum(h, 1) + '%" title="' + escapeAttr(title) + '"></div>';
                    }).join('');

                    return '<div class="hist-card">' +
                        '<div class="hist-head">' +
                            '<span class="hist-title">' + escapeHtml(spec.label) + '</span>' +
                            '<span class="hist-range">' + fmtNum(hist.min, spec.digits) + ' - ' + fmtNum(hist.max, spec.digits) + '</span>' +
                        '</div>' +
                        '<div class="hist-bars">' + bars + '</div>' +
                        '<div class="hist-footer">' +
                            'P10 ' + fmtNum(p10, spec.digits) + ' | P50 ' + fmtNum(p50, spec.digits) + ' | P90 ' + fmtNum(p90, spec.digits) + '<br>' +
                            'mean ' + fmtNum(avg, spec.digits) + spec.suffix +
                        '</div>' +
                    '</div>';
                }).join('');

                meta.className = 'status-pill ok';
                meta.textContent = 'n=' + latestMonteCarlo.samples + ' | \u00b1' + fmtNum(latestMonteCarlo.unc * 100, 0) + '% input band';
            }

            function riskColor(risk) {
                if (risk <= 25) return '#047857';
                if (risk <= 40) return '#b45309';
                return '#b91c1c';
            }

            function syncParetoRowSelection() {
                var rows = document.querySelectorAll('#paretoRows tr[data-pareto-idx]');
                rows.forEach(function(row) {
                    var idx = parseInt(row.getAttribute('data-pareto-idx'), 10);
                    row.classList.toggle('selected', idx === selectedParetoIdx);
                });
            }

            function renderParetoScatter() {
                var svg = document.getElementById('paretoScatterSvg');
                var meta = document.getElementById('paretoScatterMeta');
                if (!svg || !meta) return;

                if (!latestPareto.length) {
                    svg.innerHTML = '<text x="18" y="26" fill="currentColor" opacity="0.7" font-size="12">Generate Pareto frontier to render scatter chart.</text>';
                    meta.className = 'status-pill';
                    meta.textContent = 'No Pareto Points';
                    syncParetoRowSelection();
                    return;
                }

                var w = 620;
                var h = 300;
                var pad = { l: 88, r: 22, t: 46, b: 46 };
                var pw = w - pad.l - pad.r;
                var ph = h - pad.t - pad.b;

                var pueVals = latestPareto.map(function(m) { return m.pue; });
                var opexVals = latestPareto.map(function(m) { return m.netOpex; });
                var carbonVals = latestPareto.map(function(m) { return m.netCarbonTons; });
                var sortedByPue = latestPareto.map(function(m, idx) { return { m: m, idx: idx }; }).sort(function(a, b) { return a.m.pue - b.m.pue; });

                var minPue = Math.min.apply(null, pueVals);
                var maxPue = Math.max.apply(null, pueVals);
                var minOpex = Math.min.apply(null, opexVals);
                var maxOpex = Math.max.apply(null, opexVals);
                if (maxPue === minPue) maxPue = minPue + 0.001;
                if (maxOpex === minOpex) maxOpex = minOpex + 1;
                var puePad = (maxPue - minPue) * 0.08;
                var opexPad = (maxOpex - minOpex) * 0.08;
                minPue -= puePad;
                maxPue += puePad;
                minOpex = Math.max(0, minOpex - opexPad);
                maxOpex += opexPad;

                function sx(v) { return pad.l + ((v - minPue) / (maxPue - minPue)) * pw; }
                function sy(v) { return pad.t + ((v - minOpex) / (maxOpex - minOpex)) * ph; }

                var minCarbon = Math.min.apply(null, carbonVals);
                var maxCarbon = Math.max.apply(null, carbonVals);
                if (maxCarbon === minCarbon) maxCarbon = minCarbon + 1;

                var grid = [];
                for (var i = 0; i <= 5; i++) {
                    var gx = pad.l + (pw * i / 5);
                    var gy = pad.t + (ph * i / 5);
                    var pueTick = minPue + (maxPue - minPue) * (i / 5);
                    var opexTick = minOpex + (maxOpex - minOpex) * (i / 5);
                    grid.push('<line x1="' + fmtNum(gx, 2) + '" y1="' + pad.t + '" x2="' + fmtNum(gx, 2) + '" y2="' + (pad.t + ph) + '" stroke="rgba(148,163,184,0.18)" stroke-width="1"/>');
                    grid.push('<line x1="' + pad.l + '" y1="' + fmtNum(gy, 2) + '" x2="' + (pad.l + pw) + '" y2="' + fmtNum(gy, 2) + '" stroke="rgba(148,163,184,0.18)" stroke-width="1"/>');
                    grid.push('<text x="' + fmtNum(gx, 2) + '" y="' + (h - 12) + '" fill="currentColor" opacity="0.76" font-size="10" text-anchor="middle">' + fmtNum(pueTick, 3) + '</text>');
                    grid.push('<text x="8" y="' + fmtNum(gy + 3, 2) + '" fill="currentColor" opacity="0.76" font-size="10">' + fmtUsdCompact(opexTick) + '</text>');
                }

                var frontierPath = '';
                sortedByPue.forEach(function(item, idx) {
                    var x = sx(item.m.pue);
                    var y = sy(item.m.netOpex);
                    frontierPath += (idx === 0 ? 'M ' : ' L ') + fmtNum(x, 2) + ' ' + fmtNum(y, 2);
                });

                var points = latestPareto.map(function(m, idx) {
                    var x = sx(m.pue);
                    var y = sy(m.netOpex);
                    var r = 4 + (((m.netCarbonTons - minCarbon) / (maxCarbon - minCarbon)) * 3.5);
                    var stroke = m._feasible ? '#065f46' : '#9a3412';
                    var strokeDash = m._feasible ? '' : ' stroke-dasharray="3 2"';
                    var selected = idx === selectedParetoIdx;
                    var outer = selected ? '<circle cx="' + fmtNum(x, 2) + '" cy="' + fmtNum(y, 2) + '" r="' + fmtNum(r + 4, 2) + '" fill="none" stroke="#2563eb" stroke-width="1.6" stroke-dasharray="2 2"></circle>' : '';
                    var title = 'P' + (idx + 1) + ' | PUE ' + fmtNum(m.pue, 3) + ' | COP ' + fmtNum(m.systemCop, 2) + ' | OPEX ' + fmtUsd(m.netOpex) + ' | Carbon ' + fmtNum(m.netCarbonTons, 0) + ' | Risk ' + fmtNum(m.riskIndex, 1);
                    return '' +
                        outer +
                        '<circle cx="' + fmtNum(x, 2) + '" cy="' + fmtNum(y, 2) + '" r="' + fmtNum(r, 2) + '" fill="' + riskColor(m.riskIndex) + '" fill-opacity="0.88" stroke="' + stroke + '" stroke-width="1.35"' + strokeDash + ' data-pidx="' + idx + '">' +
                            '<title>' + escapeHtml(title) + '</title>' +
                        '</circle>' +
                        '<text x="' + fmtNum(x + r + 2, 2) + '" y="' + fmtNum(y - 2, 2) + '" font-size="9" fill="currentColor" opacity="0.82">P' + (idx + 1) + '</text>';
                }).join('');

                svg.innerHTML = [
                    '<defs><linearGradient id="paretoBg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="rgba(59,130,246,0.06)"/><stop offset="100%" stop-color="rgba(16,185,129,0.04)"/></linearGradient></defs>',
                    '<rect x="' + pad.l + '" y="' + pad.t + '" width="' + pw + '" height="' + ph + '" fill="url(#paretoBg)" stroke="rgba(148,163,184,0.34)" rx="8" />',
                    grid.join(''),
                    frontierPath ? '<path d="' + frontierPath + '" fill="none" stroke="rgba(30,64,175,0.5)" stroke-width="1.6" stroke-dasharray="4 3"></path>' : '',
                    points,
                    '<text x="' + (pad.l + (pw / 2)) + '" y="' + (h - 6) + '" fill="currentColor" opacity="0.82" font-size="11" text-anchor="middle">PUE (lower is better)</text>',
                    '<text x="14" y="' + (pad.t - 20) + '" fill="currentColor" opacity="0.82" font-size="11">Net OPEX (lower is better)</text>',
                    '<rect x="' + (w - 214) + '" y="12" width="196" height="70" rx="8" fill="rgba(255,255,255,0.76)" stroke="rgba(148,163,184,0.4)"></rect>',
                    '<text x="' + (w - 204) + '" y="28" fill="currentColor" opacity="0.85" font-size="10">Legend</text>',
                    '<circle cx="' + (w - 198) + '" cy="42" r="4.5" fill="#047857"></circle><text x="' + (w - 188) + '" y="45" fill="currentColor" font-size="10">Risk low</text>',
                    '<circle cx="' + (w - 132) + '" cy="42" r="4.5" fill="#b45309"></circle><text x="' + (w - 122) + '" y="45" fill="currentColor" font-size="10">Risk medium</text>',
                    '<circle cx="' + (w - 52) + '" cy="42" r="4.5" fill="#b91c1c"></circle><text x="' + (w - 42) + '" y="45" fill="currentColor" font-size="10">Risk high</text>',
                    '<circle cx="' + (w - 198) + '" cy="60" r="4.5" fill="#64748b" stroke="#9a3412" stroke-width="1.2" stroke-dasharray="3 2"></circle>',
                    '<text x="' + (w - 188) + '" y="63" fill="currentColor" font-size="10">Soft constraint point</text>',
                    '<text x="' + (w - 198) + '" y="76" fill="currentColor" opacity="0.75" font-size="9">Circle size = carbon burden</text>'
                ].join('');

                var feasibleCount = latestPareto.filter(function(m) { return m._feasible; }).length;
                meta.className = 'status-pill ok';
                meta.textContent = 'points=' + latestPareto.length + ' | feasible=' + feasibleCount + ' | click point/row to select';
                syncParetoRowSelection();
            }

            function sankeyBandPath(x0, y0, x1, y1, width) {
                var w = Math.max(width, 1);
                var c = (x1 - x0) * 0.46;
                var y0t = y0 - (w / 2);
                var y0b = y0 + (w / 2);
                var y1t = y1 - (w / 2);
                var y1b = y1 + (w / 2);
                return [
                    'M', fmtNum(x0, 2), fmtNum(y0t, 2),
                    'C', fmtNum(x0 + c, 2), fmtNum(y0t, 2), fmtNum(x1 - c, 2), fmtNum(y1t, 2), fmtNum(x1, 2), fmtNum(y1t, 2),
                    'L', fmtNum(x1, 2), fmtNum(y1b, 2),
                    'C', fmtNum(x1 - c, 2), fmtNum(y1b, 2), fmtNum(x0 + c, 2), fmtNum(y0b, 2), fmtNum(x0, 2), fmtNum(y0b, 2),
                    'Z'
                ].join(' ');
            }

            function renderEnergySankey(model) {
                var svg = document.getElementById('energySankeySvg');
                var status = document.getElementById('sankeyStatus');
                var summary = document.getElementById('sankeySummary');
                if (!svg || !status || !summary) return;

                var modeEl = document.getElementById('sankeyMode');
                var viewMode = modeEl ? modeEl.value : 'auto';
                var activeModel = model || optimizedModel || baselineModel;
                var baseModel = baselineModel || activeModel;
                var optModel = optimizedModel || null;
                if (viewMode === 'baseline') activeModel = baseModel;
                else if (viewMode === 'optimized') activeModel = optModel || baseModel;
                else if (viewMode === 'auto') activeModel = optModel || baseModel;

                if (viewMode === 'compare' && (!baseModel || !optModel)) {
                    viewMode = 'baseline';
                    activeModel = baseModel || optModel || activeModel;
                }

                if (!activeModel && viewMode !== 'compare') {
                    svg.innerHTML = '<text x="18" y="28" fill="currentColor" opacity="0.7" font-size="12">Run model to render Sankey distribution.</text>';
                    status.className = 'status-pill';
                    status.textContent = 'Waiting Model State';
                    summary.textContent = 'Sankey summary will appear after model execution.';
                    return;
                }

                if (viewMode === 'compare' && baseModel && optModel) {
                    var b = extractSankeyFlows(baseModel);
                    var o = extractSankeyFlows(optModel);
                    var maxTotal = Math.max(b.total, o.total, 1);
                    function laneSvg(label, y, flows, colorA) {
                        var barX = 138;
                        var barW = 250;
                        var subX = 500;
                        var subW = 250;
                        var partA = [
                            { key: 'it', color: '#2563eb', label: 'IT' },
                            { key: 'thermal', color: '#0891b2', label: 'Thermal' },
                            { key: 'elecLoss', color: '#d97706', label: 'Elec Loss' },
                            { key: 'facilityAux', color: '#64748b', label: 'Aux' }
                        ];
                        var partB = [
                            { key: 'liquidCore', color: '#0d9488', label: 'Liquid' },
                            { key: 'pump', color: '#7c3aed', label: 'Pump' },
                            { key: 'air', color: '#0284c7', label: 'Air' },
                            { key: 'fan', color: '#16a34a', label: 'Fan' }
                        ];
                        var html = [];
                        html.push('<text x="26" y="' + (y + 5) + '" fill="currentColor" font-size="11">' + escapeHtml(label) + '</text>');
                        html.push('<text x="26" y="' + (y + 20) + '" fill="currentColor" opacity="0.72" font-size="10">' + fmtNum(flows.total / 1000, 2) + ' MW total</text>');
                        html.push('<rect x="' + barX + '" y="' + (y - 10) + '" width="' + barW + '" height="16" rx="5" fill="rgba(148,163,184,0.12)" stroke="rgba(148,163,184,0.32)"/>');
                        html.push('<rect x="' + subX + '" y="' + (y - 10) + '" width="' + subW + '" height="16" rx="5" fill="rgba(148,163,184,0.12)" stroke="rgba(148,163,184,0.32)"/>');
                        var x = barX;
                        partA.forEach(function(p) {
                            var sw = Math.max(2, (flows[p.key] / maxTotal) * barW);
                            html.push('<rect x="' + fmtNum(x, 2) + '" y="' + (y - 10) + '" width="' + fmtNum(sw, 2) + '" height="16" fill="' + p.color + '"/>');
                            x += sw;
                        });
                        var sx = subX;
                        partB.forEach(function(p) {
                            var sw = Math.max(2, (flows[p.key] / maxTotal) * subW);
                            html.push('<rect x="' + fmtNum(sx, 2) + '" y="' + (y - 10) + '" width="' + fmtNum(sw, 2) + '" height="16" fill="' + p.color + '"/>');
                            sx += sw;
                        });
                        html.push('<text x="' + barX + '" y="' + (y + 22) + '" fill="currentColor" opacity="0.74" font-size="9">Primary mix: IT ' + sankeyPct(flows.it, flows.total) + ', Thermal ' + sankeyPct(flows.thermal, flows.total) + ', Loss ' + sankeyPct(flows.elecLoss, flows.total) + ', Aux ' + sankeyPct(flows.facilityAux, flows.total) + '</text>');
                        html.push('<text x="' + subX + '" y="' + (y + 22) + '" fill="currentColor" opacity="0.74" font-size="9">Thermal split: LQ ' + sankeyPct(flows.liquidCore, flows.total) + ', Pump ' + sankeyPct(flows.pump, flows.total) + ', Air ' + sankeyPct(flows.air, flows.total) + ', Fan ' + sankeyPct(flows.fan, flows.total) + '</text>');
                        return html.join('');
                    }

                    var nonItDelta = (o.total - o.it) - (b.total - b.it);
                    svg.innerHTML = [
                        '<rect x="0" y="0" width="860" height="360" fill="transparent"/>',
                        '<text x="24" y="30" fill="currentColor" opacity="0.86" font-size="12">COMPARE DELTA VIEW (Baseline vs Optimized)</text>',
                        laneSvg('Baseline', 96, b, '#1d4ed8'),
                        laneSvg('Optimized', 206, o, '#0f766e'),
                        '<line x1="24" y1="150" x2="836" y2="150" stroke="rgba(148,163,184,0.28)" stroke-dasharray="3 3"/>',
                        '<text x="24" y="326" fill="currentColor" opacity="0.78" font-size="10">Delta non-IT overhead: ' + signed(nonItDelta, 0, ' kW') + ' | Delta PUE ' + signed(optModel.pue - baseModel.pue, 3, '') + ' | Delta COP ' + signed(optModel.systemCop - baseModel.systemCop, 2, '') + '</text>'
                    ].join('');

                    status.className = 'status-pill ok';
                    status.textContent = 'Sankey Compare | baseline vs optimized';
                    summary.textContent = [
                        'Baseline total: ' + fmtNum(b.total, 0) + ' kW | Optimized total: ' + fmtNum(o.total, 0) + ' kW',
                        'Non-IT overhead baseline: ' + fmtNum(b.total - b.it, 0) + ' kW | optimized: ' + fmtNum(o.total - o.it, 0) + ' kW | delta ' + signed(nonItDelta, 0, ' kW'),
                        'This compare view prioritizes distribution readability and delta visibility for non-IT components.'
                    ].join('\n');
                    return;
                }

                var flows = extractSankeyFlows(activeModel);
                var total = flows ? flows.total : 0;

                if (total <= 0.1) {
                    svg.innerHTML = '<text x="18" y="28" fill="currentColor" opacity="0.7" font-size="12">Invalid model output for Sankey rendering.</text>';
                    status.className = 'status-pill warn';
                    status.textContent = 'Sankey Render Failed';
                    summary.textContent = 'Total facility load is too small for Sankey flow normalization.';
                    return;
                }

                var scale = 176 / total;
                var nodeW = 20;
                var srcX = 52;
                var midX = 332;
                var rightX = 610;
                var topY = 62;
                var source = { id: 'source', label: 'Total Facility Input', value: total, x: srcX, y: topY, h: 232, color: '#1d4ed8' };
                var midNodes = [
                    { id: 'compute', label: 'IT Compute', value: flows.it, x: midX, y: 84, h: 42, color: '#2563eb' },
                    { id: 'thermal', label: 'Thermal Management', value: flows.thermal, x: midX, y: 156, h: 44, color: '#0891b2' },
                    { id: 'elec', label: 'Electrical Loss', value: flows.elecLoss, x: midX, y: 232, h: 30, color: '#d97706' },
                    { id: 'aux', label: 'Facility Aux', value: flows.facilityAux, x: midX, y: 278, h: 24, color: '#64748b' }
                ];
                var thermalNode = midNodes[1];
                var rightNodes = [
                    { id: 'liq', label: 'Liquid Loop', value: flows.liquidCore, x: rightX, y: 150, h: 30, color: '#0d9488' },
                    { id: 'pump', label: 'Pump Drive', value: flows.pump, x: rightX, y: 198, h: 20, color: '#7c3aed' },
                    { id: 'air', label: 'Air Path', value: flows.air, x: rightX, y: 234, h: 20, color: '#0284c7' },
                    { id: 'fan', label: 'Fan Power', value: flows.fan, x: rightX, y: 270, h: 20, color: '#16a34a' }
                ];

                var links = [];
                function linkWidth(v) {
                    return clamp(v * scale, 3, 146);
                }
                var srcOffset = 0;
                midNodes.forEach(function(t) {
                    var h = linkWidth(t.value);
                    links.push({
                        x0: source.x + nodeW,
                        y0: source.y + 10 + srcOffset + (h / 2),
                        x1: t.x,
                        y1: t.y + (h / 2),
                        w: h,
                        color: t.color,
                        value: t.value
                    });
                    srcOffset += h + 1.5;
                });

                var thermOffset = 0;
                rightNodes.forEach(function(t) {
                    var h = linkWidth(t.value);
                    links.push({
                        x0: thermalNode.x + nodeW,
                        y0: thermalNode.y + 6 + thermOffset + (h / 2),
                        x1: t.x,
                        y1: t.y + (h / 2),
                        w: h,
                        color: t.color,
                        value: t.value
                    });
                    thermOffset += h + 1.2;
                });

                function nodeSvg(n) {
                    return '<rect x="' + n.x + '" y="' + fmtNum(n.y, 2) + '" width="' + nodeW + '" height="' + fmtNum(n.h, 2) + '" rx="5" fill="' + n.color + '" fill-opacity="0.9" stroke="rgba(15,23,42,0.35)" />' +
                        '<text x="' + (n.x + nodeW + 8) + '" y="' + fmtNum(n.y + 12, 2) + '" fill="currentColor" font-size="11">' + escapeHtml(n.label) + '</text>' +
                        '<text x="' + (n.x + nodeW + 8) + '" y="' + fmtNum(n.y + 24, 2) + '" fill="currentColor" opacity="0.78" font-size="10">' + fmtNum(n.value, 0) + ' kW | ' + sankeyPct(n.value, total) + '</text>';
                }

                var linksSvg = links.map(function(l) {
                    var title = fmtNum(l.value, 0) + ' kW';
                    return '<path d="' + sankeyBandPath(l.x0, l.y0, l.x1, l.y1, l.w) + '" fill="' + l.color + '" fill-opacity="0.46" stroke="' + l.color + '" stroke-opacity="0.62" stroke-width="0.7"><title>' + escapeHtml(title) + '</title></path>';
                }).join('');

                svg.innerHTML = [
                    '<rect x="0" y="0" width="860" height="360" fill="transparent"/>',
                    '<text x="52" y="30" fill="currentColor" opacity="0.84" font-size="12">SOURCE</text>',
                    '<text x="332" y="30" fill="currentColor" opacity="0.84" font-size="12">PRIMARY DISTRIBUTION</text>',
                    '<text x="610" y="30" fill="currentColor" opacity="0.84" font-size="12">THERMAL BREAKDOWN</text>',
                    linksSvg,
                    nodeSvg(source),
                    midNodes.map(nodeSvg).join(''),
                    rightNodes.map(nodeSvg).join(''),
                    '<rect x="606" y="86" width="230" height="218" fill="none" stroke="rgba(148,163,184,0.16)" stroke-dasharray="2 3" rx="8"/>',
                    '<text x="52" y="346" fill="currentColor" opacity="0.74" font-size="10">Flow width is proportional to power contribution. Labels are fixed-position to keep small branches readable.</text>'
                ].join('');

                var nonIt = flows.total - flows.it;
                var modeLabel = viewMode === 'auto' ? (optModel ? 'optimized' : 'baseline') : viewMode;
                status.className = 'status-pill ok';
                status.textContent = 'Sankey Live | ' + modeLabel + ' | total ' + fmtNum(total / 1000, 2) + ' MW';
                summary.textContent = [
                    'Total facility power: ' + fmtNum(total, 0) + ' kW (' + fmtNum(total / 1000, 2) + ' MW)',
                    'Non-IT overhead total: ' + fmtNum(nonIt, 0) + ' kW (' + sankeyPct(nonIt, total) + ') | IT compute: ' + fmtNum(flows.it, 0) + ' kW (' + sankeyPct(flows.it, total) + ')',
                    'Thermal split: liquid loop ' + sankeyPct(flows.liquidCore, total) + ', pump drive ' + sankeyPct(flows.pump, total) + ', air path ' + sankeyPct(flows.air, total) + ', fan power ' + sankeyPct(flows.fan, total) + '.'
                ].join('\n');
            }

            function runMonteCarlo() {
                var samples = Math.max(200, Math.round(n('mcSamples')));
                var unc = clamp(n('mcUncertainty'), 1, 30) / 100;
                var base = gatherInputs();
                var keys = ['itLoadMw', 'liquidCapture', 'supplyTemp', 'airCop', 'pumpEff', 'economizerHours', 'controlQuality', 'predictiveGain', 'coefHeatTransfer', 'coefPipeLoss', 'elecPrice', 'carbonIntensity'];
                var dist = { pue: [], cop: [], opex: [], carbon: [], risk: [] };

                for (var i = 0; i < samples; i++) {
                    var c = Object.assign({}, base);
                    keys.forEach(function(k) {
                        var v = c[k];
                        if (typeof v !== 'number') return;
                        var delta = (Math.random() * 2 - 1) * unc;
                        c[k] = v * (1 + delta);
                    });
                    c.returnTemp = clamp(c.supplyTemp + Math.max(base.returnTemp - base.supplyTemp, 6), c.supplyTemp + 5, c.supplyTemp + 18);
                    var m = computeModel(c);
                    dist.pue.push(m.pue);
                    dist.cop.push(m.systemCop);
                    dist.opex.push(m.netOpex);
                    dist.carbon.push(m.netCarbonTons);
                    dist.risk.push(m.riskIndex);
                }

                Object.keys(dist).forEach(function(k) { dist[k].sort(function(a, b) { return a - b; }); });

                var rows = [
                    ['PUE', percentile(dist.pue, 0.10), percentile(dist.pue, 0.50), percentile(dist.pue, 0.90), 3, ''],
                    ['COP', percentile(dist.cop, 0.10), percentile(dist.cop, 0.50), percentile(dist.cop, 0.90), 2, ''],
                    ['Net OPEX (USD/yr)', percentile(dist.opex, 0.10), percentile(dist.opex, 0.50), percentile(dist.opex, 0.90), 0, ' USD'],
                    ['Carbon (tCO2e/yr)', percentile(dist.carbon, 0.10), percentile(dist.carbon, 0.50), percentile(dist.carbon, 0.90), 0, ''],
                    ['Risk Index', percentile(dist.risk, 0.10), percentile(dist.risk, 0.50), percentile(dist.risk, 0.90), 1, '']
                ];

                var tbody = document.getElementById('mcRows');
                if (tbody) {
                    tbody.innerHTML = rows.map(function(r) {
                        return '<tr><td>' + r[0] + '</td><td>' + fmtNum(r[1], r[4]) + r[5] + '</td><td>' + fmtNum(r[2], r[4]) + r[5] + '</td><td>' + fmtNum(r[3], r[4]) + r[5] + '</td></tr>';
                    }).join('');
                }
                var stat = document.getElementById('mcStatus');
                if (stat) {
                    stat.className = 'status-pill ok';
                    stat.textContent = 'MC Complete | n=' + samples + ' | uncertainty ' + fmtNum(unc * 100, 0) + '%';
                }
                latestMonteCarlo = { samples: samples, unc: unc, dist: dist };
                renderMonteCarloDistributions();
            }

            function buildRandomCandidate(base, scale) {
                var c = Object.assign({}, base);
                c.liquidCapture = randomInRange(Math.max(30, base.liquidCapture - 28 * scale), Math.min(99, base.liquidCapture + 22 * scale), 1);
                c.rackDensityTarget = randomInRange(Math.max(8, base.rackDensityTarget - 18 * scale), Math.min(180, base.rackDensityTarget + 22 * scale), 1);
                c.highDensityShare = randomInRange(Math.max(0, base.highDensityShare - 35 * scale), Math.min(100, base.highDensityShare + 30 * scale), 1);
                c.supplyTemp = randomInRange(Math.max(19, base.supplyTemp - 5 * scale), Math.min(40, base.supplyTemp + 7 * scale), 0.5);
                c.airCop = randomInRange(Math.max(1.8, base.airCop - 2.4 * scale), Math.min(12, base.airCop + 2.8 * scale), 0.1);
                c.pumpEff = randomInRange(Math.max(50, base.pumpEff - 12 * scale), Math.min(95, base.pumpEff + 10 * scale), 1);
                c.controlQuality = randomInRange(Math.max(20, base.controlQuality - 26 * scale), Math.min(100, base.controlQuality + 18 * scale), 1);
                c.predictiveGain = randomInRange(Math.max(0, base.predictiveGain - 22 * scale), Math.min(60, base.predictiveGain + 20 * scale), 1);
                c.coefHeatTransfer = randomInRange(Math.max(68, base.coefHeatTransfer - 12 * scale), Math.min(99, base.coefHeatTransfer + 8 * scale), 0.5);
                c.coefPipeLoss = randomInRange(Math.max(0.75, base.coefPipeLoss - 0.22 * scale), Math.min(1.8, base.coefPipeLoss + 0.3 * scale), 0.01);
                c.coefCduLoss = randomInRange(Math.max(0.5, base.coefCduLoss - 0.95 * scale), Math.min(4.5, base.coefCduLoss + 1.05 * scale), 0.05);
                c.returnTemp = clamp(c.supplyTemp + randomInRange(6, 14, 0.5), c.supplyTemp + 5.5, c.supplyTemp + 16);
                return c;
            }

            function isDominated(a, b) {
                var noWorse = (b.pue <= a.pue) && (b.netOpex <= a.netOpex) && (b.netCarbonTons <= a.netCarbonTons) && (b.riskIndex <= a.riskIndex);
                var strictlyBetter = (b.pue < a.pue) || (b.netOpex < a.netOpex) || (b.netCarbonTons < a.netCarbonTons) || (b.riskIndex < a.riskIndex);
                return noWorse && strictlyBetter;
            }

            function runParetoFrontier() {
                var samples = Math.max(200, Math.round(n('paretoSamples')));
                var base = gatherInputs();
                var constraints = gatherConstraintState();
                var pool = [];

                for (var i = 0; i < samples; i++) {
                    var c = buildRandomCandidate(base, 1 + (i % 5) * 0.18);
                    var m = computeModel(c);
                    var hard = evaluateHardConstraints(m, constraints);
                    m._feasible = hard.feasible;
                    pool.push(m);
                }

                var nondominated = [];
                for (var j = 0; j < pool.length; j++) {
                    var dominated = false;
                    for (var k = 0; k < pool.length; k++) {
                        if (j === k) continue;
                        if (isDominated(pool[j], pool[k])) { dominated = true; break; }
                    }
                    if (!dominated) nondominated.push(pool[j]);
                }

                nondominated.sort(function(a, b) {
                    return optimizeObjective(a, base, constraints) - optimizeObjective(b, base, constraints);
                });

                latestPareto = nondominated.slice(0, 24);
                selectedParetoIdx = -1;
                var tbody = document.getElementById('paretoRows');
                if (tbody) {
                    if (!latestPareto.length) {
                        tbody.innerHTML = '<tr><td colspan="6">No frontier points generated.</td></tr>';
                    } else {
                        tbody.innerHTML = latestPareto.map(function(m, idx) {
                            return '<tr class="clickable" data-pareto-idx="' + idx + '">' +
                                '<td>P' + (idx + 1) + (m._feasible ? ' | feasible' : ' | soft') + '</td>' +
                                '<td>' + fmtNum(m.pue, 3) + '</td>' +
                                '<td>' + fmtNum(m.systemCop, 2) + '</td>' +
                                '<td>' + fmtUsd(m.netOpex) + '</td>' +
                                '<td>' + fmtNum(m.netCarbonTons, 0) + '</td>' +
                                '<td>' + fmtNum(m.riskIndex, 1) + '</td>' +
                            '</tr>';
                        }).join('');
                    }
                }

                var stat = document.getElementById('paretoStatus');
                if (stat) {
                    stat.className = latestPareto.length ? 'status-pill ok' : 'status-pill warn';
                    stat.textContent = latestPareto.length ? ('Frontier Ready | points=' + latestPareto.length) : 'Frontier Empty';
                }
                renderParetoScatter();
            }

            function applyParetoPoint(idx) {
                var m = latestPareto[idx];
                if (!m) return;
                selectedParetoIdx = idx;
                applyInputObjectToForm(m.input);
                optimizedModel = m;
                baselineModel = computeModel(gatherInputs());
                applyModelToUI(m);
                renderScenarioTable(baselineModel, m);
                renderTargetActions(baselineModel, m);
            }

            function renderCalibrationQuality() {
                var status = document.getElementById('calQualityStatus');
                var summary = document.getElementById('calQualitySummary');
                var rows = document.getElementById('calQualityRows');
                if (!status || !summary || !rows) return;

                if (!calibrationState || !calibrationState.quality) {
                    status.className = 'status-pill';
                    status.textContent = 'No Calibration Quality Data';
                    summary.textContent = 'Calibration quality pending. Run calibration to evaluate fit quality.';
                    rows.innerHTML = '<tr><td colspan="4">No residual diagnostics yet.</td></tr>';
                    return;
                }

                var q = calibrationState.quality;
                status.className = q.valErr <= 8 ? 'status-pill ok' : 'status-pill warn';
                status.textContent = 'Train ' + fmtNum(q.trainErr, 2) + '% | Val ' + fmtNum(q.valErr, 2) + '% | 95%CI ' + fmtNum(q.ci95, 2) + '%';
                summary.textContent = 'Residual mean ' + fmtNum(q.meanResidual, 2) + '% | std ' + fmtNum(q.stdResidual, 2) + '% | metrics ' + q.residuals.length + '.';
                rows.innerHTML = q.residuals.map(function(r) {
                    return '<tr><td>' + escapeHtml(r.metric) + '</td><td>' + escapeHtml(r.target) + '</td><td>' + escapeHtml(r.pred) + '</td><td>' + escapeHtml(r.residualPct) + '%</td></tr>';
                }).join('');
            }

            function computeCalibrationQuality(model, targets) {
                var metrics = [
                    { k: 'pue', label: 'PUE', pred: model.pue, target: targets.pue },
                    { k: 'cop', label: 'System COP', pred: model.systemCop, target: targets.cop },
                    { k: 'energy', label: 'Annual Energy (GWh)', pred: model.annualGwh, target: targets.energyGwh },
                    { k: 'opex', label: 'Net OPEX (USD/yr)', pred: model.netOpex, target: targets.netOpex },
                    { k: 'carbon', label: 'Net Carbon (tCO2e)', pred: model.netCarbonTons, target: targets.carbon },
                    { k: 'pump', label: 'Pump Power (kW)', pred: model.pumpPowerKw, target: targets.pumpKw }
                ].filter(function(m) { return m.target !== null && m.target !== undefined; });

                var residuals = metrics.map(function(m) {
                    var rel = ((m.pred - m.target) / Math.max(Math.abs(m.target), 1)) * 100;
                    return {
                        metric: m.label,
                        target: fmtNum(m.target, Math.abs(m.target) > 1000 ? 0 : 3),
                        pred: fmtNum(m.pred, Math.abs(m.pred) > 1000 ? 0 : 3),
                        residualPct: fmtNum(rel, 2),
                        absResidual: Math.abs(rel)
                    };
                });

                var train = [];
                var val = [];
                residuals.forEach(function(r, idx) {
                    if (idx % 2 === 0) train.push(r.absResidual);
                    else val.push(r.absResidual);
                });
                if (!val.length) val = train.slice();

                function mean(arr) {
                    if (!arr.length) return 0;
                    return arr.reduce(function(a, b) { return a + b; }, 0) / arr.length;
                }

                function std(arr) {
                    if (arr.length < 2) return 0;
                    var m = mean(arr);
                    var v = arr.reduce(function(a, b) { return a + Math.pow(b - m, 2); }, 0) / (arr.length - 1);
                    return Math.sqrt(v);
                }

                var all = residuals.map(function(r) { return r.absResidual; });
                var meanResidual = mean(all);
                var stdResidual = std(all);
                var ci95 = all.length ? (1.96 * stdResidual / Math.sqrt(all.length)) : 0;

                return {
                    trainErr: mean(train),
                    valErr: mean(val),
                    meanResidual: meanResidual,
                    stdResidual: stdResidual,
                    ci95: ci95,
                    residuals: residuals
                };
            }

            function setRuleStatus(text, cls) {
                var el = document.getElementById('ruleStatus');
                if (!el) return;
                el.className = 'status-pill' + (cls ? (' ' + cls) : '');
                el.textContent = text;
            }

            function applyRuleSetFromEditor() {
                var g1 = document.getElementById('ruleG1').value;
                var g2 = document.getElementById('ruleG2').value;
                var g3 = document.getElementById('ruleG3').value;
                var trial = { g1: g1, g2: g2, g3: g3 };
                var ctx = baselineModel ? buildRuleContext(baselineModel) : buildRuleContext(computeModel(gatherInputs()));
                var checks = [evaluateRuleExpression(trial.g1, ctx), evaluateRuleExpression(trial.g2, ctx), evaluateRuleExpression(trial.g3, ctx)];
                var bad = checks.filter(function(c) { return !c.ok; });
                if (bad.length) {
                    setRuleStatus('Rule error: ' + bad[0].error, 'err');
                    return;
                }
                gateRules = trial;
                setRuleStatus('Rule Set: Custom Applied', 'ok');
                runModel(false);
            }

            function resetRuleSetToDefault() {
                gateRules = Object.assign({}, DEFAULT_GATE_RULES);
                document.getElementById('ruleG1').value = gateRules.g1;
                document.getElementById('ruleG2').value = gateRules.g2;
                document.getElementById('ruleG3').value = gateRules.g3;
                setRuleStatus('Rule Set: Default', '');
                runModel(false);
            }

            function saveScenarioSnapshot() {
                var name = String(document.getElementById('scenarioName').value || '').trim();
                if (!name) {
                    alert('Please enter a scenario name.');
                    return;
                }
                var model = baselineModel || computeModel(gatherInputs());
                var version = scenarioSnapshots.length ? (Math.max.apply(null, scenarioSnapshots.map(function(s) { return s.version; })) + 1) : 1;
                scenarioSnapshots.push({
                    name: name,
                    version: version,
                    ts: nowIso(),
                    input: Object.assign({}, model.input),
                    model: {
                        pue: model.pue,
                        systemCop: model.systemCop,
                        netOpex: model.netOpex,
                        netCarbonTons: model.netCarbonTons,
                        riskIndex: model.riskIndex
                    }
                });
                persistScenarios();
                renderScenarioList();
                document.getElementById('scenarioName').value = '';
            }

            function loadSelectedScenario() {
                var sel = document.getElementById('scenarioSelect');
                if (!sel) return;
                var idx = parseInt(sel.value, 10);
                if (!isFinite(idx) || !scenarioSnapshots[idx]) return;
                var prev = selectedScenarioIdx >= 0 ? scenarioSnapshots[selectedScenarioIdx] : null;
                selectedScenarioIdx = idx;
                var current = scenarioSnapshots[idx];
                applyInputObjectToForm(current.input);
                runModel(true);
                renderScenarioDiff(current, prev);
            }

            function deleteSelectedScenario() {
                var sel = document.getElementById('scenarioSelect');
                if (!sel) return;
                var idx = parseInt(sel.value, 10);
                if (!isFinite(idx) || !scenarioSnapshots[idx]) return;
                scenarioSnapshots.splice(idx, 1);
                persistScenarios();
                renderScenarioList();
                selectedScenarioIdx = -1;
                renderScenarioDiff(null, null);
            }

            function downloadTextFile(name, text) {
                var blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(function() { URL.revokeObjectURL(url); }, 600);
            }

            function buildExecutivePack(model) {
                return [
                    '# Executive Pack - LTC System Modelling Lab',
                    'Generated: ' + nowIso(),
                    '',
                    '## KPI Snapshot',
                    '- PUE: ' + fmtNum(model.pue, 3),
                    '- System COP: ' + fmtNum(model.systemCop, 2),
                    '- Net OPEX: ' + fmtUsd(model.netOpex),
                    '- Net Carbon: ' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr',
                    '- Risk Index: ' + fmtNum(model.riskIndex, 1) + '/100',
                    '- Composite Score: ' + fmtNum(model.scores.total, 1) + '/100',
                    '',
                    '## Constraint Status',
                    document.getElementById('constraintStatus') ? document.getElementById('constraintStatus').textContent : '-',
                    '',
                    '## Active Failure Mode',
                    '- ' + model.failureMode + ' | ' + model.failureNote
                ].join('\n');
            }

            function buildEngineeringPack(model) {
                var inFlat = {};
                flattenObject('', model.input, inFlat);
                var outObj = {};
                Object.keys(model).forEach(function(key) { if (key !== 'input') outObj[key] = model[key]; });
                var outFlat = {};
                flattenObject('', outObj, outFlat);
                var lines = [
                    '# Engineering Pack - LTC System Modelling Lab',
                    'Generated: ' + nowIso(),
                    '',
                    '## Active Gate Rules',
                    '- G1: ' + gateRules.g1,
                    '- G2: ' + gateRules.g2,
                    '- G3: ' + gateRules.g3,
                    '',
                    '## Inputs'
                ];
                Object.keys(inFlat).sort().forEach(function(k) { lines.push('- ' + k + ' = ' + formatTraceValue(inFlat[k])); });
                lines.push('', '## Outputs');
                Object.keys(outFlat).sort().forEach(function(k) { lines.push('- ' + k + ' = ' + formatTraceValue(outFlat[k])); });
                return lines.join('\n');
            }

            function applyModelToUI(model) {
                var countryLabel = selectedCountryLabel();
                var rackLabel = selectedRackLabel();

                setText('outCountry', countryLabel);
                setText('outLiquidLoad', fmtNum(model.liquidKw, 0) + ' kW');
                setText('outAirLoad', fmtNum(model.airKw, 0) + ' kW');
                setText('outFlow', fmtNum(model.flowLpm, 0) + ' LPM');
                setText('outPump', fmtNum(model.pumpPowerKw, 1) + ' kW');
                setText('outCdu', model.cduCount + ' units');
                setText('outPue', fmtNum(model.pue, 3));
                setText('outCop', fmtNum(model.systemCop, 2));
                setText('outWue', fmtNum(model.wue, 3) + ' L/kWh');
                setText('outEnergy', fmtNum(model.annualGwh, 2) + ' GWh/yr');
                setText('outOpex', fmtUsd(model.annualOpex));
                setText('outHeatCredit', fmtUsd(model.heatReuseCredit));
                setText('outNetOpex', fmtUsd(model.netOpex));
                setText('outCarbon', fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr');
                setText('outCarbonAvoided', fmtNum(model.avoidedCarbonTons, 0) + ' tCO2e/yr');
                setText('outRackType', rackLabel);
                setText('outDesignDensity', fmtNum(model.designDensity, 1) + ' kW/rack');
                setText('outControlIndex', fmtNum(model.controlIndex, 1) + '/100');
                setText('outFutureFactor', fmtNum(model.futureFactor, 3) + 'x (' + model.input.modelYear + ')');
                setText('outRackDensity', fmtNum(model.rackDensity, 1) + ' kW/rack');
                setText('outRisk', fmtNum(model.riskIndex, 1) + '/100');
                setText('outConfidence', fmtNum(model.confidence, 0) + '%');

                setText('modelInputNode', fmtNum(model.input.itLoadMw, 1) + 'MW | ' + fmtNum(model.effectiveCapture, 0) + '% effective capture');
                setText('modelEngineNode', 'dT ' + fmtNum(model.deltaT, 1) + 'C | ' + fmtNum(model.flowLpm, 0) + ' LPM | control ' + fmtNum(model.controlIndex, 0));
                setText('modelControlNode', 'Targets PUE ' + fmtNum(model.input.targetPue, 3) + ' / COP ' + fmtNum(model.input.targetCop, 2) + ' | gap check active');
                setText('modelImpactNode', 'PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2) + ' | risk ' + fmtNum(model.riskIndex, 1));

                setText('diagInputMain', shortText(fmtNum(model.input.itLoadMw, 1) + 'MW | ' + rackLabel, 22));
                setText('diagInputSub', shortText(countryLabel + ' | dens ' + fmtNum(model.input.rackDensityTarget, 1), 22));
                setText('diagThermalMain', shortText('Ts ' + fmtNum(model.input.supplyTemp, 1) + 'C -> Tr ' + fmtNum(model.input.returnTemp, 1) + 'C', 22));
                setText('diagThermalSub', shortText('capture ' + fmtNum(model.effectiveCapture, 1) + '% | L ' + fmtNum(model.liquidKw, 0) + 'kW', 22));
                setText('diagHydraulicMain', shortText('flow ' + fmtNum(model.flowLpm, 0) + ' LPM | pump ' + fmtNum(model.pumpPowerKw, 1) + 'kW', 22));
                setText('diagHydraulicSub', shortText('pipe ' + fmtNum(model.input.coefPipeLoss, 2) + 'x | margin ' + fmtNum(model.input.hydraulicMargin, 0) + '%', 22));
                setText('diagImpactMain', shortText('PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2), 28));
                setText('diagImpactSub', shortText('WUE ' + fmtNum(model.wue, 3) + ' | future ' + fmtNum(model.futureFactor, 3) + 'x', 28));
                setText('diagCostMain', shortText('Net OPEX ' + fmtUsd(model.netOpex), 22));
                setText('diagCostSub', shortText('Carbon ' + fmtNum(model.netCarbonTons, 0) + ' tCO2e/yr', 22));
                setText('diagControlMain', shortText('ControlIdx ' + fmtNum(model.controlIndex, 1) + ' | fit ' + (calibrationState ? fmtNum(fitScoreFromError(calibrationState.bestError), 1) + '%' : 'n/a'), 24));
                setText('diagControlSub', shortText('Gap PUE ' + signed(model.pueGap, 3, '') + ' | COP ' + signed(model.copGap, 2, ''), 24));
                setText('diagComplianceMain', shortText('Score ' + fmtNum(model.scores.total, 1) + '/100', 28));
                setText('diagComplianceSub', shortText('ASH ' + fmtNum(model.scores.ashrae, 0) + ' | ANSI ' + fmtNum(model.scores.ansi, 0) + ' | ISO ' + fmtNum(model.scores.iso, 0), 28));

                setText('ctrlSensorMain', shortText('Monitoring ' + fmtNum(model.input.monitoring, 0) + '% | conf ' + fmtNum(model.confidence, 0) + '%', 22));
                setText('ctrlSensorSub', shortText('Year ' + model.input.modelYear, 22));
                setText('ctrlControllerMain', shortText('Control ' + fmtNum(model.input.controlQuality, 0) + '% | pred ' + fmtNum(model.input.predictiveGain, 0) + '%', 22));
                setText('ctrlControllerSub', shortText('Ctrl idx ' + fmtNum(model.controlIndex, 1) + '/100', 22));
                setText('ctrlActuatorMain', shortText('Ts ' + fmtNum(model.input.supplyTemp, 1) + 'C | pump ' + fmtNum(model.input.pumpEff, 0) + '%', 22));
                setText('ctrlActuatorSub', shortText('capture ' + fmtNum(model.effectiveCapture, 1) + '% | flow ' + fmtNum(model.flowLpm, 0), 22));
                setText('ctrlPlantMain', shortText('PUE ' + fmtNum(model.pue, 3) + ' | COP ' + fmtNum(model.systemCop, 2) + ' | risk ' + fmtNum(model.riskIndex, 1), 20));
                setText('ctrlPlantSub', shortText('Net OPEX ' + fmtUsd(model.netOpex), 20));

                var gateEval = evaluateGateStates(model);
                var gateAOk = gateEval.g1;
                var gateBOk = gateEval.g2;
                var gateCOk = gateEval.g3;
                setGateState('ctrlGateAPoly', gateAOk);
                setGateState('ctrlGateBPoly', gateBOk);
                setGateState('ctrlGateCPoly', gateCOk);
                setText('ctrlGateAMain', gateAOk ? 'G1 OK' : 'G1 ADJ');
                setText('ctrlGateBMain', gateBOk ? 'G2 OK' : 'G2 LIM');
                setText('ctrlGateCMain', gateCOk ? 'G3 OK' : 'G3 ACT');
                setText('ctrlGateASub', shortText(gateRules.g1.replace(/\s+/g, ' '), 28));
                setText('ctrlGateBSub', shortText(gateRules.g2.replace(/\s+/g, ' '), 28));
                setText('ctrlGateCSub', shortText(gateRules.g3.replace(/\s+/g, ' '), 28));

                setText('impactPueGap', signed(model.pueGap, 3, ''));
                setText('impactCopGap', signed(model.copGap, 2, ''));
                if (baselineModel && optimizedModel) setText('impactOpexDelta', signed(optimizedModel.netOpex - baselineModel.netOpex, 0, ' USD/yr'));
                else setText('impactOpexDelta', 'N/A');
                setText('targetGapBadge', 'Gap PUE ' + signed(model.pueGap, 3, '') + ' | COP ' + signed(model.copGap, 2, ''));

                setText('outScore', fmtNum(model.scores.total, 1) + '/100');
                setText('outGrade', grade(model.scores.total));
                setText('scoreAshrae', fmtNum(model.scores.ashrae, 0) + '/100');
                setText('scoreAnsi', fmtNum(model.scores.ansi, 0) + '/100');
                setText('scoreIso', fmtNum(model.scores.iso, 0) + '/100');
                setText('scoreNfpa', fmtNum(model.scores.nfpa, 0) + '/100');
                setText('scoreUptime', fmtNum(model.scores.uptime, 0) + '/100');
                setBar('barAshrae', model.scores.ashrae);
                setBar('barAnsi', model.scores.ansi);
                setBar('barIso', model.scores.iso);
                setBar('barNfpa', model.scores.nfpa);
                setBar('barUptime', model.scores.uptime);

                renderBreakdown(model);
                renderTraceability(model);
                renderPipelineFlow(model);
                renderLogicSequence(model);
                renderFullParameterMap(model);
                renderEquationInspector(model);
                renderImpactMatrix(model);
                renderConstraintStatus(model);
                renderCalibrationPanel();
                renderCalibrationQuality();
                renderParetoScatter();
                renderMonteCarloDistributions();
                renderEnergySankey(model);
            }

            function runModel(resetOptimization) {
                if (resetOptimization === void 0) resetOptimization = true;
                var input = gatherInputs();
                baselineModel = computeModel(input);
                if (resetOptimization) {
                    optimizedModel = null;
                    latestPareto = [];
                    selectedParetoIdx = -1;
                    latestMonteCarlo = null;
                    if (calibrationState) calibrationDirty = true;
                }
                applyModelToUI(baselineModel);
                renderScenarioTable(baselineModel, optimizedModel);
                renderTargetActions(baselineModel, optimizedModel);
            }

            function applyCountryProfile() {
                var key = document.getElementById('inCountryProfile').value;
                var profile = COUNTRY_PROFILES[key];
                if (!profile || key === 'custom') {
                    runModel(true);
                    return;
                }
                document.getElementById('inClimate').value = profile.climate;
                document.getElementById('inElecPrice').value = profile.elecPrice;
                document.getElementById('inWaterTariff').value = profile.waterTariff;
                document.getElementById('inAirCop').value = profile.airCop;
                document.getElementById('inTargetPue').value = profile.targetPue;
                document.getElementById('inTargetCop').value = profile.targetCop;
                document.getElementById('inEconomizerHours').value = profile.economizerHours;
                document.getElementById('inCarbonIntensity').value = profile.carbonIntensity;
                document.getElementById('inUpsEff').value = profile.upsEff;
                document.getElementById('inDistLoss').value = profile.distLoss;
                runModel(true);
            }

            function applyCoolingArchitecturePreset() {
                var key = document.getElementById('inCoolingArchitecture').value;
                var preset = COOLING_ARCH_PROFILES[key];
                if (!preset || key === 'manual') {
                    runModel(true);
                    return;
                }
                if (preset.rackType) document.getElementById('inRackType').value = preset.rackType;
                if (preset.liquidCapture !== undefined) document.getElementById('inLiquidCapture').value = preset.liquidCapture;
                if (preset.supplyTemp !== undefined) document.getElementById('inSupplyTemp').value = preset.supplyTemp;
                if (preset.returnTemp !== undefined) document.getElementById('inReturnTemp').value = preset.returnTemp;
                if (preset.airCop !== undefined) document.getElementById('inAirCop').value = preset.airCop;
                if (preset.fanPower !== undefined) document.getElementById('inFanPower').value = preset.fanPower;
                if (preset.economizerHours !== undefined) document.getElementById('inEconomizerHours').value = preset.economizerHours;
                if (preset.coefHeatTransfer !== undefined) document.getElementById('inCoefHeatTransfer').value = preset.coefHeatTransfer;
                if (preset.coefPipeLoss !== undefined) document.getElementById('inCoefPipeLoss').value = preset.coefPipeLoss;
                runModel(true);
            }

            function optimizeObjective(model, input, constraints) {
                var pueErr = model.pue - input.targetPue;
                var copErr = input.targetCop - model.systemCop;
                var pueRel = Math.abs(pueErr) / Math.max(input.targetPue, 1);
                var copRel = Math.abs(copErr) / Math.max(input.targetCop, 1);
                var score = 0;
                score += pueRel * 1350;
                score += copRel * 920;
                score += Math.max(0, pueErr) * 260;
                score += Math.max(0, copErr) * 220;
                score += model.riskIndex * 1.05;
                score += (model.netOpex / 1000000) * 0.12;
                score += (model.netCarbonTons / 1000) * 0.14;
                score += Math.abs(model.designDensity - input.rackDensityTarget) * 0.09;
                score += Math.max(0, model.pumpPowerKw - (input.itLoadMw * 1000 * 0.03)) * 0.32;
                if (model.pue > input.targetPue + 0.015) score += 18;
                if (model.systemCop < input.targetCop - 0.12) score += 14;
                if (model.riskIndex > 40) score += (model.riskIndex - 40) * 1.6;
                if (constraints) {
                    var hard = evaluateHardConstraints(model, constraints);
                    if (constraints.enforce && !hard.feasible) score += 100000 + hard.issues.length * 5000;
                    else if (!hard.feasible) score += hard.issues.length * 2500;
                }
                return score;
            }

            function randomInRange(min, max, step) {
                var raw = min + (Math.random() * (max - min));
                if (step > 0) raw = Math.round(raw / step) * step;
                return clamp(raw, min, max);
            }

            function optimizeToTarget() {
                var input = gatherInputs();
                var constraints = gatherConstraintState();
                var base = computeModel(input);
                baselineModel = base;
                latestPareto = [];
                selectedParetoIdx = -1;
                latestMonteCarlo = null;
                if (calibrationState) calibrationDirty = true;

                var best = base;
                var bestInput = Object.assign({}, input);
                var bestScore = optimizeObjective(base, input, constraints);
                var baseDeltaT = Math.max(input.returnTemp - input.supplyTemp, 6);
                var tunables = [
                    { key: 'liquidCapture', min: 40, max: 99, step: 1, span: 22 },
                    { key: 'rackDensityTarget', min: 8, max: 180, step: 1, span: 18 },
                    { key: 'highDensityShare', min: 0, max: 100, step: 1, span: 30 },
                    { key: 'supplyTemp', min: 20, max: 40, step: 0.5, span: 4.5 },
                    { key: 'airCop', min: 2.1, max: 12, step: 0.1, span: 1.9 },
                    { key: 'pumpEff', min: 56, max: 95, step: 1, span: 10 },
                    { key: 'economizerHours', min: 0, max: 95, step: 1, span: 18 },
                    { key: 'heatReuse', min: 0, max: 80, step: 1, span: 18 },
                    { key: 'hydraulicMargin', min: 0, max: 35, step: 1, span: 8 },
                    { key: 'controlQuality', min: 30, max: 100, step: 1, span: 12 },
                    { key: 'predictiveGain', min: 0, max: 60, step: 1, span: 12 },
                    { key: 'coefHeatTransfer', min: 72, max: 99, step: 0.5, span: 5.5 },
                    { key: 'coefCduLoss', min: 0.5, max: 4.5, step: 0.05, span: 0.7 },
                    { key: 'coefPipeLoss', min: 0.78, max: 1.65, step: 0.01, span: 0.14 },
                    { key: 'coefFutureTech', min: -6, max: 45, step: 1, span: 8 }
                ];

                function candidateFrom(anchor, scale, exploreGlobal) {
                    var candidate = Object.assign({}, anchor);
                    tunables.forEach(function(cfg) {
                        var center = exploreGlobal ? input[cfg.key] : anchor[cfg.key];
                        var low = Math.max(cfg.min, center - (cfg.span * scale));
                        var high = Math.min(cfg.max, center + (cfg.span * scale));
                        candidate[cfg.key] = randomInRange(low, high, cfg.step);
                    });
                    var deltaTarget = randomInRange(Math.max(6, baseDeltaT - (1.4 * scale)), Math.min(16, baseDeltaT + (1.8 * scale)), 0.5);
                    candidate.returnTemp = clamp(candidate.supplyTemp + deltaTarget, candidate.supplyTemp + 6, candidate.supplyTemp + 16);
                    return candidate;
                }

                var stages = [
                    { iterations: 3200, scale: 1.0, exploreEvery: 12 },
                    { iterations: 2400, scale: 0.55, exploreEvery: 0 },
                    { iterations: 1800, scale: 0.28, exploreEvery: 0 }
                ];

                stages.forEach(function(stage) {
                    for (var i = 0; i < stage.iterations; i++) {
                        var exploreGlobal = stage.exploreEvery > 0 && (i % stage.exploreEvery === 0);
                        var anchor = exploreGlobal ? input : bestInput;
                        var candidate = candidateFrom(anchor, stage.scale, exploreGlobal);
                        var model = computeModel(candidate);
                        var score = optimizeObjective(model, input, constraints);
                        if (score < bestScore) {
                            bestScore = score;
                            best = model;
                            bestInput = candidate;
                        }
                    }
                });

                [6, 3, 1].forEach(function(stepMul) {
                    var improved = true;
                    var guard = 0;
                    while (improved && guard < 8) {
                        improved = false;
                        guard += 1;
                        tunables.forEach(function(cfg) {
                            [-1, 1].forEach(function(dir) {
                                var candidate = Object.assign({}, bestInput);
                                candidate[cfg.key] = clamp(candidate[cfg.key] + (dir * cfg.step * stepMul), cfg.min, cfg.max);
                                if (cfg.key === 'supplyTemp') {
                                    candidate.returnTemp = clamp(bestInput.returnTemp + (dir * cfg.step * stepMul), candidate.supplyTemp + 6, candidate.supplyTemp + 16);
                                } else {
                                    candidate.returnTemp = clamp(candidate.returnTemp, candidate.supplyTemp + 6, candidate.supplyTemp + 16);
                                }
                                var model = computeModel(candidate);
                                var score = optimizeObjective(model, input, constraints);
                                if (score < bestScore) {
                                    bestScore = score;
                                    best = model;
                                    bestInput = candidate;
                                    improved = true;
                                }
                            });
                        });
                    }
                });

                document.getElementById('inLiquidCapture').value = fmtNum(bestInput.liquidCapture, 0);
                document.getElementById('inRackDensityTarget').value = fmtNum(bestInput.rackDensityTarget, 0);
                document.getElementById('inHighDensityShare').value = fmtNum(bestInput.highDensityShare, 0);
                document.getElementById('inSupplyTemp').value = fmtNum(bestInput.supplyTemp, 1);
                document.getElementById('inReturnTemp').value = fmtNum(bestInput.returnTemp, 1);
                document.getElementById('inAirCop').value = fmtNum(bestInput.airCop, 1);
                document.getElementById('inPumpEff').value = fmtNum(bestInput.pumpEff, 0);
                document.getElementById('inEconomizerHours').value = fmtNum(bestInput.economizerHours, 0);
                document.getElementById('inHeatReuse').value = fmtNum(bestInput.heatReuse, 0);
                document.getElementById('inHydraulicMargin').value = fmtNum(bestInput.hydraulicMargin, 0);
                document.getElementById('inControlQuality').value = fmtNum(bestInput.controlQuality, 0);
                document.getElementById('inPredictiveGain').value = fmtNum(bestInput.predictiveGain, 0);
                document.getElementById('inCoefHeatTransfer').value = fmtNum(bestInput.coefHeatTransfer, 1);
                document.getElementById('inCoefPipeLoss').value = fmtNum(bestInput.coefPipeLoss, 2);
                document.getElementById('inCoefFutureTech').value = fmtNum(bestInput.coefFutureTech, 0);

                optimizedModel = best;
                applyModelToUI(optimizedModel);
                renderScenarioTable(baselineModel, optimizedModel);
                renderTargetActions(baselineModel, optimizedModel);
            }

            function runCalibration() {
                var input = gatherInputs();
                var targets = gatherCalibrationTargets();
                if (targets.metricCount < 2) {
                    alert('Calibration needs at least 2 measured KPI targets (e.g. PUE and COP).');
                    return;
                }

                var base = computeModel(input);
                var baseEval = calibrationError(base, targets);
                latestPareto = [];
                selectedParetoIdx = -1;
                latestMonteCarlo = null;

                var best = base;
                var bestInput = Object.assign({}, input);
                var bestEval = baseEval;

                for (var i = 0; i < 4200; i++) {
                    var candidate = Object.assign({}, input, {
                        liquidCapture: randomInRange(Math.max(35, input.liquidCapture - 25), Math.min(99, input.liquidCapture + 20), 1),
                        controlQuality: randomInRange(Math.max(25, input.controlQuality - 30), Math.min(100, input.controlQuality + 22), 1),
                        predictiveGain: randomInRange(Math.max(0, input.predictiveGain - 18), Math.min(60, input.predictiveGain + 26), 1),
                        coefHeatTransfer: randomInRange(Math.max(70, input.coefHeatTransfer - 12), Math.min(99, input.coefHeatTransfer + 7), 0.5),
                        coefCduLoss: randomInRange(Math.max(0.5, input.coefCduLoss - 1.1), Math.min(4.5, input.coefCduLoss + 0.9), 0.05),
                        coefPipeLoss: randomInRange(Math.max(0.75, input.coefPipeLoss - 0.22), Math.min(1.8, input.coefPipeLoss + 0.28), 0.01),
                        coefFutureTech: randomInRange(Math.max(-10, input.coefFutureTech - 10), Math.min(45, input.coefFutureTech + 18), 1),
                        airCop: randomInRange(Math.max(1.8, input.airCop - 2.2), Math.min(13, input.airCop + 3.4), 0.1),
                        pumpEff: randomInRange(Math.max(50, input.pumpEff - 14), Math.min(95, input.pumpEff + 10), 1),
                        hydraulicMargin: randomInRange(Math.max(0, input.hydraulicMargin - 12), Math.min(45, input.hydraulicMargin + 10), 1),
                        economizerHours: randomInRange(Math.max(0, input.economizerHours - 30), Math.min(95, input.economizerHours + 35), 1),
                        fanPower: randomInRange(Math.max(0.5, input.fanPower - 2), Math.min(12, input.fanPower + 2), 0.1)
                    });
                    candidate.returnTemp = candidate.supplyTemp + Math.max(input.returnTemp - input.supplyTemp, 6);

                    var model = computeModel(candidate);
                    var evalResult = calibrationError(model, targets);
                    if (evalResult.error < bestEval.error) {
                        best = model;
                        bestInput = candidate;
                        bestEval = evalResult;
                    }
                }

                var applyChecked = document.getElementById('calLockApply').checked;
                if (applyChecked) {
                    document.getElementById('inLiquidCapture').value = fmtNum(bestInput.liquidCapture, 0);
                    document.getElementById('inControlQuality').value = fmtNum(bestInput.controlQuality, 0);
                    document.getElementById('inPredictiveGain').value = fmtNum(bestInput.predictiveGain, 0);
                    document.getElementById('inCoefHeatTransfer').value = fmtNum(bestInput.coefHeatTransfer, 1);
                    document.getElementById('inCoefCduLoss').value = fmtNum(bestInput.coefCduLoss, 2);
                    document.getElementById('inCoefPipeLoss').value = fmtNum(bestInput.coefPipeLoss, 2);
                    document.getElementById('inCoefFutureTech').value = fmtNum(bestInput.coefFutureTech, 0);
                    document.getElementById('inAirCop').value = fmtNum(bestInput.airCop, 1);
                    document.getElementById('inPumpEff').value = fmtNum(bestInput.pumpEff, 0);
                    document.getElementById('inHydraulicMargin').value = fmtNum(bestInput.hydraulicMargin, 0);
                    document.getElementById('inEconomizerHours').value = fmtNum(bestInput.economizerHours, 0);
                    document.getElementById('inFanPower').value = fmtNum(bestInput.fanPower, 1);
                }

                baselineModel = base;
                optimizedModel = best;
                calibrationState = {
                    metricCount: targets.metricCount,
                    baseError: baseEval.error,
                    bestError: bestEval.error,
                    quality: computeCalibrationQuality(best, targets),
                    tuned: {
                        liquidCapture: bestInput.liquidCapture,
                        controlQuality: bestInput.controlQuality,
                        predictiveGain: bestInput.predictiveGain,
                        coefHeatTransfer: bestInput.coefHeatTransfer,
                        coefCduLoss: bestInput.coefCduLoss,
                        coefPipeLoss: bestInput.coefPipeLoss,
                        coefFutureTech: bestInput.coefFutureTech
                    }
                };
                calibrationDirty = false;

                applyModelToUI(optimizedModel);
                renderScenarioTable(baselineModel, optimizedModel);
                renderTargetActions(baselineModel, optimizedModel);
            }

            function clearCalibration() {
                ['calTargetPue', 'calTargetCop', 'calTargetEnergy', 'calTargetNetOpex', 'calTargetCarbon', 'calTargetPump'].forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) el.value = '';
                });
                calibrationState = null;
                calibrationDirty = false;
                runModel(true);
            }

            function resetForm() {
                Object.keys(DEFAULTS).forEach(function(id) {
                    var el = document.getElementById(id);
                    if (!el) return;
                    if (el.type === 'checkbox') el.checked = DEFAULTS[id];
                    else el.value = DEFAULTS[id];
                });
                gateRules = Object.assign({}, DEFAULT_GATE_RULES);
                setRuleStatus('Rule Set: Default', '');
                baselineModel = null;
                optimizedModel = null;
                calibrationState = null;
                calibrationDirty = false;
                latestPareto = [];
                selectedParetoIdx = -1;
                latestMonteCarlo = null;
                renderScenarioDiff(null, null);
                renderPdfSourceSelectors();
                var single = document.getElementById('pdfSingleSource');
                var left = document.getElementById('pdfCompareLeft');
                var right = document.getElementById('pdfCompareRight');
                if (single) single.value = 'live_baseline';
                if (left) left.value = 'live_baseline';
                if (right) right.value = 'live_optimized';
                runModel(true);
            }

            document.getElementById('runCalc').addEventListener('click', function() { runModel(true); });
            document.getElementById('optimizeTarget').addEventListener('click', optimizeToTarget);
            document.getElementById('runCalibration').addEventListener('click', runCalibration);
            document.getElementById('clearCalibration').addEventListener('click', clearCalibration);
            document.getElementById('resetCalc').addEventListener('click', resetForm);
            document.getElementById('inCountryProfile').addEventListener('change', applyCountryProfile);
            document.getElementById('inCoolingArchitecture').addEventListener('change', applyCoolingArchitecturePreset);
            document.getElementById('applyConstraintBtn').addEventListener('click', function() { runModel(false); });
            document.getElementById('applyRulesBtn').addEventListener('click', applyRuleSetFromEditor);
            document.getElementById('resetRulesBtn').addEventListener('click', resetRuleSetToDefault);
            document.getElementById('runPareto').addEventListener('click', runParetoFrontier);
            document.getElementById('applyParetoBest').addEventListener('click', function() {
                if (!latestPareto.length) {
                    alert('Generate Pareto frontier first.');
                    return;
                }
                applyParetoPoint(0);
            });
            document.getElementById('runMonteCarlo').addEventListener('click', runMonteCarlo);
            document.getElementById('saveScenarioBtn').addEventListener('click', saveScenarioSnapshot);
            document.getElementById('loadScenarioBtn').addEventListener('click', loadSelectedScenario);
            document.getElementById('deleteScenarioBtn').addEventListener('click', deleteSelectedScenario);
            document.getElementById('refreshLedger').addEventListener('click', function() {
                var ledger = loadLedger().map(function(row) { return Object.assign({}, row, { ts: nowIso() }); });
                saveLedger(ledger);
                renderLedgerTable(ledger);
            });
            document.getElementById('exportExecutive').addEventListener('click', function() {
                var model = baselineModel || computeModel(gatherInputs());
                downloadTextFile('ltc-executive-pack.txt', buildExecutivePack(model));
                var s = document.getElementById('exportStatus');
                if (s) {
                    s.className = 'status-pill ok';
                    s.textContent = 'Executive Pack Exported';
                }
            });
            document.getElementById('exportEngineering').addEventListener('click', function() {
                var model = baselineModel || computeModel(gatherInputs());
                downloadTextFile('ltc-engineering-pack.txt', buildEngineeringPack(model));
                var s = document.getElementById('exportStatus');
                if (s) {
                    s.className = 'status-pill ok';
                    s.textContent = 'Engineering Pack Exported';
                }
            });
            document.getElementById('exportPdfSingle').addEventListener('click', exportPdfSingle);
            document.getElementById('exportPdfCompare').addEventListener('click', exportPdfCompare);

            document.getElementById('paretoRows').addEventListener('click', function(ev) {
                var tr = ev.target && ev.target.closest ? ev.target.closest('tr[data-pareto-idx]') : null;
                if (!tr) return;
                var idx = parseInt(tr.getAttribute('data-pareto-idx'), 10);
                if (!isFinite(idx)) return;
                applyParetoPoint(idx);
            });
            document.getElementById('paretoScatterSvg').addEventListener('click', function(ev) {
                var node = ev.target && ev.target.closest ? ev.target.closest('circle[data-pidx]') : null;
                if (!node) return;
                var idx = parseInt(node.getAttribute('data-pidx'), 10);
                if (!isFinite(idx)) return;
                applyParetoPoint(idx);
            });
            document.getElementById('sankeyMode').addEventListener('change', function() {
                renderEnergySankey(optimizedModel || baselineModel || computeModel(gatherInputs()));
            });

            initInputTooltips();
            initOutputTooltips();
            initTooltipPositioning();
            initTermTooltipPositioning();
            setRuleStatus('Rule Set: Default', '');
            loadScenarios();
            renderScenarioList();
            renderLedgerTable(loadLedger());

            document.querySelectorAll('.input-grid input, .input-grid select').forEach(function(el) {
                el.addEventListener('change', function() {
                    runModel(true);
                });
            });
            document.getElementById('inConcurrent').addEventListener('change', function() { runModel(true); });
            document.getElementById('inFailureMode').addEventListener('change', function() { runModel(true); });
            ['conPueMax', 'conCopMin', 'conRiskMax', 'conPumpPctMax', 'conEnforce'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('change', function() { runModel(false); });
            });
            document.getElementById('scenarioSelect').addEventListener('change', function() {
                var idx = parseInt(this.value, 10);
                if (isFinite(idx)) selectedScenarioIdx = idx;
            });

            runModel(true);
        })();
    </script>

    <script src="auth.js?v=20260225"></script>
    <script src="rz-tracker.js"></script>

    <script>
        (function rootAccessGate() {
            var ROOT_EMAILS = ['admin@resistancezero.com', 'bagus@resistancezero.com'];

            function detectRole(email) {
                var e = String(email || '').toLowerCase().trim();
                return ROOT_EMAILS.indexOf(e) !== -1 ? 'root' : 'pro';
            }

            function getSession() {
                try {
                    var raw = localStorage.getItem('rz_premium_session');
                    if (!raw) return null;
                    var data = JSON.parse(raw);
                    if (data.expires && new Date(data.expires) < new Date()) {
                        localStorage.removeItem('rz_premium_session');
                        return null;
                    }
                    if (!data.role) data.role = detectRole(data.email);
                    return data;
                } catch (e) {
                    return null;
                }
            }

            function isRoot(session) {
                return !!(session && String(session.role || '').toLowerCase() === 'root');
            }

            function applyGate() {
                var session = getSession();
                document.body.classList.toggle('locked', !isRoot(session));
            }

            var loginBtn = document.getElementById('rootLoginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', function() {
                    if (window._rzAuth && typeof window._rzAuth.showModal === 'function') {
                        window._rzAuth.showModal();
                    } else {
                        alert('Login module is not ready yet.');
                    }
                });
            }

            window.addEventListener('rz-auth-change', function() {
                applyGate();
            });

            setTimeout(applyGate, 60);
            setTimeout(applyGate, 550);
        })();

        (function cookieBanner() {
            var banner = document.getElementById('cookieBanner');
            var accepted = localStorage.getItem('rz_cookie_consent');
            if (!accepted && banner) banner.classList.remove('hidden');

            var accept = document.getElementById('cookieAccept');
            var decline = document.getElementById('cookieDecline');

            if (accept) {
                accept.addEventListener('click', function() {
                    localStorage.setItem('rz_cookie_consent', 'accepted');
                    banner.classList.add('hidden');
                });
            }

            if (decline) {
                decline.addEventListener('click', function() {
                    localStorage.setItem('rz_cookie_consent', 'declined');
                    banner.classList.add('hidden');
                    window['ga-disable-G-GED7FX8RTV'] = true;
                });
            }
        })();
    </script>
</body>
</html>
