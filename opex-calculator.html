<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GED7FX8RTV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GED7FX8RTV');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- SEO Meta Tags -->
    <title>Data Center OPEX Calculator | Comprehensive Operational Cost Analysis</title>
    <meta name="description" content="Calculate annual data center operating costs. Interactive OPEX calculator with staffing, energy, maintenance, and vendor cost modeling.">
    <meta name="keywords" content="Data Center OPEX, Operational Cost Calculator, Staffing Cost, Energy Cost, Indonesia Data Center, Ahli K3 Listrik, Facility Management Cost">
    <meta name="author" content="Bagus Dwi Permana">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#0066cc">
    <link rel="canonical" href="https://resistancezero.com/opex-calculator.html">

    <link rel="alternate" hreflang="en" href="https://resistancezero.com/opex-calculator.html">

    <!-- Resource Hints -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://resistancezero.com/opex-calculator.html">
    <meta property="og:title" content="Data Center OPEX Calculator">
    <meta property="og:description" content="Comprehensive operational cost analysis with country-specific rates and flexible staffing models.">
    <meta property="og:image" content="https://resistancezero.com/assets/opex-og.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="669">
    <meta property="og:image:alt" content="Data Center OPEX Calculator - Comprehensive Operational Cost Analysis">
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="Bagus Dwi Permana Portfolio">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Data Center OPEX Calculator">
    <meta name="twitter:description" content="OPEX calculator with 30+ countries, climate zones, and flexible staffing models.">
    <meta name="twitter:image" content="https://resistancezero.com/assets/opex-og.jpg">
    <meta name="twitter:image:alt" content="Data Center OPEX Calculator Tool">

    <!-- WebApplication Schema -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Data Center OPEX Calculator",
        "applicationCategory": "FinanceApplication",
        "description": "Calculate comprehensive data center operational costs with country-specific rates, climate adjustments, and flexible staffing models for 30+ countries including Indonesia with Ahli K3 Listrik baseline.",
        "url": "https://resistancezero.com/opex-calculator.html",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "30+ country support with local currency",
            "Climate-adjusted energy calculations",
            "Flexible staffing models (In-house, Hybrid, Outsourced)",
            "Indonesia baseline with UMK rates",
            "Real-time cost breakdown",
            "Generator maintenance scheduling",
            "Tier I-IV redundancy configurations"
        ],
        "creator": {
            "@type": "Person",
            "name": "Bagus Dwi Permana",
            "jobTitle": "Engineering Operations Manager",
            "url": "https://resistancezero.com/"
        }
    }
    </script>

    <!-- Structured Data - HowTo -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "HowTo",
        "name": "How to Calculate Data Center OPEX Costs",
        "description": "Use this interactive calculator to estimate annual operational expenditure for data centers including staffing, energy, maintenance, and compliance costs across different countries.",
        "totalTime": "PT5M",
        "tool": [
            {"@type": "HowToTool", "name": "Data Center OPEX Calculator"}
        ],
        "step": [
            {
                "@type": "HowToStep",
                "position": 1,
                "name": "Select Country and Region",
                "text": "Choose your data center location country to apply regional cost benchmarks for energy rates, labor costs, and regulatory requirements."
            },
            {
                "@type": "HowToStep",
                "position": 2,
                "name": "Set IT Load and Infrastructure Parameters",
                "text": "Enter the total IT load in kW, PUE target, and number of racks to establish the facility baseline for cost calculations."
            },
            {
                "@type": "HowToStep",
                "position": 3,
                "name": "Configure Staffing Model",
                "text": "Select the shift model (12-hour or 8-hour rotation) and adjust headcount for operations, maintenance, and management staff."
            },
            {
                "@type": "HowToStep",
                "position": 4,
                "name": "Review OPEX Breakdown",
                "text": "Analyze the comprehensive cost breakdown including energy, staffing, maintenance contracts, insurance, compliance, and SGA costs with monthly and annual projections."
            }
        ]
    }
    </script>

    <link rel="icon" type="image/png" href="assets/Favicon.png">
    <link rel="apple-touch-icon" href="assets/Favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preload" as="image" href="assets/opex-og.jpg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3a7ca5 100%);
            --secondary-gradient: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%);
            --dark-blue: #1e3a5f;
            --medium-blue: #2d5a87;
            --light-blue: #4a90b8;
            --accent-gold: #f59e0b;
            --accent-amber: #fbbf24;
            --accent-emerald: #10b981;
            --accent-cyan: #06b6d4;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-bg-dark: rgba(30, 58, 95, 0.95);
            --glass-border: rgba(30, 58, 95, 0.1);
            --glass-blur: blur(20px);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Background */
        .page-background {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            background:
                radial-gradient(ellipse at top right, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at bottom left, rgba(245, 158, 11, 0.05) 0%, transparent 50%),
                linear-gradient(rgba(30, 58, 95, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 58, 95, 0.02) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 50px 50px, 50px 50px;
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: var(--shadow-md);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--dark-blue);
        }

        .nav-logo {
            width: 44px; height: 44px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: white;
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
        }

        .nav-title { font-weight: 700; font-size: 1.1rem; color: var(--dark-blue); }
        .nav-subtitle { font-size: 0.75rem; color: var(--text-muted); }

        .nav-links { display: flex; gap: 1.5rem; align-items: center; }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 0;
            position: relative;
            transition: color 0.3s;
        }

        .nav-link:hover { color: var(--dark-blue); }

        .nav-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            color: white;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.25);
        }

        .nav-back:hover { transform: translateY(-2px); }

        /* Main Content */
        .main-content {
            position: relative;
            z-index: 10;
            padding-top: 80px;
        }

        /* Hero */
        .hero {
            padding: 3rem 2rem 2rem;
            text-align: center;
            max-width: 900px;
            margin: 0 auto;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 50px;
            font-size: 0.8rem;
            color: var(--accent-emerald);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .hero h1 {
            font-size: clamp(2rem, 4vw, 2.8rem);
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
        }

        /* Brief Section */
        .brief-section {
            max-width: 860px;
            margin: -0.5rem auto 2rem;
            padding: 0 2rem;
        }

        .brief-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.04), rgba(30, 58, 95, 0.06));
            border: 1px solid rgba(16, 185, 129, 0.15);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .brief-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #10b981, #059669);
            border-radius: 4px 0 0 4px;
        }

        .brief-hero-img {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 1.25rem;
            border: 1px solid rgba(16, 185, 129, 0.12);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .brief-lead {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .brief-body {
            font-size: 0.92rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 0.75rem;
        }

        .brief-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0,0,0,0.06);
        }

        .brief-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .brief-stat i {
            color: var(--accent-emerald);
            font-size: 0.75rem;
        }

        .brief-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .brief-section { padding: 0 1rem; }
            .brief-card { padding: 1.25rem 1.25rem 1.25rem 1.5rem; }
            .brief-stats { gap: 1rem; }
        }

        /* Calculator Layout */
        .calculator-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        @media (max-width: 1024px) {
            .calculator-container {
                grid-template-columns: 1fr;
            }
        }

        /* Input Panel */
        .input-panel {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--glass-border);
            position: sticky;
            top: 100px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .input-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .input-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--dark-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: var(--accent-emerald);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .input-field {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 10px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s;
            background: white;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-emerald);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Country Select with Flag */
        .country-select-wrapper {
            position: relative;
        }

        .country-select {
            width: 100%;
            padding: 12px 14px 12px 45px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 10px;
            font-size: 0.95rem;
            font-family: inherit;
            background: white;
            cursor: pointer;
            appearance: none;
        }

        .country-flag {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .country-select-arrow {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        /* Slider */
        .slider-container {
            padding: 0.5rem 0;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .slider-value {
            font-weight: 700;
            color: var(--accent-emerald);
            font-family: 'JetBrains Mono', monospace;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-emerald);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
        }

        /* Staffing Model Cards */
        .staffing-models {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .model-card {
            padding: 1rem 0.75rem;
            border: 2px solid var(--bg-tertiary);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            position: relative;
        }

        .model-card:hover {
            border-color: var(--light-blue);
        }

        .model-card.active {
            border-color: var(--accent-emerald);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
        }

        .model-card i {
            font-size: 1.5rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: block;
        }

        .model-card.active i {
            color: var(--accent-emerald);
        }

        .model-card .model-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .model-card .model-desc {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Partial Slider */
        .partial-controls {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: none;
        }

        .partial-controls.active {
            display: block;
        }

        .partial-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .partial-labels .inhouse { color: var(--accent-emerald); }
        .partial-labels .contractor { color: var(--accent-purple); }

        /* Results Panel */
        .results-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Summary Cards */
        .summary-card {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--medium-blue) 100%);
            border-radius: 20px;
            padding: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            pointer-events: none;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .summary-title {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }

        .country-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .total-opex {
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.5rem;
        }

        .total-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 1.5rem;
        }

        .summary-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .metric-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }

        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .metric-label {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--glass-border);
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-title i {
            color: var(--accent-emerald);
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        /* Breakdown Table */
        .breakdown-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--glass-border);
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
        }

        .breakdown-table th,
        .breakdown-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .breakdown-table th {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
        }

        .breakdown-table th:first-child {
            border-radius: 8px 0 0 8px;
        }

        .breakdown-table th:last-child {
            border-radius: 0 8px 8px 0;
        }

        .breakdown-table td {
            font-size: 0.9rem;
        }

        .breakdown-table tr:last-child td {
            border-bottom: none;
        }

        .breakdown-table .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.9rem;
        }

        .breakdown-table .amount {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .breakdown-table .percent {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            min-width: 100px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Staffing Table */
        .staffing-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .staffing-table th,
        .staffing-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .staffing-table th {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            background: var(--bg-secondary);
        }

        .staffing-table .role-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .staffing-table .fte-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .staffing-table .fte-inhouse {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-emerald);
        }

        .staffing-table .fte-contractor {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent-purple);
        }

        .staffing-table .cost {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .staffing-table tfoot td {
            font-weight: 700;
            background: var(--bg-secondary);
            border-top: 2px solid var(--dark-blue);
        }

        /* Scenario Comparison */
        .scenario-section {
            margin-top: 2rem;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 20px;
        }

        .scenario-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 800px) {
            .scenario-grid {
                grid-template-columns: 1fr;
            }
        }

        .scenario-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .scenario-card.current {
            border-color: var(--accent-emerald);
        }

        .scenario-card .scenario-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
        }

        .scenario-card .scenario-total {
            font-size: 1.5rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
        }

        .scenario-card .scenario-diff {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .scenario-card .scenario-diff.savings {
            color: var(--accent-emerald);
        }

        .scenario-card .scenario-diff.increase {
            color: var(--accent-red);
        }

        /* Footer */
        .footer {
            background: var(--dark-blue);
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
        }

        .footer p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .calculator-container { padding: 1rem; }
            .input-panel { position: static; max-height: none; }
            .summary-metrics { grid-template-columns: repeat(2, 1fr); }
            .staffing-models { grid-template-columns: 1fr; }
            #opexCompareGrid { grid-template-columns: 1fr !important; }
            #opexDeltaColumn { flex-direction: row !important; width: 100%; justify-content: center !important; }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* Enhanced Tooltip - Fixed positioning to escape overflow containers */
        .info-tooltip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 50%;
            font-size: 10px;
            color: var(--accent-emerald);
            cursor: help;
            margin-left: auto;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .info-tooltip:hover {
            background: rgba(16, 185, 129, 0.2);
            transform: scale(1.1);
        }

        .info-tooltip i {
            font-size: 8px;
        }

        /* Global tooltip container - appended to body */
        #tooltip-container {
            position: fixed;
            width: 320px;
            max-width: calc(100vw - 40px);
            padding: 16px;
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
            z-index: 999999;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease;
            color: white;
            font-size: 12px;
            line-height: 1.5;
        }

        #tooltip-container.visible {
            opacity: 1;
            visibility: visible;
        }

        #tooltip-container .tooltip-title {
            font-size: 13px;
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #tooltip-container .tooltip-desc {
            color: rgba(255,255,255,0.9);
            margin-bottom: 10px;
        }

        #tooltip-container .tooltip-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }

        #tooltip-container .tooltip-table th {
            text-align: left;
            color: rgba(255,255,255,0.6);
            font-weight: 500;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #tooltip-container .tooltip-table td {
            padding: 4px 0;
            color: white;
        }

        #tooltip-container .tooltip-table td:last-child {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            color: #22d3ee;
        }

        #tooltip-container .tooltip-note {
            margin-top: 10px;
            padding: 8px;
            background: rgba(16, 185, 129, 0.15);
            border-radius: 6px;
            font-size: 10px;
            color: #10b981;
        }

        /* Hide inline tooltip content - we use JS to show in global container */
        .info-tooltip .tooltip-content {
            display: none;
        }

        .tooltip-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-amber);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tooltip-desc {
            font-size: 11px;
            color: rgba(255,255,255,0.9);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .tooltip-table {
            width: 100%;
            font-size: 10px;
            border-collapse: collapse;
        }

        .tooltip-table th {
            text-align: left;
            color: rgba(255,255,255,0.6);
            font-weight: 500;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tooltip-table td {
            padding: 4px 0;
            color: white;
        }

        .tooltip-table td:last-child {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
        }

        .tooltip-note {
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(16, 185, 129, 0.15);
            border-radius: 6px;
            font-size: 10px;
            color: var(--accent-emerald);
        }

        /* ‚ïê‚ïê‚ïê PREMIUM GATING ‚ïê‚ïê‚ïê */
        .cost-value-hidden { filter: blur(8px); user-select: none; pointer-events: none; }
        .gated-overlay { position: relative; }
        .gated-overlay::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15,23,42,0.3); backdrop-filter: blur(2px); border-radius: 12px; z-index: 2; pointer-events: none; }
        .gated-btn { position: relative; cursor: pointer !important; }
        .gate-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 50px; font-size: 0.6rem; font-weight: 700; letter-spacing: 0.5px; background: linear-gradient(135deg,rgba(139,92,246,0.25),rgba(139,92,246,0.1)); color: #a78bfa; border: 1px solid rgba(139,92,246,0.3); margin-left: 8px; vertical-align: middle; }
        #opexFreeWatermark { position: fixed; bottom: 20px; right: 20px; z-index: 100; padding: 10px 18px; border-radius: 10px; background: linear-gradient(135deg,rgba(139,92,246,0.2),rgba(168,85,247,0.1)); border: 1px solid rgba(139,92,246,0.3); color: #a78bfa; font-size: 0.78rem; font-weight: 600; cursor: pointer; backdrop-filter: blur(8px); transition: all 0.3s; }
        #opexFreeWatermark:hover { background: linear-gradient(135deg,rgba(139,92,246,0.35),rgba(168,85,247,0.2)); transform: translateY(-2px); }
        #opexPremiumBadge { display: none; padding: 3px 10px; border-radius: 50px; font-size: 0.62rem; font-weight: 700; letter-spacing: 0.5px; background: linear-gradient(135deg,#8b5cf6,#a855f7); color: white; margin-left: 8px; vertical-align: middle; }

        /* ‚ïê‚ïê‚ïê NAVBAR AUTH ‚ïê‚ïê‚ïê */
        .nav-auth-wrap { display: flex; align-items: center; margin-left: 12px; }
        .nav-login-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 10px; border: 1px solid rgba(139,92,246,0.5); background: linear-gradient(135deg,rgba(139,92,246,0.2),rgba(168,85,247,0.1)); color: #a78bfa; font-size: 0.82rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.3s; white-space: nowrap; }
        .nav-login-btn:hover { background: linear-gradient(135deg,rgba(139,92,246,0.35),rgba(168,85,247,0.2)); transform: translateY(-1px); }
        .nav-user-btn { display: none; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: #e2e8f0; cursor: pointer; font-family: inherit; font-size: 0.82rem; position: relative; transition: all 0.2s; }
        .nav-user-btn:hover { border-color: rgba(139,92,246,0.4); }
        .nav-user-avatar { width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg,#7c3aed,#a855f7); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 0.7rem; font-weight: 700; flex-shrink: 0; }
        .nav-user-email { max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.78rem; color: #94a3b8; }
        .nav-user-dropdown { display: none; position: absolute; top: calc(100% + 8px); right: 0; min-width: 240px; background: #1e293b; border: 1px solid #334155; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); z-index: 1000; overflow: hidden; }
        .nav-user-dropdown.show { display: block; }
        .nav-dd-header { padding: 16px; border-bottom: 1px solid #334155; }
        .nav-dd-tier-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 50px; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 6px; }
        .nav-dd-tier-badge.pro { background: linear-gradient(135deg,#8b5cf6,#a855f7); color: white; }
        .nav-dd-email { font-size: 0.78rem; color: #64748b; word-break: break-all; }
        .nav-dd-logout { display: flex; align-items: center; gap: 8px; width: 100%; padding: 12px 16px; border: none; background: none; font-size: 0.82rem; font-weight: 500; color: #ef4444; cursor: pointer; font-family: inherit; transition: background 0.2s; }
        .nav-dd-logout:hover { background: rgba(239,68,68,0.08); }

        /* ‚ïê‚ïê‚ïê LOGIN MODAL ‚ïê‚ïê‚ïê */
        .login-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9999; align-items: center; justify-content: center; }
        .login-overlay.show { display: flex; }
        .login-box { background: linear-gradient(135deg,#1e293b 0%,#0f172a 100%); border: 1px solid rgba(139,92,246,0.3); border-radius: 20px; padding: 2.5rem; width: 90%; max-width: 400px; position: relative; animation: loginIn 0.3s ease; }
        @keyframes loginIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .login-close { position: absolute; top: 12px; right: 16px; background: none; border: none; color: #64748b; font-size: 1.4rem; cursor: pointer; padding: 4px; }
        .login-close:hover { color: #e2e8f0; }
        .login-input { width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.05); color: #f1f5f9; font-size: 0.9rem; font-family: inherit; margin-bottom: 12px; box-sizing: border-box; outline: none; transition: border-color 0.2s; }
        .login-input:focus { border-color: rgba(139,92,246,0.6); }
        .login-submit { width: 100%; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(135deg,#7c3aed,#a855f7); color: #fff; font-size: 0.95rem; font-weight: 700; cursor: pointer; font-family: inherit; transition: all 0.3s; }
        .login-submit:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(139,92,246,0.3); }
        @media (max-width: 768px) { .nav-user-email { display: none; } .nav-login-btn .nav-login-text { display: none; } .nav-login-btn { padding: 8px 12px; } }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="page-background"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <div class="nav-logo">OPEX</div>
                <div>
                    <div class="nav-title">OPEX Calculator</div>
                    <div class="nav-subtitle">Operational Cost Analysis</div>
                </div>
            </a>
            <div class="nav-links">
                <a href="datacenter-solutions.html" class="nav-link">DC Solutions</a>
                <a href="datahallAI.html" class="nav-link" style="color: #8b5cf6;">DC AI/HPC</a>
                <a href="dc-conventional.html" class="nav-link">DC Conventional</a>
                <a href="capex-calculator.html" class="nav-link" style="color: #f59e0b;">CAPEX Calc</a>
                <a href="tia-942-checklist.html" class="nav-link" style="color: #10b981;">TIA-942</a>
                <a href="index.html" class="nav-back">
                    <i class="fas fa-arrow-left"></i>
                    Portfolio
                </a>
                <!-- Auth UI -->
                <div class="nav-auth-wrap" id="opexNavAuthWrap">
                    <button class="nav-login-btn" id="opexNavLoginBtn" onclick="opexShowLogin()">
                        <i class="fas fa-user-circle"></i>
                        <span class="nav-login-text">Login</span>
                    </button>
                    <button class="nav-user-btn" id="opexNavUserBtn" onclick="opexToggleDropdown()">
                        <div class="nav-user-avatar" id="opexNavUserAvatar">B</div>
                        <span class="nav-user-email" id="opexNavUserEmail">user@email.com</span>
                        <i class="fas fa-chevron-down" style="font-size:0.6rem;color:#64748b;"></i>
                        <div class="nav-user-dropdown" id="opexNavUserDropdown">
                            <div class="nav-dd-header">
                                <div class="nav-dd-tier-badge pro" id="opexNavDdTierBadge">PRO</div>
                                <div class="nav-dd-email" id="opexNavDdEmail">user@email.com</div>
                            </div>
                            <button class="nav-dd-logout" onclick="opexLogout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="main-content">
        <!-- Hero -->
        <section class="hero">
            <div class="hero-badge">
                <i class="fas fa-calculator"></i>
                Operational Cost Analysis
            </div>
            <h1>Data Center OPEX Calculator</h1>
            <p>Comprehensive operational expenditure analysis with 30+ countries, climate-adjusted calculations, and flexible staffing models</p>
        </section>

        <!-- Brief -->
        <section class="brief-section">
            <div class="brief-card">
                <img src="assets/opex-og.jpg" alt="Data Center OPEX Calculator ‚Äî operational cost analysis with energy, staffing, maintenance, and climate-adjusted breakdown" class="brief-hero-img" loading="eager">
                <p class="brief-lead">CAPEX gets the boardroom attention. OPEX is what actually kills the margin &mdash; year after year, silently.</p>
                <p class="brief-body">Energy alone can eat 40&ndash;60% of your annual operating budget, and that's before you factor in staffing models, maintenance contracts, climate-driven cooling penalties, and the 30+ country-specific variables that turn a "simple" cost projection into a guessing game. This calculator maps all of it: pick your country, set your IT load, choose between in-house, hybrid, or outsourced staffing, and see how geography and climate reshape the numbers. It won't replace a full financial model &mdash; but it will show you where the real cost drivers hide, before they show up in your P&L.</p>
                <div class="brief-stats">
                    <span class="brief-stat"><i class="fas fa-globe"></i> 30+ countries with local rates</span>
                    <span class="brief-stat"><i class="fas fa-users-cog"></i> 3 staffing models</span>
                    <span class="brief-stat"><i class="fas fa-temperature-high"></i> Climate-adjusted PUE</span>
                    <span class="brief-stat"><i class="fas fa-chart-pie"></i> Full cost breakdown</span>
                </div>
                <p class="brief-note">General-purpose estimate &mdash; actual OPEX varies with contract terms, utility tariffs, and operational maturity. Need a tailored projection? Let's talk.</p>
            </div>
        </section>

        <!-- Mode Tabs -->
        <div id="opexModeTabs" style="display:flex;gap:0.5rem;margin-bottom:1.5rem;flex-wrap:wrap;max-width:1400px;margin-left:auto;margin-right:auto;padding:0 2rem;align-items:center;">
            <button type="button" class="opex-mode-btn active" data-mode="simple" onclick="switchOpexMode('simple')" style="padding:0.6rem 1.2rem;border-radius:10px;border:1px solid rgba(16,185,129,0.4);background:rgba(16,185,129,0.15);color:#10b981;cursor:pointer;font-weight:600;font-size:0.9rem;font-family:inherit;transition:all 0.3s;">
                <i class="fas fa-sliders-h" style="margin-right:6px;"></i>Simple
            </button>
            <button type="button" class="opex-mode-btn" data-mode="advanced" onclick="opexTryAdvanced()" style="padding:0.6rem 1.2rem;border-radius:10px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:#94a3b8;cursor:pointer;font-weight:500;font-size:0.9rem;font-family:inherit;transition:all 0.3s;">
                <i class="fas fa-cogs" style="margin-right:6px;"></i>Advanced
            </button>
            <button type="button" id="opexPremiumTabBtn" onclick="opexHandlePremiumTab()" style="padding:0.6rem 1.2rem;border-radius:10px;border:1px solid rgba(139,92,246,0.4);background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(139,92,246,0.05));color:#a78bfa;cursor:pointer;font-weight:600;font-size:0.9rem;font-family:inherit;transition:all 0.3s;margin-left:auto;">
                <i class="fas fa-crown" style="margin-right:6px;"></i>Premium
            </button>
            <span id="opexPremiumBadge"></span>
        </div>

        <!-- Calculator -->
        <div class="calculator-container">
            <!-- Input Panel -->
            <div class="input-panel">
                <!-- Scenario B indicator (shown after Save Scenario A) -->
                <div id="opexScenarioBBanner" style="display:none;padding:10px 16px;border-radius:10px;background:linear-gradient(135deg,rgba(52,211,153,0.15),rgba(16,185,129,0.08));border:1.5px solid rgba(16,185,129,0.4);margin-bottom:0.75rem;align-items:center;gap:10px;">
                    <span style="width:28px;height:28px;border-radius:8px;background:rgba(52,211,153,0.2);color:#34d399;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;flex-shrink:0;">B</span>
                    <div>
                        <div style="font-size:0.85rem;font-weight:600;color:#059669;">Scenario B Input</div>
                        <div style="font-size:0.72rem;color:#6b7280;">Modify the inputs below to configure Scenario B for comparison</div>
                    </div>
                </div>
                <!-- Country Selection -->
                <div class="input-section">
                    <div class="section-title">
                        <i class="fas fa-globe"></i>
                        Location
                    </div>
                    <div class="input-group">
                        <label class="input-label">Country / Region
                            <span class="info-tooltip">
                                <i class="fas fa-question"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-globe"></i> Country / Region</div>
                                    <div class="tooltip-desc">Location affects labor costs, electricity rates, and climate factors.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Factor</th><th>Impact</th></tr>
                                        <tr><td>Labor Rate</td><td>0.2x - 2.5x baseline</td></tr>
                                        <tr><td>Energy Rate</td><td>$0.03 - $0.25/kWh</td></tr>
                                        <tr><td>Climate</td><td>Affects cooling costs</td></tr>
                                    </table>
                                </span>
                            </span>
                        </label>
                        <div class="country-select-wrapper">
                            <span class="country-flag" id="selectedFlag">üáÆüá©</span>
                            <select class="country-select input-field" id="countrySelect" onchange="updateCalculation()">
                                <optgroup label="ASEAN">
                                    <option value="ID" selected>Indonesia</option>
                                    <option value="MY">Malaysia</option>
                                    <option value="SG">Singapore</option>
                                    <option value="TH">Thailand</option>
                                    <option value="VN">Vietnam</option>
                                    <option value="PH">Philippines</option>
                                </optgroup>
                                <optgroup label="Asia Pacific">
                                    <option value="JP">Japan</option>
                                    <option value="KR">South Korea</option>
                                    <option value="TW">Taiwan</option>
                                    <option value="HK">Hong Kong</option>
                                    <option value="CN">China (Tier 1)</option>
                                    <option value="CN2">China (Tier 2)</option>
                                    <option value="IN">India</option>
                                    <option value="AU">Australia</option>
                                </optgroup>
                                <optgroup label="Middle East">
                                    <option value="AE">UAE (Dubai)</option>
                                    <option value="SA">Saudi Arabia</option>
                                    <option value="QA">Qatar</option>
                                </optgroup>
                                <optgroup label="Europe">
                                    <option value="GB">United Kingdom</option>
                                    <option value="DE">Germany</option>
                                    <option value="NL">Netherlands</option>
                                    <option value="IE">Ireland</option>
                                    <option value="FR">France</option>
                                    <option value="PT">Portugal</option>
                                    <option value="SE">Sweden</option>
                                    <option value="NO">Norway</option>
                                    <option value="CH">Switzerland</option>
                                </optgroup>
                                <optgroup label="Americas">
                                    <option value="US-VA">USA (Virginia)</option>
                                    <option value="US-TX">USA (Texas)</option>
                                    <option value="US-CA">USA (California)</option>
                                    <option value="CA">Canada</option>
                                    <option value="BR">Brazil</option>
                                    <option value="MX">Mexico</option>
                                </optgroup>
                            </select>
                            <i class="fas fa-chevron-down country-select-arrow"></i>
                        </div>
                    </div>
                    <div id="countryInfo" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                        <div><strong>Labor:</strong> <span id="laborMult">1.00x</span> | <strong>Energy:</strong> <span id="energyRate">$0.075/kWh</span></div>
                    </div>
                </div>

                <!-- Facility Parameters -->
                <div class="input-section">
                    <div class="section-title">
                        <i class="fas fa-building"></i>
                        Facility Parameters
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            IT Load (kW)
                            <span class="info-tooltip">
                                <i class="fas fa-question"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-bolt"></i> IT Load (kW)</div>
                                    <div class="tooltip-desc">Total power consumption of all IT equipment including servers, storage, and network devices.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Category</th><th>Range</th></tr>
                                        <tr><td>Small/Edge DC</td><td>100-500 kW</td></tr>
                                        <tr><td>Medium DC</td><td>500-2,000 kW</td></tr>
                                        <tr><td>Large DC</td><td>2-10 MW</td></tr>
                                        <tr><td>Hyperscale</td><td>10+ MW</td></tr>
                                    </table>
                                </span>
                            </span>
                        </label>
                        <input type="number" class="input-field" id="itLoad" value="1000" min="100" max="100000" onchange="updateCalculation()">
                    </div>

                    <div class="input-group">
                        <div class="slider-container">
                            <div class="slider-header">
                                <label class="input-label">
                                    PUE
                                    <span class="info-tooltip">
                                        <i class="fas fa-question"></i>
                                        <span class="tooltip-content">
                                            <div class="tooltip-title"><i class="fas fa-tachometer-alt"></i> Power Usage Effectiveness</div>
                                            <div class="tooltip-desc">Ratio of total facility power to IT equipment power. Lower = more efficient.</div>
                                            <table class="tooltip-table">
                                                <tr><th>PUE Range</th><th>Rating</th></tr>
                                                <tr><td>1.1 - 1.3</td><td>Excellent</td></tr>
                                                <tr><td>1.3 - 1.5</td><td>Good</td></tr>
                                                <tr><td>1.5 - 1.8</td><td>Average</td></tr>
                                                <tr><td>1.8 - 2.0</td><td>Legacy</td></tr>
                                            </table>
                                            <div class="tooltip-note">Formula: PUE = Total Facility Power / IT Equipment Power</div>
                                        </span>
                                    </span>
                                </label>
                                <span class="slider-value" id="pueValue">1.50</span>
                            </div>
                            <input type="range" class="slider" id="pueSlider" min="1.1" max="2.0" step="0.05" value="1.5" onchange="updatePUE()">
                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <span>1.1 (Best)</span>
                                <span>2.0 (Legacy)</span>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            Tier Classification
                            <span class="info-tooltip">
                                <i class="fas fa-question"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-layer-group"></i> Uptime Institute Tier</div>
                                    <div class="tooltip-desc">Industry standard classification for data center availability and redundancy.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Tier</th><th>Uptime</th></tr>
                                        <tr><td>Tier I - Basic</td><td>99.67%</td></tr>
                                        <tr><td>Tier II - Redundant</td><td>99.74%</td></tr>
                                        <tr><td>Tier III - Concurrent</td><td>99.98%</td></tr>
                                        <tr><td>Tier IV - Fault Tolerant</td><td>99.99%</td></tr>
                                    </table>
                                    <div class="tooltip-note">Higher tier = more redundancy = higher staffing & maintenance costs</div>
                                </span>
                            </span>
                        </label>
                        <select class="input-field" id="tierLevel" onchange="updateCalculation()">
                            <option value="1">Tier I - Basic (99.67%)</option>
                            <option value="2">Tier II - Redundant (99.74%)</option>
                            <option value="3" selected>Tier III - Concurrent (99.98%)</option>
                            <option value="4">Tier IV - Fault Tolerant (99.99%)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            Facility Age
                            <span class="info-tooltip">
                                <i class="fas fa-question"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-calendar-alt"></i> Facility Age</div>
                                    <div class="tooltip-desc">Age of facility affects maintenance costs due to equipment wear and warranty status.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Age</th><th>Cost Factor</th></tr>
                                        <tr><td>New (0-3 yrs)</td><td>0.6x</td></tr>
                                        <tr><td>Mid-Life (4-10 yrs)</td><td>1.0x</td></tr>
                                        <tr><td>Mature (10+ yrs)</td><td>1.5x</td></tr>
                                    </table>
                                    <div class="tooltip-note">Older facilities require more maintenance & spare parts</div>
                                </span>
                            </span>
                        </label>
                        <select class="input-field" id="facilityAge" onchange="updateCalculation()">
                            <option value="new">New (0-3 years)</option>
                            <option value="mid" selected>Mid-Life (4-10 years)</option>
                            <option value="mature">Mature (10+ years)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <div class="slider-container">
                            <div class="slider-header">
                                <label class="input-label">
                                    Utilization
                                    <span class="info-tooltip">
                                        <i class="fas fa-question"></i>
                                        <span class="tooltip-content">
                                            <div class="tooltip-title"><i class="fas fa-chart-line"></i> Capacity Utilization</div>
                                            <div class="tooltip-desc">Percentage of installed IT capacity currently in use. Affects energy consumption calculations.</div>
                                            <table class="tooltip-table">
                                                <tr><th>Utilization</th><th>Status</th></tr>
                                                <tr><td>30-50%</td><td>Low / Growing</td></tr>
                                                <tr><td>50-70%</td><td>Optimal</td></tr>
                                                <tr><td>70-85%</td><td>High</td></tr>
                                                <tr><td>85-95%</td><td>Near Capacity</td></tr>
                                            </table>
                                        </span>
                                    </span>
                                </label>
                                <span class="slider-value" id="utilizationValue">70%</span>
                            </div>
                            <input type="range" class="slider" id="utilizationSlider" min="30" max="95" step="5" value="70" onchange="updateUtilization()">
                        </div>
                    </div>
                </div>

                <!-- Climate & System Configuration -->
                <div class="input-section">
                    <div class="section-title">
                        <i class="fas fa-temperature-high"></i>
                        Climate & System Config
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            Climate Zone
                            <span class="info-tooltip">
                                <i class="fas fa-question"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-globe"></i> Climate Zone</div>
                                    <div class="tooltip-desc">Climate significantly affects cooling energy consumption and free cooling potential.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Zone</th><th>Cooling Factor</th></tr>
                                        <tr><td>Tropical Humid</td><td>1.00x (baseline)</td></tr>
                                        <tr><td>Tropical Dry</td><td>0.92x</td></tr>
                                        <tr><td>Subtropical</td><td>0.88x</td></tr>
                                        <tr><td>Temperate</td><td>0.75x</td></tr>
                                        <tr><td>Cold Climate</td><td>0.55x</td></tr>
                                    </table>
                                    <div class="tooltip-note">Cold climates enable economizer/free cooling hours</div>
                                </span>
                            </span>
                        </label>
                        <select class="input-field" id="climateZone" onchange="updateCalculation()">
                            <option value="tropical_humid" selected>Tropical Humid (Indonesia, MY, SG)</option>
                            <option value="tropical_dry">Tropical Dry (UAE, Saudi)</option>
                            <option value="subtropical">Subtropical (HK, TW, AU-QLD)</option>
                            <option value="temperate">Temperate (EU, JP, KR)</option>
                            <option value="continental">Continental (US-Central, CA)</option>
                            <option value="cold">Cold Climate (Nordic, US-North)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            Cooling System Type
                            <span class="info-tooltip">
                                <i class="fas fa-question"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-snowflake"></i> Cooling Technology</div>
                                    <div class="tooltip-desc">Primary cooling technology affects efficiency, water usage, and maintenance costs.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Type</th><th>Efficiency</th></tr>
                                        <tr><td>Air-Cooled Chiller</td><td>Standard</td></tr>
                                        <tr><td>Water-Cooled Chiller</td><td>Good</td></tr>
                                        <tr><td>In-Row (CRAC)</td><td>Good</td></tr>
                                        <tr><td>RDHX</td><td>Better</td></tr>
                                        <tr><td>DLC / Immersion</td><td>Best</td></tr>
                                    </table>
                                    <div class="tooltip-note">DLC = Direct Liquid Cooling, RDHX = Rear Door Heat Exchanger</div>
                                </span>
                            </span>
                        </label>
                        <select class="input-field" id="coolingType" onchange="updateCalculation()">
                            <option value="air_chiller">Air-Cooled Chiller (Standard)</option>
                            <option value="water_chiller" selected>Water-Cooled Chiller (Efficient)</option>
                            <option value="free_cooling">Hybrid Free Cooling</option>
                            <option value="inrow">In-Row Cooling (CRAC)</option>
                            <option value="rdhx">Rear-Door Heat Exchanger (RDHX)</option>
                            <option value="dlc">Direct Liquid Cooling (DLC)</option>
                            <option value="immersion">Immersion Cooling</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            Generator Configuration
                            <span class="info-tooltip">
                                <i class="fas fa-question"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-car-battery"></i> Generator Redundancy</div>
                                    <div class="tooltip-desc">Backup power configuration determines maintenance scope and fuel reserve requirements.</div>
                                    <table class="tooltip-table">
                                        <tr><th>Config</th><th>Maint. Factor</th></tr>
                                        <tr><td>N (No backup)</td><td>1.0x</td></tr>
                                        <tr><td>N+1 (Standard)</td><td>1.3x</td></tr>
                                        <tr><td>2N (Full)</td><td>2.1x</td></tr>
                                        <tr><td>2N+1 (Tier IV)</td><td>2.4x</td></tr>
                                    </table>
                                    <div class="tooltip-note">All configs: Monthly warming + 6M/12M overhaul</div>
                                </span>
                            </span>
                        </label>
                        <select class="input-field" id="genConfig" onchange="updateCalculation()">
                            <option value="N">N (No Redundancy)</option>
                            <option value="N1" selected>N+1 (Standard Tier III)</option>
                            <option value="2N">2N (Full Redundancy)</option>
                            <option value="2N1">2N+1 (Tier IV)</option>
                        </select>
                    </div>

                    <div id="climateInfo" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                        <div><strong>Cooling Energy:</strong> <span id="coolingEnergyFactor">1.00x</span> | <strong>Free Cooling:</strong> <span id="freeCoolingHours">0 hrs/yr</span></div>
                    </div>
                </div>

                <!-- Staffing Model -->
                <div class="input-section">
                    <div class="section-title">
                        <i class="fas fa-users"></i>
                        Staffing Model
                        <span class="info-tooltip" style="margin-left: 8px;">
                            <i class="fas fa-question" style="font-size: 0.7rem;"></i>
                            <span class="tooltip-content">
                                <div class="tooltip-title"><i class="fas fa-users-cog"></i> Staffing Model</div>
                                <div class="tooltip-desc">Choose how to staff your data center operations.</div>
                                <table class="tooltip-table">
                                    <tr><th>Model</th><th>Effect</th></tr>
                                    <tr><td>In-House</td><td>Full headcount, lower per-person cost</td></tr>
                                    <tr><td>Partial (Hybrid)</td><td>Blended efficiency</td></tr>
                                    <tr><td>Full Contractor</td><td>~30% fewer FTE, higher per-person rate, net 10-15% savings</td></tr>
                                </table>
                                <div class="tooltip-note">Contractor: fewer staff (multi-skilled), no training/cert cost, but higher OEM maintenance rates. Management stays in-house.</div>
                            </span>
                        </span>
                    </div>

                    <div class="staffing-models">
                        <div class="model-card active" data-model="inhouse" onclick="selectStaffingModel('inhouse')">
                            <i class="fas fa-building"></i>
                            <div class="model-name">In-House</div>
                            <div class="model-desc">100% Own Staff</div>
                            <span class="info-tooltip" style="position:absolute;top:4px;right:4px;">
                                <i class="fas fa-question" style="font-size: 0.55rem;"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-building"></i> Full In-House Model</div>
                                    <div class="tooltip-desc">All operations staff are direct employees on your payroll.</div>
                                    <table class="tooltip-table">
                                        <tr><td>FTE Count</td><td>Full headcount (~23 FTE for 1MW Tier 3)</td></tr>
                                        <tr><td>Cost Factor</td><td>1.42x base salary (BPJS, THR, leave, overhead)</td></tr>
                                        <tr><td>Training</td><td>Owner funds all: K3 Listrik, manufacturer certs, safety training</td></tr>
                                        <tr><td>Spare Parts</td><td>Owner manages & funds 100% of critical spare parts inventory</td></tr>
                                        <tr><td>Maintenance</td><td>In-house labor = baseline cost (no OEM premium)</td></tr>
                                    </table>
                                </span>
                            </span>
                        </div>
                        <div class="model-card" data-model="partial" onclick="selectStaffingModel('partial')">
                            <i class="fas fa-handshake"></i>
                            <div class="model-name">Partial</div>
                            <div class="model-desc">Hybrid Mix</div>
                            <span class="info-tooltip" style="position:absolute;top:4px;right:4px;">
                                <i class="fas fa-question" style="font-size: 0.55rem;"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-handshake"></i> Partial (Hybrid) Model</div>
                                    <div class="tooltip-desc">Blend of in-house management + outsourced technical staff.</div>
                                    <table class="tooltip-table">
                                        <tr><td>Management</td><td>Biased toward in-house (+20% above slider)</td></tr>
                                        <tr><td>Technicians</td><td>Split per slider; contractor portion gets efficiency benefit</td></tr>
                                        <tr><td>Support</td><td>Biased toward contractor (-20% below slider)</td></tr>
                                        <tr><td>Spare Parts</td><td>Shared: ~55% owner-managed, rest under contractor scope</td></tr>
                                        <tr><td>Maintenance</td><td>Blended OEM factor based on contractor percentage</td></tr>
                                    </table>
                                    <div class="tooltip-note">Use the slider to adjust the in-house / contractor ratio (10%-90%).</div>
                                </span>
                            </span>
                        </div>
                        <div class="model-card" data-model="contractor" onclick="selectStaffingModel('contractor')">
                            <i class="fas fa-user-tie"></i>
                            <div class="model-name">Contractor</div>
                            <div class="model-desc">100% Outsource</div>
                            <span class="info-tooltip" style="position:absolute;top:4px;right:4px;">
                                <i class="fas fa-question" style="font-size: 0.55rem;"></i>
                                <span class="tooltip-content">
                                    <div class="tooltip-title"><i class="fas fa-user-tie"></i> Full Contractor Model</div>
                                    <div class="tooltip-desc">All technical operations outsourced to a maintenance contractor (All-Risk contract).</div>
                                    <table class="tooltip-table">
                                        <tr><td>FTE Reduction</td><td>~30-35% fewer people (multi-skilled workers)</td></tr>
                                        <tr><td>Cost Factor</td><td>1.75x base salary (margin, overhead, profit)</td></tr>
                                        <tr><td>Training</td><td>Contractor handles all: K3, manufacturer certs, LOTO, etc.</td></tr>
                                        <tr><td>Spare Parts</td><td>Contractor holds 85% under All-Risk warranty; owner keeps 15% buffer</td></tr>
                                        <tr><td>Maintenance</td><td>OEM premium (1.8-2.5x) but contractor absorbs corrective risk</td></tr>
                                    </table>
                                    <div class="tooltip-note">Management (Facility Mgr, Maintenance SPV) stays in-house for oversight. 1 Contract Admin added for permit/work order management.</div>
                                </span>
                            </span>
                        </div>
                    </div>

                    <div class="partial-controls" id="partialControls">
                        <div class="partial-labels">
                            <span class="inhouse">In-House: <span id="inhousePercent">70</span>%</span>
                            <span class="contractor">Contractor: <span id="contractorPercent">30</span>%</span>
                        </div>
                        <input type="range" class="slider" id="partialSlider" min="10" max="90" step="5" value="70" onchange="updatePartialSplit()">
                    </div>
                </div>

                <!-- ‚ïê‚ïê‚ïê ADVANCED OPEX INPUTS (hidden by default) ‚ïê‚ïê‚ïê -->
                <div id="opexAdvancedInputs" style="display:none;">

                    <!-- Year & Energy -->
                    <div class="input-section">
                        <div class="section-title" style="color:#10b981;">
                            <i class="fas fa-calendar-alt"></i> Year & Energy Contract
                        </div>
                        <div class="input-group">
                            <label class="input-label">Projection Year
                                <span class="info-tooltip"><i class="fas fa-question"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-calendar"></i> OPEX Year Escalation</div>
                                        <div class="tooltip-desc">Energy and labor costs escalate at different rates based on market conditions.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Year</th><th>Energy</th><th>Labor</th></tr>
                                            <tr><td>2025</td><td>1.000x</td><td>1.000x</td></tr>
                                            <tr><td>2026</td><td>1.045x</td><td>1.055x</td></tr>
                                            <tr><td>2027</td><td>1.085x</td><td>1.110x</td></tr>
                                            <tr><td>2028</td><td>1.115x</td><td>1.165x</td></tr>
                                            <tr><td>2029</td><td>1.140x</td><td>1.220x</td></tr>
                                            <tr><td>2030</td><td>1.160x</td><td>1.275x</td></tr>
                                        </table>
                                    </span>
                                </span>
                            </label>
                            <select class="input-field" id="opexProjYear" onchange="updateCalculation()">
                                <option value="2025" selected>2025 (Baseline)</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Energy Contract Type
                                <span class="info-tooltip"><i class="fas fa-question"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-file-contract"></i> Energy Contract</div>
                                        <div class="tooltip-desc">Type of power purchase agreement affects energy cost stability and pricing.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Type</th><th>Impact</th></tr>
                                            <tr><td>Spot Market</td><td>Variable, ¬±15%</td></tr>
                                            <tr><td>Fixed PPA</td><td>Stable, baseline</td></tr>
                                            <tr><td>Green PPA</td><td>+5-15% premium</td></tr>
                                            <tr><td>Hybrid</td><td>70% fixed + 30% spot</td></tr>
                                        </table>
                                    </span>
                                </span>
                            </label>
                            <select class="input-field" id="energyContract" onchange="updateCalculation()">
                                <option value="spot">Spot Market (variable)</option>
                                <option value="fixed" selected>Fixed PPA (baseline)</option>
                                <option value="green">Green PPA (+10%)</option>
                                <option value="hybrid">Hybrid (70/30 blend)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Maintenance & Insurance -->
                    <div class="input-section">
                        <div class="section-title" style="color:#3b82f6;">
                            <i class="fas fa-wrench"></i> Contracts & Coverage
                        </div>
                        <div class="input-group">
                            <label class="input-label">Maintenance Contract Level
                                <span class="info-tooltip"><i class="fas fa-question"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-wrench"></i> Maintenance Contract</div>
                                        <div class="tooltip-desc">Level of maintenance coverage in your service contract.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Level</th><th>Scope</th><th>Factor</th></tr>
                                            <tr><td>Basic</td><td>Breakdown/corrective only, no scheduled PM</td><td>0.7x</td></tr>
                                            <tr><td>Comprehensive</td><td>Full preventive + corrective program</td><td>1.0x</td></tr>
                                            <tr><td>All-Risk</td><td>Full warranty incl. parts replacement</td><td>1.4x</td></tr>
                                        </table>
                                    </span>
                                </span>
                            </label>
                            <select class="input-field" id="maintLevel" onchange="updateCalculation()">
                                <option value="basic">Basic (breakdown only)</option>
                                <option value="comprehensive" selected>Comprehensive (preventive)</option>
                                <option value="allrisk">All-Risk (full coverage, +40%)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Insurance Coverage
                                <span class="info-tooltip"><i class="fas fa-question"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-shield-alt"></i> Insurance Coverage</div>
                                        <div class="tooltip-desc">Level of insurance protection for the facility.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Level</th><th>Coverage</th><th>Factor</th></tr>
                                            <tr><td>Standard</td><td>Basic property + liability</td><td>1.0x</td></tr>
                                            <tr><td>Comprehensive</td><td>+ Business interruption, expanded cyber</td><td>1.3x</td></tr>
                                            <tr><td>Full Replacement</td><td>Full rebuild + extended BI coverage</td><td>1.6x</td></tr>
                                        </table>
                                    </span>
                                </span>
                            </label>
                            <select class="input-field" id="insuranceLevel" onchange="updateCalculation()">
                                <option value="standard" selected>Standard</option>
                                <option value="comprehensive">Comprehensive (+30%)</option>
                                <option value="full">Full Replacement (+60%)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Software & DCIM
                                <span class="info-tooltip"><i class="fas fa-question"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-laptop-code"></i> Software & DCIM Level</div>
                                        <div class="tooltip-desc">Additional DCIM platform cost on top of base software licensing (CMMS, BMS, monitoring, cybersecurity).</div>
                                        <table class="tooltip-table">
                                            <tr><th>Level</th><th>Features</th><th>Cost</th></tr>
                                            <tr><td>Basic</td><td>Asset tracking, basic monitoring</td><td>$2/kW/yr</td></tr>
                                            <tr><td>Enterprise</td><td>+ Capacity planning, analytics, alerts</td><td>$5/kW/yr</td></tr>
                                            <tr><td>AI-Ops</td><td>+ Predictive analytics, auto-optimization</td><td>$12/kW/yr</td></tr>
                                        </table>
                                        <div class="tooltip-note">This adds to the base ~$16.50/kW/yr software cost (BMS, CMMS, monitoring, cybersecurity).</div>
                                    </span>
                                </span>
                            </label>
                            <select class="input-field" id="dcimLevel" onchange="updateCalculation()">
                                <option value="basic">Basic DCIM ($2/kW/yr)</option>
                                <option value="enterprise" selected>Enterprise DCIM ($5/kW/yr)</option>
                                <option value="aiops">AI-Ops Platform ($12/kW/yr)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Staffing Advanced -->
                    <div class="input-section">
                        <div class="section-title" style="color:#8b5cf6;">
                            <i class="fas fa-users-cog"></i> Staffing Details
                        </div>
                        <div class="input-group">
                            <label class="input-label">Overtime & Holiday Premium: <span id="overtimeVal" style="color:#8b5cf6;font-family:'JetBrains Mono',monospace;">15%</span>
                                <span class="info-tooltip"><i class="fas fa-question"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-clock"></i> Overtime Premium</div>
                                        <div class="tooltip-desc">Additional labor cost for overtime, holiday, and shift differentials. Applied as a multiplier on total staffing cost.</div>
                                        <div class="tooltip-note">Indonesia labor law: overtime = 1.5x first hour, 2x subsequent hours. Holiday premium = 2x base. Typical DC average: 10-20% of base staffing.</div>
                                    </span>
                                </span>
                            </label>
                            <input type="range" class="slider" id="overtimePremium" min="0" max="30" value="15" step="5" oninput="document.getElementById('overtimeVal').textContent=this.value+'%';updateCalculation();" style="accent-color:#8b5cf6;">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Contract Type
                                <span class="info-tooltip"><i class="fas fa-question"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-file-contract"></i> Contract Type</div>
                                        <div class="tooltip-desc">Employment arrangement affects staffing cost efficiency.</div>
                                        <table class="tooltip-table">
                                            <tr><th>Type</th><th>Description</th><th>Factor</th></tr>
                                            <tr><td>Full-time 24/7</td><td>4-5 shift teams, full rotation</td><td>1.0x</td></tr>
                                            <tr><td>Shift-based</td><td>12hr rotating, 2-team model</td><td>0.92x</td></tr>
                                            <tr><td>On-call</td><td>Business hours + standby premium</td><td>0.75x</td></tr>
                                        </table>
                                        <div class="tooltip-note">On-call model only suitable for Tier 1-2. Tier 3-4 requires 24/7 coverage.</div>
                                    </span>
                                </span>
                            </label>
                            <select class="input-field" id="contractType" onchange="updateCalculation()">
                                <option value="fulltime" selected>Full-time (24/7 shifts)</option>
                                <option value="shift">Shift-based (12hr rotating)</option>
                                <option value="oncall">On-call (business hours + standby)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- ‚ïê‚ïê‚ïê END ADVANCED OPEX ‚ïê‚ïê‚ïê -->
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <!-- Summary Card -->
                <div class="summary-card fade-in">
                    <div class="summary-header">
                        <span class="summary-title">ANNUAL OPEX SUMMARY</span>
                        <div class="country-badge">
                            <span id="summaryFlag">üáÆüá©</span>
                            <span id="summaryCountry">Indonesia</span>
                        </div>
                    </div>
                    <div class="total-opex" id="totalOpex">$1,245,000</div>
                    <div class="total-label">Total Annual Operational Expenditure
                        <span class="info-tooltip" style="margin-left: 4px;">
                            <i class="fas fa-question" style="font-size: 0.7rem;"></i>
                            <span class="tooltip-content">
                                <div class="tooltip-title"><i class="fas fa-dollar-sign"></i> Total OPEX</div>
                                <div class="tooltip-desc">Annual operational expenditure including staffing, maintenance, energy, insurance, and other recurring costs to run the facility.</div>
                            </span>
                        </span>
                    </div>
                    <div class="summary-metrics">
                        <div class="metric-item">
                            <div class="metric-value" id="monthlyOpex">$103.8K</div>
                            <div class="metric-label">Per Month
                                <span class="info-tooltip" style="margin-left: 2px;">
                                    <i class="fas fa-question" style="font-size: 0.6rem;"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-calendar-alt"></i> Monthly OPEX</div>
                                        <div class="tooltip-desc">Total annual OPEX divided by 12 months. Useful for budgeting and cash flow planning.</div>
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="perKwOpex">$1,245</div>
                            <div class="metric-label">Per kW/Year
                                <span class="info-tooltip" style="margin-left: 2px;">
                                    <i class="fas fa-question" style="font-size: 0.6rem;"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-calculator"></i> OPEX per kW/Year</div>
                                        <div class="tooltip-desc">Industry benchmark: Total OPEX √∑ IT Load. Typical range: $800-2,000/kW/year depending on location and tier level.</div>
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="perKwhOpex">$0.14</div>
                            <div class="metric-label">Per kWh
                                <span class="info-tooltip" style="margin-left: 2px;">
                                    <i class="fas fa-question" style="font-size: 0.6rem;"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-plug"></i> Effective $/kWh</div>
                                        <div class="tooltip-desc">Total OPEX divided by annual energy consumption. Combines electricity cost with all other operating costs per kWh delivered.</div>
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="totalFte">24</div>
                            <div class="metric-label">Total FTE
                                <span class="info-tooltip" style="margin-left: 2px;">
                                    <i class="fas fa-question" style="font-size: 0.6rem;"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-users"></i> Full-Time Equivalent</div>
                                        <div class="tooltip-desc">Total staff headcount required. Includes management, engineers, technicians, operators, and support staff. Covers 24/7 shift operations.</div>
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Toolbar (Save, Export, Clear) -->
                <div id="opexActionToolbar" style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:0.75rem;">
                    <button onclick="saveOpexScenarioA()" id="btnSaveOpexA" style="padding:12px 8px;border-radius:10px;border:1px solid rgba(16,185,129,0.5);background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(16,185,129,0.05));color:#10b981;cursor:pointer;font-weight:600;font-size:0.85rem;font-family:inherit;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:6px;">
                        <i class="fas fa-bookmark"></i> Save Scenario A
                    </button>
                    <button onclick="exportOpexPDF()" style="padding:12px 8px;border-radius:10px;border:1px solid var(--glass-border);background:var(--bg-secondary);color:var(--text-secondary);cursor:pointer;font-weight:500;font-size:0.85rem;font-family:inherit;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:6px;">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button onclick="clearOpexComparison()" id="btnClearOpex" style="display:none;padding:12px 8px;border-radius:10px;border:1px solid rgba(239,68,68,0.4);background:linear-gradient(135deg,rgba(239,68,68,0.1),rgba(239,68,68,0.03));color:#ef4444;cursor:pointer;font-weight:600;font-size:0.85rem;font-family:inherit;transition:all 0.3s;align-items:center;justify-content:center;gap:6px;grid-column:1/-1;">
                        <i class="fas fa-times-circle"></i> Clear Comparison
                    </button>
                </div>
                <!-- Saved indicator -->
                <div id="opexSavedIndicator" style="display:none;margin-top:0.5rem;padding:8px 12px;border-radius:8px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.25);font-size:0.78rem;color:#10b981;text-align:center;">
                    <i class="fas fa-check-circle" style="margin-right:4px;"></i> Scenario A saved ‚Äî change inputs to create Scenario B
                </div>

                <!-- Compare Panel (Scenario A vs B summary) -->
                <div id="opexComparePanel" style="display:none;margin-top:0.75rem;">
                    <div style="background:var(--bg-secondary);border-radius:16px;padding:1.25rem;border:1px solid var(--glass-border);">
                        <div style="font-size:0.9rem;font-weight:700;color:var(--dark-blue);display:flex;align-items:center;gap:8px;margin-bottom:1rem;">
                            <i class="fas fa-columns" style="color:#10b981;"></i> Scenario Comparison
                        </div>
                        <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:1rem;align-items:stretch;" id="opexCompareGrid">
                            <div id="opexScenarioACard" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);border-radius:14px;padding:1.25rem;color:white;"></div>
                            <div id="opexDeltaColumn" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0.5rem;gap:0.75rem;min-width:80px;"></div>
                            <div id="opexScenarioBCard" style="background:linear-gradient(135deg,#1a4731,#2d6a4f);border-radius:14px;padding:1.25rem;color:white;"></div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card fade-in">
                        <div class="chart-title">
                            <i class="fas fa-chart-pie"></i>
                            Cost Breakdown
                        </div>
                        <div class="chart-container">
                            <canvas id="breakdownChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card fade-in">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            Category Comparison
                        </div>
                        <div class="chart-container">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Cost Breakdown Table -->
                <div class="breakdown-card fade-in">
                    <div class="chart-title">
                        <i class="fas fa-list-alt"></i>
                        Detailed Cost Breakdown
                        <span class="info-tooltip" style="margin-left: 6px;">
                            <i class="fas fa-question" style="font-size: 0.65rem;"></i>
                            <span class="tooltip-content">
                                <div class="tooltip-title"><i class="fas fa-list-alt"></i> OPEX Cost Categories</div>
                                <div class="tooltip-desc">Comprehensive breakdown of all annual operational costs.</div>
                                <table class="tooltip-table">
                                    <tr><th>Category</th><th>Includes</th></tr>
                                    <tr><td>Energy</td><td>IT load + cooling + overhead electricity</td></tr>
                                    <tr><td>Staffing</td><td>Salaries, benefits (BPJS/THR), contractor fees</td></tr>
                                    <tr><td>Maint & Spares</td><td>Preventive/corrective maintenance + critical spare parts inventory</td></tr>
                                    <tr><td>Software</td><td>DCIM, BMS, CMMS, monitoring, cybersecurity licenses</td></tr>
                                    <tr><td>Insurance</td><td>Property, business interruption, cyber + compliance certs</td></tr>
                                    <tr><td>Utilities</td><td>Water, diesel fuel, telecom, security systems, consumables</td></tr>
                                    <tr><td>Other</td><td>Staff training (in-house only), miscellaneous</td></tr>
                                </table>
                                <div class="tooltip-note">$/kW/Year = category cost divided by IT Load. Industry benchmark for total OPEX: $800-2,000/kW/yr.</div>
                            </span>
                        </span>
                    </div>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Annual Cost</th>
                                <th>% of Total</th>
                                <th>$/kW/Year</th>
                                <th>Distribution</th>
                            </tr>
                        </thead>
                        <tbody id="breakdownTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Staffing Breakdown -->
                <div class="breakdown-card fade-in">
                    <div class="chart-title">
                        <i class="fas fa-users-cog"></i>
                        Staffing Breakdown
                        <span class="info-tooltip" style="margin-left: 6px;">
                            <i class="fas fa-question" style="font-size: 0.65rem;"></i>
                            <span class="tooltip-content">
                                <div class="tooltip-title"><i class="fas fa-users-cog"></i> Staffing Cost Detail</div>
                                <div class="tooltip-desc">Full personnel breakdown by role, split between in-house and contractor staff.</div>
                                <table class="tooltip-table">
                                    <tr><th>Column</th><th>Description</th></tr>
                                    <tr><td>FTE</td><td>Full-Time Equivalents (actual headcount after efficiency)</td></tr>
                                    <tr><td>In-House</td><td>Your direct employees (salary √ó 1.42x for BPJS, THR, leave, etc.)</td></tr>
                                    <tr><td>Contractor</td><td>Outsourced staff (salary √ó 1.75x for margin, overhead, profit)</td></tr>
                                    <tr><td>Annual Cost</td><td>Total cost = In-House cost + Contractor cost per role</td></tr>
                                </table>
                                <div class="tooltip-note">Contractor model: Multi-skilled workers reduce FTE by ~30-35%. Management (Facility Manager, Maintenance Supervisor) always stays in-house for oversight.</div>
                            </span>
                        </span>
                        <span style="margin-left: auto; font-size: 0.8rem; font-weight: 500; color: var(--text-muted);" id="staffingModelLabel">Full In-House</span>
                    </div>
                    <table class="staffing-table">
                        <thead>
                            <tr>
                                <th>Role</th>
                                <th>FTE
                                    <span class="info-tooltip" style="margin-left: 2px;">
                                        <i class="fas fa-question" style="font-size: 0.55rem;"></i>
                                        <span class="tooltip-content">
                                            <div class="tooltip-title"><i class="fas fa-users"></i> Full-Time Equivalent</div>
                                            <div class="tooltip-desc">Total headcount for this role after contractor efficiency adjustments. In-House: full count. Contractor: ~65-85% of base count due to multi-skilled workers covering multiple roles.</div>
                                        </span>
                                    </span>
                                </th>
                                <th>In-House
                                    <span class="info-tooltip" style="margin-left: 2px;">
                                        <i class="fas fa-question" style="font-size: 0.55rem;"></i>
                                        <span class="tooltip-content">
                                            <div class="tooltip-title"><i class="fas fa-building"></i> In-House Staff</div>
                                            <div class="tooltip-desc">Direct employees on your payroll. Cost includes: base salary √ó 13 months (THR), BPJS (health + employment), annual leave provision, and overhead (1.42x multiplier).</div>
                                        </span>
                                    </span>
                                </th>
                                <th>Contractor
                                    <span class="info-tooltip" style="margin-left: 2px;">
                                        <i class="fas fa-question" style="font-size: 0.55rem;"></i>
                                        <span class="tooltip-content">
                                            <div class="tooltip-title"><i class="fas fa-user-tie"></i> Contractor Staff</div>
                                            <div class="tooltip-desc">Outsourced to maintenance contractor. Rate includes: contractor margin (15-20%), worker insurance, PPE, tools, supervision, and profit (1.75x multiplier). Contractor handles their own training, K3 certifications, and manufacturer courses.</div>
                                        </span>
                                    </span>
                                </th>
                                <th>Annual Cost</th>
                            </tr>
                        </thead>
                        <tbody id="staffingTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>TOTAL</strong></td>
                                <td id="totalFteCell">24</td>
                                <td id="totalInhouseCell">24</td>
                                <td id="totalContractorCell">0</td>
                                <td id="totalStaffingCost">$485,000</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Detailed Maintenance Breakdown -->
                <div class="breakdown-card fade-in">
                    <div class="chart-title">
                        <i class="fas fa-tools"></i>
                        Maintenance & Spare Parts Breakdown
                        <span class="info-tooltip" style="margin-left: 6px;">
                            <i class="fas fa-question" style="font-size: 0.65rem;"></i>
                            <span class="tooltip-content">
                                <div class="tooltip-title"><i class="fas fa-tools"></i> Maintenance & Spare Parts</div>
                                <div class="tooltip-desc">Preventive/corrective maintenance costs and critical spare parts inventory budget.</div>
                                <table class="tooltip-table">
                                    <tr><th>Component</th><th>Detail</th></tr>
                                    <tr><td>Maintenance</td><td>Scheduled PM (monthly, quarterly, semi-annual, annual) + corrective repairs</td></tr>
                                    <tr><td>OEM Factor</td><td>In-House: baseline. Contractor: 1.8-2.5x premium (OEM parts, travel, SLA guarantees)</td></tr>
                                    <tr><td>Spare Parts</td><td>Critical spares inventory: UPS modules, chiller parts, generator components, switchgear</td></tr>
                                    <tr><td>Contract Model</td><td>In-House: owner holds 100% spares. Contractor All-Risk: only 15% buffer needed</td></tr>
                                </table>
                                <div class="tooltip-note">Facility age significantly impacts cost: New (0.6x), Mid-life (1.0x), Aging (1.5x). Generator config also affects frequency and cost.</div>
                            </span>
                        </span>
                        <span style="margin-left: auto; font-size: 0.8rem; font-weight: 500; color: var(--text-muted);" id="maintConfigLabel">N+1 | Water-Cooled</span>
                    </div>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>System</th>
                                <th>Annual Cost</th>
                                <th>$/kW/Year</th>
                                <th>Frequency</th>
                                <th>Distribution</th>
                            </tr>
                        </thead>
                        <tbody id="maintTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>TOTAL MAINTENANCE</strong></td>
                                <td id="totalMaintCost" class="amount">$420,000</td>
                                <td id="totalMaintPerKw">$420</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Detailed Utilities Breakdown -->
                <div class="breakdown-card fade-in">
                    <div class="chart-title">
                        <i class="fas fa-tint"></i>
                        Utilities & Consumables Breakdown
                        <span class="info-tooltip" style="margin-left: 6px;">
                            <i class="fas fa-question" style="font-size: 0.65rem;"></i>
                            <span class="tooltip-content">
                                <div class="tooltip-title"><i class="fas fa-tint"></i> Utilities & Consumables</div>
                                <div class="tooltip-desc">Non-electricity recurring costs for facility operations.</div>
                                <table class="tooltip-table">
                                    <tr><th>Utility</th><th>Detail</th></tr>
                                    <tr><td>Water</td><td>Cooling tower/chiller makeup water. Climate-adjusted (tropical = higher evaporation)</td></tr>
                                    <tr><td>Diesel Fuel</td><td>Monthly generator load-bank testing + fuel reserve storage costs</td></tr>
                                    <tr><td>Telecom</td><td>Internet circuits, MPLS for monitoring, redundant WAN links</td></tr>
                                    <tr><td>Security</td><td>CCTV, access control, intrusion detection system maintenance</td></tr>
                                    <tr><td>Consumables</td><td>Air filters, battery replacements, cleaning chemicals, misc supplies</td></tr>
                                </table>
                                <div class="tooltip-note">Electricity cost is NOT included here ‚Äî it's under the Energy category. Water cost varies significantly with cooling type and climate zone.</div>
                            </span>
                        </span>
                    </div>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Utility Type</th>
                                <th>Annual Cost</th>
                                <th>$/kW/Year</th>
                                <th>Notes</th>
                                <th>Distribution</th>
                            </tr>
                        </thead>
                        <tbody id="utilitiesTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>TOTAL UTILITIES</strong></td>
                                <td id="totalUtilitiesCost" class="amount">$78,000</td>
                                <td id="totalUtilitiesPerKw">$78</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Insurance & Compliance Breakdown -->
                <div class="breakdown-card fade-in">
                    <div class="chart-title">
                        <i class="fas fa-shield-alt"></i>
                        Insurance & Compliance Breakdown
                        <span class="info-tooltip" style="margin-left: 6px;">
                            <i class="fas fa-question" style="font-size: 0.65rem;"></i>
                            <span class="tooltip-content">
                                <div class="tooltip-title"><i class="fas fa-shield-alt"></i> Insurance & Compliance</div>
                                <div class="tooltip-desc">Annual insurance premiums and regulatory compliance costs.</div>
                                <table class="tooltip-table">
                                    <tr><th>Item</th><th>Detail</th></tr>
                                    <tr><td>Property Insurance</td><td>~0.25% of estimated CAPEX value</td></tr>
                                    <tr><td>Business Interruption</td><td>~0.10% of CAPEX, covers revenue loss during downtime</td></tr>
                                    <tr><td>Cyber Insurance</td><td>OT/IT security breach coverage, increasingly required</td></tr>
                                    <tr><td>Compliance (ID)</td><td>K3 Listrik, AMDAL, SLO, Izin Operasi, BNSP certifications</td></tr>
                                    <tr><td>Compliance (Intl)</td><td>ISO 27001, SOC 2, PCI-DSS, Uptime Tier certification</td></tr>
                                </table>
                                <div class="tooltip-note">Indonesia: K3 Listrik (Ahli K3 Listrik) certification is mandatory for all electrical installations above 197 kVA. Renewal is typically annual or biennial.</div>
                            </span>
                        </span>
                        <span style="margin-left: auto; font-size: 0.8rem; font-weight: 500; color: var(--text-muted);" id="complianceCountryLabel">Indonesia Standards</span>
                    </div>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Annual Cost</th>
                                <th>Notes</th>
                                <th>Renewal</th>
                                <th>Distribution</th>
                            </tr>
                        </thead>
                        <tbody id="complianceTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>TOTAL INSURANCE & COMPLIANCE</strong></td>
                                <td id="totalComplianceCost" class="amount">$63,000</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Scenario Comparison -->
                <div class="scenario-section fade-in">
                    <div class="scenario-title">
                        <i class="fas fa-balance-scale"></i>
                        Staffing Model Comparison
                        <span class="info-tooltip" style="margin-left: 6px;">
                            <i class="fas fa-question" style="font-size: 0.65rem;"></i>
                            <span class="tooltip-content">
                                <div class="tooltip-title"><i class="fas fa-balance-scale"></i> Quick Staffing Comparison</div>
                                <div class="tooltip-desc">Live comparison of total OPEX under each staffing model, using your current configuration (country, IT load, tier, cooling, etc.).</div>
                                <table class="tooltip-table">
                                    <tr><th>Model</th><th>Key Characteristics</th></tr>
                                    <tr><td>In-House</td><td>Full headcount, lower rate/person, owner manages all spares & training</td></tr>
                                    <tr><td>Partial 70/30</td><td>Management in-house, operations/technicians partially outsourced</td></tr>
                                    <tr><td>Contractor</td><td>~30-35% fewer FTE, higher rate/person, contractor holds spare parts & training</td></tr>
                                </table>
                                <div class="tooltip-note">This is a quick comparison only. Use "Save Scenario A" + change inputs for a full side-by-side comparison with different configurations.</div>
                            </span>
                        </span>
                    </div>
                    <div class="scenario-grid">
                        <div class="scenario-card" id="scenarioInhouse">
                            <div class="scenario-name">Full In-House
                                <span class="info-tooltip" style="margin-left: 4px;vertical-align: middle;">
                                    <i class="fas fa-question" style="font-size: 0.5rem;"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-building"></i> In-House Baseline</div>
                                        <div class="tooltip-desc">All staff on payroll (1.42x multiplier). Full headcount, owner manages spares & training. OEM maintenance at baseline cost. This is the reference point for comparison.</div>
                                    </span>
                                </span>
                            </div>
                            <div class="scenario-total" id="inhouseTotal">$1,312,000</div>
                            <div class="scenario-diff" id="inhouseDiff">Baseline</div>
                        </div>
                        <div class="scenario-card current" id="scenarioPartial">
                            <div class="scenario-name">Partial (70/30)
                                <span class="info-tooltip" style="margin-left: 4px;vertical-align: middle;">
                                    <i class="fas fa-question" style="font-size: 0.5rem;"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-handshake"></i> Partial Model</div>
                                        <div class="tooltip-desc">70% in-house, 30% contractor (fixed for this comparison). Management biased in-house. Contractor portion benefits from FTE efficiency. Shared spare parts responsibility.</div>
                                    </span>
                                </span>
                            </div>
                            <div class="scenario-total" id="partialTotal">$1,245,000</div>
                            <div class="scenario-diff savings" id="partialDiff">-5.1% vs In-House</div>
                        </div>
                        <div class="scenario-card" id="scenarioContractor">
                            <div class="scenario-name">Full Contractor
                                <span class="info-tooltip" style="margin-left: 4px;vertical-align: middle;">
                                    <i class="fas fa-question" style="font-size: 0.5rem;"></i>
                                    <span class="tooltip-content">
                                        <div class="tooltip-title"><i class="fas fa-user-tie"></i> All-Risk Contractor</div>
                                        <div class="tooltip-desc">~30% fewer FTE (multi-skilled), 1.75x rate, but contractor absorbs: training, K3 certs, 85% spare parts, corrective maintenance risk. OEM premium on maintenance. Net: typically 8-15% cheaper total OPEX.</div>
                                    </span>
                                </span>
                            </div>
                            <div class="scenario-total" id="contractorTotal">$1,198,000</div>
                            <div class="scenario-diff savings" id="contractorDiff">-8.7% vs In-House</div>
                        </div>
                    </div>
                </div>

                <!-- (Compare Panel moved to top, after Action Toolbar) -->
            </div>
        </div>
    </main>

    
        <!-- Independence Disclaimer -->
        <div style="max-width:900px;margin:2rem auto 0;padding:1rem 1.5rem;text-align:center;">
            <p style="font-size:0.72rem;color:#64748b;font-style:italic;line-height:1.6;margin:0;">All content on ResistanceZero is independent personal research derived from publicly available sources. This site does not represent any current or former employer. <a href="terms.html" style="color:#8b5cf6;">Terms &amp; Disclaimer</a></p>
        </div>

<!-- Footer -->
    <footer style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #94a3b8; padding: 3rem 2rem; margin-top: 3rem;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 2rem; align-items: start;">
                <div>
                    <p style="font-size: 0.75rem; font-weight: 700; letter-spacing: 0.15em; color: #64748b; line-height: 1.6; margin-bottom: 1rem;">BUILT FOR MISSION CRITICAL INFRASTRUCTURE<br>MANAGEMENT // 2026</p>
                    <p style="font-size: 0.65rem; letter-spacing: 0.1em; color: #475569; margin-bottom: 0.75rem;">ALL OPERATIONAL DATASETS PRESERVED.</p>
                    <p style="font-size: 0.75rem; color: #64748b;">&copy; 2026 Bagus Dwi Permana. All rights reserved.</p>
                </div>
                <div>
                    <h4 style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.15em; color: #64748b; margin-bottom: 1rem;">NAVIGATION</h4>
                    <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.5rem;">
                        <li><a href="index.html" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Home Dashboard</a></li>
                        <li><a href="articles.html" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Technical Journal</a></li>
                        <li><a href="index.html#case-studies" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Case Studies</a></li>
                        <li><a href="datacenter-solutions.html" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">DC Solutions</a></li>
                    </ul>
                </div>
                <div>
                    <h4 style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.15em; color: #64748b; margin-bottom: 1rem;">CONNECT</h4>
                    <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.5rem;">
                        <li><a href="https://www.linkedin.com/in/bagus-dwi-permana-ba90b092" target="_blank" rel="noopener" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">LinkedIn Profile</a></li>
                        <li><a href="articles.html" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Technical Journal</a></li>
                        <li><a href="mailto:baguspermana7@gmail.com" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">Direct Contact</a></li>
                        <li><a href="https://github.com/baguspermana7-cpu" target="_blank" rel="noopener" style="color: #94a3b8; text-decoration: none; font-size: 0.8rem;">GitHub</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // =====================================================
        // COUNTRY DATABASE
        // =====================================================
        const countryData = {
            // ASEAN
            'ID': { name: 'Indonesia', flag: 'üáÆüá©', laborMult: 1.00, energyRate: 0.075, maintMult: 1.00, workerTax: 1.00 },
            'MY': { name: 'Malaysia', flag: 'üá≤üáæ', laborMult: 1.40, energyRate: 0.085, maintMult: 1.15, workerTax: 1.00 },
            'SG': { name: 'Singapore', flag: 'üá∏üá¨', laborMult: 3.50, energyRate: 0.180, maintMult: 1.50, workerTax: 1.05 },
            'TH': { name: 'Thailand', flag: 'üáπüá≠', laborMult: 1.25, energyRate: 0.095, maintMult: 1.10, workerTax: 1.00 },
            'VN': { name: 'Vietnam', flag: 'üáªüá≥', laborMult: 0.80, energyRate: 0.075, maintMult: 0.95, workerTax: 1.00 },
            'PH': { name: 'Philippines', flag: 'üáµüá≠', laborMult: 0.95, energyRate: 0.120, maintMult: 1.05, workerTax: 1.00 },
            // Asia Pacific
            'JP': { name: 'Japan', flag: 'üáØüáµ', laborMult: 4.20, energyRate: 0.220, maintMult: 1.80, workerTax: 1.10 },
            'KR': { name: 'South Korea', flag: 'üá∞üá∑', laborMult: 3.00, energyRate: 0.110, maintMult: 1.40, workerTax: 1.05 },
            'TW': { name: 'Taiwan', flag: 'üáπüáº', laborMult: 2.50, energyRate: 0.090, maintMult: 1.30, workerTax: 1.00 },
            'HK': { name: 'Hong Kong', flag: 'üá≠üá∞', laborMult: 3.80, energyRate: 0.150, maintMult: 1.60, workerTax: 1.00 },
            'CN': { name: 'China (Tier 1)', flag: 'üá®üá≥', laborMult: 2.20, energyRate: 0.085, maintMult: 1.20, workerTax: 1.00 },
            'CN2': { name: 'China (Tier 2)', flag: 'üá®üá≥', laborMult: 1.50, energyRate: 0.070, maintMult: 1.00, workerTax: 1.00 },
            'IN': { name: 'India', flag: 'üáÆüá≥', laborMult: 0.65, energyRate: 0.080, maintMult: 0.85, workerTax: 1.00 },
            'AU': { name: 'Australia', flag: 'üá¶üá∫', laborMult: 4.50, energyRate: 0.200, maintMult: 1.70, workerTax: 1.10 },
            // Middle East
            'AE': { name: 'UAE (Dubai)', flag: 'üá¶üá™', laborMult: 2.80, energyRate: 0.065, maintMult: 1.40, workerTax: 1.00 },
            'SA': { name: 'Saudi Arabia', flag: 'üá∏üá¶', laborMult: 2.40, energyRate: 0.048, maintMult: 1.30, workerTax: 1.00 },
            'QA': { name: 'Qatar', flag: 'üá∂üá¶', laborMult: 3.00, energyRate: 0.040, maintMult: 1.45, workerTax: 1.00 },
            // Europe
            'GB': { name: 'United Kingdom', flag: 'üá¨üáß', laborMult: 4.50, energyRate: 0.280, maintMult: 1.80, workerTax: 1.15 },
            'DE': { name: 'Germany', flag: 'üá©üá™', laborMult: 4.80, energyRate: 0.350, maintMult: 1.90, workerTax: 1.20 },
            'NL': { name: 'Netherlands', flag: 'üá≥üá±', laborMult: 4.20, energyRate: 0.280, maintMult: 1.70, workerTax: 1.15 },
            'IE': { name: 'Ireland', flag: 'üáÆüá™', laborMult: 4.00, energyRate: 0.220, maintMult: 1.65, workerTax: 1.10 },
            'FR': { name: 'France', flag: 'üá´üá∑', laborMult: 4.00, energyRate: 0.180, maintMult: 1.60, workerTax: 1.25 },
            'PT': { name: 'Portugal', flag: 'üáµüáπ', laborMult: 3.00, energyRate: 0.177, maintMult: 1.55, workerTax: 1.24 },
            'SE': { name: 'Sweden', flag: 'üá∏üá™', laborMult: 4.00, energyRate: 0.080, maintMult: 1.55, workerTax: 1.30 },
            'NO': { name: 'Norway', flag: 'üá≥üá¥', laborMult: 4.50, energyRate: 0.070, maintMult: 1.65, workerTax: 1.25 },
            'CH': { name: 'Switzerland', flag: 'üá®üá≠', laborMult: 5.50, energyRate: 0.120, maintMult: 2.00, workerTax: 1.15 },
            // Americas
            'US-VA': { name: 'USA (Virginia)', flag: 'üá∫üá∏', laborMult: 4.50, energyRate: 0.075, maintMult: 1.70, workerTax: 1.30 },
            'US-TX': { name: 'USA (Texas)', flag: 'üá∫üá∏', laborMult: 4.20, energyRate: 0.085, maintMult: 1.60, workerTax: 1.25 },
            'US-CA': { name: 'USA (California)', flag: 'üá∫üá∏', laborMult: 5.50, energyRate: 0.220, maintMult: 1.90, workerTax: 1.35 },
            'CA': { name: 'Canada', flag: 'üá®üá¶', laborMult: 4.00, energyRate: 0.090, maintMult: 1.55, workerTax: 1.20 },
            'BR': { name: 'Brazil', flag: 'üáßüá∑', laborMult: 1.50, energyRate: 0.140, maintMult: 1.15, workerTax: 1.40 },
            'MX': { name: 'Mexico', flag: 'üá≤üáΩ', laborMult: 1.30, energyRate: 0.095, maintMult: 1.05, workerTax: 1.20 },
        };

        // =====================================================
        // INDONESIA SALARY DATABASE (Monthly Gross in IDR, 13-month basis with THR)
        // Based on actual Indonesia DC industry rates 2026
        // =====================================================
        const salaryData = {
            facilityMgr: { name: 'Facility/Operations Manager', baseSalaryIDR: 50000000, category: 'management' },      // Manager level
            maintMgr: { name: 'Maintenance Supervisor', baseSalaryIDR: 37000000, category: 'management' },              // SPV level
            shiftLead: { name: 'Maintenance Team Lead (MTL)', baseSalaryIDR: 30000000, category: 'operations' },        // Team Lead
            elecHV: { name: 'Electrical Engineer (HV/ME)', baseSalaryIDR: 20000000, category: 'technician' },           // ME level
            elecLV: { name: 'Electrical Technician (LV)', baseSalaryIDR: 10000000, category: 'technician' },            // MT level
            hvacTech: { name: 'HVAC/Mechanical Engineer', baseSalaryIDR: 20000000, category: 'technician' },            // ME level
            mechTech: { name: 'Mechanical Technician', baseSalaryIDR: 10000000, category: 'technician' },               // MT level
            genTech: { name: 'Generator Technician', baseSalaryIDR: 10000000, category: 'technician' },                 // MT level
            bmsOp: { name: 'BMS/Control Room Operator', baseSalaryIDR: 10000000, category: 'operations' },              // Operator
            security: { name: 'Security Guard', baseSalaryIDR: 6000000, category: 'support' },                          // UMK+
            cleaning: { name: 'Cleaning Staff', baseSalaryIDR: 5500000, category: 'outsource' },                        // UMK
            contractAdmin: { name: 'Contract Admin/Permit Coordinator', baseSalaryIDR: 15000000, category: 'management' }, // For contractor supervision
        };

        // Exchange rate
        const USD_IDR = 15850;

        // =====================================================
        // CLIMATE ZONE DATABASE
        // =====================================================
        const climateFactors = {
            'tropical_humid': {
                name: 'Tropical Humid',
                coolingEnergyMult: 1.00,
                coolingMaintMult: 1.00,
                waterMult: 1.00,
                freeCoolingHours: 0,
                description: 'Indonesia, Malaysia, Singapore'
            },
            'tropical_dry': {
                name: 'Tropical Dry',
                coolingEnergyMult: 0.92,
                coolingMaintMult: 1.15,
                waterMult: 1.30,
                freeCoolingHours: 500,
                description: 'UAE, Saudi Arabia'
            },
            'subtropical': {
                name: 'Subtropical',
                coolingEnergyMult: 0.88,
                coolingMaintMult: 0.95,
                waterMult: 0.90,
                freeCoolingHours: 1500,
                description: 'Hong Kong, Taiwan, Australia-QLD'
            },
            'temperate': {
                name: 'Temperate',
                coolingEnergyMult: 0.75,
                coolingMaintMult: 0.85,
                waterMult: 0.75,
                freeCoolingHours: 4000,
                description: 'Europe, Japan, South Korea'
            },
            'continental': {
                name: 'Continental',
                coolingEnergyMult: 0.70,
                coolingMaintMult: 0.80,
                waterMult: 0.70,
                freeCoolingHours: 5000,
                description: 'US Central, Canada'
            },
            'cold': {
                name: 'Cold Climate',
                coolingEnergyMult: 0.55,
                coolingMaintMult: 0.75,
                waterMult: 0.50,
                freeCoolingHours: 7000,
                description: 'Nordic, Northern US'
            },
        };

        // =====================================================
        // COOLING SYSTEM TYPE DATABASE
        // =====================================================
        const coolingTypes = {
            'air_chiller': {
                name: 'Air-Cooled Chiller',
                efficiencyMult: 1.15,
                maintCostPerKw: 18,
                waterUsage: 0,
                pueImpact: 0.15
            },
            'water_chiller': {
                name: 'Water-Cooled Chiller',
                efficiencyMult: 1.00,
                maintCostPerKw: 32,
                waterUsage: 1.0,
                pueImpact: 0
            },
            'free_cooling': {
                name: 'Hybrid Free Cooling',
                efficiencyMult: 0.80,
                maintCostPerKw: 28,
                waterUsage: 0.6,
                pueImpact: -0.10
            },
            'inrow': {
                name: 'In-Row Cooling (CRAC)',
                efficiencyMult: 1.05,
                maintCostPerKw: 22,
                waterUsage: 0.3,
                pueImpact: 0.05
            },
            'rdhx': {
                name: 'Rear-Door Heat Exchanger',
                efficiencyMult: 0.90,
                maintCostPerKw: 20,
                waterUsage: 0.8,
                pueImpact: -0.05
            },
            'dlc': {
                name: 'Direct Liquid Cooling',
                efficiencyMult: 0.70,
                maintCostPerKw: 45,
                waterUsage: 0.2,
                pueImpact: -0.15
            },
            'immersion': {
                name: 'Immersion Cooling',
                efficiencyMult: 0.60,
                maintCostPerKw: 55,
                waterUsage: 0,
                pueImpact: -0.25
            },
        };

        // =====================================================
        // GENERATOR CONFIGURATION DATABASE
        // =====================================================
        const genConfigs = {
            'N': {
                name: 'N (No Redundancy)',
                unitMult: 1.0,
                maintMult: 1.0,
                fuelReserveDays: 3,
                testFrequency: 'Monthly + 6M/12M OH'
            },
            'N1': {
                name: 'N+1 (Standard)',
                unitMult: 1.25,
                maintMult: 1.30,
                fuelReserveDays: 5,
                testFrequency: 'Monthly + 6M/12M OH'
            },
            '2N': {
                name: '2N (Full Redundancy)',
                unitMult: 2.0,
                maintMult: 2.10,
                fuelReserveDays: 7,
                testFrequency: 'Monthly + 6M/12M OH'
            },
            '2N1': {
                name: '2N+1 (Tier IV)',
                unitMult: 2.25,
                maintMult: 2.40,
                fuelReserveDays: 10,
                testFrequency: 'Monthly + 6M/12M OH'
            },
        };

        // =====================================================
        // INDONESIA COMPLIANCE COSTS DATABASE
        // =====================================================
        const complianceCosts = {
            'ID': {
                slo: { name: 'SLO (Sertifikat Laik Operasi)', baseCost: 5000, perMW: 1500, renewal: 'Annual' },
                amdal: { name: 'AMDAL/UKL-UPL Monitoring', baseCost: 3000, perMW: 500, renewal: 'Quarterly' },
                bpjsTK: { name: 'BPJS TK Audit', baseCost: 1500, perMW: 0, renewal: 'Annual' },
                fireAudit: { name: 'Fire Safety Audit', baseCost: 2500, perMW: 500, renewal: 'Annual' },
                iso27001: { name: 'ISO 27001 Surveillance', baseCost: 8000, perMW: 1000, renewal: 'Annual' },
                uptime: { name: 'Uptime Institute (Optional)', baseCost: 15000, perMW: 2000, renewal: 'Annual' },
            },
            'default': {
                electrical: { name: 'Electrical Compliance', baseCost: 5000, perMW: 1500, renewal: 'Annual' },
                safety: { name: 'Safety Certification', baseCost: 4000, perMW: 1000, renewal: 'Annual' },
                environmental: { name: 'Environmental Audit', baseCost: 3000, perMW: 500, renewal: 'Annual' },
                iso27001: { name: 'ISO 27001 Surveillance', baseCost: 8000, perMW: 1000, renewal: 'Annual' },
            }
        };

        // =====================================================
        // MAINTENANCE COST RATES ($/kW/Year) - Indonesia Baseline
        // Generator: ~1 Billion IDR/year for 2MW = $31.50/kW (incl fuel system, aux, 6M/12M OH)
        // OEM Contractor typically 2-3x more expensive than in-house
        // =====================================================
        const maintenanceRates = {
            generator: {
                name: 'Generator System',
                icon: 'fa-car-battery',
                color: '#ef4444',
                baseCostPerKw: 31.50,           // ~1B IDR/2MW = includes genset, fuel system, aux systems, 6M/12M OH
                oemMultiplier: 2.5,              // OEM contractor premium
                frequency: 'Monthly + 6M/12M OH'
            },
            cooling: {
                name: 'Cooling/HVAC System',
                icon: 'fa-snowflake',
                color: '#06b6d4',
                baseCostPerKw: 38.00,            // Chiller maintenance + consumables
                oemMultiplier: 2.2,
                frequency: 'Monthly PM'
            },
            electrical: {
                name: 'Electrical (UPS/PDU/STS)',
                icon: 'fa-bolt',
                color: '#f59e0b',
                baseCostPerKw: 28.50,            // UPS battery, PDU, STS maintenance
                oemMultiplier: 2.0,
                frequency: 'Quarterly'
            },
            fire: {
                name: 'Fire Suppression System',
                icon: 'fa-fire-extinguisher',
                color: '#ec4899',
                baseCostPerKw: 10.00,
                oemMultiplier: 1.8,
                frequency: 'Semi-Annual'
            },
            bms: {
                name: 'BMS/DCIM/Controls',
                icon: 'fa-server',
                color: '#8b5cf6',
                baseCostPerKw: 14.00,
                oemMultiplier: 2.0,
                frequency: 'Continuous'
            },
            building: {
                name: 'Building/Facility',
                icon: 'fa-building',
                color: '#6b7280',
                baseCostPerKw: 7.50,
                oemMultiplier: 1.5,
                frequency: 'Quarterly'
            },
        };

        // =====================================================
        // CRITICAL SPARE PARTS INVENTORY ($/kW/Year)
        // Major cost often overlooked in OPEX planning
        // Transformers: 12-18 month lead time, must stock
        // UPS modules: critical for redundancy replacement
        // =====================================================
        const sparePartsRates = {
            electrical: { name: 'UPS Modules & PDU/STS Spares', baseCostPerKw: 12.00, icon: 'fa-battery-full', color: '#8b5cf6' },
            cooling:    { name: 'Chiller/CRAC Spares (Compressor, VFD, Refrigerant)', baseCostPerKw: 8.50, icon: 'fa-snowflake', color: '#06b6d4' },
            generator:  { name: 'Generator Spares (Injector, Filter, Alternator)', baseCostPerKw: 5.50, icon: 'fa-car-battery', color: '#ef4444' },
            switchgear: { name: 'Switchgear & Transformer Spares', baseCostPerKw: 4.50, icon: 'fa-plug', color: '#f59e0b' },
            controls:   { name: 'BMS Sensors, Controllers, I/O Modules', baseCostPerKw: 2.50, icon: 'fa-microchip', color: '#10b981' },
            general:    { name: 'General (Cables, Connectors, Fuses, Breakers)', baseCostPerKw: 3.00, icon: 'fa-toolbox', color: '#6b7280' },
        };
        // Total baseline: ~$36/kW/yr for full owner-managed inventory

        // Spare parts risk transfer multiplier based on staffing model + contract scope
        // Basic contract: labor only, owner holds all spares
        // Comprehensive: labor + common spares included
        // All-Risk: full warranty, contractor holds everything
        const sparePartsContractMultiplier = {
            'inhouse':    1.00,  // Owner manages all spares (full inventory)
            'contractor': 0.15,  // All-Risk: contractor holds 85%, owner keeps emergency buffer only
            'partial':    0.55,  // Comprehensive: shared responsibility
        };

        // =====================================================
        // SOFTWARE & LICENSING ($/kW/Year)
        // Recurring annual costs for DC operations software
        // =====================================================
        const softwareLicensingRates = {
            dcim:       { name: 'DCIM Platform (Nlyte/Sunbird/openDCIM)', baseCostPerKw: 6.00, icon: 'fa-server', color: '#3b82f6' },
            bmsLicense: { name: 'BMS Software Maintenance & Updates', baseCostPerKw: 3.50, icon: 'fa-desktop', color: '#8b5cf6' },
            cmms:       { name: 'CMMS (Maintenance Management System)', baseCostPerKw: 2.50, icon: 'fa-clipboard-list', color: '#10b981' },
            monitoring: { name: 'Environmental Monitoring & SNMP', baseCostPerKw: 1.50, icon: 'fa-chart-line', color: '#06b6d4' },
            cybersec:   { name: 'Cybersecurity (OT Network, SIEM)', baseCostPerKw: 3.00, icon: 'fa-shield-alt', color: '#ef4444' },
        };
        // Total baseline: ~$16.50/kW/yr

        // ‚ïê‚ïê‚ïê DERIVED METRICS DATA TABLES ‚ïê‚ïê‚ïê
        const gridEmissionFactorOpex = {
            ID: 0.72, SG: 0.41, MY: 0.62, TH: 0.49, VN: 0.65, PH: 0.64,
            US: 0.39, 'US-CA': 0.21, 'US-TX': 0.42, 'US-VA': 0.33,
            DE: 0.35, GB: 0.23, JP: 0.47, AU: 0.65, IN: 0.71, BR: 0.07,
            KR: 0.42, NL: 0.33, SE: 0.01, NO: 0.01, AE: 0.42, SA: 0.53,
            QA: 0.49, BH: 0.52, HK: 0.51, TW: 0.50, CN: 0.58, NZ: 0.10,
            FR: 0.06, IE: 0.30, CH: 0.02
        };
        const carbonPriceByRegion = {
            ID: 5, SG: 25, MY: 10, TH: 5, VN: 3, PH: 3,
            US: 15, 'US-CA': 30, 'US-TX': 10, 'US-VA': 15,
            DE: 85, GB: 80, JP: 10, AU: 30, IN: 5, BR: 10,
            KR: 20, NL: 85, SE: 85, NO: 85, AE: 5, SA: 3,
            QA: 3, BH: 3, HK: 10, TW: 10, CN: 12, NZ: 35,
            FR: 85, IE: 85, CH: 85
        };
        const industryBenchmarkOpex = {
            1: { low: 150, mid: 200, high: 280 },
            2: { low: 120, mid: 155, high: 200 },
            3: { low: 100, mid: 130, high: 170 },
            4: { low: 80,  mid: 105, high: 140 }
        };
        const rackKwDefault = 10;

        function computeDerivedMetrics(result) {
            const itKW = result.itLoadKW;
            const pue = result.effectivePue;
            const cc = result._config?.countryCode || 'ID';
            const tier = parseInt(result._config?.tierLevel) || 3;
            const util = parseFloat(result._config?.utilization) / 100 || 0.7;
            const energyRate = result.country?.energyRate || 0.075;
            const annualKWh = itKW * pue * 8760 * util;
            const totalOPEX = result.total;
            const energyCost = result.breakdown?.energy?.value || 0;
            const staffCost = result.breakdown?.staffing?.value || 0;
            const maintCost = result.breakdown?.maintenance?.value || 0;
            const softCost = result.breakdown?.software?.value || 0;
            const insCost = result.breakdown?.insurance?.value || 0;
            const utilCost = result.breakdown?.utilities?.value || 0;

            // Per-unit
            const rackCount = Math.max(1, Math.round(itKW / rackKwDefault));
            const perRackYear = totalOPEX / rackCount;
            const perRackMonth = perRackYear / 12;
            const whiteSpaceM2 = rackCount * 3.5;
            const perM2Year = totalOPEX / whiteSpaceM2;

            // Energy & Efficiency
            const pueOverhead = (pue - 1.0) * itKW * energyRate * 8760 * util;
            const coolingPct = pueOverhead / totalOPEX * 100;
            const pueSavings = 0.1 * itKW * energyRate * 8760 * util;
            const energyIntensity = annualKWh / itKW;

            // Labor
            const mw = itKW / 1000;
            const totalFTE = result.staffingDetail?.totalFTE || 0;
            const staffPerMW = mw > 0 ? totalFTE / mw : 0;
            const costPerMW = mw > 0 ? staffCost / mw : 0;

            // Carbon
            const emFactor = gridEmissionFactorOpex[cc] || gridEmissionFactorOpex['ID'];
            const co2Tonnes = (annualKWh * emFactor) / 1000;
            const cPrice = carbonPriceByRegion[cc] || 5;
            const carbonCost = co2Tonnes * cPrice;
            const cue = (co2Tonnes * 1000) / (itKW * 8760 * util);

            // TCO Projections (energy 3%/yr, labor 4%/yr, general 2.5%/yr)
            function projectCost(years) {
                let total = 0;
                for (let y = 1; y <= years; y++) {
                    const eFactor = Math.pow(1.03, y);
                    const lFactor = Math.pow(1.04, y);
                    const gFactor = Math.pow(1.025, y);
                    total += energyCost * eFactor + staffCost * lFactor + (maintCost + softCost + insCost + utilCost + (result.breakdown?.other?.value || 0)) * gFactor;
                }
                return total;
            }
            const tco5yr = projectCost(5);
            const tco10yr = projectCost(10);

            // Fixed vs Variable
            const fixedCost = staffCost + insCost + softCost;
            const variableCost = energyCost + utilCost + (result.breakdown?.other?.value || 0);
            const fixedPct = (fixedCost / totalOPEX) * 100;
            const variablePct = (variableCost / totalOPEX) * 100;
            const opLeverage = variableCost / totalOPEX;

            // Benchmark
            const bm = industryBenchmarkOpex[tier] || industryBenchmarkOpex[3];
            const perKW = result.perKW;
            let benchPosition = 'Average';
            if (perKW <= bm.low) benchPosition = 'Below Average (Efficient)';
            else if (perKW <= bm.mid) benchPosition = 'Average';
            else if (perKW <= bm.high) benchPosition = 'Above Average';
            else benchPosition = 'High Cost';
            const efficiencyScore = Math.max(0, Math.min(100, Math.round((1 - (perKW - bm.low) / (bm.high - bm.low)) * 100)));
            const maintToTotal = (maintCost / totalOPEX) * 100;

            return {
                rackCount, perRackYear, perRackMonth, whiteSpaceM2, perM2Year,
                pueOverhead, coolingPct, pueSavings, energyIntensity,
                staffPerMW, costPerMW, totalFTE,
                co2Tonnes, carbonCost, cue, emFactor, cPrice,
                tco5yr, tco10yr,
                fixedCost, variableCost, fixedPct, variablePct, opLeverage,
                benchPosition, efficiencyScore, benchLow: bm.low, benchMid: bm.mid, benchHigh: bm.high,
                maintToTotal, annualKWh
            };
        }

        // =====================================================
        // STAFFING CALCULATOR
        // Note: Even full contractor model needs internal supervision for:
        // - Contract administration
        // - Permit/work order approval
        // - Quality oversight
        // =====================================================
        function calculateStaffingFTE(itLoadKW, tierLevel) {
            const mw = itLoadKW / 1000;
            const tier = parseInt(tierLevel);

            // Tier multiplier for staffing
            const tierMult = tier === 4 ? 1.3 : tier === 3 ? 1.15 : tier === 2 ? 1.0 : 0.85;

            return {
                facilityMgr: 1, // Combined Facility + Operations Manager
                maintMgr: mw >= 2 ? 1 : 0, // Maintenance Supervisor for larger sites
                shiftLead: Math.max(5, Math.ceil(mw / 2) * 5), // MTL - 5 for 24/7 rotation
                elecHV: Math.ceil(mw * 1.0 * tierMult), // ME - Electrical Engineer
                elecLV: Math.ceil(mw * 1.0 * tierMult), // MT - Electrical Technician
                hvacTech: Math.ceil(mw * 0.8 * tierMult), // ME - HVAC/Mech Engineer
                mechTech: Math.ceil(mw * 0.5 * tierMult), // MT - Mechanical Technician
                genTech: Math.max(1, Math.ceil(mw * 0.3)), // MT - Generator Technician
                bmsOp: 2, // Fixed 2 for control room (24/7)
                security: Math.max(5, Math.ceil(mw * 0.4) * 5), // 5 for 24/7 rotation
                cleaning: 3, // Fixed 3, always outsourced
                contractAdmin: 0, // Added dynamically for contractor model
            };
        }

        // =====================================================
        // MAIN CALCULATION
        // =====================================================
        let currentStaffingModel = 'inhouse';
        let currentPartialPercent = 70;
        let breakdownChart = null;
        let comparisonChart = null;

        function calculateOPEX() {
            // Get inputs
            const country = document.getElementById('countrySelect').value;
            const itLoadKW = parseFloat(document.getElementById('itLoad').value) || 1000;
            const basePue = parseFloat(document.getElementById('pueSlider').value) || 1.5;
            const tierLevel = document.getElementById('tierLevel').value;
            const facilityAge = document.getElementById('facilityAge').value;
            const utilization = parseFloat(document.getElementById('utilizationSlider').value) / 100 || 0.7;
            const climateZone = document.getElementById('climateZone').value;
            const coolingType = document.getElementById('coolingType').value;
            const genConfig = document.getElementById('genConfig').value;

            const cf = countryData[country];
            const climate = climateFactors[climateZone];
            const cooling = coolingTypes[coolingType];
            const generator = genConfigs[genConfig];

            // Adjust PUE based on cooling type
            const effectivePue = basePue + cooling.pueImpact;

            // 1. ENERGY COST (with climate adjustment)
            const totalPowerKW = itLoadKW * effectivePue;
            const coolingPowerKW = itLoadKW * (effectivePue - 1) * cooling.efficiencyMult * climate.coolingEnergyMult;
            const adjustedTotalPowerKW = itLoadKW + coolingPowerKW;
            const annualKWh = adjustedTotalPowerKW * 8760 * utilization;
            const energyCost = annualKWh * cf.energyRate;

            // 2. STAFFING COST
            const staffingFTE = calculateStaffingFTE(itLoadKW, tierLevel);
            const staffingDetail = calculateStaffingDetail(staffingFTE, cf);
            const staffingCost = staffingDetail.totalCost;

            // 3. DETAILED MAINTENANCE BREAKDOWN
            // In-house: Lower cost (self-maintained), Contractor: OEM premium pricing
            // OEM contractors charge 2-3x more due to: travel, profit margin, specialized parts, SLA guarantees
            const ageFactor = facilityAge === 'new' ? 0.6 : facilityAge === 'mid' ? 1.0 : 1.5;

            // Calculate OEM factor based on staffing model
            // In-house: baseline, Partial: blended, Contractor: full OEM premium
            const getOemFactor = (system) => {
                const oemMult = maintenanceRates[system]?.oemMultiplier || 2.0;
                if (currentStaffingModel === 'inhouse') return 1.0;
                if (currentStaffingModel === 'contractor') return oemMult;
                // Partial: blend based on contractor percentage
                const contractorPct = (100 - currentPartialPercent) / 100;
                return 1.0 + (oemMult - 1.0) * contractorPct;
            };

            const maintenanceDetail = {
                generator: {
                    cost: itLoadKW * maintenanceRates.generator.baseCostPerKw * generator.maintMult * ageFactor * cf.maintMult * getOemFactor('generator'),
                    perKw: maintenanceRates.generator.baseCostPerKw * generator.maintMult * ageFactor * cf.maintMult * getOemFactor('generator'),
                    frequency: generator.testFrequency + ' + 6M/12M OH',
                    oemFactor: getOemFactor('generator')
                },
                cooling: {
                    cost: itLoadKW * cooling.maintCostPerKw * climate.coolingMaintMult * ageFactor * cf.maintMult * getOemFactor('cooling'),
                    perKw: cooling.maintCostPerKw * climate.coolingMaintMult * ageFactor * cf.maintMult * getOemFactor('cooling'),
                    frequency: maintenanceRates.cooling.frequency,
                    oemFactor: getOemFactor('cooling')
                },
                electrical: {
                    cost: itLoadKW * maintenanceRates.electrical.baseCostPerKw * ageFactor * cf.maintMult * getOemFactor('electrical'),
                    perKw: maintenanceRates.electrical.baseCostPerKw * ageFactor * cf.maintMult * getOemFactor('electrical'),
                    frequency: maintenanceRates.electrical.frequency,
                    oemFactor: getOemFactor('electrical')
                },
                fire: {
                    cost: itLoadKW * maintenanceRates.fire.baseCostPerKw * ageFactor * cf.maintMult * getOemFactor('fire'),
                    perKw: maintenanceRates.fire.baseCostPerKw * ageFactor * cf.maintMult * getOemFactor('fire'),
                    frequency: maintenanceRates.fire.frequency,
                    oemFactor: getOemFactor('fire')
                },
                bms: {
                    cost: itLoadKW * maintenanceRates.bms.baseCostPerKw * ageFactor * cf.maintMult * getOemFactor('bms'),
                    perKw: maintenanceRates.bms.baseCostPerKw * ageFactor * cf.maintMult * getOemFactor('bms'),
                    frequency: maintenanceRates.bms.frequency,
                    oemFactor: getOemFactor('bms')
                },
                building: {
                    cost: itLoadKW * maintenanceRates.building.baseCostPerKw * ageFactor * cf.maintMult * getOemFactor('building'),
                    perKw: maintenanceRates.building.baseCostPerKw * ageFactor * cf.maintMult * getOemFactor('building'),
                    frequency: maintenanceRates.building.frequency,
                    oemFactor: getOemFactor('building')
                },
            };

            const totalMaintenanceCost = Object.values(maintenanceDetail).reduce((sum, m) => sum + m.cost, 0);

            // 3b. CRITICAL SPARE PARTS INVENTORY
            // Cost depends on: IT load, tier (more redundancy = more spare types), facility age, and contract model
            const tier = parseInt(tierLevel);
            const tierSpareMult = tier === 4 ? 1.35 : tier === 3 ? 1.15 : tier === 2 ? 1.0 : 0.80;
            const ageSpareMult = facilityAge === 'new' ? 0.65 : facilityAge === 'mid' ? 1.0 : 1.45;
            const contractSpareMult = sparePartsContractMultiplier[currentStaffingModel] || 0.55;

            const sparePartsDetail = {};
            Object.keys(sparePartsRates).forEach(key => {
                const rate = sparePartsRates[key];
                const cost = itLoadKW * rate.baseCostPerKw * tierSpareMult * ageSpareMult * contractSpareMult * cf.maintMult;
                sparePartsDetail[key] = {
                    name: rate.name,
                    cost: cost,
                    perKw: cost / itLoadKW,
                    icon: rate.icon,
                    color: rate.color,
                };
            });
            const totalSparePartsCost = Object.values(sparePartsDetail).reduce((sum, s) => sum + s.cost, 0);

            // 3c. SOFTWARE & LICENSING
            // Relatively fixed per kW, scales slightly with country labor mult (support contracts)
            const softwareDetail = {};
            Object.keys(softwareLicensingRates).forEach(key => {
                const rate = softwareLicensingRates[key];
                const cost = itLoadKW * rate.baseCostPerKw * (0.7 + 0.3 * cf.laborMult); // 70% fixed + 30% labor-adjusted
                softwareDetail[key] = {
                    name: rate.name,
                    cost: cost,
                    perKw: cost / itLoadKW,
                    icon: rate.icon,
                    color: rate.color,
                };
            });
            const totalSoftwareCost = Object.values(softwareDetail).reduce((sum, s) => sum + s.cost, 0);

            // 4. DETAILED UTILITIES BREAKDOWN
            const mw = itLoadKW / 1000;
            const waterBaseCost = 2.50; // $/m¬≥
            const waterUsageM3 = itLoadKW * 0.5 * cooling.waterUsage * climate.waterMult * 8760 / 1000; // m¬≥/year
            const waterCost = waterUsageM3 * waterBaseCost * cf.laborMult;

            const fuelLitersPerHour = (itLoadKW / 4) * generator.unitMult; // ~0.25L/kW/hr
            const fuelTestHoursPerYear = 12; // Monthly warming up (all configs)
            const fuelCostPerLiter = country === 'ID' ? 0.85 : 1.20; // Indonesia subsidized diesel
            const fuelCost = fuelLitersPerHour * fuelTestHoursPerYear * fuelCostPerLiter;
            const fuelReserveCost = (itLoadKW * generator.fuelReserveDays * 24 * 0.25 * fuelCostPerLiter) * 0.05; // Storage cost

            const telecomCost = 4000 + (mw * 1500); // Base + per MW
            const securitySystemsCost = 2000 + (mw * 500);
            const consumablesCost = itLoadKW * 8;

            const utilitiesDetail = {
                water: { cost: waterCost, perKw: waterCost / itLoadKW, notes: `${Math.round(waterUsageM3).toLocaleString()} m¬≥/yr` },
                fuel: { cost: fuelCost + fuelReserveCost, perKw: (fuelCost + fuelReserveCost) / itLoadKW, notes: `${generator.testFrequency} testing` },
                telecom: { cost: telecomCost * 12, perKw: (telecomCost * 12) / itLoadKW, notes: 'Internet + MPLS' },
                security: { cost: securitySystemsCost * 12, perKw: (securitySystemsCost * 12) / itLoadKW, notes: 'CCTV, Access Control' },
                consumables: { cost: consumablesCost, perKw: consumablesCost / itLoadKW, notes: 'Filters, batteries, etc.' },
            };

            const totalUtilitiesCost = Object.values(utilitiesDetail).reduce((sum, u) => sum + u.cost, 0);

            // 5. DETAILED INSURANCE & COMPLIANCE BREAKDOWN
            const estimatedCAPEX = itLoadKW * 12000;
            const complianceData = country === 'ID' ? complianceCosts['ID'] : complianceCosts['default'];

            const complianceDetail = {};
            Object.keys(complianceData).forEach(key => {
                const item = complianceData[key];
                complianceDetail[key] = {
                    name: item.name,
                    cost: item.baseCost + (mw * item.perMW),
                    renewal: item.renewal
                };
            });

            // Insurance breakdown
            const insuranceDetail = {
                property: { name: 'Property Insurance', cost: estimatedCAPEX * 0.0025, renewal: 'Annual' },
                businessInt: { name: 'Business Interruption', cost: estimatedCAPEX * 0.0010, renewal: 'Annual' },
                liability: { name: 'Liability Insurance', cost: 5000 + (mw * 1000), renewal: 'Annual' },
                cyber: { name: 'Cyber Insurance', cost: 8000 + (mw * 2000), renewal: 'Annual' },
            };

            const totalInsuranceCost = Object.values(insuranceDetail).reduce((sum, i) => sum + i.cost, 0);
            const totalComplianceCertCost = Object.values(complianceDetail).reduce((sum, c) => sum + c.cost, 0);
            const totalInsuranceComplianceCost = totalInsuranceCost + totalComplianceCertCost;

            // 6. OTHER COSTS
            // Training: only for in-house staff (contractor handles own training, K3 certs, manufacturer training)
            const inhouseStaffingCost = staffingDetail.details.reduce((sum, r) => sum + r.inhouseCost, 0);
            const trainingCost = inhouseStaffingCost * 0.035;
            const miscCost = (energyCost + staffingCost) * 0.02;
            const otherCosts = trainingCost + miscCost;

            // TOTAL
            const totalOPEX = energyCost + staffingCost + totalMaintenanceCost +
                             totalSparePartsCost + totalSoftwareCost +
                             totalInsuranceComplianceCost + totalUtilitiesCost + otherCosts;

            return {
                total: totalOPEX,
                monthly: totalOPEX / 12,
                perKW: totalOPEX / itLoadKW,
                perKWh: totalOPEX / annualKWh,
                breakdown: {
                    energy: { value: energyCost, color: '#f59e0b' },
                    staffing: { value: staffingCost, color: '#10b981' },
                    maintenance: { value: totalMaintenanceCost + totalSparePartsCost, color: '#3b82f6' },
                    software: { value: totalSoftwareCost, color: '#a855f7' },
                    insurance: { value: totalInsuranceComplianceCost, color: '#8b5cf6' },
                    utilities: { value: totalUtilitiesCost, color: '#06b6d4' },
                    other: { value: otherCosts, color: '#6b7280' },
                },
                maintenanceDetail: maintenanceDetail,
                sparePartsDetail: sparePartsDetail,
                totalSparePartsCost: totalSparePartsCost,
                softwareDetail: softwareDetail,
                totalSoftwareCost: totalSoftwareCost,
                utilitiesDetail: utilitiesDetail,
                insuranceDetail: insuranceDetail,
                complianceDetail: complianceDetail,
                staffingDetail: staffingDetail,
                itLoadKW: itLoadKW,
                country: cf,
                climate: climate,
                cooling: cooling,
                generator: generator,
                effectivePue: effectivePue,
                // Configuration metadata for PDF comparison
                _config: {
                    countryCode: country,
                    countryName: cf.name,
                    countryFlag: cf.flag,
                    tierLevel: tierLevel,
                    facilityAge: facilityAge,
                    climateZone: climate.name,
                    coolingType: cooling.name,
                    genConfig: generator.name,
                    staffingModel: currentStaffingModel === 'inhouse' ? 'Full In-House' :
                                   currentStaffingModel === 'contractor' ? 'Full Contractor' :
                                   `Partial (${currentPartialPercent}% In-House)`,
                    pue: effectivePue.toFixed(2),
                    utilization: (utilization * 100).toFixed(0) + '%',
                },
            };
        }

        function calculateStaffingDetail(staffingFTE, cf) {
            const inhouseMultiplier = 1.42; // Benefits + overhead (BPJS, THR, leave, training)
            const contractorMultiplier = 1.75; // Contractor rate (margin + overhead + profit, adjusted for FTE efficiency)

            const details = [];
            let totalFTE = 0;
            let totalInhouse = 0;
            let totalContractor = 0;
            let totalCost = 0;

            // For contractor model: always need 1 internal admin for supervision/permit
            // This person handles: work permits, contractor oversight, admin, quality checks
            if (currentStaffingModel === 'contractor') {
                staffingFTE.contractAdmin = 1;
            } else if (currentStaffingModel === 'partial' && currentPartialPercent < 50) {
                staffingFTE.contractAdmin = 1;
            } else {
                staffingFTE.contractAdmin = 0;
            }

            Object.keys(staffingFTE).forEach(roleId => {
                const fte = staffingFTE[roleId];
                if (fte === 0) return;

                const role = salaryData[roleId];
                if (!role) return; // Skip if role not defined

                const annualSalaryUSD = (role.baseSalaryIDR * 13) / USD_IDR; // 13 months (inc THR)
                const countryAdjustedSalary = annualSalaryUSD * cf.laborMult;

                let inhouseFTE, contractorFTE, inhouseCost, contractorCost;

                // Contract admin is always in-house (internal supervision requirement)
                if (roleId === 'contractAdmin') {
                    inhouseFTE = fte;
                    contractorFTE = 0;
                } else if (currentStaffingModel === 'inhouse') {
                    inhouseFTE = fte;
                    contractorFTE = 0;
                } else if (currentStaffingModel === 'contractor') {
                    // Full contractor: management stays in-house, technicians outsourced
                    // Contractor is more efficient: multi-skilled workers, shared resources, optimized scheduling
                    if (role.category === 'management') {
                        inhouseFTE = fte;
                        contractorFTE = 0;
                    } else {
                        const efficiencyMap = { operations: 0.70, technician: 0.65, support: 0.85, outsource: 1.0 };
                        const efficiency = efficiencyMap[role.category] || 0.75;
                        const adjustedFTE = Math.max(1, Math.round(fte * efficiency));
                        inhouseFTE = 0;
                        contractorFTE = adjustedFTE;
                    }
                } else {
                    // Partial - different splits by category
                    let categoryPct = currentPartialPercent;
                    if (role.category === 'management') categoryPct = Math.min(100, currentPartialPercent + 20);
                    if (role.category === 'support') categoryPct = Math.max(0, currentPartialPercent - 20);

                    // Contractor portion gets efficiency benefit
                    const efficiencyMap = { operations: 0.70, technician: 0.65, support: 0.85, outsource: 1.0, management: 1.0 };
                    const efficiency = efficiencyMap[role.category] || 0.75;
                    inhouseFTE = Math.round(fte * categoryPct / 100);
                    contractorFTE = Math.max(0, Math.round((fte - inhouseFTE) * efficiency));
                }

                inhouseCost = inhouseFTE * countryAdjustedSalary * inhouseMultiplier;
                contractorCost = contractorFTE * countryAdjustedSalary * contractorMultiplier;

                const actualFTE = inhouseFTE + contractorFTE;
                details.push({
                    roleId,
                    name: role.name,
                    fte: actualFTE,
                    inhouseFTE,
                    contractorFTE,
                    inhouseCost,
                    contractorCost,
                    totalCost: inhouseCost + contractorCost,
                });

                totalFTE += actualFTE;
                totalInhouse += inhouseFTE;
                totalContractor += contractorFTE;
                totalCost += inhouseCost + contractorCost;
            });

            return {
                details,
                totalFTE,
                totalInhouse,
                totalContractor,
                totalCost,
            };
        }

        // =====================================================
        // UI UPDATE FUNCTIONS
        // =====================================================
        function updateCalculation() {
            try {
                const result = calculateOPEX();
                const cf = countryData[document.getElementById('countrySelect').value];
                const country = document.getElementById('countrySelect').value;

                // Update country info
                document.getElementById('selectedFlag').textContent = cf.flag;
                document.getElementById('laborMult').textContent = cf.laborMult.toFixed(2) + 'x';
                document.getElementById('energyRate').textContent = '$' + cf.energyRate.toFixed(3) + '/kWh';

                // Update climate info
                document.getElementById('coolingEnergyFactor').textContent = result.climate.coolingEnergyMult.toFixed(2) + 'x';
                document.getElementById('freeCoolingHours').textContent = result.climate.freeCoolingHours.toLocaleString() + ' hrs/yr';

                // Update summary
                document.getElementById('summaryFlag').textContent = cf.flag;
                document.getElementById('summaryCountry').textContent = cf.name;
                document.getElementById('totalOpex').textContent = formatCurrency(result.total);
                document.getElementById('monthlyOpex').textContent = formatCurrency(result.monthly, true);
                document.getElementById('perKwOpex').textContent = '$' + Math.round(result.perKW).toLocaleString();
                document.getElementById('perKwhOpex').textContent = '$' + result.perKWh.toFixed(3);
                document.getElementById('totalFte').textContent = result.staffingDetail.totalFTE;

                // Update breakdown table
                updateBreakdownTable(result);

                // Update staffing table
                updateStaffingTable(result.staffingDetail);

                // Update detailed maintenance table
                updateMaintenanceTable(result);

                // Update utilities table
                updateUtilitiesTable(result);

                // Update insurance & compliance table
                updateComplianceTable(result, country);

                // Update charts
                updateCharts(result);

                // Update scenario comparison
                updateScenarioComparison(result);

                // Store for compare mode
                lastOpexResult = result;
                if (savedOpexScenario) renderOpexComparison();
            } catch (e) {
                console.error('OPEX Calculation Error:', e);
                lastOpexResult = null;
            }
        }

        function formatCurrency(value, compact = false) {
            if (compact) {
                if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                if (value >= 1000) return '$' + (value / 1000).toFixed(1) + 'K';
            }
            return '$' + Math.round(value).toLocaleString();
        }

        function updateBreakdownTable(result) {
            const tbody = document.getElementById('breakdownTableBody');
            const categories = [
                { key: 'energy', name: 'Energy (Electricity)', icon: 'fa-bolt' },
                { key: 'staffing', name: 'Staffing & Labor', icon: 'fa-users' },
                { key: 'maintenance', name: 'Maintenance & Spares', icon: 'fa-wrench' },
                { key: 'software', name: 'Software & Licensing', icon: 'fa-laptop-code' },
                { key: 'insurance', name: 'Insurance & Compliance', icon: 'fa-shield-alt' },
                { key: 'utilities', name: 'Utilities & Consumables', icon: 'fa-water' },
                { key: 'other', name: 'Other Costs', icon: 'fa-ellipsis-h' },
            ];

            tbody.innerHTML = categories.map(cat => {
                const data = result.breakdown[cat.key];
                if (data.value === 0) return ''; // Skip zero values
                const percent = (data.value / result.total * 100).toFixed(1);
                const perKW = (data.value / result.itLoadKW).toFixed(0);

                return `
                    <tr>
                        <td>
                            <span class="category-icon" style="background: ${data.color}20; color: ${data.color}">
                                <i class="fas ${cat.icon}"></i>
                            </span>
                            ${cat.name}
                        </td>
                        <td class="amount">${formatCurrency(data.value)}</td>
                        <td class="percent">${percent}%</td>
                        <td>$${perKW}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percent}%; background: ${data.color}"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStaffingTable(staffingDetail) {
            const tbody = document.getElementById('staffingTableBody');

            // Update model label
            const modelLabel = currentStaffingModel === 'inhouse' ? 'Full In-House' :
                              currentStaffingModel === 'contractor' ? 'Full Contractor' :
                              `Partial (${currentPartialPercent}% In-House)`;
            document.getElementById('staffingModelLabel').textContent = modelLabel;

            tbody.innerHTML = staffingDetail.details.map(role => `
                <tr>
                    <td class="role-name">${role.name}</td>
                    <td>${role.fte}</td>
                    <td>${role.inhouseFTE > 0 ? `<span class="fte-badge fte-inhouse">${role.inhouseFTE}</span>` : '-'}</td>
                    <td>${role.contractorFTE > 0 ? `<span class="fte-badge fte-contractor">${role.contractorFTE}</span>` : '-'}</td>
                    <td class="cost">${formatCurrency(role.totalCost)}</td>
                </tr>
            `).join('');

            // Update totals
            document.getElementById('totalFteCell').textContent = staffingDetail.totalFTE;
            document.getElementById('totalInhouseCell').textContent = staffingDetail.totalInhouse;
            document.getElementById('totalContractorCell').textContent = staffingDetail.totalContractor;
            document.getElementById('totalStaffingCost').textContent = formatCurrency(staffingDetail.totalCost);
        }

        function updateMaintenanceTable(result) {
            const tbody = document.getElementById('maintTableBody');
            const maintData = result.maintenanceDetail;
            let totalCost = 0;

            // Update config label
            document.getElementById('maintConfigLabel').textContent =
                `${result.generator.name.split(' ')[0]} | ${result.cooling.name}`;

            const systems = [
                { key: 'generator', icon: 'fa-car-battery', color: '#ef4444' },
                { key: 'cooling', icon: 'fa-snowflake', color: '#06b6d4' },
                { key: 'electrical', icon: 'fa-bolt', color: '#f59e0b' },
                { key: 'fire', icon: 'fa-fire-extinguisher', color: '#ec4899' },
                { key: 'bms', icon: 'fa-server', color: '#8b5cf6' },
                { key: 'building', icon: 'fa-building', color: '#6b7280' },
            ];

            // All values for progress bar max calculation
            const allMaintCosts = [...Object.values(maintData).map(d => d.cost), ...Object.values(result.sparePartsDetail).map(d => d.cost)];
            const maxCost = Math.max(...allMaintCosts);

            // Preventive & Corrective Maintenance rows
            let rows = systems.map(sys => {
                const data = maintData[sys.key];
                const rate = maintenanceRates[sys.key];
                totalCost += data.cost;
                const percent = (data.cost / maxCost * 100).toFixed(0);
                return `<tr>
                    <td><span class="category-icon" style="background: ${sys.color}20; color: ${sys.color}"><i class="fas ${sys.icon}"></i></span>${rate.name}</td>
                    <td class="amount">${formatCurrency(data.cost)}</td>
                    <td>$${data.perKw.toFixed(2)}</td>
                    <td>${data.frequency}</td>
                    <td><div class="progress-bar"><div class="progress-fill" style="width: ${percent}%; background: ${sys.color}"></div></div></td>
                </tr>`;
            }).join('');

            // Spare Parts Inventory sub-header + rows
            const spareData = result.sparePartsDetail;
            const contractLabel = currentStaffingModel === 'inhouse' ? 'Owner-Managed' : currentStaffingModel === 'contractor' ? 'Contractor-Managed (All-Risk)' : 'Shared Risk';
            rows += `<tr style="background:rgba(168,85,247,0.06);"><td colspan="5" style="padding:8px 12px;font-weight:600;font-size:0.8rem;color:#a855f7;"><i class="fas fa-boxes" style="margin-right:6px;"></i>Spare Parts Inventory ‚Äî ${contractLabel}</td></tr>`;

            Object.keys(spareData).forEach(key => {
                const sp = spareData[key];
                totalCost += sp.cost;
                const percent = (sp.cost / maxCost * 100).toFixed(0);
                rows += `<tr>
                    <td><span class="category-icon" style="background: ${sp.color}20; color: ${sp.color}"><i class="fas ${sp.icon}"></i></span>${sp.name}</td>
                    <td class="amount">${formatCurrency(sp.cost)}</td>
                    <td>$${sp.perKw.toFixed(2)}</td>
                    <td>Inventory</td>
                    <td><div class="progress-bar"><div class="progress-fill" style="width: ${percent}%; background: ${sp.color}"></div></div></td>
                </tr>`;
            });

            tbody.innerHTML = rows;

            document.getElementById('totalMaintCost').textContent = formatCurrency(totalCost);
            document.getElementById('totalMaintPerKw').textContent = '$' + (totalCost / result.itLoadKW).toFixed(2);
        }

        function updateUtilitiesTable(result) {
            const tbody = document.getElementById('utilitiesTableBody');
            const utilData = result.utilitiesDetail;
            let totalCost = 0;

            const utilities = [
                { key: 'water', name: 'Water (Cooling Tower/Chiller)', icon: 'fa-tint', color: '#06b6d4' },
                { key: 'fuel', name: 'Diesel Fuel (Generator)', icon: 'fa-gas-pump', color: '#ef4444' },
                { key: 'telecom', name: 'Telecom / Internet', icon: 'fa-wifi', color: '#3b82f6' },
                { key: 'security', name: 'Security Systems', icon: 'fa-shield-alt', color: '#8b5cf6' },
                { key: 'consumables', name: 'Consumables (Filters, etc.)', icon: 'fa-box', color: '#f59e0b' },
            ];

            tbody.innerHTML = utilities.map(util => {
                const data = utilData[util.key];
                totalCost += data.cost;
                const maxCost = Math.max(...Object.values(utilData).map(d => d.cost));
                const percent = (data.cost / maxCost * 100).toFixed(0);

                return `
                    <tr>
                        <td>
                            <span class="category-icon" style="background: ${util.color}20; color: ${util.color}">
                                <i class="fas ${util.icon}"></i>
                            </span>
                            ${util.name}
                        </td>
                        <td class="amount">${formatCurrency(data.cost)}</td>
                        <td>$${data.perKw.toFixed(2)}</td>
                        <td>${data.notes}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percent}%; background: ${util.color}"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('totalUtilitiesCost').textContent = formatCurrency(totalCost);
            document.getElementById('totalUtilitiesPerKw').textContent = '$' + (totalCost / result.itLoadKW).toFixed(2);
        }

        function updateComplianceTable(result, countryCode) {
            const tbody = document.getElementById('complianceTableBody');
            const insuranceData = result.insuranceDetail;
            const complianceData = result.complianceDetail;
            let totalCost = 0;

            // Update country label
            const countryName = countryCode === 'ID' ? 'Indonesia Standards' : 'International Standards';
            document.getElementById('complianceCountryLabel').textContent = countryName;

            let rows = '';

            // Insurance items
            const insuranceItems = [
                { key: 'property', icon: 'fa-building', color: '#3b82f6' },
                { key: 'businessInt', icon: 'fa-chart-line', color: '#10b981' },
                { key: 'liability', icon: 'fa-user-shield', color: '#f59e0b' },
                { key: 'cyber', icon: 'fa-lock', color: '#ef4444' },
            ];

            insuranceItems.forEach(item => {
                const data = insuranceData[item.key];
                totalCost += data.cost;
                rows += `
                    <tr>
                        <td>
                            <span class="category-icon" style="background: ${item.color}20; color: ${item.color}">
                                <i class="fas ${item.icon}"></i>
                            </span>
                            ${data.name}
                        </td>
                        <td class="amount">${formatCurrency(data.cost)}</td>
                        <td>Insurance Premium</td>
                        <td>${data.renewal}</td>
                        <td>
                            <span style="font-size: 0.75rem; color: var(--accent-emerald);">
                                <i class="fas fa-shield-alt"></i> Insurance
                            </span>
                        </td>
                    </tr>
                `;
            });

            // Compliance items
            const complianceColors = ['#8b5cf6', '#ec4899', '#06b6d4', '#f59e0b', '#10b981', '#ef4444', '#3b82f6'];
            let colorIndex = 0;

            Object.keys(complianceData).forEach(key => {
                const data = complianceData[key];
                totalCost += data.cost;
                const color = complianceColors[colorIndex % complianceColors.length];
                colorIndex++;

                rows += `
                    <tr>
                        <td>
                            <span class="category-icon" style="background: ${color}20; color: ${color}">
                                <i class="fas fa-certificate"></i>
                            </span>
                            ${data.name}
                        </td>
                        <td class="amount">${formatCurrency(data.cost)}</td>
                        <td>${countryCode === 'ID' ? 'Indonesia Regulation' : 'International Standard'}</td>
                        <td>${data.renewal}</td>
                        <td>
                            <span style="font-size: 0.75rem; color: var(--accent-purple);">
                                <i class="fas fa-file-certificate"></i> Compliance
                            </span>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = rows;
            document.getElementById('totalComplianceCost').textContent = formatCurrency(totalCost);
        }

        function updateCharts(result) {
            const labels = ['Energy', 'Staffing', 'Maintenance & Spares', 'Software & Licensing', 'Insurance & Compliance', 'Utilities', 'Other'];
            const data = [
                result.breakdown.energy.value,
                result.breakdown.staffing.value,
                result.breakdown.maintenance.value,
                result.breakdown.software.value,
                result.breakdown.insurance.value,
                result.breakdown.utilities.value,
                result.breakdown.other.value,
            ];
            const colors = [
                '#f59e0b', '#10b981', '#3b82f6', '#a855f7', '#8b5cf6', '#06b6d4', '#6b7280'
            ];

            // Pie Chart
            if (breakdownChart) breakdownChart.destroy();
            breakdownChart = new Chart(document.getElementById('breakdownChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { font: { size: 11 }, padding: 15 }
                        }
                    },
                    cutout: '60%',
                }
            });

            // Bar Chart
            if (comparisonChart) comparisonChart.destroy();
            comparisonChart = new Chart(document.getElementById('comparisonChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Annual Cost ($)',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + (value/1000).toFixed(0) + 'K'
                            }
                        }
                    }
                }
            });
        }

        function updateScenarioComparison(currentResult) {
            // Save current model BEFORE try block
            const savedModel = currentStaffingModel;
            const savedPercent = currentPartialPercent;
            try {

                // Calculate In-House
                currentStaffingModel = 'inhouse';
                const inhouseResult = calculateOPEX();

                // Calculate Contractor
                currentStaffingModel = 'contractor';
                const contractorResult = calculateOPEX();

                // Calculate Partial (70/30)
                currentStaffingModel = 'partial';
                currentPartialPercent = 70;
                const partialResult = calculateOPEX();

                // Update UI
                document.getElementById('inhouseTotal').textContent = formatCurrency(inhouseResult.total);
                document.getElementById('partialTotal').textContent = formatCurrency(partialResult.total);
                document.getElementById('contractorTotal').textContent = formatCurrency(contractorResult.total);

                const partialDiff = ((partialResult.total - inhouseResult.total) / inhouseResult.total * 100).toFixed(1);
                const contractorDiff = ((contractorResult.total - inhouseResult.total) / inhouseResult.total * 100).toFixed(1);

                document.getElementById('inhouseDiff').textContent = 'Baseline';
                document.getElementById('inhouseDiff').className = 'scenario-diff';

                document.getElementById('partialDiff').textContent = `${partialDiff}% vs In-House`;
                document.getElementById('partialDiff').className = 'scenario-diff ' + (parseFloat(partialDiff) < 0 ? 'savings' : 'increase');

                document.getElementById('contractorDiff').textContent = `${contractorDiff}% vs In-House`;
                document.getElementById('contractorDiff').className = 'scenario-diff ' + (parseFloat(contractorDiff) < 0 ? 'savings' : 'increase');

                // Highlight current
                document.querySelectorAll('.scenario-card').forEach(card => card.classList.remove('current'));
                if (savedModel === 'inhouse') document.getElementById('scenarioInhouse').classList.add('current');
                else if (savedModel === 'contractor') document.getElementById('scenarioContractor').classList.add('current');
                else document.getElementById('scenarioPartial').classList.add('current');
            } catch (e) {
                console.error('Scenario comparison error:', e);
            } finally {
                // Always restore model
                currentStaffingModel = savedModel;
                currentPartialPercent = savedPercent;
            }
        }

        // =====================================================
        // EVENT HANDLERS
        // =====================================================
        function updatePUE() {
            const value = document.getElementById('pueSlider').value;
            document.getElementById('pueValue').textContent = parseFloat(value).toFixed(2);
            updateCalculation();
        }

        function updateUtilization() {
            const value = document.getElementById('utilizationSlider').value;
            document.getElementById('utilizationValue').textContent = value + '%';
            updateCalculation();
        }

        function selectStaffingModel(model) {
            currentStaffingModel = model;

            document.querySelectorAll('.model-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.model === model) card.classList.add('active');
            });

            const partialControls = document.getElementById('partialControls');
            if (model === 'partial') {
                partialControls.classList.add('active');
            } else {
                partialControls.classList.remove('active');
            }

            updateCalculation();
        }

        function updatePartialSplit() {
            currentPartialPercent = parseInt(document.getElementById('partialSlider').value);
            document.getElementById('inhousePercent').textContent = currentPartialPercent;
            document.getElementById('contractorPercent').textContent = 100 - currentPartialPercent;
            updateCalculation();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateCalculation();
            initTooltipSystem();
        });

        // ‚ïê‚ïê‚ïê OPEX MODE & COMPARE STATE ‚ïê‚ïê‚ïê
        let opexMode = 'simple';
        let savedOpexScenario = null;
        let lastOpexResult = null;

        // OPEX year escalation (different from CAPEX ‚Äî energy & labor separate)
        const opexYearEscalation = {
            '2025': { energy: 1.000, labor: 1.000 },
            '2026': { energy: 1.045, labor: 1.055 },
            '2027': { energy: 1.085, labor: 1.110 },
            '2028': { energy: 1.115, labor: 1.165 },
            '2029': { energy: 1.140, labor: 1.220 },
            '2030': { energy: 1.160, labor: 1.275 }
        };
        const energyContractMult = { spot: 1.0, fixed: 1.0, green: 1.10, hybrid: 1.03 };
        const maintLevelMult = { basic: 0.7, comprehensive: 1.0, allrisk: 1.4 };
        const insuranceLevelMult = { standard: 1.0, comprehensive: 1.3, full: 1.6 };
        const dcimCostPerKw = { basic: 2, enterprise: 5, aiops: 12 };
        const contractTypeMult = { fulltime: 1.0, shift: 0.92, oncall: 0.75 };

        function switchOpexMode(mode) {
            opexMode = mode;
            document.querySelectorAll('.opex-mode-btn').forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                btn.style.background = isActive ? 'rgba(16,185,129,0.15)' : 'transparent';
                btn.style.borderColor = isActive ? 'rgba(16,185,129,0.4)' : 'rgba(255,255,255,0.15)';
                btn.style.color = isActive ? '#10b981' : '#94a3b8';
                btn.style.fontWeight = isActive ? '600' : '500';
                btn.classList.toggle('active', isActive);
            });
            document.getElementById('opexAdvancedInputs').style.display = mode === 'advanced' ? 'block' : 'none';
            updateCalculation();
            setTimeout(() => initTooltipSystem(), 50);
        }

        // Patch calculateOPEX to incorporate advanced inputs
        const _origCalcOPEX = calculateOPEX;
        calculateOPEX = function() {
            const result = _origCalcOPEX();
            if (opexMode !== 'advanced') return result;

            const yearVal = document.getElementById('opexProjYear').value;
            const esc = opexYearEscalation[yearVal];
            const energyContract = document.getElementById('energyContract').value;
            const maintLevel = document.getElementById('maintLevel').value;
            const insurLvl = document.getElementById('insuranceLevel').value;
            const dcimLvl = document.getElementById('dcimLevel').value;
            const overtime = parseFloat(document.getElementById('overtimePremium').value) / 100;
            const contractTp = document.getElementById('contractType').value;

            // Apply year escalation
            result.breakdown.energy.value *= esc.energy * energyContractMult[energyContract];
            result.breakdown.staffing.value *= esc.labor * (1 + overtime) * contractTypeMult[contractTp];
            result.breakdown.maintenance.value *= esc.labor * maintLevelMult[maintLevel];
            result.breakdown.software.value *= esc.labor; // Software licensing scales with labor inflation
            result.breakdown.insurance.value *= insuranceLevelMult[insurLvl];

            // DCIM level upgrade cost (additional on top of base software)
            const dcimCost = dcimCostPerKw[dcimLvl] * result.itLoadKW;
            result.breakdown.software.value += dcimCost;

            // Recalculate total
            result.total = Object.values(result.breakdown).reduce((sum, b) => sum + b.value, 0);
            result.monthly = result.total / 12;
            result.perKW = result.total / result.itLoadKW;
            const itLoadKW = result.itLoadKW;
            const basePue = parseFloat(document.getElementById('pueSlider').value) || 1.5;
            const utilization = parseFloat(document.getElementById('utilizationSlider').value) / 100 || 0.7;
            const annualKWh = itLoadKW * basePue * 8760 * utilization;
            result.perKWh = result.total / annualKWh;

            // Store year info
            result._yearLabel = yearVal;
            result._energyContract = energyContract;
            return result;
        };

        // ‚ïê‚ïê‚ïê OPEX COMPARE MODE ‚ïê‚ïê‚ïê
        function saveOpexScenarioA() {
            try {
                if (!lastOpexResult) updateCalculation();
                if (!lastOpexResult) { console.error('OPEX: No result available to save'); return; }
                savedOpexScenario = JSON.parse(JSON.stringify(lastOpexResult));
                document.getElementById('opexComparePanel').style.display = 'block';
                document.getElementById('opexSavedIndicator').style.display = 'block';
                document.getElementById('opexScenarioBBanner').style.display = 'flex';
                document.getElementById('btnClearOpex').style.display = 'flex';
                const btn = document.getElementById('btnSaveOpexA');
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Scenario A Saved';
                btn.style.background = 'linear-gradient(135deg,rgba(16,185,129,0.2),rgba(16,185,129,0.1))';
                btn.style.borderColor = 'rgba(16,185,129,0.5)';
                btn.style.color = '#34d399';
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
                btn.style.cursor = 'default';
                renderOpexComparison();
                setTimeout(() => document.getElementById('opexScenarioBBanner').scrollIntoView({ behavior:'smooth', block:'start' }), 100);
            } catch (e) {
                console.error('OPEX Save Error:', e);
            }
        }

        function clearOpexComparison() {
            savedOpexScenario = null;
            document.getElementById('opexComparePanel').style.display = 'none';
            document.getElementById('opexSavedIndicator').style.display = 'none';
            document.getElementById('opexScenarioBBanner').style.display = 'none';
            document.getElementById('btnClearOpex').style.display = 'none';
            const btn = document.getElementById('btnSaveOpexA');
            btn.innerHTML = '<i class="fas fa-bookmark"></i> Save Scenario A';
            btn.style.background = 'linear-gradient(135deg,rgba(16,185,129,0.15),rgba(16,185,129,0.05))';
            btn.style.borderColor = 'rgba(16,185,129,0.5)';
            btn.style.color = '#10b981';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
            btn.style.cursor = 'pointer';
        }

        function renderOpexComparison() {
            if (!savedOpexScenario || !lastOpexResult) return;
            const b = lastOpexResult;
            const a = savedOpexScenario;
            const delta = ((b.total - a.total) / a.total * 100);
            const sign = delta >= 0 ? '+' : '';
            const dColor = delta > 0 ? '#ef4444' : '#10b981';

            const renderCard = (label, data, accent) => {
                const cats = ['energy','staffing','maintenance','software','insurance','utilities','other'];
                const catLabels = { energy:'Energy', staffing:'Staffing', maintenance:'Maint & Spares', software:'Software', insurance:'Insurance', utilities:'Utilities', other:'Other' };
                const maxVal = Math.max(...cats.map(c => data.breakdown[c]?.value || 0));
                let bars = cats.filter(c => data.breakdown[c]?.value > 0).map(c => {
                    const v = data.breakdown[c].value;
                    const clr = data.breakdown[c].color;
                    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                        <span style="font-size:0.7rem;min-width:80px;color:rgba(255,255,255,0.7);">${catLabels[c]}</span>
                        <div style="flex:1;height:5px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;">
                            <div style="width:${(v/maxVal)*100}%;height:100%;background:${clr};border-radius:3px;"></div>
                        </div>
                        <span style="font-size:0.75rem;font-family:'JetBrains Mono',monospace;min-width:55px;text-align:right;">${formatCurrency(v, true)}</span>
                    </div>`;
                }).join('');
                return `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid rgba(255,255,255,0.15);">
                    <span style="font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:6px;">
                        <span style="width:24px;height:24px;border-radius:6px;background:${accent}30;color:${accent};display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;">${label}</span>
                        Scenario ${label}
                    </span>
                </div>
                <div style="text-align:center;margin-bottom:1rem;">
                    <div style="font-size:0.7rem;color:rgba(255,255,255,0.6);text-transform:uppercase;">Annual OPEX</div>
                    <div style="font-size:1.6rem;font-weight:700;color:${accent};font-family:'JetBrains Mono',monospace;">${formatCurrency(data.total)}</div>
                    <div style="font-size:0.8rem;color:rgba(255,255,255,0.7);font-family:'JetBrains Mono',monospace;">$${Math.round(data.perKW).toLocaleString()}/kW/yr</div>
                </div>
                <div>${bars}</div>`;
            };

            document.getElementById('opexScenarioACard').innerHTML = renderCard('A', a, '#fbbf24');
            document.getElementById('opexScenarioBCard').innerHTML = renderCard('B', b, '#34d399');
            document.getElementById('opexDeltaColumn').innerHTML = `
                <div style="text-align:center;">
                    <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Delta</div>
                    <div style="font-size:1.6rem;font-weight:700;color:${dColor};font-family:'JetBrains Mono',monospace;">${sign}${delta.toFixed(1)}%</div>
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px;">${sign}${formatCurrency(b.total - a.total)}</div>
                </div>
                <div style="width:2px;height:50px;background:linear-gradient(180deg,${dColor},transparent);border-radius:1px;"></div>
                <div style="text-align:center;">
                    <div style="font-size:0.7rem;color:var(--text-muted);">$/kW/yr Delta</div>
                    <div style="font-size:0.9rem;font-weight:600;color:${dColor};font-family:'JetBrains Mono',monospace;">${sign}$${Math.round(b.perKW - a.perKW).toLocaleString()}</div>
                </div>`;
        }

        // ‚ïê‚ïê‚ïê OPEX NARRATIVE CONCLUSION GENERATOR ‚ïê‚ïê‚ïê
        function generateOpexNarrative(result, dm, cf, hasCompare, savedA) {
            const total = result.total;
            const perKW = result.perKW;
            const perKWh = result.perKWh;
            const pue = result.effectivePue;
            const tier = parseInt(result._config?.tierLevel) || 3;
            const itKW = result.itLoadKW;
            const mw = itKW / 1000;
            const sd = result.staffingDetail;
            const bk = result.breakdown;

            // Category shares
            const energyPct = (bk.energy.value / total * 100);
            const staffPct = (bk.staffing.value / total * 100);
            const maintPct = (bk.maintenance.value / total * 100);

            // ‚îÄ‚îÄ Cost Profile Assessment ‚îÄ‚îÄ
            let costProfile;
            if (perKW <= dm.benchLow) costProfile = { label: 'Cost-Efficient', color: '#059669', desc: 'below the lower end of the Tier ' + tier + ' benchmark range ($' + dm.benchLow + '-$' + dm.benchHigh + '/kW). This indicates strong cost control, though operators should verify that this is not achieved through under-investment in maintenance, staffing, or spares.' };
            else if (perKW <= dm.benchMid) costProfile = { label: 'Well-Optimized', color: '#0284c7', desc: 'within the optimal range of the Tier ' + tier + ' benchmark ($' + dm.benchLow + '-$' + dm.benchHigh + '/kW). The facility balances cost management with operational adequacy.' };
            else if (perKW <= dm.benchHigh) costProfile = { label: 'Above Average', color: '#d97706', desc: 'above the midpoint of the Tier ' + tier + ' benchmark range. While this may reflect higher service quality or market conditions, there is room for cost optimization.' };
            else costProfile = { label: 'High Cost', color: '#dc2626', desc: 'above the typical Tier ' + tier + ' range ($' + dm.benchLow + '-$' + dm.benchHigh + '/kW). A detailed cost reduction analysis is recommended, targeting energy efficiency, staffing optimization, and vendor renegotiation.' };

            // ‚îÄ‚îÄ Energy Analysis ‚îÄ‚îÄ
            let energyNarrative;
            if (pue <= 1.2) energyNarrative = 'The facility operates at an excellent PUE of ' + pue.toFixed(2) + ', approaching hyperscale efficiency. Energy overhead is minimal at ' + formatCurrency(dm.pueOverhead) + '/year.';
            else if (pue <= 1.5) energyNarrative = 'PUE of ' + pue.toFixed(2) + ' is within the industry average range. Cooling infrastructure adds ' + formatCurrency(dm.pueOverhead) + '/year in overhead. A PUE improvement of just 0.1 would save <strong>' + formatCurrency(dm.pueSavings) + '/year</strong> ‚Äî a strong ROI target for efficiency projects.';
            else if (pue <= 1.8) energyNarrative = 'PUE of ' + pue.toFixed(2) + ' is above average, resulting in ' + formatCurrency(dm.pueOverhead) + '/year in cooling overhead (' + dm.coolingPct.toFixed(1) + '% of total OPEX). Significant savings potential exists: improving PUE by 0.1 saves <strong>' + formatCurrency(dm.pueSavings) + '/year</strong>. Consider economizer hours, hot/cold aisle containment, or cooling system upgrades.';
            else energyNarrative = 'PUE of ' + pue.toFixed(2) + ' indicates significant cooling inefficiency. The PUE overhead cost of ' + formatCurrency(dm.pueOverhead) + '/year (' + dm.coolingPct.toFixed(1) + '% of total OPEX) represents a major optimization opportunity. Improving PUE by 0.1 saves <strong>' + formatCurrency(dm.pueSavings) + '/year</strong>. A comprehensive cooling audit is strongly recommended.';

            // ‚îÄ‚îÄ Staffing Assessment ‚îÄ‚îÄ
            let staffNarrative;
            if (dm.staffPerMW < 8) staffNarrative = 'Staffing density of ' + dm.staffPerMW.toFixed(1) + ' FTE/MW is lean. While cost-efficient at ' + formatCurrency(dm.costPerMW) + '/MW, operators should validate that coverage is adequate for 24/7 operations, emergency response, and maintenance execution.';
            else if (dm.staffPerMW <= 15) staffNarrative = 'Staffing at ' + dm.staffPerMW.toFixed(1) + ' FTE/MW (' + formatCurrency(dm.costPerMW) + '/MW) is within normal range for a Tier ' + tier + ' facility. The in-house/contractor split of ' + sd.totalInhouse + '/' + sd.totalContractor + ' provides operational control with cost flexibility.';
            else staffNarrative = 'Staffing density of ' + dm.staffPerMW.toFixed(1) + ' FTE/MW is above the typical range. At ' + formatCurrency(dm.costPerMW) + '/MW, there may be opportunity to optimize through process automation, role consolidation, or adjusted contractor ratios.';

            // ‚îÄ‚îÄ Carbon & Sustainability ‚îÄ‚îÄ
            let carbonNarrative;
            if (dm.co2Tonnes < 1000) carbonNarrative = 'Annual CO&#8322; emissions of ' + Math.round(dm.co2Tonnes).toLocaleString() + ' tonnes are relatively low, reflecting a clean grid (emission factor: ' + dm.emFactor.toFixed(2) + ' kgCO&#8322;/kWh). Carbon cost exposure is ' + formatCurrency(dm.carbonCost) + '/year at current regional pricing ($' + dm.cPrice + '/tonne).';
            else if (dm.co2Tonnes < 10000) carbonNarrative = 'Annual CO&#8322; emissions of ' + Math.round(dm.co2Tonnes).toLocaleString() + ' tonnes represent moderate carbon exposure. At a CUE of ' + dm.cue.toFixed(3) + ' kgCO&#8322;/kWh IT, the current carbon cost is ' + formatCurrency(dm.carbonCost) + '/year. As carbon pricing increases globally, consider PPA/REC strategies for mitigation.';
            else carbonNarrative = 'Annual CO&#8322; emissions of ' + Math.round(dm.co2Tonnes).toLocaleString() + ' tonnes represent significant carbon exposure. The projected carbon cost of ' + formatCurrency(dm.carbonCost) + '/year will likely increase as regulations tighten. With a CUE of ' + dm.cue.toFixed(3) + ', this is a priority area for sustainability strategy, including renewable energy procurement and efficiency improvements.';

            // ‚îÄ‚îÄ TCO Outlook ‚îÄ‚îÄ
            let tcoNarrative = 'Over 5 years, total projected OPEX reaches <strong>' + formatCurrency(dm.tco5yr) + '</strong> (with annual escalation: energy 3%, labor 4%, general 2.5%). The 10-year projection is <strong>' + formatCurrency(dm.tco10yr) + '</strong>. ';
            if (dm.opLeverage > 0.5) tcoNarrative += 'With ' + (dm.opLeverage * 100).toFixed(0) + '% variable cost structure (high operating leverage), OPEX is sensitive to energy price fluctuations and utilization changes. Consider locking in long-term energy contracts to stabilize costs.';
            else tcoNarrative += 'With ' + (dm.opLeverage * 100).toFixed(0) + '% variable cost structure, the cost base is relatively fixed. Staffing and insurance dominate ‚Äî optimization requires longer-term structural changes rather than quick wins.';

            // ‚îÄ‚îÄ Maintenance Health ‚îÄ‚îÄ
            let maintNarrative;
            if (dm.maintToTotal < 12) maintNarrative = 'Maintenance spending at ' + dm.maintToTotal.toFixed(1) + '% of total OPEX is below the industry recommended range (15-20%). This may indicate under-investment in preventive maintenance, which increases long-term risk of equipment failure and unplanned downtime.';
            else if (dm.maintToTotal <= 22) maintNarrative = 'Maintenance allocation at ' + dm.maintToTotal.toFixed(1) + '% of total OPEX aligns with industry best practice (15-20%). This suggests appropriate investment in equipment reliability and lifecycle management.';
            else maintNarrative = 'Maintenance spending at ' + dm.maintToTotal.toFixed(1) + '% of total OPEX exceeds the typical range. While this may reflect an aging facility or premium SLA requirements, operators should review for potential over-maintenance or vendor cost optimization opportunities.';

            // ‚îÄ‚îÄ Key Actions ‚îÄ‚îÄ
            let actions = [];
            if (pue > 1.5) actions.push({ priority: 'HIGH', text: '<strong>PUE Optimization:</strong> Reduce PUE from ' + pue.toFixed(2) + '. Target 0.1 improvement to save ' + formatCurrency(dm.pueSavings) + '/year. Investigate containment, economizer hours, and VFD upgrades.' });
            if (energyPct > 50) actions.push({ priority: 'HIGH', text: '<strong>Energy Cost Reduction:</strong> Energy is ' + energyPct.toFixed(0) + '% of OPEX. Negotiate tariff optimization, explore on-site generation, or evaluate power purchase agreements.' });
            if (dm.maintToTotal < 12) actions.push({ priority: 'HIGH', text: '<strong>Increase Maintenance Investment:</strong> At ' + dm.maintToTotal.toFixed(1) + '%, maintenance is under-funded. Allocate additional budget to preventive programs to avoid costly reactive repairs.' });
            if (dm.staffPerMW > 15) actions.push({ priority: 'MEDIUM', text: '<strong>Staffing Optimization:</strong> At ' + dm.staffPerMW.toFixed(1) + ' FTE/MW, evaluate role consolidation, automation opportunities, or managed services for non-core functions.' });
            if (dm.co2Tonnes > 5000) actions.push({ priority: 'MEDIUM', text: '<strong>Carbon Strategy:</strong> ' + Math.round(dm.co2Tonnes).toLocaleString() + ' tonnes/year CO&#8322; warrants a formal sustainability roadmap. Evaluate RECs, green tariffs, or on-site renewables.' });
            if (perKW > dm.benchHigh) actions.push({ priority: 'MEDIUM', text: '<strong>Cost Benchmarking:</strong> $/kW of $' + Math.round(perKW) + ' exceeds Tier ' + tier + ' upper range ($' + dm.benchHigh + '). Commission a detailed cost audit against peer facilities.' });
            if (dm.opLeverage > 0.55) actions.push({ priority: 'LOW', text: '<strong>Cost Hedging:</strong> High variable cost ratio (' + (dm.opLeverage * 100).toFixed(0) + '%) creates price exposure. Consider long-term energy contracts and fixed-rate vendor agreements.' });
            actions.push({ priority: 'LOW', text: '<strong>Annual Review:</strong> Re-run this analysis annually with updated inputs to track cost trends, benchmark movement, and improvement ROI.' });

            const actionsHTML = actions.map(a => {
                const pColor = a.priority === 'HIGH' ? '#dc2626' : a.priority === 'MEDIUM' ? '#d97706' : '#059669';
                return `<tr><td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:${pColor};color:white;font-size:9px;font-weight:700;">${a.priority}</span></td><td style="padding:5px 8px;border-bottom:1px solid #e5e7eb;font-size:11px;">${a.text}</td></tr>`;
            }).join('');

            // ‚îÄ‚îÄ Comparison Narrative ‚îÄ‚îÄ
            let compNarrative = '';
            if (hasCompare && savedA) {
                const dmA = computeDerivedMetrics(savedA);
                const totalDelta = ((total - savedA.total) / savedA.total * 100);
                const sign = totalDelta >= 0 ? '+' : '';
                const word = totalDelta >= 0 ? 'higher' : 'lower';
                const kw5yr = dm.tco5yr - dmA.tco5yr;

                compNarrative = `
                <div style="background:#f0fdf4;border:1px solid #a7f3d0;border-radius:10px;padding:14px;margin-bottom:14px;">
                    <div style="font-size:12px;font-weight:700;color:#065f46;margin-bottom:6px;">Scenario Comparison Insight</div>
                    <p style="font-size:11px;line-height:1.6;color:#374151;margin:0 0 6px;">
                        Scenario B is <strong>${sign}${totalDelta.toFixed(1)}%</strong> (${sign}${formatCurrency(total - savedA.total)}) ${word} than Scenario A.
                        Over 5 years, this translates to a cumulative difference of <strong>${formatCurrency(Math.abs(kw5yr))}</strong> ${kw5yr > 0 ? 'additional cost' : 'in savings'}.
                    </p>
                    <p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">
                        ${Math.abs(totalDelta) > 15 ? 'The significant cost differential suggests fundamentally different operational approaches. Carefully evaluate whether the cost difference is justified by service quality, reliability, or regulatory requirements.' :
                        Math.abs(totalDelta) > 5 ? 'The moderate cost difference is likely explained by configuration changes in staffing, energy, or tier level. Review individual category deltas to identify the primary drivers.' :
                        'The scenarios are closely aligned in total cost. Differences are primarily in cost distribution rather than magnitude. Selection should be based on operational preference and risk tolerance rather than cost alone.'}
                    </p>
                </div>`;
            }

            return `
            <div style="page-break-before:auto;margin-top:24px;">
                <h2 style="font-size:16px;color:#1e3a5f;border-bottom:3px solid #1e3a5f;padding-bottom:6px;margin-bottom:14px;">Executive Assessment & Recommendations</h2>

                <!-- Cost Profile Badge -->
                <div style="display:flex;gap:12px;margin-bottom:14px;">
                    <div style="flex:0 0 140px;background:${costProfile.color};color:white;border-radius:10px;padding:16px;text-align:center;">
                        <div style="font-size:10px;opacity:0.8;text-transform:uppercase;letter-spacing:1px;">Cost Profile</div>
                        <div style="font-size:16px;font-weight:800;margin:4px 0;">${costProfile.label}</div>
                        <div style="font-size:11px;opacity:0.9;">$${Math.round(perKW)}/kW/yr</div>
                    </div>
                    <div style="flex:1;font-size:11.5px;line-height:1.65;color:#374151;">
                        <p style="margin:0 0 6px;"><strong>Cost Assessment:</strong> At <strong style="font-family:monospace;">${formatCurrency(total)}/year</strong> ($${Math.round(perKW)}/kW/yr), this facility's operational cost is ${costProfile.desc}</p>
                        <p style="margin:0;font-size:10.5px;color:#6b7280;">Efficiency Score: ${dm.efficiencyScore}/100 ¬∑ Est. Rack Count: ${dm.rackCount} ¬∑ $/Rack/Month: $${Math.round(dm.perRackMonth).toLocaleString()}</p>
                    </div>
                </div>

                <!-- Energy Analysis -->
                <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:14px;margin-bottom:14px;">
                    <div style="font-size:12px;font-weight:700;color:#92400e;margin-bottom:6px;">Energy & Cooling Analysis (${energyPct.toFixed(0)}% of OPEX)</div>
                    <p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">${energyNarrative}</p>
                </div>

                <!-- Staffing -->
                <div style="background:#ecfdf5;border:1px solid #a7f3d0;border-radius:10px;padding:14px;margin-bottom:14px;">
                    <div style="font-size:12px;font-weight:700;color:#065f46;margin-bottom:6px;">Staffing Analysis (${staffPct.toFixed(0)}% of OPEX)</div>
                    <p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">${staffNarrative}</p>
                </div>

                <!-- Maintenance Health -->
                <div style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:14px;margin-bottom:14px;">
                    <div style="font-size:12px;font-weight:700;color:#1e3a5f;margin-bottom:6px;">Maintenance Health Check</div>
                    <p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">${maintNarrative}</p>
                </div>

                <!-- Carbon -->
                <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:14px;margin-bottom:14px;">
                    <div style="font-size:12px;font-weight:700;color:#14532d;margin-bottom:6px;">Sustainability & Carbon Exposure</div>
                    <p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">${carbonNarrative}</p>
                </div>

                <!-- TCO Outlook -->
                <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:14px;margin-bottom:14px;">
                    <div style="font-size:12px;font-weight:700;color:#1e3a5f;margin-bottom:6px;">TCO & Financial Outlook</div>
                    <p style="font-size:11px;line-height:1.6;color:#374151;margin:0;">${tcoNarrative}</p>
                </div>

                ${compNarrative}

                <!-- Prioritized Action Items -->
                <div style="margin-bottom:14px;">
                    <div style="font-size:12px;font-weight:700;color:#1e3a5f;margin-bottom:8px;">Prioritized Action Items</div>
                    <table style="width:100%;border-collapse:collapse;">
                        <tr style="background:#1e3a5f;color:white;"><th style="padding:5px 8px;text-align:left;font-size:10px;width:80px;">Priority</th><th style="padding:5px 8px;text-align:left;font-size:10px;">Action</th></tr>
                        ${actionsHTML}
                    </table>
                </div>

                <!-- Summary KPI Bar -->
                <div style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);border-radius:10px;padding:14px;color:white;display:flex;gap:2px;text-align:center;">
                    ${[
                        { label: 'Annual OPEX', value: formatCurrency(total) },
                        { label: '5-Year TCO', value: formatCurrency(dm.tco5yr) },
                        { label: 'PUE Overhead', value: formatCurrency(dm.pueOverhead) },
                        { label: 'CO‚ÇÇ/Year', value: Math.round(dm.co2Tonnes).toLocaleString() + 't' },
                        { label: 'Carbon Cost', value: formatCurrency(dm.carbonCost) },
                        { label: 'Efficiency', value: dm.efficiencyScore + '/100' }
                    ].map(k => `<div style="flex:1;padding:6px;background:rgba(255,255,255,0.06);border-radius:6px;margin:0 2px;"><div style="font-size:13px;font-weight:700;font-family:monospace;">${k.value}</div><div style="font-size:8px;opacity:0.7;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;">${k.label}</div></div>`).join('')}
                </div>
            </div>`;
        }

        // ‚ïê‚ïê‚ïê EXPORT OPEX PDF (Comprehensive 12-Section Report) ‚ïê‚ïê‚ïê
        function exportOpexPDF() {
            const result = calculateOPEX();
            const cf = countryData[document.getElementById('countrySelect').value];
            const dm = computeDerivedMetrics(result);
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
            const hasCompare = !!savedOpexScenario;
            const a = savedOpexScenario;
            const b = result;
            const dmA = hasCompare ? computeDerivedMetrics(a) : null;
            const dmB = dm;
            const cfA = hasCompare && a._config ? (countryData[a._config.countryCode] || cf) : cf;

            const cats = [
                { key: 'energy', label: 'Energy', color: '#f59e0b' },
                { key: 'staffing', label: 'Staffing', color: '#10b981' },
                { key: 'maintenance', label: 'Maintenance & Spares', color: '#3b82f6' },
                { key: 'software', label: 'Software & Licensing', color: '#a855f7' },
                { key: 'insurance', label: 'Insurance & Compliance', color: '#8b5cf6' },
                { key: 'utilities', label: 'Utilities & Consumables', color: '#06b6d4' },
                { key: 'other', label: 'Other (Training, Misc)', color: '#6b7280' }
            ];

            // Helpers
            const fC = (v) => formatCurrency(v);
            const fCc = (v) => formatCurrency(v, true);
            const fN = (v) => Math.round(v).toLocaleString();
            const fP = (v) => v.toFixed(1) + '%';
            const tH = 'padding:6px 8px;text-align:left;'; // table header
            const tR = 'padding:5px 8px;border-bottom:1px solid #e5e7eb;'; // table row
            const tM = tR + 'text-align:right;font-family:monospace;'; // mono right
            const tC = tR + 'text-align:center;'; // center
            const secTitle = (title, color) => `<h2 style="font-size:14px;color:#1e3a5f;border-bottom:2px solid ${color || '#3b82f6'};padding-bottom:5px;margin:20px 0 10px;">${title}</h2>`;
            const dClr = (v) => v > 0 ? '#ef4444' : v < 0 ? '#10b981' : '#6b7280';
            const dFmt = (aVal, bVal) => {
                if (!aVal && !bVal) return '‚Äî';
                if (!aVal) return '<span style="color:#ef4444;">NEW</span>';
                const d = ((bVal - aVal) / aVal * 100);
                const s = d >= 0 ? '+' : '';
                return `<span style="color:${dClr(d)};font-weight:600;">${s}${d.toFixed(1)}%</span>`;
            };
            const hl = (aVal, bVal) => String(aVal) !== String(bVal) ? 'color:#ef4444;font-weight:700;' : 'font-weight:600;';

            // ‚îÄ‚îÄ SVG Doughnut Chart ‚îÄ‚îÄ
            function svgDonut(breakdown, total, size, label) {
                const legendH = 14 * cats.filter(c => breakdown[c.key]?.value > 0).length + 8;
                const r = size * 0.32, cx = size / 2, cy = size * 0.38;
                let svg = `<svg width="${size}" height="${size + legendH}" xmlns="http://www.w3.org/2000/svg">`;
                if (label) svg += `<text x="${cx}" y="14" text-anchor="middle" font-size="11" font-weight="700" fill="#1e3a5f">${label}</text>`;
                let angle = -Math.PI / 2;
                const items = cats.filter(c => breakdown[c.key]?.value > 0);
                items.forEach(c => {
                    const pct = breakdown[c.key].value / total;
                    const a1 = angle;
                    const a2 = angle + pct * 2 * Math.PI;
                    const largeArc = pct > 0.5 ? 1 : 0;
                    const x1 = cx + r * Math.cos(a1), y1 = cy + r * Math.sin(a1);
                    const x2 = cx + r * Math.cos(a2), y2 = cy + r * Math.sin(a2);
                    const ir = r * 0.55;
                    const ix1 = cx + ir * Math.cos(a2), iy1 = cy + ir * Math.sin(a2);
                    const ix2 = cx + ir * Math.cos(a1), iy2 = cy + ir * Math.sin(a1);
                    svg += `<path d="M${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} L${ix1},${iy1} A${ir},${ir} 0 ${largeArc},0 ${ix2},${iy2} Z" fill="${c.color}" opacity="0.85"/>`;
                    angle = a2;
                });
                svg += `<text x="${cx}" y="${cy - 4}" text-anchor="middle" font-size="14" font-weight="700" fill="#1e3a5f" font-family="monospace">${fC(total)}</text>`;
                svg += `<text x="${cx}" y="${cy + 12}" text-anchor="middle" font-size="9" fill="#6b7280">Annual OPEX</text>`;
                let ly = size * 0.75 + 10;
                items.forEach((c, i) => {
                    const yy = ly + i * 14;
                    svg += `<rect x="10" y="${yy}" width="8" height="8" rx="2" fill="${c.color}"/>`;
                    svg += `<text x="22" y="${yy + 8}" font-size="8.5" fill="#374151">${c.label} ${((breakdown[c.key].value / total) * 100).toFixed(1)}%</text>`;
                });
                svg += '</svg>';
                return svg;
            }

            // ‚ïê‚ïê‚ïê SECTION 1: EXECUTIVE SUMMARY ‚ïê‚ïê‚ïê
            const kpiCard = (label, val, sub, bg, fg) => `<div style="flex:1;background:${bg||'#f8fafc'};${bg==='#1e3a5f'?'color:white;':''}border:${bg==='#1e3a5f'?'none':'1px solid #e5e7eb'};border-radius:10px;padding:14px;text-align:center;"><div style="font-size:9px;${bg==='#1e3a5f'?'opacity:0.7;':'color:#6b7280;'}text-transform:uppercase;letter-spacing:1px;">${label}</div><div style="font-size:20px;font-weight:700;color:${fg||'#1e3a5f'};font-family:monospace;margin:3px 0;">${val}</div><div style="font-size:10px;${bg==='#1e3a5f'?'opacity:0.8;':'color:#6b7280;'}">${sub}</div></div>`;
            let sec1;
            if (hasCompare) {
                const totalDeltaPct = ((b.total - a.total) / a.total * 100);
                const ds = totalDeltaPct >= 0 ? '+' : '';
                sec1 = `
                <div style="margin-bottom:6px;font-size:11px;font-weight:700;color:#d97706;">Scenario A</div>
                <div style="display:flex;gap:10px;margin-bottom:10px;">
                    ${kpiCard('Annual OPEX', fC(a.total), fCc(a.monthly)+'/mo', '#1e3a5f', '#fbbf24')}
                    ${kpiCard('$/kW/Year', '$'+fN(a.perKW), '$'+a.perKWh.toFixed(3)+'/kWh')}
                    ${kpiCard('$/Rack/Year', '$'+fN(dmA.perRackYear), dmA.rackCount+' racks est.')}
                    ${kpiCard('Benchmark', dmA.benchPosition, 'Score: '+dmA.efficiencyScore+'/100')}
                </div>
                <div style="margin-bottom:6px;font-size:11px;font-weight:700;color:#059669;">Scenario B</div>
                <div style="display:flex;gap:10px;margin-bottom:10px;">
                    ${kpiCard('Annual OPEX', fC(b.total), fCc(b.monthly)+'/mo', '#1e3a5f', '#34d399')}
                    ${kpiCard('$/kW/Year', '$'+fN(b.perKW), '$'+b.perKWh.toFixed(3)+'/kWh')}
                    ${kpiCard('$/Rack/Year', '$'+fN(dmB.perRackYear), dmB.rackCount+' racks est.')}
                    ${kpiCard('Benchmark', dmB.benchPosition, 'Score: '+dmB.efficiencyScore+'/100')}
                </div>
                <div style="display:flex;gap:10px;margin-bottom:18px;">
                    <div style="flex:1;background:linear-gradient(135deg,#1e3a5f,#2d5a87);color:white;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:9px;opacity:0.7;text-transform:uppercase;">Total Delta</div>
                        <div style="font-size:22px;font-weight:700;color:${dClr(totalDeltaPct)};font-family:monospace;">${ds}${totalDeltaPct.toFixed(1)}%</div>
                        <div style="font-size:10px;opacity:0.8;">${ds}${fC(b.total - a.total)}/yr</div>
                    </div>
                    <div style="flex:1;background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:9px;color:#6b7280;text-transform:uppercase;">$/kW Delta</div>
                        <div style="font-size:20px;font-weight:700;color:${dClr(b.perKW - a.perKW)};font-family:monospace;">${(b.perKW-a.perKW)>=0?'+':''}$${fN(b.perKW - a.perKW)}</div>
                        <div style="font-size:10px;color:#6b7280;">A: $${fN(a.perKW)} ‚Üí B: $${fN(b.perKW)}</div>
                    </div>
                    <div style="flex:1;background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:14px;text-align:center;">
                        <div style="font-size:9px;color:#6b7280;text-transform:uppercase;">5-Year TCO Delta</div>
                        <div style="font-size:20px;font-weight:700;color:${dClr(dmB.tco5yr - dmA.tco5yr)};font-family:monospace;">${fC(Math.abs(dmB.tco5yr - dmA.tco5yr))}</div>
                        <div style="font-size:10px;color:#6b7280;">${dmB.tco5yr > dmA.tco5yr ? 'B costs more over 5yr' : 'B saves over 5yr'}</div>
                    </div>
                </div>`;
            } else {
                sec1 = `
                <div style="display:flex;gap:12px;margin-bottom:18px;">
                    ${kpiCard('Annual OPEX', fC(result.total), fCc(result.monthly)+'/mo', '#1e3a5f', '#10b981')}
                    ${kpiCard('$/kW/Year', '$'+fN(result.perKW), '$'+result.perKWh.toFixed(3)+'/kWh')}
                    ${kpiCard('$/Rack/Year', '$'+fN(dm.perRackYear), dm.rackCount+' racks est.')}
                    ${kpiCard('Benchmark', dm.benchPosition, 'Score: '+dm.efficiencyScore+'/100')}
                </div>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 2: CONFIGURATION ‚ïê‚ïê‚ïê
            let sec2 = '';
            if (hasCompare) {
                const ac = a._config || {}, bc = b._config || {};
                const cp = 'padding:4px 8px;font-size:11px;';
                const lp = cp + 'color:#6b7280;';
                sec2 = secTitle('Configuration Comparison', '#10b981') + `
                <table style="width:100%;font-size:11px;border-collapse:collapse;">
                    <tr style="background:#1e3a5f;color:white;"><th style="${tH}">Parameter</th><th style="${tH}text-align:center;color:#fbbf24;">Scenario A</th><th style="${tH}text-align:center;color:#34d399;">Scenario B</th></tr>
                    <tr><td style="${lp}">Country</td><td style="${cp}text-align:center;${hl(ac.countryName,bc.countryName)}">${ac.countryFlag||''} ${ac.countryName||cf.name}</td><td style="${cp}text-align:center;${hl(ac.countryName,bc.countryName)}">${bc.countryFlag||cf.flag} ${bc.countryName||cf.name}</td></tr>
                    <tr style="background:#f9fafb;"><td style="${lp}">IT Load</td><td style="${cp}text-align:center;${hl(a.itLoadKW,b.itLoadKW)}">${a.itLoadKW.toLocaleString()} kW</td><td style="${cp}text-align:center;${hl(a.itLoadKW,b.itLoadKW)}">${b.itLoadKW.toLocaleString()} kW</td></tr>
                    <tr><td style="${lp}">Tier</td><td style="${cp}text-align:center;${hl(ac.tierLevel,bc.tierLevel)}">Tier ${ac.tierLevel||'-'}</td><td style="${cp}text-align:center;${hl(ac.tierLevel,bc.tierLevel)}">Tier ${bc.tierLevel||'-'}</td></tr>
                    <tr style="background:#f9fafb;"><td style="${lp}">PUE</td><td style="${cp}text-align:center;${hl(ac.pue,bc.pue)}">${ac.pue||'-'}</td><td style="${cp}text-align:center;${hl(ac.pue,bc.pue)}">${bc.pue||b.effectivePue.toFixed(2)}</td></tr>
                    <tr><td style="${lp}">Cooling</td><td style="${cp}text-align:center;${hl(ac.coolingType,bc.coolingType)}">${ac.coolingType||'-'}</td><td style="${cp}text-align:center;${hl(ac.coolingType,bc.coolingType)}">${bc.coolingType||b.cooling.name}</td></tr>
                    <tr style="background:#f9fafb;"><td style="${lp}">Generator</td><td style="${cp}text-align:center;${hl(ac.genConfig,bc.genConfig)}">${ac.genConfig||'-'}</td><td style="${cp}text-align:center;${hl(ac.genConfig,bc.genConfig)}">${bc.genConfig||b.generator.name}</td></tr>
                    <tr><td style="${lp}">Staffing</td><td style="${cp}text-align:center;${hl(ac.staffingModel,bc.staffingModel)}">${ac.staffingModel||'-'}</td><td style="${cp}text-align:center;${hl(ac.staffingModel,bc.staffingModel)}">${bc.staffingModel||'-'}</td></tr>
                    <tr style="background:#f9fafb;"><td style="${lp}">Utilization</td><td style="${cp}text-align:center;${hl(ac.utilization,bc.utilization)}">${ac.utilization||'-'}</td><td style="${cp}text-align:center;${hl(ac.utilization,bc.utilization)}">${bc.utilization||'-'}</td></tr>
                </table>`;
            } else {
                sec2 = secTitle('Configuration', '#10b981') + `
                <table style="width:100%;font-size:11.5px;">
                    <tr><td style="padding:4px 0;color:#6b7280;width:130px;">Country</td><td style="padding:4px 0;font-weight:600;">${cf.flag} ${cf.name}</td><td style="padding:4px 0;color:#6b7280;width:130px;">IT Load</td><td style="padding:4px 0;font-weight:600;">${result.itLoadKW.toLocaleString()} kW</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">Tier Level</td><td style="padding:4px 0;font-weight:600;">Tier ${result._config?.tierLevel||'-'}</td><td style="padding:4px 0;color:#6b7280;">Facility Age</td><td style="padding:4px 0;font-weight:600;">${result._config?.facilityAge||'-'}</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">PUE</td><td style="padding:4px 0;font-weight:600;">${result.effectivePue.toFixed(2)}</td><td style="padding:4px 0;color:#6b7280;">Cooling</td><td style="padding:4px 0;font-weight:600;">${result.cooling.name}</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">Generator</td><td style="padding:4px 0;font-weight:600;">${result.generator.name}</td><td style="padding:4px 0;color:#6b7280;">Staffing</td><td style="padding:4px 0;font-weight:600;">${result._config?.staffingModel||'-'}</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">Utilization</td><td style="padding:4px 0;font-weight:600;">${result._config?.utilization||'-'}</td><td style="padding:4px 0;color:#6b7280;">Total FTE</td><td style="padding:4px 0;font-weight:600;">${result.staffingDetail.totalFTE}</td></tr>
                </table>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 3: COST BREAKDOWN ‚ïê‚ïê‚ïê
            let sec3;
            if (hasCompare) {
                let cmpRows = cats.filter(c => (a.breakdown[c.key]?.value > 0) || (b.breakdown[c.key]?.value > 0)).map(c => {
                    const aV = a.breakdown[c.key]?.value || 0;
                    const bV = b.breakdown[c.key]?.value || 0;
                    return `<tr><td style="${tR}"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:${c.color};margin-right:6px;"></span>${c.label}</td><td style="${tM}">${fC(aV)}</td><td style="${tR}text-align:right;color:#6b7280;">${fP(aV/a.total*100)}</td><td style="${tM}">${fC(bV)}</td><td style="${tR}text-align:right;color:#6b7280;">${fP(bV/b.total*100)}</td><td style="${tR}text-align:right;">${dFmt(aV,bV)}</td></tr>`;
                }).join('');
                sec3 = secTitle('Cost Breakdown Overview ‚Äî A vs B', '#f59e0b') + `
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;margin-bottom:12px;">
                    <tr style="background:#1e3a5f;color:white;"><th style="${tH}">Category</th><th style="${tH}text-align:right;color:#fbbf24;">A Cost</th><th style="${tH}text-align:right;color:#fbbf24;">A %</th><th style="${tH}text-align:right;color:#34d399;">B Cost</th><th style="${tH}text-align:right;color:#34d399;">B %</th><th style="${tH}text-align:right;">Delta</th></tr>
                    ${cmpRows}
                    <tr style="background:#1e3a5f;color:white;font-weight:700;"><td style="padding:6px 8px;">TOTAL</td><td style="padding:6px 8px;text-align:right;font-family:monospace;">${fC(a.total)}</td><td style="padding:6px 8px;text-align:right;">100%</td><td style="padding:6px 8px;text-align:right;font-family:monospace;">${fC(b.total)}</td><td style="padding:6px 8px;text-align:right;">100%</td><td style="padding:6px 8px;text-align:right;">${dFmt(a.total,b.total)}</td></tr>
                </table>
                <div style="display:flex;gap:16px;justify-content:center;">
                    <div style="text-align:center;">${svgDonut(a.breakdown, a.total, 200, 'Scenario A')}</div>
                    <div style="text-align:center;">${svgDonut(b.breakdown, b.total, 200, 'Scenario B')}</div>
                </div>`;
            } else {
                let breakdownRows = cats.filter(c => result.breakdown[c.key]?.value > 0).map(c => {
                    const v = result.breakdown[c.key].value;
                    return `<tr><td style="${tR}"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:${c.color};margin-right:6px;"></span>${c.label}</td><td style="${tM}">${fC(v)}</td><td style="${tR}text-align:right;color:#6b7280;">${fP(v/result.total*100)}</td><td style="${tM}">$${fN(v/result.itLoadKW)}</td></tr>`;
                }).join('');
                sec3 = secTitle('Cost Breakdown Overview', '#f59e0b') + `
                <div style="display:flex;gap:20px;align-items:flex-start;">
                    <div style="flex:1;">
                        <table style="width:100%;border-collapse:collapse;font-size:11px;">
                            <tr style="background:#1e3a5f;color:white;"><th style="${tH}">Category</th><th style="${tH}text-align:right;">Annual Cost</th><th style="${tH}text-align:right;">%</th><th style="${tH}text-align:right;">$/kW</th></tr>
                            ${breakdownRows}
                            <tr style="background:#1e3a5f;color:white;font-weight:700;"><td style="padding:6px 8px;">TOTAL</td><td style="padding:6px 8px;text-align:right;font-family:monospace;">${fC(result.total)}</td><td style="padding:6px 8px;text-align:right;">100%</td><td style="padding:6px 8px;text-align:right;font-family:monospace;">$${fN(result.perKW)}</td></tr>
                        </table>
                    </div>
                    <div style="flex:0 0 240px;text-align:center;">${svgDonut(result.breakdown, result.total, 240)}</div>
                </div>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 4: STAFFING ANALYSIS ‚ïê‚ïê‚ïê
            const sd = result.staffingDetail;
            let sec4;
            if (hasCompare) {
                const sdA = a.staffingDetail;
                const allRoles = new Set();
                sdA.details.forEach(r => { if (r.fte > 0) allRoles.add(r.roleId); });
                sd.details.forEach(r => { if (r.fte > 0) allRoles.add(r.roleId); });
                let cmpStaffRows = '';
                allRoles.forEach(rid => {
                    const rA = sdA.details.find(x => x.roleId === rid) || { name: '‚Äî', fte: 0, totalCost: 0 };
                    const rB = sd.details.find(x => x.roleId === rid) || { name: '‚Äî', fte: 0, totalCost: 0 };
                    const name = rB.name !== '‚Äî' ? rB.name : rA.name;
                    cmpStaffRows += `<tr><td style="${tR}">${name}</td><td style="${tC}">${rA.fte.toFixed(1)}</td><td style="${tM}">${fC(rA.totalCost)}</td><td style="${tC}">${rB.fte.toFixed(1)}</td><td style="${tM}">${fC(rB.totalCost)}</td><td style="${tR}text-align:right;">${dFmt(rA.totalCost,rB.totalCost)}</td></tr>`;
                });
                sec4 = secTitle('Staffing Analysis ‚Äî A vs B', '#10b981') + `
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                    <tr style="background:#10b981;color:white;"><th style="${tH}">Role</th><th style="${tH}text-align:center;color:#fbbf24;">A FTE</th><th style="${tH}text-align:right;color:#fbbf24;">A Cost</th><th style="${tH}text-align:center;color:#d1fae5;">B FTE</th><th style="${tH}text-align:right;color:#d1fae5;">B Cost</th><th style="${tH}text-align:right;">Delta</th></tr>
                    ${cmpStaffRows}
                    <tr style="background:#1e3a5f;color:white;font-weight:700;"><td style="padding:6px 8px;">TOTAL</td><td style="padding:6px 8px;text-align:center;">${sdA.totalFTE}</td><td style="padding:6px 8px;text-align:right;font-family:monospace;">${fC(sdA.totalCost)}</td><td style="padding:6px 8px;text-align:center;">${sd.totalFTE}</td><td style="padding:6px 8px;text-align:right;font-family:monospace;">${fC(sd.totalCost)}</td><td style="padding:6px 8px;text-align:right;">${dFmt(sdA.totalCost,sd.totalCost)}</td></tr>
                </table>
                <div style="display:flex;gap:20px;margin-top:8px;font-size:10.5px;">
                    <div style="flex:1;background:#fef3c7;border-radius:6px;padding:6px 10px;"><strong style="color:#92400e;">A:</strong> Staff/MW: ${dmA.staffPerMW.toFixed(1)} ¬∑ Cost/MW: ${fC(dmA.costPerMW)} ¬∑ In-House: ${sdA.totalFTE > 0 ? ((sdA.totalInhouse/sdA.totalFTE)*100).toFixed(0) : 0}%</div>
                    <div style="flex:1;background:#d1fae5;border-radius:6px;padding:6px 10px;"><strong style="color:#065f46;">B:</strong> Staff/MW: ${dmB.staffPerMW.toFixed(1)} ¬∑ Cost/MW: ${fC(dmB.costPerMW)} ¬∑ In-House: ${sd.totalFTE > 0 ? ((sd.totalInhouse/sd.totalFTE)*100).toFixed(0) : 0}%</div>
                </div>`;
            } else {
                let staffRows = sd.details.filter(r => r.fte > 0).map(r =>
                    `<tr><td style="${tR}">${r.name}</td><td style="${tC}">${r.fte.toFixed(1)}</td><td style="${tC}">${r.inhouseFTE.toFixed(1)}</td><td style="${tC}">${r.contractorFTE.toFixed(1)}</td><td style="${tM}">${fC(r.totalCost)}</td></tr>`
                ).join('');
                sec4 = secTitle('Staffing Analysis', '#10b981') + `
                <table style="width:100%;border-collapse:collapse;font-size:11px;">
                    <tr style="background:#10b981;color:white;"><th style="${tH}">Role</th><th style="${tH}text-align:center;">FTE</th><th style="${tH}text-align:center;">In-House</th><th style="${tH}text-align:center;">Contractor</th><th style="${tH}text-align:right;">Annual Cost</th></tr>
                    ${staffRows}
                    <tr style="background:#1e3a5f;color:white;font-weight:700;"><td style="padding:6px 8px;">TOTAL</td><td style="padding:6px 8px;text-align:center;">${sd.totalFTE}</td><td style="padding:6px 8px;text-align:center;">${sd.totalInhouse}</td><td style="padding:6px 8px;text-align:center;">${sd.totalContractor}</td><td style="padding:6px 8px;text-align:right;font-family:monospace;">${fC(sd.totalCost)}</td></tr>
                </table>
                <div style="display:flex;gap:16px;margin-top:8px;font-size:11px;">
                    <div><span style="color:#6b7280;">Staff/MW:</span> <strong>${dm.staffPerMW.toFixed(1)}</strong></div>
                    <div><span style="color:#6b7280;">Cost/MW:</span> <strong>${fC(dm.costPerMW)}</strong></div>
                    <div><span style="color:#6b7280;">In-House Ratio:</span> <strong>${sd.totalFTE > 0 ? ((sd.totalInhouse/sd.totalFTE)*100).toFixed(0) : 0}%</strong></div>
                </div>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 5: MAINTENANCE & SPARE PARTS ‚ïê‚ïê‚ïê
            const md = result.maintenanceDetail;
            let sec5;
            if (hasCompare) {
                const mdA = a.maintenanceDetail;
                const allMaintKeys = new Set([...Object.keys(mdA), ...Object.keys(md)]);
                let cmpMaintRows = '';
                allMaintKeys.forEach(k => {
                    const vA = mdA[k] || { cost: 0 };
                    const vB = md[k] || { cost: 0 };
                    cmpMaintRows += `<tr><td style="${tR}">${k.charAt(0).toUpperCase() + k.slice(1)}</td><td style="${tM}">${fC(vA.cost)}</td><td style="${tM}">${fC(vB.cost)}</td><td style="${tR}text-align:right;">${dFmt(vA.cost,vB.cost)}</td></tr>`;
                });
                const allSpareKeys = new Set([...Object.keys(a.sparePartsDetail||{}), ...Object.keys(result.sparePartsDetail||{})]);
                let cmpSpareRows = '';
                allSpareKeys.forEach(k => {
                    const vA = (a.sparePartsDetail||{})[k] || { name: k, cost: 0 };
                    const vB = (result.sparePartsDetail||{})[k] || { name: k, cost: 0 };
                    cmpSpareRows += `<tr><td style="${tR}">${vB.name || vA.name}</td><td style="${tM}">${fC(vA.cost)}</td><td style="${tM}">${fC(vB.cost)}</td><td style="${tR}text-align:right;">${dFmt(vA.cost,vB.cost)}</td></tr>`;
                });
                sec5 = secTitle('Maintenance & Spare Parts ‚Äî A vs B', '#3b82f6') + `
                <div style="font-size:11px;font-weight:700;color:#3b82f6;margin-bottom:6px;">Maintenance by System</div>
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;margin-bottom:10px;">
                    <tr style="background:#3b82f6;color:white;"><th style="${tH}">System</th><th style="${tH}text-align:right;color:#fbbf24;">A Cost</th><th style="${tH}text-align:right;color:#bfdbfe;">B Cost</th><th style="${tH}text-align:right;">Delta</th></tr>
                    ${cmpMaintRows}
                </table>
                <div style="font-size:11px;font-weight:700;color:#3b82f6;margin-bottom:6px;">Spare Parts Inventory</div>
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                    <tr style="background:#3b82f6;color:white;"><th style="${tH}">Category</th><th style="${tH}text-align:right;color:#fbbf24;">A Cost</th><th style="${tH}text-align:right;color:#bfdbfe;">B Cost</th><th style="${tH}text-align:right;">Delta</th></tr>
                    ${cmpSpareRows}
                    <tr style="background:#eff6ff;font-weight:600;"><td style="padding:5px 8px;">Total Spares</td><td style="padding:5px 8px;text-align:right;font-family:monospace;">${fC(a.totalSparePartsCost||0)}</td><td style="padding:5px 8px;text-align:right;font-family:monospace;">${fC(result.totalSparePartsCost)}</td><td style="padding:5px 8px;text-align:right;">${dFmt(a.totalSparePartsCost||0,result.totalSparePartsCost)}</td></tr>
                </table>
                <div style="display:flex;gap:20px;margin-top:6px;font-size:10.5px;">
                    <div><span style="color:#92400e;font-weight:600;">A Maint/Total:</span> <strong>${dmA.maintToTotal.toFixed(1)}%</strong></div>
                    <div><span style="color:#065f46;font-weight:600;">B Maint/Total:</span> <strong>${dmB.maintToTotal.toFixed(1)}%</strong></div>
                    <div style="color:#6b7280;">(industry target: 15-20%)</div>
                </div>`;
            } else {
                let maintRows = Object.entries(md).map(([k, v]) =>
                    `<tr><td style="${tR}">${k.charAt(0).toUpperCase() + k.slice(1)}</td><td style="${tM}">${fC(v.cost)}</td><td style="${tR}text-align:right;color:#6b7280;">$${v.perKw.toFixed(2)}/kW</td><td style="${tR}text-align:center;">${v.frequency||'-'}</td></tr>`
                ).join('');
                let spareRows = Object.entries(result.sparePartsDetail).map(([k, v]) =>
                    `<tr><td style="${tR}">${v.name}</td><td style="${tM}">${fC(v.cost)}</td><td style="${tR}text-align:right;color:#6b7280;">$${v.perKw.toFixed(2)}/kW</td></tr>`
                ).join('');
                sec5 = secTitle('Maintenance & Spare Parts', '#3b82f6') + `
                <div style="display:flex;gap:16px;">
                    <div style="flex:1;">
                        <div style="font-size:11px;font-weight:700;color:#3b82f6;margin-bottom:6px;">Maintenance by System</div>
                        <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                            <tr style="background:#3b82f6;color:white;"><th style="${tH}">System</th><th style="${tH}text-align:right;">Cost</th><th style="${tH}text-align:right;">$/kW</th><th style="${tH}text-align:center;">Freq.</th></tr>
                            ${maintRows}
                        </table>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:11px;font-weight:700;color:#3b82f6;margin-bottom:6px;">Spare Parts Inventory</div>
                        <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                            <tr style="background:#3b82f6;color:white;"><th style="${tH}">Category</th><th style="${tH}text-align:right;">Cost</th><th style="${tH}text-align:right;">$/kW</th></tr>
                            ${spareRows}
                            <tr style="background:#eff6ff;font-weight:600;"><td style="padding:5px 8px;">Total Spares</td><td style="padding:5px 8px;text-align:right;font-family:monospace;">${fC(result.totalSparePartsCost)}</td><td></td></tr>
                        </table>
                    </div>
                </div>
                <div style="margin-top:6px;font-size:11px;"><span style="color:#6b7280;">Maintenance/Total Ratio:</span> <strong>${dm.maintToTotal.toFixed(1)}%</strong> <span style="color:#6b7280;">(industry target: 15-20%)</span></div>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 6: SOFTWARE & LICENSING ‚ïê‚ïê‚ïê
            let sec6;
            if (hasCompare) {
                const allSoftKeys = new Set([...Object.keys(a.softwareDetail||{}), ...Object.keys(result.softwareDetail||{})]);
                let cmpSoftRows = '';
                allSoftKeys.forEach(k => {
                    const vA = (a.softwareDetail||{})[k] || { name: k, cost: 0 };
                    const vB = (result.softwareDetail||{})[k] || { name: k, cost: 0 };
                    cmpSoftRows += `<tr><td style="${tR}">${vB.name || vA.name}</td><td style="${tM}">${fC(vA.cost)}</td><td style="${tM}">${fC(vB.cost)}</td><td style="${tR}text-align:right;">${dFmt(vA.cost,vB.cost)}</td></tr>`;
                });
                sec6 = secTitle('Software & Licensing ‚Äî A vs B', '#a855f7') + `
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                    <tr style="background:#a855f7;color:white;"><th style="${tH}">Platform</th><th style="${tH}text-align:right;color:#fbbf24;">A Cost</th><th style="${tH}text-align:right;color:#e9d5ff;">B Cost</th><th style="${tH}text-align:right;">Delta</th></tr>
                    ${cmpSoftRows}
                    <tr style="background:#f5f3ff;font-weight:600;"><td style="padding:5px 8px;">Total Software</td><td style="padding:5px 8px;text-align:right;font-family:monospace;">${fC(a.totalSoftwareCost||0)}</td><td style="padding:5px 8px;text-align:right;font-family:monospace;">${fC(result.totalSoftwareCost)}</td><td style="padding:5px 8px;text-align:right;">${dFmt(a.totalSoftwareCost||0,result.totalSoftwareCost)}</td></tr>
                </table>`;
            } else {
                let softRows = Object.entries(result.softwareDetail).map(([k, v]) =>
                    `<tr><td style="${tR}">${v.name}</td><td style="${tM}">${fC(v.cost)}</td><td style="${tR}text-align:right;color:#6b7280;">$${v.perKw.toFixed(2)}/kW</td></tr>`
                ).join('');
                sec6 = secTitle('Software & Licensing', '#a855f7') + `
                <table style="width:100%;border-collapse:collapse;font-size:11px;">
                    <tr style="background:#a855f7;color:white;"><th style="${tH}">Platform</th><th style="${tH}text-align:right;">Annual Cost</th><th style="${tH}text-align:right;">$/kW</th></tr>
                    ${softRows}
                    <tr style="background:#f5f3ff;font-weight:600;"><td style="padding:5px 8px;">Total Software</td><td style="padding:5px 8px;text-align:right;font-family:monospace;">${fC(result.totalSoftwareCost)}</td><td></td></tr>
                </table>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 7: ENERGY & EFFICIENCY ‚ïê‚ïê‚ïê
            let sec7;
            if (hasCompare) {
                const eA = a.breakdown.energy.value;
                const eB = b.breakdown.energy.value;
                const kp = 'padding:4px 8px;font-size:10.5px;';
                sec7 = secTitle('Energy & Efficiency Analysis ‚Äî A vs B', '#f59e0b') + `
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                    <tr style="background:#f59e0b;color:white;"><th style="${tH}">Metric</th><th style="${tH}text-align:right;color:#fef3c7;">Scenario A</th><th style="${tH}text-align:right;color:#fef3c7;">Scenario B</th><th style="${tH}text-align:right;">Delta</th></tr>
                    <tr><td style="${kp}color:#6b7280;">Annual Energy Cost</td><td style="${kp}text-align:right;font-family:monospace;font-weight:700;">${fC(eA)}</td><td style="${kp}text-align:right;font-family:monospace;font-weight:700;">${fC(eB)}</td><td style="${kp}text-align:right;">${dFmt(eA,eB)}</td></tr>
                    <tr style="background:#fefce8;"><td style="${kp}color:#6b7280;">Annual kWh</td><td style="${kp}text-align:right;">${fN(dmA.annualKWh)}</td><td style="${kp}text-align:right;">${fN(dmB.annualKWh)}</td><td style="${kp}text-align:right;">${dFmt(dmA.annualKWh,dmB.annualKWh)}</td></tr>
                    <tr><td style="${kp}color:#6b7280;">Energy Intensity (kWh/kW IT/yr)</td><td style="${kp}text-align:right;">${fN(dmA.energyIntensity)}</td><td style="${kp}text-align:right;">${fN(dmB.energyIntensity)}</td><td style="${kp}text-align:right;">${dFmt(dmA.energyIntensity,dmB.energyIntensity)}</td></tr>
                    <tr style="background:#fefce8;"><td style="${kp}color:#6b7280;">PUE</td><td style="${kp}text-align:right;font-weight:600;">${a.effectivePue.toFixed(2)}</td><td style="${kp}text-align:right;font-weight:600;">${b.effectivePue.toFixed(2)}</td><td style="${kp}text-align:right;font-weight:600;color:${b.effectivePue < a.effectivePue ? '#059669' : b.effectivePue > a.effectivePue ? '#ef4444' : '#6b7280'};">${b.effectivePue < a.effectivePue ? 'Improved' : b.effectivePue > a.effectivePue ? 'Worse' : 'Same'}</td></tr>
                    <tr><td style="${kp}color:#6b7280;">PUE Overhead Cost</td><td style="${kp}text-align:right;font-family:monospace;color:#ef4444;">${fC(dmA.pueOverhead)}</td><td style="${kp}text-align:right;font-family:monospace;color:#ef4444;">${fC(dmB.pueOverhead)}</td><td style="${kp}text-align:right;">${dFmt(dmA.pueOverhead,dmB.pueOverhead)}</td></tr>
                    <tr style="background:#fefce8;"><td style="${kp}color:#6b7280;">Cooling % of OPEX</td><td style="${kp}text-align:right;">${dmA.coolingPct.toFixed(1)}%</td><td style="${kp}text-align:right;">${dmB.coolingPct.toFixed(1)}%</td><td style="${kp}text-align:right;">${(dmB.coolingPct - dmA.coolingPct) >= 0 ? '+' : ''}${(dmB.coolingPct - dmA.coolingPct).toFixed(1)}pp</td></tr>
                    <tr><td style="${kp}color:#059669;font-weight:600;">PUE -0.1 Savings Potential</td><td style="${kp}text-align:right;font-family:monospace;color:#059669;font-weight:700;">${fC(dmA.pueSavings)}/yr</td><td style="${kp}text-align:right;font-family:monospace;color:#059669;font-weight:700;">${fC(dmB.pueSavings)}/yr</td><td></td></tr>
                </table>`;
            } else {
                const energyCost = result.breakdown.energy.value;
                sec7 = secTitle('Energy & Efficiency Analysis', '#f59e0b') + `
                <table style="width:100%;font-size:11px;">
                    <tr><td style="padding:4px 0;color:#6b7280;width:200px;">Annual Energy Cost</td><td style="padding:4px 0;font-weight:700;font-family:monospace;">${fC(energyCost)}</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">Annual Energy Consumption</td><td style="padding:4px 0;font-weight:600;">${fN(dm.annualKWh)} kWh</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">Energy Intensity</td><td style="padding:4px 0;font-weight:600;">${fN(dm.energyIntensity)} kWh/kW IT/yr</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">PUE Overhead Cost (cooling inefficiency)</td><td style="padding:4px 0;font-weight:700;color:#ef4444;font-family:monospace;">${fC(dm.pueOverhead)}</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">Cooling Cost as % of Total OPEX</td><td style="padding:4px 0;font-weight:600;">${dm.coolingPct.toFixed(1)}%</td></tr>
                    <tr style="background:#fffbeb;"><td style="padding:6px 0;color:#92400e;font-weight:600;">Savings if PUE improved by 0.1</td><td style="padding:6px 0;font-weight:700;color:#059669;font-family:monospace;">${fC(dm.pueSavings)}/yr</td></tr>
                </table>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 8: UTILITIES & CONSUMABLES ‚ïê‚ïê‚ïê
            const ud = result.utilitiesDetail;
            let sec8;
            if (hasCompare) {
                const udA = a.utilitiesDetail || {};
                const allUtilKeys = new Set([...Object.keys(udA), ...Object.keys(ud)]);
                let cmpUtilRows = '';
                allUtilKeys.forEach(k => {
                    const vA = udA[k] || { cost: 0 };
                    const vB = ud[k] || { cost: 0 };
                    cmpUtilRows += `<tr><td style="${tR}">${k.charAt(0).toUpperCase() + k.slice(1)}</td><td style="${tM}">${fC(vA.cost)}</td><td style="${tM}">${fC(vB.cost)}</td><td style="${tR}text-align:right;">${dFmt(vA.cost,vB.cost)}</td></tr>`;
                });
                sec8 = secTitle('Utilities & Consumables ‚Äî A vs B', '#06b6d4') + `
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                    <tr style="background:#06b6d4;color:white;"><th style="${tH}">Item</th><th style="${tH}text-align:right;color:#cffafe;">A Cost</th><th style="${tH}text-align:right;color:#cffafe;">B Cost</th><th style="${tH}text-align:right;">Delta</th></tr>
                    ${cmpUtilRows}
                </table>`;
            } else {
                let utilRows = Object.entries(ud).map(([k, v]) =>
                    `<tr><td style="${tR}">${k.charAt(0).toUpperCase() + k.slice(1)}</td><td style="${tM}">${fC(v.cost)}</td><td style="${tR}text-align:right;color:#6b7280;">$${v.perKw.toFixed(2)}/kW</td><td style="${tR}color:#6b7280;font-size:10px;">${v.notes||''}</td></tr>`
                ).join('');
                sec8 = secTitle('Utilities & Consumables', '#06b6d4') + `
                <table style="width:100%;border-collapse:collapse;font-size:11px;">
                    <tr style="background:#06b6d4;color:white;"><th style="${tH}">Item</th><th style="${tH}text-align:right;">Annual Cost</th><th style="${tH}text-align:right;">$/kW</th><th style="${tH}">Notes</th></tr>
                    ${utilRows}
                </table>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 9: INSURANCE & COMPLIANCE ‚ïê‚ïê‚ïê
            const insDetail = result.insuranceDetail;
            let sec9;
            if (hasCompare) {
                const insA = a.insuranceDetail || {};
                const allInsKeys = new Set([...Object.keys(insA), ...Object.keys(insDetail)]);
                let cmpInsRows = '';
                allInsKeys.forEach(k => {
                    const vA = insA[k] || { name: k, cost: 0 };
                    const vB = insDetail[k] || { name: k, cost: 0 };
                    cmpInsRows += `<tr><td style="${tR}">${vB.name || vA.name}</td><td style="${tM}">${fC(vA.cost)}</td><td style="${tM}">${fC(vB.cost)}</td><td style="${tR}text-align:right;">${dFmt(vA.cost,vB.cost)}</td></tr>`;
                });
                const compA = a.complianceDetail || {};
                const compB = result.complianceDetail || {};
                const allCompKeys = new Set([...Object.keys(compA), ...Object.keys(compB)]);
                let cmpCompRows = '';
                allCompKeys.forEach(k => {
                    const vA = compA[k] || { name: k, cost: 0 };
                    const vB = compB[k] || { name: k, cost: 0 };
                    cmpCompRows += `<tr><td style="${tR}">${vB.name || vA.name}</td><td style="${tM}">${fC(vA.cost)}</td><td style="${tM}">${fC(vB.cost)}</td><td style="${tR}text-align:right;">${dFmt(vA.cost,vB.cost)}</td></tr>`;
                });
                sec9 = secTitle('Insurance & Compliance ‚Äî A vs B', '#8b5cf6') + `
                <div style="font-size:11px;font-weight:700;color:#8b5cf6;margin-bottom:6px;">Insurance Coverage</div>
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;margin-bottom:10px;">
                    <tr style="background:#8b5cf6;color:white;"><th style="${tH}">Type</th><th style="${tH}text-align:right;color:#e9d5ff;">A Premium</th><th style="${tH}text-align:right;color:#e9d5ff;">B Premium</th><th style="${tH}text-align:right;">Delta</th></tr>
                    ${cmpInsRows}
                </table>
                <div style="font-size:11px;font-weight:700;color:#8b5cf6;margin-bottom:6px;">Compliance & Certifications</div>
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                    <tr style="background:#8b5cf6;color:white;"><th style="${tH}">Certification</th><th style="${tH}text-align:right;color:#e9d5ff;">A Cost</th><th style="${tH}text-align:right;color:#e9d5ff;">B Cost</th><th style="${tH}text-align:right;">Delta</th></tr>
                    ${cmpCompRows || '<tr><td style="padding:8px;color:#6b7280;" colspan="4">No country-specific compliance items</td></tr>'}
                </table>`;
            } else {
                let insRows = Object.entries(insDetail).map(([k, v]) =>
                    `<tr><td style="${tR}">${v.name}</td><td style="${tM}">${fC(v.cost)}</td><td style="${tR}text-align:center;">${v.renewal||'Annual'}</td></tr>`
                ).join('');
                let compRows = Object.entries(result.complianceDetail || {}).map(([k, v]) =>
                    `<tr><td style="${tR}">${v.name}</td><td style="${tM}">${fC(v.cost)}</td><td style="${tR}text-align:center;">${v.renewal||'-'}</td></tr>`
                ).join('');
                sec9 = secTitle('Insurance & Compliance', '#8b5cf6') + `
                <div style="display:flex;gap:16px;">
                    <div style="flex:1;">
                        <div style="font-size:11px;font-weight:700;color:#8b5cf6;margin-bottom:6px;">Insurance Coverage</div>
                        <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                            <tr style="background:#8b5cf6;color:white;"><th style="${tH}">Type</th><th style="${tH}text-align:right;">Premium</th><th style="${tH}text-align:center;">Renewal</th></tr>
                            ${insRows}
                        </table>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:11px;font-weight:700;color:#8b5cf6;margin-bottom:6px;">Compliance & Certifications</div>
                        <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                            <tr style="background:#8b5cf6;color:white;"><th style="${tH}">Certification</th><th style="${tH}text-align:right;">Cost</th><th style="${tH}text-align:center;">Cycle</th></tr>
                            ${compRows || '<tr><td style="padding:8px;color:#6b7280;" colspan="3">No country-specific compliance items</td></tr>'}
                        </table>
                    </div>
                </div>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 10: SUSTAINABILITY / CARBON ‚ïê‚ïê‚ïê
            let sec10;
            if (hasCompare) {
                const kp = 'padding:4px 8px;font-size:10.5px;';
                sec10 = secTitle('Sustainability & Carbon Analysis ‚Äî A vs B', '#059669') + `
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;">
                    <tr style="background:#059669;color:white;"><th style="${tH}">Metric</th><th style="${tH}text-align:right;color:#d1fae5;">Scenario A</th><th style="${tH}text-align:right;color:#d1fae5;">Scenario B</th><th style="${tH}text-align:right;">Delta</th></tr>
                    <tr><td style="${kp}color:#6b7280;">Grid Emission Factor</td><td style="${kp}text-align:right;">${dmA.emFactor.toFixed(2)} kgCO‚ÇÇ/kWh</td><td style="${kp}text-align:right;">${dmB.emFactor.toFixed(2)} kgCO‚ÇÇ/kWh</td><td style="${kp}text-align:right;">${dmA.emFactor !== dmB.emFactor ? 'Changed' : 'Same'}</td></tr>
                    <tr style="background:#f0fdf4;"><td style="${kp}color:#6b7280;">Annual CO‚ÇÇ Emissions</td><td style="${kp}text-align:right;font-family:monospace;font-weight:700;">${fN(dmA.co2Tonnes)} t</td><td style="${kp}text-align:right;font-family:monospace;font-weight:700;">${fN(dmB.co2Tonnes)} t</td><td style="${kp}text-align:right;">${dFmt(dmA.co2Tonnes,dmB.co2Tonnes)}</td></tr>
                    <tr><td style="${kp}color:#6b7280;">CUE (kgCO‚ÇÇ/kWh IT)</td><td style="${kp}text-align:right;">${dmA.cue.toFixed(3)}</td><td style="${kp}text-align:right;">${dmB.cue.toFixed(3)}</td><td style="${kp}text-align:right;">${dFmt(dmA.cue,dmB.cue)}</td></tr>
                    <tr style="background:#f0fdf4;"><td style="${kp}color:#6b7280;">Carbon Price ($/tonne)</td><td style="${kp}text-align:right;">$${dmA.cPrice}</td><td style="${kp}text-align:right;">$${dmB.cPrice}</td><td style="${kp}text-align:right;">${dmA.cPrice !== dmB.cPrice ? 'Changed' : 'Same'}</td></tr>
                    <tr><td style="${kp}color:#dc2626;font-weight:600;">Projected Carbon Cost</td><td style="${kp}text-align:right;font-family:monospace;color:#dc2626;font-weight:700;">${fC(dmA.carbonCost)}/yr</td><td style="${kp}text-align:right;font-family:monospace;color:#dc2626;font-weight:700;">${fC(dmB.carbonCost)}/yr</td><td style="${kp}text-align:right;">${dFmt(dmA.carbonCost,dmB.carbonCost)}</td></tr>
                </table>`;
            } else {
                sec10 = secTitle('Sustainability & Carbon Analysis', '#059669') + `
                <table style="width:100%;font-size:11px;">
                    <tr><td style="padding:4px 0;color:#6b7280;width:220px;">Grid Emission Factor</td><td style="padding:4px 0;font-weight:600;">${dm.emFactor.toFixed(2)} kgCO<sub>2</sub>/kWh</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">Annual CO<sub>2</sub> Emissions</td><td style="padding:4px 0;font-weight:700;font-family:monospace;">${fN(dm.co2Tonnes)} tonnes</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">Carbon Use Effectiveness (CUE)</td><td style="padding:4px 0;font-weight:600;">${dm.cue.toFixed(3)} kgCO<sub>2</sub>/kWh IT</td></tr>
                    <tr><td style="padding:4px 0;color:#6b7280;">Regional Carbon Price</td><td style="padding:4px 0;font-weight:600;">$${dm.cPrice}/tonne</td></tr>
                    <tr style="background:#ecfdf5;"><td style="padding:6px 0;color:#065f46;font-weight:600;">Projected Carbon Cost</td><td style="padding:6px 0;font-weight:700;color:#dc2626;font-family:monospace;">${fC(dm.carbonCost)}/yr</td></tr>
                </table>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 11: FINANCIAL PROJECTIONS ‚ïê‚ïê‚ïê
            let sec11;
            if (hasCompare) {
                const kp = 'padding:4px 8px;font-size:10.5px;';
                sec11 = secTitle('Financial Projections & Analysis ‚Äî A vs B', '#1e3a5f') + `
                <table style="width:100%;border-collapse:collapse;font-size:10.5px;margin-bottom:10px;">
                    <tr style="background:#1e3a5f;color:white;"><th style="${tH}">Metric</th><th style="${tH}text-align:right;color:#fbbf24;">Scenario A</th><th style="${tH}text-align:right;color:#34d399;">Scenario B</th><th style="${tH}text-align:right;">Delta</th></tr>
                    <tr><td style="${kp}color:#6b7280;">5-Year Projected OPEX</td><td style="${kp}text-align:right;font-family:monospace;font-weight:700;">${fC(dmA.tco5yr)}</td><td style="${kp}text-align:right;font-family:monospace;font-weight:700;">${fC(dmB.tco5yr)}</td><td style="${kp}text-align:right;">${dFmt(dmA.tco5yr,dmB.tco5yr)}</td></tr>
                    <tr style="background:#f8fafc;"><td style="${kp}color:#6b7280;">10-Year Projected OPEX</td><td style="${kp}text-align:right;font-family:monospace;font-weight:700;">${fC(dmA.tco10yr)}</td><td style="${kp}text-align:right;font-family:monospace;font-weight:700;">${fC(dmB.tco10yr)}</td><td style="${kp}text-align:right;">${dFmt(dmA.tco10yr,dmB.tco10yr)}</td></tr>
                    <tr><td style="${kp}color:#6b7280;">Fixed Costs</td><td style="${kp}text-align:right;">${fC(dmA.fixedCost)} (${dmA.fixedPct.toFixed(1)}%)</td><td style="${kp}text-align:right;">${fC(dmB.fixedCost)} (${dmB.fixedPct.toFixed(1)}%)</td><td style="${kp}text-align:right;">${dFmt(dmA.fixedCost,dmB.fixedCost)}</td></tr>
                    <tr style="background:#f8fafc;"><td style="${kp}color:#6b7280;">Variable Costs</td><td style="${kp}text-align:right;">${fC(dmA.variableCost)} (${dmA.variablePct.toFixed(1)}%)</td><td style="${kp}text-align:right;">${fC(dmB.variableCost)} (${dmB.variablePct.toFixed(1)}%)</td><td style="${kp}text-align:right;">${dFmt(dmA.variableCost,dmB.variableCost)}</td></tr>
                    <tr><td style="${kp}color:#6b7280;">Operating Leverage</td><td style="${kp}text-align:right;">${(dmA.opLeverage*100).toFixed(1)}% variable</td><td style="${kp}text-align:right;">${(dmB.opLeverage*100).toFixed(1)}% variable</td><td style="${kp}text-align:right;">${((dmB.opLeverage - dmA.opLeverage)*100).toFixed(1)}pp</td></tr>
                </table>
                <div style="font-size:10px;color:#6b7280;margin-bottom:10px;">Escalation: Energy 3%/yr, Labor 4%/yr, General 2.5%/yr</div>
                <div style="font-size:11px;font-weight:700;color:#1e3a5f;margin-bottom:6px;">Industry Benchmark Position</div>
                <div style="display:flex;gap:12px;">
                    <div style="flex:1;background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:8px 10px;font-size:10.5px;">
                        <strong style="color:#92400e;">A:</strong> $${fN(a.perKW)}/kW ¬∑ ${dmA.benchPosition} ¬∑ Score: ${dmA.efficiencyScore}/100
                    </div>
                    <div style="flex:1;background:#d1fae5;border:1px solid #a7f3d0;border-radius:8px;padding:8px 10px;font-size:10.5px;">
                        <strong style="color:#065f46;">B:</strong> $${fN(b.perKW)}/kW ¬∑ ${dmB.benchPosition} ¬∑ Score: ${dmB.efficiencyScore}/100
                    </div>
                </div>`;
            } else {
                sec11 = secTitle('Financial Projections & Analysis', '#1e3a5f') + `
                <div style="display:flex;gap:20px;">
                    <div style="flex:1;">
                        <div style="font-size:11px;font-weight:700;color:#1e3a5f;margin-bottom:6px;">TCO Projections (with escalation)</div>
                        <table style="width:100%;font-size:11px;">
                            <tr><td style="padding:4px 0;color:#6b7280;">5-Year Projected OPEX</td><td style="padding:4px 0;font-weight:700;font-family:monospace;">${fC(dm.tco5yr)}</td></tr>
                            <tr><td style="padding:4px 0;color:#6b7280;">10-Year Projected OPEX</td><td style="padding:4px 0;font-weight:700;font-family:monospace;">${fC(dm.tco10yr)}</td></tr>
                            <tr><td style="padding:4px 0;color:#6b7280;font-size:10px;" colspan="2">Escalation: Energy 3%/yr, Labor 4%/yr, General 2.5%/yr</td></tr>
                        </table>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:11px;font-weight:700;color:#1e3a5f;margin-bottom:6px;">Cost Structure</div>
                        <table style="width:100%;font-size:11px;">
                            <tr><td style="padding:4px 0;color:#6b7280;">Fixed Costs</td><td style="padding:4px 0;font-weight:600;">${fC(dm.fixedCost)} (${dm.fixedPct.toFixed(1)}%)</td></tr>
                            <tr><td style="padding:4px 0;color:#6b7280;">Variable Costs</td><td style="padding:4px 0;font-weight:600;">${fC(dm.variableCost)} (${dm.variablePct.toFixed(1)}%)</td></tr>
                            <tr><td style="padding:4px 0;color:#6b7280;">Operating Leverage</td><td style="padding:4px 0;font-weight:600;">${(dm.opLeverage * 100).toFixed(1)}% variable</td></tr>
                        </table>
                    </div>
                </div>
                <div style="margin-top:10px;">
                    <div style="font-size:11px;font-weight:700;color:#1e3a5f;margin-bottom:6px;">Industry Benchmark Position</div>
                    <div style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:10px;display:flex;gap:20px;font-size:11px;">
                        <div><span style="color:#6b7280;">Your $/kW:</span> <strong style="font-family:monospace;">$${fN(result.perKW)}</strong></div>
                        <div><span style="color:#6b7280;">Tier ${result._config?.tierLevel||3} Range:</span> <strong>$${dm.benchLow} - $${dm.benchHigh}</strong></div>
                        <div><span style="color:#6b7280;">Position:</span> <strong>${dm.benchPosition}</strong></div>
                        <div><span style="color:#6b7280;">Efficiency Score:</span> <strong>${dm.efficiencyScore}/100</strong></div>
                    </div>
                </div>`;
            }

            // ‚ïê‚ïê‚ïê SECTION 12: (Removed ‚Äî comparisons now integrated into each section above) ‚ïê‚ïê‚ïê
            let sec12 = '';

            // ‚ïê‚ïê‚ïê ASSEMBLE PDF ‚ïê‚ïê‚ïê
            const printHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>OPEX Report ‚Äî ${dateStr}</title>
            <style>@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}@page{margin:12mm 15mm;}}table{page-break-inside:auto;}tr{page-break-inside:avoid;}</style></head>
            <body style="font-family:Arial,Helvetica,sans-serif;max-width:820px;margin:0 auto;padding:30px;color:#1f2937;">
                <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #1e3a5f;padding-bottom:14px;margin-bottom:16px;">
                    <div><h1 style="font-size:20px;color:#1e3a5f;margin:0;">Data Center OPEX Report${hasCompare ? ' ‚Äî Scenario Comparison' : ''}</h1><p style="font-size:11px;color:#6b7280;margin:4px 0 0;">Generated ${dateStr} ¬∑ resistancezero.com</p></div>
                    ${hasCompare ? `
                    <div style="display:flex;gap:16px;text-align:right;">
                        <div style="padding:6px 12px;background:#fef3c7;border-radius:8px;"><div style="font-size:9px;color:#92400e;text-transform:uppercase;font-weight:700;">Scenario A</div><div style="font-size:20px;font-weight:700;color:#d97706;font-family:monospace;">${fC(a.total)}</div><div style="font-size:10px;color:#6b7280;">$${fN(a.perKW)}/kW ¬∑ ${cfA.flag} ${cfA.name}</div></div>
                        <div style="padding:6px 12px;background:#d1fae5;border-radius:8px;"><div style="font-size:9px;color:#065f46;text-transform:uppercase;font-weight:700;">Scenario B</div><div style="font-size:20px;font-weight:700;color:#059669;font-family:monospace;">${fC(b.total)}</div><div style="font-size:10px;color:#6b7280;">$${fN(b.perKW)}/kW ¬∑ ${cf.flag} ${cf.name}</div></div>
                    </div>` : `
                    <div style="text-align:right;"><div style="font-size:26px;font-weight:700;color:#10b981;font-family:monospace;">${fC(result.total)}</div><div style="font-size:12px;color:#6b7280;">$${fN(result.perKW)}/kW/yr ¬∑ ${cf.flag} ${cf.name}</div></div>`}
                </div>
                ${sec1}${sec2}${sec3}${sec4}${sec5}${sec6}${sec7}${sec8}${sec9}${sec10}${sec11}${sec12}
                ${generateOpexNarrative(result, dm, cf, hasCompare, a)}
                <div style="margin-top:30px;padding-top:14px;border-top:1px solid #e5e7eb;font-size:10px;color:#9ca3af;text-align:center;">
                    <p>This report is a general-purpose estimate. Actual OPEX varies with contract terms, utility tariffs, and operational maturity. Carbon data based on 2024 IEA grid emission factors.</p>
                    <p style="margin-top:4px;">Generated by Data Center OPEX Calculator ¬∑ resistancezero.com ¬∑ &copy; ${now.getFullYear()} Bagus Dwi Permana</p>
                </div>
</body></html>`;

            const w = window.open('', '_blank');
            w.document.write(printHTML);
            w.document.close();
            w.focus();
            setTimeout(() => w.print(), 500);
        }

        // Global Tooltip System - escapes overflow containers
        function initTooltipSystem() {
            // Create global tooltip container
            const tooltipEl = document.createElement('div');
            tooltipEl.id = 'tooltip-container';
            document.body.appendChild(tooltipEl);

            // Attach listeners to all tooltip triggers
            document.querySelectorAll('.info-tooltip').forEach(trigger => {
                const content = trigger.querySelector('.tooltip-content');
                if (!content) return;

                trigger.addEventListener('mouseenter', (e) => {
                    // Copy content to global tooltip
                    tooltipEl.innerHTML = content.innerHTML;

                    // Position tooltip
                    const rect = trigger.getBoundingClientRect();
                    const tooltipWidth = 320;
                    const tooltipHeight = tooltipEl.offsetHeight || 200;
                    const padding = 15;

                    let left = rect.right + padding;
                    let top = rect.top + rect.height / 2;

                    // Check right edge - flip to left if needed
                    if (left + tooltipWidth > window.innerWidth - 20) {
                        left = rect.left - tooltipWidth - padding;
                    }

                    // Check left edge
                    if (left < 20) {
                        left = 20;
                    }

                    // Vertical centering with bounds check
                    top = top - tooltipHeight / 2;
                    if (top < 20) top = 20;
                    if (top + tooltipHeight > window.innerHeight - 20) {
                        top = window.innerHeight - tooltipHeight - 20;
                    }

                    tooltipEl.style.left = left + 'px';
                    tooltipEl.style.top = top + 'px';
                    tooltipEl.classList.add('visible');
                });

                trigger.addEventListener('mouseleave', () => {
                    tooltipEl.classList.remove('visible');
                });
            });
        }
    </script>

    <!-- Login Modal -->
    <div class="login-overlay" id="opexLoginModal">
        <div class="login-box">
            <button class="login-close" onclick="opexCloseLogin()">&times;</button>
            <div style="text-align:center;margin-bottom:1.5rem;">
                <div style="width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,#7c3aed,#a855f7);display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;">
                    <i class="fas fa-crown" style="font-size:1.4rem;color:#fff;"></i>
                </div>
                <h3 style="color:#f1f5f9;font-size:1.2rem;margin:0 0 4px;">Unlock OPEX PRO</h3>
                <p style="color:#64748b;font-size:0.82rem;margin:0;">Full breakdowns, $/kW metrics, PDF export & more</p>
            </div>
            <div id="opexLoginError" style="display:none;padding:10px 14px;border-radius:8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;font-size:0.8rem;margin-bottom:12px;"></div>
            <input type="email" id="opexLoginEmail" class="login-input" placeholder="Email address" onkeydown="if(event.key==='Enter')opexDoLogin()">
            <input type="password" id="opexLoginPassword" class="login-input" placeholder="Password" onkeydown="if(event.key==='Enter')opexDoLogin()">
            <button class="login-submit" onclick="opexDoLogin()">
                <i class="fas fa-sign-in-alt" style="margin-right:6px;"></i>Login
            </button>
            <div style="text-align:center;margin-top:12px;">
                <a href="mailto:bagus@resistancezero.com" style="font-size:0.78rem;color:#8b5cf6;text-decoration:none;font-weight:600;">Want full access? Get in touch &rarr;</a>
                <div style="margin-top:12px;padding:10px 12px;border-radius:8px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2);font-size:0.78rem;color:#64748b;line-height:1.6;">
                    <span style="color:#8b5cf6;font-weight:600;">Demo Account:</span><br>
                    <code style="background:rgba(139,92,246,0.1);padding:2px 6px;border-radius:4px;font-size:0.75rem;color:#7c3aed;">demo@resistancezero.com</code> / <code style="background:rgba(139,92,246,0.1);padding:2px 6px;border-radius:4px;font-size:0.75rem;color:#7c3aed;">demo2026</code>
                </div>
                <p style="font-size:0.68rem;color:#64748b;margin-top:12px;line-height:1.5;">By clicking Login, you agree to our <a href="terms.html" target="_blank" style="color:#8b5cf6;text-decoration:underline;">Terms of Service</a> and <a href="privacy.html" target="_blank" style="color:#8b5cf6;text-decoration:underline;">Privacy Policy</a>.</p>
            </div>
        </div>
    </div>

    <!-- Free Watermark -->
    <div id="opexFreeWatermark" onclick="opexShowLogin()">
        <i class="fas fa-lock" style="margin-right:6px;"></i>Free estimate &middot; Upgrade to PRO &mdash; Rp 199K/bulan
    </div>

    <!-- Premium Gating Script -->
    <script>
    (function() {
        var opexIsPremium = false;
        var opexUserTier = 'free';

        // Check existing session
        var session = localStorage.getItem('rz_premium_session');
        if (session) {
            try {
                var data = JSON.parse(session);
                var expiresMs = typeof data.expires === 'string' ? new Date(data.expires).getTime() : data.expires;
                if (expiresMs > Date.now()) {
                    opexIsPremium = true;
                    opexUserTier = data.tier || 'pro';
                    setTimeout(function() { opexActivatePremium(); }, 100);
                } else {
                    localStorage.removeItem('rz_premium_session');
                }
            } catch(e) { localStorage.removeItem('rz_premium_session'); }
        }

        // Apply gating on load
        setTimeout(function() { opexApplyGating(); opexUpdateNavAuth(); }, 150);

        // Expose functions globally
        window.opexShowLogin = function() {
            document.getElementById('opexLoginModal').classList.add('show');
            setTimeout(function() { document.getElementById('opexLoginEmail').focus(); }, 100);
        };
        window.opexCloseLogin = function() {
            document.getElementById('opexLoginModal').classList.remove('show');
            document.getElementById('opexLoginError').style.display = 'none';
        };
        // Close modal on overlay click
        document.getElementById('opexLoginModal').addEventListener('click', function(e) {
            if (e.target === this) opexCloseLogin();
        });

        window.opexDoLogin = function() {
            var email = document.getElementById('opexLoginEmail').value.trim().toLowerCase();
            var password = document.getElementById('opexLoginPassword').value;
            var errEl = document.getElementById('opexLoginError');

            if (!email || !password) {
                errEl.textContent = 'Please enter email and password';
                errEl.style.display = 'block';
                return;
            }

            var validUsers = [
                { email: 'demo@resistancezero.com', password: 'demo2026', tier: 'pro' }
            ];

            var match = validUsers.find(function(u) { return u.email === email && u.password === password; });

            if (match) {
                localStorage.setItem('rz_premium_session', JSON.stringify({
                    email: match.email, tier: match.tier,
                    expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                }));
                opexIsPremium = true;
                opexUserTier = match.tier;
                opexCloseLogin();
                opexActivatePremium();
            } else {
                errEl.textContent = 'Invalid email or password';
                errEl.style.display = 'block';
                document.getElementById('opexLoginPassword').value = '';
                document.getElementById('opexLoginPassword').focus();
            }
        };

        window.opexHandlePremiumTab = function() {
            if (opexIsPremium) {
                switchOpexMode('advanced');
                return;
            }
            opexShowLogin();
        };

        window.opexTryAdvanced = function() {
            if (opexIsPremium) {
                switchOpexMode('advanced');
            } else {
                opexShowLogin();
            }
        };

        window.opexToggleDropdown = function() {
            var dd = document.getElementById('opexNavUserDropdown');
            dd.classList.toggle('show');
        };
        // Close dropdown on outside click
        document.addEventListener('click', function(e) {
            var wrap = document.getElementById('opexNavAuthWrap');
            if (wrap && !wrap.contains(e.target)) {
                var dd = document.getElementById('opexNavUserDropdown');
                if (dd) dd.classList.remove('show');
            }
        });

        window.opexLogout = function() {
            if (!confirm('Logout from your account?')) return;
            opexIsPremium = false;
            opexUserTier = 'free';
            localStorage.removeItem('rz_premium_session');

            var premBtn = document.getElementById('opexPremiumTabBtn');
            premBtn.classList.remove('premium-active');
            premBtn.innerHTML = '<i class="fas fa-crown" style="margin-right:6px;"></i>Premium';
            premBtn.onclick = function() { opexHandlePremiumTab(); };
            document.getElementById('opexPremiumBadge').style.display = 'none';

            switchOpexMode('simple');
            opexApplyGating();
            opexUpdateNavAuth();

            var dd = document.getElementById('opexNavUserDropdown');
            if (dd) dd.classList.remove('show');
        };

        function opexActivatePremium() {
            var premBtn = document.getElementById('opexPremiumTabBtn');
            premBtn.innerHTML = '<i class="fas fa-crown" style="margin-right:6px;"></i>Premium Active';
            premBtn.style.background = 'linear-gradient(135deg,rgba(139,92,246,0.25),rgba(139,92,246,0.1))';
            premBtn.style.borderColor = 'rgba(139,92,246,0.5)';
            premBtn.style.color = '#a78bfa';
            premBtn.onclick = function() { opexLogout(); };

            var badge = document.getElementById('opexPremiumBadge');
            badge.textContent = 'PRO ACTIVE';
            badge.style.display = 'inline-flex';

            switchOpexMode('advanced');
            opexApplyGating();
            opexUpdateNavAuth();
        }

        function opexUpdateNavAuth() {
            var loginBtn = document.getElementById('opexNavLoginBtn');
            var userBtn = document.getElementById('opexNavUserBtn');
            var ddEmail = document.getElementById('opexNavDdEmail');
            var avatar = document.getElementById('opexNavUserAvatar');
            var emailSpan = document.getElementById('opexNavUserEmail');

            if (opexIsPremium) {
                var sess = JSON.parse(localStorage.getItem('rz_premium_session') || '{}');
                var em = sess.email || '';
                loginBtn.style.display = 'none';
                userBtn.style.display = 'flex';
                avatar.textContent = em.charAt(0).toUpperCase();
                emailSpan.textContent = em;
                ddEmail.textContent = em;
            } else {
                loginBtn.style.display = 'flex';
                userBtn.style.display = 'none';
            }
        }

        function opexApplyGating() {
            var isFree = !opexIsPremium;

            // 1. $/kW and $/kWh ‚Äî blur for free
            var perKw = document.getElementById('perKwOpex');
            var perKwh = document.getElementById('perKwhOpex');
            if (perKw) perKw.classList.toggle('cost-value-hidden', isFree);
            if (perKwh) perKwh.classList.toggle('cost-value-hidden', isFree);

            // 2. Breakdown tables ‚Äî blur all dollar values for free
            ['breakdownTableBody','staffingTableBody','maintTableBody','utilitiesTableBody','complianceTableBody'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) {
                    el.querySelectorAll('td.amount, td:nth-child(2)').forEach(function(td) {
                        td.classList.toggle('cost-value-hidden', isFree);
                    });
                    // Also blur footer totals
                    var tfoot = el.closest('table');
                    if (tfoot) {
                        tfoot.querySelectorAll('tfoot td').forEach(function(td) {
                            if (td.textContent.includes('$')) td.classList.toggle('cost-value-hidden', isFree);
                        });
                    }
                }
            });

            // 3. Charts ‚Äî blur for free
            var charts = document.querySelectorAll('.charts-grid');
            charts.forEach(function(cg) {
                if (isFree) {
                    cg.style.filter = 'blur(6px)';
                    cg.style.pointerEvents = 'none';
                    cg.style.opacity = '0.5';
                } else {
                    cg.style.filter = 'none';
                    cg.style.pointerEvents = 'auto';
                    cg.style.opacity = '1';
                }
            });

            // 4. Staffing model comparison ‚Äî blur for free
            var scenarios = document.querySelectorAll('.scenario-section');
            scenarios.forEach(function(sc) {
                if (isFree) {
                    sc.style.filter = 'blur(6px)';
                    sc.style.pointerEvents = 'none';
                    sc.style.opacity = '0.5';
                } else {
                    sc.style.filter = 'none';
                    sc.style.pointerEvents = 'auto';
                    sc.style.opacity = '1';
                }
            });

            // 5. Comparison panel ‚Äî blur for free
            var compareGrid = document.getElementById('opexCompareGrid');
            if (compareGrid) {
                if (isFree) {
                    compareGrid.style.filter = 'blur(4px)';
                    compareGrid.style.pointerEvents = 'none';
                    compareGrid.style.opacity = '0.5';
                } else {
                    compareGrid.style.filter = 'none';
                    compareGrid.style.pointerEvents = 'auto';
                    compareGrid.style.opacity = '1';
                }
            }

            // 6. Action buttons ‚Äî lock save/PDF for free
            var btnSave = document.getElementById('btnSaveOpexA');
            if (btnSave) {
                if (isFree) {
                    btnSave.onclick = function() { opexShowLogin(); };
                    btnSave.style.opacity = '0.6';
                    btnSave.innerHTML = '<i class="fas fa-lock" style="font-size:0.65rem;margin-right:3px;color:#a78bfa;"></i> Save Scenario A';
                } else {
                    btnSave.onclick = function() { saveOpexScenarioA(); };
                    btnSave.style.opacity = '1';
                    btnSave.innerHTML = '<i class="fas fa-bookmark"></i> Save Scenario A';
                }
            }
            // PDF button ‚Äî find by content
            var pdfBtn = document.querySelector('#opexActionToolbar button:nth-child(2)');
            if (pdfBtn) {
                if (isFree) {
                    pdfBtn.setAttribute('data-orig-onclick', pdfBtn.getAttribute('onclick') || '');
                    pdfBtn.setAttribute('onclick', 'opexShowLogin()');
                    pdfBtn.style.opacity = '0.6';
                    pdfBtn.innerHTML = '<i class="fas fa-lock" style="font-size:0.65rem;margin-right:3px;color:#a78bfa;"></i> Export PDF';
                } else {
                    pdfBtn.setAttribute('onclick', 'exportOpexPDF()');
                    pdfBtn.style.opacity = '1';
                    pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Export PDF';
                }
            }

            // 7. Advanced mode tab ‚Äî lock icon for free
            var advBtn = document.querySelector('.opex-mode-btn[data-mode="advanced"]');
            if (advBtn) {
                if (isFree) {
                    if (!advBtn.querySelector('.gate-lock-icon')) {
                        advBtn.insertAdjacentHTML('beforeend', '<i class="fas fa-lock gate-lock-icon" style="margin-left:6px;font-size:0.65rem;color:#a78bfa;"></i>');
                    }
                } else {
                    var lockIcon = advBtn.querySelector('.gate-lock-icon');
                    if (lockIcon) lockIcon.remove();
                }
            }

            // 8. Watermark
            var watermark = document.getElementById('opexFreeWatermark');
            if (watermark) watermark.style.display = isFree ? 'block' : 'none';
        }
    })();
    </script>
<script src="rz-tracker.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-banner hidden" id="cookieBanner">
    <p>We use cookies for analytics to improve your experience. <a href="privacy.html">Learn more</a></p>
    <div class="cookie-actions">
        <button class="cookie-accept" id="cookieAccept">Accept</button>
        <button class="cookie-decline" id="cookieDecline">Decline</button>
    </div>
</div>

<!-- Scroll to Top -->
<button class="scroll-top-btn" id="scrollTopBtn" aria-label="Scroll to top">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
</button>

<script>
(function(){
    // Cookie Banner
    var cb = document.getElementById('cookieBanner');
    var consent = localStorage.getItem('rz_cookie_consent');
    if (!consent && cb) {
        cb.classList.remove('hidden');
    }
    var acceptBtn = document.getElementById('cookieAccept');
    var declineBtn = document.getElementById('cookieDecline');
    if (acceptBtn) acceptBtn.addEventListener('click', function(){
        localStorage.setItem('rz_cookie_consent', 'accepted');
        cb.classList.add('hidden');
    });
    if (declineBtn) declineBtn.addEventListener('click', function(){
        localStorage.setItem('rz_cookie_consent', 'declined');
        cb.classList.add('hidden');
        // Disable GA
        window['ga-disable-G-GED7FX8RTV'] = true;
    });

    // Scroll to Top
    var sBtn = document.getElementById('scrollTopBtn');
    if (sBtn) {
        var ticking = false;
        window.addEventListener('scroll', function(){
            if (!ticking) {
                window.requestAnimationFrame(function(){
                    if (window.scrollY > 500) {
                        sBtn.classList.add('visible');
                    } else {
                        sBtn.classList.remove('visible');
                    }
                    ticking = false;
                });
                ticking = true;
            }
        });
        sBtn.addEventListener('click', function(){
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
})();
</script>

</body>
</html>
